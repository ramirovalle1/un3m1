{% extends "base.html" %}
{% load humanize %}
{% load sga_extras %}
{% block heading %}
    <script src="/static/adicionalesjs/formquestionb4.js?0.24"></script>

    <script type="text/javascript">
        const openCreateSolicitud = function (action, title){
            bloqueointerface();
            //console.log(id);
            $.ajax({
                type: "GET",
                url: `{{ request.path }}`,
                data: {
                    'action': action,
                },
                success: function (data) {
                    $.unblockUI();
                    if (data.result === true) {
                        $('.modal-body', $("#modalCreateSolicitud")).html(data.html);
                        $("#modalLabelCreateSolicitud", $("#modalCreateSolicitud")).html(title);
                        $("#modalCreateSolicitud").modal({backdrop: 'static', }).modal('show');
                        //$('#id_supervisor', $("#modalAddEditFechaPlanificacion")).trigger('change');
                    } else {
                        mensajeDanger(data.message);
                    }
                },
                error: function () {
                    $.unblockUI();
                    mensajeDanger("Error de conexión.");
                },
                dataType: "json"
            });
        };

        const actionDelete = (id, permission, app, mensaje) => {
            var question = `Al eliminar el registro no podra volver a recuperar los datos. <br>¿Está seguro de eliminar el registro <span class="label label-warning">${mensaje}</span>?`;
            Confirm.ajax({"model": "CapSolicitudNecesidad", 'id': id, "permission": permission, "app_label": app}, function () {
                Confirm.question(question, function () {
                    bloqueointerface();
                    var aData = {"action": "deleteSolicitudNecesidad", 'id': id}
                    $.ajax({
                        type: "POST",
                        url: `{{ request.path }}`,
                        data: aData,
                        success: function(data) {
                            if (data.result) {
                                $.unblockUI();

                                Swal.fire({
                                    title: `NOTIFICACIÓN`,
                                    text: 'Se elimino correctamente el registro',
                                    type: 'success',
                                    icon: 'success',
                                    showCancelButton: false,
                                    allowOutsideClick: false,
                                    confirmButtonColor: '#3085d6',
                                    cancelButtonColor: '#d33',
                                    confirmButtonText: 'Aceptar',
                                    cancelButtonText: 'Cancelar'
                                }).then((result) => {
                                    if (result.value) {
                                        bloqueointerface();
                                        location.reload();
                                    }
                                }).catch(error => {
                                    NotificationJG.error(error);
                                    $.unblockUI();
                                });
                            }
                            else{
                                NotificationJG.error(data.message);
                                $.unblockUI();
                            }

                        },
                        error: function() {
                            $.unblockUI();
                            NotificationJG.error("Error al enviar los datos.");
                        },
                        dataType: "json",
                    });
                }, function () {
                    NotificationJG.info("Enhorabuena el registro esta salvado.!");
                    var h = $(window).height() - 350;
                    $('#modalConfirmAjax').modal({backdrop: 'static', keyboard: false, width: "60%", height: h}).modal('show');
                });

            }, function () {
                NotificationJG.info("Enhorabuena el registro esta salvado.!");
                $.unblockUI();
            });
        }

        const actionBusqueda = function (page/*=undefined*/) {
            var term = $("#searchCriterio").val().trim().toUpperCase();
            var pid = $("#periodo_list").val();
            var coid = $("#coordinacion_list").val() ?? 0;
            var caid = $("#carrera_list").val() ?? 0;

            page = typeof page == 'undefined' ? 1 : page;

            bloqueointerface();
            location.href = `{{ request.path }}?s=${term}&pid=${pid}&coid=${coid}&caid=${caid}&page=${page}`;
            return false;
        };

        const openModalFirma = async function (id, action, title){
            bloqueointerface();
            $.ajax({
                type: "GET",
                url: `{{ request.path }}`,
                data: {
                    'action': action,
                    'action_x': 'firmaDecanoSolicitudNecesidad',
                    'modal_x': 'modalFirmaDocumento',
                    'id': id
                },
                success: function (data) {
                    $.unblockUI();
                    if (data.result === true) {
                        $('.modal-body', $("#modalFirmaDocumento")).html(data.data.html);
                        if (data.data.tipo === 'uploadDocumento'){
                            $('.action-firmar', $("#modalFirmaDocumento")).html('Subir');
                        }
                        $("#modalLabelFirmaDocumento", $("#modalFirmaDocumento")).html(title);
                        $("#modalFirmaDocumento").modal({backdrop: 'static', }).modal('show');
                        $("#frmFirma", $("#modalFirmaDocumento")).validationEngine({autoHidePrompt:true, autoHideDelay:1000 });
                    } else {
                        mensajeDanger(data.message);
                    }
                },
                error: function () {
                    $.unblockUI();
                    mensajeDanger("Error de conexión.");
                },
                dataType: "json"
            });
        };

        const openModalSeguimiento = async function (id, action, title){
            bloqueointerface();
            $.ajax({
                type: "GET",
                url: `{{ request.path }}`,
                data: {
                    'action': action,
                    'id': id
                },
                success: function (data) {
                    $.unblockUI();
                    if (data.result === true) {
                        $('.modal-body', $("#modalSeguimiento")).html(data.data);
                        $("#modalLabelSeguimiento", $("#modalSeguimiento")).html(title);
                        $("#modalSeguimiento").modal({backdrop: 'static', }).modal('show');
                    } else {
                        mensajeDanger(data.message);
                    }
                },
                error: function () {
                    $.unblockUI();
                    mensajeDanger("Error de conexión.");
                },
                dataType: "json"
            });
        };

        const openModalRechazar = async function (id, action, title){
            bloqueointerface();
            $.ajax({
                type: "GET",
                url: `{{ request.path }}`,
                data: {
                    'action': action,
                    'id': id
                },
                success: function (data) {
                    $.unblockUI();
                    if (data.result === true) {
                        $('.modal-body', $("#modalRechazarSolicitud")).html(data.html);
                        $("#modalLabelRechazarSolicitud", $("#modalRechazarSolicitud")).html(title);
                        $("#modalRechazarSolicitud").modal({backdrop: 'static', }).modal('show');
                        $("#formRechazar", $("#modalRechazarSolicitud")).validationEngine({autoHidePrompt:true, autoHideDelay:1000 });
                    } else {
                        mensajeDanger(data.message);
                    }
                },
                error: function () {
                    $.unblockUI();
                    mensajeDanger("Error de conexión.");
                },
                dataType: "json"
            });
        };

        const actionReporteDownload = () =>{
            const pid = $("#periodo_list").val();
            if (pid === 0 || pid === '0'){
                mensajeWarning('Seleccione un periodo');
                return
            }
            var coid = $("#coordinacion_list").val() ?? 0;
            var caid = $("#carrera_list").val() ?? 0;
            //bloqueointerface();
            var a = document.createElement("a");
            a.target = "_blank";
            a.href = `{{ request.path }}?action=generateReporteCapacitaciones&pid=${pid}&coid=${coid}&caid=${caid}`;
            a.click();
            return false;
        }

        const actionZipDownload = () =>{
            const pid = $("#periodo_list").val();
            if (pid === 0 || pid === '0'){
                mensajeWarning('Seleccione un periodo');
                return
            }
            var coid = $("#coordinacion_list").val() ?? 0;
            var caid = $("#carrera_list").val() ?? 0;
            //bloqueointerface();
            var a = document.createElement("a");
            a.target = "_blank";
            a.href = `{{ request.path }}?action=generateZIPCapacitaciones&pid=${pid}&coid=${coid}&caid=${caid}`;
            a.click();
            return false;
        }


        $(function() {
            $(".tl").tooltip({position:"center up"});

            $('.select2').select2({minimumResultsForSearch: 7});

            $("#search").click(function () {
                actionBusqueda();
            });

            $('#searchCriterio').keyup(function (e) {
                if (e.keyCode == 13) {
                    actionBusqueda();
                }
            });
            $("#periodo_list").change(function () {
                actionBusqueda();
            });
            $("#coordinacion_list").change(function () {
                actionBusqueda();
            });
            $("#carrera_list").change(function () {
                actionBusqueda();
            });

            $(".action-close", $("#modalCreateSolicitud")).click(function (){
                $("#modalCreateSolicitud").modal('hide');

            });

            $(".action-save", $("#modalCreateSolicitud")).click(function (){
                bloqueointerface();
                let formdata = new FormData($("#formSolicitudNecesidad", $("#modalCreateSolicitud"))[0]);
                $.ajax({
                    type: "POST",
                    url: `{{ request.path }}`,
                    data: formdata,
                    success: function(data) {
                        $.unblockUI();
                        if (data.result === true) {
                            $("#modalCreateSolicitud").modal('hide');
                            location.href=`{{ request.path }}?action=writeDraftSolicitudNecesidad&id=${data.id}`;
                            /*Swal.fire({
                                allowOutsideClick: false,
                                allowEscapeKey: false,
                                allowEnterKey: false,
                                type: 'success',
                                customClass: {
                                    confirmButton: 'btn btn-info'
                                },
                                title: 'Exitoso',
                                text: 'Registro guardado correctamente.',
                                confirmButtonText: 'Aceptar',
                            }).then((result) => {
                                if (result.value) {
                                    bloqueointerface();
                                    location.reload();
                                }
                            })*/
                        } else {
                            Swal.fire({
                                allowOutsideClick: false,
                                allowEscapeKey: false,
                                allowEnterKey: false,
                                type: 'error',
                                customClass: {
                                    confirmButton: 'btn btn-info'
                                },
                                title: 'Ocurrio un error',
                                text: data.message,
                                confirmButtonText: 'Aceptar',
                            })
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        $.unblockUI();
                        {#smoke.alert("Error de conexión.");#}
                        var msg = '';
                        if (jqXHR.status === 0) {
                            msg='Not connect: Verify Network.';
                        } else if (jqXHR.status == 404) {
                            msg='Requested page not found [404]';
                        } else if (jqXHR.status == 500) {
                            msg='Internal Server Error [500].';
                        } else if (textStatus === 'parsererror') {
                            msg='Requested JSON parse failed.';
                        } else if (textStatus === 'timeout') {
                            msg='Time out error.';
                        } else if (textStatus === 'abort') {
                            msg='Ajax request aborted.';
                        } else {
                            msg='Uncaught Error: ' + jqXHR.responseText;
                        }
                        //smoke.alert("Error al enviar los datos: " + msg);
                        NotificationJG.error("Error al enviar los datos: " + msg);
                    },
                    dataType: "json",
                    cache: false,
                    contentType: false,
                    processData: false
                });

            });

            $(".action-close", $("#modalFirmaDocumento")).click(function (){
                $("#modalFirmaDocumento").modal('hide');

            });
            $(".action-close", $("#modalSeguimiento")).click(function (){
                $("#modalSeguimiento").modal('hide');

            });

            $(".action-firmar", $("#modalFirmaDocumento")).click((event) => {
                let hojasFirmadas = [];
                hojasFirmadas.push(
                    {
                        x: 400,
                        y: 375,
                        width: 150,
                        height: 45,
                        numPage: 5
                    }
                );
                $("textarea[name=txtFirmas]", $("#modalFirmaDocumento")).val(JSON.stringify(hojasFirmadas));

                bloqueointerface();
                /*try {
                    for (instance in CKEDITOR.instances) {
                        CKEDITOR.instances[instance].updateElement();
                    }
                } catch (err) {
                    console.error(err.message);
                }*/
                var formdata = new FormData($("#frmFirma", $("#modalFirmaDocumento"))[0]);
                $("#frmFirma", $("#modalFirmaDocumento")).validationEngine('attach',{ scroll: false });
                var valid = $("#frmFirma", $("#modalFirmaDocumento")).validationEngine('validate', { scroll: false });

                if (valid){
                    $.ajax({
                        type: "POST",
                        url: "{{ request.path }}",
                        data: formdata,
                        success: function(data) {
                            $.unblockUI();
                            if (data.result === true){
                                Swal.fire({
                                    allowOutsideClick: false,
                                    allowEscapeKey: false,
                                    allowEnterKey: false,
                                    type: 'success',
                                    customClass: {
                                        confirmButton: 'btn btn-info'
                                    },
                                    title: 'Exitoso',
                                    text: data.message,
                                    confirmButtonText: 'Aceptar',
                                }).then((result) => {
                                    if (result.value) {
                                        bloqueointerface();
                                        let a = document.createElement("a");
                                        a.target = "_blank";
                                        a.href = data.archivo;
                                        location.reload();
                                    }
                                })
                            }else {
                                Swal.fire({
                                    allowOutsideClick: false,
                                    allowEscapeKey: false,
                                    allowEnterKey: false,
                                    type: 'error',
                                    customClass: {
                                        confirmButton: 'btn btn-info'
                                    },
                                    title: 'Ocurrio un error',
                                    text: data.message,
                                    confirmButtonText: 'Aceptar',
                                })
                            }
                        },
                        error: function() {
                            $.unblockUI();

                        },
                        dataType: "json",
                        cache: false,
                        contentType: false,
                        processData: false
                    });
                }else{
                    $.unblockUI();
                    NotificationJG.error("Complete el formulario");
                    setInterval(function() {
                        $('.help-text', $("#modalFirmaDocumento")).html("");
                    }, 8000);
                }




            });

            $(".action-rechazar", $("#modalRechazarSolicitud")).click((event) => {

                bloqueointerface();

                var formdata = new FormData($("#formRechazar", $("#modalRechazarSolicitud"))[0]);
                $("#formRechazar", $("#modalRechazarSolicitud")).validationEngine('attach',{ scroll: false });
                var valid = $("#formRechazar", $("#modalRechazarSolicitud")).validationEngine('validate', { scroll: false });

                if (valid){
                    $.ajax({
                        type: "POST",
                        url: "{{ request.path }}",
                        data: formdata,
                        success: function(data) {
                            $.unblockUI();
                            if (data.result === true){
                                Swal.fire({
                                    allowOutsideClick: false,
                                    allowEscapeKey: false,
                                    allowEnterKey: false,
                                    type: 'success',
                                    customClass: {
                                        confirmButton: 'btn btn-info'
                                    },
                                    title: 'Exitoso',
                                    text: data.message,
                                    confirmButtonText: 'Aceptar',
                                }).then((result) => {
                                    if (result.value) {
                                        bloqueointerface();

                                        location.reload();
                                    }
                                })
                            }else {
                                Swal.fire({
                                    allowOutsideClick: false,
                                    allowEscapeKey: false,
                                    allowEnterKey: false,
                                    type: 'error',
                                    customClass: {
                                        confirmButton: 'btn btn-info'
                                    },
                                    title: 'Ocurrio un error',
                                    text: data.message,
                                    confirmButtonText: 'Aceptar',
                                })
                            }
                        },
                        error: function() {
                            $.unblockUI();

                        },
                        dataType: "json",
                        cache: false,
                        contentType: false,
                        processData: false
                    });
                }else{
                    $.unblockUI();
                    NotificationJG.error("Complete el formulario");
                    setInterval(function() {
                        $('.help-text', $("#modalRechazarSolicitud")).html("");
                    }, 8000);
                }




            });

        });


    </script>
{% endblock %}
{% block atras %}/adm_capacitaciondocente{% endblock %}
{% block canvas %}

    <div class='row'>
        <div class='col-12 col-lg-4'>
            <div class="headtitle">
                <h3 class="texto-blue">{{ title }}</h3>
                {% if sub_title %}
                    <h6>{{ sub_title }}</h6>
                {% endif %}
                {% if eCapPeriodoDocente %}
                    <h6>Período activo para registro de solicitudes: {{ eCapPeriodoDocente.nombre }}</h6>
                {% endif %}
            </div>
        </div>
        <div class='col-12 col-lg-8'>
            {% with eCapCronogramaNecesidades=eCapPeriodoDocente.cronograma %}
                {% if eCapCronogramaNecesidades|length %}
                    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 row-cols-lg-4">
                        {% for eCapCronogramaNecesidad in eCapCronogramaNecesidades %}
                            <div class="col-12 p-1">
                                <div class="card h-100">
                                    <!-- Card body -->
                                    <div class="p-3">
                                        <!--<span class="icon-shape icon-sm bg-light-primary text-dark-primary rounded-3"><i class="fe fe-folder"></i></span>-->
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h2 class="h4 fw-bold mb-0 lh-1">{{ eCapCronogramaNecesidad.get_etapa_display }}</h2>
                                            <span class="text-{% if eCapCronogramaNecesidad.activo %}success{% else %}danger{% endif %}">{% if eCapCronogramaNecesidad.activo %}<i class="fa fa-check tu" title="Activo" ></i>{% else %}<i class="fa fa-close tu" title="Inactivo"></i>{% endif %}</span>
                                        </div>
                                        <p class="p-0 pt-1 fs-6">{{ eCapCronogramaNecesidad.inicio|date:"d-m-Y h:i a" }} <br> {{ eCapCronogramaNecesidad.fin|date:"d-m-Y h:i a" }}</p>
                                        <p class="p-0 pt-1 fs-6">
                                            {% with proceso=eCapCronogramaNecesidad.proceso_etapa %}
                                                {% if proceso == 0 %}
                                                    <span class="text-warning fw-bolder">Etapa inactiva</span>
                                                {% elif proceso == 1 %}
                                                    <span class="text-info fw-bolder">Próximamente</span>
                                                {% elif proceso == 2 %}
                                                    <span class="text-success fw-bolder">Aperturada</span>
                                                {% elif proceso == 3 %}
                                                    <span class="text-danger fw-bolder">Cerrada</span>
                                                {% endif %}
                                            {% endwith %}
                                        </p>

                                        <!--<div class="progress bg-light-primary" style="height: 5px">
                                            <div class="progress-bar" role="progressbar" style="width: 65%" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>-->
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-warning alert-dismissible fade show h4 text-center" role="alert">
                        {% if eCapPeriodoDocente %}
                            <strong>{{ eCapPeriodoDocente.nombre }}</strong> no registra planificación de cronograma.
                        {% else %}
                            No existe periodo configurado para el registro de identificación de necesidades.
                        {% endif %}
                        <!--<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>-->
                    </div>
                {% endif %}
            {% endwith %}
        </div>
    </div>

    <div class='row'>
        <div class='col-12'>
            <div class="card">
                <div class="card-header border-bottom rounded-md-2">
                    <div class="row">
                        <div class="col-12">
                            <div class="d-lg-flex justify-content-between align-items-center">
                                <div class="mb-3 mb-lg-0">
                                    <div class="headtitle mb-0 ms-0">
                                        <h3 class="texto-blue"> Solicitudes  </h3>
                                        <h6>
                                            Listado de solicitudes de registro de identificación de necesidades
                                        </h6>
                                    </div>
                                </div>
                                <div class="">
                                    {% if es_director and eCapPeriodoDocente.puede_solicitar_firmar_director %}
                                        <a href="javascript:;" onclick="openCreateSolicitud('newSolicitud', 'Borrador de registro de identificación de necesidades')" class="btn btn-success"><i class="fa fa-plus" aria-hidden="true"></i> Adicionar</a>
                                    {% endif %}
                                    {% if es_evaluacion or persona.usuario.is_superuser %}
                                        <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasReportes" aria-controls="offcanvasReportes"><i class="fa fa-filter" aria-hidden="true"></i> Reportes</button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">

                    <form class="form-row {% if es_evaluacion or persona.usuario.is_superuser %}row-cols-1 row-cols-sm-2 row-cols-md-2 row-cols-lg-2{% else %}row-cols-1 row-cols-sm-1 row-cols-md-2 row-cols-lg-3{% endif %}" onsubmit="return actionBusqueda()" action="javascript:;" method="get">
                        <div class="col-12 p-1">
                            <label for="periodo_list"><i class="fa fa-calendar-o"></i> Periodo de planificación</label>
                            <select id="periodo_list" class="form-select select2">
                                <option value="0" {% if 0 == pid %}selected="selected"{% endif %} >---TODOS---</option>
                                {% for eCP in eCapPeriodoDocentes %}
                                    <option value="{{ eCP.id }}" {% if eCP.pk == pid %}selected="selected"{% endif %}>{{ eCP.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% if es_evaluacion or persona.usuario.is_superuser %}
                            <div class="col-12 p-1">
                                <label for="coordinacion_list"><i class="fa fa-filter"></i> Coordinación</label>
                                <select id="coordinacion_list" class="form-select select2">
                                    <option value="0" {% if 0 == coid %}selected="selected"{% endif %} >---TODOS---</option>
                                    {% for eCoordinacion in eCoordinaciones %}
                                        <option value="{{ eCoordinacion.id }}" {% if eCoordinacion.pk == coid %}selected="selected"{% endif %}>{{ eCoordinacion.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% if eCarreras|length %}
                                <div class="col-12 p-1">
                                    <label for="carrera_list"><i class="fa fa-filter"></i> Carrera</label>
                                    <select id="carrera_list" class="form-select select2">
                                        <option value="0" {% if 0 == caid %}selected="selected"{% endif %} >---TODOS---</option>
                                        {% for eCarrera in eCarreras %}
                                            <option value="{{ eCarrera.id }}" {% if eCarrera.pk == caid %}selected="selected"{% endif %}>{{ eCarrera.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            {% else %}
                                <div class="col-12 p-1"></div>
                            {% endif %}
                        {% else %}
                            <div class="col-12 p-1"></div>
                        {% endif %}
                        <div class="col-12 p-1">
                            <label for=""><i class="fa fa-search"></i> Criterio</label>
                            <div class="input-group">
                                <!--<input type="hidden" name="action" value="{{ action }}">-->
                                <input type="text" id="searchCriterio" name="s" class="form-control input-search" value='{{ s }}' autocomplete="off" placeholder="Buscar...">
                                {% if s or pid %}
                                    <div class="input-group-append">
                                        <a href="{{ request.path }}" id='allresults' class="btn btn-cian-secondary py-1 p-3"><i class="fa fa-refresh " aria-hidden="true"></i></a>
                                    </div>
                                {% else %}
                                    <div class="input-group-append">
                                        <button class="btn btn-cian-secondary py-1 p-3 btn-search" type="button" id="buscar"><i class="fa fa-search" aria-hidden="true"></i></button>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                    <div class="">
                        <table class="table table_primary tabla_responsive">
                            <thead class="table-light">
                            <tr>
                                <th class="text-center w-10">Fecha solicitud</th>
                                <th class="text-center w-40">Carrera/Facultad/Tema</th>
                                <th class="text-center w-40">Área/Subárea/Campo detallado</th>
                                <th class="text-center w-5"></th>
                                <th class="text-center w-5"></th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for eCapSolicitudNecesidad in eCapSolicitudNecesidades %}
                                <tr>
                                    <td class="text-center">{{ eCapSolicitudNecesidad.fecha_creacion|date:"d/m/Y" }}</td>
                                    <td>
                                        {{ eCapSolicitudNecesidad.carrera.nombre }}
                                        <br>
                                        {{ eCapSolicitudNecesidad.facultad.nombre }}
                                        {% if eCapSolicitudNecesidad.tema %}
                                            <br>
                                            {{ eCapSolicitudNecesidad.tema|safe }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if eCapSolicitudNecesidad.area %}
                                            {{ eCapSolicitudNecesidad.area }}
                                        {% endif %}
                                        {% if eCapSolicitudNecesidad.subarea %}
                                            <br>
                                            {{ eCapSolicitudNecesidad.subarea }}
                                        {% endif %}
                                        {% if eCapSolicitudNecesidad.campo_detallado %}
                                            <br>
                                            {{ eCapSolicitudNecesidad.campo_detallado }}
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <a href="javascript:;" class="btn btn-primary btn-mini" onclick="openModalSeguimiento('{{ eCapSolicitudNecesidad.pk|encrypt }}', 'loadSeguimientoSolicitud', 'Ver seguimiento de la solicitud')"><i class="fa fa-calendar-o"></i></a>
                                        <span class="badge badge-pill badge-{{ eCapSolicitudNecesidad.color }}">{{ eCapSolicitudNecesidad.get_estado_display }}</span>
                                    </td>
                                    <td class="text-center align-middle w-3">
                                        {% with puede_editar=eCapSolicitudNecesidad|args:persona|args:periodo|call:"puede_editar" puede_eliminar=eCapSolicitudNecesidad|args:persona|args:periodo|call:"puede_eliminar"%}
                                            <div class="dropdown dropstart">
                                                <a href="javascript:void(0);" class="btn-icon btn btn-ghost btn-sm rounded-circle" data-bs-toggle="dropdown" data-offset="-140" aria-haspopup="true" aria-expanded="false">
                                                    <i class="fa fa-ellipsis-v" aria-hidden="true"></i>
                                                </a>
                                                <ul class="dropdown-menu ">
                                                    <span class="dropdown-header"><i class="fa fa-cogs" aria-hidden="true"></i> Acciones</span>
                                                    {% if puede_editar %}
                                                        <li>
                                                            <a class="dropdown-item bloqueo_pantalla" href="{{ request.path }}?action=writeDraftSolicitudNecesidad&id={{ eCapSolicitudNecesidad.id|encrypt }}">
                                                                <i class="fa fa-edit dropdown-item-icon" aria-hidden="true"></i> Continuar editando
                                                            </a>
                                                        </li>
                                                    {% elif eCapSolicitudNecesidad.tiene_pendiente_director and es_director %}
                                                        <li>
                                                            <a class="dropdown-item bloqueo_pantalla" href="{{ request.path }}?action=writeDraftSolicitudNecesidad&id={{ eCapSolicitudNecesidad.id|encrypt }}">
                                                                <i class="fa fa-edit dropdown-item-icon" aria-hidden="true"></i> Firmar director
                                                            </a>
                                                        </li>
                                                    {% elif eCapSolicitudNecesidad.tiene_pendiente_decano and es_decano %}
                                                        <li>
                                                            <a class="dropdown-item bloqueo_pantalla" href="javascript:;" onclick="openModalFirma('{{ eCapSolicitudNecesidad.pk|encrypt }}', 'loadFormFirma', 'Legalizar solicitud por decano/a de la facultad')">
                                                                <i class="fa fa-edit dropdown-item-icon" aria-hidden="true"></i> Firmar decano
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a class="dropdown-item" href="javascript:void(0)" onclick="openModalRechazar('{{ eCapSolicitudNecesidad.id|encrypt }}', 'loadFormRechazar', 'Rechazar solicitud de necesidad')" href="javascript:;" title="Rechazar" >
                                                                <i class="fa fa-close dropdown-item-icon" aria-hidden="true"></i> Rechazar
                                                            </a>
                                                        </li>
                                                    {% endif %}

                                                    {% if puede_eliminar or persona.usuario.is_superuser %}
                                                        <li>
                                                            <a class="dropdown-item" href="javascript:void(0)" onclick="actionDelete('{{ eCapSolicitudNecesidad.id }}', '', 'sga', '{{ eCapSolicitudNecesidad }}')" href="javascript:;" title="Eliminar" >
                                                                <i class="fa fa-trash-o dropdown-item-icon" aria-hidden="true"></i> Eliminar
                                                            </a>
                                                        </li>
                                                    {% endif %}
                                                    {% if eCapSolicitudNecesidad.puede_rechazar_revisor %}
                                                        {% if es_evaluacion or persona.usuario.is_superuser %}
                                                            <li>
                                                                <a class="dropdown-item" href="javascript:void(0)" onclick="openModalRechazar('{{ eCapSolicitudNecesidad.id|encrypt }}', 'loadFormRechazar', 'Rechazar solicitud de necesidad')" href="javascript:;" title="Rechazar" >
                                                                    <i class="fa fa-close dropdown-item-icon" aria-hidden="true"></i> Rechazar
                                                                </a>
                                                            </li>
                                                        {% endif %}
                                                    {% endif %}

                                                    {% if eCapSolicitudNecesidad.archivo %}
                                                        <li>
                                                            <a class="dropdown-item" href="{{ eCapSolicitudNecesidad.archivo.url }}" target="_blank" title="Ver achivo" >
                                                                <i class="fa fa-file-o dropdown-item-icon" aria-hidden="true"></i> Archivo
                                                            </a>
                                                        </li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        {% endwith %}
                                    </td>
                                </tr>
                            {% endfor %}

                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="modalCreateSolicitud" tabindex="-1" aria-labelledby="modalLabelCreateSolicitud" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title m-2" id="modalLabelCreateSolicitud">Modal title</h5>
                    <button type="button" class="btn-close action-close m-0" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body m-2">
                    ...
                </div>
                <div class="modal-footer m-2">
                    <button type="button" class="btn btn-secondary action-close" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary action-save">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalFirmaDocumento" tabindex="-1" aria-labelledby="modalLabelFirmaDocumento" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title m-2" id="modalLabelFirmaDocumento">Modal title</h5>
                    <button type="button" class="btn-close action-close m-0" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body m-2">
                    ...
                </div>
                <div class="modal-footer m-2">
                    <button type="button" class="btn btn-primary action-firmar">Firmar</button>
                    <button type="button" class="btn btn-secondary action-close" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalRechazarSolicitud" tabindex="-1" aria-labelledby="modalLabelRechazarSolicitud" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title m-2" id="modalLabelRechazarSolicitud">Modal title</h5>
                    <button type="button" class="btn-close action-close m-0" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body m-2">
                    ...
                </div>
                <div class="modal-footer m-2">
                    <button type="button" class="btn btn-primary action-rechazar">Rechazar</button>
                    <button type="button" class="btn btn-secondary action-close" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalSeguimiento" tabindex="-1" aria-labelledby="modalLabelSeguimiento" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-fullscreen-lg-down modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title m-2" id="modalLabelSeguimiento">Modal title</h5>
                    <button type="button" class="btn-close action-close m-0" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body m-2">
                    ...
                </div>
                <div class="modal-footer m-2">
                    <button type="button" class="btn btn-secondary action-close" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="offcanvas offcanvas-start" data-bs-scroll="true" tabindex="-1" id="offcanvasReportes" aria-labelledby="offcanvasReportesLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title text-white" id="offcanvasReportesLabel">Reportes</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="d-md-flex mb-2">
                <p>Reporte de identificación de necesidades de capacitaciones</p>
                <a href="javascript:;" onclick="actionReporteDownload()" class="btn btn-outline-primary" style="vertical-align: middle !important;">Generar Reporte</a>
            </div>
            <div class="d-md-flex mb-2">
                <p>Archivos de identificación de necesidades de capacitaciones</p>
                <a href="javascript:;" onclick="actionZipDownload()" class="btn btn-outline-primary">Descargar ZIP</a>
            </div>
        </div>
    </div>


{% endblock %}
