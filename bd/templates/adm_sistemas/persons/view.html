{% extends "basebs_js.html" %}
{% load sga_extras %}
{% block heading %}
    <script type="text/javascript" src="/static/js/jquery.isloading.min.js"></script>
    <link href="/static/css/table-responsive.css?1.0.0" type="text/css" rel="stylesheet" />
    <link href="/static/widget_ppp.css" rel="stylesheet"/>
    <style type="text/css">
        .radio label,
        .checkbox label {
            display: inline-block;
            cursor: pointer;
            color: #0074D9;
            position: relative;
            padding: 5px 15px 5px 51px;
            font-size: 1em;
            border-radius: 5px;
            -webkit-transition: all 0.3s ease;
            -o-transition: all 0.3s ease;
            transition: all 0.3s ease; }
        .radio label:hover,
        .checkbox label:hover {
            background: rgba(255, 65, 54, 0.1); }
        .radio label:before,
        .checkbox label:before {
            content: "";
            display: inline-block;
            width: 17px;
            height: 17px;
            position: absolute;
            left: 15px;
            border-radius: 50%;
            background: none;
            border: 3px solid #0074D9; }
        input[type="radio"] {
            display: none; }
        input[type="radio"]:checked + label:before {
            display: none; }
        input[type="radio"]:checked + label {
            padding: 5px 15px;
            background: #0074D9;
            border-radius: 2px;
            color: #fff; }
        .checkbox label:before {
            border-radius: 3px; }
        .checkbox input[type="checkbox"] {
            display: none; }
        .checkbox input[type="checkbox"]:checked + label:before {
            display: none; }
        .checkbox input[type="checkbox"]:checked + label {
            background: #0074D9;
            color: #fff;
            padding: 5px 15px; }
    </style>
    <script type="text/javascript">
        $.extend(true, $.fn.dataTable.defaults, {
            oLanguage: {
                sSearch: "<span>Filtro:</span> _INPUT_",
                sLengthMenu: "<span>Mostrar Entradas:</span> _MENU_",
                sZeroRecords: "No se encontraron resultados",
                sProcessing: "Procesando...",
                sEmptyTable: "Ningún dato disponible para visualizar",
                sInfo: "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                sInfoEmpty: "Mostrando registros del 0 al 0 de un total de 0 registros",
                sLoadingRecords: "Cargando...",
                oPaginate: {
                    sFirst: "<i title='Inicio' class='fa fa-step-backward'></i>",
                    sLast: "<i title='Último' class='fa fa-step-forward'></i>",
                    sNext: "<i title='Siguiente' class='fa fa-fast-forward'></i>",
                    sPrevious: "<i title='Anterior' class='fa fa-fast-backward'></i>"
                },
            }
        });
        var ControllerPersons = {
            init: function (){
                var self = this;
                self.$table = $('.datatable table');
                $('[name="filter_tipopersona"], [name="filter_perfil"], [name="filter_perfil_estado"]').change(function(){
                    self.$table.dataTable().fnDraw();
                });
                self.loadDataTable();
                $("#action_min").click(function(){
                    $("#panel_filter .panel-body").hide();
                    $("#action_min").hide();
                    $("#action_max").show();
                });
                $("#action_max").click(function(){
                    $("#panel_filter .panel-body").show();
                    $("#action_min").show();
                    $("#action_max").hide();
                });


                $("#action_min").trigger("click");

                $(".action-add").click(function(){
                    var typePerson = $(this).attr('value');
                    uiModal.open('new', typePerson, 0)
                });
            },
            loadDataTable: function(){
                var self = this;
                self.$table.dataTable({
                    responsive: true,
                    searchDelay: 1000,
                    bJQueryUI: false,
                    bAutoWidth: false,
                    //bProcessing: true,
                    bServerSide: true,
                    bSort: false,
                    sPaginationType: "full_numbers",
                    iDisplayLength: 25,
                    sDom: '<"datatable-header"fl><"datatable-scroll"tr><"datatable-footer"ip>',
                    sAjaxSource: "/adm_sistemas/persons",
                    sServerMethod: "POST",
                    fnServerParams: function (aoData)
                    {
                        bloqueointerface();
                        var tipopersona = $('[name="filter_tipopersona"]:checked').val();
                        var perfil = $('[name="filter_perfil"]:checked').val();
                        var perfil_estado = $('[name="filter_perfil_estado"]:checked').val();
                        aoData.push(
                            {"name": "action", "value": 'loadDataTable'},
                            {"name": "tipopersona", "value": tipopersona},
                            {"name": "perfil", "value": perfil},
                            {"name": "perfil_estado", "value": perfil_estado},
                        );
                        //console.log(aoData);
                    },
                    aoColumnDefs:
                        [
                            {
                                aTargets: [0],
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center');
                                        $(nTd).css('vertical-align', 'middle');
                                        $(nTd).css('padding', '8px');
                                        $(nTd).attr('data-title', '#');
                                    }
                                }
                            },
                            {
                                aTargets: [1],
                                mRender: function (data, type, row)
                                {
                                    var html = ``;
                                    html += `<div><b>Tipo de Documento:</b> ${data['type_document']}</div>`;
                                    html += `<div><b>Documento:</b> ${data['document']}</div>`;
                                    html += `<div><b>${data['tipo_persona'] == 1 ? 'Persona' : 'Empresa'}:</b> ${data['nombre_completo']}</div>`;
                                    if (data['tipo_persona'] == 1) {
                                        html += `<div><b>Sexo:</b> ${data['sexo']}</div>`;
                                    }
                                    html += `<div><b>Teléfono:</b> ${data['telefono']}</div>`;
                                    html += `<div><b>Correo personal:</b> ${data['email']}</div>`;
                                    if (data['tipo_persona'] == 1) {
                                        html += `<div><b>Correo institucional:</b> ${data['emailinst']}</div>`;
                                    }

                                    return html;
                                },
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'left');
                                        $(nTd).css('vertical-align', 'middle');
                                        $(nTd).css('padding', '8px');
                                    }
                                }
                            },
                            {
                                aTargets: [2],
                                mRender: function (data, type, row)
                                {
                                    var html = ``;
                                    if (data.length > 0){
                                        for (var d in data)
                                        {
                                            html += `<div class="btn-group" style="margin-right: 3px; margin-bottom: 2px; margin-left: 0; float: left;"><a href="javascript:;" class="btn btn-tini" style="font-size: 11px !important;">${data[d]['id']} - ${data[d]['name']}</a></div>`
                                        }
                                    }
                                    return html
                                },
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'left');
                                        $(nTd).css('vertical-align', 'middle');
                                        $(nTd).css('padding', '8px');
                                    }
                                }
                            },
                            {
                                aTargets: [3],
                                mRender: function (data, type, row)
                                {
                                    var html = ``;
                                    for (var d in data)
                                    {
                                        if (data[d]['perfiles'].length > 0){
                                            html += `<div id="acordion${data[d]['id']}" class="accordion">`;
                                            html += `<div class="accordion-group">`;
                                            html += `<div class="accordion-heading" style="background: #d9edf7"><span class="accordion-toggle"><a class="action-acordion" data-toggle="collapse" data-parent="#acordion${data[d]['id']}" value="${data[d]['id']}"><i class="fa fa-tasks fa-fw"></i>${data[d]['nombre']}</a></span></div>`;
                                            html += `<div href="#${data[d]['id']}" class="accordion-body collapse" style="margin: 10px;">`;
                                            html += `<div class="accordion-heading">`;
                                            for (var m in data[d]['perfiles']) {
                                                html += `<div class="btn-group" style="margin-right: 3px; margin-bottom: 2px; margin-left: 0; float: left;"><a href="javascript:;" class="btn btn-tini" style="font-size: 11px !important;">${data[d]['perfiles'][m]['id']} - ${data[d]['perfiles'][m]['perfil']} ${data[d]['perfiles'][m]['principal']? '(<b class="text-success">PRINCIPAL</b>)':''} ${(data[d]['perfiles'][m]['visible'])? '<a href="javascript:;" class="btn btn-mini btn-success"><i class="fa fa-check"></i></a>':'<a href="javascript:;" class="btn btn-mini btn-danger"><i class="fa fa-remove"></i></a>'}</a></div>`
                                            }
                                            html += `</div>`;
                                            html += `</div>`;
                                            html += `</div>`;
                                            html += `</div>`;
                                            html += `</div>`;
                                        }

                                    }
                                    return html
                                },
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center');
                                        $(nTd).css('vertical-align', 'middle');
                                        $(nTd).css('padding', '8px');
                                        $(nTd).attr('data-title', '');
                                    }
                                }
                            },
                            {
                                aTargets: [4],
                                mRender: function (data, type, row)
                                {
                                    var html = ``;
                                    if (data['activo']){
                                        html = `<label><b>Usuario:</b> <span class="label label-success">${data['usuario']}</span></label>`;
                                    }else{
                                        html = `<label><b>Usuario:</b> <span class="label label-important">${data['usuario']}</span></label>`;
                                    }
                                    if (data['permissions'].length > 0){
                                        html += '<label><b>Permisos:</b></label>';
                                        for (var p in data['permissions'])
                                        {
                                            html += `<div class="btn-group" style="margin-right: 3px; margin-bottom: 2px; margin-left: 0; float: left;"><a href="javascript:;" class="btn btn-tini" style="font-size: 11px !important;">${data['permissions'][p]['id']} - ${data['permissions'][p]['name']}</a></div>`
                                        }
                                    }
                                    return html;
                                },
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'left');
                                        $(nTd).css('vertical-align', 'middle');
                                        $(nTd).css('padding', '8px');
                                    }
                                }
                            },
                            {
                                aTargets: [5],
                                mRender: function (data, type, row)
                                {
                                    return `<input type="hidden" class="dt-col-option" value="${data["id"]}"/> <input type="hidden" class="dt-col-data-nombre" value="${data["nombre_completo"]}"/> <input type="hidden" class="dt-col-data-is_superuser" value="${data['is_superuser']? 1:0}" /> <input type="hidden" class="dt-col-data-tipo_persona" value="${data['tipo_persona']}"/> <input type="hidden" class="dt-col-data-id_user" value="${data['id_user']}"/>`;
                                },
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center')
                                        $(nTd).css('vertical-align', 'middle')
                                        $(nTd).css('padding', '8px')
                                    }
                                }
                            },
                        ]
                    ,
                    fnDrawCallback: function (oSettingst)
                    {
                        //console.log(oSettingst);
                        desbloqueointerface();
                        var count = 0;
                        $('.accordion').each(function (){
                            $('.action-acordion', $(this)).click(function (){
                                var ref = $(this).attr('value')
                                if ($('[href="#'+ref+'"]').hasClass('in')){
                                    $(this).removeClass('collapsed');
                                    $('[href="#'+ref+'"]').removeClass('in');
                                }else{
                                    $(this).addClass('collapsed');
                                    $('[href="#'+ref+'"]').addClass('in');
                                }
                            });

                        });

                        $('.dt-col-option').each(function(){
                            var id = $(this).val();
                            var nombre_completo = $('.dt-col-data-nombre').eq(count).val().trim();
                            var is_superuser = $('.dt-col-data-is_superuser').eq(count).val().trim() == 1 ? true : false;
                            var id_user = $('.dt-col-data-id_user').eq(count).val();
                            var tipo_persona = $('.dt-col-data-tipo_persona').eq(count).val();
                            var $html = $('#el-templates [element="table-row-actions"] .table-controls').clone();
                            $('.dt-action-view', $html).click(function(){
                                uiModal.open('view', tipo_persona, id, is_superuser);
                            });

                            if (!is_superuser)
                            {
                                $('.dt-action-edit', $html).click(function(){
                                    uiModal.open('edit', tipo_persona, id, is_superuser);
                                });

                                $('.dt-action-delete', $html).click(function(){
                                    var question = `Al eliminar el registro no podra volver a recuperar los datos. <br>¿Está seguro de eliminar el ${tipo_persona == 1? 'PERSONA' : 'EMPRESA'} <span class="label label-warning">${nombre_completo}</span>?`;
                                    Confirm.ajax({"model": "Persona", 'id': id, "permission": "puede_eliminar_persona", "app_label": "bd"}, function () {
                                        Confirm.question(question, function () {
                                            bloqueointerface();
                                            var aData = {"action": "deletePerson", 'id': id}
                                            $.ajax({
                                                type: "POST",
                                                url: "/adm_sistemas/persons",
                                                data: aData,
                                                success: function(data) {
                                                    if (data.result == 'ok') {
                                                        self.$table.dataTable().fnDraw(false);
                                                        NotificationJG.success(data.mensaje)
                                                    }
                                                    else{
                                                        NotificationJG.error(data.mensaje);
                                                    }
                                                    desbloqueointerface();
                                                },
                                                error: function() {
                                                    desbloqueointerface();
                                                    NotificationJG.error("Error al enviar los datos.");
                                                },
                                                dataType: "json",
                                            });
                                        }, function () {
                                            NotificationJG.info("Enhorabuena el registro esta salvado.!");
                                            var h = $(window).height() - 350;
                                            $('#modalConfirmAjax').modal({backdrop: 'static', keyboard: false, width: "60%", height: h}).modal('show');
                                        });

                                    }, function () {
                                        NotificationJG.info("Enhorabuena el registro esta salvado.!");
                                    });
                                });

                                $('.dt-action-log', $html).click(function(){
                                    uiAuditModal.open(id_user);
                                });

                                if (id_user == 0){
                                    $(".dt-action-log", $html).addClass('disabled').hide();
                                }

                            }
                            else
                            {
                                $(".dt-action-delete", $html).addClass('disabled').hide();
                                $(".dt-action-edit", $html).addClass('disabled').hide();
                                $(".dt-action-log", $html).addClass('disabled').hide();
                            }

                            count ++;
                            $(this).after( $html );
                        });
                    }

                });
                $("#dtViewPersons_filter input").unbind(); // 'x' es el nombre de tu tabla
                $('#dtViewPersons_filter input').bind('keyup', function (e) {
                    if (e.keyCode == 13) {
                        self.$table.dataTable().fnFilter(this.value);
                    }
                });
            }

        };
        var uiModal = {
            init: function () {
                var self = this;
                self.$modalForm = $('#modalViewEdit');

                $('.action-close', self.$modalForm).click(function(){
                    self.close();
                });
                $('.action-edit', self.$modalForm).click(function(){
                    //self.setFormReadOnly(false);
                    var typePerson = $("[name='typePerson']", self.$modalForm).val();
                    self.setFormType('edit', typePerson);
                });
                $('.action-save', self.$modalForm).click(function (){
                    self.actionSave();
                });

            },
            processModalInit: function (){
                var self = this;
                $("#frmPerson", self.$modalForm).validationEngine({autoHidePrompt:true, autoHideDelay:1000 });

                $("#id_pais", self.$modalForm).change(function(){
                    var id_pais = $(this).val();
                    $("#id_provincia", self.$modalForm).select2({
                        placeholder: "---------",
                        dropdownParent: self.$modalForm,
                        ajax: {
                            url: function (params) {
                                return `/reportes?action=data&model=Provincia:pais_id=${id_pais}&p=1&s=10&q=${params.term}`;
                            },
                            dataType: 'json',
                            delay: 400,
                            data: function (params) {
                                return {
                                    q: params.term,
                                    page: params.page
                                };
                            },
                            processResults: function (data, params) {
                                params.page = params.page || 1;

                                return {
                                    results: data.results,
                                    pagination: {
                                        more: (params.page * 30) < data.total_count
                                    }
                                };
                            },
                            cache: true
                        },
                        escapeMarkup: function (markup) {
                            return markup;
                        },
                        minimumInputLength: 1,
                        templateResult: function (item) {
                            if (item.text){
                                return $('<span>' + item.text+ '</span>');
                            }else{
                                if(item.name){
                                    return $('<span>' + item.name+ '</span>');
                                }else {
                                    return '---------';
                                }
                            }
                        },
                        templateSelection: function (item) {
                            if (item.text){
                                return $('<span>' + item.text+ '</span>');
                            }else{
                                if(item.name){
                                    return $('<span>' + item.name+ '</span>');
                                }else {
                                    return '---------';
                                }
                            }
                        },
                    }).on("select2:select", function (evt) {
                        $("#id_provincia", self.$modalForm).attr({"value": (evt.params.data.id)}).change();
                    });

                });

                $("#id_provincia", self.$modalForm).change(function(){
                    var id_provincia = $(this).val();
                    $("#id_canton", self.$modalForm).select2({
                        placeholder: "---------",
                        dropdownParent: self.$modalForm,
                        ajax: {
                            url: function (params) {
                                return `/reportes?action=data&model=Canton:provincia_id=${id_provincia}&p=1&s=10&q=${params.term}`;
                            },
                            dataType: 'json',
                            delay: 400,
                            data: function (params) {
                                return {
                                    q: params.term,
                                    page: params.page
                                };
                            },
                            processResults: function (data, params) {
                                params.page = params.page || 1;

                                return {
                                    results: data.results,
                                    pagination: {
                                        more: (params.page * 30) < data.total_count
                                    }
                                };
                            },
                            cache: true
                        },
                        escapeMarkup: function (markup) {
                            return markup;
                        },
                        minimumInputLength: 1,
                        templateResult: function (item) {
                            if (item.text){
                                return $('<span>' + item.text+ '</span>');
                            }else{
                                if(item.name){
                                    return $('<span>' + item.name+ '</span>');
                                }else {
                                    return '---------';
                                }
                            }
                        },
                        templateSelection: function (item) {
                            if (item.text){
                                return $('<span>' + item.text+ '</span>');
                            }else{
                                if(item.name){
                                    return $('<span>' + item.name+ '</span>');
                                }else {
                                    return '---------';
                                }
                            }
                        },
                    }).on("select2:select", function (evt) {
                        $("#id_canton", self.$modalForm).attr({"value": (evt.params.data.id)}).change();
                    });

                });

                $("#id_canton", self.$modalForm).change(function(){
                    var id_canton = $(this).val();
                    $("#id_parroquia", self.$modalForm).select2({
                        placeholder: "---------",
                        dropdownParent: self.$modalForm,
                        ajax: {
                            url: function (params) {
                                return `/reportes?action=data&model=Parroquia:canton_id=${id_canton}&p=1&s=10&q=${params.term}`;
                            },
                            dataType: 'json',
                            delay: 400,
                            data: function (params) {
                                return {
                                    q: params.term,
                                    page: params.page
                                };
                            },
                            processResults: function (data, params) {
                                params.page = params.page || 1;

                                return {
                                    results: data.results,
                                    pagination: {
                                        more: (params.page * 30) < data.total_count
                                    }
                                };
                            },
                            cache: true
                        },
                        escapeMarkup: function (markup) {
                            return markup;
                        },
                        minimumInputLength: 1,
                        templateResult: function (item) {
                            if (item.text){
                                return $('<span>' + item.text+ '</span>');
                            }else{
                                if(item.name){
                                    return $('<span>' + item.name+ '</span>');
                                }else {
                                    return '---------';
                                }
                            }
                        },
                        templateSelection: function (item) {
                            if (item.text){
                                return $('<span>' + item.text+ '</span>');
                            }else{
                                if(item.name){
                                    return $('<span>' + item.name+ '</span>');
                                }else {
                                    return '---------';
                                }
                            }
                        },
                    }).on("select2:select", function (evt) {
                        $("#id_parroquia", self.$modalForm).attr({"value": (evt.params.data.id)});
                    });

                });

                $("#id_paisnacimiento", self.$modalForm).change(function(){
                    var id_pais = $(this).val();
                    $("#id_provincianacimiento", self.$modalForm).select2({
                        placeholder: "---------",
                        dropdownParent: self.$modalForm,
                        ajax: {
                            url: function (params) {
                                return `/reportes?action=data&model=Provincia:pais_id=${id_pais}&p=1&s=10&q=${params.term}`;
                            },
                            dataType: 'json',
                            delay: 400,
                            data: function (params) {
                                return {
                                    q: params.term,
                                    page: params.page
                                };
                            },
                            processResults: function (data, params) {
                                params.page = params.page || 1;

                                return {
                                    results: data.results,
                                    pagination: {
                                        more: (params.page * 30) < data.total_count
                                    }
                                };
                            },
                            cache: true
                        },
                        escapeMarkup: function (markup) {
                            return markup;
                        },
                        minimumInputLength: 1,
                        templateResult: function (item) {
                            if (item.text){
                                return $('<span>' + item.text+ '</span>');
                            }else{
                                if(item.name){
                                    return $('<span>' + item.name+ '</span>');
                                }else {
                                    return '---------';
                                }
                            }
                        },
                        templateSelection: function (item) {
                            if (item.text){
                                return $('<span>' + item.text+ '</span>');
                            }else{
                                if(item.name){
                                    return $('<span>' + item.name+ '</span>');
                                }else {
                                    return '---------';
                                }
                            }
                        },
                    }).on("select2:select", function (evt) {
                        $("#id_provincianacimiento", self.$modalForm).attr({"value": (evt.params.data.id)}).change();
                    });

                });

                $("#id_provincianacimiento", self.$modalForm).change(function(){
                    var id_provincia = $(this).val();
                    $("#id_cantonnacimiento", self.$modalForm).select2({
                        placeholder: "---------",
                        dropdownParent: self.$modalForm,
                        ajax: {
                            url: function (params) {
                                return `/reportes?action=data&model=Canton:provincia_id=${id_provincia}&p=1&s=10&q=${params.term}`;
                            },
                            dataType: 'json',
                            delay: 400,
                            data: function (params) {
                                return {
                                    q: params.term,
                                    page: params.page
                                };
                            },
                            processResults: function (data, params) {
                                params.page = params.page || 1;

                                return {
                                    results: data.results,
                                    pagination: {
                                        more: (params.page * 30) < data.total_count
                                    }
                                };
                            },
                            cache: true
                        },
                        escapeMarkup: function (markup) {
                            return markup;
                        },
                        minimumInputLength: 1,
                        templateResult: function (item) {
                            if (item.text){
                                return $('<span>' + item.text+ '</span>');
                            }else{
                                if(item.name){
                                    return $('<span>' + item.name+ '</span>');
                                }else {
                                    return '---------';
                                }
                            }
                        },
                        templateSelection: function (item) {
                            if (item.text){
                                return $('<span>' + item.text+ '</span>');
                            }else{
                                if(item.name){
                                    return $('<span>' + item.name+ '</span>');
                                }else {
                                    return '---------';
                                }
                            }
                        },
                    }).on("select2:select", function (evt) {
                        $("#id_cantonnacimiento", self.$modalForm).attr({"value": (evt.params.data.id)}).change();
                    });

                });

                $("#id_cantonnacimiento", self.$modalForm).change(function(){
                    var id_canton = $(this).val();
                    $("#id_parroquianacimiento", self.$modalForm).select2({
                        placeholder: "---------",
                        dropdownParent: self.$modalForm,
                        ajax: {
                            url: function (params) {
                                return `/reportes?action=data&model=Parroquia:canton_id=${id_canton}&p=1&s=10&q=${params.term}`;
                            },
                            dataType: 'json',
                            delay: 400,
                            data: function (params) {
                                return {
                                    q: params.term,
                                    page: params.page
                                };
                            },
                            processResults: function (data, params) {
                                params.page = params.page || 1;

                                return {
                                    results: data.results,
                                    pagination: {
                                        more: (params.page * 30) < data.total_count
                                    }
                                };
                            },
                            cache: true
                        },
                        escapeMarkup: function (markup) {
                            return markup;
                        },
                        minimumInputLength: 1,
                        templateResult: function (item) {
                            if (item.text){
                                return $('<span>' + item.text+ '</span>');
                            }else{
                                if(item.name){
                                    return $('<span>' + item.name+ '</span>');
                                }else {
                                    return '---------';
                                }
                            }
                        },
                        templateSelection: function (item) {
                            if (item.text){
                                return $('<span>' + item.text+ '</span>');
                            }else{
                                if(item.name){
                                    return $('<span>' + item.name+ '</span>');
                                }else {
                                    return '---------';
                                }
                            }
                        },
                    }).on("select2:select", function (evt) {
                        $("#id_parroquianacimiento", self.$modalForm).attr({"value": (evt.params.data.id)});
                    });

                });

            },
            close: function (){
                var self = this;
                self.$modalForm.modal('hide');
            },
            open: function(typeForm, typePerson, id, isEdit/*=undefined*/){

                bloqueointerface();
                isEdit = typeof isEdit == 'undefined' ? false : isEdit;

                var self = this;
                self.setFormType(typeForm, typePerson);
                if (isEdit){
                    $('.action-edit', self.$modalForm).addClass('disabled').hide();
                    $('.action-save', self.$modalForm).addClass('disabled').hide();
                }

                var h = $(window).height()-450;
                $.ajax({
                    type: "GET",
                    url: "/adm_sistemas/persons",
                    data: {'action': 'loadFormPerson', 'typeForm': typeForm, 'id': id, 'typePerson': typePerson},
                    success: function(data) {
                        if (data.result == 'ok') {
                            desbloqueointerface();
                            $(".modal-body", self.$modalForm).html(data.html);
                            self.$modalForm.modal({backdrop:'static', width: '70%'}).modal('show');
                            self.processModalInit();
                        } else {
                            desbloqueointerface();
                            NotificationJG.error(data.mensaje);
                        }
                    },
                    error: function() {
                        desbloqueointerface();
                        NotificationJG.error("Error al enviar los datos.");
                    },
                    dataType: "json",
                });
            },
            setFormType: function( typeForm /* new, edit, view */, typePerson/*=undefined*/)
            {
                var self = this;

                typePerson = typeof typePerson == 'undefined' ? 1 : typePerson;

                $('.modal-header span', self.$modalForm).html('Nuevo');

                if( typeForm == 'new' )
                {
                    if (typePerson==1)
                        $('.modal-header span', self.$modalForm).html('Nueva Persona');
                    else
                        $('.modal-header span', self.$modalForm).html('Nueva Empresa');

                    $('.action-save', self.$modalForm).show();
                    $('.action-edit', self.$modalForm).hide();
                    self.setFormReadOnly(false, typePerson);
                }
                else if( typeForm == 'edit' )
                {
                    if (typePerson==1)
                        $('.modal-header span', self.$modalForm).html('Editar Persona');
                    else
                        $('.modal-header span', self.$modalForm).html('Editar Empresa');

                    $('.action-save', self.$modalForm).show();
                    $('.action-edit', self.$modalForm).hide();
                    self.setFormReadOnly(false, typePerson);
                }
                else if( typeForm == 'view' )
                {
                    if (typePerson==1)
                        $('.modal-header span', self.$modalForm).html('Ver Persona');
                    else
                        $('.modal-header span', self.$modalForm).html('Ver Empresa');

                    $('.action-save', self.$modalForm).hide();
                    $('.action-edit', self.$modalForm).show();
                    self.setFormReadOnly(true, typePerson);
                }
            },
            setFormReadOnly: function( isFormReadOnly, typePerson )
            {
                var self = this;
                $('[name="tipo_documento"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="tipo_documento"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="documento"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="documento"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="nacimiento"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="nacimiento"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="sector"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="sector"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="direccion"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="direccion"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="direccion2"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="direccion2"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="num_direccion"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="num_direccion"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="telefono"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="telefono"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="telefono_conv"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="telefono_conv"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="email"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="email"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="pais"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="pais"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="provincia"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="provincia"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="canton"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="canton"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="parroquia"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="parroquia"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="ciudad"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="ciudad"]', self.$modalForm).prop('readonly', isFormReadOnly);

                if (typePerson == 1){
                    $('[name="sexo"]', self.$modalForm).prop('disabled', isFormReadOnly);
                    $('[name="sexo"]', self.$modalForm).prop('readonly', isFormReadOnly);
                    $('[name="nombres"]', self.$modalForm).prop('disabled', isFormReadOnly);
                    $('[name="nombres"]', self.$modalForm).prop('readonly', isFormReadOnly);
                    $('[name="apellido1"]', self.$modalForm).prop('disabled', isFormReadOnly);
                    $('[name="apellido1"]', self.$modalForm).prop('readonly', isFormReadOnly);
                    $('[name="apellido2"]', self.$modalForm).prop('disabled', isFormReadOnly);
                    $('[name="apellido2"]', self.$modalForm).prop('readonly', isFormReadOnly);
                    $('[name="paisnacimiento"]', self.$modalForm).prop('disabled', isFormReadOnly);
                    $('[name="paisnacimiento"]', self.$modalForm).prop('readonly', isFormReadOnly);
                    $('[name="provincianacimiento"]', self.$modalForm).prop('disabled', isFormReadOnly);
                    $('[name="provincianacimiento"]', self.$modalForm).prop('readonly', isFormReadOnly);
                    $('[name="cantonnacimiento"]', self.$modalForm).prop('disabled', isFormReadOnly);
                    $('[name="cantonnacimiento"]', self.$modalForm).prop('readonly', isFormReadOnly);
                    $('[name="parroquianacimiento"]', self.$modalForm).prop('disabled', isFormReadOnly);
                    $('[name="parroquianacimiento"]', self.$modalForm).prop('readonly', isFormReadOnly);
                }
                else
                {
                    $('[name="contribuyenteespecial"]', self.$modalForm).prop('disabled', isFormReadOnly);
                    $('[name="contribuyenteespecial"]', self.$modalForm).prop('readonly', isFormReadOnly);
                    $('[name="nombreempresa"]', self.$modalForm).prop('disabled', isFormReadOnly);
                    $('[name="nombreempresa"]', self.$modalForm).prop('readonly', isFormReadOnly);
                    $('[name="nombrecomercial"]', self.$modalForm).prop('disabled', isFormReadOnly);
                    $('[name="nombrecomercial"]', self.$modalForm).prop('readonly', isFormReadOnly);
                    $('[name="nombrecontacto"]', self.$modalForm).prop('disabled', isFormReadOnly);
                    $('[name="nombrecontacto"]', self.$modalForm).prop('readonly', isFormReadOnly);
                    $('[name="telefonocontacto"]', self.$modalForm).prop('disabled', isFormReadOnly);
                    $('[name="telefonocontacto"]', self.$modalForm).prop('readonly', isFormReadOnly);
                }
            },
            formGetData:function(){
                var self = this;
                var data = new FormData($("#frmPerson", self.$modalForm)[0]);
                return data;
            },
            actionSave: function (){
                var self = this;
                bloqueointerface();
                $("#frmPerson", self.$modalForm).validationEngine('attach',{ scroll: false });
                var valid = $("#frmPerson", self.$modalForm).validationEngine('validate', { scroll: false });
                if (!valid){
                    setTimeout(function() {
                        $('.help-text', self.$modalForm).each(function () {
                            var field = $(this);
                            if (field.attr('alert')) {
                                field.html(field.attr('alert'));
                            } else {
                                field.html('');
                            }
                        });
                    }, 8000);
                    desbloqueointerface();
                    return false;
                }
                $('.datepicker', self.$modalForm).css({"display": "none"});
                $('.bootstrap-timepicker-widget', self.$modalForm).css({"display": "none"});

                $('.controls input', self.$modalForm).each(function(){
                    if ($(this).attr('type')=='text'){
                        $(this).val($(this).val().trim());
                    }
                    if ($(this).attr('type')!='file'){
                        if ($(this).css('text-transform')=='uppercase'){
                            if ($(this).attr('type')!='password'){
                                $(this).val($(this).val().toUpperCase());
                            }
                        }
                    }
                });
                var aData = self.formGetData();
                //console.log(aData);
                $.ajax({
                    type: "POST",
                    url: "/adm_sistemas/persons",
                    data: aData,
                    success: function(data) {
                        if (data.result == 'ok') {
                            ControllerPersons.$table.dataTable().fnDraw(false);
                            self.close();
                            NotificationJG.success(data.mensaje);
                        }
                        else{
                            NotificationJG.error(data.mensaje);
                        }
                        desbloqueointerface();
                    },
                    error: function() {
                        desbloqueointerface();
                        NotificationJG.error("Error al enviar los datos.");
                    },
                    dataType: "json",
                    cache: false,
                    contentType: false,
                    processData: false,
                });
            },
        };

        var uiAuditModal = {
            init: function () {
                var self = this;
                self.$modalForm = $('#modalAuditoria');
                $('.action-close', self.$modalForm).click(function(){
                    self.close();
                });

            },
            close: function (){
                var self = this;
                self.$modalForm.modal('hide');
            },
            open: function(id){

                bloqueointerface();
                var self = this;
                $.ajax({
                    type: "GET",
                    url: "/adm_sistemas/persons",
                    data: {'action': 'loadAuditoria', 'id': id},
                    success: function(data) {
                        if (data.result == 'ok') {
                            $(".modal-body", self.$modalForm).html(data.contenido);
                            var h = $(window).height()-250;
                            self.$modalForm.modal({backdrop:'static', width: '80%', height: h}).modal('show');
                        } else {
                            NotificationJG.error(data.mensaje);
                        }
                        desbloqueointerface();
                    },
                    error: function() {
                        desbloqueointerface();
                        NotificationJG.error("Error al enviar los datos.");
                    },
                    dataType: "json",
                });

            },
        };

        $(function() {
            ControllerPersons.init();
            uiModal.init();
            uiAuditModal.init();
        });
    </script>
{% endblock %}
{% block atras %}/adm_sistemas{% endblock %}
{% block canvas %}
    <div class='row-fluid'>
        <div class='span6'>
            <div><h4>{{ title }}</h4></div><br>
            <div>
                {% if perms.bd.puede_agregar_persona %}
                    <a href="javascript:;" class="btn btn-success action-add" value="1"><i class="fa fa-plus"></i> Persona Natural</a>
                    <a href="javascript:;" class="btn btn-success action-add" value="2"><i class="fa fa-plus"></i> Persona Juridica</a>
                {% endif %}
            </div>
        </div>
        <div class="span6">
            <div class="panel panel-sga" id="panel_filter">
                <div class="panel-heading">
                    <h3 class="panel-title">Filtro</h3>
                    <div class="pull-right">
                        <a style="margin-right: 5px" href="javascript:;" class='btn btn-mini btn-info tu' id="action_min" title="Minimizar"><span class="fa fa-minus"></span></a>
                        <a style="margin-right: 5px" href="javascript:;" class='btn btn-mini btn-info tu' id="action_max" title="Maximizar"><span class="fa fa-plus"></span></a>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="row-fluid">
                        <div class="span3"><b>Tipo de Persona:</b></div>
                        <div class="span9">
                            <div class="radio">
                                <input type="radio" id="filter_tipopersona_all" name="filter_tipopersona" value="0">
                                <label class="" for="filter_tipopersona_all">Ambos</label>
                                <input type="radio" id="filter_tipopersona_natural" name="filter_tipopersona" value="1" checked="checked">
                                <label class="" for="filter_tipopersona_natural"><span class="label label-success">NATURAL</span></label>
                                <input type="radio" id="filter_tipopersona_juridica" name="filter_tipopersona" value="2">
                                <label class="" for="filter_tipopersona_juridica"><span class="label label-danger">JURIDICA</span></label>
                            </div>
                        </div>
                    </div>
                    <div class="row-fluid">
                        <div class="span3"><b>Perfil:</b></div>
                        <div class="span9">
                            <div class="radio">
                                <input type="radio" id="filter_perfil_all" name="filter_perfil" value="0" checked="checked">
                                <label class="" for="filter_perfil_all"><span class="label label-info">Ninguno</span></label>
                                <input type="radio" id="filter_perfil_administrativo" name="filter_perfil" value="1">
                                <label class="" for="filter_perfil_administrativo"><span class="label label-inverse">Administrativo</span></label>
                                <input type="radio" id="filter_perfil_docente" name="filter_perfil" value="2">
                                <label class="" for="filter_perfil_docente"><span class="label label-inverse">Docente</span></label>
                                <input type="radio" id="filter_perfil_estudiante" name="filter_perfil" value="3">
                                <label class="" for="filter_perfil_estudiante"><span class="label label-inverse">Estudiante</span></label>
                            </div>
                        </div>
                    </div>
                    <div class="row-fluid">
                        <div class="span3"><b>Estado Perfil:</b></div>
                        <div class="span9">
                            <div class="radio">
                                <input type="radio" id="filter_perfil_estado_all" name="filter_perfil_estado" value="0" checked="checked">
                                <label class="" for="filter_perfil_estado_all"><span class="label label-info">Ambos</span></label>
                                <input type="radio" id="filter_perfil_estado_activo" name="filter_perfil_estado" value="1">
                                <label class="" for="filter_perfil_estado_activo"><span class="label label-success"><i class="fa fa-check"></i></span></label>
                                <input type="radio" id="filter_perfil_estado_inactivo" name="filter_perfil_estado" value="2">
                                <label class="" for="filter_perfil_estado_inactivo"><span class="label label-important"><i class="fa fa-close"></i></span></label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="no-more-tables">
        <div class='row-fluid'>
            <div class='span12'>
                <div class="datatable" id="divDetailData">
                    <table id="dtViewPersons" class='table table-bordered table-striped'>
                        <thead>
                        <tr>
                            <th style="text-align: center; vertical-align: middle; width: 5%">#</th>
                            <th style="text-align: center; vertical-align: middle; width: 25%">Datos</th>
                            <th style="text-align: center; vertical-align: middle; width: 20%">Grupos</th>
                            <th style="text-align: center; vertical-align: middle; width: 20%">Perfiles</th>
                            <th style="text-align: center; vertical-align: middle; width: 20%">Usuario/Permisos</th>
                            <th style="text-align: center; vertical-align: middle; width: 10%"></th>
                        </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div id="el-templates" style="display:none;">
        <div element="table-row-actions">
            <table>
                <tbody>
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>
                        <div class="table-controls">
                            <div class="btn-group">
                                <a class="btn btn-mini dropdown-toggle" data-toggle="dropdown" href="javascript:;">Acciones<span class="caret"></span>
                                </a>
                                <ul class="dropdown-menu pull-right" style="text-align: left">
                                    <li><a href="javascript:;" class="dt-action-view"><i class="fa fa-eye"></i> Ver</a></li>
                                    {% if perms.bd.puede_modificar_persona %}
                                        <li><a href="javascript:;" class="dt-action-edit"><i class="fa fa-edit"></i> Editar</a></li>
                                    {% endif %}
                                    {% if perms.bd.puede_eliminar_persona %}
                                        <li><a href="javascript:;" class="dt-action-delete"><i class="fa fa-trash"></i> Eliminar</a></li>
                                    {% endif %}
                                    <li><a href="javascript:;" class="dt-action-log"><i class="fa fa-bug"></i> Auditoría</a></li>
                                </ul>
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade static" id="modalViewEdit" style="display: none;">
        <div class="modal-header">
            <h4 class="paneltitle"><span></span></h4>
        </div>
        <div class="modal-body panelbody">

        </div>
        <div class="modal-footer">
            {% if perms.bd.puede_modificar_persona %}
                <a href="javascript:;" class="btn btn-success action-save">Guardar</a>
                <a href="javascript:;" class="btn btn-info action-edit">Editar</a>
            {% endif %}
            <a href="javascript:;" class="btn btn-danger action-close"> Cerrar</a>
        </div>
    </div>

    <div class="modal fade static" id="modalAuditoria" style="display: none;">
        <div class="modal-header">
            <h4 class="paneltitle">Auditoría</h4>
        </div>
        <div class="modal-body panelbody">

        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn btn-info action-close"> Cerrar</a>
        </div>
    </div>

{% endblock %}
