{% extends "ajaxformbs.html" %}
{% block atras %}/af_activofijo?action=histconstatacion&id={{ constatacion.id }}{% endblock %}
{% block titulo %}{{ title }}{% endblock %}
{% block formaction %}/af_activofijo{% endblock %}
{% block form-type %}form-vertical{% endblock %}
{% block formdestination %}/af_activofijo?action=histconstatacion&id={{ constatacion.id }}{% endblock %}
{% block formwidth %}form-xl{% endblock %}
{% block extraheading %}
    <script>
        var pagina_bienes_usuario = 1;
        var pagina_bienes_otro_usuario = 1;
        var pagina_bienes_no_identificados = 1;

        $(function(){

            $("#observacion").css({"text-transform": "uppercase"});
            $("#id_catalogobien, #id_estado").val(0).trigger("change");
            $("#id_catalogobien_select2").val(0).trigger("change");

            cargar_pagina_activos_usuario = function (pag, id) {
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/af_activofijo",
                    data: { 'action': 'activosusuarioconstatacion', 'page': pag , 'id': '{{ constatacion.id }}'},
                    success: function(data) {
                        $.unblockUI();
                        if (data.result=='ok'){
                            contador_pertenece(data.contador);
                            $("#detalleactivos").html(data.data);
                            check_todos();
                            check_encontrado();
                            check_enuso();
                            check_estado();
                            check_requieretras();
                            observaciones();
                            tooltips();
                            pagina_bienes_usuario = pag;
                            if (id > 0){
                                if ($("#encontrado_"+id).is(':checked')){
                                    smoke.alert("Activo ya fue seleccionado.");
                                }else{
                                    $("#encontrado_"+id).prop('checked', true);
                                    seleccionar_elemento(id, 'true');
                                }
                            }
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        smoke.alert("Error de conexión.");
                    },
                    dataType: "json"
                });
            };

            cargar_pagina_activos_otros_usuarios = function (pag, id) {
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/af_activofijo",
                    data: { 'action': 'activosotrousuarioconstatacion', 'page': pag , 'id': '{{ constatacion.id }}'},
                    success: function(data) {
                        $.unblockUI();
                        if (data.result=='ok'){
                            contadores_otros(data.contador);
                            $("#detalleactivosotros").html(data.data);
                            check_enusootro();
                            check_traspaso();
                            check_estado_otro();
                            eliminar_detalle_otro();
                            observaciones();
                            tooltips();
                            pagina_bienes_otro_usuario = pag;
                            if (id > 0){
                                $("#encontrado_"+id).trigger('click');
                            }
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        smoke.alert("Error de conexión.");
                    },
                    dataType: "json"
                });
            };

            cargar_pagina_activos_noidentificados= function (pag, id) {
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/af_activofijo",
                    data: { 'action': 'activosnoidentificadosconstatacion', 'page': pag , 'id': '{{ constatacion.id }}'},
                    success: function(data) {
                        $.unblockUI();
                        if (data.result=='ok'){
                            contadores_ni(data.contador);
                            $("#detalleactivosni").html(data.data);
                            eliminar_detalle_noiden();
                            observaciones();
                            tooltips();
                            pagina_bienes_otro_usuario = pag;
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        smoke.alert("Error de conexión.");
                    },
                    dataType: "json"
                });
            };

            contador_pertenece = function (contador) {
                $("#totalactivos").html(contador.activos_totales);
                $('#totalactivosseleccionados').html(contador.tot_encontrados);
                $('#totalactivosfalta').html(contador.tot_falta);
                $('#totalactivosenuso').html(contador.tot_uso);
                $('#totalmalestado').html(contador.tot_mal_estado);
                $('#totalregular').html(contador.tot_reg);
            };

            contadores_otros = function (contador) {
                $('#totaldesuso_otro').html(contador.tot_desuso_otro);
                $('#totalotros').html(contador.tot_otros);
                $('#totalmalestado_otro').html(contador.mal_estado_otro);
                $('#totalregular_otro').html(contador.tot_estado_reg_otro);
            };

            contadores_ni = function (contador) {
                $('#totalni').html(contador.tot_ni);
                $('#totalmalestado_noiden').html(contador.mal_ni);
                $('#totalregular_noiden').html(contador.reg_ni);
            };

            seleccionar_elemento = function (id, estado) {
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/af_activofijo",
                    data: {"action": "marcarencontrado", "id": id, "valencontrado": estado},
                    success: function(data) {
                        $.unblockUI();
                        if (data.result=='ok'){
                            contador_pertenece(data.contador);
                            if (data.reload=='True'){
                                cargar_pagina_activos_usuario(pagina_bienes_usuario, 0);
                            }else{
                                if (estado == 'true'){
                                    $("#enuso_"+id).removeAttr('disabled');
                                    $("#requieretras_"+id).removeAttr('disabled');
                                    $("#estado_"+id).removeAttr('disabled');
                                    $("#enuso_"+id).prop('checked', true);
                                }else{
                                    $("#enuso_"+id).prop('checked', false);
                                    $("#enuso_"+id).attr({'disabled': 'disabled'});
                                    $("#requieretras_"+id).attr({'disabled': 'disabled'});
                                    $("#estado_"+id).attr({'disabled': 'disabled'});
                                    $("#requieretras_"+id).prop('checked', false);
                                }
                            }
                        } else {
                            if (estado == 'true'){
                                $("#encontrado_"+id).prop('checked', false);
                                $("#enuso_"+id).prop('checked', false);
                                $("#requieretras_"+id).prop('checked', false);
                                $("#enuso_"+id).attr({'disabled': 'disabled'});
                                $("#requieretras_"+id).attr({'disabled': 'disabled'});
                                $("#estado_"+id).attr({'disabled': 'disabled'});
                            }else{
                                $("#encontrado_"+id).prop('checked', true);
                                $("#enuso_"+id).removeAttr('disabled');
                                $("#requieretras_"+id).removeAttr('disabled');
                                $("#estado_"+id).removeAttr('disabled');
                            }
                            smoke.alert(data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        if (estado == 'true'){
                            $("#encontrado_"+id).prop('checked', false);
                            $("#enuso_"+id).prop('checked', false);
                            $("#enuso_"+id).attr({'disabled': 'disabled'});
                            $("#requieretras_"+id).attr({'disabled': 'disabled'});
                            $("#estado_"+id).attr({'disabled': 'disabled'});
                        }else{
                            $("#encontrado_"+id).prop('checked', true);
                            $("#enuso_"+id).removeAttr('disabled');
                            $("#requieretras_"+id).removeAttr('disabled');
                            $("#estado_"+id).removeAttr('disabled');
                        }
                        smoke.alert("Error de conexión.");
                    },
                    dataType: "json"
                });
            };

              ItemsDisplay = function (item) {
                if (item.name){
                    return $('<span>' + item.name+ '</span>');
                }else{
                    return $('<span>' + $("#id_usuariobienes").attr('descripcion') + '</span>');
                }
            };

            marcar_todos = function (id) {
                let mensaje='Esta por marcar o desmarcar todos los registros'
                Swal.fire({
                    title: `${mensaje}`,
                    text: "¿Seguro que desea realizar esta acción?.",
                    type: 'info',
                    showCancelButton: true,
                    allowOutsideClick: false,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Si, deseo hacerlo',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.value) {
                        bloqueointerface();
                       $.ajax({
                            type: "POST",
                            url: "/af_activofijo",
                            data: {"action": "marcartodosencontrado", "id": id},
                            success: function(data) {
                                if (data.result=='ok'){
                                    location.href=location.href;
                                } else {
                                    $.unblockUI();
                                    smoke.alert(data.mensaje);
                                }
                            },
                            error: function() {
                                $.unblockUI();
                                smoke.alert("Error de conexión.");
                            },
                            dataType: "json"
                        });
                    } else {
                    }
                })

            };

            check_todos = function () {
                $("#todos").unbind();
                $("#todos, #todos_d").click(function () {
                    var elemento = $(this);
                    var id = elemento.attr('ida');
                    var tipo = elemento.attr('tipo');
                    marcar_todos(id);
                });
            };

            check_encontrado = function () {
                $(".encontrado").unbind();
                $(".encontrado").click(function () {
                    var estado = "false";
                    var elemento = $(this);
                    var id = elemento.attr('ida');
                    if(elemento.is(":checked")){
                        estado = "true"
                    }
                    seleccionar_elemento(id, estado);
                });
            };

            check_enuso = function () {
                $(".enuso").unbind();
                $(".enuso").click(function () {
                    var elemento = $(this);
                    var id = elemento.attr("ida");
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/af_activofijo",
                        data: {"action": "marcarenuso", "id": id, "valenuso": elemento.is(':checked')},
                        success: function(data) {
                            $.unblockUI();
                            if (data.result=='ok'){
                                contador_pertenece(data.contador);
                                if (data.reload=='True'){
                                    cargar_pagina_activos_usuario(pagina_bienes_usuario, 0);
                                }else{
                                    if (elemento.is(':checked')){
                                        $("#enuso_"+id).prop('checked', true);
                                    }else{
                                        $("#enuso_"+id).prop('checked', false);
                                    }
                                }
                            } else {
                                if (elemento.is(':checked')){
                                    elemento.prop('checked', false);
                                    $("#enuso_"+id).prop('checked', false);
                                }else{
                                    elemento.prop('checked', true);
                                }
                                smoke.alert(data.mensaje);
                            }
                        },
                        error: function() {
                            $.unblockUI();
                            if (elemento.is(':checked')){
                                elemento.prop('checked', false);
                                $("#enuso_"+id).prop('checked', false);
                            }else{
                                elemento.prop('checked', true);
                            }
                            smoke.alert("Error de conexión.");
                        },
                        dataType: "json"
                    });
                });
            };

            eliminar_detalle_otro = function () {
                $(".eliminar").unbind();
                $(".eliminar").click(function () {
                    var elemento = $(this);
                    var id = elemento.attr("ida");
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/af_activofijo",
                        data: {"action": "eliminar_otro", "id": id},
                        success: function(data) {
                            $.unblockUI();
                            if (data.result=='ok'){
                                contadores_otros(data.contador);
                                cargar_pagina_activos_otros_usuarios(pagina_bienes_otro_usuario, 0);
                            } else {
                                smoke.alert(data.mensaje);
                            }
                        },
                        error: function() {
                            $.unblockUI();
                            smoke.alert("Error de conexión.");
                        },
                        dataType: "json"
                    });
                });
            };

            eliminar_detalle_noiden = function () {
                $(".eliminarni").unbind();
                $(".eliminarni").click(function () {
                    var elemento = $(this);
                    var id = elemento.attr("ida");
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/af_activofijo",
                        data: {"action": "eliminar_noiden", "id": id},
                        success: function(data) {
                            $.unblockUI();
                            if (data.result=='ok'){
                                contadores_ni(data.contador);
                                cargar_pagina_activos_noidentificados(pagina_bienes_no_identificados, 0);
                            } else {
                                smoke.alert(data.mensaje);
                            }
                        },
                        error: function() {
                            $.unblockUI();
                            smoke.alert("Error de conexión.");
                        },
                        dataType: "json"
                    });
                });
            };

            check_enusootro = function () {
                $(".enusootro").unbind();
                $(".enusootro").click(function () {
                    var elemento = $(this);
                    var id = elemento.attr("ida");
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/af_activofijo",
                        data: {"action": "marcarenusootro", "id": id, "valenuso": elemento.is(':checked')},
                        success: function(data) {
                            $.unblockUI();
                            if (data.result=='ok'){
                                contadores_otros(data.contador);
                                if (data.reload=='True'){
                                    cargar_pagina_activos_otros_usuarios(pagina_bienes_otro_usuario, 0);
                                }else{
                                    if (elemento.is(':checked')){
                                        elemento.prop('checked', true);
                                    }else{
                                        elemento.prop('checked', false);
                                    }
                                }
                            } else {
                                if (elemento.is(':checked')){
                                    elemento.prop('checked', false);
                                }else{
                                    elemento.prop('checked', true);
                                }
                                smoke.alert(data.mensaje);
                            }
                        },
                        error: function() {
                            $.unblockUI();
                            if (elemento.is(':checked')){
                                elemento.prop('checked', false);
                                $("#enusootro_"+id).prop('checked', false);
                            }else{
                                elemento.prop('checked', true);
                            }
                            smoke.alert("Error de conexión.");
                        },
                        dataType: "json"
                    });
                });
            };

            check_traspaso = function () {
                $(".requieretrasotro").unbind();
                $(".requieretrasotro").click(function () {
                    var elemento = $(this);
                    var id = elemento.attr("ida");
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/af_activofijo",
                        data: {"action": "marcarrequieretrasotro", "id": id, "valrequieretrasotro": elemento.is(':checked')},
                        success: function(data) {
                            $.unblockUI();
                            if (data.result=='ok'){
                                contadores_otros(data.contador);
                                if (data.reload=='True'){
                                    cargar_pagina_activos_otros_usuarios(pagina_bienes_otro_usuario, 0);
                                }else{
                                    if (elemento.is(':checked')){
                                        elemento.prop('checked', true);
                                        $("#obs_"+id).removeAttr('disabled');
                                    }else{
                                        elemento.prop('checked', false);
                                        $("#obs_"+id).attr({'disabled':'disabled'});
                                    }
                                }
                            } else {
                                if (elemento.is(':checked')){
                                    elemento.prop('checked', false);
                                    $("#obs_"+id).attr({'disabled':'disabled'});
                                }else{
                                    elemento.prop('checked', true);
                                    $("#obs_"+id).removeAttr('disabled');
                                }
                                smoke.alert(data.mensaje);
                            }
                        },
                        error: function() {
                            $.unblockUI();
                            if (elemento.is(':checked')){
                                elemento.prop('checked', false);
                                $("#obs_"+id).attr({'disabled':'disabled'});
                            }else{
                                elemento.prop('checked', true);
                                $("#obs_"+id).removeAttr('disabled');
                            }
                            smoke.alert("Error de conexión.");
                        },
                        dataType: "json"
                    });
                });
            };

            check_requieretras = function () {
                $(".requieretras").unbind();
                $(".requieretras").click(function () {
                    var elemento = $(this);
                    var id = elemento.attr("ida");
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/af_activofijo",
                        data: {"action": "marcartras", "id": id, "valrequieretras": elemento.is(':checked')},
                        success: function(data) {
                            $.unblockUI();
                            if (data.result=='ok'){
                                contador_pertenece(data.contador);
                                if (data.reload=='True'){
                                    cargar_pagina_activos_usuario(pagina_bienes_usuario, 0);
                                }else{
                                    if (elemento.is(':checked')){
                                        $("#requieretras_"+id).prop('checked', true);
                                        $("#obs_"+id).removeAttr('disabled');
                                    }else{
                                        $("#requieretras_"+id).prop('checked', false);
                                        $("#obs_"+id).attr({'disabled':'disabled'});
                                    }
                                }
                                observaciones();
                            } else {
                                if (elemento.is(':checked')){
                                    elemento.prop('checked', false);
                                    $("#requieretras_"+id).prop('checked', false);
                                    $("#obs_"+id).attr({'disabled':'disabled'});
                                }else{
                                    elemento.prop('checked', true);
                                    $("#requieretras_"+id).prop('checked', true);
                                    $("#obs_"+id).removeAttr('disabled');
                                }
                                smoke.alert(data.mensaje);
                            }
                        },
                        error: function() {
                            $.unblockUI();
                            if (elemento.is(':checked')){
                                elemento.prop('checked', false);
                                $("#requieretras_"+id).prop('checked', false);
                                $("#obs_"+id).attr({'disabled':'disabled'});
                            }else{
                                elemento.prop('checked', true);
                                $("#requieretras_"+id).prop('checked', true);
                                $("#obs_"+id).removeAttr('disabled');
                            }
                            smoke.alert("Error de conexión.");
                        },
                        dataType: "json"
                    });
                });
            };

            check_estado = function () {
                $(".estado").unbind();
                $(".estado").change(function () {
                    var elemento = $(this);
                    var id = elemento.attr("ida");
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/af_activofijo",
                        data: {"action": "actualizaestado", "id": id, "valestado": elemento.val()},
                        success: function(data) {
                            $.unblockUI();
                            if (data.result=='ok'){
                                contador_pertenece(data.contador);
                                if (data.reload=='True'){
                                    cargar_pagina_activos_usuario(pagina_bienes_usuario, 0);
                                }else{
                                    elemento.attr({'va': elemento.val()});
                                }
                            } else {
                                elemento.val(elemento.attr('va'));
                                smoke.alert(data.mensaje);
                            }
                        },
                        error: function() {
                            $.unblockUI();
                            elemento.val(elemento.attr('va'));
                            smoke.alert("Error de conexión.");
                        },
                        dataType: "json"
                    });
                });
            };

            check_estado_otro = function () {
                $(".estadootro").unbind();
                $(".estadootro").change(function () {
                    var elemento = $(this);
                    var id = elemento.attr("ida");
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/af_activofijo",
                        data: {"action": "actualizaestadootro", "id": id, "valestado": elemento.val()},
                        success: function(data) {
                            $.unblockUI();
                            if (data.result=='ok'){
                                contadores_otros(data.contador);
                                if (data.reload=='True'){
                                    cargar_pagina_activos_otros_usuarios(pagina_bienes_otro_usuario, 0);
                                }else{
                                    elemento.attr({'va': elemento.val()});
                                }
                            } else {
                                elemento.val(elemento.attr('va'));
                                smoke.alert(data.mensaje);
                            }
                        },
                        error: function() {
                            $.unblockUI();
                            elemento.val(elemento.attr('va'));
                            smoke.alert("Error de conexión.");
                        },
                        dataType: "json"
                    });
                });
            };

            cargar_pagina_activos_usuario(pagina_bienes_usuario, 0);
            cargar_pagina_activos_otros_usuarios(pagina_bienes_otro_usuario, 0);
            cargar_pagina_activos_noidentificados(pagina_bienes_no_identificados,0);

            $("#FilterTextBox").keypress(function(event){
                var keycode = (event.keyCode ? event.keyCode : event.which);
                var codigo = $(this).val().trim();
                if(keycode == '13' && codigo.length > 0) {
                    $.unblockUI();
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/af_activofijo",
                        data: {"action": "buscarcodigoconstatacion", "id": '{{ constatacion.id }}', "codigo": codigo},
                        success: function(data) {
                            $.unblockUI();
                            if (data.result=='ok'){
                                if (data.encontrado=='True'){
                                    if (data.pertenece == 'True'){
                                        if (data.pagina != pagina_bienes_usuario){
                                            cargar_pagina_activos_usuario(data.pagina, data.id);
                                        }else{
                                            if (data.id > 0){
                                                if ($("#encontrado_"+data.id).is(':checked')){
                                                    smoke.alert("Activo ya fue seleccionado.");
                                                }else{
                                                    $("#encontrado_"+data.id).prop('checked', true);
                                                    seleccionar_elemento(data.id, 'true');
                                                }
                                            }
                                        }
                                    }else{
                                        cargar_pagina_activos_otros_usuarios(data.pagina, 0);
                                        smoke.alert("Activo de otro usuario encontrado.");
                                    }
                                    $("#FilterTextBox").val('');
                                }else{
                                    $("#id_descripcion, #id_serie, #id_modelo, #id_marca").val("");
                                    $("#id_codigobarra").val($("#FilterTextBox").val());
                                    $("#incompletoni").hide();
                                    $("#itemspanelni").modal({width: '900'}).modal('show');
                                }
                            } else {
                                smoke.alert(data.mensaje);
                            }
                        },
                        error: function() {
                            $.unblockUI();
                            smoke.alert("Error de conexión.");
                        },
                        dataType: "json"
                    });
                }
            });



            observaciones = function () {
                $(".obser").unbind();

                $(".obser").click(function () {
                    var id = $(this).attr('ida');
                    var texto = $(this).attr('va');
                    if ($(this).attr('tipo') == 'bu'){
                        if ($("#requieretras_"+id).is(":checked")){
                            $("#observacion").val(texto);
                            $("#adicionarobs").attr({'ida': id});
                            $("#itemspanelobs").modal('show');
                        }
                    }else{
                        if ($("#requieretrasotro_"+id).is(":checked")){
                            $("#observacion").val(texto);
                            $("#adicionarobs").attr({'ida': id});
                            $("#itemspanelobs").modal('show');
                        }
                    }

                });
            };

            $("#adicionarobs").click(function () {
                $("#itemspanelobs").modal('hide');
                bloqueointerface();
                var elemento = $(this);
                var id = elemento.attr("ida");
                var texto = $("#observacion").val();
                $.ajax({
                    type: "POST",
                    url: "/af_activofijo",
                    data: {"action": "actualizaobservacion", "id": id, "valobser": texto},
                    success: function(data) {
                        $.unblockUI();
                        if (data.result=='ok'){
                            $("#obs_"+id).attr({'va': texto});
                        } else {
                            smoke.alert(data.mensaje, function(e){
                                $("#itemspanelobs").modal('show');
                            }, {
                                ok: "ok",
                                classname: "custom-class"
                            });
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        smoke.alert("Error de conexión.", function(e){
                            $("#itemspanelobs").modal('show');
                        }, {
                            ok: "ok",
                            classname: "custom-class"
                        });
                    },
                    dataType: "json"
                });
            });

            $("#adicionarni").click(function () {
                bloqueointerface();
                var elemento = $(this);
                var codigoactivo = $("#id_codigobarra").val();
                var codcatalogo = $("#id_catalogobien").val();
                var descripcion = $("#id_descripcion").val();
                var serie = $("#id_serie").val();
                var modelo = $("#id_modelo").val();
                var marca = $("#id_marca").val();
                var codestado = $("#id_estado").val();
                if (codestado && descripcion && serie && marca && modelo) {
                    $("#itemspanelni").modal('hide');
                    $("#incompletoni").hide();
                    $.ajax({
                        type: "POST",
                        url: "/af_activofijo",
                        data: {"action": "detallenoidentificado", "id": {{ constatacion.id }}, "codigo": codigoactivo, "catalogo": codcatalogo, "descripcion": descripcion, "serie": serie, "modelo": modelo, "marca": marca, "codestado": codestado},
                        success: function(data) {
                            $.unblockUI();
                            if (data.result=='ok'){
                                contadores_ni(data.contador);
                                cargar_pagina_activos_noidentificados(pagina_bienes_no_identificados, data.pagina);
                            } else {
                                smoke.alert(data.mensaje, function(e){
                                    $("#itemspanelni").modal({width: '900'}).modal('show');
                                }, {
                                    ok: "ok",
                                    classname: "custom-class"
                                });
                            }
                        },
                        error: function() {
                            $.unblockUI();
                            smoke.alert("Error de conexión.", function(e){
                                $("#itemspanelni").modal({width: '900'}).modal('show');
                            }, {
                                ok: "ok",
                                classname: "custom-class"
                            });
                        },
                        dataType: "json"
                    });
                } else {
                    $.unblockUI();
                    $("#incompletoni").show();
                    return true;
                }

            });

            $("#cerrarobs").click(function(){
                $("#itemspanelobs").modal('hide');
            });
            $("#cerrarni").click(function(){
                $("#itemspanelni").modal('hide');
            });

            ItemsDisplay = function (item) {
                if (item.name){
                    return $('<span>' + item.name+ '</span>');
                }else{
                    return '---------';
                }
            };

            $("#id_catalogobien_select2").select2({
                placeholder: "---------",
                allowClear: true,
                ajax: {
                    url: function (params) {
                        return "/reportes?action=data&model=CatalogoBien&p=1&s=10&q=" + params.term;
                    },
                    dataType: 'json',
                    delay: 400,
                    data: function (params) {
                        return {
                            q: params.term,
                            page: params.page
                        };
                    },
                    processResults: function (data, params) {
                        params.page = params.page || 1;

                        return {
                            results: data.results,
                            pagination: {
                                more: (params.page * 30) < data.total_count
                            }
                        };
                    },
                    cache: true
                },
                escapeMarkup: function (markup) { return markup; },
                minimumInputLength: 1,
                templateResult: ItemsDisplay,
                templateSelection: ItemsDisplay
            }).on("select2:select", function (evt) {
                $("#id_catalogobien").attr({"value":(evt.params.data.id)});
                $("#id_catalogobien").attr({"desc":(evt.params.data.name)});
            });

            tipo_formulario($("#form3"));

            observaciones();
        });
    </script>
{% endblock %}
{% block formextra %}
    <input type='hidden' name='action' value='editcons'/>
    <input type='hidden' name='id' value='{{ constatacion.id }}'/>
{% endblock %}
{% block formback %}/af_activofijo?action=histconstatacion&id={{ constatacion.id }}{% endblock %}
{% block formsuffix %}
    <div class="row-fluid">
        <table class="table table-condensed">
            <tr>
                <th style="width: 50%">
                    <input type="search" style="text-transform: uppercase; margin-bottom: 0px" class="input-block-level" id="FilterTextBox" name="FilterTextBox">
                </th>
                <th style="width: 50%; vertical-align: middle; font-size: 9px">
                    <div style="float: left;">Activos:<b> <span id="totalactivos">0</span></b></div>
                    <div style="float: left; margin-left: 30px">Encontrados:<b> <span id="totalactivosseleccionados">0</span></b></div>
                    <div style="float: left; margin-left: 30px">Faltantes:<b> <span id="totalactivosfalta">0</span></b></div>
                    <div style="float: left; margin-left: 30px">En uso:<b> <span id="totalactivosenuso">0</span></b></div>
                    <div style="float: left; margin-left: 30px">Mal Estado:<b> <span id="totalmalestado">0</span></b></div>
                    <div style="float: left; margin-left: 30px">E. Regular:<b> <span id="totalregular">0</span></b></div>
                </th>
            </tr>
        </table>
        <div id="detalleactivos" style="width: 100%;">

        </div>
    </div>
    <div class="row-fluid">
        <table class="table table-bordered" style="margin-bottom: 0">
            <thead>
            <tr>
                <th style="width: 50%">
                    BIENES DE OTROS USUARIOS
                </th>
                <th style="font-size: 9px">
                    <div style="float: left; margin-left: 30px">T. Bienes otros:<b> <span id="totalotros">0</span></b></div>
                    <div style="float: left; margin-left: 30px">T. Mal Estado:<b> <span id="totalmalestado_otro">0</span></b></div>
                    <div style="float: left; margin-left: 30px">T. Estado Regular:<b> <span id="totalregular_otro">0</span></b></div>
                    <div style="float: left; margin-left: 30px">T. Desuso:<b> <span id="totaldesuso_otro">0</span></b></div>
                </th>
            </tr>
        </table>
        <div id="detalleactivosotros" style="width: 100%;">

        </div>
    </div>
    <div class="row-fluid">
        <table class="table table-bordered" style="margin-bottom: 0">
            <thead>
            <tr>
                <th style="width: 50%;">
                    NO IDENTIFICADOS
                </th>
                <th>
                    <div style="float: left; margin-left: 30px">T. No iden.:<b> <span id="totalni">0</span></b></div>
                    <div style="float: left; margin-left: 30px">T. Mal Estado:<b> <span id="totalmalestado_noiden">0</span></b></div>
                    <div style="float: left; margin-left: 30px">T. Estado Regular:<b> <span id="totalregular_noiden">0</span></b></div>
                </th>
            </tr>
            </thead>
        </table>
        <div id="detalleactivosni" style="width: 100%;">

        </div>
    </div>
{% endblock %}
{% block moreblock %}
    <div class="modal fade static" id="itemspanelni">
        <div class="modal-header">
            <h3 class="paneltitle">Adicionar Activo</h3>
        </div>
        <div class="modal-body">
            <div class="alert alert-info" id="incompletoni" style="display: none;">
                <i class="fa fa-info-sign"></i> Complete todos los campos para continuar
            </div>
            <div class="alert alert-danger" id="alertaingresoni" style="display: none;">
                Ya se encuentra en la lista
            </div>
            <div class="row-fluid">
                <form id="form3" class=" form-modal"  style="margin-bottom: 0; width: 870px" formtype="form-vertical">
                    {% for field in form3 %}
                        {% if field.field.widget.attrs.separator %}
                            <div style="width: 100%; height: 1px; float: left;"></div>
                        {% endif %}
                        <fieldset id="fieldset_{{ field.name }}" class="control-group nomargins" style="min-height:35px; float: left; width: {% if field.field.widget.attrs.formwidth %}{{ field.field.widget.attrs.formwidth }}{% else %}100%{% endif %}" >
                            <div class="control-label label-text" {% if field.field.widget.attrs.labelwidth %}labelwidth="{{ field.field.widget.attrs.labelwidth }}"{% endif %} style="display: table;height: 30px;">
                                <div style="display: table-cell; vertical-align: middle; line-height: 11px">
                                    <label for="id_{{ field.name }}" style="padding-right: 20px">{{ field.label }}</label>
                                </div>
                            </div>
                            <div class="control" style="float: left; width: {% if field.field.widget.attrs.controlwidth %}{{ field.field.widget.attrs.controlwidth }}{% else %}0{% endif %}">
                                {% if field.field.widget.attrs.select2search %}
                                    <select id="id_{{ field.name }}_select2" {% if field.field.widget.attrs.disabled %}disabled=""{% endif %} >
                                        <option value="0" selected="selected">---------</option>
                                    </select>
                                    <input name="{{ field.name }}" id="id_{{ field.name }}" value="{{ field.value }}" hidden="hidden" {% if field.field.widget.attrs.descripcion %}descripcion="{{ field.field.widget.attrs.descripcion }}"{% endif %} class="select2hidden">
                                {% else %}
                                    {{ field }}
                                {% endif %}
                                <p class="help-text" style="font-size: xx-small; margin-bottom: 0; height: 13px; line-height: 13px">{{ field.help_text }} </p>
                            </div>
                        </fieldset>
                    {% endfor %}
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" id="adicionarni" class="btn btn-adicionar btn-success"><i class="fa fa-plus"></i> Adicionar</a>
            <a href="javascript:;" id="cerrarni" class="btn btn-cerrar btn-info">Cerrar</a>
        </div>
    </div>


    <div class="modal fade static" id="itemspanelobs">
        <div class="modal-header">
            <h3 class="paneltitle">Adicionar Observación</h3>
        </div>
        <div class="modal-body">
            <div class="row-fluid">
                <textarea style="width: 100%" id="observacion"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" id="adicionarobs" class="btn btn-adicionar btn-success"><i class="fa fa-plus"></i> Adicionar</a>
            <a href="javascript:;" id="cerrarobs" class="btn btn-cerrar btn-info">Cerrar</a>
        </div>
    </div>
{% endblock %}