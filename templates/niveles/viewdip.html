{% extends "base.html" %}
{% load sga_extras %}
{% block heading %}
    <script type="text/javascript" src='/static/js/jquery.validationEngine.js?v=1.0.0'></script>
    <script type="text/javascript" src='/static/js/jquery.validationEngine-es.js?v=1.0.0'></script>
    <link type='text/css' rel='stylesheet' href="/static/css/validationEngine.jquery.css?v=1.0.0"/>
    <script type="text/javascript" src='/static/js/select2.js?v=1.0.0'></script>
    <link type='text/css' rel='stylesheet' href="/static/css/select2.css?v=1.0.0"/>
    <style>
        .dropdown-item i {
            margin-right: 2px;
        }
    </style>
    <script type="text/javascript">
        const openModalRptCalificaciones = () => {
            bloqueointerface();
            //var h = $(window).height()-450;
            $.ajax({
                type: "GET",
                url: "/niveles",
                data: {'action': 'loadFormPeriodoCalificacion'},
                success: function(data) {
                    if (data.result == 'ok') {
                        $.unblockUI();
                        $(".modal-body", $("#modalRptCalificaciones")).html(data.html);
                        $("#modalRptCalificaciones").modal({backdrop:'static', width: '40%'}).modal('show');
                    }
                    else {
                        $.unblockUI();
                        NotificationJG.error(data.mensaje);
                    }
                },
                error: function() {
                    $.unblockUI();
                    NotificationJG.error("Error al enviar los datos.");
                },
                dataType: "json",
            });
        };

        $(function () {

            $('#btn-reportes').on('show.bs.dropdown', function () {
                $('#icon-btn-reportes').removeClass('fa-folder').addClass('fa-folder-open');
            }).on('hide.bs.dropdown', function () {
                $('#icon-btn-reportes').removeClass('fa-folder-open').addClass('fa-folder');
            })

            $("select").select2({minimumResultsForSearch: 5 });
            $('.action-close',  $("#modalRptCalificaciones")).click(function(){
                $("#modalRptCalificaciones").modal('hide');
            });

            $('.action-download',  $("#modalRptCalificaciones")).click(function(){
                bloqueointerface();
                var modalidad = $("#id_modalidad", $('#frmPeriodoCalificacion')).val();
                var periodo = $("#id_periodo", $('#frmPeriodoCalificacion')).val();
                var aData = {
                    'action': 'downloadRptPeriodoCalificacion',
                    'idp': periodo,
                    'idm': modalidad,
                }

                $.ajax({
                    type: "GET",
                    url: "/niveles",
                    data: aData,
                    success: function(data) {
                        $.unblockUI();
                        if (data.result) {
                            $('#btnNotificacionTareas').html(data.btn_notificaciones);
                            NotificationJG.success(data.mensaje);
                            mensajeSuccess(data.mensaje);
                            $("#modalRptCalificaciones").modal('hide');
                        } else {
                            NotificationJG.error(data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        NotificationJG.error("Error al enviar los datos.");
                    },
                    dataType: "json",
                });
            });

            {% if info %}
                NotificationJG.error({{ info }});
            {% endif %}

            $(".imprimir").click(function () {
                {#var matricula = $("#matriculasel").val();#}
                var href = $(this).attr('nhref') +{{ periodo.id }};
                var tipos = $(this).attr('tipos');

                abrir_reporte2(href, tipos);

            });

            $(".matrizestudiantesadmision_periodo").click(function (){
                var idp = $(this).attr('idp');
                $.get("/niveles", {'action': 'reporteaprobadosreprobadosadmision'}, function (data) {
                    if (data.result) {
                        $('#btnNotificacionTareas').html(data.btn_notificaciones);
                        mensajeSuccess(data.mensaje)
                    } else {
                        mensajeWarning(data.mensaje)
                    }
                }, 'json');
            });

            $(".reporte_cumplimiento_titulacion").click(function () {
                var idp = $(this).attr('idp');
                $.get("/niveles", {'action': 'reportecumplerequisitostitu'}, function (data) {
                    if (data.result) {
                        $('#btnNotificacionTareas').html(data.btn_notificaciones);
                        mensajeSuccess(data.mensaje)
                    } else {
                        mensajeWarning(data.mensaje)
                    }
                }, 'json');
            });

            $(".action-close", $("#modalRunReportAlumnosporAsignatura")).click(function () {
                $("#modalRunReportAlumnosporAsignatura").modal('hide');
                //$(".rpt_coordinacion").select
            });

            $('[name="rpt_coordinacion"]', $("#modalRunReportAlumnosporAsignatura")).select2({
                dropdownParent: $("#modalRunReportAlumnosporAsignatura")
            });

            $(".actionReporteResultadoAlumnos_x_Asignatura").click(function () {
                //$("#modalRunReportAlumnosporAsignatura").modal({backdrop: 'static'}).modal('show');
                //$('[name="rpt_coordinacion"]', $("#modalRunReportAlumnosporAsignatura")).val([]).trigger('change');
                ;
            });

            $(".action-run", $("#modalRunReportAlumnosporAsignatura")).click(function () {
                console.log("entro");
                var idp = $("[name='idp']", $("#modalRunReportAlumnosporAsignatura")).val();
                var coordinaciones = $('[name="rpt_coordinacion"]', $("#modalRunReportAlumnosporAsignatura")).val();
                console.log(idp);
                console.log(coordinaciones);
                if (coordinaciones == null) {
                    NotificationJG.error("Seleccione una coordinación", "Error");
                    return;
                }
                if (coordinaciones.length > 1) {
                    console.log(coordinaciones[0]);
                    if (coordinaciones.length > 2) {
                        NotificationJG.error("Acción no permitida de las coordinaciones seleccionadas", "Error");
                        return;
                    } else if (!coordinaciones.includes("2") || !coordinaciones.includes("3")) {
                        NotificationJG.error("Acción no permitida de las coordinaciones seleccionadas", "Error");
                        return;
                    }
                }

                var report_url = `/reportes?action=run&n={{ reporte_1.nombre }}&periodo_id={{ periodo.id }}&coordinacion_id=${coordinaciones}&rt=pdf`;
                console.log(report_url);
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: report_url,
                    success: function (data) {
                        //console.log(data);
                        $.unblockUI();
                        if (data.result == 'ok') {
                            $("#modalRunReportAlumnosporAsignatura").modal('hide');
                            window.open(location.origin + data.reportfile, '_blank');
                            NotificationJG.success("Reporte generado exitosamente!")
                        } else {
                            NotificationJG.error("No se pudo generar el reporte", "Error");
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        NotificationJG.error("No se pudo generar el reporte", "Error");
                    },
                    dataType: "json"
                });

                //
            });

            abrir_reporte2 = function (href, tipos) {
                if (!tipos) {
                    tipos = "xls";
                }
                if (tipos.contains("xls")) {
                    $("#formatoxls").removeAttr("hidden");
                } else {
                    $("#formatoxls").attr({"hidden": "hidden"});
                }

                {#primero = $("#formatoreporte_formato").find("option:first").val();#}
                $("#formatoreporte_formato").val(2);
                ejecutar_reporte_directo(href);
                {#                $('#formatoreporte').modal({'width':'400'}).modal('show');#}
                {#                $('#formatoreporte_run').attr('nhref', href);#}
            };

            $("#id_fecha").datepicker({format: "dd-mm-yyyy"}).on('changeDate', function (ev) {
                $(this).datepicker('hide');
            });

            $("#id_fecha").addClass("validate[required]");

            $('.nivelhorarios').click(function () {
                id = $(this).attr('nid');
                if ($(this).is(':checked')) {
                    valor = 'y';
                } else {
                    valor = 'n';
                }
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/niveles",
                    data: {'action': 'bloqueohorarios', 'id': id, 'val': valor},
                    success: function (data) {
                        if (data.result == 'ok') {
                            $.unblockUI();
                        } else {
                            $.unblockUI();
                            if (valor == 'y') {
                                $("#nivelhorarios_" + id).prop('checked', false);
                            } else {
                                $("#nivelhorarios_" + id).prop('checked', true);
                            }
                            smoke.alert(data.mensaje);
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        if (valor == 'y') {
                            alert();
                            $("#nivelhorarios_" + id).prop('checked', false);
                        } else {
                            $("#nivelhorarios_" + id).prop('checked', true);
                        }
                        smoke.alert("Error al enviar los datos.");
                    },
                    dataType: "json"
                });
            });

            $('.afinidad').click(function () {
                id = $(this).attr('idperiodo');
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/niveles",
                    data: {'action': 'procesar_afinidad', 'idperiodo': id},
                    success: function (data) {
                        if (data.result == 'ok') {
                            $.unblockUI();
                            smoke.alert('Listo, se realizo proceso');
                        } else {
                            $.unblockUI();
                            smoke.alert(data.mensaje);
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error al enviar los datos.");
                    },
                    dataType: "json"
                });
            });

            $('.estado_admision').click(function () {
                id = $(this).attr('idperiodo');
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/niveles",
                    data: {'action': 'procesar_estado_admision', 'idperiodo': id},
                    success: function (data) {
                        if (data.result == 'ok') {
                            $.unblockUI();
                            smoke.alert('Listo, se realizo proceso');
                        } else {
                            $.unblockUI();
                            smoke.alert(data.mensaje);
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error al enviar los datos.");
                    },
                    dataType: "json"
                });
            });

            $('.estado_admision_virtual').click(function () {
                id = $(this).attr('idperiodo');
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/niveles",
                    data: {'action': 'procesar_estado_admision_virtual', 'idperiodo': id},
                    success: function (data) {
                        if (data.result == 'ok') {
                            $.unblockUI();
                            smoke.alert('Listo, se realizo proceso');
                        } else {
                            $.unblockUI();
                            smoke.alert(data.mensaje);
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error al enviar los datos.");
                    },
                    dataType: "json"
                });
            });

            $(".asistencia").click(function () {
                var id = $(this).attr('idperiodo');
                $("#itemspanel_adicionar_2").attr({'idperiodo': id});
                $("#itemspanel2").modal({backdrop: 'static', width: '400'}).modal('show');
            });

            $(".retencion").click(function () {
                $("#itemspanel4").modal({backdrop: 'static', width: '400'}).modal('show');
            });

            $("#itemspanel_cerrar_2").click(function () {
                $("#itemspanel2").modal('hide');
            });

            $("#itemspanel_cerrar_4").click(function () {
                $("#itemspanel4").modal('hide');
            });

            $("#itemspanel_adicionar_2").click(function () {
                var elemento = $(this);
                var id = elemento.attr("idperiodo");
                var fecha = $("#id_fecha").val();
                $("#itemspanel2").modal('hide');
                if (fecha) {
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/niveles",
                        data: {"action": "avance_asistencia", "idperiodo": id, "fecha": fecha},
                        success: function (data) {
                            $.unblockUI();
                            if (data.result == 'ok') {

                                location.href = data.archivo;
                            } else {
                                smoke.alert(data.mensaje, function (e) {
                                    $("#itemspanel2").modal({backdrop: 'static', width: '400'}).modal('show');
                                }, {
                                    ok: "ok",
                                    classname: "custom-class"
                                });
                            }
                        },
                        error: function () {
                            $.unblockUI();
                            smoke.alert("Error de conexión.", function (e) {
                                $("#itemspanel2").modal({backdrop: 'static', width: '400'}).modal('show');
                            }, {
                                ok: "ok",
                                classname: "custom-class"
                            });
                        },
                        dataType: "json"
                    });
                }
            });

            $("#itemspanel_adicionar_4").click(function () {
                var elemento = $(this);
                var periodo1 = $("#periodo1").val();
                var periodo2 = $("#periodo2").val();
                $("#itemspanel4").modal('hide');
                if (periodo1) {
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/niveles",
                        data: {"action": "retencion_estudiante", "periodo1": periodo1, "periodo2": periodo2},
                        success: function (data) {
                            $.unblockUI();
                            if (data.result == 'ok') {

                                location.href = data.archivo;
                            } else {
                                smoke.alert(data.mensaje, function (e) {
                                    $("#itemspanel4").modal({backdrop: 'static', width: '400'}).modal('show');
                                }, {
                                    ok: "ok",
                                    classname: "custom-class"
                                });
                            }
                        },
                        error: function () {
                            $.unblockUI();
                            smoke.alert("Error de conexión.", function (e) {
                                $("#itemspanel4").modal({backdrop: 'static', width: '400'}).modal('show');
                            }, {
                                ok: "ok",
                                classname: "custom-class"
                            });
                        },
                        dataType: "json"
                    });
                }
            });

            $('.nivelcupo').click(function () {
                id = $(this).attr('nid');
                if ($(this).is(':checked')) {
                    valor = 'y';
                } else {
                    valor = 'n';
                }
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/niveles",
                    data: {'action': 'bloqueocupos', 'id': id, 'val': valor},
                    success: function (data) {
                        if (data.result == 'ok') {
                            $.unblockUI();
                        } else {
                            $.unblockUI();
                            if (valor == 'y') {
                                $("#nivelcupo_" + id).prop('checked', false);
                            } else {
                                $("#nivelcupo_" + id).prop('checked', true);
                            }
                            smoke.alert(data.mensaje);
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        if (valor == 'y') {
                            alert();
                            $("#nivelcupo_" + id).prop('checked', false);
                        } else {
                            $("#nivelcupo_" + id).prop('checked', true);
                        }
                        smoke.alert("Error al enviar los datos.");
                    },
                    dataType: "json"
                });
            });

            $('.nivelprofesor').click(function () {
                id = $(this).attr('nid');
                if ($(this).is(':checked')) {
                    valor = 'y';
                } else {
                    valor = 'n';
                }
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/niveles",
                    data: {'action': 'bloqueoprofesor', 'id': id, 'val': valor},
                    success: function (data) {
                        if (data.result == 'ok') {
                            $.unblockUI();
                        } else {
                            $.unblockUI();
                            if (valor == 'y') {
                                $("#nivelprofesor_" + id).prop('checked', false);
                            } else {
                                $("#nivelprofesor_" + id).prop('checked', true);
                            }
                            smoke.alert(data.mensaje);
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        if (valor == 'y') {
                            $("#nivelprofesor_" + id).prop('checked', false);
                        } else {
                            $("#nivelprofesor_" + id).prop('checked', true);
                        }
                        smoke.alert("Error al enviar los datos.");
                    },
                    dataType: "json"
                });
            });

            $(".sacarestudianteslimpios").click(function() {
                var nid;
                bloqueointerface();
                idp = $(this).attr("idp");
                idc = $(this).attr("idc");
                $.get("/niveles", {'action':'sacarestudianteslimpios', 'idp': idp, 'idc': idc}, function(data) {
                    var indice;
                    var cantidad;
                    if (data.result=='ok') {
                        $.unblockUI();
                        location.href = data.archivo;
                    }
                    else
                    {
                        $.unblockUI();
                        smoke.alert(data.mensaje);
                    }
                }, "json");
            });

            $(".horascumplidaspracticavinculacion").click(function() {
                var nid;
                idp = $(this).attr("idp");
                idc = $(this).attr("idc");
                openwindow('POST' ,'/niveles', {action:'horascumplidaspracticavinculacion',idp: idp, idc: idc, csrfmiddlewaretoken: '{{ csrf_token }}'}, '_blank');
            });

            $(".horascumplidaspracticavinculacionniveles").click(function() {
                var nid;
                idp = $(this).attr("idp");
                idc = $(this).attr("idc");
                openwindow('POST' ,'/niveles', {action:'horascumplidaspracticavinculacionniveles',idp: idp, idc: idc, csrfmiddlewaretoken: '{{ csrf_token }}'}, '_blank');
            });

            $(".modulosaprobadosingles").click(function() {
                var nid;
                idp = $(this).attr("idp");
                openwindow('POST' ,'/niveles', {action:'modulosaprobadosingles', idp: idp, csrfmiddlewaretoken: '{{ csrf_token }}'}, '_blank');
            });

            $(".practicaspendientes").click(function() {
                var nid;
                idp = $(this).attr("idp");
                idc = $(this).attr("idc");
                openwindow('POST' ,'/niveles', {action:'practicaspendientesestudiantes',idp: idp, idc: idc, csrfmiddlewaretoken: '{{ csrf_token }}'}, '_blank');
            });

            $(".practicaspendientesnomatri").click(function() {
                var nid;
                idp = $(this).attr("idp");
                idc = $(this).attr("idc");
                openwindow('POST' ,'/niveles', {action:'practicaspendientesestudiantesnomatricula',idp: idp, idc: idc, csrfmiddlewaretoken: '{{ csrf_token }}'}, '_blank');
            });

            $('.informeconflictoestudiante').click(function () {
                var idn = $(this).attr('idn');
                openwindow('POST' ,'/niveles',{action: 'informeconflictohorarioalumno', idn: idn, csrfmiddlewaretoken: '{{ csrf_token }}'}, '_blank');
            });

            $('#horarioexamenes').on('click', function () {
                $('#modal_reportes').modal({backdrop: 'static', width: '450px'}).modal('show');
                {#$('#facultad_group').fadeIn();#}
                $('#coordinacion_group').fadeIn();
                $('#id_coordinacion').empty().append('<option value="">----------</option>').val(0).trigger("change");
                $.ajax({
                    type: "GET",
                    url: `{{ request.path }}`,
                    data: {'action': 'cargar_coordinacion'},
                    success: function (data) {
                        if (data.result == 'ok') {
                            for (elemento in data.lista) {
                                $('#id_coordinacion').append('<option value="' + data.lista[elemento].id + '">' + data.lista[elemento].nombre + '</option>');
                            }
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    },
                    error: function () {
                        smoke.alert("Error de conexion.");
                    },
                    dataType: "json"
                });
                $('#download_report').click(function () {
                    let coordinacion = $('#id_coordinacion').val();
                    let coordinacion_nombre = $('#id_coordinacion').find('option:selected').text();
                    let url = '{{ request.path }}?action=reportehorarioexamen';
                    console.log(coordinacion);
                    console.log(coordinacion_nombre);
                    url += '&coordinacion=' + coordinacion + '&coordinacion_nombre=' + coordinacion_nombre;
                    window.location.href = url


                    $('#modal_reportes').modal('hide');
                });
            });

            $('#ultimo_modin_aprobado').on('click', function () {
                $('#modal_reportes').modal({backdrop: 'static', width: '450px'}).modal('show');
                {#$('#facultad_group').fadeIn();#}
                $('#coordinacion_group').fadeIn();

                $('#id_coordinacion').empty().append('<option value="">----------</option>').val(0).trigger("change");
                $.ajax({
                    type: "GET",
                    url: `{{ request.path }}`,
                    data: {'action': 'cargar_coordinacion'},
                    success: function (data) {
                        if (data.result == 'ok') {
                            for (elemento in data.lista) {
                                $('#id_coordinacion').append('<option value="' + data.lista[elemento].id + '">' + data.lista[elemento].nombre + '</option>');
                            }
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    },
                    error: function () {
                        smoke.alert("Error de conexion.");
                    },
                    dataType: "json"
                });
                $('#download_report').click(function () {
                    let coordinacion = $('#id_coordinacion').val();
                    let coordinacion_nombre = $('#id_coordinacion').find('option:selected').text();
                    let url = '{{ request.path }}?action=generar_reporte_ultimo_modin_aprobado';
                    console.log(coordinacion);
                    console.log(coordinacion_nombre);
                    url += '&coordinacion=' + coordinacion + '&coordinacion_nombre=' + coordinacion_nombre;
                    window.location.href = url


                    $('#modal_reportes').modal('hide');
                });

                $('#modal_reportes').on('hidden', function () {
                    {#$('#facultad_group').val('');#}
                    $('#coordinacion_group').val('');
                });
            });

            $('#btn_reporte_estudiantes_postgrado').on('click', function (){
                $('#modal_reporte_estudiantes_postgrado').modal({backdrop: 'static', width: '500px'}).modal('show');
                {#$('.coordinacion_select').val(null).trigger('change');#}
            });

            $("#modal_reporte_estudiantes_postgrado_cerrar").click(function () {
                $("#modal_reporte_estudiantes_postgrado").modal('hide');
            });

            $("#modal_reporte_estudiantes_postgrado_descargar").click(function () {
                let form = $('#modal_reporte_estudiantes_postgrado .modal-body .row-fluid').find('form');
                let dataform = form.serialize();
                let fecha = document.getElementById("ffin").value;
                console.log(fecha)
                $.get(`/reportes?${dataform}`).then(function (data) {
                    console.log(data);
                    if (data.result=='ok') {
                        window.open(data.reportfile, '_blank');
                        $("#modal_reporte_estudiantes_postgrado").modal('hide');
                        $.unblockUI()
                    }
                    else{
                        NotificationJG.error(data.mensaje)
                        $.unblockUI()
                    }
                }).fail(function (error) {
                    NotificationJG.error(error)
                });

            });

            $('.visibledistributivomateria').click(function () {
                id = $(this).attr('nid');
                if ($(this).is(':checked')) {
                    valor = 'y';
                } else {
                    valor = 'n';
                }
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/niveles",
                    data: {'action': 'modificar_visibledistributivomateria', 'id': id, 'val': valor},
                    success: function (data) {
                        if (data.result == 'ok') {
                            $.unblockUI();
                        } else {
                            $.unblockUI();
                            if (valor == 'y') {
                                $("#visibledistributivomateria_" + id).prop('checked', false);
                            } else {
                                $("#visibledistributivomateria_" + id).prop('checked', true);
                            }
                            smoke.alert(data.mensaje);
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        if (valor == 'y') {
                            alert();
                            $("#visibledistributivomateria_" + id).prop('checked', false);
                        } else {
                            $("#visibledistributivomateria_" + id).prop('checked', true);
                        }
                        smoke.alert("Error al enviar los datos.");
                    },
                    dataType: "json"
                });
            });

        });
        var uiResponsableActaAdmisionModal = {
            init: function () {
                var self = this;
                self.$modalForm = $('#modalResponsableActaAdmision');
                $('.action-close', self.$modalForm).click(function(){
                    self.close();
                });
                $('.action-edit', self.$modalForm).click(function(){
                    self.setFormType('edit');
                });
                $('.action-save', self.$modalForm).click(function (){
                    self.actionSave();
                });
            },
            processModalInit: function (){
                var self = this;
                $("#frmResponsableActaAdmision", self.$modalForm).validationEngine({autoHidePrompt:true, autoHideDelay:1000 });


                $("#id_fechainicio, #id_fechafin", self.$modalForm).datepicker({format:"yyyy-mm-dd"}).on('changeDate', function(ev){ $(this).datepicker('hide'); });
                $("#id_fechainicio, #id_fechafin, #id_coordinaciones", self.$modalForm).css({'text-transform': 'none'}).addClass("validate[required]");
                var eliminar_alertas = function(){
                    setInterval(function() {
                        $('.help-text', $("#frmResponsableActaAdmision")).html("");
                    }, 8000);
                };

                eliminar_alertas();
                $("#id_coordinacion", self.$modalForm).select2({minimumResultsForSearch: 20, width: '100%', dropdownParent: self.$modalForm});

            },
            close: function (){
                var self = this;
                self.$modalForm.modal('hide');
            },
            open: function(type, id, tableData){
                bloqueointerface();
                var self = this;
                self.setFormType(type);
                var h = $(window).height()-450;
                $.ajax({
                    type: "GET",
                    url: "/niveles",
                    data: {'action': 'loadFormResponableActaAdmision', 'typeForm': type, 'id': id, 'tableData':tableData},
                    success: function(data) {
                        if (data.result == 'ok') {
                            $.unblockUI();
                            $(".modal-body", self.$modalForm).html(data.html);
                            self.$modalForm.modal({backdrop:'static', width: '50%'}).modal('show');
                            self.processModalInit();

                        } else {
                            $.unblockUI();
                            NotificationJG.error(data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        NotificationJG.error("Error al enviar los datos.");
                    },
                    dataType: "json",
                });
            },
            setFormType: function( type /* new, edit, view */ )
            {
                var self = this;

                if( type == 'new' )
                {
                    $('.modal-header span', self.$modalForm).html('Nuevo');

                    $('.action-save', self.$modalForm).show();
                    $('.action-edit', self.$modalForm).hide();
                    self.setFormReadOnly(false);
                }
                else if( type == 'edit' )
                {
                    $('.modal-header span', self.$modalForm).html('Editar');

                    $('.action-save', self.$modalForm).show();
                    $('.action-edit', self.$modalForm).hide();
                    self.setFormReadOnly(false);
                }
                else if( type == 'view' )
                {
                    $('.modal-header span', self.$modalForm).html('Ver');

                    $('.action-save', self.$modalForm).hide();
                    $('.action-edit', self.$modalForm).show();
                    self.setFormReadOnly(true);
                }
            },
            setFormReadOnly: function( isFormReadOnly )
            {
                var self = this;

                $('[name="tipo"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="tipoprofesor"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="cargo"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="persona"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="firmadigital"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="firmadigital"]', self.$modalForm).prop('readonly', isFormReadOnly);
            },
            formSetData: function(data){
                //console.log(data);
                var self = this;

                var id = (data == null) ? 0 : data.id;
                var tipo = (data == null) ? 0 : data.tipo;
                var persona_id = (data == null) ? 0 : data.persona_id;
                var tipoprofesor_id = (data == null) ? '' : data.tipoprofesor_id;
                var cargo = (data == null) ? '' : data.cargo;
                var firmadigital = (data == null) ? false : data.firmadigital;
                var tableData = (data == null) ? false : data.tableData;

                $('[name="id"]', self.$modalForm).val(id);
                $('[name="persona"]', self.$modalForm).val(persona_id).change();
                $('[name="tipoprofesor"]', self.$modalForm).val(tipoprofesor_id).change();
                $('[name="tipo"]', self.$modalForm).val(tipoprofesor_id).change();
                //$('[name="cordinaciones"]', self.$modalForm).select2("val", coordinacion_id).trigger("change");;
                $('[name="cargo"]', self.$modalForm).val(cargo);
                $('[name="firmadigital"]', self.$modalForm).prop('checked', firmadigital);

            },
            formGetData:function(){
                var self = this;
                var data = {}
                let persona = $('select[name="persona_sel"] option:selected', self.$modalForm).select2().data('data');
                console.log(persona.alias)
                data['id'] = $('[name="id"]', self.$modalForm).val();
                data['tableData'] = $('[name="tableData"]', self.$modalForm).val();
                data['cargo'] = $('[name="cargo"]', self.$modalForm).val();
                data['persona'] = persona.alias ?persona.alias[1]: '';//$('[name="persona"]', self.$modalForm).val();
                data['persona_id'] = persona.id ?persona.id: '';
                data['tipoprofesor_id'] = $('[name="tipoprofesor"]', self.$modalForm).val();
                data['tipoprofesor'] = $('select[name="tipoprofesor"] option:selected', self.$modalForm).text();
                data['tipo_id'] = $('select[name="tipo"] option:selected', self.$modalForm).val();
                data['tipo'] = $('select[name="tipo"] option:selected', self.$modalForm).text();
                data['firmadigital'] = $('[name="firmadigital"]', self.$modalForm).is(':checked');
                return data;
            },
            actionSave: function (){
                var self = this;
                bloqueointerface();
                $("#frmResponsableActaAdmision", self.$modalForm).validationEngine('attach',{ scroll: false });
                var valid = $("#frmResponsableActaAdmision", self.$modalForm).validationEngine('validate', { scroll: false });
                if (!valid){
                    setTimeout(function() {
                        $('.help-text', self.$modalForm).each(function () {
                            var field = $(this);
                            if (field.attr('alert')) {
                                field.html(field.attr('alert'));
                            } else {
                                field.html('');
                            }
                        });
                    }, 8000);
                    $.unblockUI();
                    return false;
                }
                $('.datepicker', self.$modalForm).css({"display": "none"});
                $('.bootstrap-timepicker-widget', self.$modalForm).css({"display": "none"});

                $('.controls input', self.$modalForm).each(function(){
                    if ($(this).attr('type')=='text'){
                        $(this).val($(this).val().trim());
                    }
                    if ($(this).attr('type')!='file'){
                        if ($(this).css('text-transform')=='uppercase'){
                            if ($(this).attr('type')!='password'){
                                $(this).val($(this).val().toUpperCase());
                            }
                        }
                    }
                });

                /*if ($('[name="tipo"]', self.$modalForm).val() == 1){
                    smoke.alert('Seleccione una Tipo de Firma');
                    $.unblockUI();
                    return false;
                }*/

                var aData = self.formGetData();
                //console.log(aData);

                uiPeriodoActaAdmisionModal.addDataResponsableActaAdmision(aData);
                self.close();
                $.unblockUI();
            },
        };
        var uiPeriodoActaAdmisionModal = {
            init: function () {
                var self = this;
                self.$modalForm = $('#modalPeriodoActaAdmision');
                $('.action-close', self.$modalForm).click(function(){
                    self.close();
                });
                $('.action-edit', self.$modalForm).click(function(){
                    self.setFormType('edit');
                });
                $('.action-save', self.$modalForm).click(function (){
                    self.actionSave();
                });
            },
            processModalInit: function (){
                var self = this;
                //$("#frmAcademicPeriodMatriculacion", self.$modalForm).validationEngine({autoHidePrompt:true, autoHideDelay:1000 });
                $("#id_fechainicio, #id_fechafin", self.$modalForm).datepicker({format:"yyyy-mm-dd"}).on('changeDate', function(ev){ $(this).datepicker('hide'); });
                $("#id_fechainicio, #id_fechafin, #id_coordinaciones", self.$modalForm).css({'text-transform': 'none'}).addClass("validate[required]");
                $(".action_new_responsableactaadmision", self.$modalForm).click(function (){
                    uiResponsableActaAdmisionModal.open('new', [], $(this).attr('idtable'));
                });

            },
            addDataResponsableActaAdmision: function (objResponsableActaAdmision){
                var self = this;

                let idtable = `${objResponsableActaAdmision.tableData}`+ ' tbody';

                if (objResponsableActaAdmision.id == 0) {
                    objResponsableActaAdmision.id = (new Date()).getTime();
                }
                var tr = null;

                $(idtable+' tr').each(function(index, value){
                    var $_tr = $(this);
                    var data = $_tr.data();

                    if( data.objResponsableActaAdmision.id == objResponsableActaAdmision.id ) {
                        tr = $_tr;
                        console.log(tr,$(this).data(), value,objResponsableActaAdmision.tableData);
                    }
                });

                var isNew = (tr == null);

                if( isNew ) {
                    tr = $('#el-templates [element="table-row-responsableactaadmision"] tr').clone();
                }
                var $tr = $(tr);
                $tr.data({objResponsableActaAdmision:objResponsableActaAdmision});

                let tipocolorlabel=  objResponsableActaAdmision.tipo_id == 1?'success':'info';
                let firmadigitalcolor = objResponsableActaAdmision.firmadigital?'success':'default';
                let firmadigitalicon = objResponsableActaAdmision.firmadigital?'check':'close';

                $('td:nth-child(1)', $tr).html(`<span class="label label-${tipocolorlabel}">${objResponsableActaAdmision.tipo}</span>`);
                $('td:nth-child(2)', $tr).html(objResponsableActaAdmision.persona);
                $('td:nth-child(3)', $tr).html(objResponsableActaAdmision.tipoprofesor);
                $('td:nth-child(4)', $tr).html(`<input type="text" style="display:none; text-align: center" class="updateCampoText" value="${objResponsableActaAdmision.cargo}">
                                <div style="text-align: center" class="updateCampoDiv">
                                    ${objResponsableActaAdmision.cargo}
                                </div>`);
                $('td:nth-child(4) .updateCampoDiv', $tr).off('click').on('click', function(){
                    //alert(objCronograma.fechainicio);
                    $(this).hide();
                    $('td:nth-child(4) .updateCampoText', $tr).show();
                });
                $('td:nth-child(4) .updateCampoText', $tr).off('change').on('change', function(ev){

                    $(this).hide();
                    let value = $(this).val();
                    //console.log(value);
                    $('td:nth-child(4) .updateCampoDiv', $tr).html(value).show();
                    objResponsableActaAdmision.cargo = value;
                    self.addDataResponsableActaAdmision(objResponsableActaAdmision);
                    NotificationJG.success(`Se cambio el cargo de ${objResponsableActaAdmision.tipo} correctamente.`);
                });
                $('td:nth-child(5)', $tr).html(`<span class="action_firmadigital label label-${firmadigitalcolor} label-mini"><i class="fa fa-${firmadigitalicon}"></i></span>`);

                $('td:nth-child(5) .action_firmadigital', $tr).off('click').on('click', function(){
                    console.log('antes',objResponsableActaAdmision)
                    self.changeFirmaDigital(objResponsableActaAdmision);
                });

                $('td:nth-child(6) .action_remove_responsableactaadmision', $tr).off('click').on('click', function(){
                    self.removeResponsableActaAdmision(objResponsableActaAdmision);

                });
                $(idtable).append($tr);
            },
            changeFirmaDigital: function(objResponsableActaAdmision){
                var self = this;
                let registro=  objResponsableActaAdmision.tipoprofesor_id?objResponsableActaAdmision.tipoprofesor:objResponsableActaAdmision.persona;
                registro += ` (${objResponsableActaAdmision.cargo})`;

                if( objResponsableActaAdmision.firmadigital == true ) {
                    objResponsableActaAdmision.firmadigital = false
                    NotificationJG.success(`Se inactivo Responsable ${registro} correctamente.`);
                }else{
                    objResponsableActaAdmision.firmadigital = true
                    NotificationJG.success(`Se activo Responsable ${registro} correctamente.`);
                }
                self.addDataResponsableActaAdmision(objResponsableActaAdmision);
            },
            removeResponsableActaAdmision: function (objResponsableActaAdmision){
                Confirm.question('Desea eliminar el Responsable de Acta Admisión seleccionado?', function () {
                    let idtable = `${objResponsableActaAdmision.tableData}`+ ' tbody';
                    $(idtable+` tr`).each(function(index, value){
                        var $_tr = $(this);
                        var data = $_tr.data();

                        if( data.objResponsableActaAdmision.id == objResponsableActaAdmision.id ) {
                            $_tr.remove();
                            NotificationJG.success("Se elimino correctamente.");
                        }
                    });
                }, function () {
                    NotificationJG.info("Enhorabuena el registro esta salvado.!");
                });
            },
            close: function (){
                var self = this;
                self.$modalForm.modal('hide');
            },
            open: function(type, id){
                bloqueointerface();
                var self = this;
                self.setFormType(type);
                var h = $(window).height()-450;
                $.ajax({
                    type: "GET",
                    url: "/niveles",
                    data: {'action': 'loadFormPeriodoActaAdmision', 'typeForm': type, 'id': id},
                    success: function(data) {
                        if (data.result == 'ok') {
                            $.unblockUI();
                            $(".modal-body", self.$modalForm).html(data.html);
                            self.$modalForm.modal({backdrop:'static', width: '90%'}).modal('show');

                            $.each(data.asignaturas, function (index, asignatura){
                                $.each(asignatura.responsables, function(index, responsable) {
                                    self.addDataResponsableActaAdmision(responsable);
                                })
                            });
                            self.processModalInit();
                        } else {
                            $.unblockUI();
                            NotificationJG.error(data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        NotificationJG.error("Error al enviar los datos.");
                    },
                    dataType: "json",
                });
            },
            setFormType: function( type /* new, edit, view */ )
            {
                var self = this;

                if( type == 'new' )
                {
                    $('.modal-header span', self.$modalForm).html('Nuevo');

                    $('.action-save', self.$modalForm).show();
                    $('.action-edit', self.$modalForm).hide();
                    self.setFormReadOnly(false);
                }
                else if( type == 'edit' )
                {
                    $('.modal-header span', self.$modalForm).html('Editar');

                    $('.action-save', self.$modalForm).show();
                    $('.action-edit', self.$modalForm).hide();
                    self.setFormReadOnly(false);
                }
                else if( type == 'view' )
                {
                    $('.modal-header span', self.$modalForm).html('Ver');

                    $('.action-save', self.$modalForm).hide();
                    $('.action-edit', self.$modalForm).show();
                    self.setFormReadOnly(true);
                }
            },
            setFormReadOnly: function( isFormReadOnly )
            {
                var self = this;
            },
            formSetData: function(data){
                //console.log(data);
                var self = this;

                var id = (data == null) ? 0 : data.id;
                var tipo = (data == null) ? 0 : data.tipo;
                var persona_id = (data == null) ? 0 : data.persona_id;
                var tipoprofesor_id = (data == null) ? '' : data.tipoprofesor_id;
                var cargo = (data == null) ? '' : data.cargo;
                var firmadigital = (data == null) ? false : data.firmadigital;
                var tableData = (data == null) ? false : data.tableData;

                $('[name="id"]', self.$modalForm).val(id);
                $('[name="persona"]', self.$modalForm).val(persona_id).change();
                $('[name="tipoprofesor"]', self.$modalForm).val(tipoprofesor_id).change();
                $('[name="tipo"]', self.$modalForm).val(tipoprofesor_id).change();
                //$('[name="cordinaciones"]', self.$modalForm).select2("val", coordinacion_id).trigger("change");;
                $('[name="cargo"]', self.$modalForm).val(cargo);
                $('[name="firmadigital"]', self.$modalForm).prop('checked', firmadigital);

            },
            formGetData:function(){
                var self = this;
                var data = {}
                data['id'] = $('[name="id"]', self.$modalForm).val();
                data['idpm'] = $('[name="idpm"]', self.$modalForm).val();
                data['action'] = $('[name="action"]', self.$modalForm).val();

                var asignaturas = []

                $('.table-asignatura').each(function(i, tableasignatura) {
                    let asignatura = {};
                    asignatura.id = tableasignatura.id.replace('data-asignatura','');

                    asignatura.responsables = [];
                    let idtable = `#${tableasignatura.id}`;

                    $(idtable+` tbody tr`).each(function(index, value){
                        var $_tr = $(this);
                        var data = $_tr.data();
                        asignatura.responsables.push(data.objResponsableActaAdmision);
                    });
                    asignaturas.push(asignatura);
                });
                data['asignaturas'] = JSON.stringify(asignaturas)

                return data;
            },
            actionSave: function (){
                var self = this;
                $("#frmAcademicPeriodMatriculacion", self.$modalForm).validationEngine('attach',{ scroll: false });
                var valid = $("#frmAcademicPeriodMatriculacion", self.$modalForm).validationEngine('validate', { scroll: false });
                if (!valid){
                    setTimeout(function() {
                        $('.help-text', self.$modalForm).each(function () {
                            var field = $(this);
                            if (field.attr('alert')) {
                                field.html(field.attr('alert'));
                            } else {
                                field.html('');
                            }
                        });
                    }, 8000);
                    $.unblockUI();
                    return false;
                }
                $('.datepicker', self.$modalForm).css({"display": "none"});
                $('.bootstrap-timepicker-widget', self.$modalForm).css({"display": "none"});

                $('.controls input', self.$modalForm).each(function(){
                    if ($(this).attr('type')=='text'){
                        $(this).val($(this).val().trim());
                    }
                    if ($(this).attr('type')!='file'){
                        if ($(this).css('text-transform')=='uppercase'){
                            if ($(this).attr('type')!='password'){
                                $(this).val($(this).val().toUpperCase());
                            }
                        }
                    }
                });
                var aData = self.formGetData();
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/niveles",
                    data: aData,
                    success: function(data) {
                        if (data.result == 'ok') {
                            $.unblockUI();
                            NotificationJG.success(data.mensaje);
                            self.close();
                        }
                        else{
                            NotificationJG.error(data.mensaje);
                            $.unblockUI();
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        NotificationJG.error("Error al enviar los datos.");
                    },
                    dataType: "json",
                });
            },
        };

        $(function () {
            uiPeriodoActaAdmisionModal.init();
            uiResponsableActaAdmisionModal.init();
            $('.action_periodoactaadmision').click(function(){
                var typeform = $(this).attr('typeform');
                console.log(typeform);
                console.log(typeform)
                uiPeriodoActaAdmisionModal.open(typeform, []);
            });

            $('.firmantes').click(function (){
                formModal(0, '');
            })
        });

        function formModal(id,text, footer = true) {
            $('.panelbody').empty();
            bloqueointerface();
            $.ajax({
                type: "GET",
                url: `{{ request.path }}`,
                data: {
                    'action': 'firmantes',
                },
                success: function (data) {
                    $.unblockUI();
                    console.log(12);
                    if (data.result === 'ok') {
                        $('.panelbodyfirmantes').html(data.data);
                        $("#modal_firmaactas").modal({backdrop: 'static', width: '600px'}).modal('show');
                    } else {
                        smoke.alert(data.mensaje);
                    }
                },
                error: function () {
                    $.unblockUI();
                    smoke.alert("Error de conexión.");
                },
                dataType: "json"
            });
        }
    </script>
{% endblock %}
{% block atras %}/{% endblock %}
{% block canvas %}
    <div class='row'>
        <div class='col-12'>
            <div class='row'>
                <div class='col-lg-12 px-2'>
                    <div class="headtitle">
                        <h3 class="texto-blue">{{ title }}</h3>
                        <h6>{{ periodo }}</h6>
                    </div>
                </div>
            </div>
            <br>
            <div class="btn-group">
                <button id="btn-reportes" type="button" class="btn btn-default dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i id="icon-btn-reportes" class="fa fa-folder" aria-hidden="true"></i> Reportes
                </button>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="javascript:;" onclick="openModalRptCalificaciones();" style="cursor: pointer;"><i class="fa fa-table"></i> Reporte de calificaciones por período académico </a>
                    <a class="dropdown-item" id="btn_reporte_estudiantes_postgrado" style="cursor: pointer;"><i class="fa fa-table"></i> Reporte de estudiantes matriculados en postgrado </a>
                    <a class="dropdown-item" id="ultimo_modin_aprobado" style="cursor: pointer;"><i class="fa fa-table"></i> Reporte de estudiantes con último módulo de inglés aprobado </a>
                    <a class="dropdown-item modulosaprobadosingles" href="javascript:;" idp="{{ periodo.id }}"><i class="fa fa-table"></i> Reporte Estudiantes Módulos Inglés Aprobados </a>
                    <a class="dropdown-item" href="/niveles?action=reportedistributivo&periodo={{ periodo.id }}"><i class="fa fa-table"></i> Reporte distributivo de asignaturas</a>
                    <a class="dropdown-item" href="/niveles?action=reportedistributivo_preferencias&periodo={{ periodo.id }}"><i class="fa fa-table"></i> Distributivo - Preferencias - Historicos</a>
                    {% if periodo.visiblehorario or perms.sga.puede_modificar_horarios %}
                        <a class="dropdown-item" href="/niveles?action=reporteaula&periodo={{ periodo.id }}"><i class="fa fa-table"></i> Reporte de horarios y aulas</a>
                        <a class="dropdown-item" href="/niveles?action=reporteaulayactividad&periodo={{ periodo.id }}"><i class="fa fa-table"></i> Reporte de horarios, aulas y actividad</a>
                    {% endif %}
{#                   <a class="dropdown-item" href="/niveles?action=reportealumnospre&periodo={{ periodo.id }}"><i class="fa fa-table"></i> Reporte de asignaturas y estudiantes</a>#}
                    <a class="dropdown-item" href="javascript:void(0);" onclick="runReport('GET', 'reportealumnospre', undefined, false)"><i class="fa fa-table"></i> Reporte de asignaturas y estudiantes</a>
                    <a class="dropdown-item asistencia" href="javascript:;" idperiodo="{{ periodo.id }}"><i class="fa fa-table"></i> Reporte avance asistencia</a>
                    <a class="dropdown-item" href="/niveles?action=sinhorarios&periodo={{ periodo.id }}"><i class="fa fa-table"></i> Reporte de asignaturas sin horarios</a>
                    <a class="dropdown-item" href="/niveles?action=docentes&periodo={{ periodo.id }}"><i class="fa fa-table"></i> Reporte de datos de los docentes</a>
                    <a class="dropdown-item" href="/niveles?action=reportereactivo&periodo={{ periodo.id }}"><i class="fa fa-table"></i> Reporte de entrega de reactivos</a>
                    <a class="dropdown-item" href="/niveles?action=totalmatriculadossinmodulos&periodo={{ periodo.id }}"><i class="fa fa-table"></i> Reporte de matriculados</a>
                    <a class="dropdown-item" href="/niveles?action=totalmatriculadossinmodulosvirtual&periodo={{ periodo.id }}"><i class="fa fa-table"></i> Reporte de matriculados modulos virtual</a>
                    {% if perms.sga.puede_modificar_materias %}
                        <a class="dropdown-item" href="/niveles?action=totalmatriculadosadeudan&periodo={{ periodo.id }}"><i class="fa fa-table"></i> Reporte valores pendientes de pago en matrícula </a>
                        <a class="dropdown-item" href="/niveles?action=totalmatriculadospagado&periodo={{ periodo.id }}"><i class="fa fa-table"></i> Reporte valores recaudados en matrícula</a>
                        <a class="dropdown-item" href="/niveles?action=totalmatriculadospagadoadmision&periodo={{ periodo.id }}"><i class="fa fa-table"></i> Reporte valores recaudados en matrícula admisión</a>
                        <a class="dropdown-item" href="/niveles?action=totalaprobadosadmision&periodo={{ periodo.id }}"><i class="fa fa-table"></i> Reporte de estudiantes aprobados en admisión</a>
                    {% endif %}
                    <a class="dropdown-item" href="/niveles?action=totalmatriculadosadmision&periodo={{ periodo.id }}"><i class="fa fa-table"></i> Reporte de estudiantes en admisión</a>
                    <a class="dropdown-item" href="/niveles?action=conflictohorariodocente&periodo={{ periodo.id }}"><i class="fa fa-table"></i> Reporte de conflicto horarios de docentes</a>
                    <a class="dropdown-item retencion" href="javascript:;"><i class="fa fa-table"></i> Reporte retencion Estudiantes</a>
                    <a class="dropdown-item" href="/niveles?action=oracle"><i class="fa fa-table"></i> Reporte ORACLE</a>
                    <a class="dropdown-item" href="/niveles?action=reporteafinidad&periodo={{ periodo.id }}"><i class="fa fa-table"></i> Reporte Afinidad</a>
                    <a class="dropdown-item" href="/niveles?action=preferenciasasignaturas&periodo={{ periodo.id }}"><i class="fa fa-table"></i> Preferencias de asignaturas</a>
                    <a class="dropdown-item" href="/niveles?action=reportealumnocalificacionesadmisionvirtual&periodo={{ periodo.id }}" target="_blank"><i class="fa fa-table"></i> Alumnos admision virtual (calificaciones)</a>
                    <a class="dropdown-item" href="/niveles?action=reportealumnocalificacionesadmisionpresencial&periodo={{ periodo.id }}" target="_blank"><i class="fa fa-table"></i> Alumnos admision presencial (calificaciones)</a>
                    <a class="dropdown-item" href="/niveles?action=reportealumnocalificacionespregradovirtual&periodo={{ periodo.id }}" target="_blank"><i class="fa fa-table"></i> Alumnos pregrado virtual (calificaciones)</a>
                    <a class="dropdown-item" href="/niveles?action=reporteestudiantessingrupospracticas&periodo={{ periodo.id }}" target="_blank"><i class="fa fa-table"></i> Estudiantes sin grupos de prácticas</a>
                    <a class="dropdown-item bloqueo_pantalla" href="?action=avancedistributivo"><i class="fa fa-bar-chart"></i> Gráficas porcentaje distributivo</a>
                    <a class="dropdown-item matrizestudiantesadmision_periodo"><i class="fa fa-table"></i> Reporte de aprobados y reprobados de admisión</a>
                    <a class="dropdown-item" href="?action=reporteestudiantesmatriculadosvariascarreras" target="_blank"><i class="fa fa-table"></i> Reporte estudiante matriculados en varias carreras</a>
                </div>

                <button type="button" class="btn btn-default dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fa fa-ellipsis-v fs-6"></i> &nbsp;Acciones
                </button>
                <div class="dropdown-menu pull-left">
                    <a class="dropdown-item tu" href="?action=paralelos"><i class="fa fa-bank"></i> Paralelos</a>
                    <div class="dropdown-divider"></div>
                    {% if perms.sga.puede_matricular_masivo_internado %}
                        <div class="dropdown-submenu ">
                            <a class="dropdown-item" href="javascript:;"><i class="fa fa-gear"></i> Gestionar Matriculación </a>
                            <div class="dropdown-menu pull-right">
                                {% if persona.usuario.is_superuser %}
                                    <a class="dropdown-item" href="?action=importarmatricula&idp={{ periodo.id }}"><i class="fa fa-gear" ></i> Matriculación Masiva</a>
                                    <a class="dropdown-item" href="?action=matriculacionprimernivel"><i class="fa fa-gear" ></i> Matriculación Primer Nivel</a>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    {% if persona.usuario.is_superuser %}
                        <a class="dropdown-item" href="?action=importarinscripcion&idp={{ periodo.id }}"><i class="fa fa-gear" ></i> Crear Inscripciones Nuevas</a>
                        <a class="dropdown-item eliminacionmodal" href="javascript:;" nhref="/niveles?action=eliminarmatriculas&id={{ periodo.id }}"><i class="fa fa-trash"></i> Elminar matriculas pendientes de pago</a>
                        <a class="dropdown-item estado_admision" ref="javascript:;" idperiodo="{{ periodo.id }}"><i class="fa fa-refresh"></i> Actualizar Estado Admisión</a>
                        <a class="dropdown-item estado_admision_virtual" ref="javascript:;" idperiodo="{{ periodo.id }}"><i class="fa fa-refresh"></i> Actualizar Estado Admisión Virtual</a>
                        <a class="dropdown-item" href="?action=perfilaccesousuario"><i class="fa fa-user" ></i> Perfil acceso usuario</a>
                        <a class="dropdown-item confirmacionmodal" href="javascript:;" nhref="/niveles?action=actualizarprofesorcrirerio&id={{ periodo.id }}"><i class="fa fa-refresh"></i> Actualizar Profesor Criterio</a>
                    {% endif %}
                </div>
            </div>
            {% if persona.usuario.is_superuser %}
                <a href="?action=excelasistencia&id={{ periodo.id }}" class="btn btn-mini btn-primary tu"><i class="fa fa-book"></i> Reporte % asistencias </a>
            {% endif %}
        </div>
    </div>
    <div class='row'>
        <div class="col-12">
            <table class="table table-bordered table-striped">
                <tbody>
                {% for coordinacion in coordinaciones %}
                    <tr class="info">
                        <td>{{ coordinacion.nombre }}
                            <div class="btn-group">
                                <a class="btn btn-icon btn btn-ghost btn-sm rounded-circle dropdown-toggle"  data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="fa fa-ellipsis-v fs-6"></i>
                                </a>
                                <div class="dropdown-menu pull-left">
                                    <a class="dropdown-item" href="/niveles?action=reporte&periodo={{ periodo.id }}&coordinacion={{ coordinacion.id }}" class="tu"><i class="fa fa-table"></i> Reporte situación académica</a>
                                    {% if persona.usuario.is_superuser %}
                                        <a class="dropdown-item" href="javascript:;" idp="{{ periodo.id }}" idc="{{ coordinacion.id }}" class="sacarestudianteslimpios"><i class="fa fa-table"></i> Sacar Estudiantes Limpios</a>
                                    {% endif %}
                                    {% if coordinacion.id == 9 %}
                                        {% if periodo.id == 90 or periodo.id == 95 %}
                                            <a class="dropdown-item" href="/niveles?action=reporteresultadosnivelacion&periodo={{ periodo.id }}&coordinacion={{ coordinacion.id }}"><i class="fa fa-table"></i> Reporte Resultados Finales</a>
                                        {% endif %}
                                    {% endif %}
                                    {% if coordinacion.id <= 5 %}
                                        <a class="dropdown-item" href="javascript:;" idp="{{ periodo.id }}" idc="{{ coordinacion.id }}" class="horascumplidaspracticavinculacion"><i class="fa fa-table"></i> Reporte Horas Cumplidas Prácticas y Vinculación </a>
                                        <a class="dropdown-item" href="javascript:;" idp="{{ periodo.id }}" idc="{{ coordinacion.id }}" class="horascumplidaspracticavinculacionniveles"><i class="fa fa-table"></i> Reporte Horas Cumplidas Prácticas y Vinculación (todos los niveles) </a>
                                        <a class="dropdown-item" href="javascript:;" idp="{{ periodo.id }}" idc="{{ coordinacion.id }}" class="practicaspendientes"><i class="fa fa-table"></i> Reporte Estudiantes con Prácticas Pendientes (Matriculados)</a>
                                        <a class="dropdown-item" href="javascript:;" idp="{{ periodo.id }}" idc="{{ coordinacion.id }}" class="practicaspendientesnomatri"><i class="fa fa-table"></i> Reporte Estudiantes con Prácticas Pendientes (No Matriculados)</a>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <table class='table table-bordered cell'>
                                <thead>
                                <tr>
                                    {% if persona.usuario.is_superuser %}
                                        <th style='text-align: center; width: 30px'><i class='fa fa-lock'></i></th>
                                        <th style='text-align: center; width: 30px'><i class='fa fa-user'></i></th>
                                        <th style='text-align: center; width: 30px'><i class='fa fa-th'></i></th>
                                        <th style='text-align: center; width: 30px'><i class='fa fa-bars'></i></th>
                                    {% endif %}
                                    <th>Nivel</th>
                                    <th style='text-align: center; width: 30px'>Matriculas</th>
                                    <th style="width:250px">Sesion/Modalidad</th>
                                    <th style='width:80px;text-align: center;'>Inicio/Fin</th>
                                    <th style='width:80px;text-align: center;'>Mat.Reg.</th>
                                    <th style='width:80px;text-align: center;'>Mat.Ext.</th>
                                    <th style='width:80px;text-align: center;'>Mat.Esp.</th>
                                    <th style="width:300px"></th>
                                </tr>
                                </thead>
                                {% with niveles=persona|args:coordinacion|args:periodo|call:"mis_niveles" matriculadoscoordperiodo=coordinacion|args:periodo|call:"cantidad_matriculados_periodo"  cantidad_matriculas_solo_modulos_coordinacion=periodo|args:coordinacion|call:"cantidad_matriculas_solo_modulos_coordinacion" %}
                                    {% for nivel in niveles %}
                                        <tr>
                                            {% if persona.usuario.is_superuser %}
                                                <td style='text-align: center'>
                                                    <input class='nivelhorarios tu' id="nivelhorarios_{{ nivel.id }}" nid='{{ nivel.id }}' title='Bloqueo' type='checkbox' {% if nivel.extension.visible %}checked='checked'{% endif %}/>
                                                </td>
                                                <td style='text-align: center'>
                                                    <input class='nivelprofesor tu' id="nivelprofesor_{{ nivel.id }}" nid='{{ nivel.id }}' title='Modificar profesores' type='checkbox' {% if nivel.extension.modificardocente %}checked='checked'{% endif %}/>
                                                </td>
                                                <td style='text-align: center'>
                                                    <input class='nivelcupo tu' id="nivelcupo_{{ nivel.id }}" nid='{{ nivel.id }}' title='Modificar cupos' type='checkbox' {% if nivel.extension.puedematricular %}checked='checked'{% endif %}/>
                                                </td>
                                                <td style='text-align: center'>
                                                    <input class='visibledistributivomateria tu' id="visibledistributivomateria{{ nivel.id }}" nid='{{ nivel.id }}' title='Visible materias docente' type='checkbox' {% if nivel.visibledistributivomateria %}checked='checked'{% endif %}/>
                                                </td>
                                            {% endif %}
                                            <td>
                                                {{ nivel.paralelo  }}<br>
                                                {% if aprobacion_distributivo and nivel.distributivoaprobado %}
                                                    <span class='label label-success'>APROBADO</span>
                                                {% endif %}
                                                {% if nivel.cerrado %}
                                                    <span class='label label-important'>CERRADO</span>
                                                {% endif %}
                                            </td>
                                            <td style='text-align: center'>
                                                {{ nivel.nummatri }}
                                            </td>
                                            <td>{{ nivel.sesion.nombre }}<br>{{ nivel.modalidad }}</td>
                                            <td style='text-align: center;'>{{ nivel.inicio|date:'d-m-Y' }}<br>{{ nivel.fin|date:'d-m-Y' }}</td>
                                            <td style='text-align: center;'>{{ nivel.fechatopematricula|date:'d-m-Y' }}</td>
                                            <td style='text-align: center;'>{{ nivel.fechatopematriculaex|date:'d-m-Y' }}</td>
                                            <td style='text-align: center;'>{{ nivel.fechatopematriculaes|date:'d-m-Y' }}</td>
                                            <td style='text-align: left;'>
                                                {% if not nivel.cerrado and perms.sga.puede_modificar_niveles %}
                                                    <a href='?action=edit&id={{ nivel.id }}' class='btn btn-mini btn-info bloqueo_pantalla'><i class='fa fa-edit  tu' title='Editar'></i></a>
                                                    {% if nivel.puede_eliminarse %}
                                                        <a href="javascript:;" nhref='/niveles?action=del&id={{ nivel.id }}' class='btn eliminacionmodal btn-mini btn-danger'><i class='fa fa-remove tu' title='Eliminar'></i></a>
                                                    {% endif %}
                                                {% endif %}
                                                <a href='?action=materias&id={{ nivel.id }}' class='btn btn-sm btn-success btn-form bloqueo_pantalla' ><i class='fa fa-list '></i> Materias</a>
                                                <a href='/matriculas?action=matricula&id={{ nivel.id }}' class='btn btn-sm btn-primary btn-form bloqueo_pantalla'><i class='fa fa-user '></i> Matriculados </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    <tr>
                                        <td {% if persona.usuario.is_superuser %}colspan="5"{% endif %}></td>
                                        <td style="text-align: center"><strong>{% if coordinacion.id == 7 %}{{ matriculadoscoordperiodo }}{% else %}{{ matriculadoscoordperiodo|resta:cantidad_matriculas_solo_modulos_coordinacion }}{% endif %}</strong></td>
                                        <td colspan="7"></td>
                                    </tr>
                                {% endwith %}
                            </table>
                            {% if perms.sga.puede_modificar_niveles %}
                                <a href="/niveles?action=add&periodo={{ periodo.id }}&coordinacion={{ coordinacion.id }}" class="btn btn-success btn-mini"><i class="fa fa-plus"></i> Adicionar</a>
                            {% endif %}
                        </td>
                    </tr>
                    </tbody>
                {% endfor %}
                <tfoot>
                <tr>
                    <td>
                        {% with cantidad_matriculas_solo_modulos=periodo.cantidad_matriculas_solo_modulos cantidad_matriculas_solo_modulos_virtual=periodo.cantidad_matriculas_solo_modulos_virtual total_matriculados_virtual=periodo.total_matriculados_virtual total_matriculados=periodo.total_matriculados  total_matriculados_inscritos=periodo.total_matriculados_inscritos total_matriculadoscndeuda=periodo.total_matriculados_con_deuda total_matriculadosadmins=periodo.total_matriculados_admision  %}
                            {% if coordinacion.id == 7 %}
                                Total matriculados: <b>{{ total_matriculados }}</b> / En línea: <b>{{ total_matriculados_virtual }}</b> / M&oacute;dulos: <b>{{ cantidad_matriculas_solo_modulos }}</b>  /  Adeudan: <b>{{ total_matriculadoscndeuda }}</b> / Admisión: <b>{{ total_matriculadosadmins }}</b>
                            {% else %}
                                Total matriculados: <b>{{ total_matriculados|resta:cantidad_matriculas_solo_modulos }}</b> / En línea: <b>{{ total_matriculados_virtual|resta:cantidad_matriculas_solo_modulos_virtual }}</b> / M&oacute;dulos: <b>{{ cantidad_matriculas_solo_modulos }}</b>  /  Adeudan: <b>{{ total_matriculadoscndeuda }}</b> / Admisión: <b>{{ total_matriculadosadmins }}</b>
                            {% endif %}
                        {% endwith %}<br>
                        <a class="btn imprimir btn-warning tu" title="Reporte Matriculados"  href="javascript:;" tipos="{{ reporte_0.tiporeporte }}" nhref="/reportes?action=run&n={{ reporte_0.nombre }}&coordinacion_id=7&periodo={{ periodo.id }}&"><span class="fa fa-print"></span> Reporte Matriculados </a>&nbsp;
                        {% if perms.bd.puede_ver_periodo_academico_estadistica_matricula %}
                            <a class="btn btn-inverse tu" title="Estadisticas de matriculados"  href="/adm_sistemas/academic_period/statistics?id={{ periodo.id }}"><span class="fa fa-print"></span> Estadísticas de matriculados</a>&nbsp;
                        {% endif %}
                    </td>
                </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-----Modales----->
    <div class="modal fade static" id="itemspanel2" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="paneltitle">Reporte Avance Asistencia</h3>
                </div>
                <div class="modal-body panelbody">
                    <div class=ow-fluid">
                        <form id="form3" class="form-horizontal form-modal" style="width: 370px; margin-bottom: 0">
                            <div style="width: 150px">
                                <p>Date: <input type="text" id="id_fecha"></p>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="javascript:;" class="btn btn-danger" id="itemspanel_adicionar_2"><i class="fa fa-plus"></i> Procesar</a>
                    <a href="javascript:;" class="btn btn-info" id="itemspanel_cerrar_2"> Cerrar</a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade static" id="itemspanel4" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="paneltitle">Reporte Retención Estudiante</h3>
                </div>
                <div class="modal-body panelbody">
                    <div class=ow-fluid">
                        <form id="form4" class="form-horizontal form-modal" style="width: 370px; margin-bottom: 0">
                            <div style="width: 150px">
                                <b>Periodo1: </b>
                                <select name="periodo1" id="periodo1" style="width: 350px">
                                    {% for per in periodos_retencion %}
                                        <option selected value="{{ per.id }}" >
                                            {{ per.nombre }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <b>Periodo2: </b>
                                <select name="periodo2" id="periodo2" style="width: 350px">
                                    {% for per in periodos_retencion %}
                                        <option selected value="{{ per.id }}" >
                                            {{ per.nombre }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="javascript:;" class="btn btn-danger" id="itemspanel_adicionar_4"><i class="fa fa-plus"></i> Procesar</a>
                    <a href="javascript:;" class="btn btn-info" id="itemspanel_cerrar_4"> Cerrar</a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal static" id="cerrarpanel" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="cerrarpanelpaneltitle">Sacando Estudiantes Limpios</h3>
                </div>
                <div class="modal-body" id="cerrarpanelpanelbody">
                    <div class="progress progress-striped active">
                        <div class="bar" style="width: 0;" id="progressbar"></div>
                    </div>
                    <div id="cerrarpanelprogresshint">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade static" id="modalPeriodoActaAdmision" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="text-center"><b class="paneltitle m-2 text-uppercase">Período Acta Admisión</b></h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body panelbody">

                </div>
                <div class="modal-footer">
                    {% if perms.bd.puede_modificar_periodo_academico_matriculacion %}
                        <a href="javascript:;" class="btn btn-success action-save">Guardar</a>
                    {% endif %}
                    <a href="javascript:;" class="btn btn-danger action-close"> Cerrar</a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade static" id="modalResponsableActaAdmision" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="text-center"><b class="paneltitle m-2 text-uppercase">Responsable Acta Admisión</b></h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body panelbody">

                </div>
                <div class="modal-footer">
                    {% if perms.bd.puede_modificar_periodo_academico_matriculacion %}
                        <a href="javascript:;" class="btn btn-success action-save">Guardar</a>
                    {% endif %}
                    <a href="javascript:;" class="btn btn-danger action-close"> Cerrar</a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade static" id="modalRptCalificaciones" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="text-center"><b class="paneltitle m-2 text-uppercase">Reporte de calificaciones por período académico</b></h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body panelbody">

                </div>
                <div class="modal-footer">
                    <a href="javascript:;" class="btn btn-success action-download">Descargar</a>
                    <a href="javascript:;" class="btn btn-primary action-close"> Cerrar</a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade static" id="modal_firmaactas" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="text-center"><b class="paneltitle m-2 text-uppercase">Docentes firmantes de acta</b></h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body panelbodyfirmantes"></div>
                <div class="modal-footer">
                    <table class="pull-right">
                        <tr>
                            <td><a class="btn btn-danger" data-dismiss="modal"><i class="fa fa-close"></i> Cerrar</a></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade static" id="modal_reportes" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="text-center"><b class="paneltitle m-2 text-uppercase">Filtrar por Facultad</b></h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body panelbody">
                    <div class="row-fluid">
                        <div class="span12">
                            <label><input type="checkbox" id="filtros" value="first_checkbox"> Aplicar filtros</label><br>
                            <div class="form-group" id="coordinacion_group" style="display: none">
                                <form class="form-search">
                                    <select id="id_coordinacion" name="Coordinacion" style="width: 415px;">
                                        <option value="0">--------</option>
                                    </select>
                                </form>
                                <br>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <table class="pull-right">
                        <tr>
                            <td><a class="btn btn-success " id="download_report"><i class="fa fa-download"></i> Descargar Reporte</a>
                            </td>
                            <td><a class="btn btn-danger" data-dismiss="modal"><i class="fa fa-close"></i> Cerrar</a></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade static modal-sm" id="modal_reporte_estudiantes_postgrado" style="display: none; width: 400px!important;" role="dialog">
         <div class="modal-dialog modal-dialog-centered modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="text-center"><b class="paneltitle m-2 text-uppercase">Reporte de estudiantes matriculados en postgrado</b></h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row-fluid">
                        <form>
                            <input type="hidden" name="rid" value="{{ reporte_matriculados_postgrado.id }}">
                            <input type="hidden" name="action" value="run">
                            <fieldset class="control-group nomargins"
                                      style="float: left; padding-right: 10px; width: 100%">
                                <label class="control-label" for="formato_reporte">Formato Reporte:</label>
                                <div class="controls">
                                    <select name="rt" required="" style="width: 100%">
                                        <option value="xlsx">Excel</option>
                                        <option value="pdf">Pdf</option>
                                    </select>
                                    <p class="help-text"></p>
                                </div>
                            </fieldset>

                            <fieldset class="control-group nomargins" style="float: left; padding-right: 10px; width: 100%">
                                <label class="control-label" for="formato_reporte">Fecha fin de periodo:</label>
                                <div class="controls">
                                    <input type="date" id="ffin" name="ffin" data-date-format="YYYY-MM-DD" class="selectorfecha" style="width:231px">
                                    <p class="help-text"></p>
                                </div>
                            </fieldset>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <a id="modal_reporte_estudiantes_postgrado_descargar" class="btn btn-success">Descargar</a>
                    <a id="modal_reporte_estudiantes_postgrado_cerrar" class="btn btn-danger">Cerrar</a>
                </div>
            </div>
        </div>
    </div>

    <!---Se usan partes del elemento--->
     <div id="el-templates" style="display:none;">
        <div element="table-row-responsableactaadmision">
            <table>
                <tbody>
                <tr>
                    <td style="text-align: left; vertical-align: middle"></td>
                    <td style="text-align: center; vertical-align: middle"></td>
                    <td style="text-align: center; vertical-align: middle"></td>
                    <td style="text-align: center; vertical-align: middle"></td>
                    <td style="text-align: center; vertical-align: middle"></td>
                    <td style="text-align: center; vertical-align: middle">
                        <div class="btn-group">
                            <a style="margin-right: 5px;" href="javascript:;" class='btn btn-mini btn-danger tu action_remove_responsableactaadmision' title="Quitar coordinación"><span class="fa fa-remove"></span></a>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}
