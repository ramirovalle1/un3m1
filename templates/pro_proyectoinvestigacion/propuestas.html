{% extends "base.html" %}
{% load humanize %}
{% load sga_extras %}
{% block heading %}
    <script type="text/javascript" src='/static/js/jquery.validationEngine.js?v=1.0.0'></script>
    <script type="text/javascript" src='/static/js/jquery.validationEngine-es.js?v=1.0.0' ></script>
    <link type='text/css' rel='stylesheet' href="/static/css/validationEngine.jquery.css?v=1.0.0"/>
    <script type="text/javascript">
        $(function() {
            $('[data-bs-toggle="tooltip"]').on('click', function () {
                $(this).tooltip('hide');
            });

            $("#search").click(function() {
                busqueda();
            });

            $('#searchinput').keyup(function(e) {
                if(e.keyCode == 13) {
                    $("#search").trigger("click");
                }
            });

            busqueda = function () {
                let term = $("#searchinput").val().toUpperCase().trim();
                if (term.length > 0)
                    location.href = "/pro_proyectoinvestigacion?action=propuestas&idc={{ convocatoriaid|encrypt }}&s="+$("#searchinput").val().toUpperCase();
            };

            $(".mostrarrecorrido").click(function() {
                let id = $(this).attr('id');
                bloqueointerface();
                $.ajax({
                    type: "GET",
                    url: "/pro_proyectoinvestigacion",
                    data: {'action': 'mostrarrecorrido', 'id': id},
                    success: function(data) {
                        $.unblockUI();
                        if (data.result == 'ok') {
                            $(".paneltitlerecorrido").html(data.title);
                            $(".panelbodyrecorrido").html(data.data);
                            $("#itemspanelrecorrido").modal({backdrop:'static'}).modal('show');
                        } else {
                            mensajeErrorSwal("No se puede consultar", data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        mensajeErrorSwal("No se puede consultar", "Error al enviar los datos")
                    },
                    dataType: "json"
                });
            });

            $(".mostrarevaluaciones").click(function() {
                let id = $(this).attr('id');
                bloqueointerface();
                $.ajax({
                    type: "GET",
                    url: "/pro_proyectoinvestigacion",
                    data: {'action': 'mostrarevaluaciones', 'id': id},
                    success: function(data) {
                        $.unblockUI();
                        if (data.result == 'ok') {
                            $(".paneltitleevaluaciones").html(data.title);
                            $(".panelbodyevaluaciones").html(data.data);
                            $("#itemspanelevaluaciones").modal({backdrop:'static'}).modal('show');
                        } else {
                            mensajeErrorSwal("No se puede consultar", data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        mensajeErrorSwal("No se puede consultar", "Error al enviar los datos")
                    },
                    dataType: "json"
                });
            });

            $(".mostrarnovedad").click(function() {
                mostrarNovedad('{{ convocatoria.id|encrypt }}');
            });

            mostrarNovedad = function (idc){
                let id = idc;
                bloqueointerface();
                $.ajax({
                    type: "GET",
                    url: "/pro_proyectoinvestigacion",
                    data: {'action': 'mostrarnovedad', 'id': id},
                    success: function(data) {
                        $.unblockUI();
                        if (data.result == 'ok') {
                            $(".paneltitlenovedad").html(data.title);
                            $(".panelbodynovedad").html(data.data);
                            $("#itemspanelnovedad").modal({backdrop:'static'}).modal('show');
                        } else {
                            mensajeErrorSwal("No se puede consultar", data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        mensajeErrorSwal("No se puede consultar", "Error al enviar los datos")
                    },
                    dataType: "json"
                });
            };

            $(".generardocumento").click(function () {
                let id = $(this).attr('id');
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/pro_proyectoinvestigacion",
                    data: {'action':'generardocumento', 'id': id},
                    success: function(data) {
                        if (data.result == 'ok'){
                            location.href = "/pro_proyectoinvestigacion?action=propuestas&idc={{ convocatoria.id|encrypt }}&idf="+data.idf;
                        } else {
                            $.unblockUI();
                            if(data.swalType == 'warning')
                                mensajeWarningSwal(data.titulo, data.mensaje);
                            else
                                mensajeErrorSwal(data.titulo, data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        mensajeErrorSwal("No se puede consultar", "Error al enviar los datos");
                    },
                    dataType: "json"
                });
            });

            $(".subirdocumento").click(function() {
                let id = $(this).attr('id');
                bloqueointerface();
                $.ajax({
                    type: "GET",
                    url: "/pro_proyectoinvestigacion",
                    data: {'action': 'subirdocumento', 'id': id},
                    success: function(data) {
                        $.unblockUI();
                        if (data.result == 'ok') {
                            $(".panelbodysubirdocumento").html(data.data);
                            $(".paneltitlesubirdocumento").html(data.title);
                            $("#itemspanelsubirdocumento").modal({backdrop:'static'}).modal('show');
                        } else {
                            mensajeErrorSwal("No se puede consultar", data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        mensajeErrorSwal("No se puede consultar", "Error al enviar los datos")
                    },
                    dataType: "json"
                });
            });

            $("#itemspanelsubirdocumento .guardar").click(function () {
                envioformularioreg("/pro_proyectoinvestigacion", "subirdocumento", false);
                return false;
            });

            envioformularioreg = function(url, action, destino){
                let valido;
                let formdata;
                if(action == 'subirdocumento'){
                    $("#frmSubirDocumento").validationEngine('attach',{ scroll: false });
                    valido = $("#frmSubirDocumento").validationEngine('validate', { scroll: false });
                }
                else if(action == 'editactividadcronograma'){
                    $("#frmEditActividadCronograma").validationEngine('attach',{ scroll: false });
                    valido = $("#frmEditActividadCronograma").validationEngine('validate', { scroll: false });
                }
                else if(action == 'subirpresupuesto'){
                    $("#frmSubirPresupuesto").validationEngine('attach',{ scroll: false });
                    valido = $("#frmSubirPresupuesto").validationEngine('validate', { scroll: false });
                }

                if(valido){
                    bloqueointerface();
                    if(action == 'subirdocumento')
                        formdata = new FormData($("#frmSubirDocumento")[0]);
                    else if (action == 'editactividadcronograma')
                        formdata = new FormData($("#frmEditActividadCronograma")[0]);
                    else if (action == 'subirpresupuesto')
                        formdata = new FormData($("#frmSubirPresupuesto")[0]);

                    $.ajax({
                        type: "POST",
                        action: action,
                        url: url,
                        data: formdata,
                        success: function(data) {
                            if(data.result == 'ok'){
                                $.unblockUI();
                                urlDestino = "/pro_proyectoinvestigacion?action=propuestas&id="+data.id+"&idc={{ convocatoria.id|encrypt }}";
                                mensajeSuccessSwal(data.titulo, data.mensaje, urlDestino);
                            }else{
                                $.unblockUI();
                                if(data.swalType == 'warning')
                                    mensajeWarningSwal(data.titulo, data.mensaje);
                                else
                                    mensajeErrorSwal(data.titulo, data.mensaje);
                            }
                        },
                        error: function() {
                            $.unblockUI();
                            mensajeErrorSwal("No se puede guardar", "Error al enviar los datos")
                        },
                        dataType: "json",
                        cache: false,
                        contentType: false,
                        processData: false
                    });
                }else{
                    setTimeout(function() {
                        $('.help-text').html("");
                    }, 8000);
                    $.unblockUI();
                }
            };

            $(".eliminar").click(function() {
                let id = $(this).attr('id');
                let titulo = $(this).attr('titulo');
                let url = "/pro_proyectoinvestigacion";
                let action = "delpropuestaproyecto";
                let urlDestino = "/pro_proyectoinvestigacion?action=propuestas&idc={{ convocatoria.id|encrypt }}";

                mensajeConfirmSwal("Eliminar Propuesta de Proyecto", "¿Está seguro de eliminar la propuesta de proyecto de investigación con el título "+titulo+"?", true, url, action, id, urlDestino);
            });

            $(".habilitar").click(function() {
                let id = $(this).attr('id');
                let titulo = $(this).attr('titulo');
                let url = "/pro_proyectoinvestigacion";
                let action = "habilitaredicion";
                let urlDestino = "/pro_proyectoinvestigacion?action=propuestas&idc={{ convocatoria.id|encrypt }}";

                mensajeConfirmSwal("Habilitar Edición de Propuesta de Proyecto", "¿Está seguro de habilitar la edición de información para la propuesta de proyecto de investigación con el título "+titulo+"?", true, url, action, id, urlDestino);
            });

            $(".subirpresupuesto").click(function() {
                let id = $(this).attr('id');
                bloqueointerface();
                $.ajax({
                    type: "GET",
                    url: "/pro_proyectoinvestigacion",
                    data: {'action': 'subirpresupuesto', 'id': id},
                    success: function(data) {
                        $.unblockUI();
                        if (data.result == 'ok') {
                            $(".panelbodysubirpresupuesto").html(data.data);
                            $(".paneltitlesubirpresupuesto").html(data.title);
                            $("#itemspanelsubirpresupuesto").modal({backdrop:'static'}).modal('show');
                        } else {
                            mensajeErrorSwal("No se puede consultar", data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        mensajeErrorSwal("No se puede consultar", "Error al enviar los datos")
                    },
                    dataType: "json"
                });
            });

            $("#itemspanelsubirpresupuesto .guardar").click(function () {
                envioformularioreg("/pro_proyectoinvestigacion", "subirpresupuesto", false);
                return false;
            });

            {% if formatoinscripcion %}
                Fancybox.show([
                    {
                        src: "{{ formatoinscripcion }}",
                        width: 2048,
                        height: 1365,
                        caption:"{{ tipoformato }}"
                    }
                ]);
            {% endif %}

            {% if existenovedad %}
                mostrarNovedad('{{ convocatoria.id|encrypt }}');
            {% endif %}

        });
    </script>
{% endblock %}
{% block atras %}/pro_proyectoinvestigacion?action=convocatorias{% endblock %}
{% block canvas %}
    {# TITULO PANTALLA #}
    <div class='row'>
        <div class='col-lg-12'>
            <div class="headtitle">
                <h3 class="texto-blue">{{ title }}</h3>
                <h6>Propuestas de Docentes (Convocatoria: {{ tituloconvocatoria }})</h6>
            </div>
        </div>
    </div>
    {# TITULO PANTALLA #}

    <div class="container-fluid">
        {# FILA DE MENSAJE #}
        {% if convocatoria.vigente %}
            {% if mostrarboton or mensaje %}
                <div class='row'>
                    <div class="col-sm-12 pb-2">
                        {% if mensaje %}
                            <div class="{{ clasemsg }} d-flex align-items-center" role="alert">
                                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-exclamation-triangle-fill me-2" viewBox="0 0 16 16">
                                     <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                                  </svg>
                                  <div>
                                     {{ mensaje|safe }}
                                  </div>
                             </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        {% endif %}
        {# FILA DE MENSAJE #}
        {# FILA DE MENSAJE #}
        {% if not proyectos and not mensaje %}
            <div class='row'>
                <div class="col-sm-12 pb-2">
                    <div class="alert alert-primary d-flex align-items-center" role="alert">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-info-circle-fill me-2" viewBox="0 0 16 16">
                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                        </svg>
                        <div>
                            <strong>Nota:</strong> Los docentes que deseen dirigir o co-dirgir un proyecto de investigación, deben estar registrados en el Sistema de Registro, Acreditación y Categorización de Investigadores Nacionales y Extranjeros de la Senescyt.
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        {# FILA DE MENSAJE #}
        {# FILA DE FILTRO #}
        {% if not mensaje %}
            <div class='row'>
                {# COLUMNA REPORTE #}
                <div class="col-sm-8 pb-2">
                    {% if mostrarboton %}
                        <a href="/pro_proyectoinvestigacion?action=addpropuestaproyecto&idc={{ convocatoria.id|encrypt }}" class='btn btn-success tu' title="Agregar Propuesta de proyecto"><span class="fa fa-plus" ></span> Agregar</a>
                    {% endif %}
                </div>
                {# COLUMNA REPORTE #}
                {# COLUMNA FILTRO #}
                <div class="col-sm-4 pb-2">
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" autocomplete="off" placeholder="Título del proyecto" aria-label="Buscar" id='searchinput' name="s" value="{{ s }}">
                        <div class="input-group-append">
                            <button class="btn btn-primary-old tu" id="search" title="Buscar" type="button"><i class="fa fa-search"></i></button>
                            {% if url_vars %}
                                {% if s or id %}
                                    <a title="Ver todo" href="{{ request.path }}?action=propuestas&idc={{ convocatoriaid|encrypt }}" class="btn btn-default tr"><i class="fas fa-sync-alt"></i></a>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {# COLUMNA FILTRO #}
            </div>
        {% endif %}
        {# FILA DE FILTRO #}
        {# TABLA DE DATOS #}
        <div class="card mb-4">
            <div class="card-body border-top border-6 rounded-3 border-dark-info">
                <div class="table-responsive-xxl">
                    <table class='table table_primary table-striped'>
                        <thead>
                            <tr>
                                <th style="width: 7%;" class="text-center">F.Registro</th>
                                <th style="width: 10%;" class="text-center">Categoría</th>
                                <th style="width: 34%;" class="text-center">Título/Línea</th>
                                <th style="width: 5%;" class="text-center">Archivos</th>
                                <th style="width: 12%;" class="text-center">Tiempos</th>
                                <th style="width: 7%;" class="text-center">Cobertura</th>
                                <th style="width: 10%;" class="text-center">Montos</th>
                                <th style="width: 10%;" class="text-center">Estado</th>
                                <th style="width: 5%;" class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for proyecto in proyectos %}
                                {% with rolparticipante=proyecto|args:persona|call:"rol_participante" %}
                                    <tr>
                                        <td class="text-center">
                                            <p>{{ proyecto.fecha_creacion|date:"d-m-Y" }}</p>
                                        </td>
                                        <td class="text-center">
                                            <p>{{ proyecto.categoria2.descripcion|title }}</p>
                                        </td>
                                        <td class="text-justify">
                                            <p>{{ proyecto.titulo }}</p>
                                            <p class="text-info">{{ proyecto.lineainvestigacion.nombre|title }}</p>
                                            <p><strong>Rol cumplido:</strong> <span class="badge bg-info">{{ rolparticipante.descripcion|title }}</span></p>
                                        </td>
                                        <td class="text-center">
                                            {% if proyecto.archivopresupuesto %}
                                                <a href="{{ proyecto.archivopresupuesto.url }}" class="fs-4" data-width="2048" data-height="1380" data-fancybox="presupesto{{ proyecto.id }}" data-caption="Presupuesto Final" data-bs-toggle="tooltip" data-placement="top" title="Presupuesto Final"><i class="fa fa-eye text-info"></i> </a>
                                            {% endif %}
                                            {% if proyecto.archivoproyecto %}
                                                <a href="{{ proyecto.archivoproyecto.url }}" class=fs-4" data-width="2048" data-height="1380" data-fancybox="proyecto{{ proyecto.id }}" data-caption="Archivo del Proyecto" data-bs-toggle="tooltip" data-placement="top" title="Archivo del Proyecto"><i class="fa fa-eye text-info"></i> </a>
                                            {% endif %}
                                            {% if proyecto.documentogenerado %}
                                                <a href="{{ proyecto.archivodocumento.url }}" class="fs-4" data-width="2048" data-height="1380" data-fancybox="formatosinfirmar{{ proyecto.id }}" data-caption="Formato Inscripción" data-bs-toggle="tooltip" data-placement="top" title="Formato Inscripción"><i class="fa fa-eye text-success"></i> </a>
                                            {% endif %}
                                            {% if proyecto.documentogenerado and proyecto.archivodocumentofirmado %}
                                                <a href="{{ proyecto.archivodocumentofirmado.url }}" class="fs-4" data-width="2048" data-height="1380" data-fancybox="formatofirmado{{ proyecto.id }}" data-caption="Formato Inscripción Firmado" data-bs-toggle="tooltip" data-placement="top" title="Formato Inscripción Firmado"><i class="fa fa-eye text-warning"></i> </a>
                                            {% endif %}
                                            {% if proyecto.archivoanulacion %}
                                                <a href="{{ proyecto.archivoanulacion.url }}" class="fs-4" data-width="2048" data-height="1380" data-fancybox="anulacion{{ proyecto.id }}" data-caption="Respaldo Anulación de Proyecto" data-bs-toggle="tooltip" data-placement="top" title="Respaldo Anulación del Proyecto"><i class="fa fa-eye text-danger"></i> </a>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <div class="arrow-content">
                                                <i class="arrow-item" style="bottom: 1px"></i>
                                                <div class="arrow-text" data-bs-toggle="tooltip"><b class="tu" title="Tiempo Duración">Dur:</b> {{ proyecto.tiempomes }} meses</div>
                                            </div>
                                            {% if proyecto.fase_aprobacion_superada %}
                                                <div class="arrow-content">
                                                    <i class="arrow-item" style="bottom: 1px"></i>
                                                    <div class="arrow-text" data-bs-toggle="tooltip"><b class="tu" title="Fecha Inicio">Fi:</b> {% if proyecto.fechainicio %}{{ proyecto.fechainicio|date:"d-m-Y" }}{% else %}<span class="text-warning">No disponible</span>{% endif %}</div>
                                                </div>
                                                <div class="arrow-content">
                                                    <i class="arrow-item" style="bottom: 1px"></i>
                                                    <div class="arrow-text" data-bs-toggle="tooltip"><b class="tu" title="Fecha Fin Estimada">Ff:</b> {% if proyecto.fechafinplaneado %}{{ proyecto.fechafinplaneado|date:"d-m-Y" }}{% else %}<span class="text-warning">No disponible</span>{% endif %}</div>
                                                </div>
                                                {% if proyecto.fechafinreal %}
                                                    <div class="arrow-content">
                                                        <i class="arrow-item" style="bottom: 1px"></i>
                                                        <div class="arrow-text" data-bs-toggle="tooltip"><b class="tu" title="Fecha Fin Real">Ffr:</b> {{ proyecto.fechafinreal|date:"d-m-Y" }}</div>
                                                    </div>
                                                {% endif %}
                                                {% if proyecto.fechacierre %}
                                                    <div class="arrow-content">
                                                        <i class="arrow-item" style="bottom: 1px"></i>
                                                        <div class="arrow-text" data-bs-toggle="tooltip"><b class="tu" title="Fecha Cierre">Fc:</b> {{ proyecto.fechacierre|date:"d-m-Y" }}</div>
                                                    </div>
                                                {% endif %}
                                                {% if proyecto.reprogramacion %}
                                                    <p><b>Re-Prog:</b> <a href="{{ proyecto.resolucionreprogramacionocs.url }}" class="fs-4" data-width="2048" data-height="1380" data-fancybox="resolucionocsreprog{{ forloop.counter }}" data-caption="Resolución OCS de la re-programación" data-bs-toggle="tooltip" data-placement="top" title="Ver resolución OCS"><i class="fa fa-eye text-info"></i> </a></p>
                                                    <div class="arrow-content">
                                                        <i class="arrow-item" style="bottom: 1px"></i>
                                                        <div class="arrow-text" data-bs-toggle="tooltip"><b class="tu" title="Tiempo Duración">Dur:</b> {{ proyecto.tiempomesreprogramacion }} meses</div>
                                                    </div>
                                                    <div class="arrow-content">
                                                        <i class="arrow-item" style="bottom: 1px"></i>
                                                        <div class="arrow-text" data-bs-toggle="tooltip"><b class="tu" title="Fecha Inicio Re-programacion">Fi:</b> {{ proyecto.inicioreprogramacion|date:"d-m-Y" }}</div>
                                                    </div>
                                                    <div class="arrow-content">
                                                        <i class="arrow-item" style="bottom: 1px"></i>
                                                        <div class="arrow-text" data-bs-toggle="tooltip"><b class="tu" title="Fecha Fin Re-programacion">Fr:</b> {{ proyecto.finreprogramacion|date:"d-m-Y" }}</div>
                                                    </div>
                                                {% endif %}
                                                {% if proyecto.prorroga %}
                                                    <p><b>Prórroga:</b> <a href="{{ proyecto.resolucionprorrogaocs.url }}" class="fs-4" data-width="2048" data-height="1380" data-fancybox="resolucionocsprorr{{ forloop.counter }}" data-caption="Resolución OCS de la prórroga" data-bs-toggle="tooltip" data-placement="top" title="Ver resolución OCS"><i class="fa fa-eye text-info"></i> </a></p>
                                                    <div class="arrow-content">
                                                        <i class="arrow-item" style="bottom: 1px"></i>
                                                        <div class="arrow-text" data-bs-toggle="tooltip"><b class="tu" title="Tiempo Duración">Dur:</b> {{ proyecto.tiempomesprorroga }} meses</div>
                                                    </div>
                                                    <div class="arrow-content">
                                                        <i class="arrow-item" style="bottom: 1px"></i>
                                                        <div class="arrow-text" data-bs-toggle="tooltip"><b class="tu" title="Fecha Inicio Prórroga">Fi:</b> {{ proyecto.inicioprorroga|date:"d-m-Y" }}</div>
                                                    </div>
                                                    <div class="arrow-content">
                                                        <i class="arrow-item" style="bottom: 1px"></i>
                                                        <div class="arrow-text" data-bs-toggle="tooltip"><b class="tu" title="Fecha Fin Prórroga">Fp:</b> {{ proyecto.finprorroga|date:"d-m-Y" }}</div>
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if proyecto.tipo %}
                                                <span class="badge bg-warning">{{ proyecto.get_tipo_display|title }}</span><br>
                                            {% endif %}
                                            <p>{{ proyecto.get_tipocobertura_display|title }}</p>
                                        </td>
                                        <td>
                                            <p><b>Total proyecto:</b></p>
                                            <div class="arrow-content">
                                                <i class="arrow-item" style="bottom: 1px"></i>
                                                <div class="arrow-text" data-bs-toggle="tooltip"><span class="tu" title="Monto total del proyecto">$ {{ proyecto.montototal|floatformat:2|intcomma }}</span></div>
                                            </div>
                                            <p><b>Presupuesto:</b></p>
                                            <div class="arrow-content">
                                                <i class="arrow-item" style="bottom: 1px"></i>
                                                <div class="arrow-text" data-bs-toggle="tooltip"><span class="tu" title="Presupuesto">$ {{ proyecto.presupuesto|floatformat:2|intcomma }}</span></div>
                                            </div>
                                            {% if proyecto.fase_aprobacion_superada %}
                                                <div class="arrow-content">
                                                    <i class="arrow-item" style="bottom: 1px"></i>
                                                    <div class="arrow-text" data-bs-toggle="tooltip"><span class="text-info tu" title="Devengado">$ {{ proyecto.devengado|floatformat:2|intcomma }}</span></div>
                                                </div>
                                                <div class="arrow-content">
                                                    <i class="arrow-item" style="bottom: 1px"></i>
                                                    <div class="arrow-text" data-bs-toggle="tooltip"><span class="text-success tu" title="Saldo">$ {{ proyecto.saldo|floatformat:2|intcomma }}</span></div>
                                                </div>
                                                {% if proyecto.presupuesto != proyecto.montototal %}
                                                    <p class="text-warning text-justify">Se requiere actualización del detalle del presupuesto</p>
                                                {% endif %}
                                                {% with permisorubros=proyecto|args:1|args:2|call:"permiso_edicion_vigente" %}
                                                    {% if permisorubros %}
                                                        <br>
                                                        <p class="text-warning text-justify">
                                                        {% if permisorubros.estado == 1 %}
                                                            Tiene pendiente la edición de los rubros del presupuesto
                                                        {% else %}
                                                            Una vez que el valor de total presupuesto registrado sea igual al monto total del proyecto debe finalizar edición
                                                        {% endif %}
                                                        </p>
                                                    {% endif %}
                                                {% endwith %}
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <span class="{{ proyecto.estado.clase }} tu" title="{{ proyecto.estado.observacion|title }}">{{ proyecto.estado.descripcion|title }}</span>
                                            {% if proyecto.estado.valor != 4 %}
                                                {% if proyecto.novedades_propuesta or proyecto.integrantes_director_codirector_novedad or proyecto.estadodocumentofirmado == 4 %}
                                                    <p class="text-danger">Existen novedades pendientes de corregir</p>
                                                    <p><a href="javascript:;" class="fs-4 mostrarnovedad" data-bs-toggle="tooltip" data-placement="top" title="Mostrar Novedades"><i class="fa fa-eye text-danger"></i></a></p>
                                                {% endif %}
                                            {% elif proyecto.estado.valor == 4 %}
                                                <p><a href="javascript:;" class="fs-4 mostrarnovedad" data-bs-toggle="tooltip" data-placement="top" title="Mostrar Novedades"><i class="fa fa-eye text-danger"></i></a></p>
                                            {% endif %}
                                            {% if proyecto.reprogramacion %}
                                                <br>
                                                <span class="badge bg-dark">Re-programación</span>
                                            {% endif %}
                                            {% if proyecto.prorroga %}
                                                <br>
                                                <span class="badge bg-warning">Prórroga</span>
                                            {% endif %}
                                            {% if proyecto.pendiente_finalizacion %}
                                                <p class="text-warning text-justify">El proyecto debió haber finalizado el {% if not proyecto.prorroga and not proyecto.reprogramacion %}{{ proyecto.fechafinplaneado|date:"d-m-Y" }}{% else %}{{ proyecto.fechafinreal|date:"d-m-Y" }}{% endif %}</p>
                                            {% endif %}
                                            {% if proyecto.fase_aprobacion_superada %}
                                                {% with valoresavance=proyecto.valores_ejecucion %}
                                                    <p>E.Técnica:</p>
                                                    <div class="progress">
                                                        <div class="progress-bar tu" title="{{ valoresavance.etecnicacumplida }}% cumplido" role="progressbar" style="width: {{ valoresavance.etecnicacumplida }}%;" aria-valuenow="{{ valoresavance.etecnicacumplida }}" aria-valuemin="0" aria-valuemax="100">{% if valoresavance.etecnicacumplida >= 20 %}{{ valoresavance.etecnicacumplida }}%{% endif %}</div>
                                                    </div>
                                                    <p>E.Financiera:</p>
                                                    <div class="progress">
                                                        <div class="progress-bar tu" title="{{ valoresavance.efinancieracumplida }}% cumplido" role="progressbar" style="width: {{ valoresavance.efinancieracumplida }}%;" aria-valuenow="{{ valoresavance.efinancieracumplida }}" aria-valuemin="0" aria-valuemax="100">{% if valoresavance.efinancieracumplida >= 20 %}{{ valoresavance.efinancieracumplida }}%{% endif %}</div>
                                                    </div>
                                                {% endwith %}
                                            {% endif %}
                                            {% if proyecto.estado.valor == 20  %}
                                                {% if proyecto.presupuesto != proyecto.montototal %}
                                                    <br>
                                                    <div class="alert alert-warning p-0" role="alert">
                                                        <b>Atención:</b> Se requiere una actualización de los rubros del detalle del Prespuesto
                                                    </div>
                                                {% endif %}
                                                {% with permisorubros=proyecto|args:1|args:1|call:"permiso_edicion_vigente" permisocronograma=proyecto|args:2|args:1|call:"permiso_edicion_vigente" %}
                                                    {% if permisorubros %}
                                                        <br>
                                                        <div class="alert alert-warning p-0" role="alert">
                                                        <b>Atención:</b>
                                                        {% if permisorubros.estado == 1 %}
                                                            Tiene pendiente la edición de los rubros del Presupuesto
                                                        {% else %}
                                                            Una vez que el valor de Total Presupuesto Registrado sea igual al Monto Total del proyecto debe finalizar edición
                                                        {% endif %}
                                                        </div>
                                                    {% endif %}
                                                    {% if permisocronograma %}
                                                        <br>
                                                        <div class="alert alert-warning p-0" role="alert">
                                                        <b>Atención:</b>
                                                        {% if permisocronograma.estado == 1 %}
                                                            Tiene pendiente la edición del Cronograma de actividades
                                                        {% else %}
                                                            Una vez que haya hecho los cambios necesarios al cronograma del proyecto debe finalizar edición
                                                        {% endif %}
                                                        </div>
                                                    {% endif %}
                                                {% endwith %}
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <div class="dropbottom" style="text-align: left">
                                            <button type="button" class="btn btn-default dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Acciones <i class="fa fa-angle-down"></i></button>
                                            <ul class="dropdown-menu pull-right" x-placement="right-start">
                                                <li class="dropdown-item"><a class="mostrarrecorrido" id="{{ proyecto.id|encrypt }}" href="javascript:;"><i class="fa fa-list-ol"></i> Mostrar Recorrido</a></li>
                                                <li class="dropdown-item"><a href="/pro_proyectoinvestigacion?action=informacionproyecto&id={{ proyecto.id|encrypt }}"><i class="fa fa-paste"></i> Mostrar Información</a></li>
                                                {% if proyecto.convocatoria.esta_abierta %}
                                                    {% if proyecto.estado.valor == 2 or proyecto.estado.valor == 5 %}
                                                        <li class="dropdown-item"><a class="habilitar" id="{{ proyecto.id|encrypt }}" titulo="<b>{{ proyecto.titulo }}</b>" href="javascript:;"><i class="fa fa-pencil-square-o"></i> Habilitar Edición</a></li>
                                                    {% endif %}
                                                {% endif %}
                                                {% if rolparticipante.id == 1 and not proyecto.fase_aprobacion_superada %}
                                                    {% if proyecto.puede_editar %}
                                                        <li class="dropdown-item"><a href="/pro_proyectoinvestigacion?action=editpropuestaproyecto&id={{ proyecto.id|encrypt }}"><i class="fa fa-edit"></i> Editar Datos Generales</a></li>
                                                        <li class="dropdown-item"><a href="/pro_proyectoinvestigacion?action=personalproyecto&id={{ proyecto.id|encrypt }}"><i class="fa fa-users"></i> Integrantes</a></li>
                                                        <li class="dropdown-item"><a href="/pro_proyectoinvestigacion?action=contenidoproyecto&id={{ proyecto.id|encrypt }}"><i class="fa fa-list"></i> Contenido</a></li>
                                                    {% endif %}
                                                    {% if proyecto.resumenpropuesta and proyecto.puede_editar %}
                                                        <li class="dropdown-item"><a href="/pro_proyectoinvestigacion?action=presupuesto&id={{ proyecto.id|encrypt }}"><i class="fa fa-money"></i> Presupuesto</a></li>
                                                        <li class="dropdown-item"><a href="/pro_proyectoinvestigacion?action=cronograma&id={{ proyecto.id|encrypt }}"><i class="fa fa-tasks"></i> Cronograma</a></li>
                                                        {% if proyecto.cronograma_asignado %}
                                                            {% if proyecto.convocatoria.apertura.year == 2022 %}
{#                                                                {% if proyecto.puede_subir_archivo_presupuesto %}#}
{#                                                                    <div class="dropdown-divider"></div>#}
{#                                                                    {% if proyecto.convocatoria.archivoformatopresupuesto %}#}
{#                                                                        <li class="dropdown-item"><a target="_blank" href="{{ proyecto.convocatoria.archivoformatopresupuesto.url }}"><i class="fa fa-download"></i> Formato Presupuesto Final</a></li>#}
{#                                                                    {% endif %}#}
{#                                                                    <li class="dropdown-item"><a href="javascript:;" class="subirpresupuesto" id="{{ proyecto.id|encrypt }}"><i class="fa fa-cloud-upload"></i> Subir Presupuesto Final</a></li>#}
{#                                                                {% endif %}#}
                                                            {% endif %}
                                                            {% if proyecto.puede_generar_documento %}
                                                                <div class="dropdown-divider"></div>
                                                                {% if not proyecto.documentogenerado %}
                                                                    <li class="dropdown-item"><a class="generardocumento" id="{{ proyecto.id|encrypt }}" href="javascript:;"><i class="fa fa-print"></i> Imprimir Formato Inscripción</a></li>
                                                                {% else %}
                                                                    <li class="dropdown-item"><a href="{{ proyecto.archivodocumento.url }}" data-width="2048" data-height="1380" data-fancybox="formatoinscripcion{{ forloop.counter }}" data-caption="Formato de Inscripción del Proyecto"><i class="fa fa-print"></i> Imprimir Formato Inscripción</a></li>
                                                                {% endif %}
                                                            {% endif %}
                                                            {% if proyecto.puede_subir_documento and proyecto.documentogenerado %}
                                                                <li class="dropdown-item"><a href="javascript:;" class="subirdocumento" id="{{ proyecto.id|encrypt }}"><i class="fa fa-cloud-upload"></i> Subir Formato Firmado</a></li>
                                                                {% if proyecto.archivodocumentofirmado %}
                                                                    <li class="dropdown-item"><a href="/pro_proyectoinvestigacion?action=finalizaedicion&id={{ proyecto.id|encrypt }}"><i class="fa fa-check"></i> Finalizar Edición</a></li>
                                                                {% endif %}
                                                            {% endif %}
                                                            {% if proyecto.tiene_evaluaciones_cerradas %}
                                                                <div class="dropdown-divider"></div>
                                                                <li class="dropdown-item"><a class="mostrarevaluaciones" id="{{ proyecto.id|encrypt }}" href="javascript:;"><i class="fa fa-search-plus"></i> Mostrar Evaluaciones</a></li>
                                                            {% endif %}
                                                            {% if proyecto.estado.valor == 20 %}
                                                                {% if not proyecto.tiene_conflicto_fecha_cronograma %}
                                                                    <li class="dropdown-item"><a href="/pro_proyectoinvestigacion?action=informesproyecto&id={{ proyecto.id|encrypt }}"><i class="fa fa-file-text"></i> Informes</a></li>
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endif %}
                                                    {% if proyecto.estado.valor == 1 or proyecto.estado.valor == 2 %}
                                                        <div class="dropdown-divider"></div>
                                                        <li class="dropdown-item"><a class="eliminar" id="{{ proyecto.id|encrypt }}" titulo="<b>{{ proyecto.titulo }}</b>" href="javascript:;"><i class="fa fa-remove"></i> Eliminar</a></li>
                                                    {% endif %}
                                                    {% if proyecto.estado.valor == 13 and proyecto.convocatoria.apertura.year >= 2023 %}
                                                        <div class="dropdown-divider"></div>
                                                        <li class="dropdown-item"><a href="/pro_proyectoinvestigacion?action=presupuesto&id={{ proyecto.id|encrypt }}"><i class="fa fa-money"></i> Presupuesto</a></li>
                                                    {% endif %}
                                                    {% if proyecto.estado.valor == 18 and proyecto.convocatoria.apertura.year >= 2023 %}
                                                        <li class="dropdown-item"><a href="/pro_proyectoinvestigacion?action=cronograma&id={{ proyecto.id|encrypt }}"><i class="fa fa-tasks"></i> Cronograma</a></li>
                                                    {% endif %}

                                                {% else %}
{#                                                    {% if rolparticipante.id == 1 and proyecto.estado.valor == 20 and proyecto.convocatoria.apertura.year == 2022 %}#}
{#                                                        <div class="dropdown-divider"></div>#}
{#                                                        <li class="dropdown-item"><a href="javascript:;" class="subirpresupuesto" id="{{ proyecto.id|encrypt }}"><i class="fa fa-cloud-upload"></i> Subir Presupuesto Actualizado</a></li>#}
{#                                                    {% endif %}#}
                                                    {% if proyecto.tiene_evaluaciones_cerradas and proyecto.convocatoria.apertura.year > 2020 %}
                                                        <li class="dropdown-item"><a class="mostrarevaluaciones" id="{{ proyecto.id|encrypt }}" href="javascript:;"><i class="fa fa-search-plus"></i> Mostrar Evaluaciones</a></li>
                                                    {% endif %}
                                                    {% if proyecto.fase_aprobacion_superada %}
                                                        <li class="dropdown-item"><a href="/pro_proyectoinvestigacion?action=cronograma&id={{ proyecto.id|encrypt }}"><i class="fa fa-tasks"></i> Cronograma</a></li>
{#                                                        {% with puedeeditarcronograma=proyecto|args:1|call:"puede_editar_cronograma_actividades" %}#}
{#                                                            {% if puedeeditarcronograma %}#}
{#                                                                <li class="dropdown-item"><a href="/pro_proyectoinvestigacion?action=cronograma&id={{ proyecto.id|encrypt }}"><i class="fa fa-tasks"></i> Cronograma</a></li>#}
{#                                                            {% endif %}#}
{#                                                        {% endwith %}#}

                                                        {% with puedeeditaritems=proyecto|args:1|call:"puede_editar_rubros_presupuesto" %}
                                                            {% if puedeeditaritems %}
                                                                <li class="dropdown-item"><a href="/pro_proyectoinvestigacion?action=presupuesto&id={{ proyecto.id|encrypt }}"><i class="fa fa-money"></i> Presupuesto</a></li>
                                                            {% endif %}
                                                        {% endwith %}
                                                        <div class="dropdown-divider"></div>
                                                        <li class="dropdown-item"><a href="/pro_proyectoinvestigacion?action=informesproyecto&id={{ proyecto.id|encrypt }}"><i class="fa fa-file-text"></i> Informes</a></li>
                                                    {% endif %}
                                                {% endif %}
                                            </ul>
                                            </div>
                                        </td>
                                    </tr>
                                    {% if proyecto.cronograma_asignado and proyecto.estado.valor == 1 and not proyecto.novedades_propuesta %}
                                        <tr>
                                            <td colspan="9">
                                                <div class="alert alert-primary d-flex align-items-center" role="alert">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-info-circle-fill me-2" viewBox="0 0 16 16">
                                                        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                                                    </svg>
                                                    <div>
                                                        <strong>Consideraciones para poder imprimir el formato de inscripción del proyecto:</strong>
                                                        <ul>
                                                            <li>El presupuesto debe estar completo</li>
                                                            <li>El cronograma de actividades debe cumplir con el 100% de la ponderación y la cantidad de meses acumulada de las mismas debe ser igual a la cantidad de meses de duración del proyecto</li>
                                                            <li>La cantidad mínima de integrantes debe ser la solicitada</li>
                                                            <li>El director/co-director del proyecto deben tener cargado el certificado de registro de investigador </li>
                                                            <li>Para aprobación del proyecto, este deberá contar con un profesor titular a tiempo completo de manera obligatoria, que pueda asumir el rol de Director en caso de ausencia temporal o permanente del mismo.</li>
                                                            <li>El proyecto deberá contar con mínimo 2 ayudantes de investigación</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                                {% with advertencias=proyecto.advertencias_generar_documento %}
                                                    {% if advertencias %}
                                                        <div class="alert alert-danger d-flex align-items-center" role="alert">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-exclamation-triangle-fill me-2" viewBox="0 0 16 16">
                                                                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                                                            </svg>
                                                            <div>
                                                                <strong>Advertencias encontradas:</strong>
                                                                <ul>
                                                                    {% for advertencia in advertencias %}
                                                                        <li>{{ advertencia.mensaje|safe }}</li>
                                                                    {% endfor %}
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                {% endwith %}
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% endwith %}
                            {% empty %}
                                <tr><td style="text-align: center" colspan="9">No existen registros de propuestas de proyectos de investigación</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer border-top-0">
                {% include 'paginacionb4.html' %}
            </div>
        </div>
        {# TABLA DE DATOS #}
    </div>

    <div class="modal fade static"  id="itemspanelrecorrido" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
            <div class="modal-content border-radius-modal">
                <div class="modal-header" style="padding-bottom: .7rem !important">
                    <h4 class="mb-0"><i class="fa fa-list-ol"></i>&nbsp;<span class="paneltitlerecorrido">Mostrar Recorrido de la Convocatoria</span></h4>
                    <button type="button" class="btn-close btn-cerrar-modal fs-5" data-bs-dismiss="modal" aria-label="Close">X</button>
                </div>
                <div class="modal-body panelbodyrecorrido">

                </div>
                <div class="modal-footer" id="footermodal">
                    <button type="button" class="btn btn-cian-secondary fs-5" data-bs-dismiss="modal"> Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade static"  id="itemspanelsubirdocumento" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content border-radius-modal">
                <div class="modal-header" style="padding-bottom: .7rem !important">
                    <h4 class="mb-0"><i class="fa fa-cloud-upload"></i>&nbsp;<span class="paneltitlesubirdocumento">Mostrar Recorrido de la Convocatoria</span></h4>
                    <button type="button" class="btn-close btn-cerrar-modal fs-5" data-bs-dismiss="modal" aria-label="Close">X</button>
                </div>
                <div class="modal-body panelbodysubirdocumento">

                </div>
                <div class="modal-footer" id="footermodal">
                    <button type="button" class="btn btn-orange fs-5 guardar"><i class="fa fa-check-circle" aria-hidden="true"></i> Guardar</button>
                    <button type="button" class="btn btn-cian-secondary fs-5" data-bs-dismiss="modal"><i class="fa fa-close" aria-hidden="true"></i> Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade static"  id="itemspanelnovedad" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
            <div class="modal-content border-radius-modal">
                <div class="modal-header" style="padding-bottom: .7rem !important">
                    <h4 class="mb-0"><i class="fa fa-warning"></i>&nbsp;<span class="paneltitlenovedad">Mostrar Recorrido de la Convocatoria</span></h4>
                    <button type="button" class="btn-close btn-cerrar-modal fs-5" data-bs-dismiss="modal" aria-label="Close">X</button>
                </div>
                <div class="modal-body panelbodynovedad">

                </div>
                <div class="modal-footer" id="footermodal">
                    <button type="button" class="btn btn-cian-secondary fs-5" data-bs-dismiss="modal"><i class="fa fa-close" aria-hidden="true"></i> Cancelar</button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade static"  id="itemspanelevaluaciones" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4><i class="fa fa-search-plus"></i>&nbsp;<span class="paneltitleevaluaciones">Mostrar Recorrido de la Convocatoria</span></h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    </button>
                </div>
                <div class="modal-body panelbodyevaluaciones">

                </div>
                <div class="modal-footer" id="footermodal">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal"> Cerrar</button>
                </div>
            </div>
        </div>
    </div>

{##}
{##}
{#    <div class="modal fade static"  id="itemspanelnovedad" style="display: none;">#}
{#        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl" role="document">#}
{#            <div class="modal-content">#}
{#                <div class="modal-header">#}
{#                    <h4><i class="fa fa-warning"></i>&nbsp;<span class="paneltitlenovedad">Mostrar Recorrido de la Convocatoria</span></h4>#}
{#                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">#}
{#                    </button>#}
{#                </div>#}
{#                <div class="modal-body panelbodynovedad">#}
{##}
{#                </div>#}
{#                <div class="modal-footer" id="footermodal">#}
{#                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal"> Cerrar</button>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{#    </div>#}

    <div class="modal fade static"  id="itemspanelsubirpresupuesto" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4><i class="fa fa-cloud-upload"></i>&nbsp;<span class="paneltitlesubirpresupuesto">Mostrar Recorrido de la Convocatoria</span></h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    </button>
                </div>
                <div class="modal-body panelbodysubirpresupuesto">

                </div>
                <div class="modal-footer" id="footermodal">
                    <button type="button" class="btn btn-success guardar"> Guardar</button>
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal"> Cerrar</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}