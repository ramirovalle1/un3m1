{% extends "login/base.html" %}
{% load sga_extras %}
{% load humanize %}
{% block heading %}
<header>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#1C3247 ">
    <link href="/static/sweet2/sweetalert2.css?1.0.4" rel="stylesheet"/>
    <script src="/static/sweet2/sweetalert2.js?1.0.0"></script>
    <script type='text/javascript' src="/static/js/jquery.min.js?4.0.0"></script>
    <script type='text/javascript' src="/static/js/jquery.blockUI.js?4.0.0"></script>
    <script type='text/javascript' src="/static/js/jquery.maskedinput.min.js?4.0.0"></script>
    <script type='text/javascript' src="/static/js/sysend.js?4.0.0"></script>
    <script type='text/javascript' src="/static/js/smoke.js?4.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>
    <script type='text/javascript' src="/static/js/bootstrap-datepicker.js?4.0.0"></script>
    <script type='text/javascript' src="/static/js/bootstrap-timepicker.js?4.0.0"></script>
    <script type='text/javascript' src="/static/js/bootstrap-modal.js?4.0.0"></script>
    <script type='text/javascript' src="/static/js/bootstrap-modalmanager.js?4.0.0"></script>
    <script type='text/javascript' src="/static/js/big.min.js?4.0.0"></script>
    <script type='text/javascript' src='/static/js/jquery.flexbox.js?4.0.0'></script>
    <script type='text/javascript' src='/static/js/dragdivscroll.js?4.0.0'></script>
    <script type='text/javascript' src='/static/js/jquery.dataTables.min.js?4.0.0'></script>
    <link href="/static/css/smoke.css?4.0.0" rel="stylesheet" type="text/css" media="screen"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="/static/css/bootstrap-responsive.css?5.0.0" rel="stylesheet"/>
    <link href='/static/css/font-awesome.css?4.0.0' rel='stylesheet'/>
    <link href='/static/css/font-awesome.min.css?4.0.0' rel='stylesheet'/>
    <link href="/static/css/stylesbs.css?5.1.17" rel='stylesheet'/>
    <link href="/static/css/datepicker.css?4.0.0" rel='stylesheet'/>
    <link href="/static/css/bootstrap-timepicker.css?4.0.0" rel='stylesheet'/>
    <!--<link href="/static/css/bootstrap-modal.css?4.0.2" rel='stylesheet'/>-->
    <link href="/static/css/jquery.flexbox.css?4.0.0" type="text/css" rel="stylesheet"/>
    <link href="/static/css/jquery.dataTables.css?4.0.2" type="text/css" rel="stylesheet"/>
    <script type="text/javascript" src="/static/js/select2.js?v=4.0.0"></script>
    <link type="text/css" rel="stylesheet" href="/static/css/select2.css?v=4.0.2">
    <script type="text/javascript" src="/static/js/snow.js?4.0.0"></script>
    <script src="/static/js/offline/v0.7.13/offline.min.js"></script>
    <link rel="stylesheet" href="/static/js/offline/v0.7.13/offline-theme-default.css"/>
    <link rel="stylesheet" href="/static/js/offline/v0.7.13/offline-language-spanish.css"/>


    <script type="text/javascript" src='/static/js/fontawesomev3.js?v=1.0.0'></script>
    <style>
        .form-text {
            color: red;
        }

        /*input {
            text-transform: uppercase;
        }*/

        .box_border {
            border: 1px solid rgba(157, 157, 157, 0.55);
            background-color: #fff;
            padding: 20px;
            background-clip: padding-box;
            border-radius: 10px;
        }

        .box_border:hover {
            box-shadow: rgba(100, 100, 111, 0.2) 0 7px 79px 0;
            cursor: pointer;
        }

        .shadow-data-container {
            overflow: hidden;
            padding: 5px;
            border-radius: 10px;
        }

        .white-shadow-img {
            border: 1px solid rgba(157, 157, 157, 0.55);
            display: block;
            margin: 0 auto;
            border-radius: 50%;
            box-shadow: 8px 3px 1px #ccc;
            -webkit-box-shadow: 6px 2px 7px #ccc;
            -moz-box-shadow: 8px 3px 1px #ccc;
        }

        .label {
            margin: 0.5px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: normal;
            display: inline-block;
            padding: 2px 4px;
            font-size: 10px;
            font-weight: bold;
            line-height: 14px;
            color: #fff;
            text-shadow: 0 -1px 0 rgb(0 0 0 / 25%);
            white-space: nowrap;
            vertical-align: baseline;
            background-color: #999;
        }

        .label-info, .badge-info {
            background-color: #3a87ad;
        }

        h4 {
            font-size: 16px;
            display: block;
            margin-block-start: 1.33em;
            margin-block-end: 1.33em;
            margin-inline-start: 0px;
            margin-inline-end: 0px;
            font-weight: bold;
            margin-top: 0;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }

        h4 small {
            font-size: 14px;
            font-weight: normal;
            line-height: 1;
            color: #999;
        }


    </style>

    <link href="/static/switchery/switchery.min.css" rel="stylesheet"/>
    <script src="/static/switchery/switchery.min.js"></script>
    <link rel="stylesheet" href="/static/css/jquery.fancybox.css?v=2.1.4" type="text/css" media="screen"/>
    <script type="text/javascript" src="/static/js/jquery.fancybox.pack.js?v=2.1.4"></script>

    <script type="text/javascript" src='/static/js/jquery.validationEngine.js?v=1.0.0'></script>
    <script type="text/javascript" src='/static/js/jquery.validationEngine-es.js?v=1.0.0'></script>
    <link type='text/css' rel='stylesheet' href="/static/css/validationEngine.jquery.css?v=1.0.0"/>

    <script type="text/javascript">

        var switchery = {};
        $.fn.initSwitchery = function () {
            //Init CheckBox Style
            var searchBy = ".js-switch";
            $(this).find(searchBy).each(function (i, html) {
                if (!$(html).next().hasClass("switchery")) {
                    //switchery[html.getAttribute('id')] = new Switchery(html, $(html).data()); size: small
                    switchery[html.getAttribute('id')] = new Switchery(html, {size: 'default', color: '#5DADE2'});
                }
            });
        };

        function bloqueointerface() {
            $.blockUI({
                message: '<span class="spinner-grow spinner-border-lg text-primary" role="status" aria-hidden="true" style="width: 10rem; height: 10rem;"></span>',
                css: {
                    backgroundColor: 'transparent',
                    border: '0',
                    zIndex: 9999999
                },
                overlayCSS: {
                    backgroundColor: '#fff',
                    opacity: 0.8,
                    zIndex: 9999990
                }
            });
        }

        function validarCedula() {

            var valor = $("#id_cedula").val().trim();
            $("#id_cedula").val(valor);
            if ($("#id_cedula").val().length == 10) {
                //Obtenemos el digito de la region que sonlos dos primeros digitos
                var digito_region = $("#id_cedula").val().substring(0, 2);

                //Pregunto si la region existe ecuador se divide en 24 regiones
                if (digito_region >= 1 && digito_region <= 24) {

                    // Extraigo el ultimo digito
                    var ultimo_digito = $("#id_cedula").val().substring(9, 10);

                    //Agrupo todos los pares y los sumo
                    var pares = parseInt($("#id_cedula").val().substring(1, 2)) + parseInt($("#id_cedula").val().substring(3, 4)) + parseInt($("#id_cedula").val().substring(5, 6)) + parseInt($("#id_cedula").val().substring(7, 8));

                    //Agrupo los impares, los multiplico por un factor de 2, si la resultante es > que 9 le restamos el 9 a la resultante
                    var numero1 = $("#id_cedula").val().substring(0, 1);
                    var numero1 = (numero1 * 2);
                    if (numero1 > 9) {
                        var numero1 = (numero1 - 9);
                    }

                    var numero3 = $("#id_cedula").val().substring(2, 3);
                    var numero3 = (numero3 * 2);
                    if (numero3 > 9) {
                        var numero3 = (numero3 - 9);
                    }

                    var numero5 = $("#id_cedula").val().substring(4, 5);
                    var numero5 = (numero5 * 2);
                    if (numero5 > 9) {
                        var numero5 = (numero5 - 9);
                    }

                    var numero7 = $("#id_cedula").val().substring(6, 7);
                    var numero7 = (numero7 * 2);
                    if (numero7 > 9) {
                        var numero7 = (numero7 - 9);
                    }

                    var numero9 = $("#id_cedula").val().substring(8, 9);
                    var numero9 = (numero9 * 2);
                    if (numero9 > 9) {
                        var numero9 = (numero9 - 9);
                    }

                    var impares = numero1 + numero3 + numero5 + numero7 + numero9;

                    //Suma total
                    var suma_total = (pares + impares);

                    //extraemos el primero digito
                    var primer_digito_suma = String(suma_total).substring(0, 1);

                    //Obtenemos la decena inmediata
                    var decena = (parseInt(primer_digito_suma) + 1) * 10;

                    //Obtenemos la resta de la decena inmediata - la suma_total esto nos da el digito validador
                    var digito_validador = decena - suma_total;

                    //Si el digito validador es = a 10 toma el valor de 0
                    if (digito_validador == 10)
                        var digito_validador = 0;

                    //Validamos que el digito validador sea igual al de la cedula
                    if (digito_validador == ultimo_digito) {
                        $('#id_validatecedula').attr('class', 'fa fa-check').css('color', 'green');
                        $('#cedulahelp').html('');
                        let cedula = $("#id_cedula").val() ? $("#id_cedula").val() : ''
                        if ($('#id_cedula').attr('validate') === 'false'){
                            $.get("{{ request.path }}", {'action': 'get_persona', 'c': cedula, 'tipo':1}, function (data) {
                                if (data.result) {
                                    $('#id_nombre1').val(data.data.nombre1).attr('disabled', 'disabled');
                                    $('#id_nombre2').val(data.data.nombre2).attr('disabled', 'disabled');
                                    $('#id_apellido1').val(data.data.apellido1).attr('disabled', 'disabled');
                                    $('#id_apellido2').val(data.data.apellido2).attr('disabled', 'disabled');
                                    $('#id_sexo').val(data.data.sexo).trigger('change').attr('disabled', 'disabled');
                                    $('#id_email').val(data.data.email).trigger('change').attr('disabled', 'disabled');

                                    $('#id_cedula').attr('validate', true);
                                }else {
                                    $('#id_cedula').attr('validate', false);
                                }
                            }, 'json');
                        }

                    } else {
                        $('#cedulahelp').html('La cedula es incorrecta');
                        $("#id_cedula").val('')
                        clearValues();
                        return false;
                    }

                } else {
                    // imprimimos en consola si la region no pertenece
                    $('#cedulahelp').html('Esta cedula no pertenece a ninguna region');
                    $("#id_cedula").val('')
                    clearValues();
                    return false;
                }
            } else {
                //imprimimos en consola si la cedula tiene mas o menos de 10 digitos
                $('#cedulahelp').html('Esta cedula tiene menos de 10 Digitos');
                clearValues();
                $("#id_cedula").val('')
                $('#id_validatecedula').removeClass('fa-spin');
                return false;
            }
        }

        function clearValues() {
            $('#id_nombre1').val('').attr('disabled', false);
            $('#id_nombre2').val('').attr('disabled', false);
            $('#id_apellido1').val('').attr('disabled', false);
            $('#id_apellido2').val('').attr('disabled', false);
            $('#id_email').val('').attr('disabled', false);
            $('#id_sexo').val('').trigger('change').attr('disabled', false);
            $('#id_razonsocial').val('').trigger('change').attr('disabled', false);
            $('#id_cedula').val('').attr('validate', false);
        }

        $(function () {

            clienteinfo = function (window) {
                {
                    var unknown = '-';

                    // screen
                    var screenSize = '';
                    if (screen.width) {
                        width = (screen.width) ? screen.width : '';
                        height = (screen.height) ? screen.height : '';
                        screenSize += '' + width + " x " + height;
                    }

                    // browser
                    var nVer = navigator.appVersion;
                    var nAgt = navigator.userAgent;
                    var browser = navigator.appName;
                    var version = '' + parseFloat(navigator.appVersion);
                    var majorVersion = parseInt(navigator.appVersion, 10);
                    var nameOffset, verOffset, ix;

                    // Opera
                    if ((verOffset = nAgt.indexOf('Opera')) != -1) {
                        browser = 'Opera';
                        version = nAgt.substring(verOffset + 6);
                        if ((verOffset = nAgt.indexOf('Version')) != -1) {
                            version = nAgt.substring(verOffset + 8);
                        }
                    }
                    // Opera Next
                    if ((verOffset = nAgt.indexOf('OPR')) != -1) {
                        browser = 'Opera';
                        version = nAgt.substring(verOffset + 4);
                    }
                    // MSIE
                    else if ((verOffset = nAgt.indexOf('MSIE')) != -1) {
                        browser = 'Microsoft Internet Explorer';
                        version = nAgt.substring(verOffset + 5);
                    }
                    // Chrome
                    else if ((verOffset = nAgt.indexOf('Chrome')) != -1) {
                        browser = 'Chrome';
                        version = nAgt.substring(verOffset + 7);
                    }
                    // Safari
                    else if ((verOffset = nAgt.indexOf('Safari')) != -1) {
                        browser = 'Safari';
                        version = nAgt.substring(verOffset + 7);
                        if ((verOffset = nAgt.indexOf('Version')) != -1) {
                            version = nAgt.substring(verOffset + 8);
                        }
                    }
                    // Firefox
                    else if ((verOffset = nAgt.indexOf('Firefox')) != -1) {
                        browser = 'Firefox';
                        version = nAgt.substring(verOffset + 8);
                    }
                    // MSIE 11+
                    else if (nAgt.indexOf('Trident/') != -1) {
                        browser = 'Microsoft Internet Explorer';
                        version = nAgt.substring(nAgt.indexOf('rv:') + 3);
                    }
                    // Other browsers
                    else if ((nameOffset = nAgt.lastIndexOf(' ') + 1) < (verOffset = nAgt.lastIndexOf('/'))) {
                        browser = nAgt.substring(nameOffset, verOffset);
                        version = nAgt.substring(verOffset + 1);
                        if (browser.toLowerCase() == browser.toUpperCase()) {
                            browser = navigator.appName;
                        }
                    }
                    // trim the version string
                    if ((ix = version.indexOf(';')) != -1) version = version.substring(0, ix);
                    if ((ix = version.indexOf(' ')) != -1) version = version.substring(0, ix);
                    if ((ix = version.indexOf(')')) != -1) version = version.substring(0, ix);

                    majorVersion = parseInt('' + version, 10);
                    if (isNaN(majorVersion)) {
                        version = '' + parseFloat(navigator.appVersion);
                        majorVersion = parseInt(navigator.appVersion, 10);
                    }

                    // mobile version
                    var mobile = /Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(nVer);

                    // cookie
                    var cookieEnabled = (navigator.cookieEnabled) ? true : false;

                    if (typeof navigator.cookieEnabled == 'undefined' && !cookieEnabled) {
                        document.cookie = 'testcookie';
                        cookieEnabled = (document.cookie.indexOf('testcookie') != -1) ? true : false;
                    }

                    // system
                    var os = unknown;
                    var clientStrings = [
                        {s: 'Windows 10', r: /(Windows 10.0|Windows NT 10.0)/},
                        {s: 'Windows 8.1', r: /(Windows 8.1|Windows NT 6.3)/},
                        {s: 'Windows 8', r: /(Windows 8|Windows NT 6.2)/},
                        {s: 'Windows 7', r: /(Windows 7|Windows NT 6.1)/},
                        {s: 'Windows Vista', r: /Windows NT 6.0/},
                        {s: 'Windows Server 2003', r: /Windows NT 5.2/},
                        {s: 'Windows XP', r: /(Windows NT 5.1|Windows XP)/},
                        {s: 'Windows 2000', r: /(Windows NT 5.0|Windows 2000)/},
                        {s: 'Windows ME', r: /(Win 9x 4.90|Windows ME)/},
                        {s: 'Windows 98', r: /(Windows 98|Win98)/},
                        {s: 'Windows 95', r: /(Windows 95|Win95|Windows_95)/},
                        {s: 'Windows NT 4.0', r: /(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},
                        {s: 'Windows CE', r: /Windows CE/},
                        {s: 'Windows 3.11', r: /Win16/},
                        {s: 'Android', r: /Android/},
                        {s: 'Open BSD', r: /OpenBSD/},
                        {s: 'Sun OS', r: /SunOS/},
                        {s: 'Linux', r: /(Linux|X11)/},
                        {s: 'iOS', r: /(iPhone|iPad|iPod)/},
                        {s: 'Mac OS X', r: /Mac OS X/},
                        {s: 'Mac OS', r: /(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},
                        {s: 'QNX', r: /QNX/},
                        {s: 'UNIX', r: /UNIX/},
                        {s: 'BeOS', r: /BeOS/},
                        {s: 'OS/2', r: /OS\/2/},
                        {s: 'Search Bot', r: /(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}
                    ];
                    for (var id in clientStrings) {
                        var cs = clientStrings[id];
                        if (cs.r.test(nAgt)) {
                            os = cs.s;
                            break;
                        }
                    }

                    var osVersion = unknown;

                    if (/Windows/.test(os)) {
                        osVersion = /Windows (.*)/.exec(os)[1];
                        os = 'Windows';
                    }

                    switch (os) {
                        case 'Mac OS X':
                            osVersion = /Mac OS X (10[\.\_\d]+)/.exec(nAgt)[1];
                            break;

                        case 'Android':
                            osVersion = /Android ([\.\_\d]+)/.exec(nAgt)[1];
                            break;

                        case 'iOS':
                            osVersion = /OS (\d+)_(\d+)_?(\d+)?/.exec(nVer);
                            osVersion = osVersion[1] + '.' + osVersion[2] + '.' + (osVersion[3] | 0);
                            break;
                    }

                    // flash (you'll need to include swfobject)
                    /* script src="//ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js" */
                    var flashVersion = 'no check';
                    if (typeof swfobject != 'undefined') {
                        var fv = swfobject.getFlashPlayerVersion();
                        if (fv.major > 0) {
                            flashVersion = fv.major + '.' + fv.minor + ' r' + fv.release;
                        } else {
                            flashVersion = unknown;
                        }
                    }
                }

                window.jscd = {
                    screen: screenSize,
                    browser: browser,
                    browserVersion: version,
                    browserMajorVersion: majorVersion,
                    mobile: mobile,
                    os: os,
                    osVersion: osVersion,
                    cookies: cookieEnabled,
                    flashVersion: flashVersion
                };
            };

            clienteinfo(window);

            var navegador = jscd.browser + ' ' + jscd.browserMajorVersion;
            var os = jscd.os + ' ' + jscd.osVersion;
            var cookies = jscd.cookies;
            var screensize = jscd.screen;

            $('input').click(function (e) {
               $(this).css('text-transform', 'upper');
            });

            $("body").initSwitchery();

            /*BANDERA PARA QUE NO HAGA RELOAD EN GET_PERSONA*/
            $('#id_cedula').attr('validate', false);

            $('#id_ruc').focusout(function () {
                let ruc = $(this).val();
                if (ruc) {
                    $.get("/{{ request.path }}", {'action': 'get_persona', 'ruc': ruc, 'tipo':2, 'c':''}, function (data) {
                        if (data.result) {
                            $('#id_razonsocial').val(data.data.nombres).attr('disabled', 'disabled');
                        }
                    }, 'json');
                }
            });

            $('.personanatural, .permaneceranonimo, .personajuridica, .fieldset_email').hide();

            $('.select2, #id_sexo').select2({
                placeholder: "---------",
                allowClear: true,
                width:'100%',
                /*theme: "classic"*/
            });

            $('#id_cedula').attr('disabled', true);

            $('#id_tipoidentificacion').on('select2:select', function (e) {
                $('#id_cedula').attr('disabled', false);
               if (e.params.data.id != 1){
                   clearValues();
                   $('#id_cedula').attr({'maxlength': 13, 'onkeypress':null});
                   $('#id_validatecedula').hide();
                   if (e.params.data.id == 2){
                       $('#cedulahelp').text('Nota: Para ingresar pasaporte digite VS al inicio de la numeración. Ejemplo: VSA0928').css({'color':'black', 'margin-bottom':'5px'});
                   }else{
                       $('#cedulahelp').text('Nota: Para ingresar RUC digite 001 al final de la cedula. Ejemplo: 06062746XX001').css({'color':'black', 'margin-bottom':'5px'});
                   }
               }else{
                   $('#id_cedula').attr({'maxlength': 10, 'onkeypress':'return soloNumeros(event)'});
                   $('#cedulahelp').text('');
                   $('#id_validatecedula').show();
               }
            });



            $('#id_tipodonante').on('select2:select', function (e) {
                $('.permaneceranonimo, .fieldset_email').show();
                clearValues();
                if (e.params.data.id == 1) {
                    $('.personajuridica').hide();
                    $('.personanatural').show();

                    $('#id_cedula, #id_nombre1, #id_apellido1, #id_sexo, #id_email').addClass("validate[required]");
                    $('#id_razonsocial, #id_ruc').removeClass("validate[required]");
                } else {
                    $('.personanatural').hide();
                    $('.personajuridica').show();
                    $('#id_razonsocial, #id_ruc').addClass("validate[required]");
                    $('#id_cedula, #id_nombre1, #id_apellido1, #id_sexo, #id_email').removeClass("validate[required]");
                }
            });

            $('#submit').click(function (e) {
                e.preventDefault();
                bloqueointerface();
                var valid = $(".form-validate").validationEngine('validate');
                if (valid) {
                    let formdata = new FormData($('#formdata')[0]);
                    debugger;
                    formdata.append('action', 'addcontribuidor');
                    $.ajax({
                    type: "POST",
                    url: "{{ request.path }}",
                    data: formdata,
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == 'ok') {
                            alerta('Datos guardados correctamente', 'success');
                            setTimeout(function () {
                                //location.reload();
                                location.href = '/publicaciondonacion?tab=2&externo=1'
                            }, 2000);
                        } else {
                            debugger;
                            if (data.form) {
                                data.form.forEach(function (val, indx) {
                                    var keys = Object.keys(val);
                                    keys.forEach(function (val1, indx1) {
                                        alerta(val[val1], 'warning');
                                    });
                                });
                            }
                            alerta('Error en el envío de datos.', 'warning');
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        alerta('Error de conexión', 'error');
                    },
                    dataType: "json",
                    cache: false,
                    contentType: false,
                    processData: false
                });
                } else {
                    $.unblockUI();
                    $('.form-text').each(function () {
                        var field = $(this);
                        if (field.attr('alert')) {
                            field.html(field.attr('alert'));
                        } else {
                            field.html('* Campo requerido');
                        }
                    }).css('color', 'red');
                    limpiarHelpText();
                }
            });

            $('#id_cedula').keyup(function (e) {
                if ($('#id_tipoidentificacion').val() == 1){
                    $('#id_validatecedula').attr('class', 'fa fa-circle-o-notch fa-spin').css('color','black');
                    setTimeout(function () {$('#id_validatecedula').removeClass('fa-spin')}, 1800);
                    if ($(this).val().length == 10) {
                        validarCedula();
                        $('#id_validatecedula').removeClass('fa-spin');
                    }
                }
            });

            $('#id_cedula').focusout(function () {
                if ($('#id_tipoidentificacion').val() == 1){
                    if ($(this).val().length < 10) {
                        $('#id_validatecedula').attr('class', 'fa fa-times').css('color', 'red');
                        $('#id_validatecedula').removeClass('fa-spin');
                        $('#cedulahelp').text('* La cedula debe tener 10 digitos.').css('color', 'red');
                        limpiarHelpText();
                        clearValues();
                    }
                }
            });
            
            $('#itemspanel #btnguardardonacion').click(function () {
                bloqueointerface();
                let formdata = new FormData($('#formtoaddcantidad')[0]);
                $.ajax({
                    type: "POST",
                    url: "{{ request.path|safe }}",
                    data: formdata,
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == 'ok') {
                            alerta('Datos guardados correctamente', 'success');
                            /*setTimeout(function () {
                                location.reload();
                            }, 4000);*/
                        } else {
                            debugger;
                            if (data.form) {
                                data.form.forEach(function (val, indx) {
                                    var keys = Object.keys(val);
                                    keys.forEach(function (val1, indx1) {
                                        $("#id_" + val1).addClass("is-invalid");
                                        $("#errorMessage" + val1).html(val[val1]);
                                    });
                                });
                            }
                            if (data.mensaje){
                                alerta(data.mensaje, 'warning');
                            }
                            alerta('Error en el envío de datos.', 'warning');
                        }

                        $('#closeandopenmodal1').click();
                    },
                    error: function(xhr, textStatus, error){
                        $.unblockUI();
                        alerta('Error de conexión', 'error');
                        console.log(xhr.statusText);
                        console.log(textStatus);
                        console.log(error);
                    },

                    dataType: "json",
                    cache: false,
                    contentType: false,
                    processData: false
                });
            });

            $('#dataTable').DataTable({
                columnDefs: [
                    {
                        target: 2,
                        visible: false,
                        searchable: false,
                    },
                    {
                        target: 3,
                        visible: false,
                    },
                ],
            });

            $('#dataTable_info').hide();

        });

        function soloNumeros(e) {
            var key = window.Event ? e.which : e.keyCode
            return (key >= 48 && key <= 57)
        }

        function limpiarHelpText() {
            setTimeout(function () {
                $('.form-text').each(function () {
                    var field = $(this);
                    field.text('');
                    if (parseInt($('#id_tipoidentificacion').val()) == 2){
                        $('#cedulahelp').text('Nota: Para ingresar pasaporte digite VS al inicio de la numeración. Ejemplo: VSA0928').css({'color':'black', 'margin-bottom':'5px'});
                    }else{
                       $('#cedulahelp').text('');
                    }
                });
            }, 8000);

        }

        function alerta(mensaje, tipo = 'success') {
            Swal.fire({
                toast: true,
                position: 'top-end',
                type: tipo,
                title: mensaje,
                showConfirmButton: false,
                timer: 8000
            })
        }

        function formModal(id, text, action, width = '85%') {
            bloqueointerface();
            $.ajax({
                type: "GET",
                url: `/publicaciondonacion`,
                data: {
                    'action': action,
                    'id': id,
                },
                success: function (data) {
                    //$.unblockUI();
                    if (data.result === true) {
                        $('.panelbody').html(data.data);
                        $('#itemspanel .modal-title').html(text);
                        $("#itemspanel").modal({
                            backdrop: 'static',
                            width: width,
                            maxWidth: width,
                            keyboard: false
                        }).modal('show').on('hidden.bs.modal', function (e) {
                            $(".panelbody").empty();
                        });


                        return true;
                    } else {
                        alerta(data.mensaje, 'warning');
                        return false;
                    }
                },
                error: function(xhr, textStatus, error){
                    $.unblockUI();
                    alerta('Error de conexión', 'error');
                    console.log(xhr.statusText);
                    console.log(textStatus);
                    console.log(error);
                    console.warn(xhr.responseText);
                },
                dataType: "json",
            });
        }

    </script>


</header>
{% endblock %}
{% block pagetitle %}Registro de Donante{% endblock %}
{% block canvas %}
<div class="row-fluid">
        <div class="modal fade" id="itemspanel" aria-hidden="true" aria-labelledby="exampleModalToggleLabel" tabindex="-1">
            <div class="modal-dialog modal-fullscreen-sm-down modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalToggleLabel"><i class="fa fa-solid fa-hand-holding-heart"></i> Donar</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body panelbody">

                    </div>
                    <!--<div class="modal-footer">
                        <button class="btn btn-primary" data-bs-target="#exampleModalToggle2" data-bs-toggle="modal" data-bs-dismiss="modal">Open second modal
                        </button>
                    </div>-->
                </div>
            </div>
        </div>
        <div class="modal fade" id="exampleModalToggle2" aria-hidden="true" aria-labelledby="exampleModalToggleLabel2"
             tabindex="-1">
            <div class="modal-dialog modal-fullscreen-sm-down modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalToggleLabel2"><h4 class="titulo-modal2"></h4></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!--modal 2-->
                        <form id="formtoaddcantidad" class="form-validate" enctype="multipart/form-data">
                            <div class="row-fluid">
                                <div class="col-6">
                                    {% csrf_token %}
                                    <label for="id_cantidad" class="form-label">Cantidad:</label>
                                    <div class="input-group mb-2" id="cantidad">
{#                                        <input class="form-control" type="text" placeholder="1" id="id_cantidad" name="cantidad" onKeyPress="return soloNumeros(event)">#}
                                        <div id="cantidadhelp" class="form-text"></div>
                                    </div>
                                    <input type="hidden" name="action" value="adddonacion">
{#                                    <input type="hidden" name="iddonacion" value="">#}
                                </div>
                            </div>
                        </form>
                        <div class="row-fluid" style="text-align: center;">
                            <a class="btn btn-danger btn-sm" data-bs-toggle="modal" href="#itemspanel" role="button"> Cancelar</a>
                            <a id="btnguardardonacion2" class="btn btn-primary btn-sm"> Guardar</a>
                        </div>
                        <button style="display: none" id="closeandopenmodal1" class="btn btn-primary btn-sm" data-bs-target="#itemspanel" data-bs-toggle="modal" data-bs-dismiss="modal">Open first modal</button>
                    </div>
                </div>
            </div>
        </div>
        <a style="display: none" id="openmodal1" class="btn btn-primary" data-bs-toggle="modal" href="#itemspanel" role="button">Open first modal</a>
</div>
<div class="container">
    {% if not perfildonante %}
    <div class="tab-pane fade show active" id="home-tab-pane" role="tabpanel" aria-labelledby="home-tab"
         tabindex="0">
        <div class="row-fluid">
            <div class="container">
                <div class="row-fluid"><br>
                    <div class="card mx-5">
                        <div class="card-header">Perfil donante</div>
                        <div class="card-body mx-5">
                            <!--adddonacion-->
                            <form method="POST" id="formdata" class="form-validate form-floating">
                                {% csrf_token %}
                                <div class="row">
                                    <label for="id_tipodonante" class="form-label">Tipo de donante:</label>
                                    <div class="input-group mb-2" id="tipodonante">
                                        <select id="id_tipodonante" name="tipodonante" class="form-select select2"
                                                aria-label="Default select example">
                                            <option value="0" selected>-----</option>
                                            <option value="1">Persona natural</option>
                                            <option value="2">Persona jurídica</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row permaneceranonimo">
                                    <label for="id_tipodonante" class="form-label">¿Permanecer anónimo?</label>
                                    <div class="mb-2" id="anonimo">
                                        {{ form.esanonimo }}
                                    </div>
                                </div>
                                <section class="personanatural">
                                    <div class="row">
                                        <label for="id_tipoidentificacion" class="form-label">Tipo de identificación:</label>
                                        <div class="input-group mb-2" id="tipodonante">
                                            <select id="id_tipoidentificacion" name="tipoidentificacion" class="form-select select2"
                                                    aria-label="Default select example">
                                                <option value="0" selected>-----</option>
                                                <option value="1">Cédula</option>
                                                <option value="3">RUC</option>
                                                <option value="2">Pasaporte</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <label for="id_validcedula" class="form-label">Cedula, RUC o pasaporte</label>
                                        <div class="input-group mb-2" id="cedula">
                                            <span class="input-group-text" id="id_validcedula"><i
                                                    style="font-size: 14px;color:black;" id="id_validatecedula"
                                                    class="fa fa-circle-o-notch"></i></span>
                                            {{ form.cedula }}
                                        </div>
                                        <div id="cedulahelp" class="form-text"></div>
                                    </div>
                                    <div class="row">
                                        <label for="id_sexo" class="form-label">Género:</label>
                                        <div class="input-group mb-2" id="sexo">
                                            {{ form.sexo }}
                                            <div id="sexohelp" class="form-text"></div>
                                        </div>
                                    </div>
                                    <div class="row mb-2">
                                        <label for="id_nombre1" class="form-label">Nombres:</label>
                                        <div class="col-6">
                                            <div class="mb-2">
                                                {{ form.nombre1 }}
                                                <div id="nombre1help" class="form-text"></div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mb-2">
                                                {{ form.nombre2 }}
                                                <div id="nombre2help" class="form-text"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mb-2">
                                        <label for="id_apellido1" class="form-label">Apellidos:</label>
                                        <div class="col-6">
                                            <div class="mb-2">
                                                {{ form.apellido1 }}
                                                <div id="apellido1help" class="form-text"></div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mb-2">
                                                {{ form.apellido2 }}
                                                <div id="apellido2help" class="form-text"></div>
                                            </div>
                                        </div>
                                    </div>
                                </section>
                                <section class="personajuridica">
                                    <div class="row">
                                        <label for="id_cedula" class="form-label">RUC</label>
                                        <div class="input-group mb-2" id="ruc">
                                            {{ form.ruc }}
                                            <div id="ruchelp" class="form-text"></div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="mb-2">
                                            <label for="id_razonsocial" class="form-label">Razón social</label>
                                            <div class="input-group mb-2" id="ruc">
                                                {{ form.razonsocial }}
                                                <div id="razonsocialhelp" class="form-text"></div>
                                            </div>
                                        </div>
                                    </div>
                                </section>
                                <div class="row fieldset_email">
                                    <div class="mb-2">
                                        <label for="id_email" class="form-label">Email</label>
                                        <div class="input-group mb-2" id="email">
                                            {{ form.email }}
                                        </div>
                                        <p id="emailhelp" class="form-text"></p>
                                    </div>
                                </div>
                                <div class="row">
                                        <div class="mb-2">
                                            <div class="input-group mb-2" id="ruc">
                                                <button type="submit" class="btn btn-primary btn-sm" id="submit">Guardar</button>
                                            </div>
                                        </div>
                                    </div>

                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
        <div class="row-fluid">
            <div class="alert alert-info" role="alert">
              ¡Gracias por su inscripción! Ya puede empezar a registrar sus donaciónes.
            </div>
            <a href="https://sga.unemi.edu.ec/logout" class="btn btn-warning btn-large" style="color:#fff;width: 120.9px;"><i class="fa fa-arrow-circle-left"></i> <b>Volver</b></a>
            <a href="https://sga.unemi.edu.ec/publicaciondonacion?tab=2&externo=1" class="btn btn-primary btn-large"><i class="fa fa-send"></i> <b>Continuar</b></a>
        </div>
    {% endif %}
</div>
{% endblock %}