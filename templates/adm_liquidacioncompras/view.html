{% extends "basebs.html" %}
{% load humanize %}
{% load sga_extras %}
{% block heading %}
    <script type="text/javascript" src='/static/js/select2.js?v=1.0.0'></script>
    <link type='text/css' rel='stylesheet' href="/static/css/select2.css?v=1.0.0"/>
    <script src="/static/js/moment/moment.min.js" type="text/javascript"></script>
    <script src="/static/js/moment/moment-with-locales.min.js" type="text/javascript"></script>
    <script src="/static/js/moment/moment-timezone.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="/static/bootstrap4/plugins/daterangepicker/daterangepicker.css">
    <script src="/static/bootstrap4/plugins/daterangepicker/daterangepicker.js"></script>
    <script type="text/javascript">
        function consultar(pk, accion, nombre, ruta, ocultarcerrar = false, valor = 0, campo = 'default') {
            $.ajax({
                type: "GET",
                url: `/${ruta}`,
                data: {'action': accion, 'id': pk, 'adicionalvalor': valor, 'adicionalcampo': campo},
                success: function (data) {
                    if (data.result === true) {
                        if (ocultarcerrar === true) {
                            $('#footerModalView').hide();
                        }
                        $('.tablaaqui').html(data.data)
                        $('#frmConsulta #nombre').html(nombre);
                        $('#modalConsulta').modal({"backdrop": "static", "width": "1000px"}).modal("show");
                    } else {
                        smoke.alert(data.mensaje);
                    }
                },
                error: function () {
                    smoke.alert("Error de conexión.");
                },
                dataType: "json"
            });
        }

        $(function () {
            $("#itemspanel_cerrar_2").click(function () {
                $("#itemspanel2").modal('hide');
            });

            $("#itemspanel_adicionar_2").click(function () {
                var fechainicio = $("#id_fechainicio").val();
                var fechafin = $("#id_fechafinal").val();
                console.log(fechainicio)
                console.log(fechafin)
                $("#itemspanel2").modal('hide');
                if (fechainicio !== '' && fechafin !== '') {
                    location.href = `/rec_facturas?action=reporte_anual_pagos&fechainicio=${fechainicio}&fechafin=${fechafin}`;

                } else {
                    smoke.alert('DEBE SELECCIONAR UN RANGO DE FECHAS')
                }
            });

            $(".reporteanual").click(function () {
                $("#itemspanel2").modal({backdrop: 'static'}).modal('show');
            });


            $("#fechainicio, #fechafin").datepicker({format: "dd-mm-yyyy"}).on('changeDate', function (ev) {
                $(this).datepicker('hide');
            });

            $("#fechainicio_anuladas, #fechafin_anuladas").datepicker({format: "dd-mm-yyyy"}).on('changeDate', function (ev) {
                $(this).datepicker('hide');
            });

            $("#search").click(function () {
                var term = $("#searchinput").val().trim().toUpperCase();
                var fecha_desde = $("#id_fecha_desde").val().trim().toUpperCase();
                var fecha_hasta = $("#id_fecha_hasta").val().trim().toUpperCase();
                var estado = $("#id_searchestado").val().trim().toUpperCase();
                bloqueointerface();
                location.href = `{{ request.path }}?s=${term}&fecha_desde=${fecha_desde}&fecha_hasta=${fecha_hasta}&est=${estado}`;
            });
            $('.selectorfecha').datepicker({format:"dd-mm-yyyy"});
            $('#searchinput').keyup(function (e) {
                if (e.keyCode == 13) {
                    $("#search").trigger("click");
                }
            });

            $(".reimprimir").click(function () {
                var id;
                bloqueointerface();
                id = $(this).attr("idfactura");
                $.post("/rec_facturas", {'id': id, 'action': 'reprint'}, function (data) {
                    if (data.result == "ok") {
                        location.href = location.href;
                    } else {
                        $.unblockUI();
                        smoke.alert(data.mensaje);
                    }
                }, "json");
                return false;
            });

            $(".reimprimirnuevomodelo").click(function () {
                var id;
                bloqueointerface();
                id = $(this).attr("idfactura");
                $.post("/print/factura/" + id, function (data) {
                    if (data.result == "ok") {
                        location.href = location.href;
                    } else {
                        $.unblockUI();
                        smoke.alert(data.mensaje);
                    }
                }, "json");
                return false;
            });

            $("#modal-detalle .btn-aceptar").click(function () {
                $("#modal-detalle").modal("hide");
                return false;
            });

            $("#modal-detalle-pagos .btn-aceptar").click(function () {
                $("#modal-detalle-pagos").modal("hide");
                return false;
            });

            $(".detalle").click(function () {
                var id = $(this).attr("idliquidacion");
                bloqueointerface();
                $.ajax({
                    type: "GET",
                    url: "/adm_liquidacion_compras",
                    data: {'action': 'detalleliquidacion', 'id': id},
                    success: function (data) {
                        $.unblockUI();
                        if (data.result === 'ok') {
                            $("#detalle").html(data.html);
                            $("#modal-detalle").modal({"backdrop": "static", "width": "1000px"}).modal("show");
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error de conexión.");
                    },
                    dataType: "json"
                });
            });

            $(".rubros").click(function () {
                var id = $(this).attr("idfactura");
                bloqueointerface();
                $.ajax({
                    type: "GET",
                    url: "/rec_facturas",
                    data: {'action': 'rubros', 'id': id},
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == 'ok') {
                            $("#detallepagos").html(data.html);
                            $("#modal-detalle-pagos").modal({"backdrop": "static", "width": "1000px"}).modal("show");
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error de conexión.");
                    },
                    dataType: "json"
                });
            });

            $("#exportar").click(function () {
                $("#ficherofacturamodal").modal({'width': '400px'}).modal('show');
                $("#panelfichero").hide();
            });

            $("#ficherofacturamodal .btn-cerrar").click(function () {
                $("#ficherofacturamodal").modal('hide');
            });

            $("#ficheromodal .btn-cerrar").click(function () {
                $("#ficheromodal").modal('hide');
            });

            $("#ficherofacturamodal .btn-generar").click(function () {
                var fechai = $("#fechainicio").val();
                var fechaf = $("#fechafin").val();
                bloqueointerface();
                $("#ficherofacturamodal").modal("hide");
                $.ajax({
                    type: "POST",
                    url: "/rec_facturas",
                    data: {'action': 'generar_xml', 'fechai': fechai, 'fechaf': fechaf},
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == 'ok') {
                            $("#enlacefichero").attr({'href': data.archivo});
                            $("#enlaceficheronombre").html('Archivo: ' + data.archivo);
                            $("#ficheromodal").modal({'width': '200'}).modal("show");
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error de conexión.");
                    },
                    dataType: "json"
                });
            });

            $("#enlacefichero").click(function () {
                $("#ficherofacturamodal").modal('hide');
            });


            $("#filtroanulada").change(function () {
                var id = $(this).val();
                if (id > 0) {
                    location.href = '/rec_facturas?a=' + id;
                } else {
                    location.href = '/rec_facturas';
                }
            });

            $(".detalleasiento").click(function () {
                var ida = $(this).attr("ida");
                $.get("/rec_facturas", {'action': 'detalle_asiento', 'ida': ida}, function (data) {
                    $(".panelbody").html(data);
                    $(".paneltitle").html('VISTA PREVIA DE ASIENTO DE DIARIO');
                    $("#itemspanel").modal({backdrop: 'static', width: 900, height: 400}).modal('show');
                }, "html");
                return false;
            });

            $("#cerrarpanel").click(function () {
                $("#itemspanel").modal("hide");
            });


            $(" .btn-aceptar").click(function () {
                $("#modal-detalle-nota").modal("hide");
                return false;
            });

            $(".detallenc").click(function () {
                var id = $(this).attr("idfactura");
                bloqueointerface();
                bloqueointerface();
                $.ajax({
                    type: "GET",
                    url: "/rec_facturas",
                    data: {'action': 'detalle_nota', 'id': id},
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == 'ok') {
                            $("#detalle-nota").html(data.html);
                            $("#modal-detalle-nota").modal({
                                backdrop: 'static',
                                width: 1000,
                                height: 600
                            }).modal('show');
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error de conexión.");
                    },
                    dataType: "json"
                });
            });


            $("#exportar_anuladas").click(function () {
                $("#ficherofacturamodal_anuladas").modal({'width': '400px'}).modal('show');
            });

            $("#ficherofacturamodal_anuladas .btn-cerrar").click(function () {
                $("#ficherofacturamodal_anuladas").modal('hide');
            });

            $("#ficherofacturamodal_anuladas .btn-generar").click(function () {
                var fechai = $("#fechainicio_anuladas").val();
                var fechaf = $("#fechafin_anuladas").val();
                $("#ficherofacturamodal_anuladas").modal("hide");
                openwindow('POST', '/rec_facturas', {
                    'action': 'generar_pdf',
                    'fechai': fechai,
                    'fechaf': fechaf
                }, '_blank');
            });

            $("#enlacefichero").click(function () {
                $("#ficherofacturamodal").modal('hide');
            });
            $('#searchdate').daterangepicker({
                showDropdowns: true,
                autoUpdateInput: false,
                minYear: 2000,
                //maxYear: parseInt(moment().subtract(18, 'year').format('YYYY'),10),
                locale: {
                    'format': 'DD-MM-YYYY'
                },
                opens: 'left',
                //singleDatePicker: true,
            }, function (start, end, label) {
                $('#searchdate').val(`${start.format('DD-MM-YYYY')} - ${end.format('DD-MM-YYYY')}`);
            });
            $('#id_rango_fecha').daterangepicker({
                showDropdowns: true,
                autoUpdateInput: false,
                width:'100%',
                parentEl: '#modal_reporte_liquidacion_compra',
                /*minYear: 2000,
                maxYear: parseInt(moment().subtract(18, 'year').format('YYYY'),10),*/
                locale: {
                    'format': 'DD-MM-YYYY'
                },
                opens: 'left',
                //singleDatePicker: true,
            }, function (start, end, label) {
                $('#id_rango_fecha').val(`${start.format('DD-MM-YYYY')} - ${end.format('DD-MM-YYYY')}`);
            });
            $('#id_cuentacontable').select2({minimumResultsForSearch: 20, width: '100%', dropdownParent: $('#modal_reporte_liquidacion_compra') })
            $(".reporte_liquidacion_compra").click(function () {
                $('form',$("#modal_reporte_liquidacion_compra"))[0].reset();
                $("#modal_reporte_liquidacion_compra").modal({backdrop:'static', width: '480px'}).modal('show');
            });

            $("#modal_reporte_liquidacion_compra_ejecutar").click(function () {
                if($('#id_tipoarchivo').val()){
                    $("#modal_reporte_liquidacion_compra").modal('hide');
                    let form = $("#modal_reporte_liquidacion_compra").find('form');
                    let url = `{{ request.path }}?`;
                    for (const obj of form.serializeArray()){
                        console.log( obj)
                        url += `&${obj.name}=${obj.value}`;
                    }
                    console.log(form.serializeArray());
                    window.open(url, '_blank');
                }else{
                     smoke.alert("Debe seleccionar el tipo de archivo a generar.");
                }
            });

            $("#moodal_reporte_close").click(function () {
                $("#modal_reporte_liquidacion_compra").modal('hide');
            });

        });

        function anular_liquidacion_compra(id, texto) {
            Swal.fire({
                title: `NOTIFICACIÓN`,
                html: `¿Estas seguro de anular la liquidación compra <span class="badge badge-warning">${texto}</span>?`,
                //info',
                icon: 'info',
                showCancelButton: true,
                allowOutsideClick: false,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Si',
                cancelButtonText: 'No'
            }).then((result) => {
                if (result.value) {
                    $.post("{{ request.path }}", {
                        action: 'anular_liquidacion_compra',
                        id: id,
                    }, function (data) {
                        if (data.result == 'ok') {
                            $.unblockUI();
                            location.reload();
                        } else {
                            mensajeWarning(data.message)
                        }
                    }, "json")
                }
            }).catch(error => {
                NotificationJG.error(error);
                $.unblockUI();
            });
        }
        function enviar_liquidacion_compra(id, texto) {
            Swal.fire({
                title: `NOTIFICACIÓN`,
                html: `¿Estas seguro de enviar liquidación compra <span class="badge badge-info">${texto}</span>?`,
                type: 'info',
                icon: 'info',
                showCancelButton: true,
                allowOutsideClick: false,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Si',
                cancelButtonText: 'No'
            }).then((result) => {
                if (result.value) {
                    $.post("{{ request.path }}", {
                        action: 'enviarcliente',
                        id: id,
                    }, function (data) {
                        if (data.result == 'ok') {
                            $.unblockUI();
                            location.href = '{{ request.path }}';
                        } else {
                            mensajeWarning(data.mensaje);
                        }
                    }, "json")
                }
            }).catch(error => {
                NotificationJG.error('Error en conexión con el servidor');
                $.unblockUI();
            });
        }


    </script>
{% endblock %}
{% block atras %}/{% endblock %}
{% block canvas %}
    <div class='row-fluid'>
        <div class='span12'>
            <h4>{{ title }}</h4>
        </div>
    </div>
    {{ list_d|join:', ' }}
{#    {% if dias <= 0 %}#}
{#        <div class="alert alert-danger" id="incompleto">#}
{#            <i class="fa fa-info-sign"></i> El certificado de {{ NOMBRE_CERTIFICADO }} caducó#}
{#            el {{ FECHA_CADUCIDAD_CERTIFICADO|date:'d-m-Y' }}, por favor realizar la renovación#}
{#        </div>#}
{#    {% else %}#}
{#        <div class="alert alert-info" id="incompleto">#}
{#            <i class="fa fa-info-sign"></i> El certificado de {{ NOMBRE_CERTIFICADO }} caduca#}
{#            el {{ FECHA_CADUCIDAD_CERTIFICADO|date:'d-m-Y' }} quedan {{ dias }} días para caducar#}
{#        </div>#}
{#    {% endif %}#}

    {#    <div class='row-fluid'>#}
    {#        <div class="span12">#}
    {#            <a href="javascript:;" class="btn btn-success tu reporteanual">#}
    {#                <i class='fa fa-print'></i> Generar Excel</a>#}
    {#        </div>#}
    {#    </div>#}
    <div class='row-fluid'>
        <div class="span4">
            <a href="adm_liquidacion_compras?action=addliquidacioncompra" class='btn btn-success'><i class="fa fa-plus "></i> Adicionar Liquidacion</a>
            <a href="adm_liquidacion_compras?action=listaservicios" class='btn btn-warning'><i class="fa fa-amazon "></i> Servicios</a>
            <a href="javascript:;" class='btn btn-info reporte_liquidacion_compra'><i class="fa fa-file"></i> Reporte</a>
        </div>
        <div class="span8">
            <form class='form-search'>
                <div class="row-fluid">
                    <div class="span2">
                        <input class="selectorfecha" formwidth="50%" id="id_fecha_desde" placeholder="Fecha desde"  style="width:100%" type="text" value="{{ fecha_desde }}">
                    </div>
                    <div class="span2">
                        <input class="selectorfecha" formwidth="50%" id="id_fecha_hasta" placeholder="Fecha hasta"  style="width:100%" type="text" value="{{ fecha_hasta }}">
                    </div>
                    <div class="span2">
                        <select name="est" id="id_searchestado" class="form-control">
                            <option value="">TODOS</option>
                            {% for estado in estados %}
                                <option value="{{ estado.0 }}" {% if estado.0 == est%}selected{% endif %}>{{ estado.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="span6" style="text-align: right">
                        <input class='searchinput' type='text' id='searchinput' value='{{ search }}' autocomplete="off"/>
                        <a href="javascript:;" id='search' class='btn btn-info tu' title="Buscar"><i class="fa fa-search "></i></a>
                        {% if search or ids or fecha_desde or fechas_hasta or est %}
                            <a href="{{ request.path }}" id='allresults' class='btn btn-success tu' title="Todos"><i class="fa fa-refresh "></i></a>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class='row-fluid'>
        <div class='span12'>
            <table class='table table-striped table-bordered'>
                <thead>
                <tr>
                    <th style="width: 120px;">No.</th>
                    <th style="width: 80px; text-align: center;">Fecha / Hora</th>
                    <th>Proveedor</th>
                    <th style="width: 70px;">Identificacion</th>
                    <th style="width: 70px; text-align: center;">Subtotal 0</th>
                    <th style="width: 70px; text-align: center;">Subtotal IVA</th>
                    <th style="width: 70px; text-align: center;">IVA</th>
                    <th style="width: 70px; text-align: center;">Descuento</th>
                    <th style="width: 70px; text-align: center;">Total</th>
                    <th style="width: 25px; text-align: center">Gen.</th>
                    <th style="width: 25px; text-align: center">XML.</th>
                    <th style="width: 25px; text-align: center">Fir.</th>
                    <th style="width: 25px; text-align: center">SRI.</th>
                    <th style="width: 25px; text-align: center">Aut.</th>
                    <th style="width: 25px; text-align: center">Env.</th>
                    <th style="width: 60px; text-align: center">Info.</th>
                    <th style="width: 120px; text-align: center">Estado</th>
                    <th style="width: 90px;"></th>
                </tr>
                </thead>
                <tbody>
                {% for liquidacion in listado %}
                    <tr>
                        <td>{{ liquidacion.numerocompleto }}</td>
                        <td style="text-align: center;">{{ liquidacion.fecha|date:'d-m-Y' }}
                            <br>{{ liquidacion.fecha_creacion|date:'H:i:s' }}</td>
                        <td>{{ liquidacion.proveedor.nombre }}</td>
                        <td>{{ liquidacion.proveedor.identificacion }}</td>
                        <td style="text-align: right;">$ {{ liquidacion.subtotal_base0|floatformat:2|intcomma }}</td>
                        <td style="text-align: right;">$ {{ liquidacion.subtotal_base_iva|floatformat:2|intcomma }}</td>
                        <td style="text-align: right;">$ {{ liquidacion.total_iva|floatformat:2|intcomma }}</td>
                        <td style="text-align: right;">$ {{ liquidacion.total_descuento|floatformat:2|intcomma }}</td>
                        <td style="text-align: right;">$ {{ liquidacion.total|floatformat:2|intcomma }}</td>
                        <td style="text-align: center">
                            {% if liquidacion.pagada %}
                                <i class="fa fa-check tu" title="Generada" style="color: #55ea55"></i>
                            {% endif %}
                        </td>
                        <td style="text-align: center">
                            {% if liquidacion.xmlgenerado %}
                                <i class="fa fa-check tu" title="XML Generado" style="color: #55ea55"></i>
                                {% else %}
                                <i class="fa fa-times tu" style="color: red"></i>
                            {% endif %}
                        </td>

                        <td style="text-align: center">
                            {% if liquidacion.firmada %}
                                <i class="fa fa-check tu" title="Firmada" style="color: #55ea55"></i>
                                {% else %}
                                <i class="fa fa-times tu" style="color: red"></i>
                            {% endif %}
                        </td>
                        <td style="text-align: center">
                            {% if liquidacion.enviadasri  %}
                                {% if liquidacion.falloenviodasri %}
                                    <i class="fa fa-times tu" title="Error de envio" style="color: red"></i>
                                {% else %}
                                    <i class="fa fa-check tu" title="Enviada al SRI" style="color: #55ea55"></i>
                                {% endif %}
                                {% else %}
                                <i class="fa fa-times tu" style="color: red"></i>
                            {% endif %}

                        </td>
                        <td style="text-align: center">
                            {% if liquidacion.autorizada %}
                                {% if liquidacion.falloautorizacionsri %}
                                    <i class="fa fa-remove tu" title="Error de autorización" style="color: red"></i>
                                {% else %}
                                    <i class="fa fa-check tu" title="Autorizada" style="color: #55ea55"></i>
                                {% endif %}
                                {% else %}
                                <i class="fa fa-times tu" style="color: red"></i>
                            {% endif %}
                        </td>
                        <td style="text-align: center">
                            {% if liquidacion.enviadacliente %}
                                <i class="fa fa-check tu" title="Enviada" style="color: #55ea55"></i>
                            {% else %}
                                <i class="fa fa-times tu" style="color: red"></i>
                            {% endif %}
                        </td>
                        <td style="text-align: center">
                            <a class="btn btn-success btn-mini tu"
                               onclick="consultar('{{ liquidacion.pk|encrypt }}', 'detalleliquidacion', 'DETALLE LIQUIDACION EN COMPRA {{ liquidacion.tipodocumento }} - {{ liquidacion.numerodocumento }}', 'adm_liquidacion_compras')"
                               title="Detalles Liquidación" href='javascript:;'
                               idr="{{ liquidacion.id }}" idliq="{{ liquidacion.pk }}"> <i class='fa fa-list'></i> </a>
                        </td>
                        <td style="text-align: center">
                            <span class="badge badge-{% if liquidacion.estado == 1%}warning{% elif liquidacion.estado == 2%}success{% else %}important{% endif %}">{{ liquidacion.get_estado_display }}</span>
                        </td>
                        <td style="text-align: center">
                            <div class="btn-group">
                                <a class="btn btn-mini dropdown-toggle" data-toggle="dropdown" href="javascript:;">Acciones<span
                                        class="caret"></span></a>
                                <ul class="dropdown-menu pull-right list-group">
                                    <li><a class="reportedirecto" href="javascript:;"
                                           tipos="{{ reporte_1.tiporeporte }}"
                                           nhref="/reportes?action=run&n={{ reporte_1.nombre }}&id={{ liquidacion.id }}"> <i
                                            class='fa fa-print'></i> Formato Liquidación</a></li>
                                {% if liquidacion.estado != 3 %}
                                    {% if not liquidacion.xmlgenerado %}
                                        <li><a class="btn-form"
                                               href="/adm_liquidacion_compras?action=generarxmlliqu&id={{ liquidacion.id }}"><i
                                                class="fa fa-file"></i> Generar XML (Liquidación)</a></li>

                                    {% endif %}
                                    {% if not liquidacion.firmada %}
                                        <li><a class="btn-form"
                                               href="/adm_liquidacion_compras?action=firmarliqu&id={{ liquidacion.id }}"><i
                                                class="fa fa-key"></i> Firmar XML (Liquidación)</a></li>
                                    {% endif %}

                                     {% if not liquidacion.enviadasri %}
                                        <li><a class="btn-form"
                                               href="/adm_liquidacion_compras?action=enviosriliqu&id={{ liquidacion.id }}"><i
                                                class="fa fa-envelope"></i> Enviar al SRI (Liquidación)</a></li>
                                    {% endif %}

                                    {% if not liquidacion.autorizada %}
                                        <li><a class="btn-form"
                                               href="/adm_liquidacion_compras?action=autorizarliqu&id={{ liquidacion.id }}"><i
                                                class="fa fa-flag"></i> Autorizar (Liquidación)</a></li>
                                    {% endif %}
                                    <li>
                                        <a href="javascript:;" onclick="anular_liquidacion_compra({{ liquidacion.id }}, '{{ liquidacion }}')">
                                           <i class="fa fa-stamp"></i> Anular Liquidación</a>
                                    </li>
                                {% endif %}

{#                                    <hr>#}
{% comment %}                                {% if liquidacion.xmlgenerado and liquidacion.firmada and liquidacion.enviadasri  and liquidacion.autorizada  %}
                                    <li>
                                    <a class="reportedirecto" href="javascript:;"
                                           tipos="{{ reporte_2.tiporeporte }}"
                                           nhref="/reportes?action=run&n={{ reporte_2 }}&id={{ liquidacion.ctaporpagar.id }}"> <i
                                            class='fa fa-print'></i> Formato Retención</a></li>

                                    {% if not liquidacion.ctaporpagar.tienexml %}
                                        <li><a class="btn-form"
                                               href="/adm_liquidacion_compras?action=generarxml&id={{ liquidacion.ctaporpagar.id }}"><i
                                                class="fa fa-file"></i> Generar XML (Liquidación)</a></li>
                                    {% endif %}

                                    {% if not liquidacion.ctaporpagar.firmada %}
                                        <li><a class="btn-form"
                                               href="/adm_liquidacion_compras?action=firmar&id={{ liquidacion.ctaporpagar.id }}"><i
                                                class="fa fa-key"></i> Firmar XML (Retención)</a></li>
                                    {% endif %}

                                    {% if not liquidacion.ctaporpagar.sri %}
                                        <li><a class="btn-form"
                                               href="/adm_liquidacion_compras?action=enviosri&id={{ liquidacion.ctaporpagar.id }}"><i
                                                class="fa fa-envelope"></i> Enviar al SRI (Retención)</a></li>
                                    {% endif %}

                                    {% if not liquidacion.ctaporpagar.autorizada %}
                                        <li><a class="btn-form"
                                               href="/adm_liquidacion_compras?action=autorizar&id={{ liquidacion.ctaporpagar.id }}"><i
                                                class="fa fa-flag"></i> Autorizar (Retención)</a></li>
                                    {% endif %}

                                    {% if not liquidacion.ctaporpagar.tienexml %}
                                        <li class="divider"></li>
                                        <li><a class="eliminacionmodal" href="javascript:;"
                                               nhref="/adm_liquidacion_compras?action=delete&id={{ liquidacion.ctaporpagar.id }}"><i
                                                class="fa fa-times fa-fw fa fa-remove"></i> Eliminar (Retención)</a></li>
                                    {% endif %}

                                    {% if not liquidacion.ctaporpagar.sri and liquidacion.ctaporpagar.valida %}
                                        <li><a onclick="cancelar({{ liquidacion.ctaporpagar.id }})"><i
                                                class="fa fa-remove"></i> Cancelar</a></li>
                                    {% endif %}

                                    {% if request.user.is_superuser %}
                                        <li><a onclick="anular({{ liquidacion.ctaporpagar.id }})"><i
                                                class="fa fa-remove"></i> Anular Retención</a></li>
                                    {% endif %}
                                {% endif %}{% endcomment %}
                                    {% if liquidacion.puede_enviar_email_liquidacion_compra %}
                                        <li>
                                            <a href="javascript:;" onclick="enviar_liquidacion_compra({{ liquidacion.id }}, '{{ liquidacion.proveedor }}')"> <i class="fa fa-send"></i> Enviar liquidación compra</a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </div>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="20">NO EXISTEN FACTURAS REGISTRADAS</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class='row-fluid'>
        <div class="span12">
            {% if paging.num_pages > 20 %}
                <div class='pagination'>
                    <ul>
                        {% if paging.primera_pagina %}
                            <li>
                                <a href="/adm_liquidacion_compras?page=1{{ url_vars }}">1</a>
                            </li>
                            <li>
                                <a href="/adm_liquidacion_compras?page={{ paging.ellipsis_izquierda }}{{ url_vars }}"
                                   class="active">...</a></li>
                        {% endif %}
                        {% for pagenumber in paging.paginas %}
                            <li {% if pagenumber == page.number %}class='active'{% endif %}><a
                                    href="/adm_liquidacion_compras?page={{ pagenumber }}{{ url_vars }}">{{ pagenumber }}</a>
                            </li>
                        {% endfor %}
                        {% if paging.ultima_pagina %}
                            <li>
                                <a href="/adm_liquidacion_compras?page={{ paging.ellipsis_derecha }}{{ url_vars }}"
                                   class="active">...</a></li>
                            <li>
                                <a href="/adm_liquidacion_compras?page={{ paging.num_pages }}{{ url_vars }}">{{ paging.num_pages }}</a>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            {% else %}
                <div class='pagination'>
                    <ul>
                        {% for pagenumber in paging.page_range %}
                            <li {% if pagenumber == page.number %}class='active'{% endif %}><a
                                    href="/adm_liquidacion_compras?{% if search %}s={{ search }}&{% endif %}{% if a %}a={{ a }}&{% endif %}{% if date %}date={{ date }}&{% endif %}page={{ pagenumber }}">{{ pagenumber }}</a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}
{% block moreblock %}
    <div class="modal fade static" id="modal-detalle" style="display: none;">
        <div class="modal-header">
            <h3 class="paneltitle">Detalle de Factura</h3>
        </div>
        <div class="modal-body">
            <div id="detalle">

            </div>
        </div>
        <div class="modal-footer">
            <div style="float: right">
                <a href="javascript:;" class="btn btn-info btn-aceptar"> Aceptar</a>
            </div>
        </div>
    </div>

    <div class="modal fade static" id="modal-detalle-pagos" style="display: none;">
        <div class="modal-header">
            <h3 class="paneltitle">Detalle de Pagos</h3>
        </div>
        <div class="modal-body">
            <div id="detallepagos">

            </div>
        </div>
        <div class="modal-footer">
            <div style="float: right">
                <a href="javascript:;" class="btn btn-info btn-aceptar"> Aceptar</a>
            </div>
        </div>
    </div>

    <div class="modal fade static" id="ficherofacturamodal" style="display: none;">
        <div class="modal-header">
            <h4>Descargar archivo</h4>
        </div>
        <div class="modal-body" id="cerrarpanelpanelbody">
            <div class="row-fluid">
                <div style="margin-bottom: 5px; float: left">
                    Fecha Desde: <input type="text" id="fechainicio" class="selectorfecha"
                                        value="{{ fecha|date:'d-m-Y' }}">
                </div>
                <div style="margin-bottom: 5px; margin-left: 15px; float: left">
                    Fecha Hasta: <input type="text" id="fechafin" class="selectorfecha"
                                        value="{{ fecha|date:'d-m-Y' }}">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn btn-generar btn-success">Generar</a>
            <a href="javascript:;" class="btn btn-cerrar btn-info">Cerrar</a>
        </div>
    </div>

    <div class="modal fade static" id="itemspanel" style="display: none;">
        <div class="modal-header">
            <table border="0" width="100%" style="background-color: transparent">
                <tr>
                    <td style="width: 80%"><h3 class="paneltitle"></h3></td>
                    <td><a href="javascript:;" id="cerrarpanel" class="btn btn-danger btn-mini pull-right"><i
                            class="fa fa-remove"></i></a></td>
                </tr>
            </table>
        </div>
        <div class="modal-body panelbody">
        </div>
    </div>


    <div class="modal fade static modal-lg" id="modal-detalle-nota" style="display: none;">
        <div class="modal-header modal-lg">
            <h3 class="paneltitle-nota">Detalle de Nota Crédito</h3>
        </div>
        <div class="modal-body">
            <div id="detalle-nota">

            </div>
        </div>
        <div class="modal-footer">
            <div style="float: right">
                <a href="javascript:;" class="btn btn-info btn-aceptar"> Aceptar</a>
            </div>
        </div>
    </div>

    <div class="modal fade static modal-sm" id="itemspanel2" style="display: none;">
        <div class="modal-header">
            <h3><i class="fa fa-print"></i> Reporte Facturas Anual</h3>
        </div>
        <div class="modal-body">
            <div class=ow-fluid">
                <form id="form3" class="form-horizontal form-modal" style="margin-bottom: 0">
                    <label>Fecha Inicial:</label>
                    <input style="width: 100%" type="date" class="form-control" id="id_fechainicio" required
                           value="{{ fechaactual }}">
                    <label>Fecha Final:</label>
                    <input style="width: 100%" type="date" class="form-control" id="id_fechafinal" required
                           value="{{ fechaactual }}">
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn btn-danger" id="itemspanel_adicionar_2"><i class="fa fa-plus"></i>
                Procesar</a>
            <a href="javascript:;" class="btn btn-info" id="itemspanel_cerrar_2"> Cerrar</a>
        </div>
    </div>

    <div class="modal fade static" id="ficherofacturamodal_anuladas" style="display: none;">
        <div class="modal-header">
            <h4>Descargar archivo</h4>
        </div>
        <div class="modal-body" id="cerrarpanelpanelbody_anuladas">
            <div class="row-fluid">
                <div style="margin-bottom: 5px; float: left">
                    Fecha Desde: <input type="text" id="fechainicio_anuladas" class="selectorfecha"
                                        value="{{ fecha|date:'d-m-Y' }}">
                </div>
                <div style="margin-bottom: 5px; margin-left: 15px; float: left">
                    Fecha Hasta: <input type="text" id="fechafin_anuladas" class="selectorfecha"
                                        value="{{ fecha|date:'d-m-Y' }}">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn btn-generar btn-success">Generar</a>
            <a href="javascript:;" class="btn btn-cerrar btn-info">Cerrar</a>
        </div>
    </div>
    <div class="modal fade" id="modalConsulta">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="frmConsulta" method="post" enctype="multipart/form-data">{% csrf_token %}
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title"><b id="nombre"></b></h4>
                </div>
                <div class="modal-body tablaaqui">
                </div>
                <div class="modal-footer" id="footerModalView">
                    <a href="javascript:;" class="btn btn-default" data-dismiss="modal"><i
                            class="fa fa-window-close"></i>
                        Cerrar</a>
                </div>
            </form>
        </div>
    </div>
</div>
    <div class="modal fade static modal-sm" id="modal_reporte_liquidacion_compra" style="display: none; width: 400px!important;" role="dialog">
        <div class="modal-header">
            <h4>REPORTE DE  LIQUIDACIONES DE COMPRA DE BIENES Y PRESTACIÓN DE SERVICIOS</h4>
        </div>
        <div class="modal-body">
            <form action="javascript:;">
                <input type="hidden" name="action" value="rpt_liquidacion_compra">
                <div class="row-fluid">
                {% for field in formReporteLiquidacionCompra %}
                    <fieldset id="fieldset_{{ field.name }}" class="control-group nomargins" style="float: left; width: {% if field.field.widget.attrs.formwidth %}{{ field.field.widget.attrs.formwidth }}{% else %}100%{% endif %}">
                        <div class="control-label label-text" {% if field.field.widget.attrs.labelwidth %}labelwidth="{{ field.field.widget.attrs.labelwidth }}"{% endif %} style="display: table;height: 30px;">
                            {% if field.field.widget.attrs.fieldbuttons %}
                                <div style="display: table-cell; vertical-align: middle; line-height: 11px">
                                    {% for boton in field.field.widget.attrs.fieldbuttons %}
                                        <a href="javascript:;" class="btn btn-mini {{ boton.btnclasscolor }} tu" title="{{ boton.tooltiptext }}" id="{{ boton.id }}"><i class="fa {{ boton.btnfaicon }}"></i></a>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div style="display: table-cell; vertical-align: middle; line-height: 11px">
                                <label for="id_{{ field.name }}" style="padding-right: 20px">{{ field.label }}</label>
                            </div>
                        </div>
                        <div class="controls">
                            {{ field }}
                        </div>
                    </fieldset>
                {% endfor %}
            </div>
            </form>
        </div>
        <div class="modal-footer">
            <a id="modal_reporte_liquidacion_compra_ejecutar" class="btn btn-success">Ejecutar</a>
            <a id="moodal_reporte_close" class="btn btn-danger">Cerrar</a>
        </div>
    </div>
{% endblock %}
