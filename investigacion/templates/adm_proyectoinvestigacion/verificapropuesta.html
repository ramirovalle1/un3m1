{% extends "base.html" %}
{% load humanize %}
{% load sga_extras %}
{% block heading %}
    <script type="text/javascript" src='/static/js/jquery.validationEngine.js?v=1.0.0'></script>
    <script type="text/javascript" src='/static/js/jquery.validationEngine-es.js?v=1.0.0' ></script>
    <link type='text/css' rel='stylesheet' href="/static/css/validationEngine.jquery.css?v=1.0.0"/>
    <link rel="stylesheet" href="/static/css/stylesfc.css">
    <link href="/static/switchery/switchery.min.css" rel="stylesheet"/>
    <script src="/static/switchery/switchery.min.js"></script>
    <style>
        .accordion-item{
            border:1px solid rgba(0,0,0,.125);
        }
        .accordion-header{
            padding: 1px;
        }
        .accordion-button{
            padding: 10px;
        }
        .accordion-body{
            padding: 2px;
        }
    </style>
    <script type="text/javascript">
        var switchery = {};
        $.fn.initSwitchery = function () {
            //Init CheckBox Style
            var searchBy = ".js-switch";
            $(this).find(searchBy).each(function (i, html) {
                debugger;
                if (!$(html).next().hasClass("switchery")) {
                    //switchery[html.getAttribute('id')] = new Switchery(html, $(html).data());
                    switchery[html.getAttribute('id')] = new Switchery(html, {size: 'small', color: '#264763'});
                }
            });
        };

        $(function() {
            $('[data-bs-toggle="tooltip"]').on('click', function () {
                $(this).tooltip('hide');
            });

            $("body").initSwitchery();
            $("select").select2({minimumResultsForSearch: 5, width: '100%' });

            $("#observacion, #estado").addClass("validate[required]");

            let investigadoresacreditados = false;
            let documentosvalidos = false;
            let iddet = '';

            lista_items1 = [];
            lista_items2 = [];

            $(".investigadores").on("change" , function() {
                investigadoresacreditados = true;
                lista_items1 = [];
                $(".investigadores").each(function(){
                    iddet = $(this).attr("iddet");
                    if($(this).is(":checked")){
                        $("#observacionint_"+iddet).val("");
                        $("#observacionint_"+iddet).prop("readOnly", true);
                        $("#observacionint_"+iddet).removeClass("validate[required]");
                    }else{
                        $("#observacionint_"+iddet).prop("readOnly", false);
                        $("#observacionint_"+iddet).addClass("validate[required]");

                        investigadoresacreditados = false;
                    }

                    lista_items1.push({'id': $(this).attr("iddet"),
                                       'valor': $(this).is(":checked")});

                });
                cargar_estados_propuesta();
            });

            agregar_validacion_observaciones = function (){
                $(".observacionintegrante").each(function(){
                    $(this).addClass("validate[required]");
                });
            };

            $(".documentos").on("change" , function() {
                documentosvalidos = true;
                bloquearultimo = false;
                lista_items2 = [];
                $(".documentos").each(function(){
                    iddet = $(this).attr("iddet");
                    if($(this).is(":checked")){
                        $("#observaciondoc_"+iddet).val("");
                        $("#observaciondoc_"+iddet).prop("readOnly", true);
                        $("#observaciondoc_"+iddet).removeClass("validate[required]");
                    }else{
                        $("#observaciondoc_"+iddet).prop("readOnly", false);
                        $("#observaciondoc_"+iddet).addClass("validate[required]");

                        documentosvalidos = false;
                        console.log(iddet);
                        if(iddet != '6'){
                            bloquearultimo = true;
                        }
                    }

                    lista_items2.push({'id': $(this).attr("iddet"),
                                       'valor': $(this).is(":checked")});

                });

                console.log(bloquearultimo);
                if(bloquearultimo){
                    switchery[`chkdocumento${iddet}`].disable();
                    if($(`#chkdocumento${iddet}`).is(":checked"))
                        switchery[`chkdocumento${iddet}`].setPosition(true);
                    $("#observaciondoc_"+iddet).prop("readOnly", false);
                    $("#observaciondoc_"+iddet).addClass("validate[required]");
                }else{
                    switchery[`chkdocumento${iddet}`].enable();
                }

                cargar_estados_propuesta();
            });

            agregar_validacion_observaciones_documentos = function (){
                $(".observaciondocumento").each(function(){
                    $(this).addClass("validate[required]");
                });
            };

            actualizar_lista_acreditados_documentos = function(){
                lista_items1 = [];
                lista_items2 = [];

                $(".investigadores").each(function(){
                    lista_items1.push({'id': $(this).attr("iddet"),
                                       'valor': $(this).is(":checked")});
                });

                $(".documentos").each(function(){
                    lista_items2.push({'id': $(this).attr("iddet"),
                                       'valor': $(this).is(":checked")});
                });
            };

            cargar_estados_propuesta = function (){
                $("#estado").empty();
                $("#estado").append('<option value="">---------</option>');
                if(investigadoresacreditados && documentosvalidos){
                    $("#estado").append('<option value="3">VERIFICADO </option>');
                    $("#estado").append('<option value="27">P.RECHAZADA</option>');
                }else {
                    $("#estado").append('<option value="4">PRESENTA NOVEDADES</option>');
                    $("#estado").append('<option value="27">P.RECHAZADA</option>');
                }
                $("#estado").val('').trigger('change');
            };

            $('#estado').change(function(){
                $("#observacion").prop("readOnly", true);
                $("#observacion").val('');
                $("#observacion").removeClass("validate[required]");

                if($("#estado").val() == '4' || $("#estado").val() == '27'){
                    $("#observacion").prop("readOnly", false);
                    $("#observacion").addClass("validate[required]");
                }
            });

            $(".archivos").change(function () {
                let cantidad = $(this).get(0).files.length;
                $("#bgarchivo").html(cantidad.toString());
            });

            $(".guardar").click(function () {
                enviarFormulario("/adm_proyectoinvestigacion", "verificarrequisitos");
                return false;
            });

            enviarFormulario = function(url, action){
                $("#frmVerificar").validationEngine('attach',{ scroll: true });
                let valido = $("#frmVerificar").validationEngine('validate', { scroll: true });

                if (valido){
                    bloqueointerface();

                    if(action == 'verificarrequisitos'){
                        var formdata = new FormData($("#frmVerificar")[0]);
                        formdata.append("lista_items1", JSON.stringify(lista_items1));
                        formdata.append("lista_items2", JSON.stringify(lista_items2));
                    }

                    $.ajax({
                        type: "POST",
                        action : action,
                        url: url,
                        data:  formdata,
                        success: function(data) {
                            if(data.result=='ok'){
                                $.unblockUI();
                                urlDestino = "/adm_proyectoinvestigacion?action=propuestas&idc={{ proyecto.convocatoria.id|encrypt }}&id={{ proyecto.id|encrypt }}";
                                mensajeSuccessSwal(data.titulo, data.mensaje, urlDestino);
                            }else{
                                $.unblockUI();
                                if(data.swalType == 'warning')
                                    mensajeWarningSwal(data.titulo, data.mensaje);
                                else
                                    mensajeErrorSwal(data.titulo, data.mensaje);
                            }
                        },
                        error: function() {
                            $.unblockUI();
                            mensajeErrorSwal("No se puede guardar", "Error al enviar los datos");
                        },
                        dataType: "json",
                        cache: false,
                        contentType: false,
                        processData: false
                    });
                }else{
                    setTimeout(function() {
                        $('.help-text').html("");
                    }, 8000);
                    $.unblockUI();
                }
            };

            $(".cancelar").click(function () {
                mensajeConfirmSwal("Cerrar pantalla sin guardar cambios", "¿Acepta cerrar la pantalla de Verificación de Requisitos sin haber guardado la información?", false, "/adm_proyectoinvestigacion", "", "", "/adm_proyectoinvestigacion?action=propuestas&idc={{ proyecto.convocatoria.id|encrypt }}&id={{ proyecto.id|encrypt }}");
            });

            $(".proformadetalle").click(function() {
                let id = $(this).attr('id');
                bloqueointerface();
                $.ajax({
                    type: "GET",
                    url: "/adm_proyectoinvestigacion",
                    data: {'action': 'proformadetallepresupuesto', 'id': id},
                    success: function(data) {
                        $.unblockUI();
                        if (data.result === 'ok') {
                            $(".panelbodyproformadetalle").html(data.data);
                            $(".paneltitleproformadetalle").html(data.title);
                            $("#itemspanelproformadetalle").modal({backdrop:'static'}).modal('show');
                        } else {
                            mensajeErrorSwal("No se puede consultar", data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        mensajeErrorSwal("No se puede consultar", "Error al enviar los datos")
                    },
                    dataType: "json"
                });
            });

            $(".hojadevida").click(function() {
                let id = $(this).attr('id');
                bloqueointerface();
                $.ajax({
                    type: "GET",
                    url: "/adm_proyectoinvestigacion",
                    data: {'action': 'mostrarhojavida', 'id': id},
                    success: function(data) {
                        $.unblockUI();
                        if (data.result === 'ok') {
                            $(".panelbodyhojadevida").html(data.data);
                            $(".paneltitlehojadevida").html(data.title);
                            $("#itemspanelhojadevida").modal({backdrop:'static'}).modal('show');
                        } else {
                            mensajeErrorSwal("No se puede consultar", data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        mensajeErrorSwal("No se puede consultar", "Error al enviar los datos")
                    },
                    dataType: "json"
                });
            });

            $(".imprimirdocumento").click(function() {
                let id=$(this).attr('id');

                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/pro_proyectoinvestigacion",
                    data: {'action': 'generardocumento', 'id': id, 'tipo': 'actualizado'},
                    success: function(data) {
                        $.unblockUI();
                        if (data.result=='ok'){
                            location.href = "/pro_proyectoinvestigacion?action=informacionproyecto&id="+id+"&vpd=S";
                        } else {
                            mensajeErrorSwal("No se puede consultar", data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        mensajeErrorSwal("No se puede consultar", "Error al enviar los datos");
                    },
                    dataType: "json"
                });
            });

            $(".descargarpresupuestoindividual").click(function() {
                let id=$(this).attr('id');

                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/adm_proyectoinvestigacion",
                    data: {'action': 'descargarpresupuestoindividual', 'id': id},
                    success: function(data) {
                        $.unblockUI();
                        if (data.result == 'ok'){
                            location.href = data.archivo;
                        } else {
                            if(data.swalType == 'warning')
                                mensajeWarningSwal(data.titulo, data.mensaje);
                            else
                                mensajeErrorSwal(data.titulo, data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        mensajeErrorSwal("No se puede consultar", "Error al enviar los datos");
                    },
                    dataType: "json"
                });
            });

            $(".descargarcronogramaindividual").click(function() {
                let id=$(this).attr('id');

                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/adm_proyectoinvestigacion",
                    data: {'action': 'descargarcronogramaindividual', 'id': id},
                    success: function(data) {
                        $.unblockUI();
                        if (data.result == 'ok'){
                            location.href = data.archivo;
                        } else {
                            if(data.swalType == 'warning')
                                mensajeWarningSwal(data.titulo, data.mensaje);
                            else
                                mensajeErrorSwal(data.titulo, data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        mensajeErrorSwal("No se puede consultar", "Error al enviar los datos");
                    },
                    dataType: "json"
                });
            });

            agregar_validacion_observaciones();
            agregar_validacion_observaciones_documentos();
            cargar_estados_propuesta();
            actualizar_lista_acreditados_documentos();

            $(".investigadores").trigger('change');
            $(".documentos").trigger('change');

            {% if proyecto.estado.valor == 3 or proyecto.estado.valor == 4 %}
                $("#estado").val('{{ proyecto.estado.valor }}').trigger('change');
                $("#observacion").val('{{ proyecto.observacion }}');
            {% endif %}
        });
    </script>
{% endblock %}
{% block atras %}/adm_proyectoinvestigacion?id={{ proyecto.id|encrypt }}&action=propuestas&idc={{ proyecto.convocatoria.id|encrypt }}{% endblock %}
{% block canvas %}
    {# TITULO PANTALLA #}
    <div class='row'>
        <div class='col-lg-12'>
            <div class="headtitle">
                <h3 class="texto-blue">{{ title }}</h3>
                <h6>Propuestas de Docentes (Convocatoria: {{ proyecto.convocatoria.descripcion }}) | Director: {{ proyecto.profesor.persona.nombre_completo|title }}</h6>
            </div>
        </div>
    </div>
    {# TITULO PANTALLA #}
    <div class="container-fluid">
        {# TITULO DEL PROYECTO #}
        <div class='row'>
            <div class="col-sm-12">
                <div class="alert alert-primary d-flex align-items-center" role="alert">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-info-circle-fill me-2" viewBox="0 0 16 16">
                        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                    </svg>
                    <div>
                        {{ proyecto.titulo }}
                    </div>
                </div>
            </div>
        </div>
        {# TITULO DEL PROYECTO #}
        {# TABLA DE DATOS #}
        <div class="card mb-4">
            <div class="card-body border-top border-6 rounded-3 border-dark-info">
                <form name="frmVerificar" id="frmVerificar">{% csrf_token %}
                    <input type='hidden' name='action' value='verificarrequisitos'/>
                    <input type='hidden' name='idproyecto' value='{{ proyecto.id|encrypt }}'/>
                    <div class="row">
                        {# PESTAÑAS #}
                        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" id="pills-verificacion-tab" data-bs-toggle="pill" href="#pills-verificacion" role="tab" aria-controls="pills-verificacion" aria-selected="true">Verificación</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="pills-datosgenerales-tab" data-bs-toggle="pill" href="#pills-datosgenerales" role="tab" aria-controls="pills-datosgenerales" aria-selected="true">Datos Generales</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="pills-integrantes-tab" data-bs-toggle="pill" href="#pills-integrantes" role="tab" aria-controls="pills-integrantes" aria-selected="false">Integrantes</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="pills-contenido-tab" data-bs-toggle="pill" href="#pills-contenido" role="tab" aria-controls="pills-contenido" aria-selected="false">Contenido</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="pills-presupuesto-tab" data-bs-toggle="pill" href="#pills-presupuesto" role="tab" aria-controls="pills-presupuesto" aria-selected="false">Presupuesto</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="pills-cronograma-tab" data-bs-toggle="pill" href="#pills-cronograma" role="tab" aria-controls="pills-cronograma" aria-selected="false">Cronograma</a>
                            </li>
                        </ul>
                        {# PESTAÑAS #}
                        {# CONTENIDO DE CADA PESTAÑA #}
                        <div class="tab-content px-0" id="pills-tabContent">
                            <div class="tab-pane fade show active" id="pills-verificacion" role="tabpanel" aria-labelledby="pills-verificacion-tab">
                                <div class="table-responsive-xxl">
                                    <table class="table table-bordered table-striped table_primary">
                                        <thead>
                                            <tr>
                                                <th colspan="7">Validación Investigadores Acreditados</th>
                                            </tr>
                                            <tr>
                                                <th class="text-center" style="width: 3%;">#</th>
                                                <th class="text-center" style="width: 6%;">Rol</th>
                                                <th class="text-center" style="width: 9%;">Identificación</th>
                                                <th class="text-center" style="width: 20%;">Nombres y Apellidos</th>
                                                <th class="text-center" style="width: 8%;">Certificado</th>
                                                <th class="text-center" style="width: 7%;">Acreditado</th>
                                                <th class="text-center" style="width: 47%;">Observaciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for integrante in proyecto.integrantes_director_codirector %}
                                                <tr>
                                                    <td class="text-end"><b>{{ forloop.counter }}</b><input type="hidden" name="idintegrante[]" value="{{ integrante.id }}"> </td>
                                                    <td class="text-center">{{ integrante.get_funcion_display|title }}</td>
                                                    <td class="text-center">{{ integrante.persona.identificacion }}</td>
                                                    <td class="text-justify">{{ integrante.persona.nombre_completo|title }}</td>
                                                    <td class="text-center">
                                                        {% if integrante.archivoacreditado %}
                                                            <a href="{{ integrante.archivoacreditado.url }}" class="fs-4" data-width="2048" data-height="1380" data-fancybox="certificadoverifica{{ integrante.id }}" data-caption="Certificado de Registro como Investigador: {{ integrante.persona.nombre_completo|title }}" data-bs-toggle="tooltip" data-placement="top" title="Ver Certificado"><i class="fa fa-eye text-info"></i> </a>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" class="js-switch investigadores" iddet="{{ integrante.id }}" {% if integrante.estadoacreditado == 2 %}checked{% endif %} />
                                                    </td>
                                                    <td class="text-start">
                                                        <input type="text" autocomplete="off" maxlength="1000" id="observacionint_{{ integrante.id }}" name="observacionint[]" value="{{ integrante.observacion }}" class="observacionintegrante" style="width: 100%; text-transform: none;" {% if integrante.estadoacreditado == 2 %}readonly{% endif %}>
                                                        <div class="help-text" style="color: #dc1414; font-size: xx-small; margin-bottom: 0;"> </div>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="table-responsive-xxl">
                                    <table class="table table-bordered table_primary">
                                        <thead>
                                            <tr>
                                                <th colspan="5">Validación por Sección y Formato de Inscripción</th>
                                            </tr>
                                            <tr>
                                                <th style="width: 3%;" class="text-center">#</th>
                                                <th style="width: 30%;" class="text-center">Sección/Documento</th>
                                                <th style="width: 7%;" class="text-center">Archivo</th>
                                                <th style="width: 7%;" class="text-center">Validado</th>
                                                <th style="width: 53%;" class="text-center">Observaciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
{#                                            <tr>#}
{#                                                <td class="text-end">1<input type="hidden" name="iddocumento[]" value="1"></td>#}
{#                                                <td class="text-justify">Formulario Formato de inscripción de Proyecto firmado</td>#}
{#                                                <td class="text-center">#}
{#                                                    <a href="{{ proyecto.archivodocumentofirmado.url }}" class="fs-4" data-width="2048" data-height="1380" data-fancybox="inscripcionverifica{{ proyecto.id }}" data-caption="Formato de Inscripción de Proyecto" data-bs-toggle="tooltip" data-placement="top" title="Ver Formato de Inscripción"><i class="fa fa-eye text-info"></i> </a>#}
{#                                                </td>#}
{#                                                <td class="text-center">#}
{#                                                    <input type="checkbox" class="js-switch documentos" iddet="1" {% if proyecto.estadodocumentofirmado == 2 %}checked{% endif %} />#}
{#                                                </td>#}
{#                                                <td class="text-start">#}
{#                                                    <input type="text" autocomplete="off" maxlength="1000" id="observaciondoc_1" name="observaciondoc[]" value="{{ proyecto.observaciondocumentofirmado }}" class="observaciondocumento" style="width: 100%; text-transform: none;" {% if proyecto.estadodocumentofirmado == 2 %}readonly{% endif %}>#}
{#                                                    <div class="help-text" style="color: #dc1414; font-size: xx-small; margin-bottom: 0;"> </div>#}
{#                                                </td>#}
{#                                            </tr>#}
                                            {% for documento in documentos %}
                                                <tr>
                                                    <td class="text-end"><b>{{ forloop.counter }}</b><input type="hidden" name="iddocumento[]" value="{{ documento.id }}"></td>
                                                    <td class="text-justify">{{ documento.descripcion }}</td>
                                                    <td class="text-center">
                                                        {% if documento.archivo %}
                                                            <a href="{{ documento.archivo }}" class="fs-4" data-width="2048" data-height="1380" data-fancybox="inscripcionverifica{{ proyecto.id }}" data-caption="Formato de Inscripción de Proyecto" data-bs-toggle="tooltip" data-placement="top" title="Ver Formato de Inscripción"><i class="fa fa-eye text-info"></i> </a>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" id="chkdocumento{{ documento.id }}" class="js-switch documentos" iddet="{{ documento.id }}" {% if documento.estado == 2 %}checked{% endif %} />
                                                    </td>
                                                    <td class="text-start">
                                                        <input type="text" autocomplete="off" maxlength="1000" id="observaciondoc_{{ documento.id }}" name="observaciondoc[]" value="{{ documento.observacion }}" class="observaciondocumento" style="width: 100%; text-transform: none;" {% if documento.estado == 2 %}readonly{% endif %}>
                                                        <div class="help-text" style="color: #dc1414; font-size: xx-small; margin-bottom: 0;"> </div>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="table-responsive-xxl">
                                    <table class="table table-bordered table_primary" >
                                        <thead>
                                            <tr>
                                                <th colspan="4">Estado General de la propuesta</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="width: 10%;"><b>Estado:</b></td>
                                                <td style="width: 30%;">
                                                    <select id="estado" name="estado">
                                                        <option value="" selected>---------</option>
                                                    </select>
                                                    <div class="help-text" style="color: #dc1414; font-size: xx-small; margin-bottom: 0;"> </div>
                                                </td>
                                                <td style="width: 10%;"><b>Observaciones:</b></td>
                                                <td style="width: 50%;">
                                                    <textarea style="width: 100%; resize: none; text-transform: none;" cols="40" id="observacion" name="observacion" readonly rows="4"></textarea>
                                                    <div class="help-text" style="color: #dc1414; font-size: xx-small; margin-bottom: 0;"> </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="width: 10%;"><b>Archivo novedad:</b></td>
                                                <td style="width: 90%;" colspan="3">
                                                    {% if proyecto.archivonovedad and proyecto.estado.valor == 4 %}
                                                        <a href="{{ proyecto.archivonovedad.url }}" class="btn btn-sm btn-info" data-width="2048" data-height="1380" data-fancybox="archivonovedad" data-caption="Documento de novedades" data-bs-toggle="tooltip" data-placement="top" title="Ver Documento novedades"><i class="fa fa-eye"></i> </a>
                                                    {% endif %}
                                                    <label class="btn btn-default"><i class="fa fa-cloud-upload" aria-hidden="true"></i> Seleccionar <span id="bgarchivo" class="badge">0</span><input type="file" style="color: transparent" class="archivos" id="archivo" name="archivo" hidden> </label>
                                                    <small class="form-text text-muted">Tamaño Maximo permitido 4Mb, en formato pdf</small>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                {# FILA DE LOS BOTONES #}
                                <div class="row">
                                    <div class="col-sm-12 px-4" style="text-align: right; float: left; width: 100%">
                                        <a href="javascript:;" class="btn btn-success guardar"> Guardar</a>
                                        <a href="javascript:;" class="btn btn-danger cancelar"> Cancelar</a>
                                    </div>
                                </div>
                                {# FILA DE LOS BOTONES #}
                            </div>
                            <div class="tab-pane fade" id="pills-datosgenerales" role="tabpanel" aria-labelledby="pills-datosgenerales-tab">
                                <div class="table-responsive-xxl">
                                    <table class="table table_primary table-bordered table-striped mb-0" id="tbdatosgenerales">
                                        <thead>
                                            <tr>
                                                <th colspan="4">Datos Generales</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="width: 15%;"><strong>Convocatoria:</strong></td>
                                                <td style="width: 35%;">{{ proyecto.convocatoria.descripcion|title }}</td>
                                                <td style="width: 15%;"><strong>Tipo:</strong></td>
                                                <td style="width: 35%;">{{ proyecto.categoria2.descripcion|title }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Título:</strong></td>
                                                <td colspan="3" class="text-justify">{{ proyecto.titulo }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Área Conocimiento:</strong></td>
                                                <td class="text-justify">{{ proyecto.areaconocimiento.nombre|title }}</td>
                                                <td><strong>Sub área Conocimiento:</strong></td>
                                                <td class="text-justify">{{ proyecto.subareaconocimiento.nombre|title }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Sub área específica Conocimiento:</strong></td>
                                                <td colspan="3" class="text-justify">{{ proyecto.subareaespecificaconocimiento.nombre|title }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Línea Investigación:</strong></td>
                                                <td class="text-justify">{{ proyecto.lineainvestigacion.nombre|title }}</td>
                                                <td><strong>Sub-Línea Investigación:</strong></td>
                                                <td>
                                                    {% for sublinea in proyecto.sublineainvestigacion.all %}
                                                        {{ sublinea.nombre|title }}
                                                        {% if not forloop.last %}, {% endif %}
                                                    {% endfor %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><strong>Programa:</strong></td>
                                                <td class="text-justify">{{ proyecto.programainvestigacion.nombre|title }}</td>
                                                <td><strong>Área prioritaria:</strong></td>
                                                <td class="text-justify">{{ proyecto.industriapriorizada.nombre|title }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>¿Requiere convenio?:</strong></td>
                                                <td colspan="3" class="text-justify">
                                                    {% if proyecto.requiereconvenio %}Si ({{ proyecto.especificaconvenio|title }}){% else %}No{% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><strong>¿Necesita permiso del CEISH?:</strong></td>
                                                <td colspan="3" class="text-justify">
                                                    {% if proyecto.requierepermiso %}Si ({{ proyecto.especificapermiso|title }}){% else %}No{% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><strong>Duración(meses):</strong></td>
                                                <td class="text-justify">{{ proyecto.tiempomes }} meses</td>
                                                <td><strong>Contempla compra de equipamiento:</strong></td>
                                                <td>
                                                    {% if convocatoriamonto.tipoequipamiento %}
                                                        {{ convocatoriamonto.get_tipoequipamiento_display|title }}
                                                    {% else %}
                                                        {% if proyecto.contempla_compra_equipos %}Si{% else %}No{% endif %}
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><strong>Monto UNEMI:</strong></td>
                                                <td>$ {{ proyecto.montounemi|floatformat:2|intcomma }}</td>
                                                <td><strong>Máximo a financiar por UNEMI:</strong></td>
                                                <td>$ {{ convocatoriamonto.maximo|floatformat:2|intcomma }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Monto otra fuente:</strong></td>
                                                <td>$ {{ proyecto.montootrafuente|floatformat:2|intcomma }}</td>
                                                <td><strong>Monto Total:</strong></td>
                                                <td>$ {{ proyecto.montototal|floatformat:2|intcomma }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <br>
                                <div class="table-responsive-xxl">
                                    <table class="table table_primary table-bordered table-striped mb-0" id="tblocalizacion">
                                        <thead>
                                            <tr>
                                                <th colspan="4">Localización Geográfica del proyecto</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% if proyecto.tipocobertura == 1 or proyecto.tipocobertura == 2 %}
                                                <tr>
                                                    <td style="width: 15%;"><strong>Tipo de Cobertura:</strong></td>
                                                    <td colspan="3" style="width: 85%;">{{ proyecto.get_tipocobertura_display|title }}</td>
                                                </tr>
                                            {% elif proyecto.tipocobertura == 3 %}
                                                <tr>
                                                    <td style="width: 15%;"><strong>Tipo de Cobertura:</strong></td>
                                                    <td style="width: 35%;">{{ proyecto.get_tipocobertura_display|title }}</td>
                                                    <td style="width: 15%;"><strong>Zonas de planificación:</strong></td>
                                                    <td style="width: 35%;">
                                                        {% for zona in proyecto.zonas.all %}
                                                            {{ zona.nombre|title }} ({{ zona.miembroszona|title }})
                                                            {% if not forloop.last %}, {% endif %}
                                                        {% endfor %}
                                                    </td>
                                                </tr>
                                            {% elif proyecto.tipocobertura == 4 %}
                                                <tr>
                                                    <td style="width: 15%;"><strong>Tipo de Cobertura:</strong></td>
                                                    <td style="width: 35%;">{{ proyecto.get_tipocobertura_display|title }}</td>
                                                    <td style="width: 15%;"><strong>Provincias:</strong></td>
                                                    <td style="width: 35%;">
                                                        {% for provincia in proyecto.provincias.all %}
                                                            {{ provincia.nombre|title }}
                                                            {% if not forloop.last %}, {% endif %}
                                                        {% endfor %}
                                                    </td>
                                                </tr>
                                            {% else %}
                                                <tr>
                                                    <td style="width: 15%;"><strong>Tipo de Cobertura:</strong></td>
                                                    <td style="width: 35%;">{{ proyecto.get_tipocobertura_display|title }}</td>
                                                    <td style="width: 15%;"><strong>Provincia:</strong>
                                                    <td style="width: 35%; text-align: justify">{{ proyecto.provincia.nombre|title }}</td>
                                                </tr>
                                                <tr>
                                                    <td style="width: 15%;"><strong>Cantones:</strong></td>
                                                    <td style="width: 35%; text-align: justify">
                                                        {% for canton in proyecto.canton.all %}
                                                            {{ canton.nombre|title }}
                                                            {% if not forloop.last %}, {% endif %}
                                                        {% endfor %}
                                                    </td>
                                                    <td style="width: 15%;"><strong>Parroquia:</strong></td>
                                                    <td style="width: 35%; text-align: justify">{{ proyecto.parroquia|title }}</td>
                                                </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                                <br>
                                <div class="table-responsive-xxl">
                                    <table class="table table_primary table-bordered table-striped" id="tbinstitucion">
                                        <thead>
                                            <tr>
                                                <th colspan="7">Instituciones Participantes</th>
                                            </tr>
                                            <tr>
                                                <th style="width: 10%;" class="text-center">Tipo Institución</th>
                                                <th style="width: 20%;" class="text-center">Grupo de Investigación</th>
                                                <th style="width: 20%;" class="text-center">Representante legal</th>
                                                <th style="width: 10%;" class="text-center">Identificación</th>
                                                <th style="width: 10%;" class="text-center">e-mail</th>
                                                <th style="width: 20%;" class="text-center">Dirección</th>
                                                <th style="width: 10%;" class="text-center">Página web</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for institucion in proyecto.instituciones_proyecto %}
                                                <tr>
                                                    <td class="text-center">{{ institucion.get_tipo_display|title }}</td>
                                                    <td class="text-justify">
                                                        {% if institucion.tipo == 1 %}
                                                            {{ proyecto.grupoinvestigacion.nombre|title }}
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-justify">{{ institucion.representante|title}}</td>
                                                    <td class="text-justify">{{ institucion.cedula }}</td>
                                                    <td class="text-justify">{{ institucion.email }}</td>
                                                    <td class="text-justify">{{ institucion.direccion|title }}</td>
                                                    <td class="text-justify">{{ institucion.paginaweb }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="pills-integrantes" role="tabpanel" aria-labelledby="pills-integrantes-tab">
                                <div class="table-responsive-xxl">
                                    <table class="table table_primary table-bordered table-striped" id="tblocalizacion">
                                        <thead>
                                            <tr>
                                                <th colspan="8">Integrantes del Proyecto de Investigación</th>
                                            </tr>
                                            <tr>
                                                <th style="width: 7%;" class="text-center">Rol</th>
                                                <th style="width: 7%;" class="text-center">Tipo</th>
                                                <th style="width: 7%;" class="text-center">Identificación</th>
                                                <th style="width: 23%;" class="text-center">Nombres y Apellidos</th>
                                                <th style="width: 10%;" class="text-center">Vigencia</th>
                                                <th style="width: 22%;" class="text-center">Entidad</th>
                                                <th style="width: 14%;" class="text-center">Teléfonos/E-mail</th>
                                                <th style="width: 10%;" class="text-center">Investigador Acreditado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for integrante in proyecto.integrantes_proyecto_informe %}
                                                <tr>
                                                    <td class="text-center">{{ integrante.get_funcion_display|title }}</td>
                                                    <td class="text-center">{{ integrante.get_tipo_display|title }}</td>
                                                    <td class="text-center">
                                                        <p>{{ integrante.persona.identificacion }}</p>
                                                        <a href="javascript:;" class="fs-4 hojadevida" id="{{ integrante.id|encrypt }}" data-bs-toggle="tooltip" data-bs-placement="top" title="Ver hoja de vida"><i class="fa fa-id-card text-primary"></i></a>
                                                    </td>
                                                    <td class="text-justify">
                                                        {{ integrante.persona.nombre_completo|title }}<br>
                                                        <span class="badge bg-{{ integrante.color_tipo_registro }}">{{ integrante.get_tiporegistro_display|title }}</span>
                                                        {% if integrante.tiporegistro == 2 %}
                                                            <span class="badge bg-info">{{ integrante.personareemplazo.nombre_completo|title }}</span>
                                                        {% endif %}
                                                        {% if integrante.tiporegistro != 1 %}
                                                            <a target="_blank" href="{{ integrante.archivo.url }}" class="btn btn-mini btn-warning tu" data-toggle="tooltip" data-placement="top" data-original-title="Descargar Archivo"><i class="fa fa-download"></i> </a>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-start">
                                                        {% if integrante.desde %}
                                                            <p><b>Inicio</b>: {{ integrante.desde }}</p>
                                                            <p><b>Fin&nbsp;&nbsp;&nbsp;&nbsp;</b>: {{ integrante.hasta }}</p>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-justify">
                                                        <p>
                                                        {% if integrante.tipo != 4 %}
                                                            Universidad Estatal de Milagro
                                                        {% else %}
                                                            {{ integrante.externo.institucionlabora|title }}
                                                        {% endif %}
                                                        </p>
                                                    </td>
                                                    <td class="text-justify">
                                                        <p>
                                                        {% if integrante.persona.telefono %}
                                                            {{ integrante.persona.telefono }} /
                                                        {% endif %}
                                                        {{ integrante.persona.telefono_conv }}<br>
                                                        {% if integrante.persona.email %}
                                                            {{ integrante.persona.email }},
                                                        {% endif %}
                                                        {{ integrante.persona.emailinst }}
                                                        </p>
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="badge bg-{{ integrante.color_estado_acreditado }}">{{ integrante.get_estadoacreditado_display|title }}</span>
                                                        {% if integrante.archivoacreditado %}<br>
                                                            <a href="{{ integrante.archivoacreditado.url }}" class="fs-4" data-width="2048" data-height="1380" data-fancybox="certificado{{ integrante.id }}" data-caption="Certificado de Registro como Investigador" data-bs-toggle="tooltip" data-placement="top" title="Ver Certificado"><i class="fa fa-eye text-info"></i> </a>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="pills-contenido" role="tabpanel" aria-labelledby="pills-contenido-tab">
                                <div class="table-responsive-xxl">
                                    <table class="table table_primary table-bordered table-striped" id="tbcontenido">
                                        <thead>
                                            <tr>
                                                <th colspan="2">Contenido del Proyecto de Investigación</th>
                                            </tr>
                                        </thead>
                                        {% if proyecto.resumenpropuesta %}
                                            <tbody>
                                                <tr>
                                                    <td style="width: 15%;"><strong>Resumen Propuesta:</strong></td>
                                                    <td style="width: 85%;" class="text-justify">{{ proyecto.resumenpropuesta|safe }}</td>
                                                </tr>
                                                <tr>
                                                    <td style="width: 15%;"><strong>Formulación del problema:</strong></td>
                                                    <td style="width: 85%;" class="text-justify">{{ proyecto.formulacionproblema|safe }}</td>
                                                </tr>
                                                <tr>
                                                    <td style="width: 15%;"><strong>Objetivo General:</strong></td>
                                                    <td style="width: 85%;" class="text-justify">{{ proyecto.objetivogeneral|safe }}</td>
                                                </tr>
                                                <tr>
                                                    <td style="width: 15%;"><strong>Objetivos Específicos:</strong></td>
                                                    <td style="width: 85%;">
                                                        <table class="table table-bordered table-striped mb-0" id="tbdetalleobjetivos">
                                                            <thead>
                                                                <tr>
                                                                    <th style="width: 3%;" class="text-center">#</th>
                                                                    <th style="width: 97%;" class="text-center">Objetivo</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="detalle_objetivos">
                                                                {% for objetivo in proyecto.objetivos_especificos %}
                                                                    <tr>
                                                                        <td class="text-end">{{ forloop.counter }}</td>
                                                                        <td class="text-justify">{{ objetivo.descripcion }}</td>
                                                                    </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style="width: 15%;"><strong>Justificación:</strong></td>
                                                    <td style="width: 85%;" class="text-justify">{{ proyecto.justificacion|safe }}</td>
                                                </tr>
                                                <tr>
                                                    <td style="width: 15%;"><strong>Estado del arte:</strong></td>
                                                    <td style="width: 85%;" class="text-justify">{{ proyecto.estadoarte|safe }}</td>
                                                </tr>
                                                <tr>
                                                    <td style="width: 15%;"><strong>Metodología:</strong></td>
                                                    <td style="width: 85%;" class="text-justify">{{ proyecto.metodologia|safe }}</td>
                                                </tr>
                                                <tr>
                                                    <td style="width: 15%;"><strong>Impactos:</strong></td>
                                                    <td style="width: 85%;">
                                                        <table class="table table-bordered table-striped mb-0" id="tbdetalleimpacto">
                                                            <thead>
                                                                <tr>
                                                                    <th style="width: 15%;" class="text-center">Tipo</th>
                                                                    <th style="width: 85%;" class="text-center">Detalle</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="detalle_impactos">
                                                                {% if proyecto.impactosocial %}
                                                                    <tr>
                                                                        <td><strong>Impacto Social:</strong></td>
                                                                        <td class="text-justify">{{ proyecto.impactosocial }}</td>
                                                                    </tr>
                                                                {% endif %}
                                                                {% if proyecto.impactocientifico %}
                                                                    <tr>
                                                                        <td><strong>Impacto Científico:</strong></td>
                                                                        <td class="text-justify">{{ proyecto.impactocientifico }}</td>
                                                                    </tr>
                                                                {% endif %}
                                                                {% if proyecto.impactoeconomico %}
                                                                    <tr>
                                                                        <td><strong>Impacto Económico:</strong></td>
                                                                        <td class="text-justify">{{ proyecto.impactoeconomico }}</td>
                                                                    </tr>
                                                                {% endif %}
                                                                {% if proyecto.impactopolitico %}
                                                                    <tr>
                                                                        <td><strong>Impacto Político:</strong></td>
                                                                        <td class="text-justify">{{ proyecto.impactopolitico }}</td>
                                                                    </tr>
                                                                {% endif %}
                                                                {% if proyecto.otroimpacto %}
                                                                    <tr>
                                                                        <td><strong>Otro Impacto:</strong></td>
                                                                        <td class="text-justify">{{ proyecto.otroimpacto }}</td>
                                                                    </tr>
                                                                {% endif %}
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style="width: 15%;"><strong>Productos / Resultados / Compromisos:</strong></td>
                                                    <td style="width: 85%;">
                                                        <table class="table table-bordered table-striped mb-0" id="tbdetalleproductos">
                                                            <thead>
                                                                <tr>
                                                                    <th style="width: 3%;" class="text-center">#</th>
                                                                    <th style="width: 97%;" class="text-center">Descripción</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="detalle_productos">
                                                                {% for resultado in proyecto.resultados_compromisos %}
                                                                    <tr>
                                                                        <td class="text-end">{{ forloop.counter }}</td>
                                                                        <td class="text-justify">{{ resultado.resultado.descripcion }}</td>
                                                                    </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style="width: 15%;"><strong>Referencias Bibliográficas (En formato APA séptima edición):</strong></td>
                                                    <td style="width: 85%;">
                                                        <table class="table table-bordered table-striped mb-0" id="tbdetalleproductos">
                                                            <thead>
                                                                <tr>
                                                                    <th style="width: 3%;" class="text-center">#</th>
                                                                    <th style="width: 97%;" class="text-center">Referencia</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="detalle_productos">
                                                                {% for referencia in proyecto.referencias_bibliograficas %}
                                                                    <tr>
                                                                        <td class="text-end">{{ forloop.counter }}</td>
                                                                        <td class="text-justify">{{ referencia.descripcion }}</td>
                                                                    </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                                {% if proyecto.archivoproyecto %}
                                                    <tr>
                                                        <td style="width: 15%;"><strong>Archivo del proyecto:</strong></td>
                                                        <td style="width: 85%;">
                                                            {% if proyecto.archivoproyecto %}
                                                                <a target="_blank" href="{{ proyecto.archivoproyecto.url }}" class="btn btn-info tu" title="Descargar Archivo del proyecto"><i class="fa fa-eye"></i> Descargar</a>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                                <tr>
                                                    <td style="width: 15%;"><strong>Formato Inscripción:</strong></td>
                                                    <td style="width: 85%;">
                                                        {% if proyecto.archivodocumento %}
                                                            <a href="{{ proyecto.archivodocumento.url }}" class="fs-4" data-width="2048" data-height="1380" data-fancybox="formatosinfirmar{{ proyecto.id }}" data-caption="Formato de Inscripción" data-bs-toggle="tooltip" data-placement="top" title="Ver Archivo"><i class="fa fa-eye text-info"></i></a>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style="width: 15%;"><strong>Formato Inscripción Firmado:</strong></td>
                                                    <td style="width: 85%;">
                                                        {% if proyecto.archivodocumentofirmado %}
                                                            <a href="{{ proyecto.archivodocumentofirmado.url }}" class="fs-4" data-width="2048" data-height="1380" data-fancybox="formatofirmado{{ proyecto.id }}" data-caption="Formato de Inscripción Firmado" data-bs-toggle="tooltip" data-placement="top" title="Ver Archivo"><i class="fa fa-eye text-info"></i></a>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            </tbody>
                                        {% else %}
                                            <tbody>
                                                <tr>
                                                    <td style="text-align: justify" colspan="2">No ha registrado el contenido del proyecto</td>
                                                </tr>
                                            </tbody>
                                        {% endif %}
                                    </table>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="pills-presupuesto" role="tabpanel" aria-labelledby="pills-presupuesto-tab">
                                <div class='row'>
                                    <div class="col-lg-6">
                                        {% if proyecto.archivopresupuesto %}
                                            <a href="{{ proyecto.archivopresupuesto.url }}" class="btn btn-success" data-width="2048" data-height="1380" data-fancybox="presupuesto{{ proyecto.id }}" data-caption="Presupuesto del Proyecto" data-bs-toggle="tooltip" data-placement="top" title="Ver Archivo"><i class="fa fa-eye"></i> Presupuesto</a>
                                        {% elif proyecto.presupuesto > 0 %}
                                            <a href="javascript:;" class='btn btn-success mb-2 descargarpresupuestoindividual' id="{{ proyecto.id|encrypt }}" data-bs-toggle="tooltip" title="Descargar Presupuesto en Excel"><span class="fa fa-file-excel-o"></span> Descargar</a>
                                        {% endif %}
                                    </div>
                                    <div class="col-lg-6 text-end">
                                        {% if proyecto.presupuesto > 0 %}
                                            Total Presupuesto: <span class="badge bg-primary tu" title="Total Presupuesto Registrado">$ {{ proyecto.presupuesto|floatformat:2|intcomma:2 }}</span>
                                        {% endif %}
                                    </div>
                                </div>

                                {% if proyecto.presupuesto > 0 %}
                                    <div class="accordion" id="accordionPanelsStayOpenExample">
                                        {# ACORDIÓN POR TIPO DE RECURSO #}
                                        {% for recursoconvocatoria in recursosconvocatoria %}
                                            {% with detalles=proyecto|args:recursoconvocatoria.tiporecurso.id|call:"presupuesto_detalle_tiporecurso" totales=proyecto|args:recursoconvocatoria.tiporecurso.id|call:"totales_detalle_tiporecurso" %}
                                            <div class="accordion-item">
                                                <h2 class="accordion-header" id="panelsStayOpen-heading{{ recursoconvocatoria.tiporecurso.id }}">
                                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapse{{ recursoconvocatoria.tiporecurso.id }}" aria-expanded="true" aria-controls="panelsStayOpen-collapse{{ recursoconvocatoria.tiporecurso.id }}">
                                                    <b>{{ forloop.counter }}.</b>&nbsp;{{ recursoconvocatoria.tiporecurso.descripcion|title }}&nbsp;
                                                    <span class="badge bg-info" id="totalitems{{ recursoconvocatoria.tiporecurso.id }}" data-bs-toggle="tooltip" data-bs-placement="top" title="Total items">{{ totales.totalitems }}</span>&nbsp;
                                                    <span class="badge bg-success" id="totalrecurso{{ recursoconvocatoria.tiporecurso.id }}" data-bs-toggle="tooltip" data-bs-placement="top" title="Total tipo recurso">$ {{ totales.totaldetalle|floatformat:2|intcomma }}</span>
                                                    </button>
                                                </h2>
                                                <div id="panelsStayOpen-collapse{{ recursoconvocatoria.tiporecurso.id }}" class="accordion-collapse collapse show" aria-labelledby="panelsStayOpen-heading{{ recursoconvocatoria.tiporecurso.id }}">
                                                    <div class="accordion-body">
                                                        <div class="table-responsive-xxl">
                                                            <table class="table table_primary table-bordered table-striped" id="tbrecurso_{{ recursoconvocatoria.tiporecurso.id }}" style="margin-bottom: 1px">
                                                                <thead>
                                                                    <tr>
                                                                        <th style="width: 1%;" class="text-center">N°</th>
                                                                        <th style="width: 25%;" class="text-center">Recurso</th>
                                                                        <th style="width: 25%;" class="text-center">Descripcion</th>
                                                                        <th style="width: 8%;" class="text-center">Cant</th>
                                                                        <th style="width: 8%;" class="text-center">Valor Unitario</th>
                                                                        <th style="width: 8%;" class="text-center">Total</th>
                                                                        <th style="width: 20%;" class="text-center">Observaciones</th>
                                                                        <th style="width: 5%;" class="text-center">Proformas</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="detalle_recurso_{{ recursoconvocatoria.tiporecurso.id }}">
                                                                    {% if detalles %}
                                                                        {% for detalle in detalles %}
                                                                            <tr id="filadetalle_{{ recursoconvocatoria.tiporecurso.id }}{{ forloop.counter }}">
                                                                                <td class="text-end"><b>{{ forloop.counter }}</b></td>
                                                                                <td class="text-justify">{{ detalle.recurso }}</td>
                                                                                <td class="text-justify">{{ detalle.descripcion }}</td>
                                                                                <td class="text-end">{{ detalle.cantidad }}</td>
                                                                                <td class="text-end">$ {{ detalle.valorunitario|floatformat:2|intcomma }}</td>
                                                                                <td class="text-end">$ {{ detalle.valortotal|floatformat:2|intcomma }}</td>
                                                                                <td class="text-justify">{{ detalle.observacion }}</td>
                                                                                <td class="text-center">
                                                                                    {% if recursoconvocatoria.tiporecurso.aplica_proforma %}
                                                                                        <a href="javascript:;" class="fs-4 proformadetalle" id="{{ detalle.id|encrypt }}" data-bs-toggle="tooltip" data-bs-placement="top" title="Proformas"><i class="fa fa-list text-info"></i></a>
                                                                                    {% endif %}
                                                                                </td>
                                                                            </tr>
                                                                        {% endfor %}
                                                                    {% else %}
                                                                        <tr id="fila_default_recurso_{{ recursoconvocatoria.tiporecurso.id }}">
                                                                            <td colspan="8" class="text-center">No existen detalles para el tipo de recurso {{ recursoconvocatoria.tiporecurso.descripcion|title }}</td>
                                                                        </tr>
                                                                    {% endif %}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endwith %}
                                        {% endfor %}
                                        {# ACORDIÓN POR RUBRICA #}
                                    </div>
                                {% else %}
                                    <div class="table-responsive-xxl">
                                        <table class="table table_primary table-bordered table-striped" id="tbcontenido">
                                            <thead>
                                                <tr>
                                                    <th>Presupuesto del Proyecto de Investigación</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>No ha registrado el presupuesto del proyecto</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="tab-pane fade" id="pills-cronograma" role="tabpanel" aria-labelledby="pills-cronograma-tab">
                                {% if proyecto.cronograma_asignado %}
                                    <a href="javascript:;" class='btn btn-success mb-2 descargarcronogramaindividual' id="{{ proyecto.id|encrypt }}" data-bs-toggle="tooltip" title="Descargar Cronograma en Excel"><span class="fa fa-file-excel-o"></span> Descargar</a>

                                    <div class="accordion" id="accordionPanelsStayOpenExample">
                                        {# ACORDIÓN POR OBJETIVO #}
                                        {% for objetivo in objetivos %}
                                            {% with detalles=proyecto|args:objetivo.id|call:"cronograma_detallado_objetivo" totales=proyecto|args:objetivo.id|call:"totales_detalle_objetivo" %}
                                            <div class="accordion-item">
                                                <h2 class="accordion-header" id="panelsStayOpen-heading{{ objetivo.id }}">
                                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapse{{ objetivo.id }}" aria-expanded="true" aria-controls="panelsStayOpen-collapse{{ objetivo.id }}">
                                                    <b>{{ forloop.counter }}.</b>&nbsp;{{ objetivo.descripcion }}&nbsp;
                                                    <span class="badge bg-info" id="totalactividades{{ objetivo.id }}" data-bs-toggle="tooltip" data-bs-placement="top" title="Total actividades">{{ totales.totalactividades }}</span>&nbsp;
                                                    <span class="badge bg-success" id="totalobjetivo{{ objetivo.id }}" data-bs-toggle="tooltip" data-bs-placement="top" title="Total ponderación objetivo">{{ totales.totalponderacion|floatformat:2|intcomma }} %</span>
                                                    </button>
                                                </h2>
                                                <div id="panelsStayOpen-collapse{{ objetivo.id }}" class="accordion-collapse collapse show" aria-labelledby="panelsStayOpen-heading{{ objetivo.id }}">
                                                    <div class="accordion-body">
                                                        <div class="table-responsive-xxl">
                                                            <table class="table table_primary table-bordered table-striped" id="tbobjetivo_{{ objetivo.id }}" style="margin-bottom: 1px">
                                                                <thead>
                                                                    <tr>
                                                                        <th style="width: 1%;" class="text-center">N°</th>
                                                                        <th style="width: 27%;" class="text-center">Actividad</th>
                                                                        <th style="width: 6%;" class="text-center">Pond. (%)</th>
                                                                        <th style="width: 6%;" class="text-center">Fecha Inicio</th>
                                                                        <th style="width: 6%;" class="text-center">Fecha Fin</th>
                                                                        <th style="width: 8%;" class="text-center">Avance</th>
                                                                        <th style="width: 10%;" class="text-center">Entregable</th>
                                                                        <th style="width: 10%;" class="text-center">Evidencia control informes</th>
                                                                        <th style="width: 10%;" class="text-center">Observaciones</th>
                                                                        <th style="width: 16%;" class="text-center">Responsables</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="detalle_objetivo_{{ objetivo.id }}">
                                                                    {% if detalles %}
                                                                        {% for detalle in detalles %}
                                                                            <tr id="filadetalle_{{ objetivo.id }}{{ forloop.counter }}">
                                                                                <td class="text-end"><b>{{ forloop.counter }}</b></td>
                                                                                <td class="text-justify">{{ detalle.actividad }}</td>
                                                                                <td class="text-end">{{ detalle.ponderacion|floatformat:2 }} %</td>
                                                                                <td class="text-center">{{ detalle.fechainicio|date:"d-m-Y" }}</td>
                                                                                <td class="text-center">{{ detalle.fechafin|date:"d-m-Y" }}</td>
                                                                                <td class="text-center">
                                                                                    {% with ultimo_avance_actividad=detalle.ultimo_avance_actividad %}
                                                                                        {% if ultimo_avance_actividad %}
                                                                                            <p><b>Estado:</b></p>
                                                                                            <span class="text-{{ ultimo_avance_actividad.color_estado }}">{{ ultimo_avance_actividad.get_estadoactual_display|title }}</span>
                                                                                            <p><b>Porcentaje:</b></p>
                                                                                            <p>{{ ultimo_avance_actividad.avanceactual|floatformat:2 }}</p>
                                                                                        {% else %}
                                                                                            <p><b>Estado:</b></p>
                                                                                            <span class="text-warning">Por Iniciar</span>
                                                                                            <p><b>Porcentaje:</b></p>
                                                                                            <p>0.00</p>
                                                                                        {% endif %}
                                                                                    {% endwith %}
                                                                                </td>
                                                                                <td class="text-justify">
                                                                                    {% if detalle.entregable %}
                                                                                        {{ detalle.entregable|truncatechars:'100' }}
                                                                                    {% elif detalle.lista_entregables %}
                                                                                        {% for entregable in detalle.lista_entregables %}
                                                                                            {{ entregable.entregable }}<br>
                                                                                        {% endfor %}
                                                                                    {% else %}
                                                                                        <span class="badge bg-warning">Falta entregable</span>
                                                                                    {% endif %}
                                                                                </td>
                                                                                <td class="text-justify">
                                                                                    <p>{{ detalle.evidenciacontrolinforme|truncatechars:'100' }}</p>
                                                                                </td>
                                                                                <td class="text-justify">
                                                                                    <p>{{ detalle.observaciongeneral|truncatechars:'100' }}</p>
                                                                                </td>
                                                                                <td class="text-justify">
                                                                                    {% for responsable in detalle.lista_responsables %}
                                                                                        <div class="arrow-content">
                                                                                            <i class="arrow-item" style="bottom: 1px"></i>
                                                                                            <div class="arrow-text" data-bs-toggle="tooltip">{{ responsable.persona.nombre_completo|title }}</div>
                                                                                        </div>
                                                                                    {% endfor %}
                                                                                </td>
                                                                            </tr>
                                                                        {% endfor %}
                                                                    {% else %}
                                                                        <tr id="fila_default_objetivo_{{ objetivo.id }}">
                                                                            <td colspan="10" style="text-align: center">No existen detalles de actividades para el objetivo # {{ forloop.counter }}</td>
                                                                        </tr>
                                                                    {% endif %}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endwith %}
                                        {% endfor %}
                                        {# ACORDIÓN POR OBJETIVO #}
                                    </div>
                                {% else %}
                                    <div class="table-responsive-xxl">
                                        <table class="table table_primary table-bordered table-striped" id="tbcontenido">
                                            <thead>
                                                <tr>
                                                    <th>Cronograma del Proyecto de Investigación</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>No ha registrado el cronograma del proyecto</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {# CONTENIDO DE CADA PESTAÑA #}
                    </div>
                </form>
            </div>
        </div>
        {# TABLA DE DATOS #}
    </div>

    <div class="modal fade static"  id="itemspanelproformadetalle" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content border-radius-modal">
                <div class="modal-header" style="padding-bottom: .7rem !important">
                    <h4 class="mb-0"><i class="fa fa-list"></i>&nbsp;<span class="paneltitleproformadetalle">Mostrar Recorrido de la Convocatoria</span></h4>
                    <button type="button" class="btn-close btn-cerrar-modal fs-5" data-bs-dismiss="modal" aria-label="Close">X</button>
                </div>
                <div class="modal-body panelbodyproformadetalle">

                </div>
                <div class="modal-footer" id="footermodal">
                    <button type="button" class="btn btn-cian-secondary fs-5" data-bs-dismiss="modal"> Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade static"  id="itemspanelhojadevida" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
            <div class="modal-content border-radius-modal">
                <div class="modal-header" style="padding-bottom: .7rem !important">
                    <h4 class="mb-0"><i class="fa fa-id-card"></i>&nbsp;<span class="paneltitlehojadevida">Mostrar Recorrido de la Convocatoria</span></h4>
                    <button type="button" class="btn-close btn-cerrar-modal fs-5" data-bs-dismiss="modal" aria-label="Close">X</button>
                </div>
                <div class="modal-body panelbodyhojadevida">

                </div>
                <div class="modal-footer" id="footermodal">
                    <button type="button" class="btn btn-cian-secondary fs-5" data-bs-dismiss="modal"> Cerrar</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
