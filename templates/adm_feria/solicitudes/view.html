{% extends "basebs_js.html" %}
{% load sga_extras %}
{% block atras %}/adm_feria{% endblock %}
{% block heading %}
    <script type="text/javascript" src="/static/js/jquery.isloading.min.js"></script>
    <link href="/static/css/table-responsive.css?1.0.0" type="text/css" rel="stylesheet" />
    <link href="/static/widget_ppp.css" rel="stylesheet"/>
    <style type="text/css">
        .radio label,
        .checkbox label {
            display: inline-block;
            cursor: pointer;
            color: #0074D9;
            position: relative;
            padding: 5px 15px 5px 51px;
            font-size: 1em;
            border-radius: 5px;
            -webkit-transition: all 0.3s ease;
            -o-transition: all 0.3s ease;
            transition: all 0.3s ease; }
        .radio label:hover,
        .checkbox label:hover {
            background: rgba(255, 65, 54, 0.1); }
        .radio label:before,
        .checkbox label:before {
            content: "";
            display: inline-block;
            width: 17px;
            height: 17px;
            position: absolute;
            left: 15px;
            border-radius: 50%;
            background: none;
            border: 3px solid #0074D9; }
        input[type="radio"] {
            display: none; }
        input[type="radio"]:checked + label:before {
            display: none; }
        input[type="radio"]:checked + label {
            padding: 5px 15px;
            background: #0074D9;
            border-radius: 2px;
            color: #fff; }
        .checkbox label:before {
            border-radius: 3px; }
        .checkbox input[type="checkbox"] {
            display: none; }
        .checkbox input[type="checkbox"]:checked + label:before {
            display: none; }
        .checkbox input[type="checkbox"]:checked + label {
            background: #0074D9;
            color: #fff;
            padding: 5px 15px; }
    </style>
    <script type="text/javascript">
        $.extend(true, $.fn.dataTable.defaults, {
            oLanguage: {
                sSearch: "<span>Filtro:</span> _INPUT_",
                sLengthMenu: "<span>Mostrar Entradas:</span> _MENU_",
                sZeroRecords: "No se encontraron resultados",
                sProcessing: "Procesando...",
                sEmptyTable: "Ningún dato disponible para visualizar",
                sInfo: "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                sInfoEmpty: "Mostrando registros del 0 al 0 de un total de 0 registros",
                sLoadingRecords: "Cargando...",
                oPaginate: {
                    sFirst: "<i title='Inicio' class='fa fa-step-backward'></i>",
                    sLast: "<i title='Último' class='fa fa-step-forward'></i>",
                    sNext: "<i title='Siguiente' class='fa fa-fast-forward'></i>",
                    sPrevious: "<i title='Anterior' class='fa fa-fast-backward'></i>"
                },
            }
        });

        var ControllerRequests = {
            init: function (){
                var self = this;
                self.$table = $('.datatable table');
                $('[name="carreras"]').change(function(){
                    self.$table.dataTable().fnDraw();
                });

                $(".action-add").click(function (){
                    uiModal.open('new', 0);
                });

                self.loadDataTable();
                 $("#action_min").click(function(){
                    $("#panel_filter .panel-body").hide();
                    $("#action_min").hide();
                    $("#action_max").show();
                });
                $("#action_max").click(function(){
                    $("#panel_filter .panel-body").show();
                    $("#action_min").show();
                    $("#action_max").hide();
                });


                $("#action_min").trigger("click");

            },
            loadDataTable: function(){
                var self = this;
                self.$table.dataTable({
                    responsive: true,
                    searchDelay: 1000,
                    bJQueryUI: false,
                    bAutoWidth: false,
                    //bProcessing: true,
                    bServerSide: true,
                    bSort: false,
                    sPaginationType: "full_numbers",
                    iDisplayLength: 25,
                    sDom: '<"datatable-header"fl><"datatable-scroll"tr><"datatable-footer"ip>',
                    sAjaxSource: "/adm_feria/solicitudes",
                    sServerMethod: "POST",
                    fnServerParams: function (aoData)
                    {
                        bloqueointerface();
                        var carreras = $('[name="carreras"]').val();
                        aoData.push(
                            {"name": "action", "value": 'loadDataTable'},
                            {"name": "id", "value": '{{eCronogramaFeria.id|encrypt }}'},
                            {"name": "carreras", "value": carreras},
                        );
                    },
                    aoColumnDefs:
                        [
                            {
                                aTargets: [0],
                                width: "30%",
                                mRender: function (data, type, row)
                                {
                                    let html  = `
                                            ${data}<br>
                                            <b>Solictante:</b>
                                            <a title="${row[3]['solicitante']['name']}" href="${row[3]['solicitante']['foto']}" class="fancybox" rel="group">
                                                 <img src="${row[3]['solicitante']['foto']}" class="img-circle" width="30px">
                                            </a> <span>${row[3]['solicitante']['name']}</span> <br>
                                                <b>Contacto:</b>
                                             <span>${row[3]['solicitante']['correo']} - ${row[3]['solicitante']['celular']}
                                                <a href='https://web.whatsapp.com/send?l=en&phone=+593${row[3]['solicitante']['celular']}&text=Hola ${row[3]['solicitante']['name']}'
                                                               target="_blank" class="btn btn-mini btn-success tu"
                                                               title="Enviar mensaje por whatsapp">
                                                                <i class="fa fa-whatsapp"></i>
                                                            </a>
                                            </span> <br>
                                                <b>Carrera:</b>
                                             <span>${row[3]['solicitante']['carrera']}</span> <br>
                                            <b>Tutor:</b>
                                            <a title="${row[3]['tutor']['name']}" href="${row[3]['tutor']['foto']}" class="fancybox" rel="group">
                                            <img class="img-circle" src="${row[3]['tutor']['foto']}" width="30px">
                                            </a> <span>${row[3]['tutor']['name']}</span>
                                    `
                                    return html;
                                },
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'left');
                                        $(nTd).css('vertical-align', 'middle');
                                        $(nTd).css('padding', '8px');
                                        $(nTd).attr('data-title', '#');
                                    }
                                }
                            },
                            {
                                aTargets: [1],
                                width: "40%",
                                mRender: function (data, type, row)
                                {
                                    let html = `<div id="acordion${row[3]['id']}" class="accordion">
                                        <div class="accordion-group">
                                            <div class="accordion-heading" style="background: #d9edf7">
                                                <span class="accordion-toggle">
                                                    <a class="action-acordion" data-toggle="collapse" data-parent="#acordion${row[3]['id']}" value="${row[3]['id']}">
                                                        <i class="fa fa-tasks fa-fw" aria-hidden="true"></i> Resumen
                                                    </a>
                                                </span>
                                            </div>
                                            <div href="#${row[3]['id']}" class="accordion-body collapse" style="margin: 10px;">
                                                <div class="accordion-heading">
                                                    ${data}
                                                </div>
                                            </div>
                                        </div>
                                    </div>`;
                                    return html;
                                },
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'left');
                                        $(nTd).css('vertical-align', 'middle');
                                        $(nTd).css('padding', '8px');
                                    }
                                }
                            },
                            {
                                aTargets: [2],
                                width: "10%",
                                mRender: function (data, type, row) {
                                    let colour_label =  data.estado != 2 ? data.estado != 3 ? 'warning':'important': 'success';
                                    let aData = row[3]
                                    let html = ``;
                                    html = `<span class="label label-${colour_label}">${data['estado_display']}</span>`;
                                    if(aData.ganador){
                                        html +=  `<br><i class="fa fa-trophy" aria-hidden="true"></i> <b>${aData.puesto}</b>`;
                                    }
                                    if(aData.ganadorfacultad == "2"){
                                        html +=  `<br><i class="fa fa-trophy" aria-hidden="true"></i> <b>GANADOR FACULTAD</b>`;
                                    }
                                    return html
                                },
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center');
                                        $(nTd).css('vertical-align', 'middle');
                                        $(nTd).css('padding', '8px');
                                        $(nTd).attr('data-title', '#');
                                    }
                                }
                            },
                            {
                                aTargets: [3],
                                width: "10%",
                                mRender: function (data, type, row) {
                                    let aData = row[3]
                                    let html = ``;
                                    if (aData.propuesta != null){
                                        html = `
                                                <a class="btn btn-mini btn-info" href="${aData.propuesta}"
                                               target="_blank"><i class="fa fa-file-pdf"></i></a>`;
                                        }else{
                                        html = `
                                                `;
                                    }

                                    return html
                                },
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center');
                                        $(nTd).css('vertical-align', 'middle');
                                        $(nTd).css('padding', '8px');
                                        $(nTd).attr('data-title', '#');
                                    }
                                }
                            },
                            {
                                aTargets: [4],
                                width: "20%",
                                mRender: function (data, type, row)
                                {
                                    let participante = row[2];
                                    return `<input type="hidden" class="dt-col-option" value="${row[3]["id_enc"]}" />
                                            <input type="hidden" class="dt-col-data-name" value="${row[3]["name"]}" estado="${participante.estado}" ganador="${row[3]['ganador']}" ganadorfacultad="${row[3]['ganadorfacultad']}" />`;
                                },
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center')
                                        $(nTd).css('vertical-align', 'middle')
                                        $(nTd).css('padding', '8px')
                                    }
                                }
                            },
                        ]
                    ,
                    fnDrawCallback: function (oSettingst, oData)
                    {
                        desbloqueointerface();
                        var count = 0;

                        $('.accordion').each(function (){
                            $('.action-acordion', $(this)).click(function (){
                                var ref = $(this).attr('value')
                                if ($('[href="#'+ref+'"]').hasClass('in')){
                                    $(this).removeClass('collapsed');
                                    $('[href="#'+ref+'"]').removeClass('in');
                                }else{
                                    $(this).addClass('collapsed');
                                    $('[href="#'+ref+'"]').addClass('in');
                                }
                            });

                        });

                        $('.dt-col-option').each(function(){
                            var id = $(this).val();
                            var data = $(this).data('json');
                            var nombre = $('.dt-col-data-name').eq(count).val();
                            var estado = $('.dt-col-data-name').eq(count).attr('estado');
                            var ganador = $('.dt-col-data-name').eq(count).attr('ganador');
                            var ganadorfacultad = $('.dt-col-data-name').eq(count).attr('ganadorfacultad');
                            var $html = $('#el-templates [element="table-row-actions"] .table-controls').clone();
                            $('.dt-action-view', $html).click(function(){
                                uiModal.open('view', id);
                            });


                            $('.dt-action-edit', $html).click(function(){
                                uiModal.open('edit', id);
                            });

                            if(estado == "3" || estado == "1"){
                                $('.dt-action-change-status-approve', $html).click(function(){
                                    uiModalChangeStatusRequest.open(id,2, nombre);
                                });
                            }else{
                                $('.dt-action-change-status-approve', $html).hide();
                            }
                            if(estado == "2" || estado == "1"){
                                $('.dt-action-change-status-deny', $html).click(function(){
                                    uiModalChangeStatusRequest.open(id,3, nombre);
                                });
                            }else{
                                $('.dt-action-change-status-deny', $html).hide();
                            }
                            if(ganadorfacultad == "2"){
                                $('.dt-action-remove-winner-faculty', $html).click(function(){
                                var question = `¿Está seguro de remover al ganador de la facultad <span class="label label-warning">${nombre}</span>?`;
                                    Confirm.question(question, function () {
                                        bloqueointerface();
                                        var aData = {"action": "removeWinnerFaculty", 'id': id}
                                        $.ajax({
                                            type: "POST",
                                            url: "/adm_feria/solicitudes",
                                            data: aData,
                                            success: function(data) {
                                                if (data.result == 'ok') {
                                                    self.$table.dataTable().fnDraw(false);
                                                    NotificationJG.success(data.mensaje)
                                                }
                                                else{
                                                    NotificationJG.error(data.mensaje);
                                                }
                                                desbloqueointerface();
                                            },
                                            error: function() {
                                                desbloqueointerface();
                                                NotificationJG.error("Error al enviar los datos.");
                                            },
                                            dataType: "json",
                                        });
                                    }, function () {
                                        NotificationJG.info("Enhorabuena el registro esta salvado.!");
                                        {#var h = $(window).height() - 350;#}
                                        {#$('#modalConfirmAjax').modal({backdrop: 'static', keyboard: false, width: "60%", height: h}).modal('show');#}
                                    });
                            });
                                $('.dt-action-declare-winner-faculty', $html).hide();
                            }else{
                                $('.dt-action-declare-winner-faculty', $html).click(function () {
                                    uiModalDeclareWinnerFaculty.open(id, nombre);
                                })
                                $('.dt-action-remove-winner-faculty', $html).hide();
                            }
                            if(eval(ganador)){
                                $('.dt-action-remove-winner', $html).click(function(){
                                var question = `¿Está seguro de remover al ganador <span class="label label-warning">${nombre}</span>?`;
                                    Confirm.question(question, function () {
                                        bloqueointerface();
                                        var aData = {"action": "removeWinner", 'id': id}
                                        $.ajax({
                                            type: "POST",
                                            url: "/adm_feria/solicitudes",
                                            data: aData,
                                            success: function(data) {
                                                if (data.result == 'ok') {
                                                    self.$table.dataTable().fnDraw(false);
                                                    NotificationJG.success(data.mensaje)
                                                }
                                                else{
                                                    NotificationJG.error(data.mensaje);
                                                }
                                                desbloqueointerface();
                                            },
                                            error: function() {
                                                desbloqueointerface();
                                                NotificationJG.error("Error al enviar los datos.");
                                            },
                                            dataType: "json",
                                        });
                                    }, function () {
                                        NotificationJG.info("Enhorabuena el registro esta salvado.!");
                                        {#var h = $(window).height() - 350;#}
                                        {#$('#modalConfirmAjax').modal({backdrop: 'static', keyboard: false, width: "60%", height: h}).modal('show');#}
                                    });
                            });
                                $('.dt-action-declare-winner', $html).hide();
                            }else{
                                $('.dt-action-declare-winner', $html).click(function () {
                                    uiModalDeclareWinner.open(id, nombre);
                                })
                                $('.dt-action-remove-winner', $html).hide();
                            }

                            count ++;
                            $(this).after( $html );
                        });
                    }

                });
                $("#dtViewGroups_filter input").unbind(); // 'x' es el nombre de tu tabla
                $('#dtViewGroups_filter input').bind('keyup', function (e) {
                    if (e.keyCode == 13) {
                        self.$table.dataTable().fnFilter(this.value);
                    }
                });
            }

        };
        var uiModal = {
            init: function () {
                var self = this;
                self.$modalForm = $('#modalSolicitudFeria');
                $('.action-close', self.$modalForm).click(function(){
                    self.close();
                });
                $('.action-edit', self.$modalForm).click(function(){
                    //self.setFormReadOnly(false);
                    self.setFormType('edit');
                });
                $('.action-save', self.$modalForm).click(function (){
                    self.actionSave();
                });
            },
            processModalInit: function (){
                var self = this;
                //$("#formmodalChangeStatusRequest", self.$modalForm).validationEngine({autoHidePrompt:true, autoHideDelay:1000 });
                $(".action_remove_permission", self.$modalForm).click(function(){
                    var id = $(this).attr('value');
                    var question = `¿Está seguro de quitar el permiso <span class="label label-warning">${$('td:nth-child(2)', $(this).closest('tr')).text()}</span>?`;
                    Confirm.question(question, function (){
                        $("#dataPermissions tbody tr", self.$modalForm).each(function(){
                            var _id = $(this).attr('value');
                            if (id == _id)
                            {
                                $(this).remove();
                                NotificationJG.warning(`Se quito correctamente el permiso`)
                            }
                        });
                    });

                });
                $(".action_new_permission", self.$modalForm).click(function (){
                    var permissions = []
                    $("#dataPermissions tbody tr", self.$modalForm).each(function(){
                        var id = $(this).attr('value');
                        permissions.push(id);

                    });
                    permissions = JSON.stringify(permissions);
                    uiPermissionsModal.open(permissions);
                });

                $(".action_new_carrera", self.$modalForm).click(function (){
                    var carreras = []
                    $("#dataCarreras tbody tr", self.$modalForm).each(function(){
                        var id = $(this).attr('value');
                        carreras.push(id);

                    });
                    carreras = JSON.stringify(carreras);
                    uiCarrerasModal.open(carreras);
                });

            },
            close: function (){
                var self = this;
                self.$modalForm.modal('hide');
            },
            open: function(type, id, isEdit/*=undefined*/){

                bloqueointerface();
                isEdit = typeof isEdit == 'undefined' ? false : isEdit;
                var self = this;
                self.setFormType(type);
                if (isEdit) {
                    $('.action-edit', self.$modalForm).addClass('disabled').hide();
                    $('.action-save', self.$modalForm).addClass('disabled').hide();

                }
                var h = $(window).height()-450;
                $.ajax({
                    type: "GET",
                    url: "/adm_feria/solicitudes",
                    data: {'action': 'loadFormRequestFair', 'typeForm': type, 'id': id},
                    success: function(data) {
                        if (data.result == 'ok') {
                            desbloqueointerface();
                            $(".modal-body", self.$modalForm).html(data.html);
                            var h = $(window).height() - 150;
                            self.$modalForm.modal({backdrop:'static', width: '80%', height: h}).modal('show');
                             self.processModalInit();
                        } else {
                            desbloqueointerface();
                            NotificationJG.error(data.mensaje);
                        }
                    },
                    error: function() {
                        desbloqueointerface();
                        NotificationJG.error("Error al enviar los datos.");
                    },
                    dataType: "json",
                });
            },
            setFormType: function( type /* new, edit, view */ )
            {
                var self = this;

                if( type == 'new' )
                {
                    $('.modal-header span', self.$modalForm).html('Nuevo');

                    $('.action-save', self.$modalForm).show();
                    $('.action-edit', self.$modalForm).hide();
                    self.setFormReadOnly(false);
                }
                else if( type == 'edit' )
                {
                    $('.modal-header span', self.$modalForm).html('Editar');

                    $('.action-save', self.$modalForm).show();
                    $('.action-edit', self.$modalForm).hide();
                    self.setFormReadOnly(false);
                }
                else if( type == 'view' )
                {
                    $('.modal-header span', self.$modalForm).html('Ver');

                    $('.action-save', self.$modalForm).hide();
                    $('.action-edit', self.$modalForm).show();
                    self.setFormReadOnly(true);
                }
            },
            setFormReadOnly: function( isFormReadOnly )
            {
                var self = this;

                $('[name="name"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="name"]', self.$modalForm).prop('readonly', isFormReadOnly);

                 if ((!isFormReadOnly))
                {
                    $(".action_new_carrera", self.$modalForm).css("display", "");
                    $(".action_remove_carrera", self.$modalForm).css("display", "");
                }

            },
            formGetData:function(){
                var self = this;
                var data = {}
                data['id'] = $('[name="id"]', self.$modalForm).val();
                data['action'] = $('[name="action"]', self.$modalForm).val();
                data['objetivo'] = $('[name="objetivo"]', self.$modalForm).val();
                data['fechainicio'] = $('[name="fechainicio"]', self.$modalForm).val();
                data['fechafin'] = $('[name="fechafin"]', self.$modalForm).val();
                data['fechainicioinscripcion'] = $('[name="fechainicioinscripcion"]', self.$modalForm).val();
                data['fechafininscripcion'] = $('[name="fechafininscripcion"]', self.$modalForm).val();
                var carreras = []
                $("#dataCarreras tbody tr", self.$modalForm).each(function(){
                    var id = $(this).attr('value');
                    carreras.push(id);

                });
                data['carreras'] = JSON.stringify(carreras);

                return data;
            },
            actionSave: function (){
                var self = this;
                var valid = $("#frmCronograma").validationEngine('validate');
                {#var valid = $("#frmGrupo", self.$modalForm).validationEngine('validate', { scroll: false });#}
                if (!valid){
                    return false;
                }
                $('.datepicker').css({"display": "none"});
                $('.bootstrap-timepicker-widget').css({"display": "none"});

                $('.controls input').each(function(){
                    if ($(this).attr('type')=='text'){
                        $(this).val($(this).val().trim());
                    }
                    if ($(this).attr('type')!='file'){
                        if ($(this).css('text-transform')=='uppercase'){
                            if ($(this).attr('type')!='password'){
                                $(this).val($(this).val().toUpperCase());
                            }
                        }
                    }
                });
                var aData = self.formGetData();
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/adm_feria",
                    data: aData,
                    success: function(data) {
                        if (data.result == 'ok') {
                            ControllerUsers.$table.dataTable().fnDraw(false);
                            self.close();
                            NotificationJG.success(data.mensaje);
                        }
                        else{
                            NotificationJG.error(data.mensaje);
                        }
                        desbloqueointerface();
                    },
                    error: function() {
                        desbloqueointerface();
                        NotificationJG.error("Error al enviar los datos.");
                    },
                    dataType: "json",
                });
            },
        };
        var uiModalChangeStatusRequest  = {
            init: function () {
                var self = this;
                self.$modalForm = $('#modalChangeStatusRequest');
                self.$table = $('.datatable table');
                self.$puede_guardar  = false;
                self.$id  = '';
                self.$estado  = 0;
                $('.action-close', self.$modalForm).click(function(){
                    NotificationJG.info("Enhorabuena el registro esta salvado.!");
                    self.close();
                });
                $('.action-edit', self.$modalForm).click(function(){
                    //self.setFormReadOnly(false);
                    self.setFormType('edit');
                });
                $('.action-save', self.$modalForm).click(function (){
                    self.actionSave();
                });
                $('#observacion', self.$modalForm).change(function (){
                    self.change_yes(this);
                });
            },
            open: function (id, current_status, name_span) {
                var self = this;
                self.$id = id;
                self.$estado=current_status;
                bloqueointerface();
                let htmlquestion =`<b>Información <br>¿Está seguro de aprobar la solicitud de Feria ?</b><br><span class="label label-warning">${name_span}</span> `;
                if(current_status === 3){
                     htmlquestion =`<b>Información <br>¿Está seguro de rechazar la solicitud de Feria?</b><br> <span class="label label-warning">${name_span}</span>`;
                }
                $('#message-question', self.$modalForm).html(htmlquestion);
                setTimeout(function(){
                    desbloqueointerface();
                    self.$modalForm.modal({backdrop:'static', width: '40%', keyboard: false}).modal('show');
                }, 1000);
            },
            close: function () {
                var self = this;
                self.$modalForm.modal('hide');
            },
            actionSave: function(){
                var self = this;
                if(self.$puede_guardar){
                    bloqueointerface();
                    let aData = {"action": "changeStatusRequest", 'id': self.$id, 'estado':self.$estado, 'observacion': $('#observacion', self.$modalForm).val()}
                    $.ajax({
                        type: "POST",
                        url: "/adm_feria/solicitudes",
                        data: aData,
                        success: function(data) {
                            desbloqueointerface();
                            if (data.result == 'ok') {
                                self.$table.dataTable().fnDraw(false);
                                self.close();
                                NotificationJG.success(data.mensaje);
                            }
                            else{
                                NotificationJG.error(data.mensaje);
                            }
                        },
                        error: function() {
                            desbloqueointerface();
                            NotificationJG.error("Error al enviar los datos.");
                        },
                        dataType: "json",
                    });
                }else{
                    NotificationJG.error("Debe llenar el campo observación.!");
                };
            },
            change_yes: function (elemento) {
                var self = this;
                if(elemento.value){
                    self.$puede_guardar=true;
                }else{
                    self.$puede_guardar=false;
                }
            }
        }


        var uiModalDeclareWinner = {
            init: function () {
                var self = this;
                self.$modalForm = $('#modalDeclareWinner');
                self.$table = $('.datatable table');
                $('.action-close', self.$modalForm).click(function(){
                    NotificationJG.info("Enhorabuena el registro esta salvado.!");
                    self.close();
                });
                $('.action-edit', self.$modalForm).click(function(){
                    //self.setFormReadOnly(false);
                    self.setFormType('edit');
                });
                $('.action-save', self.$modalForm).click(function (){
                    self.actionSave();
                });
            },
            open: function (id, name_span) {
                var self = this;
                self.$id = id;
                //self.$estado=current_status;
                bloqueointerface();
                let htmlquestion =`<b>Información <br>¿Está seguro de declarar como ganador al siguiente proyecto?</b><br><span class="label label-warning">${name_span}</span> `;
                $('#message-question', self.$modalForm).html(htmlquestion);
                setTimeout(function(){
                    desbloqueointerface();
                    self.$modalForm.modal({backdrop:'static', width: '40%', keyboard: false}).modal('show');
                }, 1000);
            },
            close: function () {
                var self = this;
                self.$modalForm.modal('hide');
            },
            actionSave: function(){
                var self = this;
                let puesto = $('#puesto', self.$modalForm).val();
                if(puesto){
                    bloqueointerface();
                    let aData = {"action": "declareWinner",
                                'id': self.$id,
                                'puesto':puesto}
                    $.ajax({
                        type: "POST",
                        url: "/adm_feria/solicitudes",
                        data: aData,
                        success: function(data) {
                            desbloqueointerface();
                            if (data.result == 'ok') {
                                self.$table.dataTable().fnDraw(false);
                                self.close();
                                NotificationJG.success(data.mensaje);
                            }
                            else{
                                NotificationJG.error(data.mensaje);
                            }
                        },
                        error: function() {
                            desbloqueointerface();
                            NotificationJG.error("Error al enviar los datos.");
                        },
                        dataType: "json",
                    });
                }else{
                    NotificationJG.error("Debe llenar el campo puesto!");
                };
            }
        }

        var uiModalDeclareWinnerFaculty = {
            init: function () {
                var self = this;
                self.$modalForm = $('#modalDeclareWinnerFaculty');
                self.$table = $('.datatable table');
                $('.action-close', self.$modalForm).click(function(){
                    NotificationJG.info("Enhorabuena el registro esta salvado.!");
                    self.close();
                });
                $('.action-edit', self.$modalForm).click(function(){
                    //self.setFormReadOnly(false);
                    self.setFormType('edit');
                });
                $('.action-save', self.$modalForm).click(function (){
                    self.actionSave();
                });
            },
            open: function (id, name_span) {
                var self = this;
                self.$id = id;
                //self.$estado=current_status;
                bloqueointerface();
                let htmlquestion =`<b>Información <br>¿Está seguro de declarar como ganador de la facultad al siguiente proyecto?</b><br><span class="label label-warning">${name_span}</span> `;
                $('#message-question', self.$modalForm).html(htmlquestion);
                setTimeout(function(){
                    desbloqueointerface();
                    self.$modalForm.modal({backdrop:'static', width: '40%', keyboard: false}).modal('show');
                }, 1000);
            },
            close: function () {
                var self = this;
                self.$modalForm.modal('hide');
            },
            actionSave: function(){
                var self = this;
                bloqueointerface();
                let aData = {"action": "declareWinnerFaculty",
                            'id': self.$id}
                $.ajax({
                    type: "POST",
                    url: "/adm_feria/solicitudes",
                    data: aData,
                    success: function(data) {
                        desbloqueointerface();
                        if (data.result == 'ok') {
                            self.$table.dataTable().fnDraw(false);
                            self.close();
                            NotificationJG.success(data.mensaje);
                        }
                        else{
                            NotificationJG.error(data.mensaje);
                        }
                    },
                    error: function() {
                        desbloqueointerface();
                        NotificationJG.error("Error al enviar los datos.");
                    },
                    dataType: "json",
                });
            }
        }


        $(function() {
            uiModalChangeStatusRequest.init();
            ControllerRequests.init();
            uiModal.init();
            uiModalDeclareWinner.init();
            uiModalDeclareWinnerFaculty.init();

            $('#generateCertificatesParticipants').click(function (){
                Swal.fire({
                    html: "¿Está segur{% if persona.sexo.id == 1 %}a{% else %}o{% endif %} de generar de forma masiva los certificados de participación del cronograma  <label class='badge badge-warning'>{{ eCronogramaFeria.objetivo }}</label>?",
                    type: 'info',
                    icon: 'info',
                    showCancelButton: true,
                    allowOutsideClick: false,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'SI,SEGUR{% if persona.sexo.id == 1 %}A{% else %}O{% endif %}',
                    cancelButtonText: 'NO, CANCELAR'
                }).then((result) => {
                    if (result.value) {
                        bloqueointerface();
                        $.ajax({
                            type: "POST",
                            url: "{{ request.path }}",
                            data: {
                                'action': 'generateCertificatesParticipants',
                                'idc': '{{ eCronogramaFeria.id|encrypt }}',
                            },
                            success: function (data) {
                                desbloqueointerface();
                                if (data.result == 'ok') {
                                    NotificationJG.success(data.mensaje);
                                } else {
                                    NotificationJG.error(data.mensaje);
                                }
                            },
                            error: function () {
                                desbloqueointerface();
                                NotificationJG.error('Ocurrio un error inesperado');
                            },
                            dataType: "json"
                        });
                    }else{
                        NotificationJG.info('Ha cancelado');
                    }
                }).catch(error => {
                    desbloqueointerface();
                    NotificationJG.error('Ocurrio un error inesperado');
                });
            });
            $('#generateCertificatesWinners').click(function (){
                Swal.fire({
                    html: "¿Está segur{% if persona.sexo.id == 1 %}a{% else %}o{% endif %} de generar de forma masiva los certificados de ganadores del cronograma  <label class='badge badge-warning'>{{ eCronogramaFeria.objetivo }}</label>?",
                    type: 'info',
                    icon: 'info',
                    showCancelButton: true,
                    allowOutsideClick: false,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'SI,SEGUR{% if persona.sexo.id == 1 %}A{% else %}O{% endif %}',
                    cancelButtonText: 'NO, CANCELAR'
                }).then((result) => {
                    if (result.value) {
                        bloqueointerface();
                        $.ajax({
                            type: "POST",
                            url: "{{ request.path }}",
                            data: {
                                'action': 'generateCertificatesWinners',
                                'idc': '{{ eCronogramaFeria.id|encrypt }}',
                            },
                            success: function (data) {
                                desbloqueointerface();
                                if (data.result == 'ok') {
                                    NotificationJG.success(data.mensaje);
                                } else {
                                    NotificationJG.error(data.mensaje);
                                }
                            },
                            error: function () {
                                desbloqueointerface();
                                NotificationJG.error('Ocurrio un error inesperado');
                            },
                            dataType: "json"
                        });
                    }else{
                        NotificationJG.info('Ha cancelado');
                    }
                }).catch(error => {
                    desbloqueointerface();
                    NotificationJG.error('Ocurrio un error inesperado');
                });
            });
            $('#generateFirma').click(function (){
                Swal.fire({
                    html: "¿Está segur{% if persona.sexo.id == 1 %}a{% else %}o{% endif %} de generar firma electronica?",
                    type: 'info',
                    icon: 'info',
                    showCancelButton: true,
                    allowOutsideClick: false,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'SI,SEGUR{% if persona.sexo.id == 1 %}A{% else %}O{% endif %}',
                    cancelButtonText: 'NO, CANCELAR'
                }).then((result) => {
                    if (result.value) {
                        bloqueointerface();
                        $.ajax({
                            type: "GET",
                            url: "{{ request.path }}",
                            data: {
                                'action': 'firmavistaprevia',
                                'idc': '{{ eCronogramaFeria.id|encrypt }}',
                            },
                            success: function (data) {
                                desbloqueointerface();
                                if (data.result == 'ok') {
                                    window.open(data.url, '_blank');
                                    NotificationJG.success(data.mensaje);
                                } else {
                                    NotificationJG.error(data.mensaje);
                                }
                            },
                            error: function () {
                                desbloqueointerface();
                                NotificationJG.error('Ocurrio un error inesperado');
                            },
                            dataType: "json"
                        });
                    }else{
                        NotificationJG.info('Ha cancelado');
                    }
                }).catch(error => {
                    desbloqueointerface();
                    NotificationJG.error('Ocurrio un error inesperado');
                });
            });
        });
    </script>
{% endblock %}
{% block canvas %}
    <div class='row-fluid'>
        <div class='span8'>
            <div>
                <h4>{{ title }}</h4> <br>
                <h3>CRONOGRAMA:</h3> <p>{{ eCronogramaFeria }}</p>
                {% if perms.feria.puede_generar_certificadosparticipacion_feria %}
                    <a href="javascript:;" class="btn btn-success" id="generateCertificatesParticipants">Generar certificados de participación</a>
                {% endif %}
                {% if perms.feria.puede_generar_certificadosganador_feria %}
                    <a href="javascript:;" class="btn btn-success" id="generateCertificatesWinners">Generar certificados de Ganadores</a>
{#                    <a href="javascript:;" class="btn btn-success" id="generateFirma">Generar Firma</a>#}
                {% endif %}
                <div class="btn-group" style="margin-top: 4px;">
                    <a class="btn btn-primary dropdown-toggle" data-toggle="dropdown" href="javascript:;"><i class="fa fa-download" aria-hidden="true"></i>
                        Reportes <span class="caret"></span></a>
                    <ul class="dropdown-menu pull-left" style="width: 300px;">
                        <li>
                            <a href="{{ request.path }}?id={{ id }}&action=reportParticipants"><i class="fa fa-file-excel-o" aria-hidden="true"></i> Participantes</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="span4">
            <div class="panel panel-sga" id="panel_filter">
                <div class="panel-heading">
                    <h3 class="panel-title">Filtro</h3>
                    <div class="pull-right">
                        <a style="margin-right: 5px" href="javascript:;" class='btn btn-mini btn-info tu' id="action_min" title="Minimizar"><span class="fa fa-minus"></span></a>
                        <a style="margin-right: 5px" href="javascript:;" class='btn btn-mini btn-info tu' id="action_max" title="Maximizar"><span class="fa fa-plus"></span></a>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="row-fluid">
                        <div class="span3"><b>Carrera:</b></div>
                        <div class="span9">
                            <select name="carreras" style="width: 100%;">
                                <option value="0" selected="selected">--TODOS--</option>
                                {% for t in carreras %}
                                    <option value="{{ t.id }}">{{ t.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="no-more-tables">
        <div class='row-fluid'>
            <div class='span12'>
                <div class="datatable" id="divDetailData">
                    <table id="dtViewRequests" class='table table-bordered table-striped'>
                        <thead>
                        <tr>
                            <th style="text-align: center; vertical-align: middle; width: 30%" class="hidden-phone hidden-tablet">Titulo</th>
                            <th style="text-align: center; vertical-align: middle; width: 40%">Resumen</th>
                            <th style="text-align: center; vertical-align: middle; width: 10%">Estado</th>
                            <th style="text-align: center; vertical-align: middle; width: 10%">Propuesta</th>
                            <th style="text-align: center; vertical-align: middle; width: 10%"></th>
                        </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div id="el-templates" style="display:none;">
        <div element="table-row-actions">
            <table>
                <tbody>
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>
                        <div class="table-controls">
                            <div class="btn-group">
                                <a class="btn btn-mini dropdown-toggle" data-toggle="dropdown" href="javascript:;">Acciones<span class="caret"></span>
                                </a>
                                <ul class="dropdown-menu pull-right" style="text-align: left">
                                    <li><a href="javascript:;" class="dt-action-view"><i class="fa fa-eye"></i> Ver</a></li>
                                    {% if perms.feria.puede_gestionar_solicitudesferia %}
                                        <li><a href="javascript:;" class="dt-action-change-status-approve"><i class="fa fa-check"></i> Aprobar</a></li>
                                        <li><a href="javascript:;" class="dt-action-change-status-deny"><i class="fa fa-close"></i> Rechazar</a></li>
                                        <li><a href="javascript:;" class="dt-action-declare-winner"><i class="fa fa-medal"></i> Declarar ganador</a></li>
                                        <li><a href="javascript:;" class="dt-action-remove-winner"><i class="fa fa-trash"></i> Remover ganador</a></li>
                                        <li><a href="javascript:;" class="dt-action-declare-winner-faculty"><i class="fa fa-medal"></i> Declarar ganador facultad</a></li>
                                        <li><a href="javascript:;" class="dt-action-remove-winner-faculty"><i class="fa fa-trash"></i> Remover ganador facultad</a></li>
                                    {% endif %}

{#                                    {% if perms.feria.puede_eliminar_cronogramaferia %}#}
{#                                        <li><a href="javascript:;" class="dt-action-delete"><i class="fa fa-trash"></i> Eliminar</a></li>#}
{#                                    {% endif %}#}
                                </ul>
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="modal fade static" id="modalSolicitudFeria" style="display: none;">
        <div class="modal-header">
            <h4 class="paneltitle"><span></span> Solicitud Feria</h4>
        </div>
        <div class="modal-body panelbody">

        </div>
        <div class="modal-footer">
{#            {% if perms.bd.puede_modificar_grupo %}#}
{#                <a href="javascript:;" class="btn btn-success action-save">Guardar</a>#}
{#                <a href="javascript:;" class="btn btn-info action-edit">Editar</a>#}
{#            {% endif %}#}
            <a href="javascript:;" class="btn btn-default action-close"> Cerrar</a>
        </div>
    </div>

<div class="modal fade static" id="modalChangeStatusRequest" style="display: none;">
    <div class="modal-header">
        <h4 id="justificacionpaneltitle">Confirmaci&oacute;n</h4>
    </div>
    <div class="modal-body">
        <form action="javascript:;" id="formmodalChangeStatusRequest">
            <div id="message-question"></div>
            <br>
            <label class="observacion" required>Observación:</label><br>
            <input type="text" style="text-transform: uppercase" class="input-block-level" id="observacion">
        </form>
    </div>
    <div class="modal-footer">
        <a  href="javascript:;"  class="btn btn-danger action-save">SI</a>
        <a  href="javascript:;"  class="btn btn-info action-close">NO</a>
    </div>
</div>

<div class="modal fade static" id="modalDeclareWinner" style="display: none;">
    <div class="modal-header">
        <h4 id="justificacionpaneltitle">Confirmaci&oacute;n</h4>
    </div>
    <div class="modal-body">
        <form action="javascript:;" id="formmodalDeclareWinne">
            <div id="message-question"></div>
            <br>
            <label class="puesto" required>Puesto:</label><br>
            <input type="text" style="text-transform: uppercase" class="input-block-level" id="puesto">
        </form>
    </div>
    <div class="modal-footer">
        <a  href="javascript:;"  class="btn btn-danger action-save">SI</a>
        <a  href="javascript:;"  class="btn btn-info action-close">NO</a>
    </div>
</div>

<div class="modal fade static" id="modalDeclareWinnerFaculty" style="display: none;">
    <div class="modal-header">
        <h4 id="justificacionpaneltitle">Confirmaci&oacute;n</h4>
    </div>
    <div class="modal-body">
        <form action="javascript:;" id="formmodalDeclareWinneFaculty">
            <div id="message-question"></div>
        </form>
    </div>
    <div class="modal-footer">
        <a  href="javascript:;"  class="btn btn-danger action-save">SI</a>
        <a  href="javascript:;"  class="btn btn-info action-close">NO</a>
    </div>
</div>
{% endblock %}
