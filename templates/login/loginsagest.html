{% extends 'login/base.html' %}

{% block heading %}
    {% if validar_con_captcha %}
        <script src='https://www.google.com/recaptcha/api.js'></script>
        <link rel="stylesheet" href="/static/css/captcha/chaptcha_response.css" type="text/css" media="screen"/>
    {% endif %}
    <script type="text/javascript">
        {% if validar_con_captcha %}
            var checkRecaptcha = function () {
                res = $('#g-recaptcha-response').val();
                if (res === "" || res === undefined || res.length === 0)
                    return false;
                else
                    return true;
            };
        {% endif %}

        $(function () {
            $("#username").focus();
            $("#user").blur(function () {
                $(this).val($(this).val().trim());
            });
            $("#pass, #user").keydown(function () {
                $("#errormensaje").hide();
            });
            
            $(".tl").tooltip({position: "center up"});
            
            {#$("#login").click(function () {#}
            {#    login();#}
            {# });#}
            {#            $('#user, #pass').keyup(function(e) {#}
            {#                if(e.keyCode == 13) {#}
            {#                    login();#}
            {#                }#}
            {#            });#}

        });
    </script>
    <link rel="stylesheet" href="/static/modaltour.css?0.1">
    <style>
        .rc-anchor-light {
            background: #ffffff;
        !important;
            color: #000;
        }

        .rc-anchor {
            border-radius: 16px;
            box-shadow: 0 0 4px 1px rgb(0 0 0 / 8%);
            -webkit-box-shadow: 0 0 4px 1px rgb(0 0 0 / 8%);
            -moz-box-shadow: 0 0 4px 1px rgba(0, 0, 0, 0.08);
        }

        .panel_logo {
            border-radius: 0.25rem;
            /* box-shadow: 0 1px 3px rgb(0 0 0 / 12%), 0 1px 2px rgb(0 0 0 / 24%); */
            background-color: #fff;
            border-left: 5px solid #e9ecef;
            margin-bottom: 1rem;
            border-left-color: #FE9900;
            /* padding: 1rem; */
            line-height: 21px;
            width: 350px;
            font-size: 20px;
        }

        .lista_actividades {
        {#padding-left: 12px;#} list-style: none;
            text-align: left;
            width: 345px;
            font-size: 13px;
        }

        @media (min-width: 768px) and (max-width: 979px) {
            .lista_actividades {
                padding-left: 0;
                list-style: none;
                text-align: left;
                width: 345px;
            }
        }

        .formulariologin {
            height: 400px;
        }

        @media (min-width: 768px) and (max-width: 979px) {
            .formulariologin {
                height: 520px;
            }
        }


        @media (max-width: 767px) and (max-width: 992px) and (max-width: 1200px) {
            .formulariologin {
                height: 578px;
            }
        }

        .recaptchainput {
            margin-left: 141px;
        }

        @media (min-width: 768px) and (max-width: 979px) {
            .recaptchainput {
                margin-left: 241px;
            }
        }


        @media (max-width: 767px) and (max-width: 992px) and (max-width: 1200px) {
            .recaptchainput {
                margin-left: 18%;
            }
        }

    </style>
    <script>
        $(function () {
            $('.recuperardatos').on('click', function () {
                $("#iddocumentopass").val("");
                $(".panelPass").prop("hidden", false);
                $(".panelPassConf").prop("hidden", true);
                $('#modalRecuperarDatos').modal('show')
            })

            buscar = function () {
                var busqueda = $("#iddocumentopass").val();
                if (busqueda.trim().length > 0) {
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/recoverypassword",
                        data: {"action": "searchSGA", "documento": busqueda},
                        success: function (data) {
                            $.unblockUI();
                            if (data.result === "ok") {
                                console.log(data)
                                $(".panelPassConf").prop("hidden", false);
                                $(".panelPass").prop("hidden", true);
                                $("#nombrepersona").html(data.user);
                                if (data.permisoboton === "0") {
                                    $("#generar").hide();
                                    $("#visualizar").show();
                                    $("#cambioclave").attr('value', 0)
                                } else {
                                    $("#generar").show();
                                    $("#visualizar").hide();
                                    $("#cambioclave").attr('value', data.id)
                                }

                            } else {
                                alertaDanger(data.mensaje)
                            }
                        },
                        error: function () {
                            $.unblockUI();
                            alertaWarning('No se pudo realizar la consulta')
                        },
                        dataType: "json"
                    });
                } else {
                    $("#iddocumentopass").focus();
                }
            };

            $("#busqueda").click(function () {
                buscar();
            });

            $("#cambioclave").click(function () {
                var usuario = $("#iddocumentopass").val();
                var id = $(this).attr('value');
                console.log(id)
                console.log(usuario)
                if (usuario.trim().length > 0) {
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/recoverypassword",
                        data: {"action": "generatepassword", "id": id, "app": 1},
                        success: function (data) {
                            $.unblockUI();
                            if (data.result === "ok") {
                                mensajeSuccess('Revise su bandeja de correo  para completar la solicitud', 'Proceso Exitoso')
                            } else {
                                alertaDanger(data.mensaje)
                            }
                        },
                        error: function () {
                            $.unblockUI();
                            alertaDanger("Error al enviar la solicitud.");
                        },
                        dataType: "json"
                    });
                } else {
                    $("#datos").focus();
                }

            });

        })
    </script>
    <style>
        .input-group > :not(:first-child):not(.dropdown-menu):not(.valid-tooltip):not(.valid-feedback):not(.invalid-tooltip):not(.invalid-feedback) {
            border-bottom-left-radius: 0;
            border-top-left-radius: 0;
            margin-left: -2px;
        !important:;
        }
                #video {
            border: 1px solid black;
            transform: scaleX(-1); /* Esto invierte el video horizontalmente */
        }

        #canvas {
            display: none;
        }

        .video-container {
            position: relative;
            padding-bottom: 70%; /* Relación de aspecto 4:3 (480/640 * 100) */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background: #000;
            width: 100%;
        }

        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1); /* Esto también invierte el video */
        }
    </style>
    <script src="/static/bootstrap-show-password/dist/bootstrap-show-password.js"></script>
{% endblock %}
{% block extraJs %}
    {% include 'adm_registro_marcadas/utils_info.html' %}
    <script type="application/javascript">
        const login = async () => {
            var capipprivada = jscd.ip;
            var navegador = jscd.browser + ' ' + jscd.browserMajorVersion;
            var os = jscd.os + ' ' + jscd.osVersion;
            var cookies = jscd.cookies;
            var screensize = jscd.screen;
            bloqueointerface()
            $("#login").attr({"disabled": "disabled"});
            $.ajax({
                type: "POST",
                url: "/loginsagest",
                data: {
                    'action': 'login',
                    'capippriva': capipprivada,
                    'navegador': navegador,
                    'os': os,
                    'cookies': cookies,
                    'screensize': screensize,
                    'user': $("#user").val(),
                    'pass': $("#pass").val(),
                    'next':  $("#next").val(),
                    'g-recaptcha-response': $("#g-recaptcha-response").val()
                },
                success: function (data) {
                    $.unblockUI();
                    if (data.result === 'ok') {
                        localStorage.clear();
                        localStorage.setItem('sessionid', data.sessionid);
                        window.name = data.sessionid;
                        {#location.href = "/loginsga";#}
                        location.href = data.url_redirect;
                    } else {
                        $("#login").removeAttr('disabled');
                        {#$("#errormensaje").html(data.mensaje).show();#}
                        alertaWarning(data.mensaje);
                        {% if validar_con_captcha %}
                            grecaptcha.reset();
                        {% endif %}
                    }
                },
                error: function () {
                    $.unblockUI();
                    $("#login").removeAttr('disabled');
                    alertaWarning('Error al enviar los datos');
                    {#$("#errormensaje").html('Error al enviar los datos').show();#}
                    {% if validar_con_captcha %}
                        grecaptcha.reset();
                    {% endif %}
                },
                dataType: "json"
            });
        };

        {% if faceid_access %}
            $(async function () {
                $("#intentar_new, #id_intentos_cab").hide();
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                const captureButton = document.getElementById('login');
                const cerrarButton = document.getElementById('cerrar_faceid');
                const intentarNew = document.getElementById('intentar_new');
                const resultText = document.getElementById('result');
                const instructionText = document.getElementById('instructions');
                const cloudFunctionUrl = 'https://us-central1-unemi-biometrico-sga.cloudfunctions.net/analyze_photo';
                let blinkCount = 0;
                let startFaceDetected = false;
                let noDetectFace = 0;
                let camera;
                let ingresoApi=false
                let isProcessing = false; // Nueva variable para controlar el procesamiento
                let detectionStopped = false;
                let lastMovementTime = 0;
                let lastNoseX = null; // Posición anterior de la nariz en X
                let lastNoseY = null; // Posición anterior de la nariz en Y
                let interval;
                const movementThreshold = 0.05; // Umbral para determinar si un movimiento es significativo
   
                const faceMesh = new FaceMesh({
                        locateFile: (file) => {
                            return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                        }
                    });
                startCamera()
    
                function onResults(results) {
                    if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) {
                        noDetectFace++;
                        instructionText.innerText = "No se detectó un rostro. Inténtelo de nuevo.";
                        resultText.classList.add('text-danger');
                        resultText.classList.remove('text-success');
                        stopDetection();
                        if(noDetectFace > 2){
                            instructionText.innerText = "Si la cámara no se visualiza correctamente, te recomendamos utilizar Google Chrome, Microsoft Edge o Safari para garantizar un funcionamiento óptimo del reconocimiento facial. También asegúrate de mantener tu rostro claramente visible frente a la cámara para una correcta detección.";
                        }
                     }
                     if (detectionStopped) {
                        return; // Detiene la detección si está marcada como detenida
                    }
                    resultText.classList.remove('text-danger');
                    if (isProcessing) {
                        // Si estamos esperando que pase el tiempo de espera, no procesamos nada
                        return
                    }
                    const landmarks = results.multiFaceLandmarks[0];
                    const initialBrowDistance = captureInitialBrowDistance(landmarks);
                    const leftEAR = [landmarks[33], landmarks[160], landmarks[158], landmarks[133], landmarks[153], landmarks[144]]
                    const rightEAR = [landmarks[263], landmarks[387], landmarks[385], landmarks[362], landmarks[380], landmarks[373]]
                    const noseX = landmarks[1].x;
                    const noseY = landmarks[1].y;
                    const leftEyeY = landmarks[159].y;
                    const rightEyeY = landmarks[386].y;
                    const mouthLeftX = landmarks[61].x;
                    const mouthRightX = landmarks[291].x;
                    const chinY = landmarks[152].y;
                    const chinX = landmarks[152].x;
                    const mouthTopY = landmarks[13].y;
                    const mouthBottomY = landmarks[14].y;
                    const browLeftX = landmarks[70].x;
                    const browRightX = landmarks[107].x;
    
                    let movementDetected = false;
                    let incorrectMovementDetected = false;
    
    
                    if (lastNoseX !== null && lastNoseY !== null) {
                        // Calcula la magnitud del movimiento
                        const movementMagnitude = Math.sqrt(Math.pow(noseX - lastNoseX, 2) + Math.pow(noseY - lastNoseY, 2));
    
                        // Si el movimiento es significativo y ocurrió en menos de 3 segundos, marcarlo como sospechoso
                        const currentTime = performance.now();
                        if (movementMagnitude > movementThreshold && currentTime - lastMovementTime < 3000) {
                            instructionText.html = "Movimiento sospechoso detectado. <br> Por favor, realice las acciones lentamente."
                            resultText.classList.add('text-danger');
                            return;
                        }
    
                        if (movementMagnitude > movementThreshold) {
                            lastMovementTime = currentTime; // Actualiza el tiempo del último movimiento significativo
                        }
                    }
    
                    lastNoseX = noseX;
                    lastNoseY = noseY;
    
                    if (currentStep < sequence.length) {
                        switch (sequence[currentStep]) {
                            case 'smile':
                                movementDetected = detectSmile(mouthLeftX, mouthRightX);
                                break;
                            case 'blink':
                                movementDetected = detectBlink(leftEAR, rightEAR);
                                break;
                            case 'tiltLeft':
                                movementDetected = detectTiltLeft(noseX, chinX);
                                incorrectMovementDetected = detectTiltRight(noseX, chinX);
                                break;
                            case 'tiltRight':
                                movementDetected = detectTiltRight(noseX, chinX);
                                incorrectMovementDetected = detectTiltLeft(noseX, chinX);
                                break;
                        }
    
                        if (incorrectMovementDetected) {
                            // Resetea la secuencia y notifica al usuario
                            instructionText.innerText = `Movimiento incorrecto detectado.`;
                            resultText.classList.add('text-danger');
                            stopDetection();
                        } else if (movementDetected) {
                            isProcessing = true; // Bloquea la detección de nuevos movimientos
                            paso = currentStep + 1;
                            {#console.log(paso)#}
                            instructionText.innerText = `Paso ${paso} completado. Espere...`;
                            if(paso < 1){
                                setTimeout(() => {
                                    if (!detectionStopped){
                                        currentStep++;
                                        updateInstructions();
                                    }
                                    isProcessing = false; // Desbloquea para el siguiente movimiento
                                }, 2000); // 2000 milisegundos = 2 segundos de retraso
                            }else{
                                currentStep++;
                                updateInstructions();
                                isProcessing = false; // Desbloquea para el siguiente movimiento
                            }
                        }
                    }
    
                    if (currentStep >= sequence.length) {
                        resultText.innerText = 'Prueba de vida completada con éxito';
                        resultText.classList.add('text-success');
                        resultText.classList.remove('text-danger');
                         captureAndSendImage();
                    }
                }
    
                function startCamera(){
                    faceMesh.setOptions({
                        {#maxNumFaces: 1,#}
                        refineLandmarks: true,
                        minDetectionConfidence: 0.5,
                        minTrackingConfidence: 0.5
                    });
                    camera = new Camera(video, {
                        onFrame: async () => {
                            await faceMesh.send({image: video});
                        },
                        width: 640,
                        height: 480
                    });
    
                }
    
                async function startDetection(){
                    await camera.start();
                    faceMesh.onResults(onResults);
                    startCountDetection()
                    detectionStopped = false;
                    $("#intentar_new").hide();
                }
    
                function stopDetection() {
                    stopCountDetection()
                    detectionStopped = true;
    
                    if (camera) {
                        camera.stop(); // Detener la cámara
                    }
    
                    // Detener el flujo de medios (apagar la cámara)
                    if (video.srcObject) {
                        video.srcObject.getTracks().forEach(track => track.stop());
                    }
    
                    // Limpiar el video para liberar recursos
                    video.srcObject = null;
    
                    // Actualizar la interfaz
                    resultText.innerText = "Detección detenida.";
                    resultText.classList.add('text-danger');
                    resultText.classList.remove('text-success');
                    $("#intentar_new").show();
    
                }
    
                function startCountDetection() {
                    const tiempo = document.getElementById('id_time');
                    const duration = 12000;
                    const startTime = performance.now(); // Hora de inicio de la animación
                    interval = setInterval(() => {
                        const elapsedTime = performance.now() - startTime; // Tiempo transcurrido
                        const timeLeft = Math.max(0, duration - elapsedTime); // Tiempo restante en milisegundos
    
                        // Convertir milisegundos a segundos
                        const secondsLeft = Math.ceil(timeLeft / 1000);
    
                        {#console.log(timeLeft)#}
                        // Actualizar la etiqueta con el tiempo restante
                        tiempo.textContent = `Tiempo restante: ${secondsLeft} segundos`;
                        if (timeLeft <= 0) {
                            stopDetection();
                            if (!ingresoApi) {
                                $("#intentar_new").show();
                            }
                        }
                    }, 1000);
                }

                function stopCountDetection() {
                    clearInterval(interval); // Detener el intervalo usando clearInterval
                }
                
                function validarUser(){
                    bloqueointerface()
                    $.ajax({
                        url: '/api',
                        type: 'GET',
                        data: { 'usuario': $("#user").val(),
                                'password': $("#pass").val(),
                                'profile': 'administrativo',
                                'app': 'sagest',
                                'a': 'validarusuario'},
                        success: function (response) {
                            if (response.result === false){
                                $.unblockUI();
                                alertaWarning(response.mensaje)
                                if(response.tipo === 'usuario'){
                                    $("#user").focus();
                                    $("#helpUsuario").html(response.mensaje);
                                    $("#helpUsuario").addClass('text-danger');
                                    $("#user").addClass('is-invalid');
                                }else{
                                    $("#pass").focus();
                                    $("#helpPassword").html(response.mensaje);
                                    $("#helpPassword").addClass('text-danger');
                                    $("#pass").addClass('is-invalid')
    
                                    $("#helpUsuario").html('');
                                    $("#user").removeClass('text-danger');
                                    $("#user").removeClass('is-invalid');
                                    $("#user").addClass('is-valid');
                                }
                                return false
                            }else{
                                $("#helpPassword, #helpUsuario").removeClass('text-danger').html('');
                                $("#pass, #user").removeClass('is-invalid');
                                 $("#pass, #user").addClass('is-valid');
                                startFaceDetection();
                            }
                        },
                        error: function (xhr, status, error) {
                            $.unblockUI();
                            return false
                            alertaDanger('Error de conexión')
                            // Manejar el error de la consulta AJAX si es necesario
                        }
                    });
                }
                
                function startFaceDetection() {
                    bloqueointerface()
                    
                    if (!startFaceDetected){
                        navigator.mediaDevices.getUserMedia({video: true})
                        .then(stream => {
                            video.srcObject = stream;
                            video.play();
                            video.onloadedmetadata = () => {
                                canvas.width = video.videoWidth;
                                canvas.height = video.videoHeight;
                                startDetection().then(() => {
                                    resetSequence();
                                    setTimeout(() => {
                                       $.unblockUI();
                                        startFaceDetected = true;
                                        formModalFace('Capturar imagen', 'modal-md', false, 'fa fa-camera');
                                    }, 500); // Espera 1 segundo antes de mostrar el modal
                                });
                            };
                        })
                        .catch(err => {
                            console.error("Error de acceso a la camara: ", err);
                            mensajeDangerReload('Error al acceder a la cámara. <br> Por favor verifique los permisos y recargue la pagina.', 'Recargar');
                        }); 
                    }else{
                        $.unblockUI();
                        resultText.innerText = "";
                        resetSequence();
                        startDetection();
                        formModalFace('Capturar imagen', 'modal-md', false, 'fa fa-camera');
                        
                    }
                }
    
                async function captureAndSendImage() {
                    if (isProcessing) return; // Si ya está en proceso, no hacer nada.
                    isProcessing = true;
                    bloqueointerface();
                    ingresoApi = true;
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
                        const dataURL = canvas.toDataURL('image/jpg');
                        const username = $("#user").val().trim().toLowerCase();
                        const payload = JSON.stringify({
                            image: dataURL,
                            cedula: username
                        });
    
                        stopDetection();
                        $('#itemspanelface').modal('hide');
                        fetch(cloudFunctionUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                },
                                body: payload
                            })
                            .then(response => response.json())
                            .then(data => {
                                console.log(data);
                                if (data.status === 'success') {
                                    imgURL = dataURL;
                                    similitud = data.message;
                                    login();
                                } else {
                                    $.unblockUI();
                                    mensajeDangerReload('No se pudo identificar al usuario con la imagen capturada, asegure que sus datos sean correctos y vuelva a intentarlo.')
                                }
                            })
                            .catch(error => {
                                $.unblockUI();
                                console.error('Error:', error);
                                mensajeDangerReload('Ocurrió un error inesperado en la verificación de imagen, por favor recargue la página e intente de nuevo')
                            });
    
                    } else {
                        mensajeDanger('La cámara no está lista. Por favor, inténtelo de nuevo.');
                        isProcessing = false; // Liberar bloqueo
                    }
                }

                const validarCampos = async () => {
                    let usuario = $("#user").val();
                    if (usuario.length === 0) {
                        $("#user").focus();
                        return false;
                    }
                    let clave = $("#pass").val();
                    if (clave.length === 0) {
                        $("#pass").focus();
                        return false;
                    }
                    {% if validar_con_captcha %}
                        if ($("#g-recaptcha-response").length !== 0) {
                            if (!checkRecaptcha()) {
                                $.unblockUI();
                                alertaDanger('Complete el captcha para continuar')
                                return false;
                            }
                        }
                    {% endif %}
                    validarUser();
                    {#startFaceDetection()#}
                }
    
                intentarNew.addEventListener('click', async () => {
                    blinkCount = 0;
                    resultText.innerText = "";
                    resetSequence();
                    startDetection();
                    $("#intentar_new").hide();
                });
    
                captureButton.addEventListener('click', async () => {
                    await validarCampos();
                });
    
                cerrarButton.addEventListener('click', async () => {
                    stopDetection();
                    $('#itemspanelface').modal('hide');
                    {#ingresoApi=false#}
                    {#resultText.innerText = "";#}
                    {#resultText.classList.remove('text-danger');#}
                    {#resultText.classList.remove('text-success');#}
                    {#$("#intentar_new").hide();#}
                    {#bloqueointerface()#}
                    {#location.reload()#}
                });
            });
        {% else %}
            $(function () {
                $("#login").click(function () {
                    let usuario = $("#user").val();
                    if (usuario.length === 0) {
                        $("#user").focus();
                        return false;
                    }
                    let clave = $("#pass").val();
                    if (clave.length === 0) {
                        $("#pass").focus();
                        return false;
                    }
                    {% if validar_con_captcha %}
                        if ($("#g-recaptcha-response").length !== 0) {
                            if (!checkRecaptcha()) {
                                $.unblockUI();
                                alertaDanger('Complete el captcha para continuar')
                                return false;
                            }
                        }
                    {% endif %}
                    login();
                });
            });
        {% endif %}
    </script>
{% endblock %}
{% block canvas %}
    <br>
    <div class="row align-items-center min-vh-80">
        <div class="col-md-6 col-xl-6 col-12 hidden-phone visible-desktop"
             style="padding-left: 7%;border-right: 1px solid #e9ecef; height: 500px;">
            <center>
                {% if DIA_CANCER_MAMA_19_OCTUBRE %}
                    <div id="carouselEventos" class="carousel slide lista_eventos" data-ride="carousel" style="height: 57%;">
                        <div class="carousel-inner" role="listbox">
                            <div class="carousel-item active">
                                <img src="/static/diascelebres/luchaoctubre/sagest_login.png" class="fancybox" width="100%">
                            </div>
                        </div>
                    </div>
                {% else %}
                    <a href="/"><img src="/static/logos/sagestplus_login.svg" style="width: 70%;margin-left: -65px;" class="mb-4" alt=""></a><br>
                    {% if noticias or noticiasgraficas %}
                        <div id="carouselNoticias" class="carousel slide lista_actividades" data-ride="carousel" style="width: 357px;height: 57%;">
                            <div class="carousel-inner" role="listbox">
                                {% for noticia in noticias %}
                                    <div class="carousel-item {% if forloop.first and not noticiasgraficas %}active{% else %}active{% endif %}">
                                        <div class="panel_logo">
                                            <p class="texto-blue" style="margin-left: 4px; font-weight: 600"> {{ noticia.titular }}</p>
                                        </div>
                                        {{ noticia.cuerpo|safe }}
                                    </div>
                                {% endfor %}
                                {% for noticia in noticiasgraficas %}
                                    <div class="carousel-item {% if forloop.first and not noticias %}active{% endif %}">
                                        <div class="panel_logo">
                                            <p class="texto-blue" style="margin-left: 4px; font-weight: 600"> {{ noticia.titular }}</p>
                                        </div>
                                        <img src="/media/{{ noticia.imagen__archivo }}" class="fancybox"
                                             width="100%">
                                    </div>
                                {% endfor %}
                            </div>
                            {#                        <a class="carousel-control-prev" href="#carouselNoticias" role="button" data-slide="prev">#}
                            {#                            <span class="carousel-control-prev-icon" aria-hidden="true" style="color: black; border-radius: 18px; background-color: #d1d1d1; width: 30px; margin-left: -86px;"></span>#}
                            {#                        </a>#}
                            {#                        <a class="carousel-control-next" href="#carouselNoticias" role="button" data-slide="next">#}
                            {#                            <span class="carousel-control-next-icon" aria-hidden="true" style="color: black; border-radius: 18px; background-color: #d1d1d1; width: 30px; margin-right: -69px;"></span>#}
                            {#                        </a>#}
                        </div>
                    {% else %}
                        <div id="carouselNoticias" class="carousel slide lista_actividades" data-ride="carousel" style="width: 428px;height: 83%;">
                            <div class="carousel-inner" role="listbox">
                                <div class="carousel-item active">
                                    <img src="/static/logos/banner1_loginsagest.png" class="fancybox" width="100%">
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endif %}
            </center>
        </div>
        <div class="col-md-6 col-xl-6 col-12 formulariologin">
            <div class="mb-1 text-center">
                <div class="visible-phone hidden-desktop">
                    <center>
                        <a href="/"><img src="/static/logos/sagestplus_login.svg" style="width: 250px" class="mb-4" alt=""></a><br>
                    </center>
                </div>
                <h2 class="mb-1 fw-bold texto-naranja">Iniciar sesión</h2>
                <p style="font-size: 15px; line-height: 17px">Ingrese sus datos de forma correcta</p>
            </div>
            <form>
                <div class="mb-3" style="text-align: center">
                    {% if next %}
                        <input type="hidden" id="next" name="next" value="{{ next }}">
                    {% endif %}
                    <div>
                        <label for="username" class="form-label" style="margin-left: -192px;" for="user"><b>Usuario:</b></label>
                        <input type="text" id='user' name="user" placeholder="Ingrese su nombre de usuario"
                               style="width: 243px;"
                               required>
                        <p class="fs-6 text-danger" style="margin-left: -147px;" id="helpUsuario"></p>
                    </div>
                   <div>
                       <label for="pass" class="form-label" 
                              style="margin-top: 9px;margin-left: -174px;"><b>Contraseña:</b></label>
                       <input type="password" id="pass" style="width: 207px;"
                              data-toggle="password" data-placement="after" name="pass"
                              placeholder="Ingrese su contraseña" required>
                        <p class="fs-6 text-danger" id="helpPassword" style="margin-left: -128px;"></p>
                   </div>
                </div>

                {% if validar_con_captcha %}
                    <div class="mb-3" style="text-align: center">
                        <label for="password" class="form-label" style="margin-left: -176px;"><b>Seguridad:</b></label>
                        <div style="margin-top: 1px;width: 243px;" id="g-recaptcha-response"
                             class="g-recaptcha recaptchainput" data-sitekey="{{ public_key }}"></div>
                    </div>
                {% endif %}

                <div>
                    <div class="d-grid">
                        <center>
                            <a href="javascript:void(0);" id="login" class="btn btn-orange text-white"
                               style="width: 40%;border-radius: 3.2rem;padding: 8px 11px;">Entrar</a>
                        </center>
                    </div>
                </div>
                <div class="mt-2 text-center">
                    <p style="font-size: 13px">
                        ¿Tienes problemas? <a target="_blank" href="mailto:servicios.informaticos@unemi.edu.ec">Contacta al
                        administrador</a></p>
                </div>
            </form>
        </div>
    </div>

    <div class="modal fade opacity" id="modalRecuperarDatos">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background-color: transparent;!important;border: 1px solid transparent;">
                <div class="modal-wrap">
                    <div class="modal-header"
                         style="text-align: right; display: list-item; border-bottom: 1px solid white; padding: 12px 13px">
                        <button type="button" class="btn-close btn-cerrar-modal" data-toggle="modal"
                                data-dismiss="modal" aria-label="Close">X
                        </button>
                    </div>
                    <div class="panelPass">
                        <center style="margin-bottom: 43px;"><br>
                            <H2 class="texto-naranja">Recuperar datos de cuenta</H2>
                            <p class="texto-gris">Ingrese su número de documento<br>para validar su cuenta:</p>
                            <input id="iddocumentopass" type="text" class="form-control" maxlength="15"
                                   placeholder="Ingrese su número de cédula/ruc/pasaporte.." style="width: 75%"><br>
                            <a href="javascript:void(0);" id="busqueda" class="btn btn-warning btn-sm text-white"
                               style="width: 40%;  border-radius: 3.2rem; font-size: 15px; margin-top: 10px">Validar</a>
                        </center>
                    </div>
                    <div class="panelPassConf" hidden>
                        <center style="margin-top: -37px; margin-bottom: 23px;"><br>
                            <img src="/static/logos/icon_user_check.svg" style="width: 70px">
                            <h2 class="texto-naranja">Datos de cuenta</h2>
                            <span class="texto-gris">Su nombre de usuario es:</span><br>
                            <b class="texto-blue" id="nombrepersona"></b>
                            <div id="generar">
                                <p class="texto-gris">¿Desea recuperar su contraseña?</p>
                                <button href="javascript:void(0);" data-toggle="modal" data-dismiss="modal"
                                        class="btn btn-gris btn-sm"
                                        style="width: 40%;  border-radius: 3.2rem; font-size: 15px">Cerrar
                                </button>
                                <a href="javascript:void(0);" id="cambioclave" class="btn btn-warning btn-sm text-white"
                                   style="width: 40%;  border-radius: 3.2rem; font-size: 15px">Aceptar</a>
                            </div>
                            <div id="visualizar">
                                <p class="texto-gris">Si es la primera vez que ingresa, <br><b>su número de cédula séra
                                    su contraseña</b></p>
                                <button href="javascript:void(0);" data-toggle="modal" data-dismiss="modal"
                                        class="btn btn-gris btn-sm"
                                        style="width: 40%;  border-radius: 3.2rem; font-size: 15px">Cerrar
                                </button>
                            </div>
                        </center>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}