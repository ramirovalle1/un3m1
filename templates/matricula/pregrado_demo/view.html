{% extends "basebs.html" %}
{% load staticfiles %}
{% load sga_extras %}
{% block heading %}
    <link href="/static/css/table-responsive.css?1.0.0" type="text/css" rel="stylesheet" />
    <script src="/static/js/moment/moment.min.js" type="text/javascript"></script>
    <script src="/static/js/moment/moment-with-locales.min.js" type="text/javascript"></script>
    <script src="/static/js/moment/moment-timezone.min.js" type="text/javascript"></script>
    <link href='/static/boxicons-2.0.9/css/boxicons.min.css' rel='stylesheet'>
    <style>
        .modal-header {
            padding: 9px 15px;
            border-bottom: 1px solid #ddd;
            background-color: #eaf5e2;
            color: #3f572c;
            border-radius: 6px 6px 0 0;
        }
        .btn-flotante {
            font-size: 16px; /* Cambiar el tamaño de la tipografia */
            text-transform: uppercase; /* Texto en mayusculas */
            font-weight: bold; /* Fuente en negrita o bold */
            color: #ffffff; /* Color del texto */
            border-radius: 15px; /* Borde del boton */
            letter-spacing: 2px; /* Espacio entre letras */
            background-color: #51a351; /* Color de fondo */
            padding: 18px 30px; /* Relleno del boton */
            position: fixed;
            bottom: 52px;
            right: 10px;
            transition: all 300ms ease 0ms;
            box-shadow: 0px 8px 15px rgba(0, 0, 0, 0.1);
            z-index: 99;
        }
        .btn-flotante:hover {
            /*background-color: #2c2fa5;*/
            box-shadow: 0px 15px 20px rgba(0, 0, 0, 0.3);
            color: #ffffff;
            transform: translateY(-10px);
        }
        @media only screen and (max-width: 600px) {
            .btn-flotante {
                font-size: 14px;
                padding: 12px 20px;
                bottom: 52px;
                right: 10px;
            }
        }

        .terminos ul {
            list-style: none;
        }
        .terminos ul li::before {
            content: "✅";
            display: inline-block;
            margin-right: 0.2rem;
        }
        .terminos ul li {
            padding-bottom: 2ex;
        }
        .thumbnail {
            /*max-height: 350px !important;
            min-height: 150px !important;*/
            height: 100% !important;
            width: 100%;
            text-align: center;
            padding: 15px;
            border-radius: 15px !important;
        }

        .thumbnail:hover{
            box-shadow: 0px 15px 20px rgba(0, 0, 0, 0.3);
            transform: translateY(-10px);
            cursor: pointer;
        }

        .thumbnail > .thumbnail-subject {
            font-size: 13px;
            font-weight: bold;
            height: 4rem;
            text-align: center;
            overflow: hidden;
            display: block;
            text-overflow: ellipsis;
            width: 100%;
        }

        .thumbnail > .thumbnail-level {
            font-size: 12px;
            /*font-family: "Droid Serif", "DejaVu Serif", "STIX", serif;*/
            font-weight: bold;
        }

        .thumbnail > .thumbnail-eje {
            font-size: 11px;
            /*font-family: "Droid Serif", "DejaVu Serif", "STIX", serif;*/
        }

        .thumbnail > table {
            height: 50px;
            margin-top: 20px;
        }

        .thumbnail > .thumbnail-actions {
            height: 50px;
        }

        @media only screen and (max-width: 600px) {
            .thumbnail {
                /*max-height: 300px !important;
                min-height: 150px !important;*/
                height: 100% !important;
                text-align: center;
                padding: 15px;
                border-radius: 15px !important;
            }
        }

        .search {
            max-width: 300px;
            margin: 0 auto;
            position: relative;
            float: right;
            /*padding-top: 10px;*/
        }

        .search input {
            width: 300px;
            padding: 10px;
            border: 1px solid #cecece;
            border-radius: 3px;
        }

        .search i {
            position: absolute;
            cursor: pointer;
            right: 10px;
            top: 15px;
        }






    </style>
    <script>

        $(function (){
            $('.predecesores').popover({
                placement : 'left',
                html : true,
                trigger : 'hover', //<--- you need a trigger other than manual
                delay: {
                    show: "500",
                    hide: "100"
                }
            });

            $('.predecesores').on('shown.bs.popover', function() {
                setTimeout(function() {
                    $('.predecesores').popover('hide');
                }, 1000);
            });


        });


    </script>
{% endblock %}
{% block atras %}/{% endblock %}
{% block canvas %}
    <div class='row-fluid'>
        <div class='span12'>
            <h3>{{ title }}</h3>
        </div>
    </div>
    <div class="row-fluid">
        <div class="span12">
            <div class='span8'>
                <div class="media">
                    <a class="pull-left hidden-phone" href="javascript:;">
                        {% if persona.foto %}
                            <img src="{{ persona.foto.foto.url }}" onerror="this.onerror=null;this.src='/static/images/image.png'" class="media-object img-circle" width="140" height="140">
                        {% else %}
                            <img src="/static/images/iconos/{% if persona.sexo.id == 2 %}hombre.png{% else %}mujer.png{% endif %}" onerror="this.onerror=null;this.src='/static/images/image.png'" class="media-object img-circle" width="140" height="140">
                        {% endif %}
                    </a>
                    <div class="media-body" style="color: #1C3247  !important; padding-left: 20px">
                        <h3 class="media-heading">{{ persona }} ({{ inscripcion.id }})</h3>
                        <p><b><i class="fa fa-envelope"></i> Email Inst.:</b> {{ persona.emailinst }} &nbsp;&nbsp; <b><i class="fa fa-envelope"></i> Email:</b> {{ persona.email }} &nbsp;&nbsp; <b><i class="fa fa-phone"></i> Telf.:</b> {{ persona.telefono }}</p>
                        <p><b><i class="fa fa-map-marker"></i> Ciudad:</b> {{ persona.canton.nombre }} &nbsp;&nbsp; <b><i class="fa fa-map-marker"></i> Dirección:</b> {{ persona.direccion_corta }}</p>
                        <p><b><i class="fa fa-graduation-cap"></i> Carrera:</b> {{ inscripcion.carrera }} &nbsp;&nbsp; <b><i class="fa fa-cubes"></i> Malla:</b> {{ inscripcionmalla.malla }}</p>
                        <p><b><i class="fa fa-calendar-o"></i> Periodo:</b> {{ periodomatricula.periodo }} &nbsp; <b><i class="fa fa-check-circle"></i> Nivel malla:</b> {{ minivel.nombre }} (Actual)</p>
                        <p><b><i class="fa fa-group"></i> Grupo Socioeconómico:</b> <span class="label label-info smaller">{{ fichasocioeconomicainec }}</span> &nbsp; <span v-show="itinerario>0"><b><i class="fa fa-gear"></i> Itinerario:</b> <label class="label label-info smaller">ITINERARIO ${itinerario}</label></span></p>
                    </div>
                </div>
                {% if periodomatricula.valida_deuda and tiene_valores_pendientes %}
                    <p>{{ msg_valores_pendientes|safe }}</p>
                {% endif %}
                {% if va_ultima_matricula %}
                    <div class="alert alert-danger">
                        <h4 class="alert-heading">AVISO</h4>
                        Sólo puede seleccionar materias en las que se va a matricular por {% if va_ultima_matricula == 3 %}Tercera{% elif va_ultima_matricula == 4 %}Cuarta{% elif va_ultima_matricula == 5 %}Quinta{% else %}{{ va_ultima_matricula }}{% endif %} vez.
                    </div>
                {% endif %}
                {% if periodomatricula.valida_conflicto_horario %}
                    <div class="alert alert-info">
                        <a  href="javascript:;" class="close" data-dismiss="alert">×</a>
                        <h4 class="alert-heading">AVISO</h4>
                        Debes seleccionar las asignaturas en el mismo paralelo para evitar conflictos de horarios.
                    </div>
                {% endif %}
            </div>

            <div class='span4' style="text-align: center;">
                <a href="javascript:;" class="btn btn-large btn-info" v-on:click="openCalendar()">CALENDARIO DE MATRICULACIÓN</a>
                <br>
                <br>
                <table class='table table-hover personal-task'>
                    <tbody style="font-weight: bold">
                    <tr>
                        <td colspan="2"><i class='bx bx-analyse'></i> {{ nivel }}</td>
                    </tr>
                    <tr>
                        <td><i class='bx bx-network-chart'></i> Nivel de matrícula:</td>
                        <td style="text-align: center;">${nivelmalla_matricula}</td>
                    </tr>
                    <tr>
                        <td><i class='bx bx-bookmarks'></i> Asignaturas aperturadas en el nivel:</td>
                        <td style="text-align: center;">${total_asignaturas_aperturadas}</td>
                    </tr>
                    <tr>
                        <td><i class='bx bx-book-add'></i> Asignaturas seleccionadas del nivel aperturado:</td>
                        <td style="text-align: center;">${total_asignaturas_aperturadas_seleccionada}</td>
                    </tr>
                    <tr>
                        <td><i class='bx bxs-bookmark-alt-minus'></i> Total de asignaturas seleccionadas:</td>
                        <td style="text-align: center;">${materias.length}</td>
                    </tr>
                    <tr v-show="valida_materias_maxima">
                        <td><i class='bx bxs-bookmark-alt-minus'></i> Máximo de asignaturas a seleccionar:</td>
                        <td style="text-align: center;">${total_asignaturas}</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class='row-fluid'>
        <div class='span12'>
            <h3>Asignaturas de mi malla</h3>
            <a href="javascript:;" class="btn-flotante action-enroll" v-show="puede_matricularse"><i class='fa fa-plus-circle'></i> MATRICULARSE</a>
        </div>
    </div>
    <div class='row-fluid' style="border: 1px solid #ddd; background:#FFFFFF !important;  border-radius: 15px !important;">
        <div class="span12">
            <div class="row-fluid" style="">
                <div class="span12" style="background: #f0f0f0 !important; border-radius: 10px 10px 0 0 !important; border-bottom: 1px solid #ddd; padding: 15px 20px;">
                    <h4>Filtrar asignaturas</h4>
                </div>
            </div>
            <div class="row-fluid">
                <div class="span8" style="padding: 15px 20px 15px 20px;">
                    <table style="background:#FFFFFF !important; ">
                        <tr>
                            <td style="width: 15%"><h4>Por estado:</h4></td>
                            <td style="width: 90%">
                                <a href="javascript:;" class="btn actionSearchLevel" value="pendiente" data-toggle="tab">PENDIENTES</a>
                                <a href="javascript:;" class="btn actionSearchLevel" value="aprobada" data-toggle="tab">APROBADAS</a>
                                <a href="javascript:;" class="btn actionSearchLevel" value="reprobada" data-toggle="tab">REPROBADAS</a></td>
                        </tr>
                        <tr>
                            <td style="padding-top: 10px;"><h4>Por nivel:</h4></td>
                            <td style="padding-top: 10px;">
                                {% for nivelmalla in nivelesmalla %}
                                    <a href="javascript:;" class="btn actionSearchLevel" value="{{ nivelmalla.nombre }}" data-toggle="tab">{{ nivelmalla.nombre }}</a>
                                {% endfor %}
                            </td>
                        </tr>
                        {% if tiene_itinerarios %}
                            <tr>
                                <td style="padding-top: 10px;"><h4>Por itinerario:</h4></td>
                                <td style="padding-top: 10px;">
                                    {% for itinerario in lista_itinerarios %}
                                        <a href="javascript:;" class="btn actionSearchLevel" value="Itinerario {{ itinerario }}" data-toggle="tab">ITINERARIO {{ itinerario }}</a>
                                    {% endfor %}
                                </td>
                            </tr>
                        {% endif %}
                    </table>
                </div>
                <div class="span4" style="padding: 20px;">
                    <div class="search">
                        <input type="text" id="searchSubjects" placeholder="Buscar ...">
                        <i class="fa fa-search"></i>
                        <a href="javascript:;" class="btn btn-danger actionSearchLevel actionSearchLevelAll" style="width: 100% !important; margin-top: 5px; background: #da4f49 !important;" value="all">LIMPIAR BUSQUEDA</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <br>
    <div v-if="" v-for="nmo in nivelesmalla" style="width: 100%; height: max-content; display: inline-block" :key="nmo.id">
        <h4 class="hr_nivel_malla" v-bind:nivelmallaid="nmo.id" style="width:100%; text-align:left; border-bottom: 1px solid #198754; line-height:0.1em; margin:10px 0 20px;"><span style="padding:0 10px; background: #198754; padding: 5px 10px; color: #FFFFFF; border-radius: 5px">${nmo.nombre}</span></h4>
        <ul class="thumbnails" id="listSubjects" style="vertical-align: middle !important;">
            <li class="span3 valueYesSearch" v-for="am in asignaturasmalla" :key="am.id" v-bind:nivel_malla_id="am.nivelmalla_id" v-if="nmo.id == am.nivelmalla_id">
                <div class="thumbnail">
                    <div class="thumbnail-subject">${am.asignatura}</div>
                    <div class="thumbnail-level">${am.nivelmalla}</div>
                    <div class="thumbnail-eje">${am.ejeformativo}</div>
                    <div v-if="am.estado === 1">
                        <span class="label label-success">APROBADA</span> <span v-if="am.itinerario > 0"> / <label class="label label-info">${am.itinerario_verbose}</label></span>
                    </div>
                    <div v-if="am.estado === 2">
                        <span class="label label-important">REPROBADA</span> <span v-if="am.itinerario > 0"> / <label class="label label-info">${am.itinerario_verbose}</label></span> <span v-if="am.totalrecordasignatura > 1"> / <label class="label label-warning">${am.totalrecordasignatura} MAT.</label></span>
                    </div>
                    <div v-if="am.estado === 3">
                        <span class="label label-warning">PENDIENTE</span> <span v-if="am.itinerario > 0"> / <label class="label label-info">${am.itinerario_verbose}</label></span> <span v-if="am.totalrecordasignatura > 1"> / <label class="label label-warning">${am.totalrecordasignatura} MAT.</label></span>
                    </div>
                    <div v-if="am.estado === 0">
                        <span class="label label-info">NO APLICA</span>
                    </div>
                    <div id="no-more-tables" style="margin-top: 5px">
                        <table class='table table-bordered table-striped'>
                            <thead>
                            <tr>
                                <th style="text-align: center">Créditos</th>
                                <th style="text-align: center">Horas</th>
                                <th style="text-align: center">Precedencias</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td data-title='Créditos' style="text-align: center;">${am.creditos}</td>
                                <td data-title='Horas' style="text-align: center;">${am.horas}</td>
                                <td data-title='Precedencias' style="text-align: center;">
                                    <a href="javascript:;" class="smaller predecesores btn btn-min" data-placement="left" rel="popover" v-bind:data-content="am.predecesoras" v-on:click="infoPredecesora(am.predecesoras, am.cantidad_predecesoras)"> ${am.cantidad_predecesoras}</a>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="thumbnail-actions">
                        <!--<a class="btn btn-large btn-info" v-if="am.estado === 3 && am.cantidad_predecesoras === 0" v-on:click="openAsignatura(am)">HORARIO</a>-->
                        <a class="btn btn-large btn-info" v-bind:itinerario="`itinerario_`+am.itinerario" v-bind:id="`btn_aplicar_`+am.id" :key="`aplicar_`+am.id" v-if="am.puede_ver_horario == 1" v-on:click="openAsignatura(am)"><i class='bx bx-building-house'></i> HORARIO</a>
                        <a class="btn btn-large btn-danger" style="display: none" v-bind:id="`btn_remover_`+am.id" :key="`remover_`+am.id" v-if="am.puede_ver_horario == 1" v-on:click="removeAsignatura(am)"><i class='bx bxs-no-entry'></i> REMOVER</a>
                    </div>
                </div>
            </li>
        </ul>
    </div>

    <div class="modal fade static" id="modalAsignatura">
        <div class="modal-header">
            <h4 class="paneltitle"><span>HORARIOS DE CLASES DE </span> << ${ asignatura.asignatura } [${ asignatura.nivelmalla }] >></h4>
        </div>
        <div class="modal-body panelbody">
            <div class="alert alert-warning" v-if="!asignatura.materias || asignatura.materias.length === 0">
                <h4 class="alert-heading">Importante!</h4>
                <p class="alert-body">
                    MATERIA NO ESTÁ ABIERTA,CONTACTAR A SU DIRECTOR/A DE CARRERA
                </p>
            </div>
            <table class="table table-bordered table-striped" cellpadding="0" cellspacing="0" v-else>
                <thead>
                <tr>
                    <th style="text-align: center; vertical-align: middle; width: 30%">Coordinación / Carrera / Paralelo</th>
                    <th style="text-align: center; vertical-align: middle; width: 30%" v-if="ver_horario_materia">Horario</th>
                    <th style="text-align: center; vertical-align: middle; width: 8%" v-if="ver_cupo_materia">Cupo</th>
                    <th style="text-align: center; vertical-align: middle; width: 8%" v-if="ver_cupo_materia">Disponible</th>
                    <th style="text-align: center; vertical-align: middle; width: 8%">Sección</th>
                    <th style="text-align: center; vertical-align: middle; width: 6%">Inicio</th>
                    <th style="text-align: center; vertical-align: middle; width: 6%">Fin</th>
                    <th style="text-align: center; vertical-align: middle; width: 10%"></th>
                </tr>
                </thead>
                <tbody>
                <tr v-for="m in asignatura.materias" :key="m.id">
                    <td style="text-align: left; vertical-align: middle">
                        ${ m.coordinacion }<br>
                        ${ m.carrera } <br>
                        ${ m.paralelo } /
                        <span v-if="m.tipomateria === 1">
                                <label class="label label-info">${m.tipomateria_display}</label> /
                            </span>
                        <span v-else-if="m.tipomateria === 2">
                                <label class="label label-inverse">${m.tipomateria_display}</label> /
                            </span>
                        <span v-if="m.teoriapractica === 1">
                                <label class="label label-warning">TP</label> /
                            </span>
                        <span v-if="m.teoriapractica === 0">
                                <label class="label label-warning">T</label>
                            </span>
                    </td>
                    <td v-if="ver_horario_materia">
                        <ul>
                            <li v-for="h in m.horarios_verbose"><i class="fa fa-calendar-o"></i> ${ h }</li>
                        </ul>
                    </td>
                    <td v-if="ver_cupo_materia" style="text-align: center; vertical-align: middle">${m.cupos}</td>
                    <td v-if="ver_cupo_materia" style="text-align: center; vertical-align: middle">${m.disponibles}</td>
                    <td style="text-align: center; vertical-align: middle">${m.session}</td>
                    <td style="text-align: center; vertical-align: middle">${m.inicio}</td>
                    <td style="text-align: center; vertical-align: middle">${m.fin}</td>
                    <td style="text-align: center; vertical-align: middle">
                        <div v-if="m.puede_agregar">
                            <div v-if="valida_horario_materia">
                                <div v-if="m.horarios.length > 0">
                                    <div v-if="valida_cupo_materia">
                                        <div v-if="m.cupos > 0 && m.disponibles <= m.cupos">
                                            <a href="javascript:;" class="btn btn-large btn-success" v-on:click="selectSubject(m)">SELECCIONAR</a>
                                        </div>
                                    </div>
                                    <div v-else>
                                        <a href="javascript:;" class="btn btn-large btn-success" v-on:click="selectSubject(m)">SELECCIONAR</a>
                                    </div>
                                </div>
                            </div>
                            <div v-else-if="valida_cupo_materia">
                                <div v-if="m.cupos > 0 && m.disponibles <= m.cupos">
                                    <a href="javascript:;" class="btn btn-large btn-success" v-on:click="selectSubject(m)">SELECCIONAR</a>
                                </div>
                            </div>
                            <div v-else>
                                <a href="javascript:;" class="btn btn-large btn-success" v-on:click="selectSubject(m)">SELECCIONAR</a>
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn action-close">CERRAR</a>
        </div>
    </div>

    <div class="modal fade static" id="modalPractica">
        <div class="modal-header">
            <h4 class="paneltitle"><span>HORARIOS DE PRÁCTICAS DE </span> << ${ asignatura.asignatura } [${ asignatura.nivelmalla }] >></h4>
        </div>
        <div class="modal-body panelbody">
            <div class="alert alert-info" v-if="!materia.mispracticas || materia.mispracticas.length === 0">
                <h4 class="alert-heading">Importante!</h4>
                <p class="alert-body">
                    NO EXISTEN PRACTICAS PROGRAMADAS
                </p>
            </div>
            <table class="table table-bordered table-striped" cellpadding="0" cellspacing="0" v-else>
                <thead>
                <tr>
                    <th v-if="ver_horario_materia" style="text-align: center; vertical-align: middle; width: 30%">Horario</th>
                    <th style="text-align: center; vertical-align: middle; width: 20%">Paralelo</th>
                    <th v-if="ver_cupo_materia" style="text-align: center; vertical-align: middle; width: 8%">Cupo</th>
                    <th v-if="ver_cupo_materia" style="text-align: center; vertical-align: middle; width: 8%">Disponible</th>
                    <th style="text-align: center; vertical-align: middle; width: 30%"></th>
                </tr>
                </thead>
                <tbody>
                <tr v-for="p in materia.mispracticas" :key="p.id">
                    <td v-if="ver_horario_materia" style="text-align: left; vertical-align: middle">
                        <ul>
                            <li v-for="h in p.horarios_verbose" :key="h.id"><i class="fa fa-calendar-o"></i> ${h}</li>
                        </ul>
                    </td>
                    <td style="text-align: center; vertical-align: middle">${p.paralelo}</td>
                    <td v-if="ver_cupo_materia" style="text-align: center; vertical-align: middle">${p.cupos}</td>
                    <td v-if="ver_cupo_materia" style="text-align: center; vertical-align: middle">${p.disponibles}</td>
                    <td style="text-align: center; vertical-align: middle">
                        <div v-if="valida_horario_materia">
                            <div v-if="p.horarios.length > 0">
                                <div v-if="valida_cupo_materia">
                                    <div v-if="p.cupos > 0 && p.disponibles <= p.cupos">
                                        <a href="javascript:;" class="btn btn-large btn-success" v-on:click="selectSubjectPractice(materia, p)">SELECCIONAR</a>
                                    </div>
                                </div>
                                <div v-else>
                                    <a href="javascript:;" class="btn btn-large btn-success" v-on:click="selectSubjectPractice(materia, p)">SELECCIONAR</a>
                                </div>
                            </div>

                        </div>
                        <div v-else-if="valida_cupo_materia">
                            <div v-if="p.cupos > 0 && p.disponibles <= p.cupos">
                                <a href="javascript:;" class="btn btn-large btn-success" v-on:click="selectSubjectPractice(materia, p)">SELECCIONAR</a>
                            </div>
                        </div>
                        <div v-else>
                            <a href="javascript:;" class="btn btn-large btn-success" v-on:click="selectSubjectPractice(materia, p)">SELECCIONAR</a>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn action-close">CERRAR</a>
        </div>
    </div>

    <div class="modal fade static" id="modalValoresPendientes" style="display: none;">
        <div class="modal-header">
            <h4 class="paneltitle"><span></span> Detalle de valores pendientes</h4>
        </div>
        <div class="modal-body panelbody">

        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn btn-info action-close"> Cerrar</a>
        </div>
    </div>

    <div class="modal fade static" id="modalConfirmarMatricula" style="display: none;">
        <div class="modal-header">
            <h4 class="paneltitle"><span></span>Confirmar matrícula</h4>
        </div>
        <div class="modal-body panelbody">
            <div v-show="perdida_gratuidad">
                <span v-html="mensaje_gratuidad"></span>
                <span><p style="font-weight: bold;">Una vez confirmada la matriculación, podrá consultar los rubros a pagar a través del módulo "Mis Finanzas".</p></span>
            </div>
            {% if periodomatricula.valida_terminos %}
                <br>
                <table class="table table-bordered table-striped">
                    <thead>
                    <tr>
                        <th colspan="2"><h4 style="color: red; padding-left: 15px; padding-right: 15px"><strong>TÉRMINOS Y CONDICIONES</strong></h4></th>
                    </tr>
                    </thead>
                    <tbody style="text-align: justify-all">
                    <tr>
                        <td style="text-align: center !important; vertical-align: middle; ">
                            <input name="acept_t" type="checkbox">
                        </td>
                        <td style=" vertical-align: middle;">
                            <div class="terminos">
                                {{ periodomatricula.terminos|safe }}
                            </div>
                        </td>
                    </tr>
                </table>
            {% endif %}
            <p>{% if persona.sexo.id == 1 %}Estimada{% else %}Estimado{% endif %} {{ persona }}, al confirmar usted se estaría matriculando en (<b v-html="materias.length"></b>) <span v-html="materias.length > 1 ? 'materias' : 'materia'"></span>. <b style="font-size: 16px;">¿Está {% if persona.sexo.id == 1 %}segura{% else %}seguro{% endif %} de matricularse?</b></p>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn btn-success action-confirm"> Confirmar</a>
            <a href="javascript:;" class="btn btn-inverse action-close"> Cancelar</a>
        </div>
    </div>

    <div class="modal fade static" id="modalConfirmarDiferir" style="display: none;">
        <div class="modal-header">
            <h3 class="paneltitle"><span></span> Confirmación de diferir valores de matrícula</h3>
        </div>
        <div class="modal-body panelbody">

        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn btn-info btn-large action-confirm"> Si, diferir</a>
            <a href="javascript:;" class="btn btn-inverse btn-large action-close"> No diferir</a>
        </div>
    </div>

    <div class="modal fade static" id="modalCalendar" style="display: none;">
        <div class="modal-header">
            <h4 class="paneltitle"><span></span> Calendario de matriculación</h4>
        </div>
        <div class="modal-body panelbody">

        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn btn-inverse action-close"> Cerrar</a>
        </div>
    </div>

    <!--<loader object="#ff9633" color1="#ffffff" color2="#17fd3d" size="14" speed="2.8" bg="#343a40" objectbg="#999793" opacity="93" disableScrolling="false" name="loading"></loader>-->

{% endblock %}
{% block extraJs %}
    <!--https://vuejsexamples.com/a-scroll-loading-component-for-vue-js/-->
    <!--https://molvqingtai.github.io/vue-scroll-loader/demo.html-->
    <!--<script src="https://cdn.jsdelivr.net/npm/vue3-sfc-loader"></script>-->
    <!--<script src=”https://cdn.jsdelivr.net/npm/vue-resource@1.3.5"></script>-->
    <!-- archivos vue.js -->
    <!--<script src ="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.js"> </script>-->
    <!--<script src ="https://cdn.jsdelivr.net/npm/vue-resource@ 1.3.5"> </script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>-->
    <script src="/static/js/vue.js"></script>
    <!--<script src="https://unpkg.com/vue-ui-preloader"></script>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/vue-ui-preloader/dist/loader.css">-->
    <script type="text/javascript">
        //Vue.use(loader)
        //axios.defaults.headers.common['X-CSRFToken'] = csrftoken

        const loadAjax = (data, url) => new Promise((resolve, reject) => {
            $.ajax({
                type: "POST",
                url: url,
                data: data,
                success: function(response) {
                    resolve({
                        error: false,
                        value: response
                    });
                },
                error: function() {
                    reject({
                        error: true,
                        message: "Error al enviar los datos."
                    });
                },
                dataType: "json"
            });

        });
        var data = {
            asignaturasmalla: [],
        };
        var app = new Vue({
            delimiters: ['${', '}'],
            el: '#app',
            data: {
                nivelesmalla: [],
                asignaturasmalla: [],
                itinerario_inscripcion: parseInt('{% if inscripcion.itinerario %}{{ inscripcion.itinerario }}{% else %}0{% endif %}'),
                itinerario: parseInt('{% if inscripcion.itinerario %}{{ inscripcion.itinerario }}{% else %}0{% endif %}'),
                itinerarios: [],
                nivel_id: parseInt('{{ nivel.id }}'),
                nivelmalla_id: parseInt('{{ minivel.id }}'),
                nivelmalla_matricula: '',
                nivelmalla_matricula_id: 0,
                total_asignaturas_aperturadas: 0,
                total_asignaturas_aperturadas_seleccionada: 0,
                //total_asignaturas_seleccionadas: 0,
                total_asignaturas: parseInt('{% if periodomatricula and periodomatricula.num_materias_maxima %}{{ periodomatricula.num_materias_maxima }}{% else %}0{% endif %}'),
                puede_matricularse: false,
                perdida_gratuidad: false,
                mensaje_gratuidad: '',
                asignatura: {},
                materia: {},
                materias:[],
                clases:[],
                total_materias_pendientes_malla: parseInt('{{ total_materias_pendientes_malla }}'),
                total_materias_nivel: parseInt('{{ total_materias_nivel }}'),
                valida_gratuidad: eval('{% if periodomatricula and periodomatricula.valida_gratuidad %}"true"{% else %}"false"{% endif %}') === 'true',
                porciento_perdida_parcial_gratuidad: parseInt('{% if periodomatricula and periodomatricula.porcentaje_perdidad_parcial_gratuidad %}{{ periodomatricula.porcentaje_perdidad_parcial_gratuidad }}{% else %}0{% endif %}'),
                porciento_perdida_total_gratuidad: parseInt('{% if periodomatricula and periodomatricula.porcentaje_perdidad_total_gratuidad %}{{ periodomatricula.porcentaje_perdidad_total_gratuidad }}{% else %}0{% endif %}'),
                porcentaje_seleccionadas: 0,
                valida_materias_maxima: eval('{% if periodomatricula.valida_materias_maxima %}"true"{% else %}"false"{% endif %}') === 'true',
                num_materias_maxima: parseInt('{% if periodomatricula and periodomatricula.num_materias_maxima %}{{ periodomatricula.num_materias_maxima }}{% else %}0{% endif %}'),
                matriculacion_libre: eval('{% if matriculacion_libre %}"true"{% else %}"false"{% endif %}') === 'true',
                va_ultima_matricula: eval('{% if va_ultima_matricula %}"true"{% else %}"false"{% endif %}') === 'true',
                valida_cupo_materia: eval('{% if periodomatricula.valida_cupo_materia %}"true"{% else %}"false"{% endif %}') === 'true',
                valida_horario_materia: eval('{% if periodomatricula.valida_horario_materia %}"true"{% else %}"false"{% endif %}') === 'true',
                valida_conflicto_horario: eval('{% if periodomatricula.valida_conflicto_horario %}"true"{% else %}"false"{% endif %}') === 'true',
                valida_cuotas_rubro: eval('{% if periodomatricula.valida_cuotas_rubro %}"true"{% else %}"false"{% endif %}') === 'true',
                num_cuotas_rubro: parseInt('{% if periodomatricula and periodomatricula.num_cuotas_rubro %}{{ periodomatricula.num_cuotas_rubro }}{% else %}0{% endif %}'),
                valida_deuda: eval('{% if periodomatricula.valida_deuda %}"true"{% else %}"false"{% endif %}') === 'true',
                ver_cupo_materia: eval('{% if periodomatricula.ver_cupo_materia %}"true"{% else %}"false"{% endif %}') === 'true',
                ver_horario_materia: eval('{% if periodomatricula.ver_horario_materia %}"true"{% else %}"false"{% endif %}') === 'true',
                ver_deduda: eval('{% if periodomatricula.ver_deduda %}"true"{% else %}"false"{% endif %}') === 'true',
                valida_terminos: eval('{% if periodomatricula.valida_terminos %}"true"{% else %}"false"{% endif %}') === 'true',
                cobro: 0,
                tipo_matricula: 0,
                matricula_id: 0,
                socket_status: false,
            },
            /*components:{
                loader: loader
            },*/
            created(){
                var self = this;

                /*if (self.itinerio > 0){
                    self.itinerio_show = true
                }
                else {
                    self.itinerio_show = false
                }*/
            },
            mounted: function (){
                var self = this;
                moment.tz.add('America/Guayaquil|QMT -05 -04|5e 50 40|0121|-1yVSK 2uILK rz0|27e5');
                /*self.$nextTick(() => {
                    self.sw = new Switchery(this.$refs.cb)
                });*/

                {% if tiene_itinerarios %}
                    {% for itinerario in lista_itinerarios %}
                        self.itinerarios.push(parseInt("{{itinerario}}"));
                    {% endfor %}
                {% endif %}
                self.loading();
                self.loadInitial();
                self.search();
                self.actionSearchLevel();
                $(".actionSearchLevelAll").trigger('click');
                self.$modalAsignatura = $("#modalAsignatura");
                self.$modalPractica = $("#modalPractica");
                self.$modalValoresPendientes = $("#modalValoresPendientes");
                self.$modalConfirmarMatricula = $("#modalConfirmarMatricula");
                self.$modalConfirmarDiferir = $("#modalConfirmarDiferir");
                self.$modalCalendar = $("#modalCalendar");
                $('.action-close', self.$modalAsignatura).click(function(){
                    self.closeAsignatura();
                });
                $('.action-close', self.$modalPractica).click(function(){
                    self.closePractica();
                });
                $('.action-close', self.$modalValoresPendientes).click(function(){
                    self.closeValoresPendientes();
                });
                $('.action-close', self.$modalConfirmarMatricula).click(function(){
                    self.closeConfirmarMatricula();
                });
                $('.action-confirm', self.$modalConfirmarMatricula).click(function(){
                    self.ConfirmarMatricula();
                });
                $('.action-close', self.$modalConfirmarDiferir).click(function(){
                    self.closeConfirmarDiferir();
                });
                $('.action-confirm', self.$modalConfirmarDiferir).click(function(){
                    self.ConfirmarDiferir();
                });
                $('.action-close', self.$modalCalendar).click(function(){
                    self.closeCalendar();
                });

                $('.action-view-pending-values').click(function (){
                    self.viewPendingValues();
                });
                self.changeItinerario();

                $('.action-enroll').click(function (){
                    self.actionEnroll();
                });

            },
            methods: {
                loading: function (){
                    if (!$(".blockUI").length){
                        $.blockUI({message: $('#throbber'), css: { 'border': '1px solid', 'border-radius' : '10px', 'left': '46%', 'width':'140px', 'height': '140px',  'padding': '15px',  '-webkit-border-radius': '10px', '-moz-border-radius': '10px', opacity: .6, color: '#000' }});
                    }
                },
                actionEnroll: function (){
                    var self = this;
                    if (self.materias.length == 0){
                        Swal.fire({
                            toast: false,
                            position: 'center',
                            icon:"error",
                            type: 'error',
                            title: 'Acción no permitida',
                            text: `Tiene (${self.materias.length}) asignaturas seleccionadas`,
                            showConfirmButton: false,
                            timer: 6000
                        });
                        return false;
                    }else{
                        self.openConfirmarMatricula();
                    }
                },
                openConfirmarMatricula: function (){
                    var self = this;
                    self.calcula_gratuidad();
                    $.unblockUI();
                    if (self.valida_terminos){
                        if (self.perdida_gratuidad){
                            var h = $(window).height()-350;
                            self.$modalConfirmarMatricula.modal({backdrop:'static', width: '90%', height: h}).modal('show');
                        }else{
                            self.$modalConfirmarMatricula.modal({backdrop:'static', width: '60%'}).modal('show');
                        }

                    }else{
                        self.$modalConfirmarMatricula.modal({backdrop:'static', width: '40%'}).modal('show');
                    }
                },
                ConfirmarMatricula: function (){
                    var self = this;
                    var acepto_terminos = $('[name="acept_t"]', self.$modalConfirmarMatricula).is(':checked');
                    if (!acepto_terminos){
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            type: "error",
                            title: "Para continuar, favor acepte los términos y condiciones",
                            showConfirmButton: false,
                            timer: 3500
                        })
                        //NotificationJG.warning("Favor acepte los terminos", "Advertencia");
                        return false;
                    }
                    let acept_t = acepto_terminos ? 1 : 0

                    self.loading();
                    loadAjax({
                        'action': 'enroll',
                        'materias': JSON.stringify(self.materias),
                        'nivel_id': self.nivel_id,
                        'cobro': self.cobro,
                        'tipo_matricula': self.tipo_matricula,
                        'acept_t': acept_t,
                    }, '/alu_matricula/pregrado/demo')
                        .then(response => {
                            $.unblockUI();
                            if (response.value.result == 'ok')
                            {
                                console.log(response.value.aData);
                                self.matricula_id = response.value.aData.phase
                                if (self.valida_cuotas_rubro && self.num_cuotas_rubro > 0 && response.value.aData.valorpagar > 0){
                                    self.openConfirmarDiferir(response.value);
                                    self.closeConfirmarMatricula();
                                }else{
                                    if (response.value.aData.valorpagar > 0){
                                        Swal.fire({
                                            title: `NOTIFICACIÓN`,
                                            text: `{% if persona.sexo.id == 1 %}Estimada{% else %}Estimado{% endif %} {{ persona }}, le informamos que el proceso de matriculación ha finalizado y se han generados rubros. Consulte los valores en el Módulo "Mis Finanzas"`,
                                            type: 'warning',
                                            icon: 'warning',
                                            showCancelButton: false,
                                            allowOutsideClick: false,
                                            confirmButtonColor: '#3085d6',
                                            cancelButtonColor: '#d33',
                                            confirmButtonText: 'Aceptar',
                                            cancelButtonText: 'Cancelar'
                                        }).then((result) => {
                                            if (result.value) {
                                                self.loading();
                                                location.reload();
                                            }else{
                                                self.loading();
                                                location.reload();
                                            }
                                        }).catch(error => {
                                            NotificationJG.error(error);
                                        });
                                    }else{
                                        Swal.fire({
                                            title: `NOTIFICACIÓN`,
                                            text: `{% if persona.sexo.id == 1 %}Estimada{% else %}Estimado{% endif %} {{ persona }}, se informa que el proceso de matriculación ha finalizado.`,
                                            type: 'success',
                                            icon: 'success',
                                            showCancelButton: false,
                                            allowOutsideClick: false,
                                            confirmButtonColor: '#3085d6',
                                            cancelButtonColor: '#d33',
                                            confirmButtonText: 'Aceptar',
                                            cancelButtonText: 'Cancelar'
                                        }).then((result) => {
                                            if (result.value) {
                                                self.loading();
                                                location.reload();
                                            }else{
                                                self.loading();
                                                location.reload();
                                            }
                                        }).catch(error => {
                                            NotificationJG.error(error);
                                        });
                                    }

                                }
                            }
                            else{
                                console.log(response);
                                NotificationJG.error(response.value.mensaje);
                            }
                        })
                        .catch(error => {
                            console.log(error);
                            $.unblockUI();
                            NotificationJG.error(error.message);
                        });
                },
                openConfirmarDiferir: function (data) {
                    var self = this;
                    $.unblockUI();
                    $(".modal-body", self.$modalConfirmarDiferir).html(`<p style="font-size:15px !important">{% if persona.sexo.id == 1 %}Estimada{% else %}Estimado{% endif %} {{ persona }}, ¿desea diferir el valor de <strong>$ ${data.aData.valorarancel}</strong> del rubro <strong>${data.aData.descripcionarancel}</strong> a <strong>${self.num_cuotas_rubro}</strong> ${self.num_cuotas_rubro > 1 ? 'meses':'mes' }?</p>`);
                    self.$modalConfirmarDiferir.modal({backdrop:'static', width: '50%'}).modal('show');

                },
                ConfirmarDiferir: function () {
                    var self = this;
                    self.loading();
                    loadAjax({
                        'action': 'to_differ',
                        'idm': self.matricula_id,
                    }, '/alu_matricula/pregrado/demo')
                        .then(response => {
                            $.unblockUI();
                            if (response.value.result == 'ok')
                            {
                                Swal.fire({
                                    title: `NOTIFICACIÓN`,
                                    text: `{% if persona.sexo.id == 1 %}Estimada{% else %}Estimado{% endif %} {{ persona }}, le informamos que se procedió a diferir los rubros generados. El proceso de matriculación ha finalizado. Consulte los valores en Módulo "Mis Finanzas"`,
                                    type: 'success',
                                    icon: 'success',
                                    showCancelButton: false,
                                    allowOutsideClick: false,
                                    confirmButtonColor: '#3085d6',
                                    cancelButtonColor: '#d33',
                                    confirmButtonText: 'Aceptar',
                                    cancelButtonText: 'Cancelar'
                                }).then((result) => {
                                    if (result.value) {
                                        self.loading();
                                        location.reload();
                                    }else{
                                        self.loading();
                                        location.reload();
                                    }
                                }).catch(error => {
                                    NotificationJG.error(error.message);
                                });
                            }else{
                                NotificationJG.error(response.value.mensaje);
                            }
                        })
                        .catch(error => {
                            $.unblockUI();
                            NotificationJG.error(error.message);
                        });
                },
                viewPendingValues: function (){
                    var self = this;
                    self.loading();
                    $.ajax({
                        type: "POST",
                        url: "/alu_matricula/pregrado/demo",
                        data: {
                            'action': 'viewPendingValues',
                            'nivel_id': self.nivel_id
                        },
                        success: function(response) {
                            if (response.result == 'ok') {
                                $.unblockUI();
                                $(".modal-body", self.$modalValoresPendientes).html(response.html);
                                var h = $(window).height() - 150;
                                self.$modalValoresPendientes.modal({backdrop:'static', width: '70%', height: h}).modal('show');
                            } else {
                                NotificationJG.error(response.mensaje);
                                $.unblockUI();
                            }
                        },
                        error: function() {
                            $.unblockUI();
                            NotificationJG.error("Error al enviar los datos.");
                        },
                        dataType: "json"
                    });
                },
                changeItinerario: function (){
                    var self = this;
                    if (self.itinerario_inscripcion > 0){
                        self.itinerarios.forEach(function(iti, index) {
                            if (iti != self.itinerario_inscripcion){
                                $("[itinerario='itinerario_"+iti+"']").hide();
                            }
                        });
                        self.itinerario = self.itinerario_inscripcion;
                    }else{
                        let utilizaItinerario = false
                        let itinerario = 0;
                        self.materias.forEach(function(materia, index) {
                            if (materia.itinerario > 0){
                                self.itinerario = materia.itinerario;
                                utilizaItinerario = true;
                                return false;
                            }
                        });
                        if (utilizaItinerario){
                            self.itinerarios.forEach(function(iti, index) {
                                if (iti != self.itinerario){
                                    $("[itinerario='itinerario_"+iti+"']").hide();
                                }
                            });
                        }else {
                            self.itinerario = 0;
                            self.itinerarios.forEach(function(iti, index) {
                                $("[itinerario='itinerario_"+iti+"']").show();
                            });
                        }

                    }

                },
                changeNivelMatricula: function (){
                    var self = this;
                    let mismaterias = [];
                    self.materias.forEach(function(materia, index) {
                        mismaterias.push(materia.id)
                    });
                    if (self.materias.length > 0){
                        self.loading();
                        $.ajax({
                            type: "POST",
                            url: "/alu_matricula/pregrado/demo",
                            data: {
                                'action': 'locateEnrollmentLevel',
                                'mismaterias': JSON.stringify(mismaterias)
                            },
                            success: function(response) {
                                if (response.result == 'ok') {
                                    self.nivelmalla_matricula_id = response.aData.id;
                                    self.nivelmalla_matricula = response.aData.nombre;
                                    self.countSubjectsApproved();
                                    self.countSelectSubjectLevel();
                                    self.countSubjectsOpen();
                                    $.unblockUI();
                                } else {
                                    NotificationJG.error(response.mensaje);
                                    $.unblockUI();
                                }
                            },
                            error: function() {
                                $.unblockUI();
                                NotificationJG.error("Error al enviar los datos.");
                            },
                            dataType: "json"
                        });
                    }else{
                        self.nivelmalla_matricula_id = 0;
                        self.nivelmalla_matricula = '';
                        self.countSubjectsApproved();
                        self.countSelectSubjectLevel();
                        self.countSubjectsOpen();
                    }


                },
                changeMatricularse: function (){
                    var self = this;
                    self.puede_matricularse = false;
                    if (self.materias.length > 0){
                        self.puede_matricularse = true;
                    }
                },
                countSelectSubjectLevel: function (){
                    var self = this;
                    self.total_asignaturas_aperturadas_seleccionada = 0;
                    self.materias.forEach(function(materia, index) {
                        if (materia.nivelmalla_id == self.nivelmalla_matricula_id){
                            self.total_asignaturas_aperturadas_seleccionada += 1
                        }
                    });
                },
                countSubjectsApproved: function (){
                    var self = this;
                    self.total_asignaturas_aprobadas = 0
                    self.asignaturasmalla.forEach(function(asignatura, index) {
                        //console.log(asignatura.nivelmalla_id);
                        //console.log(self.nivelmalla_matricula_id);
                        if (asignatura.nivelmalla_id == self.nivelmalla_matricula_id && asignatura.materias.length > 0){
                            self.total_asignaturas_aprobadas += 1
                        }
                    });

                },
                countSubjectsOpen: function (){
                    var self = this;
                    self.total_asignaturas_aperturadas = 0
                    self.asignaturasmalla.forEach(function(asignatura, index) {
                        if (asignatura.nivelmalla_id == self.nivelmalla_matricula_id && asignatura.puede_ver_horario){
                            self.total_asignaturas_aperturadas += 1
                        }
                    });

                },
                loadInitial: function() {
                    var self = this;
                    self.loading();
                    $.ajax({
                        type: "POST",
                        url: "/alu_matricula/pregrado/demo",
                        data: {
                            'action': 'loadInitialData',
                            'nivel_id': self.nivel_id
                        },
                        success: function(response) {
                            if (response.result == 'ok') {
                                self.asignaturasmalla = response.aData;
                                response.aData.forEach(function (am, index) {
                                    let isExit = false;
                                    for (let i in self.nivelesmalla){
                                        if (self.nivelesmalla[i]['id'] == am.nivelmalla_id){
                                            isExit = true;
                                            return false;
                                        }
                                    }
                                    if (!isExit){
                                        self.nivelesmalla.push({
                                            "id": am.nivelmalla_id,
                                            "nombre": am.nivelmalla,
                                        });
                                    }
                                });
                                //self.countSubjectsOpen();
                                if (self.socket_status){
                                    Swal.fire({
                                        toast: true,
                                        position: 'top-end',
                                        type: 'success',
                                        title: `Existe conexión en tiempo real`,
                                        showConfirmButton: false,
                                        timer: 6000
                                    })
                                }
                                $.unblockUI();
                            } else {
                                //NotificationJG.error(response.mensaje);
                                $.unblockUI();
                                Swal.fire({
                                    title: `NOTIFICACIÓN`,
                                    text: response.mensaje,
                                    type: 'error',
                                    icon: 'error',
                                    showCancelButton: false,
                                    allowOutsideClick: false,
                                    confirmButtonColor: '#3085d6',
                                    cancelButtonColor: '#d33',
                                    confirmButtonText: 'Aceptar',
                                    cancelButtonText: 'Cancelar'
                                }).then((result) => {
                                    if (result.value) {
                                        self.loading();
                                        window.location.href = "/";
                                    }else{
                                        self.loading();
                                        window.location.href = "/";
                                    }
                                }).catch(error => {
                                    self.loading();
                                    window.location.href = "/";
                                });
                            }
                        },
                        error: function() {
                            $.unblockUI();
                            Swal.fire({
                                title: `NOTIFICACIÓN`,
                                text: "Error al enviar los datos.",
                                type: 'error',
                                icon: 'error',
                                showCancelButton: false,
                                allowOutsideClick: false,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Aceptar',
                                cancelButtonText: 'Cancelar'
                            }).then((result) => {
                                if (result.value) {
                                    self.loading();
                                    window.location.href = "/";
                                }else{
                                    self.loading();
                                    window.location.href = "/";
                                }
                            }).catch(error => {
                                self.loading();
                                window.location.href = "/";
                            });
                            //NotificationJG.error("Error al enviar los datos.");
                        },
                        dataType: "json"
                    });
                },
                closeAsignatura: function (){
                    var self = this;
                    self.asignatura = {};
                    self.$modalAsignatura.modal('hide');
                },
                removeAsignatura: function (asignatura){
                    var self = this;
                    self.loading();
                    self.materias.forEach(function(materia, index) {
                        if (asignatura.id == materia.asignatura_id){
                            $("#btn_aplicar_"+materia.asignatura_id).show();
                            $("#btn_remover_"+materia.asignatura_id).hide();
                            self.materias.splice(index, 1); // 1 es la cantidad de elemento a eliminar
                        }
                    });
                    //self.countSelectSubjectLevel();
                    self.changeMatricularse();
                    self.changeItinerario();
                    self.changeNivelMatricula();
                    self.calcula_gratuidad();
                    setTimeout(function() {
                        $.unblockUI();
                    }, 2000);
                },
                selectSubject: function (materia){
                    var self = this;
                    self.loading();
                    let fnSelect = function () {

                        if (materia.teoriapractica == 0) {
                            self.materias.push({
                                "id": materia.id,
                                "asignatura_id": self.asignatura.id,
                                "itinerario": self.asignatura.itinerario,
                                "nivelmalla_id": materia.nivelmalla_id,
                                "paralelo_id": materia.paralelo_id,
                                "practica": {},
                                "horarios": materia.horarios,
                            });
                            self.asignaturasmalla.forEach(function (asignatura, index) {
                                if (asignatura.id == self.asignatura.id) {
                                    $("#btn_aplicar_" + self.asignatura.id).hide();
                                    $("#btn_remover_" + self.asignatura.id).show();
                                }
                            });
                            //self.validConflictoHorario(materia);
                            setTimeout(function () {
                                $.unblockUI();
                            }, 2000);
                            self.closeAsignatura();
                            //self.countSelectSubjectLevel();
                            self.changeMatricularse();
                            self.changeItinerario();
                            self.changeNivelMatricula();
                            self.calcula_gratuidad();
                        } else {
                            self.openPractica(materia);
                        }
                    }

                    if (self.valida_conflicto_horario && self.materias.length > 0){
                        console.log(self.materias);
                        if (self.materias.length > 0) {
                            let materia_aux = {
                                "id": materia.id,
                                "asignatura_id": self.asignatura.id,
                                "itinerario": self.asignatura.itinerario,
                                "nivelmalla_id": materia.nivelmalla_id,
                                "paralelo_id": materia.paralelo_id,
                                "practica": {},
                                "horarios": materia.horarios,
                            }
                            loadAjax({
                                'action': 'validConflictoHorario',
                                'materias': JSON.stringify(self.materias),
                                'materia': JSON.stringify(materia_aux)
                            }, '/alu_matricula/pregrado/demo')
                                .then(response => {
                                    if (response.value.result == 'ok') {
                                        console.log(response.value.conflicto);
                                        if (response.value.conflicto){
                                            Swal.fire({
                                                toast: true,
                                                position: 'top-end',
                                                type: 'warning',
                                                title: response.value.mensaje,
                                                showConfirmButton: false,
                                                timer: 6000
                                            });
                                        }else{
                                            fnSelect();
                                        }
                                        $.unblockUI();
                                    } else {
                                        $.unblockUI();
                                        NotificationJG.error(response.value.mensaje);
                                    }
                                })
                                .catch(error => {
                                    $.unblockUI();
                                    NotificationJG.error(error.message);
                                });
                        }else {
                            if (fnSelect){
                                fnSelect();
                            }else {
                                NotificationJG.error("Ocurrio un error al cargar los datos");
                                $.unblockUI();
                            }
                        }
                    }else{
                        if (fnSelect){
                            fnSelect();
                        }else {
                            NotificationJG.error("Ocurrio un error al cargar los datos");
                            $.unblockUI();
                        }
                    }

                },
                selectSubjectPractice: function (materia, practica){
                    //console.log(practica);
                    var self = this;
                    self.loading();
                    let fnSelect = function (){
                        self.materias.push({
                            "id": materia.id,
                            "asignatura_id": self.asignatura.id,
                            "itinerario": self.asignatura.itinerario,
                            "nivelmalla_id": materia.nivelmalla_id,
                            "paralelo_id": materia.paralelo_id,
                            "practica": practica,
                            "horarios": materia.horarios,
                        });

                        self.asignaturasmalla.forEach(function(asignatura, index) {
                            if (asignatura.id == self.asignatura.id){
                                $("#btn_aplicar_"+self.asignatura.id).hide();
                                $("#btn_remover_"+self.asignatura.id).show();
                            }
                        });
                        setTimeout(function() {
                            $.unblockUI();
                        }, 2000);
                        self.closePractica();
                        self.closeAsignatura();
                        //self.countSelectSubjectLevel();
                        self.changeMatricularse();
                        self.changeItinerario();
                        self.changeNivelMatricula();
                        self.calcula_gratuidad();
                    }
                    if (self.valida_conflicto_horario && self.materias.length > 0){
                        /*let clases = []
                        self.materias.forEach(function(m, i) {
                            //console.log(m);
                            m.horarios.forEach(function(horario, j) {
                                if (horario.tipohorario == 1){
                                    clases.push(horario);
                                }

                            });
                            //console.log(m);
                            if (m.practica.length > 0){
                                m.practica.horarios.forEach(function(horario, i) {
                                    if (horario.tipohorario == 1){
                                        clases.push(horario);
                                    }
                                });
                            }
                        });*/
                        if (self.materias.length > 0) {
                            /*let clases_aux = [];
                            materia.horarios.forEach(function(horario, i) {
                                if (horario.tipohorario == 1){
                                    clases_aux.push(horario);
                                }
                            });
                            practica.horarios.forEach(function(horario, i) {
                                if (horario.tipohorario == 1){
                                    clases_aux.push(horario);
                                }
                            });*/
                            let materia_aux = {
                                "id": materia.id,
                                "asignatura_id": self.asignatura.id,
                                "itinerario": self.asignatura.itinerario,
                                "nivelmalla_id": materia.nivelmalla_id,
                                "paralelo_id": materia.paralelo_id,
                                "practica": practica,
                                "horarios": materia.horarios,
                            }
                            loadAjax({
                                'action': 'validConflictoHorario',
                                'materias': JSON.stringify(self.materias),
                                'materia': JSON.stringify(materia_aux)
                            }, '/alu_matricula/pregrado/demo')
                                .then(response => {
                                    if (response.value.result == 'ok')
                                    {
                                        if (response.value.conflicto){
                                            Swal.fire({
                                                toast: true,
                                                position: 'top-end',
                                                type: 'warning',
                                                title: response.value.mensaje,
                                                showConfirmButton: false,
                                                timer: 6000
                                            })
                                        }else{
                                            fnSelect();
                                        }
                                        $.unblockUI();
                                    }
                                    else
                                    {
                                        $.unblockUI();
                                        NotificationJG.error(response.value.mensaje);
                                    }
                                })
                                .catch(error => {
                                    $.unblockUI();
                                    NotificationJG.error(error.message);
                                });
                        }else {
                            if (fnSelect){
                                fnSelect();
                            }else {
                                NotificationJG.error("Ocurrio un error al cargar los datos");
                                $.unblockUI();
                            }
                        }
                    }else{
                        if (fnSelect){
                            fnSelect();
                        }else {
                            NotificationJG.error("Ocurrio un error al cargar los datos");
                            $.unblockUI();
                        }
                    }


                },
                openAsignatura: function (asignatura){
                    var self = this;
                    self.loading();
                    console.log(asignatura);
                    if (self.valida_materias_maxima && (self.materias.length + 1) > self.num_materias_maxima){
                        Swal.fire({
                            toast: false,
                            position: 'center',
                            icon:"error",
                            type: 'error',
                            title: 'Número de materias',
                            text: `Ha superado la cantidad (${self.num_materias_maxima}) asignaturas permitidas a seleccionar`,
                            showConfirmButton: false,
                            timer: 6000
                        });
                        $.unblockUI();
                        return true;
                    }

                    if (self.materias.length == 0 || self.va_ultima_matricula){
                        self.asignatura = asignatura;
                    }else{
                        if (asignatura.itinerario == 0)
                        {
                            var paralelo_id = 0;
                            self.materias.forEach(function(materia, index) {
                                if (materia.nivelmalla_id == asignatura.nivelmalla_id){
                                    paralelo_id = materia.paralelo_id
                                    return false;
                                }
                            });

                            if (paralelo_id > 0){
                                var aux_asignatura = {};
                                $.each( asignatura, function( key, value ) {
                                    if (key != 'materias')
                                    {
                                        aux_asignatura[key] = value
                                    }
                                });
                                var materias = []
                                asignatura.materias.forEach(function(materia, index) {
                                    if (paralelo_id == materia.paralelo_id){
                                        materias.push(materia)
                                    }
                                });
                                aux_asignatura['materias'] = materias
                                self.asignatura = aux_asignatura;
                            }else{
                                self.asignatura = asignatura;
                            }
                        }else {
                            self.asignatura = asignatura;
                        }

                    }

                    let fnModal = function (){
                        if (self.asignatura.materias.length >= 1 && self.asignatura.materias.length <=3){
                            self.$modalAsignatura.modal({backdrop:'static', width: '70%'}).modal('show');
                        }
                        else if (self.asignatura.materias.length > 3){
                            self.$modalAsignatura.modal({backdrop:'static', width: '70%', height: $(window).height()-250}).modal('show');
                        }else{
                            self.$modalAsignatura.modal({backdrop:'static', width: '50%'}).modal('show');
                        }
                        $.unblockUI();
                    }
                    if (self.valida_cupo_materia){
                        loadAjax({
                            'action': 'loadCupoMateria',
                            'asignatura': JSON.stringify(self.asignatura)
                        }, '/alu_matricula/pregrado/demo')
                            .then(response => {
                                if (response.value.result == 'ok'){
                                    self.asignatura = response.value.asignatura
                                    fnModal();
                                    $.unblockUI();
                                }else{
                                    $.unblockUI();
                                    NotificationJG.error(response.value.mensaje);
                                }
                            })
                            .catch(error => {
                                $.unblockUI();
                                NotificationJG.error(error.message);
                            });
                    }else{
                        if (fnModal){
                            fnModal();
                        }else {
                            NotificationJG.error("Ocurrio un error al cargar los datos");
                            $.unblockUI();
                        }
                    }

                },
                closePractica: function (){
                    var self = this;
                    //self.asignatura = {};
                    self.materia = {};
                    self.$modalPractica.modal('hide');
                },
                openPractica: function (materia){
                    var self = this;
                    self.loading();
                    self.materia = materia;

                    let fnModal = function (){
                        if (self.materia.length >= 1 && self.materia.length <= 3){
                            self.$modalPractica.modal({backdrop:'static', width: '70%'}).modal('show');
                        }
                        else if (self.materia.length > 3){
                            self.$modalPractica.modal({backdrop:'static', width: '70%', height: $(window).height()-250}).modal('show');
                        }else{
                            self.$modalPractica.modal({backdrop:'static', width: '50%'}).modal('show');
                        }
                        $.unblockUI();
                    }
                    if (self.valida_cupo_materia){

                        loadAjax({'action': 'loadCupoPractica', 'materia': JSON.stringify(self.materia)}, '/alu_matricula/pregrado/demo')
                            .then(response => {
                                if (response.value.result == 'ok'){
                                    self.materia = response.value.materia
                                    fnModal();
                                    $.unblockUI();
                                }else{
                                    $.unblockUI();
                                    NotificationJG.error(response.value.mensaje);
                                }
                            })
                            .catch(error => {
                                $.unblockUI();
                                NotificationJG.error(error.message);
                            });
                    }else{
                        if (fnModal){
                            fnModal();
                        }else {
                            NotificationJG.error("Ocurrio un error al cargar los datos");
                            $.unblockUI();
                        }
                    }

                },
                infoPredecesora: function (predecesoras, cantidad){
                    var self = this;
                    Swal.fire({
                        toast: false,
                        position: 'center',
                        icon:"info",
                        type: 'info',
                        title: 'Precedencias',
                        text: (cantidad > 0) ? predecesoras : 'No registra ninguna precedencia',
                        showConfirmButton: false,
                        timer: 6000
                    });
                },
                actionSearchLevel: function (){
                    $(".actionSearchLevel").click(function (){
                        var value = $(this).attr('value');
                        let levels = [];
                        $(".actionSearchLevel").removeClass('btn-inverse');
                        $(this).addClass('btn-inverse');
                        $('#listSubjects li').each(function(){
                            if (value.toLowerCase() == 'all')
                            {
                                $("#searchSubjects").val('');
                                $(this).show().addClass('valueYesSearch');
                                //$('.hr_nivel_malla').show();
                            }
                            else
                            {
                                if(converToAscii($(this).text().toLowerCase()).indexOf(converToAscii(value.toLowerCase())) === -1)
                                {
                                    $(this).hide().removeClass('valueYesSearch');
                                }
                                else{
                                    $(this).show().addClass('valueYesSearch');
                                    levels.push($(".thumbnail-level", $(this)).html());
                                }

                            }
                        });
                        if (value.toLowerCase() == 'all')
                        {
                            $('.hr_nivel_malla').show();
                        }else{
                            $('.hr_nivel_malla').each(function(){
                                if (levels.indexOf(converToAscii($(this).text().toLowerCase())) === -1){
                                    $(this).hide();
                                }
                                else{
                                    $(this).show();

                                }
                            });
                        }

                    });
                },
                search: function (){
                    $("#searchSubjects").keyup(function(){
                        var _this = this;
                        var clase = $('.search i');
                        if($(_this).val() != ''){
                            $(clase).attr('class', 'fa fa-times');
                        }else{
                            $(clase).attr('class', 'fa fa-search');
                        }
                        if($(clase).hasClass('fa fa-times')){
                            $(clase).click(function(){
                                $(_this).val('');
                                $('.valueYesSearch').show();
                                $(clase).attr('class', 'fa fa-search');
                            });
                        }
                        let levels = [];
                        $('.valueYesSearch').each(function(){
                            if(converToAscii($(this).text().toLowerCase()).indexOf(converToAscii($(_this).val().toLowerCase())) === -1){
                                $(this).hide();
                            }
                            else{
                                $(this).show();
                                //levels.push($(this).attr('nivel_malla_id'));
                                levels.push($(".thumbnail-level", $(this)).html());
                            }
                        });

                        $('.hr_nivel_malla').each(function(){
                            if (levels.indexOf(converToAscii($(this).text().toLowerCase())) === -1){
                                $(this).hide();
                            }
                            else{
                                $(this).show();

                            }
                        });

                    });
                },
                closeValoresPendientes: function (){
                    var self = this;
                    self.$modalValoresPendientes.modal('hide');
                },
                closeConfirmarMatricula: function (){
                    var self = this;
                    $('[name="acept_t"]', self.$modalConfirmarMatricula).prop('checked', false);
                    self.$modalConfirmarMatricula.modal('hide');
                },
                closeConfirmarDiferir: function(){
                    var self = this;
                    self.$modalConfirmarDiferir.modal('hide');
                    Swal.fire({
                        title: `NOTIFICACIÓN`,
                        text: `{% if persona.sexo.id == 1 %}Estimada{% else %}Estimado{% endif %} {{ persona }}, se informa que el proceso ha finalizado y registra valores por concepto de matricula. Consulte los valores en Módulo "Mis Finanzas"`,
                        type: 'warning',
                        icon: 'warning',
                        showCancelButton: false,
                        allowOutsideClick: false,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Aceptar',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.value) {
                            self.loading();
                            location.reload();
                        }else{
                            self.loading();
                            location.reload();
                        }
                    }).catch(error => {
                        NotificationJG.error(error.message);
                    });
                },
                calcula_gratuidad: function (){
                    var self = this;
                    //var materias_nivel = $("#id_materias_nivel_aperturadas").html();
                    //var materias_nivel_seleccionadas = $("#id_materias_seleccionadas_nivel_aperturadas").html();

                    self.cobro = 0;
                    self.porcentaje_seleccionadas = 0;
                    self.perdida_gratuidad = false;
                    self.mensaje_gratuidad = '';
                    if (self.valida_gratuidad && self.materias.length > 0){
                        self.porcentaje_seleccionadas = Math.round(((self.total_asignaturas_aperturadas * self.porciento_perdida_parcial_gratuidad) / 100), 0);
                        {% if not inscripcion.persona.tiene_otro_titulo %}
                            {% if inscripcion.estado_gratuidad == 1 or inscripcion.estado_gratuidad == 2 %}
                                if (self.total_asignaturas_aperturadas_seleccionada < self.porcentaje_seleccionadas){
                                    self.mensaje_gratuidad = `<p class='alert alert-danger' style='text-align: justify'>Con base en el Art.7 del Reglamento para garantizar el cumplimiento de la gratuidad, emitido por el Consejo de Educación Superior (CES) y en relación al Art.5 del Reglamento Interno para garantizar el ejercicio del derecho a la gratuidad en la Universidad Estatal de Milagro, informamos que usted se ha matriculado en menos del ${self.porciento_perdida_parcial_gratuidad}% de las asignaturas correspondientes a su nivel del plan de estudios; por lo tanto, no cumple con los requisitos necesarios para considerarse como ESTUDIANTE REGULAR, motivo por el cual deberá cancelar los valores correspondientes a matrícula y arancel.</p>`;
                                    self.cobro = 1;
                                }
                                else {
                                    {% if inscripcion.estado_gratuidad == 2 %}
                                        self.mensaje_gratuidad = "<p class='alert alert-danger' style='text-align: justify'>Con base al Art.5 del Reglamento para garantizar el cumplimiento de la gratuidad emitido por el Concejo de Educaci&oacute;n Superior (CES) y en relaci&oacute;n a los Arts. 6, 7 y 12 del Reglamento interno para garantizar el ejercicio del derecho a la gratuidad en la Universidad Estatal de Milagro. Su estado es P&Eacute;RDIDA PARCIAL DE LA GRATUIDAD y tendr&aacute; que cancelar el valor correspondiente entre matr&iacute;cula y arancel.</p>";
                                        self.cobro = 2;
                                    {% else %}
                                        self.mensaje_gratuidad = "<p class='alert alert-success' style='text-align: justify'>Ha seleccionado correctamente las asignatura de su nivel.</p>";
                                        self.cobro = 2;
                                    {% endif %}
                                }
                            {% else %}
                                self.mensaje_gratuidad = "<p class='alert alert-danger' style='text-align: justify'>Con base al Art.11 del Reglamento para garantizar el cumplimiento de la gratuidad emitido por el Concejo de Educaci&oacute;n Superior (CES) y en relaci&oacute;n al Art.11 del Reglamento interno para garantizar el ejercicio del derecho a la gratuidad en la Universidad Estatal de Milagro. Usted supera el 30% de las asignaturas reprobadas correspondientes al plan de estudios  como indica la Ley. Su estado es P&Eacute;RDIDA DEFINITIVA DE LA GRATUIDAD. A partir de este momento todas las asignaturas, cursos o sus equivalentes hasta la culminaci&oacute;n de su carrera, cancelar&aacute; los valores respectivos a matr&iacute;culas y aranceles.</p>";
                                self.cobro = 3;
                            {% endif %}
                        {% else %}
                            self.mensaje_gratuidad = "<p class='alert alert-danger' style='text-align: justify'>Con base al Art.5 tercer literal del Reglamento para garantizar el cumplimiento de la gratuidad emitido por el Concejo de Educaci&oacute;n Superior (CES) y en relaci&oacute;n al Art.4 segundo literal del Reglamento interno para garantizar el ejercicio del derecho a la gratuidad en la Universidad Estatal de Milagro. Por concepto de gratuidad se cubrir&aacute; un sola carrera por estudiante, usted mantiene X carreras financiadas por el Estado. Por la cual, se generar&aacute;n los valores respectivos por matr&iacute;cula y aranceles de las segundas o m&aacute;s carreras que no gocen de la gratuidad</p>";
                            self.cobro = 3;
                        {% endif %}
                        if (self.total_asignaturas_aperturadas_seleccionada < self.porcentaje_seleccionadas){
                            self.tipo_matricula = 2;
                            self.perdida_gratuidad = true;
                        }
                        else{
                            self.tipo_matricula = 1;
                        }
                    }


                },
                validConflictoHorario: function(materia){
                    var self = this;
                    //let hoy = moment.tz("America/Guayaquil").format('DD-MM-YYYY HH:mm');
                    //let clases = []
                    self.materias.forEach(function(m, i) {
                        m.horarios.forEach(function(horario, j) {
                            self.clases.push(horario);
                            /*clases.push({
                                "id": horario.id,
                                "dia": horario.dia,
                                "tipohorario": horario.tipohorario,
                                "aula": horario.aula,
                                "inicio_comienza": moment((horario.inicio + " " + horario.comienza), "DD-MM-YYYY HH:mm").tz("America/Guayaquil"),
                                "inicio": moment(horario.inicio, "DD-MM-YYYY").tz("America/Guayaquil"),
                                "comienza": moment(horario.comienza, "HH:mm").tz("America/Guayaquil"),
                                "fin_termina": moment((horario.fin + " " + horario.termina), "DD-MM-YYYY HH:mm").tz("America/Guayaquil"),
                                "fin": moment(horario.fin, "DD-MM-YYYY").tz("America/Guayaquil"),
                                "termina": moment(horario.termina, "HH:mm").tz("America/Guayaquil"),
                            });*/
                        });
                        if (m.practica.length > 0){
                            m.practica.horarios.forEach(function(horario, i) {
                                self.clases.push(horario);
                                /*clases.push({
                                    "id": horario.id,
                                    "dia": horario.dia,
                                    "tipohorario": horario.tipohorario,
                                    "aula": horario.aula,
                                    "inicio_comienza": moment((horario.inicio + " " + horario.comienza), "DD-MM-YYYY HH:mm").tz("America/Guayaquil"),
                                    "inicio": moment(horario.inicio, "DD-MM-YYYY").tz("America/Guayaquil"),
                                    "comienza": moment(horario.comienza, "HH:mm").tz("America/Guayaquil"),
                                    "fin_termina": moment((horario.fin + " " + horario.termina), "DD-MM-YYYY HH:mm").tz("America/Guayaquil"),
                                    "fin": moment(horario.fin, "DD-MM-YYYY").tz("America/Guayaquil"),
                                    "termina": moment(horario.termina, "HH:mm").tz("America/Guayaquil"),
                                });*/
                            });
                        }
                    });

                },
                openCalendar: function (){
                    var self = this;
                    self.loading();
                    loadAjax({'action': 'loadCalendar', 'idn': self.nivel_id}, '/alu_matricula/pregrado/demo')
                        .then(response => {
                            if (response.value.result == 'ok'){
                                $(".modal-body", self.$modalCalendar).html(response.value.json_content);
                                self.$modalCalendar.modal({backdrop:'static', width: '70%'}).modal('show');
                                $.unblockUI();
                            }else{
                                $.unblockUI();
                                NotificationJG.error(response.value.mensaje);
                            }
                        })
                        .catch(error => {
                            $.unblockUI();
                            NotificationJG.error(error.message);
                        });
                },
                closeCalendar: function (){
                    var self = this;
                    self.$modalCalendar.modal('hide');
                },
            }
        });
    </script>
{% endblock %}

