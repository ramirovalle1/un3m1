{% extends "base.html" %}
{% load sga_extras %}
{% block heading %}
    <script type="text/javascript" src='/static/js/jquery.validationEngine.js?v=1.0.0'></script>
    <script type="text/javascript" src='/static/js/jquery.validationEngine-es.js?v=1.0.0' ></script>
    <link type='text/css' rel='stylesheet' href="/static/css/validationEngine.jquery.css?v=1.0.0"/>
    <script type="text/javascript" src="/static/js/bootstrap-filestyle.min.js?v=1.0.0"> </script>
    <link type='text/css' rel='stylesheet' href="/static/chosen/chosen.css?v=1.3.0"/>
    <link type='text/css' rel='stylesheet' href="/static/chosen/ImageSelect.css?v=1.0.0"/>
    <script type="text/javascript" src="/static/chosen/chosen.jquery.js?v=1.0.0"> </script>
    <script type="text/javascript" src="/static/chosen/ImageSelect.jquery.js?v=1.0.0"> </script>
    <style>
        {#table {#}
        {#    overflow: hidden;#}
        {# }#}
        {##}
        {#td, th {#}
        {#    padding: 1px;#}
        {#    position: relative;#}
        {#    outline: 0;#}
        {# }#}
        {##}
        {#body:not(.nohover) tbody tr:hover {#}
        {#    background-color: #d9edf7;#}
        {# }#}
        {##}
        {#td:hover::after,#}
        {#thead th:not(:empty):hover::after,#}
        {#td:focus::after,#}
        {#thead th:not(:empty):focus::after {#}
        {#    content: '';#}
        {#    height: 10000px;#}
        {#    left: 0;#}
        {#    position: absolute;#}
        {#    top: -5000px;#}
        {#    width: 100%;#}
        {#    z-index: -1;#}
        {# }#}
        {##}
        {#td:hover::after,#}
        {#th:hover::after {#}
        {#    background-color: #d9edf7;#}
        {# }#}
        {##}
        {#td:focus::after,#}
        {#th:focus::after {#}
        {#    background-color: lightblue;#}
        {# }#}
        {##}
        {#/* Focus stuff for mobile */#}
        {#td:focus::before,#}
        {#tbody th:focus::before {#}
        {#    background-color: lightblue;#}
        {#    content: '';#}
        {#    height: 100%;#}
        {#    top: 0;#}
        {#    left: -5000px;#}
        {#    position: absolute;#}
        {#    width: 10000px;#}
        {#    z-index: -1;#}
        {# }#}
    </style>
    <script type="text/javascript">

        $(document).ready(function() {
            var h =$(window).height() - 332;
            var table = $('#example').DataTable({
                language: {
                    "decimal": "",
                    "emptyTable": "No hay información",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ Registros",
                    "infoEmpty": "Mostrando 0 to 0 of 0 Registros",
                    "infoFiltered": "(Filtrado de _MAX_ total Registros)",
                    "infoPostFix": "",
                    "thousands": ",",
                    "lengthMenu": "Mostrar _MENU_ Registroa",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscar:",
                    "zeroRecords": "Sin resultados encontrados",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "sPaginationType": "full_numbers",
                {#"scrollY": h,#}
                "scrollX": true,
                "scroller": true,
                "deferRender": true,
                {#"scrollCollapse": true,#}
                "paging":   true,
                "ordering": false,
                {#"sfixedHeader":    true,#}
                "info":     false,
                {#                "scrollY": '50vh',#}
                "order": [[ 1, 'asc' ]],
                "buttons": [
                    'copy', 'csv', 'excel', 'pdf', 'print'
                ],
                columnDefs: [
                    { orderable: false, targets: 0 },
                    { width: "300px", targets: 0 },
                    { orderable: false, targets: -1 }
                ],
                ordering: [[ 1, 'asc' ]],
                colReorder: {
                    fixedColumnsLeft: 1,
                    fixedColumnsRight: 1
                }

            });
            new $.fn.dataTable.FixedColumns( table, {
                leftColumns: 1,
                rightColumns: 1
            } );

        } );

        if (screen.width < 500) {
            $("tbody").addClass("nohover");
            $("td, th")
                .attr("tabindex", "1")
                .on("touchstart", function() {
                    $(this).focus();
                });

        }
        $(function() {
            $(".aplicaindicador").click(function(){
                actualizaCheckboxes('aplicaindicador', $(this)); return false;
            });
            actualizaCheckboxes = function(accion, obj){
                var codigoindi = obj.attr('indi');
                var idobj = obj.attr('idobj');
                $.blockUI({message: null});
                $.post("/poa_revisaevidencia", {'action': accion, 'codigoindi': codigoindi }, function(data){
                    $.unblockUI();
                    if (data.result=='ok'){
                        if (data.valor){
                            $("#idcalculofinal"+codigoindi).val(1)
                            obj.html('<i class="fa fa-check" style="color: green"></i>');
                            calculacumplimientoejecutado(codigoindi,idobj)
                        } else {
                            $("#idcalculofinal"+codigoindi).val(0)
                            obj.html('<i class="fa fa-remove" style="color: red"></i>');
                            calculacumplimientoejecutado(codigoindi,idobj)
                        }
                    }
                }, "json" );
                valores_check = null;
            };
            $(".generarmatriz").click(function() {
                $("#itemspanelgenerainforme").modal({backdrop:'static', width: '600px'}).modal('show');
            });
            $("#informe_generar").click(function () {
                bloqueointerface();
                totalpromediodesempeno = $("#id_totaldesempeno").html()
                {% if evaluacionperiodo.informeanual %}
                    totalpromedioobjetivo = $("#id_totalobjetivo").html()
                {% else %}
                    totalpromedioobjetivo = 0
                {% endif %}
                $.post("/poa_revisaevidencia", {'action':'generarmatrizevaluacion', 'idmatrizpoa': {{ matriz.id }}, 'totalpromediodesempeno': totalpromediodesempeno, 'totalpromedioobjetivo': totalpromedioobjetivo }, function(data) {
                    if (data.result == 'ok') {
                        location.reload();
                        $("#itemspanelgenerainforme").modal("hide");
                    }else{
                        mensajeWarning(data.mensaje);
                        $.unblockUI();
                    }
                }, 'json');
            });
            $("#informe_cancel").click(function () {
                $("#itemspanelgenerainforme").modal("hide");
            });
        });
        function recalculapromediodesempeno (){
            var sumadesempeno = 0
            var vecesdesempeno = 0
            $(".promediodesempeno").each(function(){
                vecesdesempeno ++;
                var codindicador = $(this).attr("codindicador")
                var vecesacti = $(this).attr("vecesacti")

                var numeronocalcula = 0
                $(".cumplimiento"+codindicador).each(function(){
                    idrubri = $(this).attr("idrubri")
                    if (idrubri ==3 || idrubri ==2){
                        numeronocalcula ++;
                    }
                });
                if (vecesacti==numeronocalcula){
                    vecesdesempeno --;
                }else{
                    valordesempeno = $("#id_desempeno"+codindicador).val()
                    sumadesempeno = sumadesempeno + parseFloat(valordesempeno)
                }

            });
            id_totaldesempeno = Math.round((sumadesempeno / vecesdesempeno) * 100) / 100;
            if(isNaN(id_totaldesempeno)){
                $("#id_totaldesempeno").html('-')
            }else{
                $("#id_totaldesempeno").html(id_totaldesempeno)
            }

            {% if evaluacionperiodo.informeanual %}
                {#INICIO CALCULA CUMPLIMIENTO OBJETIVO OPERATIVO#}
                var sumacumplimiento = 0
                var vecesobjetivo = 0
                $(".recorridoobjetivo").each(function(){
                    var codigoobjetivo = $(this).attr("codigoobjetivo")
                    var sumaaplica = 0;
                    $(".recorridoporindicador"+codigoobjetivo).each(function(){
                        var codiindi = $(this).attr("codiindi")
                        var codigocalculofinal = $("#idcalculofinal"+codiindi).val()
                        if (codigocalculofinal==1){
                            sumaaplica ++;
                        }
                    });
                    if (sumaaplica>0){
                        vecesobjetivo ++;
                        $("#id_noaplica"+codigoobjetivo).val(0)
                        sumacumplimiento = sumacumplimiento +  parseFloat($("#id_cumplimientoobjoperativo"+codigoobjetivo).val())
                    }else{
                        $("#id_noaplica"+codigoobjetivo).val(1)
                    }
                });

                id_cumplimientoobjoperativo = Math.round((sumacumplimiento / vecesobjetivo) * 100) / 100;
                if(isNaN(id_cumplimientoobjoperativo)){
                    $("#id_totalobjetivo").html('-')
                }else{
                    $("#id_totalobjetivo").html(id_cumplimientoobjoperativo)
                }
            {% endif %}
            {#FIN CALCULA CUMPLIMIENTO OBJETIVO OPERATIVO#}
        }

        function calculaeficienciapresupuesto(codigoindi, codigooperativo, codrubrica) {
            var id_planreformado = $("#id_planreformado"+codigooperativo).val();
            var id_planutilizado = $("#id_planutilizado"+codigooperativo).val();
            var totaleficienciapresupuesto = 0
            if (parseFloat(id_planutilizado) < parseFloat(id_planreformado)){
                totaleficienciapresupuesto = (parseFloat(id_planutilizado) / parseFloat(id_planreformado)) * 100
                totaleficienciapresupuesto = Math.round(totaleficienciapresupuesto * 100) / 100;
            }else{
                if (parseFloat(id_planutilizado) == 0 && parseFloat(id_planreformado) == 0){
                    totaleficienciapresupuesto = 0
                }else{
                    totaleficienciapresupuesto = 100
                }
            }
            $("#id_eficienciapresupuesto"+codigooperativo).val(parseFloat(totaleficienciapresupuesto))
            $(".indicadoresporobjetivo"+codigooperativo).each(function(){
                var totaleficienciatiempo = 0
                var totaleficienciatp = 0
                var idcodigoindicador = $(this).attr("codiindicador")
                totaleficienciatiempo = $("#id_eficienciatiempo"+idcodigoindicador).val()
                if (totaleficienciapresupuesto == 0 && id_planreformado == 0){
                    totaleficienciatp=parseFloat(totaleficienciatiempo)
                }else{
                    totaleficienciatp = (parseFloat(totaleficienciapresupuesto) + parseFloat(totaleficienciatiempo)) / 2
                }
                totaleficienciatp = Math.round(totaleficienciatp * 100) / 100;
                $("#id_eficienciatp"+idcodigoindicador).val(totaleficienciatp)

                var eficaciatotal = 0
                var eficienciatptotal = 0
                var totaldesempeno = 0
                eficaciatotal = $("#id_eficacia"+idcodigoindicador).val()
                eficienciatptotal = $("#id_eficienciatp"+idcodigoindicador).val()
                totaldesempeno = parseFloat(0.7 * eficaciatotal) + parseFloat(0.3 * eficienciatptotal)
                totaldesempeno = Math.round(totaldesempeno * 100) / 100;
                $("#id_desempeno"+idcodigoindicador).val(totaldesempeno)
            });
            bloqueointerface();
            $(".recorrido"+codigooperativo).each(function(){
                var cod_indi = $(this).attr("codindi")
                var coddetmatrizvaloracion = $(this).attr("coddetmatriz")
                var cod_eficienciatp = $("#id_eficienciatp"+cod_indi).val()
                var cod_desempeno = $("#id_desempeno"+cod_indi).val()
                var cod_planreformado = $("#id_planreformado"+codigooperativo).val();
                var cod_planutilizado = $("#id_planutilizado"+codigooperativo).val();
                var cod_eficienciapresupuesto = $("#id_eficienciapresupuesto"+codigooperativo).val()
                $.ajax({
                    type: "POST",
                    url: "/poa_revisaevidencia",
                    data: {'action': 'actualizamatrizvaloracionpresupuesto', 'iddetmatrizvaloracion': coddetmatrizvaloracion,'cod_eficienciatp':cod_eficienciatp,'cod_desempeno':cod_desempeno,'cod_planreformado':cod_planreformado,'cod_planutilizado':cod_planutilizado,'cod_eficienciapresupuesto':cod_eficienciapresupuesto  },
                    success: function(data) {
                        $.unblockUI();
                        if (data.result == 'ok') {
                            $.unblockUI();
                            {#location.href = "/poa_revisaevidencia?action=matrizvaloracionpoa&evaluacionperiodo={{ evaluacionperiodo.id }}&idd={{ departamento.id }}&idp={{ evaluacionperiodo.periodopoa.id }}";#}
                        } else {
                            mensajeWarning(data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        mensajeWarning(data.mensaje);
                    },
                    dataType: "json"
                });
            });
            recalculapromediodesempeno();
            calculacumplimientoejecutado(codigoindi,codigooperativo);
        }

        function calculapromedioobjetivooperativo(codigoindi,codigooperativo) {
            id_cumplimientoejecutado = $("#id_cumplimientoejecutado"+codigoindi).val()
            if (id_cumplimientoejecutado=='-'){
                id_cumplimientoejecutado = 0
            }
            id_desempeno = $("#id_desempeno"+codigoindi).val()
            totalcumplimientoindicador = parseFloat(({{ porcentajemeta }}) * id_cumplimientoejecutado) + parseFloat(({{ porcentajedesempeno }}) * id_desempeno)
            totalcumplimientoindicador = Math.round(totalcumplimientoindicador * 100) / 100;
            $("#id_cumplimientoindicador"+codigoindi).val(totalcumplimientoindicador)
            var totalsuma = 0
            var sumacalculofinal = 0
            $(".indicadoresporobjetivo"+codigooperativo).each(function(){
                var totalcumplimientoindicador = 0
                var totalponderacionindicador = 0
                var sumatoria = 0
                var idcalculofinal = 0
                var idcodigoindicador = $(this).attr("codiindicador")
                totalcumplimientoindicador = $("#id_cumplimientoindicador"+idcodigoindicador).val()
                totalponderacionindicador = $("#id_ponderacionindicador"+idcodigoindicador).val()
                idcalculofinal = $("#idcalculofinal"+idcodigoindicador).val()
                if (idcalculofinal==1){
                    sumacalculofinal = parseFloat(sumacalculofinal) + parseFloat(totalponderacionindicador)
                    sumatoria = parseFloat(totalcumplimientoindicador) * parseFloat(totalponderacionindicador)
                    totalsuma = parseFloat(totalsuma) + parseFloat(sumatoria)
                }
            });
            totalcumplimientoobjoperativoejecutado =parseFloat(((Math.round(totalsuma) / sumacalculofinal) * 100)/ 100).toFixed(2);
            if(isNaN(totalcumplimientoobjoperativoejecutado)) {
                $("#id_cumplimientoobjoperativo"+codigooperativo).val(0)
            }else{
                $("#id_cumplimientoobjoperativo"+codigooperativo).val(totalcumplimientoobjoperativoejecutado)
            }
            var sumacumplimiento = 0
            var vecesobjetivo = 0
            $(".recorridoobjetivo").each(function(){
                var codigoobjetivo = $(this).attr("codigoobjetivo")
                var sumaaplica = 0;
                $(".recorridoporindicador"+codigoobjetivo).each(function(){
                    var codiindi = $(this).attr("codiindi")
                    var codigocalculofinal = $("#idcalculofinal"+codiindi).val()
                    if (codigocalculofinal==1){
                        sumaaplica ++;
                    }
                });
                if (sumaaplica>0){
                    $("#id_noaplica"+codigoobjetivo).val(0)
                    vecesobjetivo ++;
                    sumacumplimiento = sumacumplimiento +  parseFloat($("#id_cumplimientoobjoperativo"+codigoobjetivo).val())
                }else{
                    $("#id_noaplica"+codigoobjetivo).val(1)
                }
            });
            id_cumplimientoobjoperativo = Math.round((sumacumplimiento / vecesobjetivo) * 100) / 100;
            if(isNaN(id_cumplimientoobjoperativo)){
                $("#id_totalobjetivo").html('-')
            }else{
                $("#id_totalobjetivo").html(id_cumplimientoobjoperativo)
            }
        }

        function calculacumplimientoejecutado(codigoindi,codigooperativo) {
            var id_metasemestral = $("#id_metasemestral"+codigoindi).val();
            var id_metaejecutada = $("#id_metaejecutada"+codigoindi).val();
            var totalcumplimientoejecutado = 0
            var totalcumplimientoindicador = 0
            if (id_metasemestral == 0){
                totalcumplimientoejecutado = 0
            }else{
                if (parseFloat(id_metaejecutada) >= parseFloat(id_metasemestral)){
                    totalcumplimientoejecutado = 100
                }else{
                    totalcumplimientoejecutado = (parseFloat(id_metaejecutada) / parseFloat(id_metasemestral)) * 100
                }
            }
            {#alert(totalcumplimientoejecutado)#}
            totalcumplimientoejecutado = Math.round(totalcumplimientoejecutado * 100) / 100;
            if (totalcumplimientoejecutado == 0){
                $("#id_cumplimientoejecutado"+codigoindi).val('-')
            }else{
                $("#id_cumplimientoejecutado"+codigoindi).val(totalcumplimientoejecutado)
            }

            {# INICIO CALCULA CUMPLIMIENTO OBJETIVO OPERATIVO#}
            {% if evaluacionperiodo.informeanual %}
                calculapromedioobjetivooperativo(codigoindi,codigooperativo);
            {% endif %}
            {#FIN CALCULA CUMPLIMIENTO OBJETIVO OPERATIVO#}

            bloqueointerface();
            $(".recorrido"+codigooperativo).each(function(){
                var cod_indi = $(this).attr("codindi")
                var coddetmatrizvaloracion = $(this).attr("coddetmatriz")
                var cod_metaejecutada = $("#id_metaejecutada"+cod_indi).val()
                var cod_cumplimientoejecutado = $("#id_cumplimientoejecutado"+cod_indi).val()
                var cod_cumplimientoindicador = $("#id_cumplimientoindicador"+cod_indi).val()
                var cod_cumplimientoobjetivo = $("#id_cumplimientoobjoperativo"+codigooperativo).val()
                $.ajax({
                    type: "POST",
                    url: "/poa_revisaevidencia",
                    data: {'action': 'actualizacumplimientototal', 'cod_cumplimientoobjetivo': cod_cumplimientoobjetivo,'cod_cumplimientoindicador': cod_cumplimientoindicador,'iddetmatrizvaloracion': coddetmatrizvaloracion,'cod_metaejecutada':cod_metaejecutada,'cod_cumplimientoejecutado':cod_cumplimientoejecutado },
                    success: function(data) {
                        $.unblockUI();
                        if (data.result == 'ok') {
                            $.unblockUI();
                            {#location.href = "/poa_revisaevidencia?action=matrizvaloracionpoa&evaluacionperiodo={{ evaluacionperiodo.id }}&idd={{ departamento.id }}&idp={{ evaluacionperiodo.periodopoa.id }}";#}
                        } else {
                            mensajeWarning(data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        mensajeWarning("Error de conexión.");
                    },
                    dataType: "json"
                });
            });
        }
        function imprimirmatriz(){
            totalpromediodesempeno = $("#id_totaldesempeno").html()
            totalpromedioobjetivo = $("#id_totalobjetivo").html()
            var listamatriz = ''
            $(".listanoaplica").each(function(){
                var validanoaplica = $(this).val()
                var codiobje = $(this).attr("codiobje")
                if (validanoaplica==1){
                    listamatriz += codiobje + ','
                }
            });
            listamatriz = listamatriz.substring(0, listamatriz.length-1);
            openwindow('POST' ,'/poa_revisaevidencia', {action:'matrizevaluacion_pdf',idd:{{ departamento.id }},idevaluacionperiodo:{{ evaluacionperiodo.id }},totalpromediodesempeno: totalpromediodesempeno,totalpromedioobjetivo: totalpromedioobjetivo,listamatriz: listamatriz }, '_blank');
        }

        function calculasemana(idactividad, idindicador, idoperativo, codirubri) {
            var id_semanaplan = $("#id_semanaplan"+idactividad).val()
            var id_semanaejec = $("#id_semanaejec"+idactividad).val()
            var restasemana = 0
            var porcentaje = 0
            var id_planreformado = $("#id_planreformado"+idoperativo).val();
            var porcentajecumplumiento = 0
            var vecescumplimiento = 0

            $(".cumplimiento"+idindicador).each(function(){
                idrubri = $(this).attr("idrubri")
                if (idrubri ==3 || idrubri ==2){
                    c=0
                }
                else{
                    vecescumplimiento ++;
                    porcentajecumplumiento = parseFloat(porcentajecumplumiento) + parseFloat($(this).attr("idcum"));
                }
            });
            if(isNaN(porcentajecumplumiento / vecescumplimiento)) {
                $("#id_eficacia"+idindicador).val(0)
            }else{
                totaleseficacia = 0
                totaleseficacia = porcentajecumplumiento / vecescumplimiento
                totaleseficacia = Math.round(totaleseficacia * 100) / 100;
                $("#id_eficacia"+idindicador).val(totaleseficacia)
            }

            if (parseFloat(id_semanaplan)!=0 && parseFloat(id_semanaejec)!=0 ){
                if (parseFloat(id_semanaplan)==parseFloat(id_semanaejec)){
                    $("#id_porcentajesem"+idactividad).val(100)
                }
                if (parseFloat(id_semanaejec) > parseFloat(id_semanaplan)){
                    restasemana = (parseFloat(id_semanaejec) - parseFloat(id_semanaplan)) * 5
                    porcentaje = 100 - parseFloat(restasemana)
                    if (porcentaje < 0){
                        porcentaje = 0
                    }
                    $("#id_porcentajesem"+idactividad).val(porcentaje)
                }
                if (parseFloat(id_semanaejec) <= parseFloat(id_semanaplan)){
                    $("#id_porcentajesem"+idactividad).val(100)
                }
            }else{
                $("#id_porcentajesem"+idactividad).val(0)
            }
            if(codirubri == 1){
                $("#id_porcentajesem"+idactividad).val(0)
            }
            var porcentajesemana = $("#id_porcentajesem"+idactividad).val()

            var porcentajecumplumientosemana = 0
            var vecesporcentajesemana = 0
            $(".porcentajesemana"+idindicador).each(function(){
                idrub = $(this).attr("idrub")
                if (idrub ==3 || idrub ==2){
                    c=0
                }else{
                    vecesporcentajesemana ++;
                    porcentajecumplumientosemana = parseFloat(porcentajecumplumientosemana) + parseFloat($(this).val());
                }
            });
            if(isNaN(porcentajecumplumientosemana / vecesporcentajesemana)) {
                $("#id_eficienciatiempo" + idindicador).val(0)
            }else{
                totaleficienciatiempovalor = porcentajecumplumientosemana / vecesporcentajesemana
                totaleficienciatiempovalor = Math.round(totaleficienciatiempovalor * 100) / 100;
                $("#id_eficienciatiempo"+idindicador).val(totaleficienciatiempovalor)
            }

            var totaleficienciatiempo = 0
            var totaleficienciapresupuesto = 0
            var totaleficienciatp = 0
            totaleficienciatiempo = $("#id_eficienciatiempo"+idindicador).val()
            totaleficienciapresupuesto = $("#id_eficienciapresupuesto"+idoperativo).val()
            if (totaleficienciapresupuesto == 0 && id_planreformado == 0){
                totaleficienciatp = parseFloat(totaleficienciatiempo)
            }else{
                totaleficienciatp = (parseFloat(totaleficienciatiempo) + parseFloat(totaleficienciapresupuesto)) / 2
            }
            totaleficienciatp = Math.round(totaleficienciatp * 100) / 100;
            if(totaleficienciatiempo==0){
                totaleficienciatp = 0
            }
            $("#id_eficienciatp"+idindicador).val(totaleficienciatp)

            var eficaciatotal = 0
            var eficienciatptotal = 0
            var totaldesempeno = 0
            eficaciatotal = $("#id_eficacia"+idindicador).val()
            eficienciatptotal = $("#id_eficienciatp"+idindicador).val()
            totaldesempeno = parseFloat(0.7 * eficaciatotal) + parseFloat(0.3 * eficienciatptotal)
            totaldesempeno = Math.round(totaldesempeno * 100) / 100;
            $("#id_desempeno"+idindicador).val(totaldesempeno)

            bloqueointerface();
            $(".cumplimiento"+idindicador).each(function(){
                var coddetmatrizvaloracion = $(this).attr("coddetmatriz")
                var codactividad = $(this).attr("codacti")
                var cod_semanaplan = $("#id_semanaplan"+codactividad).val()
                var cod_semanaejec = $("#id_semanaejec"+codactividad).val()
                var cod_porcentajesem = $("#id_porcentajesem"+codactividad).val()
                var cod_eficacia = $("#id_eficacia"+idindicador).val()
                var cod_eficienciatiempo = $("#id_eficienciatiempo"+idindicador).val()
                var cod_eficienciatp = $("#id_eficienciatp"+idindicador).val()
                var cod_desempeno = $("#id_desempeno"+idindicador).val()
                $.ajax({
                    type: "POST",
                    url: "/poa_revisaevidencia",
                    data: {'action': 'actualizamatrizvaloracion', 'iddetmatrizvaloracion': coddetmatrizvaloracion,'id_semanaplan':cod_semanaplan,'id_semanaejec':cod_semanaejec,'porcentajesemana':cod_porcentajesem,'cod_eficacia':cod_eficacia,'cod_eficienciatiempo':cod_eficienciatiempo,'cod_eficienciatp':cod_eficienciatp,'cod_desempeno':cod_desempeno  },
                    success: function(data) {
                        {#$.unblockUI();#}
                        if (data.result == 'ok') {
                            $.unblockUI();
                            {#location.href = "/poa_revisaevidencia?action=matrizvaloracionpoa&evaluacionperiodo={{ evaluacionperiodo.id }}&idd={{ departamento.id }}&idp={{ evaluacionperiodo.periodopoa.id }}";#}
                        } else {
                            mensajeWarning("Error de conexión.");
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        mensajeWarning("Error de conexión.");
                    },
                    dataType: "json"
                });
            });
            recalculapromediodesempeno();
            calculacumplimientoejecutado(idindicador,idoperativo) ;
        }
        function updateinforme(){
            bloqueointerface();
            totalpromediodesempeno = $("#id_totaldesempeno").html()
            {% if evaluacionperiodo.informeanual %}
                totalpromedioobjetivo = $("#id_totalobjetivo").html()
            {% else %}
                totalpromedioobjetivo = 0
            {% endif %}
            location.href = "/poa_revisaevidencia?action=actualizarmatrizevaluacion&idmatriz={{ matriz.id }}&totalpromediodesempeno="+totalpromediodesempeno+"&totalpromedioobjetivo="+totalpromedioobjetivo;
        }
    </script>
{% endblock %}
{% block atras %}/poa_revisaevidencia?action=periodosevaluacion&idd={{ departamento.id }}&idc=0&idp={{ periodopoa.id }}{% endblock %}
{% block canvas %}
    <div class='row'>
        <div class='col-lg-12'>
            <div class="headtitle">
                <h4>{{ title }}</h4>
                <h6>{{ departamento }}</h6>
                <h6>Periodo: {{ periodopoa.descripcion }}</h6>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12 pb-2">
                {% if not matrizarchivo.archivo %}
                    <a href="javascript:;" onclick="imprimirmatriz()" class='btn btn-mini btn-warning'><span class="fa fa-file-pdf-o " ></span> Imprimir matriz</a>
                    <a href='/poa_revisaevidencia?action=listadofirmas&idd={{ departamento.id }}&idpeval={{ evaluacionperiodo.id }}'  class='btn btn-mini btn-success bloqueo_pantalla'><span class="fa fa-list" ></span> Listado firmas</a>
                {% endif %}
                {% if mostrargenerar %}
                    {% if generarinforme %}
                        <a href="javascript:;" id="itemsadicionarobj" class="btn btn-success btn-mini generarmatriz" ide="q"><i class="fa fa-retweet"></i> Generar matriz evaluación</a>
                    {% endif %}
                {% endif %}
                {% if not generarinforme %}
                    {% if not matrizarchivo.archivo %}
                        <a href='#' onclick="updateinforme()" class="btn btn-success btn-mini" ide="q"><i class="fa fa-upload"></i> Actualizar o subir matriz evaluación</a>
                    {% else %}
                        {% if matrizarchivo.archivo %}
                            <a href="{{ matrizarchivo.download_link }}" target="_blank" class='btn btn-success btn-mini'><i class="fa fa-check"></i> Matriz evaluación firmada</a>
                        {% endif %}
                    {% endif %}
                    <strong>FECHA: </strong> {{ matrizarchivo.fecha|date:"Y-m-d" }}
                {% endif %}
                {%  if persona.usuario.is_superuser %}
                    <label class="label label-info">CODMATRIZ: {{ matriz.id }}</label>
                {% endif %}
            </div>
        </div>
        <div class="card mb-4">
            <div class="card-body border-top border-6 rounded-3 border-dark-info">
                <table class="table table-bordered table-striped display" id="example">
                    {% for doc in documento %}
                        <thead class="table-light">
                        <tr>
                            <th colspan="21" style="text-align: left; font-weight: bold;">
                                EJE ESTRATÉGICO: {{ doc.programa.nombre }}<br>
                                OBJETIVO ESTRATÉGICO: {{ doc.descripcion }}
                            </th>
                        </tr>
                        <tr>
                            <th colspan="3" style="text-align: center; font-weight: bold;"></th>
                            <th  colspan="1" style="text-align: center; font-weight: bold;">Panel Expertos</th>
                            <th colspan="3" style="text-align: center; font-weight: bold;">Tiempo</th>
                            <th class="col" colspan="2" style="text-align: center; font-weight: bold;">Presupuesto</th>
                            <th class="col" colspan="5" style="text-align: center; font-weight: bold;">Indicadores</th>
                            <th class="col" colspan="7" style="text-align: center; font-weight: bold;"></th>
                        </tr>
                        <tr>
                            <th class="col" style="text-align: center; font-weight: bold;width: 300px;">
                                Objetivo Operativo
                                _________________________
                            </th>
                            <th class="col" style="text-align: center; font-weight: bold;width: 400px;">
                                Indicador
                                _____________________________________
                            </th>
                            <th class="col" style="text-align: center; font-weight: bold;width: 700px;">
                                Actividad
                                ___________________________________________________________________________
                            </th>
                            <th class="col" style="vertical-align: middle;text-align: center; font-weight: bold;width: 250px;">Valoracion</th>
                            {#                    <th style="vertical-align: middle;text-align: center; font-weight: bold;width: 70px;">Cumplimiento</th>#}
                            <th style="vertical-align: middle;text-align: center; font-weight: bold;">Semana planificada.</th>
                            <th  class="col" style="vertical-align: middle;text-align: center; font-weight: bold;">Semana ejecutada.</th>
                            <th  style="vertical-align: middle;text-align: center; font-weight: bold;">% cumplimiento semana.</th>
                            <th class="col" style="vertical-align: middle;text-align: center; font-weight: bold;width: 70px;">Plan. Reformado.</th>
                            <th class="col" style="vertical-align: middle;text-align: center; font-weight: bold;width: 70px;">Utilizado.</th>
                            <th class="col" style="vertical-align: middle;text-align: center; font-weight: bold;width: 70px;">Eficacia</th>
                            <th class="col" style="vertical-align: middle;text-align: center; font-weight: bold;width: 70px;">Eficiencia tiempo</th>
                            <th class="col" style="vertical-align: middle;text-align: center; font-weight: bold;width: 70px;">Eficiencia presupuesto</th>
                            <th class="col" style="vertical-align: middle;text-align: center; font-weight: bold;width: 70px;">Eficiencia</th>
                            <th class="col" style="vertical-align: middle;text-align: center; font-weight: bold;width: 70px;">Desempeño</th>
                            <th class="col" style="vertical-align: middle;text-align: center; font-weight: bold;width: 70px;">Meta semes.</th>
                            <th class="col" style="vertical-align: middle;text-align: center; font-weight: bold;width: 70px;">Meta ejec.</th>
                            <th class="col" style="vertical-align: middle;text-align: center; font-weight: bold;width: 70px;">Cumplimiento Meta</th>
                            {% if evaluacionperiodo.informeanual %}
                                <th class="col" style="vertical-align: middle;text-align: center; font-weight: bold;width: 70px;">Cumplimiento Indicador</th>
                                <th class="col" style="vertical-align: middle;text-align: center; font-weight: bold;width: 70px;">Ponderación Indicadores</th>
                                <th class="col" style="vertical-align: middle;text-align: center; font-weight: bold;width: 10px;">Aplica</th>
                                <th class="col" style="vertical-align: middle;text-align: center; font-weight: bold;width: 70px;">Cumplimiento Objetivo Operativo</th>
                            {% endif %}
                        </tr>
                        </thead>
                        <tbody >
                        {% with itemindicadores=doc|args:evaluacionperiodo.id|args:departamento.id|call:'listadosemestrematriz' %}
                            {% for eval in itemindicadores %}
                                <tr>
                                    {% if eval.7 == eval.0  %}
                                        <td style="vertical-align: middle;text-align: justify" rowspan="{{ eval.6 }}">
                                            {{ eval.5 }}
                                            <div id="recorridoobjetivo" class="recorridoobjetivo" codigoobjetivo="{{ eval.13 }}" ></div>
                                        </td>
                                    {% endif %}
                                    {% if eval.4 == eval.0  %}
                                        <div id="recorridoindicador" class="recorridoindicador" codigoindicador="{{ eval.12 }}" ></div>
                                        <td class="indicadoresporobjetivo{{ eval.13 }}" codiindicador="{{ eval.12 }}" style="vertical-align: middle;text-align: justify" rowspan="{{ eval.3 }}">{{ eval.2 }} </td>
                                    {% endif %}
                                    <td style="vertical-align: middle;text-align: justify">{{ eval.1 }}</td>
                                    <td style="vertical-align: middle;text-align: left">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-default" style="font-weight: bold">
                                                <img src="{{ eval.34 }}" width="16px">
                                            </button>
                                            <button type="button" class="btn btn-default" style="font-weight: bold">
                                                <div style="text-align: left">{{ eval.11 }}</div>
                                            </button>
                                            <button type="button" class="btn btn-default" style="font-weight: bold">
                                                <div id="id_cumplimiento{{ eval.0 }}" class="cumplimiento{{ eval.12 }}" coddetmatriz="{{ eval.16 }}" codacti="{{ eval.0 }}" idrubri="{{ eval.8 }}" idcum='{{ eval.9 }}'>{{ eval.9 }}%</div>
                                                <div id="id_recorrido{{ eval.0 }}" class="recorrido{{ eval.13 }}" coddetmatriz="{{ eval.16 }}" codindi="{{ eval.12 }}"></div>
                                            </button>
                                        </div>
                                        {#                                        <table>#}
                                        {#                                            <tr>#}
                                        {#                                                <td width="20%"></td>#}
                                        {#                                                <td width="60%"></td>#}
                                        {#                                                <td width="20%">#}
                                        {##}
                                        {#                                                </td>#}
                                        {#                                            </tr>#}
                                        {#                                        </table>#}
                                    </td>
                                    {#                            <td style="vertical-align: middle;text-align: center">#}
                                    {##}
                                    {#                            </td>#}
                                    <td style="vertical-align: middle;text-align: center">
                                        <input id="id_semanaplan{{ eval.0 }}" {% if not generarinforme %}{% if matrizarchivo.archivo %}disabled{% endif %}{% endif %} onchange="calculasemana({{ eval.0 }},{{ eval.12 }},{{ eval.13 }},{{ eval.8 }})" name="id_semanaplan{{ eval.0 }}" type="text" style="width:50px;" value="{{ eval.15 }}">
                                    </td>
                                    <td style="vertical-align: middle;text-align: center">
                                        <input id="id_semanaejec{{ eval.0 }}" {% if not generarinforme %}{% if matrizarchivo.archivo %}disabled{% endif %}{% endif %} onchange="calculasemana({{ eval.0 }},{{ eval.12 }},{{ eval.13 }},{{ eval.8 }})" name="id_semanaejec{{ eval.0 }}" type="text" style="width:50px;" value="{{ eval.17 }}">
                                    </td>
                                    <td style="vertical-align: middle;text-align: center">
                                        <input id="id_porcentajesem{{ eval.0 }}" name="id_porcentajesem{{ eval.0 }}" class="porcentajesemana{{ eval.12 }}" idrub="{{ eval.8 }}" type="text" style="width:50px;" readonly value="{{ eval.18 }}">
                                    </td>
                                    {% if eval.7 == eval.0  %}
                                        <td style="vertical-align: middle;text-align: center" rowspan="{{ eval.6 }}">
                                            <input id="id_planreformado{{ eval.13 }}" {% if not generarinforme %}{% if matrizarchivo.archivo %}disabled{% endif %}{% endif %} name="id_planreformado{{ eval.13 }}" onchange="calculaeficienciapresupuesto({{ eval.12 }}, {{ eval.13 }},{{ eval.8 }})" type="text" style="width:75px;" value="{{ eval.19 }}">
                                        </td>
                                    {% endif %}
                                    {% if eval.7 == eval.0  %}
                                        <td style="vertical-align: middle;text-align: center" rowspan="{{ eval.6 }}">
                                            <input id="id_planutilizado{{ eval.13 }}" {% if not generarinforme %}{% if matrizarchivo.archivo %}disabled{% endif %}{% endif %} name="id_planutilizado{{ eval.13 }}" onchange="calculaeficienciapresupuesto({{ eval.12 }}, {{ eval.13 }},{{ eval.8 }})" type="text" style="width:75px;" value="{{ eval.20 }}">
                                        </td>
                                    {% endif %}
                                    {% if eval.4 == eval.0  %}
                                        <td style="vertical-align: middle;text-align: center" rowspan="{{ eval.3 }}">
                                            <input id="id_eficacia{{ eval.12 }}" name="id_eficacia{{ eval.12 }}" type="text" style="width:75px;" readonly value="{{ eval.21 }}">
                                        </td>
                                    {% endif %}
                                    {% if eval.4 == eval.0  %}
                                        <td style="vertical-align: middle;text-align: center" rowspan="{{ eval.3 }}">
                                            <input id="id_eficienciatiempo{{ eval.12 }}" name="id_eficienciatiempo{{ eval.12 }}" type="text" style="width:75px;" readonly value="{{ eval.22|floatformat:"2" }}">
                                        </td>
                                    {% endif %}
                                    {% if eval.7 == eval.0  %}
                                        <td style="vertical-align: middle;text-align: center" rowspan="{{ eval.6 }}">
                                            <input id="id_eficienciapresupuesto{{ eval.13 }}" name="id_eficienciapresupuesto{{ eval.13 }}" type="text" style="width:75px;" readonly value="{{ eval.23 }}">
                                        </td>
                                    {% endif %}
                                    {% if eval.4 == eval.0  %}
                                        <td style="vertical-align: middle;text-align: center" rowspan="{{ eval.3 }}">
                                            <input id="id_eficienciatp{{ eval.12 }}" name="id_eficienciatp{{ eval.12 }}" type="text" style="width:75px;" readonly value="{{ eval.24 }}">
                                        </td>
                                    {% endif %}
                                    {% if eval.4 == eval.0  %}
                                        <td style="vertical-align: middle;text-align: center;background-color: #d9edf7" rowspan="{{ eval.3 }}" class="promediodesempeno" codindicador="{{ eval.12 }}" vecesacti="{{ eval.3 }}">
                                            <input id="id_desempeno{{ eval.12 }}" name="id_desempeno{{ eval.12 }}" type="text" style="width:75px;" readonly value="{{ eval.25 }}">
                                        </td>
                                    {% endif %}
                                    {% if eval.4 == eval.0  %}
                                        <td style="vertical-align: middle;text-align: center" rowspan="{{ eval.3 }}">
                                            <input id="id_metasemestral{{ eval.12 }}" name="id_metasemestral{{ eval.12 }}" type="text" style="width:75px;" readonly value="{{ eval.14.numero }}">
                                        </td>
                                    {% endif %}
                                    {% if eval.4 == eval.0  %}
                                        <td style="vertical-align: middle;text-align: center" rowspan="{{ eval.3 }}">
                                            <input id="id_metaejecutada{{ eval.12 }}" {% if not generarinforme %}{% if matrizarchivo.archivo %}disabled{% endif %}{% endif %} name="id_metaejecutada{{ eval.12 }}" onchange="calculacumplimientoejecutado({{ eval.12 }},{{ eval.13 }})" type="text" {% if eval.14.numero == 0 %} readonly {% endif %} style="width:75px;" value="{{ eval.26 }}">
                                        </td>
                                    {% endif %}
                                    {% if eval.4 == eval.0  %}
                                        <td style="vertical-align: middle;text-align: center;background-color: #f1f1f1" rowspan="{{ eval.3 }}">
                                            {% if eval.14.numero == 0 %}
                                                <input id="id_cumplimientoejecutado{{ eval.12 }}" name="id_cumplimientoejecutado{{ eval.12 }}" type="text" style="width:75px;" readonly value="-">
                                            {% else %}
                                                <input id="id_cumplimientoejecutado{{ eval.12 }}" name="id_cumplimientoejecutado{{ eval.12 }}" type="text" style="width:75px;" readonly value="{{ eval.27 }}">
                                            {% endif %}
                                        </td>
                                    {% endif %}
                                    {% if evaluacionperiodo.informeanual %}
                                        {% if eval.4 == eval.0  %}
                                            <td style="vertical-align: middle;text-align: center;" rowspan="{{ eval.3 }}">
                                                <input id="id_cumplimientoindicador{{ eval.12 }}" name="id_cumplimientoindicador{{ eval.12 }}" type="text" style="width:75px;" readonly value="{{ eval.31 }}">
                                            </td>
                                        {% endif %}
                                        {% if eval.4 == eval.0  %}
                                            <td style="vertical-align: middle;text-align: center;" rowspan="{{ eval.3 }}">
                                                <input id="id_ponderacionindicador{{ eval.12 }}" name="id_ponderacionindicador{{ eval.12 }}" type="text" style="width:75px;" readonly value="{{ eval.30 }}">
                                            </td>
                                        {% endif %}
                                        {% if eval.4 == eval.0  %}
                                            <td style="vertical-align: middle;text-align: center;" rowspan="{{ eval.3 }}">
                                                <div class="recorridoporindicador{{ eval.13 }}" codiindi="{{ eval.12 }}"></div>
                                                <input type="hidden" id="idcalculofinal{{ eval.12 }}" name="idcalculofinal{{ eval.12 }}" {% if eval.33 %}value="1"{% else %}value="0"{% endif %}>
                                                <a href="javascript:;" {% if not matrizarchivo.archivo %}class="aplicaindicador"{% endif %} indi="{{ eval.12 }}" idobj="{{ eval.13 }}">
                                                    {% if eval.33 %}
                                                        <i class="fa fa-check" style="color: green"></i>
                                                    {% else %}
                                                        <i class="fa fa-remove" style="color: red"></i>
                                                    {% endif %}
                                                </a>
                                                {#                                    <input id="id_ponderacionindicador{{ eval.12 }}" name="id_ponderacionindicador{{ eval.12 }}" type="checkbox" {% if eval.33 %} checked {% endif %} style="width:75px;">#}
                                            </td>
                                        {% endif %}
                                        {% if eval.7 == eval.0  %}
                                            <td style="vertical-align: middle;text-align: center;" rowspan="{{ eval.6 }}">
                                                <input id="id_noaplica{{ eval.13 }}" name="id_noaplica{{ eval.13 }}" codiobje="{{ eval.13 }}" class="listanoaplica" type="hidden" style="width:75px;" readonly value="0">
                                                <input id="id_cumplimientoobjoperativo{{ eval.13 }}" name="id_cumplimientoobjoperativo{{ eval.13 }}" type="text" style="width:75px;" readonly value="{{ eval.32 }}">
                                            </td>
                                        {% endif %}
                                    {% endif %}
                                </tr>
                            {% endfor %}
                        {% endwith %}
                        </tbody>
                    {% endfor %}
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td colspan="3" style="text-align: center"><strong>Desempeño POA {{ evaluacionperiodo.periodopoa.anio }}</strong></td>
                        <td><div id="id_totaldesempeno" style="text-align: center">{{ data.totalpromediodesempeno }}</div></td>
                        {% if evaluacionperiodo.informeanual %}
                            <td colspan="6" style="text-align: center;background-color: #9ABC32"><strong>
                                <font color="white">CUMPLIMIENTO POA {{ evaluacionperiodo.periodopoa.anio }}</font>
                            </strong></td>
                            <td style="text-align: center"><div id="id_totalobjetivo" style="text-align: center"></div></td>
                        {% else %}
                            <td colspan="3"></td>
                        {% endif %}
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        recalculapromediodesempeno();
    </script>
    <div class="modal fade static" id="itemspanelgenerainforme" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h4>Generar matriz evaluación</h4></div>
                <div class="modal-body" style="min-height: 60px">
                    <form id="formulario" style="margin-bottom: 0; margin-top: 0; background-color: white">
                        <input type='hidden' id="iddel" name='id' value=""/>
                        <p style="margin-top: 10px;">Esta seguro(a) que desea generar matriz de evaluación: <b class="tiponame">{{ departamento.nombre }} {{ evaluacionperiodo.descripcion }} {{ evaluacionperiodo.fechafin|date:"Y" }}</b></p>
                        <p style="margin-top: 10px;"><b>NOTA:</b> Al dar clic en "Generar" se genera matriz de evaluación con fecha actual, la fecha será modificable. </p>
                    </form>
                </div>
                <div class="modal-footer">
                    <p style="text-align: right; margin-bottom: 0">
                        <a href="javascript:;" id="informe_generar" class='btn btn-success btn-form'><i class="fa fa-save"></i> Generar</a>
                        <a href="javascript:;" id="informe_cancel" class="btn btn-danger"><i class="fa fa-close"></i> Cancelar</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
{% endblock %}