{% extends "basebs.html" %}
{% load humanize %}
{% load sga_extras %}
{% block heading %}
    <script type="text/javascript" src="/static/js/jquery.isloading.min.js"></script>
    <link href="/static/css/table-responsive.css?1.0.0" type="text/css" rel="stylesheet" />
    <link href="/static/widget_ppp.css" rel="stylesheet"/>
    <style type="text/css">
        .radio label,
        .checkbox label {
            display: inline-block;
            cursor: pointer;
            color: #0074D9;
            position: relative;
            padding: 5px 15px 5px 51px;
            font-size: 1em;
            border-radius: 5px;
            -webkit-transition: all 0.3s ease;
            -o-transition: all 0.3s ease;
            transition: all 0.3s ease; }
        .radio label:hover,
        .checkbox label:hover {
            background: rgba(255, 65, 54, 0.1); }
        .radio label:before,
        .checkbox label:before {
            content: "";
            display: inline-block;
            width: 17px;
            height: 17px;
            position: absolute;
            left: 15px;
            border-radius: 50%;
            background: none;
            border: 3px solid #0074D9; }
        input[type="radio"] {
            display: none; }
        input[type="radio"]:checked + label:before {
            display: none; }
        input[type="radio"]:checked + label {
            padding: 5px 15px;
            background: #0074D9;
            border-radius: 2px;
            color: #fff; }
        .checkbox label:before {
            border-radius: 3px; }
        .checkbox input[type="checkbox"] {
            display: none; }
        .checkbox input[type="checkbox"]:checked + label:before {
            display: none; }
        .checkbox input[type="checkbox"]:checked + label {
            background: #0074D9;
            color: #fff;
            padding: 5px 15px; }
            table.dataTable{
                margin-bottom: 15px;
            }
            div.datatable-scroll{
                padding-top: 45px;
            }
    </style>
    <script type="text/javascript">
        $.extend(true, $.fn.dataTable.defaults, {
            oLanguage: {
                sSearch: "<span>Filtro:</span> _INPUT_",
                sLengthMenu: "<span>Mostrar Entradas:</span> _MENU_",
                sZeroRecords: "No se encontraron resultados",
                sProcessing: "Procesando...",
                sEmptyTable: "Ningún dato disponible para visualizar",
                sInfo: "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                sInfoEmpty: "Mostrando registros del 0 al 0 de un total de 0 registros",
                sLoadingRecords: "Cargando...",
                oPaginate: {
                    sFirst: "<i title='Inicio' class='fa fa-step-backward'></i>",
                    sLast: "<i title='Último' class='fa fa-step-forward'></i>",
                    sNext: "<i title='Siguiente' class='fa fa-fast-forward'></i>",
                    sPrevious: "<i title='Anterior' class='fa fa-fast-backward'></i>"
                },
            }
        });
        var uiModalSolicitudProfesorCatedra = {
                    init: function () {
                        var self = this;
                        self.$materias = [];
                        self.$modalForm = $('#modalSolicitudProfesorCatedra');
                        $('.action-close', self.$modalForm).click(function(){
                            self.close();
                        });
                        $('.action-edit', self.$modalForm).click(function(){
                            //self.setFormReadOnly(false);
                            self.setFormType('edit');
                        });
                        $('.action-save', self.$modalForm).click(function (){
                            self.actionSave();
                        });
                    },
                    processModalInit: function (type) {
                        var self = this;
                        $("#frmSolicitudProfesorCatedra", self.$modalForm).validationEngine({autoHidePrompt: true, autoHideDelay: 1000});
                        $('#id_carrera', self.$modalForm).select2({minimumResultsForSearch: 4 ,width:'100%'});
                        $('#id_carrera', self.$modalForm).change(function () {
                           let val = $(this).val();
                           if(val){
                               $('#id_materias_imparte').prop('disabled', false);
                           }else{
                               $('#id_materias_imparte').prop('disabled', true);
                           }
                           $('#id_materias_imparte').empty().append('<option value="">---------</option>').val(0).trigger("change");
                           self.$materias = [];
                            $("#dataMaterias tbody.principal", self.$modalForm).html('');
                        });
                        if (type != 'view'){
                            $('#id_materias_imparte', self.$modalForm).select2({
                            placeholder:'---------',
                            allowClear: true,
                            minimumResultsForSearch: 3,
                            dropdownParent: uiModalSolicitudProfesorCatedra.$modalForm,
                            width:'100%',
                            ajax: {
                                url:`{{ request.path }}`,
                                data: function (params) {
                                    bloqueointerface();
                                  var query = {
                                    search: params.term,
                                    carrera: $('#id_carrera').val(),
                                    action: 'loadMateriasImparte',
                                    exclude: JSON.stringify(self.$materias),
                                    type: 'public'
                                  }
                                  return query;
                                },
                                processResults: function (data) {
                                  $.unblockUI();
                                  return {
                                    results: data.results
                                  };
                                }
                            }
                        });
                        }else{
                            $('.action_add_horariomateria').hide();
                        }
                        $(".action_add_materia", self.$modalForm).click(function () {
                            let elMateria = $("#id_materias_imparte", self.$modalForm)
                            let val = elMateria.val();
                            if(val){
                                let eMateria = elMateria.select2('data')[0];
                                let tr_existe = false;
                                $("#dataMaterias tbody.principal", self.$modalForm).each(function(){
                                    var _id = $(this).attr('value');
                                    if (eMateria.id == _id)
                                    {
                                        tr_existe = true;
                                        $(this).remove();
                                    }
                                });
                                if(!tr_existe){
                                    var $tr = $('#el-templates [element="table-row-materia"] table tbody tr.principal').clone();
                                    $tr.attr('value', eMateria.id);
                                    $tr.data({'eMateria': eMateria});
                                    $('td.principal:nth-child(1)', $tr).html(eMateria.text);
                                    $('td.principal:nth-child(2)', $tr).html('');
                                    $('td.principal:nth-child(2)', $tr).html(`<div class="accordion-group">
                                        <div class="accordion-heading" style="background-color:#f0f0f0">
                                                <a style="color: black" class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#accordionhorariomateria${eMateria.id}" href="#collapsehorariomateria${eMateria.id}">
                                                    <span class="fa fa-chevron-down" aria-hidden="true"></span> Horario
                                                </a>
                                        </div>
                                        <div id="collapsehorariomateria${eMateria.id}" class="accordion-body tercerafilaacoordion collapse" style="height: 0px;">
                                            <div class="accordion-inner">
                                                <table class="table table-striped table-bordered text-center" id="tablehorariomateria${eMateria.id}">
                                                    <thead>
                                                        <tr>
                                                            <td style="text-align: center;width:30%;">Dia</td>
                                                            <td style="text-align: center;width:30%;">Hora Inicio</td>
                                                            <td style="text-align: center;width:30%">Hora Fin</td>
                                                            <td style="text-align: center;width:10%">
                                                                <a href="javascript:;" class='btn btn-mini btn-success action_add_horariomateria btn-a-h' title="Agregar Horario" value="${eMateria.id}">
                                                                    <span class="fa fa-plus"></span>
                                                                </a>
                                                            </td>
                                                        </tr>
                                                    </thead>
                                                    <tbody>

                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>`);
                                    $('td.principal:nth-child(3) input', $tr).attr('value', eMateria.numero_estudiantes);
                                    $('td.principal:nth-child(3) input', $tr).attr('val', eMateria.id);
                                    $('td.principal:nth-child(4) a', $tr).attr('value', eMateria.id);
                                    $("#dataMaterias tbody.principal", self.$modalForm).append($tr);
                                    self.$materias.push(eMateria.id);
                                    $('#id_materias_imparte').empty().append('<option value="">---------</option>').val(0).trigger("change");
                                }else{
                                    NotificationJG.error('La materia ya se encuentra agregada');
                                }
                            }else{
                               NotificationJG.error('Debe seleccionar una materia');
                            }
                        });
                        $(document).on('click', ".action_remove_materia", function(){
                            var id = $(this).attr('value');
                            var question = `¿Está seguro de quitar la materia <span class="label label-warning">${$('td:nth-child(1)', $(this).closest('tr.principal')).text()}</span>?`;
                            Confirm.question(question, function (){
                                $("#dataMaterias tbody.principal tr.principal", self.$modalForm).each(function(){
                                    var _id = $(this).attr('value');
                                    if (id == _id)
                                    {
                                        $(this).remove();
                                        NotificationJG.warning(`Se quito correctamente la materia`)
                                    }
                                });
                            });
                        });
                        $(document).on('click', ".action_add_horariomateria", function(e){
                            e.preventDefault();
                            e.stopImmediatePropagation();
                            let id = $(this).attr('value');
                            let eMateria = $(`tr.principal[value='${id}']`, self.$modalForm).data('eMateria');
                            var $tr = $('#el-templates [element="table-row-horario"] table tbody.example tr').clone();
                            console.log($tr);
                            $tr.attr('value', eMateria.id);
                            $tr.data('eHorario', {
                                'materia_id': eMateria.id,
                                'dia': '',
                                'horainicio': '',
                                'horafin': '',
                            });
                            console.log(eMateria);
                            $(`#tablehorariomateria${eMateria.id} tbody`, self.$modalForm).append($tr);
                        });
                        $(document).on('change', ".action_change_horariomateria", function(){
                           let typefield = $(this).attr('typefield');
                           let val = $(this).val();
                           var $tr = $(this).parent().parent();
                           let eHorario = $tr.data('eHorario');
                           switch (typefield) {
                                case 'dia':
                                    eHorario.dia = val;
                                    break;
                               case 'horainicio':
                                    eHorario.horainicio = val;
                                    break;
                               case 'horafin':
                                    eHorario.horafin = val;
                                    break;
                           }
                           $tr.data('eHorario', eHorario);
                        });
                        $(document).on('click', ".action_remove_horariomateria", function(){
                            let id = $(this).attr('value');
                            let question = `¿Está seguro de quitar el horario <span class="label label-warning">${'Horario seleccionado'}</span>?`;
                            var $tr = $(this).parent().parent().parent();
                            Confirm.question(question, function (){
                                $tr.remove();
                                NotificationJG.warning(`Se quito correctamente el horario`);
                            });
                        });
                        $(document).on('change', ".action_change_numeroestudiantes", function(){
                            let id = $(this).attr('val');
                            var $tr = $(`#dataMaterias tbody.principal tr.principal[value="${id}"]`);
                            let eMateria = $tr.data('eMateria');
                            eMateria.numero_estudiantes = $(this).val();
                            $tr.data('eMateria', eMateria);
                            console.log(eMateria);
                        });
                    },
                    close: function (){
                        var self = this;
                        self.$modalForm.modal('hide');
                    },
                    open: function(type, id, isEdit/*=undefined*/){

                        bloqueointerface();
                        isEdit = typeof isEdit == 'undefined' ? false : isEdit;
                        var self = this;
                        self.setFormType(type);
                        if (isEdit) {
                            $('.action-edit', self.$modalForm).addClass('disabled').hide();
                            $('.action-save', self.$modalForm).addClass('disabled').hide();

                        }
                        var h = $(window).height()-450;
                        $.ajax({
                            type: "GET",
                            url: "{{ request.path }}",
                            data: {'action': 'loadFormSolicitudProfesorCatedra', 'typeForm': type, 'id': id},
                            success: function(data) {
                                if (data.result == 'ok') {
                                    $.unblockUI();
                                    $(".modal-body", self.$modalForm).html(data.html);
                                    if(data.eMaterias.length > 0)
                                        self.setDetailData(data.eMaterias);
                                    var h = $(window).height() - 150;
                                    self.$modalForm.modal({backdrop:'static', width: '80%', height: h}).modal('show');
                                    self.processModalInit(type);
                                } else {
                                    $.unblockUI();
                                    NotificationJG.error(data.mensaje);
                                }
                            },
                            error: function() {
                                $.unblockUI();
                                NotificationJG.error("Error al enviar los datos.");
                            },
                            dataType: "json",
                        });
                    },
                    setFormType: function( type /* new, edit, view */ )
                    {
                        var self = this;

                        if( type == 'new' )
                        {
                            $('.modal-header span', self.$modalForm).html('Nueva');

                            $('.action-save', self.$modalForm).show();
                            $('.action-edit', self.$modalForm).hide();
                            self.setFormReadOnly(false);
                        }
                        else if( type == 'edit' )
                        {
                            $('.modal-header span', self.$modalForm).html('Editar');

                            $('.action-save', self.$modalForm).show();
                            $('.action-edit', self.$modalForm).hide();
                            self.setFormReadOnly(false);
                        }
                        else if( type == 'view' )
                        {
                            $('.modal-header span', self.$modalForm).html('Ver');
                            $('.action-save', self.$modalForm).hide();
                            $('#id_materias_imparte', self.$modalForm).hide();
                            $('.action_add_materia', self.$modalForm).hide();
                            $('.action_change_numeroestudiantes', self.$modalForm).prop('disabled',true);
                            $('[typefield="dia"]', self.$modalForm).prop('disabled',true);
                            $('.action-edit', self.$modalForm).hide();
                            self.setFormReadOnly(true);
                        }
                    },
                    setFormReadOnly: function( isFormReadOnly )
                    {
                        var self = this;

                        $('[name="name"]', self.$modalForm).prop('disabled', isFormReadOnly);
                        $('[name="name"]', self.$modalForm).prop('readonly', isFormReadOnly);

                         if ((!isFormReadOnly))
                        {
                            $(".action_new_carrera", self.$modalForm).css("display", "");
                            $(".action_remove_carrera", self.$modalForm).css("display", "");
                        }

                    },
                    formGetData:function(){
                        var self = this;
                        let formdata = new FormData($('#frmSolicitudProfesorCatedra', self.$modalForm)[0]);
                        var materias = []
                        $("#dataMaterias tbody.principal tr.principal", self.$modalForm).each(function(){
                            let eMateria = $(this).data('eMateria');
                            eMateria.horarios=[];
                            $(`#tablehorariomateria${eMateria.id} tbody tr`, $(this)).each(function () {
                                let eHorario = $(this).data('eHorario');
                                eMateria.horarios.push(eHorario);
                            });
                            materias.push(eMateria);
                        });
                        formdata.append("materias", JSON.stringify(materias));
                        return formdata;
                    },
                    actionSave: function (){
                        var self = this;
                        var valid = $("#frmSolicitudProfesorCatedra").validationEngine('validate');
                        {#var valid = $("#frmGrupo", self.$modalForm).validationEngine('validate', { scroll: false });#}
                        if (!valid){
                            return false;
                        }
                        $('.datepicker').css({"display": "none"});
                        $('.bootstrap-timepicker-widget').css({"display": "none"});

                        $('.controls input').each(function(){
                            if ($(this).attr('type')=='text'){
                                $(this).val($(this).val().trim());
                            }
                            if ($(this).attr('type')!='file'){
                                if ($(this).css('text-transform')=='uppercase'){
                                    if ($(this).attr('type')!='password'){
                                        $(this).val($(this).val().toUpperCase());
                                    }
                                }
                            }
                        });
                        var aData = self.formGetData();
                        //console.log(aData)
                        //console.log(JSON.parse(aData.get('materias')));
                        bloqueointerface();
                        $.ajax({
                            type: "POST",
                            url: "{{ request.path }}",
                            data: aData,
                            success: function(data) {
                                if (data.result == 'ok') {
                                    self.close();
                                    ControllerSolicitudesProfesorCatedra.$table.dataTable().fnDraw(false);
                                    NotificationJG.success(data.mensaje);
                                }
                                else{
                                    NotificationJG.error(data.mensaje);
                                }
                                $.unblockUI();
                            },
                            error: function() {
                                $.unblockUI();
                                NotificationJG.error("Error al enviar los datos.");
                            },
                            dataType: "json",
                            cache: false,
                            contentType: false,
                            processData: false
                        });
                    },
                    setDetailData: function(eMaterias) {
                      var self = this;
                      for (const eMateria of eMaterias) {
                        var $tr = $('#el-templates [element="table-row-materia"] table tbody tr.principal').clone();
                        $tr.attr('value', eMateria.id);
                        $tr.data({'eMateria': eMateria});
                        $('td.principal:nth-child(1)', $tr).html(eMateria.text);
                        let elementoHorario = $(`<div class="accordion-group">
                                        <div class="accordion-heading" style="background-color:#f0f0f0">
                                                <a style="color: black" class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#accordionhorariomateria${eMateria.id}" href="#collapsehorariomateria${eMateria.id}">
                                                    <span class="fa fa-chevron-down" aria-hidden="true"></span> Horario
                                                </a>
                                        </div>
                                        <div id="collapsehorariomateria${eMateria.id}" class="accordion-body tercerafilaacoordion collapse" style="height: 0px;">
                                            <div class="accordion-inner">
                                                <table class="table table-striped table-bordered text-center" id="tablehorariomateria${eMateria.id}">
                                                    <thead>
                                                        <tr>
                                                            <td style="text-align: center;width:30%;">Dia</td>
                                                            <td style="text-align: center;width:30%;">Hora Inicio</td>
                                                            <td style="text-align: center;width:30%">Hora Fin</td>
                                                            <td style="text-align: center;width:10%">
                                                                <a href="javascript:;" class='btn btn-mini btn-success action_add_horariomateria btn-a-h' title="Agregar Horario" value="${eMateria.id}">
                                                                    <span class="fa fa-plus"></span>
                                                                </a>
                                                            </td>
                                                        </tr>
                                                    </thead>
                                                    <tbody>

                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>`);
                        for (const eHorario of eMateria.horarios) {
                          let $htr = $('#el-templates [element="table-row-horario"] table tbody.example tr').clone();
                           $('td:nth-child(1) select', $htr).val(eHorario.dia);
                           $('td:nth-child(2) input', $htr).val(eHorario.horainicio);
                           $('td:nth-child(3) input', $htr).val(eHorario.horafin);
                          $htr.attr('value', eMateria.id);
                          $htr.data('eHorario', eHorario);
                          elementoHorario.find(`table#tablehorariomateria${eMateria.id} tbody`).append($htr);
                        }
                        $('td.principal:nth-child(2)', $tr).append(elementoHorario);
                        $('td.principal:nth-child(3) input', $tr).attr('value', eMateria.numero_estudiantes);
                        $('td.principal:nth-child(3) input', $tr).attr('val', eMateria.id);
                        $('td.principal:nth-child(4) a', $tr).attr('value', eMateria.id);
                        self.$materias.push(eMateria.id);
                        $("#dataMaterias tbody.principal", self.$modalForm).append($tr);
                      }
                      $('#id_materias_imparte', self.$modalForm).prop('disabled', false);
                    }
                };

        var uiModalCambiarEstadoSolicitudProfesorCatedra  = {
            init: function () {
                var self = this;
                self.$modalForm = $('#modalCambiarEstadoSolicitudProfesorCatedra');
                self.$table = $('.datatable table');
                self.$puede_guardar  = false;
                self.$id  = '';
                self.$estado  = 0;
                $('.action-close', self.$modalForm).click(function(){
                    NotificationJG.info("Enhorabuena el registro esta salvado.!");
                    self.close();
                });
                $('.action-edit', self.$modalForm).click(function(){
                    //self.setFormReadOnly(false);
                    self.setFormType('edit');
                });
                $('.action-save', self.$modalForm).click(function (){
                    self.actionSave();
                });
                $('#observacion', self.$modalForm).change(function (){
                    self.change_yes(this);
                });
            },
            open: function (id, current_status, name_span) {
                var self = this;
                self.$id = id;
                self.$estado=current_status;
                $('#observacion', self.$modalForm).val('');
                bloqueointerface();
                let htmlquestion =`<b>Información <br>¿Está seguro de aprobar la solicitud docente para ayudantía de cátedra?</b><br><span class="label label-warning">${name_span}</span> `;
                if(current_status === 3){
                     htmlquestion =`<b>Información <br>¿Está seguro de rechazar la solicitud docente para ayudantía de cátedra?</b><br> <span class="label label-warning">${name_span}</span>`;
                }
                $('#message-question', self.$modalForm).html(htmlquestion);
                setTimeout(function(){
                    $.unblockUI();
                    self.$modalForm.modal({backdrop:'static', width: '40%', keyboard: false}).modal('show');
                }, 1000);
            },
            close: function () {
                var self = this;
                self.$modalForm.modal('hide');
            },
            actionSave: function(){
                var self = this;
                if(self.$puede_guardar){
                    bloqueointerface();
                    let aData = {"action": "CambiarEstadoSolicitudProfesorCatedra", 'id': self.$id, 'estado':self.$estado, 'observacion': $('#observacion', self.$modalForm).val()}
                    $.ajax({
                        type: "POST",
                        url: "{{ request.path }}",
                        data: aData,
                        success: function(data) {
                            $
                            if (data.result == 'ok') {
                                self.$table.dataTable().fnDraw(false);
                                self.close();
                                NotificationJG.success(data.mensaje);
                            }
                            else{
                                NotificationJG.error(data.mensaje);
                            }
                        },
                        error: function() {
                            $.unblockUI();
                            NotificationJG.error("Error al enviar los datos.");
                        },
                        dataType: "json",
                    });
                }else{
                    NotificationJG.error("Debe llenar el campo observación.!");
                };
            },
            change_yes: function (elemento) {
                var self = this;
                if(elemento.value){
                    self.$puede_guardar=true;
                }else{
                    self.$puede_guardar=false;
                }
            }
        }


        var ControllerSolicitudesProfesorCatedra = {
                    init: function (){
                        var self = this;
                        self.$table = $('.datatable table');

                        $(".action-add").click(function (){
                           uiModalSolicitudProfesorCatedra.open('new', 0);
                        });
                        self.loadDataTable();
                         $("#action_min").click(function(){
                            $("#panel_filter .panel-body").hide();
                            $("#action_min").hide();
                            $("#action_max").show();
                        });
                        $("#action_max").click(function(){
                            $("#panel_filter .panel-body").show();
                            $("#action_min").show();
                            $("#action_max").hide();
                        });


                        $("#action_min").trigger("click");

                    },
                    loadDataTable: function(){
                        var self = this;
                        self.$table.dataTable({
                            responsive: true,
                            searchDelay: 1000,
                            bJQueryUI: false,
                            bAutoWidth: false,
                            //bProcessing: true,
                            bServerSide: true,
                            bSort: false,
                            sPaginationType: "full_numbers",
                            iDisplayLength: 25,
                            sDom: '<"datatable-header"fl><"datatable-scroll"tr><"datatable-footer"ip>',
                            sAjaxSource: "{{ request.path }}",
                            sServerMethod: "POST",
                            fnServerParams: function (aoData)
                            {
                                bloqueointerface();
                                aoData.push(
                                    {"name": "action", "value": 'loadDataTableSolicitudesProfesorCatedra'},
                                    {"name": "periodocatedra_id", "value": '{{ ePeriodoCatedra.id|encrypt }}'},
                                );
                                console.log(aoData);
                            },
                            aoColumnDefs:
                                [
                                    {
                                        aTargets: [0],
                                        width: "5%",
                                        mRender: function (data, type, row)
                                        {
                                            return `<span class="label label-success">${data}</span>`;
                                        },
                                        fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                        {
                                            if(sData != 'NULL') {
                                                $(nTd).css('text-align', 'center');
                                                $(nTd).css('vertical-align', 'middle');
                                                $(nTd).css('padding', '8px');
                                                $(nTd).attr('data-title', '#');
                                            }
                                        }
                                    },
                                    {
                                        aTargets: [1],
                                        width: "25%",
                                        mRender: function (data, type, row)
                                        {
                                            let html  = `
                                                    <p class="text-wrap m-0 p-0" >${data.name}</p>
                                                    <b>Docente:</b>
                                                    <a title="${data.docente.name}" href="${data.docente.foto}" class="fancybox" rel="group">
                                                    <img class="img-circle" src="${data.docente.foto}" width="30px">
                                                    </a> <span>${data.docente.name}</span><br>
                                                    <b>Carrera:</b> <span>${data.carrera}</span>
                                            `
                                            return html;
                                        },

                                        fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                        {
                                            if(sData != 'NULL') {
                                                $(nTd).css('text-align', 'left');
                                                $(nTd).css('vertical-align', 'middle');
                                                $(nTd).css('padding', '8px');
                                            }
                                        }
                                    },
                                    {
                                        aTargets: [2],
                                        width: "40%",
                                        mRender: function (data, type, row)
                                        {
                                            let html = `<div class="accordion-group">
                                                            <div class="accordion-heading" style="background-color:#f0f0f0">
                                                                <a style="color: black" class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#accordion${row[4].id}" href="#collapse${row[4].id}">
                                                                    <span class="fa fa-chevron-down" aria-hidden="true"></span> Detalle
                                                                </a>
                                                            </div>
                                                            <div id="collapse${row[4].id}" class="accordion-body tercerafilaacoordion collapse" style="height: 0px;">
                                                                <div class="accordion-inner">`;
                                            for (const materia of data) {
                                                html += ` <table class="table table-striped table-bordered text-center">
                                                                <thead>
                                                                    <tr><th colspan="2" style="text-align: left">${materia.name} <br>#Estudiantes: <label class="label label-info"> ${materia.number_students}</label></th></tr>
                                                                    <tr>
                                                                        <th style="text-align: center">Dia</th>
                                                                        <th style="text-align: center">Hora</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>`;
                                                                if ( materia.horarios.length == 0)
                                                                     html += `<tr><td colspan="3" style="text-align: center">No existe horario registrado</td></tr>`;
                                                                for (const horario of materia.horarios) {
                                                                    html += `<tr>
                                                                                <th style="text-align: center">${horario.dia}</th>
                                                                                <td style="text-align: center">${horario.horainicio} - ${horario.horafin}</td>
                                                                             </tr>`;
                                                                }
                                                html += `    </tbody>
                                                          </table>

                                                `;
                                            }
                                            html += `</div>
                                                    </div>
                                                </div>`;
                                            return html;
                                        },
                                        fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                        {
                                            if(sData != 'NULL') {
                                                $(nTd).css('text-align', 'left')
                                                $(nTd).css('vertical-align', 'middle')
                                                $(nTd).css('padding', '8px')
                                            }
                                        }
                                    },
                                    {
                                        aTargets: [3],
                                        width: "10%",
                                        mRender: function (data, type, row)
                                        {
                                            let colour_label =  data.estado != 3 ? data.estado !=2? 'warning':'important': 'success';
                                            let html = ``;
                                            html = `<span class="label label-${colour_label}">${data['estado_display']}</span>`;
                                            return html;
                                        },
                                        fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                        {
                                            if(sData != 'NULL') {
                                                $(nTd).css('text-align', 'center')
                                                $(nTd).css('vertical-align', 'middle')
                                                $(nTd).css('padding', '8px')
                                            }
                                        }
                                    },
                                    {
                                        aTargets: [4],
                                        width: "20%",
                                        mRender: function (data, type, row)
                                        {
                                            return `<input type="hidden" class="dt-col-option" value="${data.id_encr}"/>
                                                    <input type="hidden" class="dt-col-data-name" value="${data.name}" estado="${data.estado}" />`;
                                        },
                                        fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                        {
                                            if(sData != 'NULL') {
                                                $(nTd).css('text-align', 'center')
                                                $(nTd).css('vertical-align', 'middle')
                                                $(nTd).css('padding', '8px')
                                            }
                                        }
                                    },
                                ]
                            ,
                            fnDrawCallback: function (oSettingst)
                            {
                                //console.log(oSettingst);
                                $.unblockUI();
                                var count = 0;

                                $('.accordion').each(function (){
                                    $('.action-acordion', $(this)).click(function (){
                                        var ref = $(this).attr('value')
                                        if ($('[href="#'+ref+'"]').hasClass('in')){
                                            $(this).removeClass('collapsed');
                                            $('[href="#'+ref+'"]').removeClass('in');
                                        }else{
                                            $(this).addClass('collapsed');
                                            $('[href="#'+ref+'"]').addClass('in');
                                        }
                                    });

                                });

                                $('.dt-col-option').each(function(){
                                    var id = $(this).val();
                                    var nombre = $('.dt-col-data-name').eq(count).val();
                                    var estado = $('.dt-col-data-name').eq(count).attr('estado');
                                    var $html = $('#el-templates [element="table-row-actions"] .table-controls').clone();

                                    $('.dt-action-view', $html).click(function(){
                                        uiModalSolicitudProfesorCatedra.open('view', id);
                                    });


                                    $('.dt-action-edit', $html).click(function(){
                                        uiModalSolicitudProfesorCatedra.open('edit', id);
                                    });

                                    $('.dt-action-delete', $html).click(function(){
                                        var question = `Al eliminar el registro no podra volver a recuperar los datos. <br>¿Está seguro de eliminar el cronograma <span class="label label-warning">${nombre}</span>?`;
                                        Confirm.question(question, function (){
                                            console.log('id', id);
                                            bloqueointerface();
                                            var aData = {"action": "deleteSolicitudProfesorCatedra", 'id': id}
                                            $.ajax({
                                                type: "POST",
                                                url: "{{ request.path }}",
                                                data: aData,
                                                success: function(data) {
                                                    if (data.result == 'ok') {
                                                        $.unblockUI();

                                                        Swal.fire({
                                                            title: `NOTIFICACIÓN`,
                                                            text: data.mensaje,
                                                            type: 'success',
                                                            icon: 'success',
                                                            showCancelButton: false,
                                                            allowOutsideClick: false,
                                                            confirmButtonColor: '#3085d6',
                                                            cancelButtonColor: '#d33',
                                                            confirmButtonText: 'Aceptar',
                                                            cancelButtonText: 'Cancelar'
                                                        }).then((result) => {
                                                            if (result.value) {
                                                                ControllerSolicitudesProfesorCatedra.$table.dataTable().fnDraw(false);
                                                            }
                                                        }).catch(error => {
                                                            NotificationJG.error(error);
                                                            $.unblockUI();
                                                        });
                                                    }
                                                    else{
                                                        NotificationJG.error(data.mensaje);
                                                        $.unblockUI();
                                                    }

                                                },
                                                error: function() {
                                                    $.unblockUI();
                                                    NotificationJG.error("Error al enviar los datos.");
                                                },
                                                dataType: "json",
                                            });
                                        }, function () {
                                            NotificationJG.info("Enhorabuena el registro esta salvado.!");
                                            var h = $(window).height() - 350;
                                        });

                                    });

                                    if(estado == "2" || estado == "1"){
                                        $('.dt-action-change-status-approve', $html).click(function(){
                                            uiModalCambiarEstadoSolicitudProfesorCatedra.open(id,3, nombre);
                                        });
                                    }else{
                                        $('.dt-action-change-status-approve', $html).hide();
                                    }
                                    if(estado == "3" || estado == "1"){
                                        $('.dt-action-change-status-deny', $html).click(function(){
                                            uiModalCambiarEstadoSolicitudProfesorCatedra.open(id,2, nombre);
                                        });
                                    }else{
                                        $('.dt-action-change-status-deny', $html).hide();
                                    }

                                    count ++;
                                    $(this).after( $html );
                                });
                            }

                        });
                        $("#dtViewGroups_filter input").unbind(); // 'x' es el nombre de tu tabla
                        $('#dtViewGroups_filter input').bind('keyup', function (e) {
                            if (e.keyCode == 13) {
                                self.$table.dataTable().fnFilter(this.value);
                            }
                        });
                    }

                };

        $(function() {
            ControllerSolicitudesProfesorCatedra.init();
            uiModalSolicitudProfesorCatedra.init();
            uiModalCambiarEstadoSolicitudProfesorCatedra.init();
        });
    </script>

{% endblock %}
{% block atras %}/adm_ayudantiacatedra{% endblock %}
{% block canvas %}
    <div class='row-fluid'>
        <div class='span8'>
            <div><h4>{{ title }}</h4></div>
            <h3>Período cátedra:</h3>
            <p>{{ ePeriodoCatedra }}</p>
        </div>
    </div>
    <div id="no-more-tables">
        <div class='row-fluid'>
            <div class='span12'>
                <div class="datatable" id="divDetailData">
                    <table id="dtViewGroups" class='table table-bordered table-striped'>
                        <thead>
                        <tr>
                            <th style="text-align: center; vertical-align: middle; width: 10%" class="hidden-phone hidden-tablet">#</th>
                            <th style="text-align: center; vertical-align: middle; width: 30%">Solicitud</th>
                            <th style="text-align: center; vertical-align: middle; width: 30%">Materias</th>
                            <th style="text-align: center; vertical-align: middle; width: 10%">Estado</th>
                            <th style="text-align: center; vertical-align: middle; width: 20%">Acciones</th>
                        </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade static" id="showdetalle" style="display: none;">
        <div class="modal-header">
            <h4 id="paneltitle">Malla Estudiante</h4>
        </div>
        <div class="modal-body" id="body-modal">
        </div>
        <div class="modal-footer">
            <a  href="javascript:;" id="cerrardetallemodal" class="btn btn-success">Cerrar</a>
        </div>
    </div>
    <div class="modal fade static" id="modalverinforme" style="display: none;">
        <div class="modal-header">
            <h3 class="paneltitle">Historial del informe</h3>
        </div>
        <div class="modal-body panelbody">
        </div>
        <div class="modal-footer">
            <table class="pull-right">
                <tr>
                    <td><a href="javascript:;" class="btn btn-cerrar btn-info">Cerrar</a></td>
                </tr>
            </table>
        </div>
    </div>
    <div class="modal fade static" id="modalSolicitudProfesorCatedra" style="display: none;">
        <div class="modal-header">
            <h4 class="paneltitle"><span></span> Solicitud Catedra</h4>
        </div>
        <div class="modal-body panelbody">

        </div>
        <div class="modal-footer">
{#            {% if perms.bd.puede_modificar_grupo %}#}
                <a href="javascript:;" class="btn btn-success action-save">Guardar</a>
                <a href="javascript:;" class="btn btn-info action-edit">Editar</a>
{#            {% endif %}#}
            <a href="javascript:;" class="btn btn-danger action-close"> Cerrar</a>
        </div>
    </div>
    <div class="modal fade static" id="modalCambiarEstadoSolicitudProfesorCatedra" style="display: none;">
        <div class="modal-header">
            <h4 id="justificacionpaneltitle">Confirmaci&oacute;n</h4>
        </div>
        <div class="modal-body">
            <form action="javascript:;" id="formmodalChangeStatusRequest">
                <div id="message-question"></div>
                <br>
                <label class="observacion" required>Observación:</label><br>
                <input type="text" style="text-transform: uppercase" class="input-block-level" id="observacion">
            </form>
        </div>
        <div class="modal-footer">
            <a  href="javascript:;"  class="btn btn-danger action-save">SI</a>
            <a  href="javascript:;"  class="btn btn-info action-close">NO</a>
        </div>
    </div>
    <div id="el-templates" style="display:none;">
            <div element="table-row-actions">
            <table>
                <tbody>
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>
                        <div class="table-controls">
                            <div class="btn-group">
                                <a class="btn btn-mini dropdown-toggle" data-toggle="dropdown" href="javascript:;">Acciones<span class="caret"></span>
                                </a>
                                <ul class="dropdown-menu pull-right" style="text-align: left">
                                    <li><a href="javascript:;" class="dt-action-view"><i class="fa fa-eye"></i> Ver</a></li>
                                    <li><a href="javascript:;" class="dt-action-change-status-approve"><i class="fa fa-check"></i> Aprobar</a></li>
                                    <li><a href="javascript:;" class="dt-action-change-status-deny"><i class="fa fa-close"></i> Rechazar</a></li>
{#                                    <li><a href="javascript:;" class="dt-action-change-status"><i class="fa fa-tags"></i> Materias</a></li>#}
{#                                    <li><a href="javascript:;" class="dt-action-edit"><i class="fa fa-edit"></i> Editar</a></li>#}
{#                                    <li><a href="javascript:;" class="dt-action-delete"><i class="fa fa-trash"></i> Eliminar</a></li>#}
                                </ul>
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div element="table-row-materia">
            <table>
                <tbody>
                    <tr class="principal">
                        <td class="principal" style="text-align: left; vertical-align: middle"></td>
                        <td class="principal" style="text-align: left; vertical-align: middle"></td>
                        <td class="principal" style="text-align: left; vertical-align: middle"><input type="number" class="form-control action_change_numeroestudiantes" style="width:100%"></td>
                        <td class="principal" style="text-align: center; vertical-align: middle">
                            <div class="btn-group">
                                <a style="margin-right: 5px; {% if typeForm == 'view' %}display:none{% endif %}" href="javascript:;" class='btn btn-mini btn-danger action_remove_materia' title="Quitar materia"><span class="fa fa-remove"></span></a>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div element="table-row-horario">
            <table>
                <tbody class="example">
                    <tr>
                        <td style="text-align: left; vertical-align: middle">
                            <select name="dia_horario" id="id_dia_horario" class="action_change_horariomateria" typefield="dia" style="width: 100%;">
                                <option value="">--------------</option>
                                {% for dia in dias %}
                                    <option value="{{ dia.0 }}">{{ dia.1 }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td style="text-align: left; vertical-align: middle">
                            <input type="time" name="hora_inicio_horario" class="selectorhora action_change_horariomateria" typefield="horainicio" style="width:100%;height:30px;" id="id_hora_inicio_horario">
                        </td>
                        <td style="text-align: left; vertical-align: middle">
                            <input type="time" name="hora_fin_horario" class="selectorhora action_change_horariomateria" typefield="horafin" style="width:100%;height:30px;" id="id_hora_fin_horario">
                        </td>
                        <td style="text-align: center; vertical-align: middle">
                            <div class="btn-group">
                                <a style="margin-right: 5px;"
                                   href="javascript:;" class='btn btn-mini btn-danger action_remove_horariomateria' title="Quitar horario">
                                    <span class="fa fa-remove"></span>
                                </a>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}
