{% extends "basebs.html" %}
{% load sga_extras %}
{% block heading %}

    <style type="text/css">
        /*COLORES
        $aqua: #7FDBFF
        $blue: #0074D9
        $navy: #001F3F
        $teal: #39CCCC
        $green: #2ECC40
        $olive: #3D9970
        $lime: #01FF70
        // Warm
        $yellow: #FFDC00
        $orange: #FF851B
        $red:    #FF4136
        $fuchsia: #F012BE
        $purple: #B10DC9
        $maroon: #85144B
        // Gray Scale
        $white: #fff
        $silver: #ddd
        $gray:  #aaa
        $black: #111*/
        .modal-header {
            padding: 9px 15px;
            border-bottom: 1px solid #ddd;
            background-color: #eaf5e2;
            color: #3f572c;
            border-radius: 6px 6px 0 0;
        }


        .radio label,
        .checkbox label {
            display: inline-block;
            cursor: pointer;
            color: #0074D9;
            position: relative;
            padding: 5px 15px 5px 51px;
            font-size: 1em;
            border-radius: 5px;
            -webkit-transition: all 0.3s ease;
            -o-transition: all 0.3s ease;
            transition: all 0.3s ease; }
        .radio label:hover,
        .checkbox label:hover {
            background: rgba(255, 65, 54, 0.1); }
        .radio label:before,
        .checkbox label:before {
            content: "";
            display: inline-block;
            width: 17px;
            height: 17px;
            position: absolute;
            left: 15px;
            border-radius: 50%;
            background: none;
            border: 3px solid #0074D9; }
        input[type="radio"] {
            display: none; }
        input[type="radio"]:checked + label:before {
            display: none; }
        input[type="radio"]:checked + label {
            padding: 5px 15px;
            background: #0074D9;
            border-radius: 2px;
            color: #fff; }
        .checkbox label:before {
            border-radius: 3px; }
        .checkbox input[type="checkbox"] {
            display: none; }
        .checkbox input[type="checkbox"]:checked + label:before {
            display: none; }
        .checkbox input[type="checkbox"]:checked + label {
            background: #0074D9;
            color: #fff;
            padding: 5px 15px; }
    </style>
    <script type="text/javascript">
        $.extend(true, $.fn.dataTable.defaults, {
            oLanguage: {
                sSearch: "<span>Filtro:</span> _INPUT_",
                sLengthMenu: "<span>Mostrar Entradas:</span> _MENU_",
                sZeroRecords: "No se encontraron resultados",
                sProcessing: "<div style='margin: 0 auto; width: 60px; height: 60px; background-color: #0c6251; opacity: .6'><img src='/static/images/ajax-document-loader.gif'/></div>",
                sEmptyTable: "Ningún dato disponible para visualizar",
                sInfo: "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                sInfoEmpty: "Mostrando registros del 0 al 0 de un total de 0 registros",
                sLoadingRecords: "Cargando...",
                oPaginate: {
                    sFirst: "<i title='Inicio' class='fa fa-step-backward'></i>",
                    sLast: "<i title='Último' class='fa fa-step-forward'></i>",
                    sNext: "<i title='Siguiente' class='fa fa-fast-forward'></i>",
                    sPrevious: "<i title='Anterior' class='fa fa-fast-backward'></i>"
                },
            }
        });


        var myController = {
            //************************************************
            // FUNCTION **************************************
            //************************************************
            init: function ()
            {
                var self = this;

                $(".addTestPaciente").click(function (){
                    myModalSearchPaciente.open();
                });

                $("#search").click(function() {
                    self.search();
                });

                $('#searchinput').keyup(function(e) {
                    if(e.keyCode == 13) {
                        self.search();
                    }
                });

                $(".view_data_paciente").click(function() {
                    var id = $(this).attr('idp');
                    myModalDatosPaciente.open(id);
                });


                $(".view_data_test").click(function() {
                    var id = $(this).attr('idp');
                    var paciente = $(this).attr('paciente');
                    myModalTestsPaciente.open(id, paciente);
                });


            },
            search: function(){
                var term = $("#searchinput").val().trim().toUpperCase();
                if (term.length>0){
                    location.href = "/box_psicologica?action=pacientes_test_psicologicos&s="+term;
                }
                return false;
            },

        };
        var myModalAddPaciente = {
            init: function () {
                var self = this;

                self.$popup = $('#modalAddPaciente');
                $("[name='nacimiento']", self.$popup).datepicker({format:"dd-mm-yyyy"}).on('changeDate', function(ev){ $(this).datepicker('hide');});

                $(".action-close", self.$popup).click(function (){
                    self.closePopup();
                });


                $(".action-save-paciente", self.$popup).click(function (){
                    self.save();
                });

                self.$popup.on("show.bs.modal", function () {
                });

                self.$popup.on("hidden.bs.modal", function () {
                    //self.setFormReadOnlyAsignacionClase(false);
                    //self.setDataAsignacionClase(null);
                });


            },
            open: function (id_test, isEdit/*=false*/) {
                var self = this;
                bloqueointerface();
                self.formSetError([]);
                var fOpen = function (){
                    var h = $(window).height() - 150;
                    $('.modal-title > span', self.$popup).html(isEdit ? 'Editar': 'Nuevo')
                    self.$popup.modal({backdrop:'static', width: '50%',  height: '50%'}).modal('show');
                    $.unblockUI();
                }
                if (fOpen())
                {
                    fOpen();
                }


            },
            closePopup: function () {

                var self = this


                self.formReset();


                self.$popup.modal('hide');

            },
            formReset: function (){
                var self = this;
                /*$("[name='nombre']", self.$popup).val('');
                $("[name='version']", self.$popup).val('');
                $("[name='id_test']", self.$popup).val(0);
                $("[name='instruccion']", self.$popup).html('');*/
                self.formSetError([]);
            },
            formSetError: function( data ) {
                var self = this;

                var $form_group = $('.form-group', self.$popup);

                $form_group.removeClass('has-error');
                $('.label-important', $form_group ).html('').hide();
                //console.log(data);
                for( var i in data )
                {
                    //console.log(data[i].name);
                    var $form_group = $('[name="'+( data[i].name )+'"]', self.$popup).closest('.form-group');
                    $form_group.addClass('has-error');
                    $('.label-important', $form_group ).html( data[i].error ).show();
                }
            },
            save: function (){
                var self = this;
                //self.resetForm();
                var tipo_identificacion = $("[name='tipo_identificacion']", self.$popup).val();
                var identificacion = $("[name='identificacion']", self.$popup).val();
                var apellido_paterno = $("[name='apellido_paterno']", self.$popup).val();
                var apellido_materno = $("[name='apellido_materno']", self.$popup).val();
                var nombres = $("[name='nombres']", self.$popup).val();
                var sexo = $("[name='sexo']", self.$popup).val();
                var nacimiento = $("[name='nacimiento']", self.$popup).val();




                var dataFilter = {  'tipo_identificacion': tipo_identificacion,
                    'identificacion': identificacion,
                    'apellido_paterno': apellido_paterno,
                    'apellido_materno': apellido_materno,
                    'nombres': nombres,
                    'sexo': sexo,
                    'nacimiento': nacimiento,
                    'action': 'save_add_paciente' }

                smoke.confirm("¿Está seguro de agregar un nuevo paciente.?", function(e){
                    if (e){
                        bloqueointerface();
                        $.ajax({
                            type: "POST",
                            url: "/box_psicologica",
                            data:dataFilter,
                            success: function(data) {
                                if (data.result=='ok'){
                                    NotificationJG.success(data.mensaje, "Exitoso")
                                    self.closePopup();
                                    myModalSearchPaciente.$table.dataTable().fnDraw();

                                } else {
                                    NotificationJG.error(data.mensaje, "Error")
                                    self.formSetError(data.errores)
                                }
                                $.unblockUI();
                            },
                            error: function() {
                                NotificationJG.error("Existio un error en la conexión", "Error");
                                $.unblockUI();
                            },
                            dataType: "json"
                        });
                    }
                }, {
                    ok: "SI,SEGURO",
                    cancel: "NO,CANCELAR",
                    classname: "custom-class",
                    reverseButtons: true
                });

            },
        }
        var myModalSearchPaciente = {
            init: function () {
                var self = this;

                self.$popup = $('#modalSearchPaciente');
                self.$table = $('#dataTableListPacientes table');

                $(".action-close", self.$popup).click(function (){
                    self.closePopup();
                });

                $(".action-add-paciente", self.$popup).click(function (){
                    myModalAddPaciente.open();
                });

                self.$popup.on("show.bs.modal", function () {
                });

                self.$popup.on("hidden.bs.modal", function () {
                    //self.setFormReadOnlyAsignacionClase(false);
                    //self.setDataAsignacionClase(null);
                });


            },
            open: function () {
                var self = this;
                bloqueointerface();
                var fOpen = function (){
                    var h = $(window).height() - 150;
                    //$('.modal-title > span', self.$popup).html(isEdit ? 'Editar': 'Nuevo')
                    self.$popup.modal({backdrop:'static', width: '90%',  height: h}).modal('show');
                    $.unblockUI();
                }
                self.$table.dataTable({
                    responsive: true,
                    searchDelay: 1000,
                    bJQueryUI: false,
                    bAutoWidth: false,
                    //bProcessing: true,
                    bServerSide: true,
                    bSort: false,
                    sPaginationType: "full_numbers",
                    iDisplayLength: 25,
                    sDom: '<"datatable-header"fl><"datatable-scroll"tr><"datatable-footer"ip>',
                    sAjaxSource: "box_psicologica",
                    sServerMethod: "POST",
                    //"dom": '<"toolbar">frtip',
                    //buttons: ['csv', 'excel', 'pdf', 'print'],
                    aoColumnDefs:
                        [
                            {
                                /*SELECCIÓN*/
                                aTargets: [0],
                                width: "15%",
                                mRender: function (data, type, row)
                                {
                                    return '<input type="hidden" class="dt-col-option-list-test" value="' + (data.id) + '"/>'+
                                        '<input type="hidden" class="dt-col-option-persona" value="' + (data.paciente) + '"/>';
                                },
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center')
                                        $(nTd).css('vertical-align', 'middle')
                                        $(nTd).css('padding', '8px')
                                    }
                                }
                            },
                            {
                                /*IDENTIFICACIÓN*/
                                aTargets: [1],
                                width: "10%",
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center')
                                        $(nTd).css('vertical-align', 'middle')
                                        $(nTd).css('padding', '8px')
                                    }
                                }
                            },
                            {
                                /*NOMBRES COMPLETOS*/
                                aTargets: [2],
                                width: "55%",
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'left')
                                        $(nTd).css('vertical-align', 'middle')
                                        $(nTd).css('padding', '8px')
                                    }
                                }
                            },
                            {
                                /*SEXO*/
                                aTargets: [3],
                                width: "8%",
                                mRender: function (data, type, row)
                                {
                                    var sexo ='';

                                    if (data==1){
                                        sexo = '<i class="fa fa-female fa-2x"></i>';
                                    }
                                    else if (data==2) {
                                        sexo = '<i class="fa fa-male fa-2x"></i>'
                                    }
                                    else{
                                        sexo = 'Sin Registro';
                                    }
                                    return '<span>'+sexo+'</span>';
                                },

                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center')
                                        $(nTd).css('vertical-align', 'middle')
                                        $(nTd).css('padding', '8px')
                                    }
                                }
                            },
                            {
                                /*FECHA NACIMIENTO*/
                                aTargets: [4],
                                width: "12%",
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center')
                                        $(nTd).css('vertical-align', 'middle')
                                        $(nTd).css('padding', '8px')
                                    }
                                }
                            },
                        ]
                    ,
                    initComplete: function(settings, json) {

                        $("#dtViewListPacientes_filter input").unbind();
                        $("#dtViewListPacientes_filter input").bind('keyup', function (e) {
                            //console.log("eeee");
                            if (e.keyCode == 13) {
                                self.$table.dataTable().fnFilter(this.value);
                            }
                        });

                        if (fOpen){
                            fOpen();
                        }
                    },
                    fnServerParams: function (aoData)
                    {
                        bloqueointerface();
                        aoData.push({"name": 'action', "value": 'load_datatable_search_pacientes'})

                    },
                    fnDrawCallback: function (oSettingst)
                    {
                        var count = 0;
                        $.unblockUI();

                        //aTargets: [0]
                        $('.dt-col-option-list-test', self.$table).each(function () {
                            var id = $(this).val();
                            var persona = $('.dt-col-option-persona').eq(count).val();
                            //console.log(persona);
                            var html = ''+
                                '<div class="btn-group">'+
                                '<button class="btn btn-default btn-info tu dt-action-select_aplicar" href="javascript:;"><i class="fa fa-check"></i> Seleccionar</button>'+
                                '</div>';

                            var $html = $(html);

                            $(".dt-action-select_aplicar", $html).click(function (){
                                self.closePopup();
                                myModalListTestAplicar.open(id, persona);
                            });
                            $(this).after($html);
                            count++;
                        });

                    }

                });


            },
            closePopup: function () {

                var self = this
                self.$table.dataTable().fnDestroy();
                self.$popup.modal('hide');

            },

        }
        var myModalListTestAplicar = {
            init:function (){
                var self = this;

                self.$popup = $('#modalListTestAplicar');
                self.$table = $('#dataTableListTestAplicar table');

                $(".action-close", self.$popup).click(function (){
                    self.closePopup();
                });

                self.$popup.on("show.bs.modal", function () {
                });

                self.$popup.on("hidden.bs.modal", function () {
                });
            },
            closePopup: function () {
                var self = this
                bloqueointerface();
                var id_paciente = $('[name="id_paciente"]', self.$popup).val();
                $('[name="id_paciente"]', self.$popup).val(0);
                self.$table.dataTable().fnDestroy();
                location.href = '/box_psicologica?action=pacientes_test_psicologicos';
                self.$popup.modal('hide');
            },
            open: function (id_paciente, persona) {
                var self = this;
                bloqueointerface();
                var fOpen = function () {
                    var h = $(window).height() - 150;
                    $('[name="id_paciente"]', self.$popup).val(id_paciente);
                    $('.modal-title', self.$popup).html(persona);
                    self.$popup.modal({backdrop: 'static', width: '90%', height: h}).modal('show');
                    $.unblockUI();
                }
                self.loadDataTable(fOpen);

            },
            loadDataTable(fOpen){
                var self = this;
                self.$table.dataTable({
                    responsive: true,
                    searchDelay: 1000,
                    bJQueryUI: false,
                    bAutoWidth: false,
                    //bProcessing: true,
                    bServerSide: true,
                    bSort: false,
                    sPaginationType: "full_numbers",
                    iDisplayLength: 25,
                    sDom: '<"datatable-header"fl><"datatable-scroll"tr><"datatable-footer"ip>',
                    sAjaxSource: "box_psicologica",
                    sServerMethod: "POST",
                    //"dom": '<"toolbar">frtip',
                    //buttons: ['csv', 'excel', 'pdf', 'print'],
                    aoColumnDefs:
                        [
                            {
                                /*CODIGO*/
                                aTargets: [0],
                                width: "6%",
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center')
                                        $(nTd).css('vertical-align', 'middle')
                                        $(nTd).css('padding', '8px')
                                    }
                                }
                            },
                            {
                                /*NOMBRE*/
                                aTargets: [1],
                                width: "70%",
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'left')
                                        $(nTd).css('vertical-align', 'middle')
                                        $(nTd).css('padding', '8px')
                                    }
                                }
                            },
                            {
                                /*VERSION*/
                                aTargets: [2],
                                width: "8%",
                                /*mRender: function (data, type, row)
                                {
                                    return '<input type="hidden" class="dt-col-estado" value="' + (data) + '"/>';
                                },*/
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center')
                                        $(nTd).css('vertical-align', 'middle')
                                        $(nTd).css('padding', '8px')
                                    }
                                }
                            },
                            {
                                /*ACCIONES*/
                                aTargets: [3],
                                width: "16%",
                                mRender: function (data, type, row)
                                {
                                    return '<input type="hidden" class="dt-col-option-test-aplicar" value="' + (data.id) + '"/>';
                                },
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center')
                                        $(nTd).css('vertical-align', 'middle')
                                        $(nTd).css('padding', '8px')
                                    }
                                }
                            },
                        ]
                    ,
                    initComplete: function(settings, json) {
                        $("#dtViewListTests_filter input").unbind();
                        $("#dtViewListTests_filter input").bind('keyup', function (e) {
                            //console.log("eeee");
                            if (e.keyCode == 13) {
                                self.$table.dataTable().fnFilter(this.value);
                            }
                        });
                        if (fOpen)
                        {
                            fOpen();
                        }
                    },
                    fnServerParams: function (aoData)
                    {
                        bloqueointerface();
                        aoData.push({"name": 'action', "value": 'load_datatable_tests'})

                    },
                    fnDrawCallback: function (oSettingst)
                    {
                        var count = 0;
                        $.unblockUI();

                        //aTargets: [3]
                        $('.dt-col-option-test-aplicar', self.$table).each(function () {
                            var id = $(this).val();
                            //console.log(id);
                            var html = '';

                            var html = ''+
                                '<div class="btn-group">'+
                                '<button class="btn btn-primary btn-icon btn-xs tu dt-action-aplicar-test" href="javascript:;"><i class="fa fa-edit"></i> Aplicar</button>'+
                                '</div>';

                            var $html = $(html);

                            $(".dt-action-aplicar-test", $html).click(function (){
                                var dataFilter = {
                                    'id_test': id,
                                    'id_paciente': $('[name="id_paciente"]', self.$popup).val(),
                                    'action': 'aplicar_test_paciente' }
                                smoke.confirm("¿Está seguro de aplicar el test.?", function(e){
                                    if (e){
                                        bloqueointerface();
                                        $.ajax({
                                            type: "POST",
                                            url: "/box_psicologica",
                                            data:dataFilter,
                                            success: function(data) {
                                                if (data.result=='ok'){
                                                    //NotificationJG.success(data.mensaje, "Exitoso")
                                                    myModalAplicarTest.open(data)

                                                } else {
                                                    NotificationJG.error(data.mensaje, "Error")
                                                }
                                                $.unblockUI();
                                            },
                                            error: function() {
                                                NotificationJG.error("Existio un error en la conexión", "Error");
                                                $.unblockUI();
                                            },
                                            dataType: "json"
                                        });
                                    }
                                }, {
                                    ok: "SI,SEGURO",
                                    cancel: "NO,CANCELAR",
                                    classname: "custom-class",
                                    reverseButtons: true
                                });
                            });
                            $(this).after($html);
                            count++;
                        });

                    }

                });
            }
        }
        var myModalAplicarTest = {
            init:function (){
                var self = this;

                self.$popup = $('#modalTestAplicar');
                self.$arrData = [];
                $(".action-close", self.$popup).click(function (){
                    self.closePopup();
                });

                $(".action-save-test-aplica", self.$popup).click(function (){
                    self.save();
                });

                self.$popup.on("show.bs.modal", function () {
                });

                self.$popup.on("hidden.bs.modal", function () {
                });
            },
            closePopup: function () {
                var self = this
                self.$arrData = [];
                self.$popup.modal('hide');
            },
            open: function (data) {
                var self = this;
                bloqueointerface();
                var fOpen = function () {
                    var h = $(window).height() - 150;
                    $('.modal-body', self.$popup).html(data.contenido);
                    self.$arrData = data.aData;
                    self.$popup.modal({backdrop: 'static', width: '90%', height: h}).modal('show');
                    $.unblockUI();
                }
                if (fOpen){
                    fOpen();
                }
            },
            save: function (){
                var self = this;
                bloqueointerface();
                var isValid = true

                $.each(self.$arrData, function(i, item) {
                    var $element = $('[name="respuesta_'+item.id+'"]', self.$popup)
                    var $element_checked = $('[name="respuesta_'+item.id+'"]:checked', self.$popup)
                    var $tr = $('#tr_'+item.id+'', self.$popup);
                    //console.log($element);
                    if ($element.is(':checked')){
                        //console.log("esta chequeado respuesta 1");
                        //console.log(item.regla==$element_checked.val());
                        self.$arrData[i].respuesta_id = $element_checked.attr('value_idr');
                        self.$arrData[i].respuesta_valor = $element_checked.val();
                        if (item.validar_children==1 && item.regla == $element_checked.val()){
                            var $element_children = $('[name="children_respuesta_'+item.id+'"]', self.$popup)
                            var $element_children_checked = $('[name="children_respuesta_'+item.id+'"]:checked', self.$popup)
                            if ($element_children.is(':checked')){
                                $('td', $tr).css("background-color", "#ddffdd");
                                self.$arrData[i].respuesta_children_id = $element_children_checked.attr('value_idr');;
                                self.$arrData[i].respuesta_children_valor = $element_children_checked.val();
                            }
                            else {
                                isValid = false
                                $('td', $tr).css("background-color", "#f2dede");
                            }
                        }
                        else
                        {
                            $('td', $tr).css("background-color", "#ddffdd");
                        }
                    }else {
                        isValid = false
                        $('td', $tr).css("background-color", "#f2dede");
                    }
                });
                //console.log($('[name="id_paciente_aplica"]', self.$popup).val());
                if (isValid){
                    $.unblockUI();
                    var dataFilter = {
                        'id_paciente': $('[name="id_paciente_aplica"]', self.$popup).val(),
                        'id_test': $('[name="id_test"]', self.$popup).val(),
                        'respuestas': JSON.stringify(self.$arrData),
                        'action': 'save_test_aplicado_paciente' }
                    smoke.confirm("¿Está seguro de guardar el test.?", function(e){
                        if (e){
                            bloqueointerface();
                            $.ajax({
                                type: "POST",
                                url: "/box_psicologica",
                                data:dataFilter,
                                success: function(data) {
                                    if (data.result=='ok'){
                                        NotificationJG.success(data.mensaje, "Exitoso")
                                        self.closePopup();

                                    } else {
                                        NotificationJG.error(data.mensaje, "Error")
                                    }
                                    $.unblockUI();
                                },
                                error: function() {
                                    NotificationJG.error("Existio un error en la conexión", "Error");
                                    $.unblockUI();
                                },
                                dataType: "json"
                            });
                        }
                    }, {
                        ok: "SI,SEGURO",
                        cancel: "NO,CANCELAR",
                        classname: "custom-class",
                        reverseButtons: true
                    });
                }
                else {
                    NotificationJG.error("Debe responder todas la preguntas", "Error");
                    $.unblockUI();
                }
                //console.log(self.$arrData);
                return;
            },
        }
        var myModalDatosPaciente = {
            init:function (){
                var self = this;

                self.$popup = $('#modalDatosPaciente');
                $(".action-close", self.$popup).click(function (){
                    self.closePopup();
                });

                self.$popup.on("show.bs.modal", function () {
                });

                self.$popup.on("hidden.bs.modal", function () {
                });
            },
            closePopup: function () {
                var self = this
                self.$popup.modal('hide');
            },
            open: function (id) {
                var self = this;
                bloqueointerface();

                $.ajax({
                    type: "POST",
                    url: "/box_medical",
                    data: {'action':'datospaciente', 'id': id },
                    success: function(data) {
                        if (data.result=='ok'){
                            var h = $(window).height() - 150;
                            $('.modal-body', self.$popup).html(data.html);
                            self.$popup.modal({backdrop: 'static', width: '90%', height: h}).modal('show');
                            $.unblockUI();

                        } else {
                            NotificationJG.error(data.mensaje, "Error")
                        }
                        $.unblockUI();
                    },
                    error: function() {
                        NotificationJG.error("Existio un error en la conexión", "Error");
                        $.unblockUI();
                    },
                    dataType: "json"
                });
            },
        }
        var myModalTestsPaciente = {
            init:function (){
                var self = this;

                self.$popup = $('#modalTestPaciente');
                self.$table = $('#dataTableListTestPacientes table');

                $(".action-close", self.$popup).click(function (){
                    self.closePopup();
                });

                self.$popup.on("show.bs.modal", function () {
                });

                self.$popup.on("hidden.bs.modal", function () {
                });
            },
            closePopup: function () {
                var self = this;
                //self.$table.dataTable().fnClearTable();
                self.$table.dataTable().fnDestroy();
                self.$popup.modal('hide');
            },
            open: function (id, paciente) {

                var self = this;
                $('[name="idp"]', self.$popup).val(id);
                bloqueointerface();
                var fOpen = function (){
                    var h = $(window).height() - 150;
                    $('.modal-header span', self.$popup).html(paciente);
                    //$('input[type="checkbox"]', self.$popup).change();
                    self.$popup.modal({backdrop: 'static', width: '90%', height: h}).modal('show');
                    $('[name="filter_date_begin"], [name="filter_date_end"]', self.$popup).datepicker({format:"dd-mm-yyyy"}).on('changeDate', function(ev){
                        $(this).datepicker('hide');
                        self.$table.dataTable().fnDraw();
                    });

                    /*$('[name="not_filter_date"]', self.$popup).change(function(el){
                        self.$table.dataTable().fnDraw();
                    });*/
                }
                self.loadDataTable(fOpen);

            },
            loadDataTable(fOpen){
                var self = this;
                self.$table.dataTable({
                    responsive: true,
                    searchDelay: 1000,
                    bJQueryUI: false,
                    bAutoWidth: false,
                    //bProcessing: true,
                    bServerSide: true,
                    bSort: false,
                    sPaginationType: "full_numbers",
                    iDisplayLength: 25,
                    sDom: '<"datatable-header"fl><"datatable-scroll"tr><"datatable-footer"ip>',
                    sAjaxSource: "box_psicologica",
                    sServerMethod: "POST",
                    //"dom": '<"toolbar">frtip',
                    //buttons: ['csv', 'excel', 'pdf', 'print'],
                    aoColumnDefs:
                        [
                            {
                                /*TEST*/
                                aTargets: [0],
                                width: "45%",
                                mRender: function (data, type, row)
                                {
                                    var html = '<div><b>Test:</b>'+data.nombre+' <span class="label label-warning"> V'+data.version+'</span></div>'+
                                        '<div><b>Fecha:</b>'+data.fecha+'</div>'+
                                        '<div><b>Psicólogo:</b>'+data.medico+'</div>';
                                    return html;
                                },
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'left')
                                        $(nTd).css('vertical-align', 'middle')
                                        $(nTd).css('padding', '8px')
                                    }
                                }
                            },
                            {
                                /*DIAGNOSTICO*/
                                aTargets: [1],
                                width: "45%",
                                mRender: function (data, type, row)
                                {
                                    //console.log(data);
                                    return `<div><span class="label label-default">Diagnóstico técnico:</span> ${data.diagnostico}</div><div><span class="label label-default">Diagnóstico:</span> ${data.diagnosticoverbose}</div>`;
                                },
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'left')
                                        $(nTd).css('vertical-align', 'middle')
                                        $(nTd).css('padding', '8px')
                                    }
                                }
                            },
                            {
                                aTargets: [2],
                                width: "10%",
                                mRender: function (data, type, row)
                                {
                                    return '<input type="hidden" class="dt-col-option-test-persona" value="' + (data) + '"/>';
                                },
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center')
                                        $(nTd).css('vertical-align', 'middle')
                                        $(nTd).css('padding', '8px')
                                    }
                                }
                            },
                        ]
                    ,
                    initComplete: function(settings, json) {
                        $("#dtViewListTestPacientes_filter input").unbind();
                        $("#dtViewListTestPacientes_filter input").bind('keyup', function (e) {
                            //console.log("eeee");
                            if (e.keyCode == 13) {
                                self.$table.dataTable().fnFilter(this.value);
                            }
                        });
                        if (fOpen)
                        {
                            fOpen();
                        }
                    },
                    fnServerParams: function (aoData)
                    {
                        bloqueointerface();
                        /*var not_filter_date = 1;
                        if ($('[name="not_filter_date"]', self.$popup).is(':checked')){
                            not_filter_date = 0;
                        }*/
                        var filter_date_begin = $('[name="filter_date_begin"]', self.$popup).val();
                        var filter_date_end = $('[name="filter_date_end"]', self.$popup).val();
                        aoData.push({"name": 'action', "value": 'load_datatable_tests_paciente'})
                        aoData.push({"name": 'idp', "value":  $('[name="idp"]', self.$popup).val()})
                        //aoData.push({"name": 'not_filter_date', "value":  not_filter_date})
                        aoData.push({"name": 'filter_date_begin', "value": filter_date_begin })
                        aoData.push({"name": 'filter_date_end', "value": filter_date_end })

                    },
                    fnDrawCallback: function (oSettingst)
                    {
                        var count = 0;
                        $.unblockUI();
                        var html = '';
                        //aTargets: [3]
                        $('.dt-col-option-test-persona', self.$table).each(function () {
                            var id = $(this).val();
                            //console.log(id);
                            var html = ''+
                                '<div class="btn-group">'+
                                '<button class="btn btn-primary btn-icon btn-xs tu dt-action-test-diagnostico" href="javascript:;"><i class="fa fa-search-plus"></i> Diagnostico</button>'+
                                '</div>';
                            var $html = $(html);

                            /*$(".dt-action-test-diagnostico", $html).click(function (){

                            });*/

                            count++;
                            $(this).after($html);
                        });

                    }

                });
            }
        }
        $(function() {
            myController.init();
            myModalAddPaciente.init();
            myModalSearchPaciente.init();
            myModalListTestAplicar.init();
            myModalAplicarTest.init();
            myModalDatosPaciente.init();
            myModalTestsPaciente.init();
        });
    </script>
{% endblock %}
{% block atras %}/box_psicologica{% endblock %}
{% block canvas %}
    <div class='row-fluid'>
        <div class='span8'>
            <h4>{{ title }}</h4>
            <br>
            <br>
            <br>
            <br>
            <br>
            <div class="row-fluid">
                <div class='span6'>
                    <div class="btn-group">
                        <a href="javascript:;" class='btn btn-success tu addTestPaciente' title="Aplicar Test"><span class="fa fa-plus " ></span> Aplicar Test</a>
                    </div>

                    <div class="btn-group">
                        <a class="btn btn-default dropdown-toggle" data-toggle="dropdown" href="javascript:;"> Acciones <span class="caret"></span></a>
                        <ul class="dropdown-menu pull-left">
                            <li class="dropdown-submenu">
                                <a href="javascript:;"><i class="fa fa-file-pdf-o"></i> Reportes</a>
                                <ul class="dropdown-menu pull-right" style="width: 450px">
                                    {% if persona.usuario.is_superuser or persona.grupo_psicologia and not esdirectordbu %}
                                        <li><a href="javascript:;" class="reporte_pdf" tipo="DET" ><i class="fa fa-table"></i> Listado detallado de test psicológicos realizadas</a></li>
                                    {% endif %}
                                </ul>
                            </li>

                        </ul>
                    </div>

                </div>

                <div class='span6' style="text-align: right">
                    <form class="form-search" onsubmit="return busqueda()">
                        <input class='searchinput' type='text' id='searchinput' value='{{ search }}' autocomplete="off"/>
                        <a href="javascript:;" id='search' class='btn btn-info'><i class="fa fa-search "></i> Buscar</a>
                        {% if search or ids %}
                            <a href="/box_psicologica?action=pacientes_test_psicologicos" id='allresults' class='btn btn-info'><i class="fa fa-refresh "></i> Todos</a>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
        <div class="span4">
            <table class='table table-hover personal-task'>
                <tbody style="font-weight: bold">
                <tr>
                    <td><i class="fa fa-line-chart"></i> Total general de test psicológicos </td>
                    <td style="text-align: center;">{{ totalgeneral }}</td>
                </tr>
                <tr>
                    <td><i class="fa fa-book"></i> Total general atenciones psicológicas de {{ medico }}</td>
                    <td style="text-align: center;">{{ totalgeneralusuario }}</td>
                </tr>
                <tr>
                    <td> <i class="fa fa-list-ul"></i> Total de test psicológicos hoy</td>
                    <td style="text-align: center;">{{ totalhoy }}</td>
                </tr>
                <tr>
                    <td> <i class="fa fa-hand-o-up"></i> Total de test psicológicos de {{ medico }} hoy</td>
                    <td style="text-align: center;">{{ totalusuariohoy }}</td>
                </tr>

                </tbody>
            </table>
        </div>

    </div>

    <div class='row-fluid'>
        <div class='span12'>
            <table class='table table-striped table-bordered'>
                <thead>
                <tr>
                    <th style="width: 6%; text-align: center";>#</th>
                    <th style="width: 8%; text-align: center;">Identificaci&oacute;n</th>
                    <th style="width: 40%; text-align: center;">Nombre</th>
                    <th style="width: 16%; text-align: center;">Email/Tel&eacute;fonos</th>
                    <th style="width: 10%; text-align: center;">Fecha Nacimiento</th>
                    <th style="width: 20%; text-align: center"></th>
                </tr>
                </thead>
                <tbody>
                {% for paciente in pacientes %}
                    <tr>
                        <td style="text-align: center; vertical-align: middle">{{ forloop.counter }}</td>
                        <td style="text-align: center; vertical-align: middle">{% if paciente.cedula %}{{ paciente.cedula }}{% else %}{{ paciente.pasaporte }}{% endif %}</td>
                        <td style="text-align: left; vertical-align: middle">
                            {{ paciente }}<br>
                            {% if paciente.datos_medicos_incompletos %}
                                <span title="Datos Medicos Incompletos" class="label label-important tu">DMI</span>
                            {% endif %}
                            {% if paciente.valoracion_medica_incompleta %}
                                <span title="Valoracion Medica Incompleta" class="label label-warning tu">VMI</span>
                            {% endif %}
                        </td>
                        <td style="text-align: left; vertical-align: middle">
                            {%  for email in paciente.lista_emails %}
                                <a href="mailto:{{ email }}">{{ email }}</a><br/>
                            {% endfor %}
                            {%  for telefono in paciente.lista_telefonos %}
                                {{ telefono }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </td>
                        <td style="text-align: center; vertical-align: middle">{{ paciente.nacimiento|date:"d-m-Y" }}</td>
                        <td style="text-align: center; vertical-align: middle">
                            <div class="btn-group">
                                <a class="view_data_paciente btn btn-info" href="javascript:;" idp="{{paciente.id}}" ><i class="fa fa-vcard"></i> Mostrar Datos</a>
                            </div>
                            <div class="btn-group">
                                <a class="view_data_test btn btn-default" href="javascript:;" idp="{{paciente.id}}" paciente="{{ paciente }}" ><i class="fa fa-list-ul"></i> Mis Test</a>
                            </div>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="6" style="text-align: center">No registra pacientes con test psicológicos</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class='row-fluid'>
        {% if paging.num_pages > 20 %}
            <div class='pagination'>
                <ul>
                    {% if paging.primera_pagina %}
                        <li><a href="/box_psicologica?action=pacientes_test_psicologicos&page=1">1</a></li>
                        <li><a href="/box_psicologica?action=pacientes_test_psicologicos&page={{ paging.ellipsis_izquierda }}" class="active">...</a></li>
                    {% endif %}
                    {% for pagenumber in paging.paginas %}
                        <li {%  if pagenumber == page.number %}class='active'{% endif %}><a href="/box_psicologica?action=pacientes_test_psicologicos&page={{ pagenumber }}">{{ pagenumber }}</a></li>
                    {% endfor %}
                    {% if paging.ultima_pagina %}
                        <li><a href="/box_psicologica?action=pacientes_test_psicologicos&page={{ paging.ellipsis_derecha }}" class="active">...</a></li>
                        <li><a href="/box_psicologica?action=pacientes_test_psicologicos&page={{ paging.num_pages }}">{{ paging.num_pages }}</a></li>
                    {% endif %}
                </ul>
            </div>
        {% else %}
            <div class='pagination'>
                <ul>
                    {% for pagenumber in paging.page_range %}
                        <li {%  if pagenumber == page.number %}class='active'{% endif %}><a href="/box_psicologica?action=pacientes_test_psicologicos&page={{ pagenumber }}">{{ pagenumber }}</a></li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
    </div>

    <div id="modalSearchPaciente" data-width="" class="modal fade" aria-labelledby="" aria-hidden="true" tabindex="-1" role="dialog" style="display: block;"  data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title"><i class="fa fa-search"></i> Buscar Paciente</h4>
                </div>

                <div class="modal-body">
                    <div class="row-fluid">
                        <div class="span12">
                            <a href="javascript:;" class="btn btn-success action-add-paciente"> Agregar Nuevo Paciente</a>
                        </div>
                    </div>
                    <div class="row-fluid">
                        <div class="span12">
                            <div class="datatable" id="dataTableListPacientes">
                                <table id="dtViewListPacientes" class='table table-bordered table-striped'>
                                    <thead>
                                    <tr>
                                        <th style="text-align: center; width: 15%; vertical-align: middle"></th>
                                        <th style="text-align: center; width: 10%; vertical-align: middle">Identificación</th>
                                        <th style="text-align: center; width: 55%; vertical-align: middle">Nombres Completos</th>
                                        <th style="text-align: center; width: 8%; vertical-align: middle">Sexo</th>
                                        <th style="text-align: center; width: 12%; vertical-align: middle">Fecha de Nacimiento</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <a href="javascript:;" class="btn btn-info action-close" data-dismiss="modal"> Cerrar</a>
                </div>

            </div>
        </div>
    </div>

    <div id="modalAddPaciente" data-width="" class="modal fade" aria-labelledby="" aria-hidden="true" tabindex="-1" role="dialog" style="display: block;"  data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title"><i class="fa fa-plus"></i> Agregar Paciente</h4>
                </div>
                <!-- Form inside modal -->
                <form action="javascript:;" role="form">
                    <div class="modal-body with-padding">
                        <div class="row-fluid">
                            <div class="span6">
                                <div class="form-group has-feedback">
                                    <label for="tipo_identificacion">Tipo de identificación: </label>
                                    <select name="tipo_identificacion">
                                        <option value="1">Cédula</option>
                                        <option value="2">Pasaporte</option>
                                    </select>
                                    <span class="label label-block label-important text-left">Centered label</span>
                                </div>
                            </div>
                            <div class="span6">
                                <div class="form-group has-feedback">
                                    <label for="identificacion">Número de Identificación: </label>
                                    <input type="text" class="form-control" name="identificacion">
                                    <span class="label label-block label-important text-left">Centered label</span>
                                </div>
                            </div>

                        </div>
                        <div class="row-fluid">
                            <div class="span4">
                                <div class="form-group has-feedback">
                                    <label for="apellido_paterno">Apellido Paterno: </label>
                                    <input type="text" class="form-control" name="apellido_paterno">
                                    <span class="label label-block label-important text-left">Centered label</span>
                                </div>
                            </div>
                            <div class="span4">
                                <div class="form-group has-feedback">
                                    <label for="apellido_materno">Apellido Materno: </label>
                                    <input type="text" class="form-control" name="apellido_materno">
                                    <span class="label label-block label-important text-left">Centered label</span>
                                </div>
                            </div>
                            <div class="span4">
                                <div class="form-group has-feedback">
                                    <label for="nombres">Nombres: </label>
                                    <input type="text" class="form-control" name="nombres">
                                    <span class="label label-block label-important text-left">Centered label</span>
                                </div>
                            </div>

                        </div>
                        <div class="row-fluid">
                            <div class="span4">
                                <div class="form-group has-feedback">
                                    <label for="sexo">Sexo: </label>
                                    <select name="sexo">
                                        {% for sexo in sexos %}
                                            <option value="{{ sexo.id }}">{{ sexo.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                    <span class="label label-block label-important text-left">Centered label</span>
                                </div>
                            </div>
                            <div class="span4">
                                <div class="form-group has-feedback">
                                    <label for="nacimiento">Nacimiento: </label>
                                    <input type="text" class="form-control" name="nacimiento">
                                    <span class="label label-block label-important text-left">Centered label</span>
                                </div>
                            </div>
                            <div class="span4"></div>
                        </div>
                        <!--<div class="row-fluid">
                            <div class="span6">

                            </div>
                            <div class="span6">

                            </div>
                        </div>-->

                    </div>
                    <div class="modal-footer">
                        <a href="javascript:;" class="btn btn-success action-save-paciente"> Guardar</a>
                        <a href="javascript:;" class="btn btn-info action-close" data-dismiss="modal"> Cerrar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="modalListTestAplicar" data-width="" class="modal fade" aria-labelledby="" aria-hidden="true" tabindex="-1" role="dialog" style="display: block;"  data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title"></h4>
                </div>
                <div class="modal-body with-padding">
                    <input type="hidden" name="id_paciente" value="0">
                    <div class="row-fluid">
                        <div class="span12">
                            <div class="datatable" id="dataTableListTestAplicar">
                                <table id="dtViewListTestAplicar" class='table table-bordered table-striped'>
                                    <thead>
                                    <tr>
                                        <th style="text-align: center; width: 6%; vertical-align: middle">Código</th>
                                        <th style="text-align: center; width: 70%; vertical-align: middle">Nombre</th>
                                        <th style="text-align: center; width: 8%; vertical-align: middle">Versión</th>
                                        <th style="text-align: center; width: 16%; vertical-align: middle"></th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="javascript:;" class="btn btn-info action-close" data-dismiss="modal"> Cerrar</a>
                </div>

            </div>
        </div>
    </div>

    <div id="modalTestAplicar" data-width="" class="modal fade" aria-labelledby="" aria-hidden="true" tabindex="-1" role="dialog" style="display: block;"  data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Test Psicológico</h4>
                </div>
                <div class="modal-body with-padding">
                </div>
                <div class="modal-footer">
                    <a href="javascript:;" class="btn btn-success action-save-test-aplica"> Enviar</a>
                    <a href="javascript:;" class="btn btn-info action-close" data-dismiss="modal"> Cerrar</a>
                </div>
            </div>
        </div>
    </div>

    <div id="modalDatosPaciente" data-width="" class="modal fade" aria-labelledby="" aria-hidden="true" tabindex="-1" role="dialog" style="display: block;"  data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="paneltitle">
                        Datos del Paciente
                    </h3>
                </div>
                <div class="modal-body with-padding">
                </div>
                <div class="modal-footer">
                    <a href="javascript:;" class="btn btn-info action-close" data-dismiss="modal"> Cerrar</a>
                </div>
            </div>
        </div>
    </div>

    <div id="modalTestPaciente" data-width="" class="modal fade" aria-labelledby="" aria-hidden="true" tabindex="-1" role="dialog" style="display: block;"  data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="paneltitle">
                        Tests del Paciente <span></span>
                    </h3>
                </div>
                <div class="modal-body with-padding">
                    <input type="hidden" value="0" name="idp">
                    <div class="row-fluid">
                        <div class="span3">
                        </div>
                        <div class="span3">
                            <!--<div class="checkbox">
                                <span>Sin Fechas: </span>
                                <input type="checkbox" class="" name="not_filter_date" id="not_filter_date">
                                <label for="not_filter_date"><i class="fa fa-circle"></i></label>
                            </div>-->
                        </div>
                        <div class="span3" style="text-align: right">
                            <span>Fecha Inicio:</span>
                            <input class="selectorfecha" id="filter_date_begin" name="filter_date_begin" type="text" value="{{ filter_date_begin | date:'d-m-Y' }}">
                        </div>
                        <div class="span3" style="text-align: right">
                            <span>Fecha Fin:</span>
                            <input class="selectorfecha" id="filter_date_end" name="filter_date_end" type="text" value="{{ filter_date_end | date:'d-m-Y' }}">
                        </div>
                    </div>
                    <div class="row-fluid">
                        <div class="span12">
                            <div class="datatable" id="dataTableListTestPacientes">
                                <table id="dtViewListTestPacientes" class='table table-bordered table-striped'>
                                    <thead>
                                    <tr>
                                        <th style="text-align: center; width: 45%; vertical-align: middle">Test/Fecha/Psicólogo</th>
                                        <th style="text-align: center; width: 45%; vertical-align: middle">Diagnóstico</th>
                                        <th style="text-align: center; width: 10%; vertical-align: middle"></th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="javascript:;" class="btn btn-info action-close" data-dismiss="modal"> Cerrar</a>
                </div>
            </div>
        </div>
    </div>

{% endblock %}