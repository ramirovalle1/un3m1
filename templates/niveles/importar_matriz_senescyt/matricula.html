{% extends "ajaxformbs.html" %}
{% load sga_extras %}
{% block form-type %}form-vertical{% endblock %}
{% block extraheading %}
    {#    <link rel="stylesheet" href="../bootstrap-combined.min.css">#}
    {#    <link type='text/css' rel='stylesheet' href="/static/css/bootstrap-combined.min.css?v=1.0.0"/>#}
    {#	<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>#}
    {#	<script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>#}
    <script type='text/javascript' src="/static/js/jquery.blockUI.js?1.0.0"></script>
    <script type="text/javascript">
        $.extend(true, $.fn.dataTable.defaults, {
            oLanguage: {
                sSearch: "<span>Filtro:</span> _INPUT_",
                sLengthMenu: "<span>Mostrar Entradas:</span> _MENU_",
                sZeroRecords: "No se encontraron resultados",
                sProcessing: "Procesando...",
                sEmptyTable: "Ningún dato disponible para visualizar",
                sInfo: "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                sInfoEmpty: "Mostrando registros del 0 al 0 de un total de 0 registros",
                sLoadingRecords: "Cargando...",
                oPaginate: {
                    sFirst: "<i title='Inicio' class='fa fa-step-backward'></i>",
                    sLast: "<i title='Último' class='fa fa-step-forward'></i>",
                    sNext: "<i title='Siguiente' class='fa fa-fast-forward'></i>",
                    sPrevious: "<i title='Anterior' class='fa fa-fast-backward'></i>"
                },
            }
        });
        $(function () {
            $('.tree li:has(ul)').addClass('parent_li').find(' > span').attr('title', 'Contraer');
            $('.tree li.parent_li > span').on('click', function (e) {
                var children = $(this).parent('li.parent_li').find(' > ul > li');
                if (children.is(":visible")) {
                    children.hide('fast');
                    $(this).find(' > i').removeClass('fa fa-folder-open');
                    $(this).attr('title', 'Ampliar').find(' > i').addClass('fa fa-folder');
                } else {
                    children.show('fast');
                    $(this).find(' > i').removeClass('fa fa-folder');
                    $(this).attr('title', 'Contraer').find(' > i').addClass('fa fa-folder-open');
                }
                {#e.stopPropagation();#}
            });

            $('.actionMSG').click(function () {
                var id = $(this).attr('_value_id');
                var data = $(this).attr('_value_data');
                var level = $(this).attr('_value_level');
                smoke.alert(data);
            });

            $('.actionCupo').click(function () {
                var id = $(this).attr('_value_id');
                var data = $(this).attr('_value_data');
                var level = $(this).attr('_value_level');
                smoke.alert(data);
            });

            $('.actionRefresh').click(function () {
                smoke.signal("Se procedera actualizar la información...", function (ek) {
                    document.location.reload();
                }, {duration: 4000});
            });

            $('.actionCancelCelery').click(function () {
                var id = $(this).attr('_value_id');
                var data = $(this).attr('_value_data');
                var filter = $(this).attr('_value_filter');
                var level = $(this).attr('_value_level');
                smoke.confirm("¿Está seguro de cancelar el proceso de matriculación?", function (e) {
                    if (e) {
                        bloqueointerface();
                        $.ajax({
                            type: "POST",
                            url: "/niveles",
                            data: {'action': 'processCancelarMatriculaMatrizSENESCYT', 'id': id},
                            success: function (data) {
                                if (data.result == "ok") {
                                    $.unblockUI();
                                    smoke.signal(data.mensaje, function (ek) {location.reload();}, { duration: 4000 } );
                                } else {
                                    $.unblockUI();
                                    NotificationJG.error(data.mensaje);
                                }
                            },
                            error: function () {
                                $.unblockUI();
                                NotificationJG.error("Error al obtener los datos.");
                            },
                        });
                    }
                }, {
                    ok: "SI,SEGURO",
                    cancel: "NO,CANCELAR",
                    classname: "custom-class",
                    reverseButtons: true
                });
            });

            $('.actionActiveProfileUser').click(function(){
                var id = $(this).attr('_value_id');
                var data = $(this).attr('_value_data');
                var filter = $(this).attr('_value_filter');
                var level = $(this).attr('_value_level');
                var status = $(this).attr('_value_status');
                var msg = '';
                //console.log(puede_matricular);
                bloqueointerface();
                if (level == 'masiva'){
                    msg = "¿Está seguro de activar perfiles de usuarios masivamente?";
                }
                else if(level == 'carrera'){
                    msg = "¿Está seguro de activar perfiles de usuarios en la carrera "+data+"?";
                }
                else {
                    NotificationJG.error("No se encontro la acción a ejecutar", "Error!");
                    $.unblockUI();
                    return;
                }

                $.unblockUI();
                smoke.confirm(msg, function (e) {
                    if (e) {
                        bloqueointerface();
                        $.ajax({
                            type: "POST",
                            url: "/niveles",
                            data: {'action': 'processActiveProfilesUserAdmision', 'id': id, 'level': level, 'level_filter': filter},
                            success: function (data) {
                                $.unblockUI();
                                if (data.result == "ok") {
                                    smoke.signal(data.mensaje, function (ek) {location.reload();}, { duration: 4000 } );
                                } else {
                                    $.unblockUI();
                                    NotificationJG.error(data.mensaje);
                                }
                            },
                            error: function () {
                                $.unblockUI();
                                NotificationJG.error("Error al obtener los datos.");
                            },
                        });
                    }
                }, {
                    ok: "SI,SEGURO",
                    cancel: "NO,CANCELAR",
                    classname: "custom-class",
                    reverseButtons: true
                });
            });

            $("#periodo_admision").change(function (){
                var idaux = $(this).val();
                var idm = parseInt({{ matriz.id }});
                location.href = "/niveles?action=procesomatricularadmisionmatriz&id="+idm+"&idaux="+idaux
            });

            $('.actionDeleteEnroll').click(function (){
                //document.location.reload();
                var id = $(this).attr('_value_id');
                var data = $(this).attr('_value_data');
                var filter = $(this).attr('_value_filter');
                var level = $(this).attr('_value_level');
                var status = $(this).attr('_value_status');
                var msg = '';
                //console.log(puede_matricular);
                //bloqueointerface();

                msg = "¿Está seguro de eliminar la matricula en la carrera "+data+"?";

                $.unblockUI();
                smoke.confirm(msg, function (e) {
                    if (e) {
                        bloqueointerface();
                        $.ajax({
                            type: "POST",
                            url: "/niveles",
                            data: {'action': 'processDeleteMatriculaAdmision', 'id': id, 'level': level, 'level_filter': filter},
                            success: function (data) {
                                $.unblockUI();
                                if (data.result == "ok") {
                                    smoke.signal(data.mensaje, function (ek) {location.reload();}, { duration: 4000 } );
                                } else {
                                    $.unblockUI();
                                    NotificationJG.error(data.mensaje);
                                }
                            },
                            error: function () {
                                $.unblockUI();
                                NotificationJG.error("Error al obtener los datos.");
                            },
                        });
                    }
                }, {
                    ok: "SI,SEGURO",
                    cancel: "NO,CANCELAR",
                    classname: "custom-class",
                    reverseButtons: true
                });
            });

            $('.actionRegister').click(function () {
                //document.location.reload();
                var id = $(this).attr('_value_id');
                var data = $(this).attr('_value_data');
                var filter = $(this).attr('_value_filter');
                var level = $(this).attr('_value_level');
                var status = $(this).attr('_value_status');
                var msg = '';
                //console.log(puede_matricular);
                bloqueointerface();

                if (level == 'masiva'){
                    msg = "¿Está seguro de matricular masivamente?";
                }
                else if(level == 'carrera'){
                    msg = "¿Está seguro de matricular en la carrera "+data+"?";
                }
                else {
                    NotificationJG.error("No se encontro la acción a ejecutar", "Error!");
                    $.unblockUI();
                    return;
                }
                /*console.log(status)
                if ((status != 'SUCCESS' && status != 'FAILURE') || puede_matricular == false){
                    //NotificationJG.info("El proceso de matriculación se esta ejecutando...", "Notificación!");
                    smoke.alert("El proceso de matriculación se esta ejecutando...");
                    $.unblockUI();
                    return;
                }*/
                $.unblockUI();
                smoke.confirm(msg, function (e) {
                    if (e) {
                        bloqueointerface();
                        $.ajax({
                            type: "POST",
                            url: "/niveles",
                            data: {'action': 'processMatriculaMatrizSENESCYT', 'id': id, 'level': level, 'level_filter': filter},
                            success: function (data) {
                                $.unblockUI();
                                if (data.result == "ok") {
                                    smoke.signal(data.mensaje, function (ek) {location.reload();}, { duration: 4000 } );
                                } else {
                                    $.unblockUI();
                                    NotificationJG.error(data.mensaje);
                                }
                            },
                            error: function () {
                                $.unblockUI();
                                NotificationJG.error("Error al obtener los datos.");
                            },
                        });
                    }
                }, {
                    ok: "SI,SEGURO",
                    cancel: "NO,CANCELAR",
                    classname: "custom-class",
                    reverseButtons: true
                });
            });

            var $modalActionEnrollRepeat = $('#modalActionEnrollRepeat');

            $modalActionEnrollRepeat.find('.modal-body').css({
                'height': function (){
                    height_window = $( window ).height();
                    altura_body = $(this).outerHeight();
                    return height_window-altura_body-150;
                }
            });


            $modalActionEnrollRepeat.on("show.bs.modal", function () {
            });

            $modalActionEnrollRepeat.on("hidden.bs.modal", function () {
            });

            $(".actionViewEnroll_2m").click(function (){
                var idp = $("#periodo_admision").val();
                var idm = $(this).attr('_value_id');
                var data = $(this).attr('_value_data');
                var filter = $(this).attr('_value_filter');
                var level = $(this).attr('_value_level');
                var status = $(this).attr('_value_status');
                bloqueointerface();
                var fnOpenModal= function (){
                    var h = $(window).height()-200
                    $('#modalActionEnrollRepeat')
                        .off('shown.bs.modal')
                        .on('shown.bs.modal', function (event) {
                            //$(this).find('.modal-body').css({'overflow-y': 'scroll'});
                        })

                        .modal({backdrop: "static", width: "50%", height: h})
                        .modal('show');
                    $.unblockUI()
                }
                $.ajax({
                    type: "POST",
                    url: "/niveles",
                    data: {'action': 'loadAsignaturasByCareers', 'idm': idm, 'idp': idp, 'level': level, 'level_filter': filter},
                    success: function (data) {
                        if (data.result == "ok") {
                            $.unblockUI();
                            $(".modal-body", $modalActionEnrollRepeat).html(data.html);
                            //smoke.signal(data.mensaje, function (ek) {location.reload();}, { duration: 4000 } );
                            if (fnOpenModal)
                            {
                                fnOpenModal();
                            }

                        } else {
                            $.unblockUI();
                            NotificationJG.error(data.mensaje);
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        NotificationJG.error("Error al obtener los datos.");
                    },
                });

            });

            $(".action-enroll", $modalActionEnrollRepeat).click(function (){
                var dataAnterior = []
                $(".select_segunda_matricula_anterior", $modalActionEnrollRepeat).each(function( index ) {
                    console.log( index + ": " + $(this).val() );
                    dataAnterior.push($(this).val())
                });
                var dataActual = []
                $(".select_segunda_matricula_actual", $modalActionEnrollRepeat).each(function( index ) {
                    console.log( index + ": " + $(this).val() );
                    dataActual.push($(this).val())
                });
                var aData = []
                for(var i=0;i<dataAnterior.length;i++){
                    aData.push({"asignatura_anterior": dataAnterior[i], "asignatura_actual": dataActual[i]})
                }
                /*dataAnterior.each(function (index){
                    data.append({"asignatura_anterior": dataAnterior[index], "asignatura_actual": dataActual[index]})
                });*/
                bloqueointerface();
                console.log(aData);
                aData = JSON.stringify(aData);
                var matriz = $("[name='matriz']", $modalActionEnrollRepeat).val()
                var carrera = $("[name='carrera']", $modalActionEnrollRepeat).val()
                var idpa = $("[name='idpa']", $modalActionEnrollRepeat).val()
                var nivel = $("[name='nivel']", $modalActionEnrollRepeat).val()
                console.log(matriz)
                $.ajax({
                    type: "POST",
                    url: "/niveles",
                    data: {'action': 'process2MatriculaAdmision', 'aData': aData, 'id': matriz, 'idc':carrera, 'idpa': idpa, 'idn': nivel},
                    success: function (data) {
                        if (data.result == "ok") {
                            $.unblockUI();
                            $modalActionEnrollRepeat.modal("hide");
                            NotificationJG.success(data.mensaje);
                        } else {
                            $.unblockUI();
                            NotificationJG.error(data.mensaje);
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        NotificationJG.error("Error al obtener los datos.");
                    },
                });
            });

            $(".actionEnroll_2m").click(function (){
                var id = $(this).attr('_value_id');
                var data = $(this).attr('_value_data');
                var filter = $(this).attr('_value_filter');
                var level = $(this).attr('_value_level');
                var status = $(this).attr('_value_status');
                var msg = '';
                //console.log(puede_matricular);
                bloqueointerface();

                if (level == 'masiva'){
                    msg = "¿Está seguro de matricular masivamente?";
                }
                else if(level == 'carrera'){
                    msg = "¿Está seguro de matricular en la carrera "+data+"?";
                }
                else {
                    NotificationJG.error("No se encontro la acción a ejecutar", "Error!");
                    $.unblockUI();
                    return;
                }

                $.unblockUI();
                smoke.confirm(msg, function (e) {
                    if (e) {
                        bloqueointerface();
                        $.ajax({
                            type: "POST",
                            url: "/niveles",
                            data: {'action': 'processMatriculaMatrizSENESCYT', 'id': id, 'level': level, 'level_filter': filter},
                            success: function (data) {
                                $.unblockUI();
                                if (data.result == "ok") {
                                    smoke.signal(data.mensaje, function (ek) {location.reload();}, { duration: 4000 } );
                                } else {
                                    $.unblockUI();
                                    NotificationJG.error(data.mensaje);
                                }
                            },
                            error: function () {
                                $.unblockUI();
                                NotificationJG.error("Error al obtener los datos.");
                            },
                        });
                    }
                }, {
                    ok: "SI,SEGURO",
                    cancel: "NO,CANCELAR",
                    classname: "custom-class",
                    reverseButtons: true
                });
            });

            var $modalViewAlumnos = $('#modalViewAlumnos');

            $modalViewAlumnos.find('.modal-body').css({
                'height': function (){
                    height_window = $( window ).height();
                    altura_body = $(this).outerHeight();
                    return height_window-altura_body-100;
                }
            });


            $modalViewAlumnos.on("show.bs.modal", function () {
            });

            $modalViewAlumnos.on("hidden.bs.modal", function () {
            });

            $(".action-close", $modalViewAlumnos).click(function () {

                //$('#divDetailData table').dataTable().fnClearTable();
                $('#divDetailData table').dataTable().fnDestroy();
                $modalViewAlumnos.modal('hide');
            });

            $('.actionLoadAlumnos').click(function () {
                var id = $(this).attr('_value_id');
                var data = $(this).attr('_value_data');
                var filter = $(this).attr('_value_filter');
                var level = $(this).attr('_value_level');
                bloqueointerface();
                var fnOpenModal= function (){
                    $('#modalViewAlumnos')
                        .off('shown.bs.modal')
                        .on('shown.bs.modal', function (event) {
                            $(this).find('.modal-body').css({'overflow-y': 'scroll'});
                        })
                        .modal({backdrop: "static", width: $(window).width()-100, height: $(window).height()-150})
                        .modal('show');
                    $.unblockUI()
                }
                loadDataTableAlumnos(id, filter, level, fnOpenModal);


            });

            {% if distributivo.iMensaje.error %}
                NotificationJG.error("Existe observaciones por superar para continuar la matriculación", "Error!");
            {% endif %}
            {% if distributivo.iMensaje.warning %}
                NotificationJG.warning("Existe observaciones por considerar para continuar la matriculación", "Información!");
            {% endif %}
            {% if distributivo.iMensaje.success %}
                NotificationJG.success("No existe observaciones por superar, puede continuar la matriculación", "Listo!");
            {% endif %}
        });


        loadDataTableAlumnos = function(id, filter, level, fnOpenModal) {

            var self = this;
            //self.$table.dataTable().fnClearTable();
            bloqueointerface()
            self.$table = $('#divDetailData table');
            //const response = await fetch(url);
            self.$table.dataTable({
                responsive: true,
                searchDelay: 1000,
                bJQueryUI: false,
                bAutoWidth: false,
                //bProcessing: true,
                bServerSide: true,
                bSort: false,
                sPaginationType: "full_numbers",
                iDisplayLength: 25,
                sDom: '<"datatable-header"fl><"datatable-scroll"tr><"datatable-footer"ip>',
                sAjaxSource: "niveles",
                sServerMethod: "POST",
                initComplete: function(settings, json) {
                    console.log( 'DataTables has finished its initialisation.' );
                    console.log(settings);
                    console.log(json);
                    if (fnOpenModal) {
                        fnOpenModal();
                    }
                },
                fnServerParams: function (aoData) {
                    bloqueointerface();
                    aoData.push(
                        {"name": "action", "value": 'LoadDataTableAlumnos'},
                        {"name": "id", "value": id},
                        {"name": "level", "value": level},
                        {"name": "level_filter", "value": filter},
                    );
                },
                aoColumnDefs:
                    [
                        {
                            /*DOCUMENTO*/
                            aTargets: [0],
                            width: "8%",
                            fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
                                if (sData != 'NULL') {
                                    $(nTd).css('text-align', 'center')
                                    $(nTd).css('vertical-align', 'middle')
                                    $(nTd).css('padding', '8px')
                                }
                            }
                        },
                        {
                            /*ALUMNO*/
                            aTargets: [1],
                            width: "22%",
                            fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
                                if (sData != 'NULL') {
                                    $(nTd).css('text-align', 'left')
                                    $(nTd).css('vertical-align', 'middle')
                                    $(nTd).css('padding', '8px')
                                }
                            }
                        },
                        {
                            /*CARRERA*/
                            aTargets: [2],
                            width: "20%",
                            fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
                                if (sData != 'NULL') {
                                    $(nTd).css('text-align', 'center')
                                    $(nTd).css('vertical-align', 'middle')
                                    $(nTd).css('padding', '8px')
                                }
                            }
                        },
                        {
                            /*MODALIDAD*/
                            aTargets: [3],
                            width: "10%",
                            fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
                                if (sData != 'NULL') {
                                    $(nTd).css('text-align', 'center')
                                    $(nTd).css('vertical-align', 'middle')
                                    $(nTd).css('padding', '8px')
                                }
                            }
                        },
                        {
                            /*ASIGNATURA y PARALELO*/
                            aTargets: [4],
                            width: "25%",
                            /*mRender: function (data, type, row)
                            {
                                return '<input type="hidden" class="dt-col-estado-usuario" value="' + (data) + '"/>';
                            },*/
                            fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
                                if (sData != 'NULL') {
                                    $(nTd).css('text-align', 'left')
                                    $(nTd).css('vertical-align', 'middle')
                                    $(nTd).css('padding', '8px')
                                }
                            }
                        },
                        {
                            /*RUBRO*/
                            aTargets: [5],
                            width: "6%",
                            mRender: function (data, type, row) {
                                return '<span>'+data.valortotal+'/'+data.saldo+'</span>';
                            },
                            fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
                                if (sData != 'NULL') {
                                    $(nTd).css('text-align', 'center')
                                    $(nTd).css('vertical-align', 'middle')
                                    $(nTd).css('padding', '8px')
                                }
                            }
                        },
                        {
                            /*USUARIO*/
                            aTargets: [6],
                            width: "10%",
                            mRender: function (data, type, row) {
                                var perfil = data.tiene_perfilusuario ? data.tiene_perfilusuario_visible ? '<span class="label label-success">ACTIVO</span>' : '<span class="label label-warning">INACTIVO</span>' : '<span class="label label-important">SIN PERFIL</span>';
                                return '<div><b>Usuario: </b> ' + data.usuario + '</div> <div><b>Perfil: </b>'+ perfil +'</div>';
                            },
                            fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
                                if (sData != 'NULL') {
                                    $(nTd).css('text-align', 'left')
                                    $(nTd).css('vertical-align', 'middle')
                                    $(nTd).css('padding', '8px')
                                }
                            }
                        },
                    ]
                ,
                fnDrawCallback: function (oSettingst) {
                    $.unblockUI()
                }

            });

            $("#dtViewAlumnos_filter input").unbind(); // 'x' es el nombre de tu tabla
            $('#dtViewAlumnos_filter input').bind('keyup', function (e) {
                if (e.keyCode == 13) {
                    self.$table.dataTable().fnFilter(this.value);
                }
            });

        }

        cargaDistributivo = function (data) {
            //console.log(data);
            var ulDistributivo = $("#idcabecera")
            var niveles = data.iData
            var html = "";
            $.each(niveles, function (iNivel, vNivel) {
                html += "<li id='li_distributivo_" + vNivel.id + "'class='parent_li'><span title='Contraer'><i class='fa fa-folder-open'></i> <a>" + vNivel.nombre + "</a></span><br>";
                var modalidades = vNivel.hasOwnProperty('modalidades') ? vNivel.modalidades : null
                if (modalidades.length > 0) {
                    html += "<ul id='ul_modalidad'>";
                    $.each(modalidades, function (iModalidad, vModalidad) {
                        html += "<li id='li_modalidad_" + vModalidad.id + "'class='parent_li'><span title='Contraer'><i class='fa fa-folder-open'></i> <a>" + vModalidad.nombre + "</a></span><br>";
                        var carreras = vModalidad.hasOwnProperty('carreras') ? vModalidad.carreras : null
                        if (carreras.length > 0) {
                            html += "<ul id='ul_carrera'>";
                            $.each(carreras, function (iCarrera, vCarrera) {
                                html += "<li id='li_carrera_" + vCarrera.id + "'class='parent_li'><span title='Contraer'><i class='fa fa-folder-open'></i> <a>" + vCarrera.nombre + "</a></span><br>";
                                var materias = vCarrera.hasOwnProperty('materias') ? vCarrera.materias : null
                                if (materias.length > 0) {
                                    html += "<ul id='ul_materia'>";
                                    $.each(materias, function (iMateria, vMateria) {
                                        html += "<li id='li_materia_" + vMateria.id + "'class='parent_li'><span title='Contraer'><i class='fa fa-folder-open'></i> <a>" + vMateria.nombre + "</a></span><br>";
                                        var paralelos = vMateria.hasOwnProperty('paralelos') ? vMateria.paralelos : null
                                        if (paralelos.length > 0) {
                                            html += "<ul id='ul_materia'>";
                                            $.each(paralelos, function (iParalelo, vParalelo) {
                                                html += "<li id='li_paralelo_" + vMateria.id + "'class='parent_li'><span title='Contraer'><i class='fa fa-folder-open'></i> <a>" + vParalelo.nombre + "</a></span></li>";
                                            });
                                            html += "</ul>";
                                        }
                                        html += "</li>";
                                    });
                                    html += "</ul>";
                                }
                                html += "</li>";
                            });
                            html += "</ul>";
                        }
                        html += "</li>";
                    });
                    html += "</ul>";
                }
                html += "</li>";
            });
            ulDistributivo.append(html);
        };

        /*$(document).ready(function () {
            console.log("ready!");
        });*/
    </script>
    <style>
        .tree {
            min-height: 20px;
            padding: 19px;
            margin-bottom: 20px;
            background-color: #fbfbfb;
            border: 1px solid #999;
            -webkit-border-radius: 4px;
            -moz-border-radius: 4px;
            border-radius: 4px;
            -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
            -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05)
        }

        .tree li {
            list-style-type: none;
            margin: 0;
            padding: 10px 5px 0 5px;
            position: relative
        }

        .tree li::before, .tree li::after {
            content: '';
        {#overflow: visible;#} left: -20px;
            position: absolute;
            right: auto
        }

        .tree li::before {
            border-left: 1px solid #999;
            bottom: 50px;
            height: 100%;
            top: 0;
            width: 1px
        }

        .tree li::after {
            border-top: 1px solid #999;
            height: 20px;
            top: 25px;
            width: 25px
        }

        .tree li span {
            -moz-border-radius: 5px;
            -webkit-border-radius: 5px;
            border: 1px solid #999;
            border-radius: 5px;
            display: inline-block;
            padding: 3px 8px;
            text-decoration: none
        }

        .tree li > span, .tree li.parent_li > span {
            cursor: pointer
        }

        .tree > ul > li::before, .tree > ul > li::after {
            border: 0
        }

        .tree li:last-child::before {
            height: 30px
        }

        .tree li.parent_li > span:hover, .tree li.parent_li > span:hover + ul li span {
            background: #eee;
            border: 1px solid #94a0b4;
            color: #000
        }

        .mostrarli {
            overflow: visible;
        }


        .tree li > span.label-important > a, .tree li.parent_li > span.label-important > a, .tree li.parent_li > span.label-important > a + ul li span {
            color: #EEEEEE !important;
        }

        .tree li > span.label-important:hover, .tree li.parent_li > span.label-important:hover, .tree li.parent_li > span.label-important:hover + ul li span {
            background-color: #f2dede !important;
            border: 1px solid #eed3d7 !important;
        }

        .tree li > span.label-important:hover > a:hover, .tree li.parent_li > span.label-important:hover > a:hover, .tree li.parent_li > span.label-important:hover > a:hover + ul li span {
            color: #b94a48 !important;
        }

        .tree li > span.label-success > a, .tree li.parent_li > span.label-success > a, .tree li.parent_li > span.label-success > a + ul li span {
            color: #EEEEEE !important;
        }

        .tree li > span.label-success:hover, .tree li.parent_li > span.label-success:hover, .tree li.parent_li > span.label-success:hover + ul li span {
            background-color: #dff0d8 !important;
            border: 1px solid #d6e9c6 !important;
        }

        .tree li > span.label-success:hover > a:hover, .tree li.parent_li > span.label-success:hover > a:hover, .tree li.parent_li > span.label-success:hover > a:hover + ul li span {
            color: #468847 !important;
        }

        .tree li > span.label-warning > a, .tree li.parent_li > span.label-warning > a, .tree li.parent_li > span.label-warning > a + ul li span {
            color: #EEEEEE !important;
        }

        .tree li > span.label-warning:hover, .tree li.parent_li > span.label-warning:hover, .tree li.parent_li > span.label-warning:hover + ul li span {
            background-color: #fcf8e3 !important;
            border: 1px solid #fbeed5 !important;
        }

        .tree li > span.label-warning:hover > a:hover, .tree li.parent_li > span.label-warning:hover > a:hover, .tree li.parent_li > span.label-warning:hover > a:hover + ul li span {
            color: #c09853 !important;
        }

    </style>
{% endblock %}
{% block atras %}/niveles?action=importar_matriz_senescyt{% endblock %}
{% block canvas %}
    <div class="tree well">
        <div class="row-fluid">
            <div class="span12">
                <div align="center"><h4>{{ title }}</h4></div>
            </div>
        </div>
        <div class="row-fluid">
            <div class="span6">
                <h5>Periodo Académico: {{ periodo.nombre }} - [{% if periodo.activo %}
                    <span class="label label-success">Activo</span> {% else %}
                    <span class="label label-important">Inactivo</span> {% endif %}] - [<span
                        class="label label-info">{{ periodo.tipo.nombre }}</span>]</h5>
                <h5>Fecha Inicio: {{ periodo.inicio|date:"d-m-Y" }} - Fecha Fin: {{ periodo.fin|date:"d-m-Y" }}</h5>
                <h5>Inicio agregaciones: {{ periodo.inicio_agregacion|date:"d-m-Y" }} - Limite
                    agregaciones: {{ periodo.limite_agregacion|date:"d-m-Y" }} - Limite
                    retiro: {{ periodo.limite_retiro|date:"d-m-Y" }}</h5>
            </div>
            <div class="span6">
                <div class="datatable">
                    <table class='table table-bordered table-striped'>
                        <thead>
                        <tr>
                            <th style="text-align: center">Número Demanda (SENESCYT)</th>
                            <th style="text-align: center">Número Planificados (Distributivo)</th>
                            <th style="text-align: center"> Número Matriculados</th>
                            <th style="text-align: center"> Número por Matricular</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td style="text-align: center">{{ distributivo.cupoDemanda }}</td>
                            <td style="text-align: center">{{ distributivo.cupoOfertado }}</td>
                            <td style="text-align: center">{{ total_matricular }}</td>
                            <td style="text-align: center">{{ total_por_matricular }}</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="row-fluid">
            <div class="span6">
                {% if distributivo.isCanEnroll %}
                    {#                    <a href="javascript:;" class="btn btn-primary actionRegister" _value_id="{{ matriz.id }}" _value_level="masiva" _value_data="" _value_filter="" _value_status="{{ matriz.status_matricular_masiva }}"><i class="fa fa-cogs"></i> Matriculación Masiva</a>#}
                {% else %}
                    <a href="javascript:;" class="btn btn-default actionCancelCelery" _value_id="{{ matriz.id }}" _value_level="masiva" _value_data="" _value_filter=""><i class="fa fa-refresh"></i> Cancelar Matriculación</a>
                {% endif %}
                <a href="javascript:;" class="btn btn-default actionRefresh"><i class="fa fa-refresh"></i> Actualizar Información</a>
                {% if total_por_matricular < distributivo.cupoDemanda %}
                    <a href="javascript:;" class="btn btn-success actionActiveProfileUser" _value_id="{{ matriz.id }}" _value_level="masiva" _value_data="" _value_filter="" _value_status="{{ matriz.status_matricular_masiva }}"><i class="fa fa-cogs"></i> Activar Perfiles Masiva</a>
                {% endif %}
                {% if periodos_admision %}
                    <select name="periodo_admision" id="periodo_admision" class="select2" style="width: 40%">
                        {% for per_ad in periodos_admision %}
                            <option value="{{ per_ad.id }}" {% if per_ad.id == periodosadmision_aux.id %}selected="selected" {% endif %}>{{ per_ad.nombre }}</option>
                        {% endfor %}
                    </select>
                {% endif %}
            </div>
        </div>
        <br>
        {% if not distributivo.isValid %}
            <div class="accordion" id="accordionnivel_1">
                <div class="accordion-group">
                    <div class="accordion-heading">
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordionnivel_1"
                           href="#collapsenivel_1">Existen observaciones generales en la planificación del
                            distributivo </a>
                    </div>
                    <div id="collapsenivel_1" class="accordion-body collapse in">
                        <div class="accordion-inner">
                            {% for msg in distributivo.iMensaje.error %}
                                <div class="alert alert-danger">{{ msg }}</div>
                            {% endfor %}
                            {% for msg in distributivo.iMensaje.warning %}
                                <div class="alert alert-warning">{{ msg }}</div>
                            {% endfor %}
                            {% for msg in distributivo.iMensaje.succes %}
                                <div class="alert alert-success">{{ msg }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        <ul id="idcabecera">
            {% for nivel in distributivo.iData %}
                <li id="id_nivel_{{ nivel.id }}">
                    {% if nivel.tipo != 'success' %}
                        <a href='javascript:;'
                           class='btn btn-tini {% if nivel.tipo == 'error' %} btn-danger {% else %} btn-warning {% endif %} tu actionMSG'
                           _value_id="{{ nivel.id }}" _value_data="{{ nivel.msg }}" _value_level="nivel"
                           title='{% if nivel.tipo == 'error' %} Error {% else %} Información {% endif %}'><i
                                class='fa {% if nivel.tipo == 'error' %} fa-exclamation {% else %} fa-info {% endif %}'></i></a>
                    {% endif %}
                    {% if nivel.cupo > 0 %}
                        <a href='javascript:;' class='btn btn-tini btn-default tu actionCupo' _value_id="{{ nivel.id }}"
                           _value_data="En la sección {{ nivel.nombre }}, el total de cupo ofertado es: {{ nivel.cupo }}"
                           _value_level="nivel" title='Cupo'><i class='fa fa-users'></i> CUPO({{ nivel.cupo }})</a>
                    {% endif %}
                    <a href='javascript:;' class='btn btn-tini btn-info tu actionLoadAlumnos' _value_id='{{ nivel.id }}'
                       _value_filter='' _value_data='' _value_level='nivel' title='Tomaron la materia'><i class="fa fa-users"></i></a>
                    <span><i class="fa fa-folder"></i> <a class="nivel"  _value_id="{{ nivel.id }}"> {{ nivel.nombre }}</a></span>
                    {% if nivel.modalidades %}
                        <br>
                        <ul>
                            {% for modalidad in nivel.modalidades %}
                                <li id="id_modalidad_{{ modalidad.id }}" class="mostrarli" style="overflow: visible;">
                                    {% if modalidad.tipo != 'success' %}
                                        <a href='javascript:;'
                                           class='btn btn-tini {% if modalidad.tipo == 'error' %} btn-danger {% else %} btn-warning {% endif %} tu actionMSG'
                                           _value_id="{{ modalidad.id }}" _value_data="{{ modalidad.msg }}"
                                           _value_level="modalidad"
                                           title='{% if modalidad.tipo == 'error' %} Error {% else %} Información {% endif %}'><i
                                                class='fa {% if modalidad.tipo == 'error' %} fa-exclamation {% else %} fa-info {% endif %}'></i></a>
                                    {% endif %}
                                    {% if modalidad.cupo > 0 %}
                                        <a href='javascript:;' class='btn btn-tini btn-default tu actionCupo'
                                           _value_id="{{ modalidad.id }}"
                                           _value_data="En la sección {{ nivel.nombre }} de la modalidad {{ modalidad.nombre }}, el total de cupo ofertado es:{{ modalidad.cupo }}"
                                           _value_level="modalidad" title='Cupo'><i
                                                class='fa fa-users'></i> CUPO({{ modalidad.cupo }})</a>
                                    {% endif %}
                                    <a href='javascript:;' class='btn btn-tini btn-info tu actionLoadAlumnos'
                                       _value_id='{{ modalidad.id }}' _value_filter='nivel_id={{ nivel.id }}'
                                       _value_data='' _value_level='modalidad'
                                       title='Tomaron la materia'><i class="fa fa-users"></i></a>
                                    <span class=""><i class="fa fa-folder"></i> <a class="modalidad" _value_id="{{ modalidad.id }}"> {{ modalidad.nombre }}</a></span>
                                    {% if modalidad.carreras %}
                                        <br>
                                        <ul>
                                            {% for carrera in modalidad.carreras %}
                                                {% with statusCarrera=matriz|args:carrera.id|call:'status_matricular_carrera' %}
                                                    <li id="id_carrera_{{ carrera.id }}" class="mostrarli" style="overflow: visible; display: none;">
                                                        {% if carrera.tipo != 'success' %}
                                                            <a href='javascript:;'
                                                               class='btn btn-tini {% if carrera.tipo == 'error' %} btn-danger {% else %} btn-warning {% endif %} tu actionMSG'
                                                               _value_id="{{ carrera.id }}" _value_data="{{ carrera.msg }}"
                                                               _value_level="carrera"
                                                               title='{% if carrera.tipo == 'error' %} Error {% else %} Información {% endif %}'><i class='fa {% if carrera.tipo == 'error' %} fa-exclamation {% else %} fa-info {% endif %}'></i></a>
                                                        {% endif %}
                                                        {% if carrera.cupo > 0 %}
                                                            <a href='javascript:;'
                                                               class='btn btn-tini btn-default tu actionCupo'
                                                               _value_id="{{ carrera.id }}"
                                                               _value_data="En la sección {{ nivel.nombre }} de la modalidad {{ modalidad.nombre }} y carrera {{ carrera.nombre }}, el total de cupo ofertado es: {{ carrera.cupo }} y el total de la demanda de primera matricula (SENESCYT) es: {{ carrera.total_demanda }}, y el total de la demanda de segunda matricula (REPETIDORES) es: {{ carrera.cupo2m }}"
                                                               _value_level="carrera" title='Cupo / 1ra-M / 2da-M'><i class='fa fa-users'></i> {{ carrera.cupo }} / {{ carrera.total_demanda }} / {{ carrera.cupo2m }}</a>
                                                        {% endif %}
                                                        <a href='javascript:;'
                                                           class='btn btn-tini btn-info tu actionLoadAlumnos'
                                                           _value_id='{{ carrera.id }}'
                                                           _value_filter='nivel_id={{ nivel.id }},modalidad_id={{ modalidad.id }}'
                                                           _value_data=''
                                                           _value_level='carrera' title='Tomaron la materia'><i class="fa fa-users"></i></a>
                                                        <a href='javascript:;'
                                                           class='btn btn-tini btn-primary tu actionRegister'
                                                           _value_id='{{ matriz.id }}'
                                                           _value_filter='carrera_id={{ carrera.id }}'
                                                           _value_data='{{ carrera.nombre }}'
                                                           _value_level='carrera'
                                                           _value_status="{{ statusCarrera }}"
                                                           title='Primera Matricula'><i class="fa fa-gear"></i> 1M</a>

                                                        <a href='javascript:;'
                                                           class='btn btn-tini btn-warning tu actionViewEnroll_2m'
                                                           _value_id='{{ matriz.id }}'
                                                           _value_filter='nivel_id={{ nivel.id }},carrera_id={{ carrera.id }}'
                                                           _value_data='{{ carrera.nombre }}'
                                                           _value_level='nivel,carrera'
                                                           _value_status="{{ statusCarrera }}"
                                                           title='Segunda Matricula'><i class="fa fa-gear"></i> 2M</a>
                                                        {% if persona.usuario.is_superuser %}
                                                            <a href='javascript:;'
                                                               class='btn btn-tini btn-danger tu actionDeleteEnroll'
                                                               _value_id='{{ matriz.id }}'
                                                               _value_filter='carrera_id={{ carrera.id }}'
                                                               _value_data='{{ carrera.nombre }}'
                                                               _value_level='carrera'
                                                               _value_status="{{ statusCarrera }}"
                                                               title='Eliminar Matricula'><i class="fa fa-remove"></i></a>
                                                        {% endif %}
                                                        <a href='javascript:;'
                                                           class='btn btn-tini btn-success tu actionActiveProfileUser'
                                                           _value_id='{{ matriz.id }}'
                                                           _value_filter='carrera_id={{ carrera.id }}'
                                                           _value_data='{{ carrera.nombre }}'
                                                           _value_level='carrera'
                                                           _value_status="{{ statusCarrera }}"
                                                           title='Activar Perfiles'><i class="fa fa-gear"></i></a>


                                                        <span class=""><i class="fa fa-folder"></i> <a class="carrera" _value_id="{{ carrera.id }}"> {{ carrera.nombre }}</a></span>
                                                        {% if carrera.materias %}
                                                            <br>
                                                            <ul>
                                                                {% for materia in carrera.materias %}
                                                                    <li id="id_materia_{{ materia.id }}" class="mostrarli"
                                                                        style="overflow: visible; display: none;">
                                                                        {% if materia.tipo != 'success' %}
                                                                            <a href='javascript:;'
                                                                               class='btn btn-tini {% if materia.tipo == 'error' %} btn-danger {% else %} btn-warning {% endif %} tu actionMSG'
                                                                               _value_id="{{ materia.id }}"
                                                                               _value_data="{{ materia.msg }}"
                                                                               _value_level="materia"
                                                                               title='{% if materia.tipo == 'error' %} Error {% else %} Información {% endif %}'><i class='fa {% if materia.tipo == 'error' %} fa-exclamation {% else %} fa-info {% endif %}'></i></a>
                                                                        {% endif %}
                                                                        {% if materia.cupo > 0 %}
                                                                            <a href='javascript:;'
                                                                               class='btn btn-tini btn-default tu actionCupo'
                                                                               _value_id="{{ materia.id }}"
                                                                               _value_data="En la sección {{ nivel.nombre }} de la modalidad {{ modalidad.nombre }} y carrera {{ carrera.nombre }}, de la materia {{ materia.nombre }}; el total de cupo ofertado es: {{ materia.cupo }}"
                                                                               _value_level="materia" title='Cupo'><i class='fa fa-users'></i> CUPO({{ materia.cupo }})
                                                                            </a>
                                                                        {% endif %}
                                                                        <a href='javascript:;'
                                                                           class='btn btn-tini btn-info tu actionLoadAlumnos'
                                                                           _value_id='{{ materia.id }}'
                                                                           _value_filter='nivel_id={{ nivel.id }},modalidad_id={{ modalidad.id }},carrera_id={{ carrera.id }}'
                                                                           _value_data=''
                                                                           _value_level='materia'
                                                                           title='Tomaron la materia'><i
                                                                                class="fa fa-users"></i></a>
                                                                        <span class=""><i class="fa fa-folder"></i> <a class="materia" _value_id="{{ materia.id }}"> {{ materia.nombre }}</a></span>
                                                                        {% if materia.paralelos %}
                                                                            <br>
                                                                            <ul>
                                                                                {% for paralelo in materia.paralelos %}
                                                                                    <li id="id_paralelo_{{ paralelo.id }}"
                                                                                        class="mostrarli"
                                                                                        style="overflow: visible; display: none;">
                                                                                        {% if paralelo.tipo != 'success' %}
                                                                                            <a href='javascript:;'
                                                                                               class='btn btn-tini {% if paralelo.tipo == 'error' %} btn-danger {% else %} btn-warning {% endif %} tu actionMSG'
                                                                                               _value_id="{{ paralelo.id }}"
                                                                                               _value_data="{{ paralelo.msg }}"
                                                                                               _value_level="paralelo"
                                                                                               title='{% if paralelo.tipo == 'error' %} Error {% else %} Información {% endif %}'><i
                                                                                                    class='fa {% if paralelo.tipo == 'error' %} fa-exclamation {% else %} fa-info {% endif %}'></i></a>
                                                                                        {% endif %}
                                                                                        {% if paralelo.cupo > 0 %}
                                                                                            <a href='javascript:;'
                                                                                               class='btn btn-tini btn-default tu actionCupo'
                                                                                               _value_id="{{ paralelo.id }}"
                                                                                               _value_data="En la sección {{ nivel.nombre }} de la modalidad {{ modalidad.nombre }} y carrera {{ carrera.nombre }}, de la materia {{ materia.nombre }} y paralelo {{ paralelo.nombre }}; el total de cupo ofertado es: {{ paralelo.cupo }}"
                                                                                               _value_level="paralelo"
                                                                                               title='Cupo'><i class='fa fa-users'></i> CUPO({{ paralelo.cupo }})
                                                                                            </a>
                                                                                        {% endif %}
                                                                                        <a href='javascript:;'
                                                                                           class='btn btn-tini btn-info tu actionLoadAlumnos'
                                                                                           _value_id='{{ paralelo.id }}'
                                                                                           _value_filter='nivel_id={{ nivel.id }},modalidad_id={{ modalidad.id }},carrera_id={{ carrera.id }},materia_id={{ materia.id }}'
                                                                                           _value_data=''
                                                                                           _value_level='paralelo'
                                                                                           title='Tomaron la materia'><i class="fa fa-users"></i></a>
                                                                                        <span class=""><i class="fa fa-folder"></i> <a class="paralelo" _value_id="{{ paralelo.id }}"> {{ paralelo.nombre }}</a></span>
                                                                                    </li>
                                                                                {% endfor %}
                                                                            </ul>
                                                                        {% endif %}
                                                                    </li>
                                                                {% endfor %}

                                                            </ul>
                                                        {% endif %}
                                                    </li>
                                                {% endwith %}
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    </div>

    <div id="modalViewAlumnos" data-width="" class="modal fade" aria-labelledby="" aria-hidden="true" tabindex="-1"
         role="dialog" style="display: block;" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <!--<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>-->
                    <h4 class="modal-title panel-title">Listado de alumnos</h4>
                </div>
                <div class="modal-body">
                    <div class="row-fluid">
                        <div class="span12">
                            <div class="datatable" id="divDetailData">
                                <table id="dtViewAlumnos" class='table table-bordered table-striped'>
                                    <thead>
                                    <tr>
                                        <th style="text-align: center">Documento</th>
                                        <th style="text-align: center">Alumno</th>
                                        <th style="text-align: center">Carrera</th>
                                        <th style="text-align: center">Modalidad</th>
                                        <th style="text-align: center">Asignatura-[Paralelo]</th>
                                        <th style="text-align: center">Rubro</th>
                                        <th style="text-align: center">Usuario</th>
                                        <!--<th style="text-align: center"></th>-->
                                    </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <!--<a href="javascript:;" class="btn btn-success action-edit"><i class="fa fa-edit"></i> Editar</a>-->
                    <a href="javascript:;" class="btn btn-info action-close" data-dismiss="modal"> Cerrar</a>
                </div>
            </div>

        </div>
    </div>

    <div id="modalActionEnrollRepeat" data-width="" class="modal fade" aria-labelledby="" aria-hidden="true" tabindex="-1"
         role="dialog" style="display: block;" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <!--<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>-->
                    <h4 class="modal-title panel-title">Segunda matricula <span></span></h4>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                    <a href="javascript:;" class="btn btn-success action-enroll"><i class="fa fa-gear"></i> Matricular</a>
                    <a href="javascript:;" class="btn btn-info action-close" data-dismiss="modal"> Cerrar</a>
                </div>
            </div>

        </div>
    </div>


{% endblock %}
