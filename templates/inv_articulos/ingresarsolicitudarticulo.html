{% extends "ajaxformbs.html" %}
{% load sga_extras %}
{% block extraheading %}
    <script type="text/javascript">
        $(function(){
            $(function(){
                $("#id_fecharecepcion, #id_fechaaprobacion, #id_fechapublicacion").datepicker({format:"dd-mm-yyyy"}).on('changeDate', function(ev){ $(this).datepicker('hide'); });
                $("#id_nombre, #id_revista2, #id_estadopublicacion, #id_fecharecepcion, #id_fechaaprobacion, #id_fechapublicacion").addClass("validate[required]");
                $("#id_areaconocimiento, #id_subareaconocimiento, #id_subareaespecificaconocimiento, #id_lineainvestigacion, #id_sublineainvestigacion, #id_categoriaarticulo").addClass("validate[required]");
                $("#id_estadosolicitud").addClass("validate[required]");

                lista_items1 = [];

                var tiposolicitud = parseInt('{{ tiposolicitud }}');

                $("#id_numero, #id_volumen, #id_paginas").css({'text-transform': 'none'});

                $('#id_areaconocimiento').change(function(){
                    $('#id_subareaconocimiento, #id_subareaespecificaconocimiento').empty().append('<option value="">---------</option>').val(0).trigger("change");
                    var control = $(this);
                    var id = parseInt($("#id_areaconocimiento").val());
                    if (id > 0) {
                        bloqueointerface();
                        $.ajax({
                            type: "POST",
                            url: "/api",
                            data: {'a': 'subareaconocimiento', 'id': id},
                            success: function (data) {
                                $.unblockUI();
                                if (data.result == 'ok') {
                                    for (elemento in data.lista) {
                                        $('#id_subareaconocimiento').append('<option value="' + data.lista[elemento][0] + '">' + data.lista[elemento][1] + '</option>');
                                    }
                                } else {
                                    control.val(0).trigger("change");
                                    smoke.alert(data.mensaje);
                                }
                            },
                            error: function () {
                                $.unblockUI();
                                control.val(0).trigger("change");
                                smoke.alert("Error de conexion.");
                            },
                            dataType: "json"
                        });
                    }
                });

                $('#id_subareaconocimiento').change(function(){
                    $('#id_subareaespecificaconocimiento').empty().append('<option value="">---------</option>').val(0).trigger("change");
                    var control = $(this);
                    var id = parseInt($("#id_subareaconocimiento").val());
                    if (id > 0) {
                        bloqueointerface();
                        $.ajax({
                            type: "POST",
                            url: "/api",
                            data: {'a': 'subareaespecificaconocimiento', 'id': id},
                            success: function (data) {
                                $.unblockUI();
                                if (data.result == 'ok') {
                                    for (elemento in data.lista) {
                                        $('#id_subareaespecificaconocimiento').append('<option value="' + data.lista[elemento][0] + '">' + data.lista[elemento][1] + '</option>');
                                    }
                                } else {
                                    control.val(0).trigger("change");
                                    smoke.alert(data.mensaje);
                                }
                            },
                            error: function () {
                                $.unblockUI();
                                control.val(0).trigger("change");
                                smoke.alert("Error de conexion.");
                            },
                            dataType: "json"
                        });
                    }
                });

                $('#id_revista2').change(function(){
                    $("#id_base").val("");
                    $("#edit_revista, #go_link").hide();
                    var control = $(this);
                    var id = parseInt(control.val());
                    if (id > 0) {
                        bloqueointerface();
                        $.ajax({
                            type: "POST",
                            url: "/api",
                            data: {'a': 'datosrevista', 'id': id},
                            success: function (data) {
                                $.unblockUI();
                                if (data.result == 'ok') {
                                    //$("#id_enlace").val(data.enlace);
                                    $("#id_base").val(data.baseindexada);
                                    $("#id_categoriabase").val(data.categorianombre);
                                    $("#categoriabaseid").val(data.categoriaid);
                                    $("#basescielo").val(data.tienebasescielo);
                                    {#$("#id_cuartil2").val(data.cuartil);#}
                                    {#$("#id_sjr2").val(data.sjr);#}
                                    {#$("#id_jcr2").val(data.jcr);#}
                                    {#$("#id_revistaindexada2").val(data.revistaindexada);#}

                                    determinarcategoria();

                                    $("#edit_revista").show();
                                    if(data.enlace)
                                        $("#go_link").show();
                                    else
                                        $("#go_link").hide();
                                } else {
                                    control.val(0).trigger("change");
                                    smoke.alert(data.mensaje);
                                }
                            },
                            error: function () {
                                $.unblockUI();
                                control.val(0).trigger("change");
                                smoke.alert("Error de conexion.");
                            },
                            dataType: "json"
                        });
                    }
                });

                $('#id_lineainvestigacion').change(function(){
                    $('#id_sublineainvestigacion').empty().append('<option value="">---------</option>').val(0).trigger("change");
                    var control = $(this);
                    var id = parseInt($("#id_lineainvestigacion").val());
                    if (id > 0) {
                        bloqueointerface();
                        $.ajax({
                            type: "POST",
                            url: "/api",
                            data: {'a': 'sublineainvestigacion', 'id': id},
                            success: function (data) {
                                $.unblockUI();
                                if (data.result == 'ok') {
                                    for (elemento in data.lista) {
                                        $('#id_sublineainvestigacion').append('<option value="' + data.lista[elemento][0] + '">' + data.lista[elemento][1] + '</option>');
                                    }
                                } else {
                                    control.val(0).trigger("change");
                                    smoke.alert(data.mensaje);
                                }
                            },
                            error: function () {
                                $.unblockUI();
                                control.val(0).trigger("change");
                                smoke.alert("Error de conexion.");
                            },
                            dataType: "json"
                        });
                    }
                });

                $('#id_estadopublicacion').change(function(){
                    var control = $(this);
                    if(control.val() == "1"){
                        $("#fieldset_fechapublicacion").show();
                        $("#fieldset_archivo").show();

                        $("#fieldset_enlace").show();
                        $("#fieldset_numero").show();
                        $("#fieldset_volumen").show();
                        $("#fieldset_paginas").show();

                        $("#id_enlace").attr("readonly", false);
                        $("#id_numero").attr("readonly", false);
                        $("#id_volumen").attr("readonly", false);
                        $("#id_paginas").attr("readonly", false);
                        $("#id_enlace").attr("readonly", false);
                        $("#id_archivo").attr('disabled', false);

                        $("#id_numero").addClass("validate[required]");
                        $("#id_volumen").addClass("validate[required]");
                        $("#id_paginas").addClass("validate[required]");
                        $("#id_enlace").addClass("validate[required]");

                        {#if(obligarchivo == 'S')#}
                        {#    $("#id_archivo").addClass("validate[required]");#}

                    }else{
                        $("#fieldset_fechapublicacion").hide();
                        $("#fieldset_archivo").hide();

                        $("#fieldset_enlace").hide();
                        $("#fieldset_numero").hide();
                        $("#fieldset_volumen").hide();
                        $("#fieldset_paginas").hide();

                        $("#id_enlace").attr("readonly", true);
                        $("#id_numero").attr("readonly", true);
                        $("#id_volumen").attr("readonly", true);
                        $("#id_paginas").attr("readonly", true);
                        $("#id_enlace").attr("readonly", true);
                        $("#id_archivo").attr('disabled', true);

                        $("#id_enlace").removeClass("validate[required]");
                        $("#id_numero").removeClass("validate[required]");
                        $("#id_volumen").removeClass("validate[required]");
                        $("#id_paginas").removeClass("validate[required]");
                        $("#id_archivo").removeClass("validate[required]");
                    }
                });

                $("#id_provieneproyecto").click(function () {
                    if ($(this).is(':checked')) {
                        $("#id_tipoproyecto").attr('disabled', false);
                        $("#id_proyectointerno").attr('disabled', false);
                        $("#id_proyectoexterno").attr('disabled', false);
                        $("#id_tipoproyecto").val(0).trigger('change');
                        $("#id_tipoproyecto").addClass("validate[required]");
                        $("#id_proyectointerno").addClass("validate[required]");
                        $("#id_proyectoexterno").addClass("validate[required]");
                        $("#fieldset_tipoproyecto, #fieldset_proyectointerno").show();
                    } else {
                        $("#id_tipoproyecto").attr('disabled', true);
                        $("#id_proyectointerno").attr('disabled', true);
                        $("#id_proyectoexterno").attr('disabled', true);
                        $("#id_tipoproyecto").val(0).trigger('change');
                        $("#id_tipoproyecto").removeClass("validate[required]");
                        $("#id_proyectointerno").removeClass("validate[required]");
                        $("#id_proyectoexterno").removeClass("validate[required]");
                        $("#fieldset_tipoproyecto, #fieldset_proyectointerno").hide();
                    }
                });

                $('#id_tipoproyecto').change(function(){
                    $('#id_proyectointerno').empty().append('<option value="">---------</option>').val(0).trigger("change");
                    $('#id_proyectoexterno').empty().append('<option value="">---------</option>').val(0).trigger("change");
                    $("#fieldset_proyectointerno").show();
                    $("#fieldset_proyectoexterno").hide();

                    var control = $(this);
                    var id = parseInt($("#id_tipoproyecto").val());
                    if (id > 0) {
                        bloqueointerface();
                        $.ajax({
                            type: "POST",
                            url: "/api",
                            data: {'a': 'proyectoinvestigacion', 'tipo': id},
                            success: function (data) {
                                $.unblockUI();
                                if (data.result == 'ok') {
                                    for (elemento in data.lista) {
                                        if(id != 3){
                                            $('#id_proyectointerno').append('<option value="' + data.lista[elemento][0] + '">' + data.lista[elemento][1] + '</option>');
                                        }
                                        else{
                                            $('#id_proyectoexterno').append('<option value="' + data.lista[elemento][0] + '">' + data.lista[elemento][1] + '</option>');
                                        }
                                    }

                                    if(id != 3){
                                        $("#fieldset_proyectointerno").show();
                                        $("#fieldset_proyectoexterno").hide();
                                        $("#id_proyectointerno").addClass("validate[required]");
                                        $("#id_proyectoexterno").removeClass("validate[required]");
                                    }
                                    else{
                                        $("#fieldset_proyectoexterno").show();
                                        $("#fieldset_proyectointerno").hide();
                                        $("#id_proyectoexterno").addClass("validate[required]");
                                        $("#id_proyectointerno").removeClass("validate[required]");
                                    }

                                } else {
                                    control.val(0).trigger("change");
                                    smoke.alert(data.mensaje);
                                }
                            },
                            error: function () {
                                $.unblockUI();
                                control.val(0).trigger("change");
                                smoke.alert("Error de conexion.");
                            },
                            dataType: "json"
                        });
                    }
                });




                $("#go_link").click(function () {
                    window.open($("#id_enlace").val(), '_blank');
                });

                $("#id_codigoissn, #id_tipo, #id_baseindexada, #id_nombrerevista").addClass("validate[required]");

                mostrarcampobasescopus = function (){
                    if(tiposolicitud == 1){
                        $("#id_cuartil option[value='1']").removeAttr('disabled');
                        $("#id_cuartil option[value='2']").removeAttr('disabled');
                        $("#id_cuartil option[value='3']").removeAttr('disabled');
                        $("#id_cuartil option[value='4']").removeAttr('disabled');
                        $("#id_cuartil option[value='5']").attr('disabled','disabled');
                    }else{
                        $("#id_cuartil option[value='1']").attr('disabled','disabled');
                        $("#id_cuartil option[value='2']").attr('disabled','disabled');
                        $("#id_cuartil option[value='3']").attr('disabled','disabled');
                        $("#id_cuartil option[value='4']").attr('disabled','disabled');
                        $("#id_cuartil option[value='5']").removeAttr('disabled','disabled');
                    }

                    $("#fieldset_cuartil, #fieldset_sjr").show();
                    $("#id_cuartil, #id_sjr").addClass("validate[required]");
                };

                ocultarcampobasescopus = function (){
                    $("#fieldset_cuartil, #fieldset_sjr").hide();
                    $("#id_cuartil, #id_sjr").removeClass("validate[required]");
                };

                mostrarcampobasewebscience = function (){
                    $("#fieldset_jcr").show();
                    $("#id_jcr").addClass("validate[required]");
                };

                ocultarcampobasewebscience = function (){
                    $("#fieldset_jcr").hide();
                    $("#id_jcr").removeClass("validate[required]");
                };

                ocultarcamposscopusweb = function (){
                    ocultarcampobasescopus();
                    ocultarcampobasewebscience();
                }

                ocultarcamposscopusweb();


                var ultimoseleccionado = null;
                $('#id_baseindexada').change(function() {
                    if($(this).val() != null){
                        if($(this).val().length > 3)
                            $(this).val(ultimoseleccionado).trigger('change');
                        else
                            ultimoseleccionado = $(this).val();

                        if($(this).val().length == 1){
                            var idbase = parseInt($(this).val());
                            if(idbase == 10){
                                mostrarcampobasescopus();
                                ocultarcampobasewebscience();
                            }
                            else if(idbase == 17 || idbase == 27){
                                mostrarcampobasewebscience();
                                ocultarcampobasescopus();
                            }
                            else{
                                ocultarcamposscopusweb();
                            }
                        }
                        else{
                            ocultarcamposscopusweb();
                        }

                        $("#detalle_documentos").empty();
                        $.each($("#id_baseindexada option:selected"), function(){
                            var cbase = $(this).val();
                            var nbase = $(this).text();
                            nueva = '<tr>\n' +
                                '       <td>\n' +
                                '           '+nbase+'\n' +
                                '           <input type="hidden" name="idbasedocumento[]" value="'+cbase+'"/>\n' +
                                '       </td>\n' +
                                '       <td>\n' +
                                '           <label class="btn btn-default"><i class="fa fa-cloud-upload" aria-hidden="true"></i> Seleccionar <span id="bga_'+cbase+'" class="badge">0</span><input type="file" style="color: transparent" class="archivosbase" nf="'+cbase+'" nb="'+nbase+'" name="documento[]" hidden> </label>\n' +
                                '       </td>\n' +
                                '    </tr>'
                            $("#detalle_documentos").append(nueva);
                            conectar_change_fileinput();
                        });

                    }
                    else{
                        ultimoseleccionado = $(this).val();
                        ocultarcamposscopusweb();
                        $("#detalle_documentos").empty();
                    }
                });

                conectar_change_fileinput=function() {
                    $(".archivosbase").unbind();
                    $(".archivosbase").change(function () {
                        var id = $(this).get(0).files.length;
                        var idf = $(this).attr('nf');
                        $("#bga_"+idf).html("1");
                        actualizar_lista_basedocumento();
                    });
                };

                actualizar_lista_basedocumento = function (){
                    lista_items1 = [];
                    $('input[type=file]').each(function() {
                        if($(this).get(0).files.length > 0){
                            var item = {
                                idbase: $(this).attr('nf'),
                                nombrebase: $(this).attr('nb')
                            };
                            lista_items1.push(item);
                        }
                    });
                };


                /*$("#id_nombrecolegio").keypress(function(event) {
                    if (event.keyCode == 13) {
                        event.preventDefault();
                    }
                });*/

                $("#add_revista").click(function() {
                    $("#id_baseindexada, #id_tipo, #id_cuartil").select2({ width: '100%' });

                    /*$("#id_codigoissn").val("");
                    $("#id_nombrerevista").val("");
                    $("#id_institucion").val("");
                    $("#id_enlacerevista").val("");
                    */
                    $("#id_baseindexada").trigger('change');


                    $("#itemspanelagregarrevista").modal({keyboard: false, backdrop:'static', width: '500px'}).modal('show');
                });

                $(".cerrarrevista").click(function () {
                    $('#itemspanelagregarrevista').modal('hide');
                });

                $(".guardarrevista").click(function() {
                    envioformularioreg("/articulosinvestigacion","addrevista", false);
                    return false;
                });

                $("#edit_revista").click(function() {
                    var id = $("#id_revista2").val();
                    $("#idrev").val(id);
                    tiporegistro = parseInt($("#tiporegistro").val());
                    bloqueointerface();
                    $.ajax({
                        type: "GET",
                        url: "/articulosinvestigacion",
                        data: {'action': 'editrevistaarticulo', 'id': id, 'tiporegistro': tiporegistro},
                        success: function(data) {
                            $.unblockUI();
                            if (data.result == 'ok') {
                                $(".panelbodyeditarrevista").html(data.data);
                                $(".paneltitleeditrevista").html(data.title);
                                $("#itemspaneleditarrevista").modal({keyboard: false, backdrop:'static', width: '500px'}).modal('show');
                            } else {
                                smoke.alert(data.mensaje);
                            }
                        },
                        error: function() {
                            $.unblockUI();
                            smoke.alert("Error de conexión.");
                        },
                        dataType: "json"
                    });
                });

                $(".actualizarrevista").click(function() {
                    envioformularioreg("/articulosinvestigacion","editrevistaarticulo", false);
                    return false;
                });

                $(".cerrareditrevista").click(function () {
                    $('#itemspaneleditarrevista').modal('hide');
                });

                envioformularioreg = function(url, action, destino){
                    if(action == 'addrevista'){
                        $("#formulario2").validationEngine('attach',{ scroll: false });
                        var valid = $("#formulario2").validationEngine('validate', { scroll: false });
                    }
                    else if(action == 'editrevistaarticulo'){
                        $("#formulario3").validationEngine('attach',{ scroll: false });
                        var valid = $("#formulario3").validationEngine('validate', { scroll: false });
                    }

                    if (valid){
                        $('.bootstrap-timepicker-widget').css({"display": "none"});
                        bloqueointerface();
                        $('.controls input').each(function(){
                            if ($(this).attr('type')=='text'){
                                $(this).val($(this).val().trim());
                            }
                            if ($(this).attr('type')!='file'){
                                if ($(this).css('text-transform')=='uppercase'){
                                    if ($(this).attr('type')!='password'){
                                        $(this).val($(this).val().toUpperCase());
                                    }
                                }
                            }
                        });

                        if(action == 'addrevista')
                            var formdata = new FormData($("#formulario2")[0]);
                        else if(action == 'editrevistaarticulo')
                            var formdata = new FormData($("#formulario3")[0]);

                        formdata.append("lista_items1", JSON.stringify(lista_items1));

                        $.ajax({
                            type: "POST",
                            action : action,
                            url: url,
                            data:  formdata,
                            success: function(data) {
                                if (data.result == 'ok') {
                                    if(action == 'addrevista'){
                                        tiporegistro=parseInt($("#tiporegistro").val());
                                        cargarrevistas(data.id, tiporegistro);
                                        $("#itemspanelagregarrevista").modal("hide");
                                        $.unblockUI();
                                    }
                                    else if(action == 'editrevistaarticulo'){
                                        idr = data.idrevista;
                                        $("#id_revista2").val(idr).trigger('change');
                                        $("#itemspaneleditarrevista").modal("hide");
                                        $.unblockUI();
                                    }
                                } else {
                                    $.unblockUI();
                                    smoke.alert(data.mensaje);
                                }
                            },
                            error: function() {
                                $.unblockUI();
                                smoke.alert("Error al enviar los datos.");
                            },
                            dataType: "json",
                            cache: false,
                            contentType: false,
                            processData: false
                        });
                    } else {
                        setTimeout(function() {
                            $('.help-text').html("");
                        }, 8000);
                        $.unblockUI();
                    }
                };

                cargarrevistas = function(nuevoid, tiporegistro){
                    $('#id_revista2').empty();
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/api",
                        data: {'a': 'revistas', 'tiporegistro': tiporegistro},
                        success: function (data) {
                            $.unblockUI();
                            if (data.result == 'ok') {
                                $('#id_revista2').append('<option value="0">---------</option>');
                                for (elemento in data.lista) {
                                    marcado='';
                                    if(data.lista[elemento][0] == nuevoid){
                                        marcado = 'selected';
                                    }
                                    $('#id_revista2').append('<option '+marcado+' value="' + data.lista[elemento][0] + '">' + data.lista[elemento][1] + '</option>');
                                }
                                $('#id_revista2').trigger("change");
                            } else {
                                smoke.alert(data.mensaje);
                            }
                        },
                        error: function () {
                            $.unblockUI();
                            smoke.alert("Error de conexion.");
                        },
                        dataType: "json"
                    });
                }

                $("#go_link").hide();


                $("#id_revista2").trigger('change');
                $("#id_estadopublicacion").trigger('change');

                if($('#id_provieneproyecto').attr('checked')){
                    $("#id_tipoproyecto").addClass("validate[required]");
                    $("#fieldset_tipoproyecto, #fieldset_proyectointerno").show();
                    if($("#id_tipoproyecto").val() != "3"){
                        $("#fieldset_proyectointerno").show();
                        $("#fieldset_proyectoexterno").hide();
                        $("#id_proyectointerno").addClass("validate[required]");
                        $("#id_proyectoexterno").removeClass("validate[required]");
                    }else{
                        $("#fieldset_proyectointerno").hide();
                        $("#fieldset_proyectoexterno").show();
                        $("#id_proyectoexterno").addClass("validate[required]");
                        $("#id_proyectointerno").removeClass("validate[required]");
                    }
                }else{
                    $("#fieldset_tipoproyecto, #fieldset_proyectointerno, #fieldset_proyectoexterno").hide();
                    $("#id_tipoproyecto").attr('disabled', true);
                    $("#id_proyectointerno").attr('disabled', true);
                    $("#id_proyectoexterno").attr('disabled', true);
                    //$("#id_tipoproyecto").val(0).trigger('change');
                    //$("#id_tipoproyecto").removeClass("validate[required]");
                   // $("#id_proyectointerno").removeClass("validate[required]");
                    //$("#id_proyectoexterno").removeClass("validate[required]");
                }

                cargarevistacongreso = function (tiporegistro){
                    $('#id_revista2').empty().append('<option value="">---------</option>').val(0).trigger("change");
                    var control = $(this);
                    var id = parseInt('{{ congresoid }}');
                    if (id > 0) {
                        bloqueointerface();
                        $.ajax({
                            type: "POST",
                            url: "/api",
                            data: {'a': 'revistas', 'tiporegistro': tiporegistro},
                            success: function (data) {
                                $.unblockUI();
                                if (data.result == 'ok') {
                                    for (elemento in data.lista) {
                                        marcado='';
                                        if(data.lista[elemento][0] == id){
                                            marcado = 'selected';
                                        }
                                        $('#id_revista2').append('<option '+marcado+' value="' + data.lista[elemento][0] + '">' + data.lista[elemento][1] + '</option>');
                                    }
                                    $('#id_revista2').trigger("change");
                                } else {
                                    control.val(0).trigger("change");
                                    smoke.alert(data.mensaje);
                                }
                            },
                            error: function () {
                                $.unblockUI();
                                control.val(0).trigger("change");
                                smoke.alert("Error de conexion.");
                            },
                            dataType: "json"
                        });
                    }
                };


                if(tiposolicitud == 1){
                    $("#separator2title_revista").html("Datos de la Revista");
                    $("label[for='id_revista2']").text("Revista");
                    $("label[for='id_revista']").text("Revista Solicitud");
                    $("label[for='id_numero']").text("Número de la Revista");
                    $("label[for='id_volumen']").text("Volumen de Revista");
                    $("label[for='id_paginas']").text("Páginas del artículo en la Revista");
                    $("label[for='id_codigoissn']").text("Código ISSN");
                    $(".paneltitlerevista").text("Agregar Revista");


                    if($("#id_revista").val()!='')
                        $("#fieldset_revista").show();
                    else
                        $("#fieldset_revista").hide();

                    $("#tiporegistro").val("1");
                    //cargarevistacongreso(1);
                }else{

                    $("#separator2title_revista").html("Datos del Congreso");
                    $("label[for='id_revista2']").text("Congreso");
                    $("label[for='id_revista']").text("Congreso Solicitud");
                    $("label[for='id_numero']").text("Edición del Congreso");
                    $("label[for='id_volumen']").text("Volumen de Memoria");
                    $("label[for='id_paginas']").text("Páginas del artículo en la Memoria");
                    $("label[for='id_codigoissn']").text("Código ISBN");
                    $(".paneltitlerevista").text("Agregar Congreso");

                    if($("#id_revista").val()!='')
                        $("#fieldset_revista").show();
                    else
                        $("#fieldset_revista").hide();

                    {#$("#fieldset_revista").hide();#}
                    $("#tiporegistro").val("2");

                    //cargarevistacongreso(2);
                }

                determinarcategoria = function (){
                    revistaindexada = $("#id_revistaindexada").prop("checked");
                    cuartil = $("#id_cuartilarticulo").val();
                    idcategoriabase = $("#categoriabaseid").val();
                    categoriaconfirmada = $("#id_categoriaconfirmada").val();
                    categoriaarticulo = "";
                    idcategoriaarticulo = "0";


                    if(tiposolicitud == 1) {
                        if(categoriaconfirmada == '1') {
                            if (!revistaindexada && cuartil == '') {
                                categoriaarticulo = "DIVULGATIVO";
                                idcategoriaarticulo = "4";
                            } else if (revistaindexada && cuartil == '') {
                                if ($("#basescielo").val() == 'S') {
                                    categoriaarticulo = "CIENTÍFICO NIVEL II";
                                    idcategoriaarticulo = "2";
                                } else {
                                    categoriaarticulo = "REGIONAL";
                                    idcategoriaarticulo = "3";
                                }
                            } else if (revistaindexada && (cuartil == '3' || cuartil == '4')) {
                                categoriaarticulo = "CIENTÍFICO NIVEL II";
                                idcategoriaarticulo = "2";
                            } else if (revistaindexada && (cuartil == '1' || cuartil == '2')) {
                                categoriaarticulo = "CIENTÍFICO NIVEL I";
                                idcategoriaarticulo = "1";
                            } else if (revistaindexada && cuartil == '5') {
                                categoriaarticulo = "CIENTÍFICO NIVEL II";
                                idcategoriaarticulo = "2";
                            } else if (revistaindexada && cuartil == '6') {
                                categoriaarticulo = "CIENTÍFICO NIVEL I";
                                idcategoriaarticulo = "1";
                            } else if (revistaindexada && cuartil == '7') {
                                categoriaarticulo = "REGIONAL";
                                idcategoriaarticulo = "3";
                            } else {
                                categoriaarticulo = "";
                                idcategoriaarticulo = "0";
                            }
                        }else{
                            categoriaarticulo = "EN REVISIÓN";
                            idcategoriaarticulo = "";
                        }
                    }else{
                        categoriaarticulo = "PROCEEDING";
                        idcategoriaarticulo = "5";
                    }

                    $("#fieldset_observacion").hide();
                    $("#id_observacion").removeClass("validate[required]");

                    if(idcategoriaarticulo != "0" && idcategoriaarticulo != ""){
                        if(idcategoriaarticulo == idcategoriabase){
                            $("#alertamensaje").removeClass('alert alert-error').addClass('alert alert-success');
                            mensajecategoria = "El Artículo y la base indexada tienen categorías iguales";
                        }
                        else{
                            $("#alertamensaje").removeClass('alert alert-success').addClass('alert alert-error');
                            mensajecategoria = "El Artículo y la base indexada tienen categorías diferentes";
                            $("#fieldset_observacion").show();
                            $("#id_observacion").val("");
                            $("#id_observacion").addClass("validate[required]");
                        }
                    }
                    else{
                        $("#alertamensaje").removeClass('alert alert-error').removeClass('alert alert-success').addClass('alert alert-warning');
                        mensajecategoria = "El Artículo no tiene asignado categoría";
                    }

                    $("#mensaje").html(mensajecategoria);

                    $("#id_categoriaarticulo").val(categoriaarticulo);
                    $("#categoriaarticuloid").val(idcategoriaarticulo);

                };

                determinarcategoria();

                $("#id_revistaindexada").click(function () {
                    determinarcategoria();
                });

                $('#id_cuartilarticulo').change(function(){
                    determinarcategoria();
                });

                $('#id_estadosolicitud').change(function(){
                    var valor = $(this).val();
                    $("#id_observacionsolicitud").val("");
                    $("#id_observacionsolicitud").prop("disabled", true);
                    $("#id_observacionsolicitud").removeClass("validate[required]");
                    $("#id_observacion").val("");
                    $("#id_observacion").addClass("validate[required]");
                    $("#id_revista2").addClass("validate[required]");
                    // 58 NOVEDADES, 59 RECHAZADO
                    if(valor == '58' || valor == '59'){
                        $("#id_observacionsolicitud").prop("disabled", false);
                        $("#id_observacionsolicitud").addClass("validate[required]");
                        $("#id_observacion").removeClass("validate[required]");
                        $("#id_revista2").removeClass("validate[required]");
                    }
                });

                $("#id_pertenecegrupoinv").change(function () {
                    $("#id_grupoinvestigacion").val('').trigger('change');
                    if ($(this).is(':checked')) {
                        $("#id_grupoinvestigacion").addClass("validate[required]");
                        $("#fieldset_grupoinvestigacion").show();
                    } else {
                        $("#id_grupoinvestigacion").removeClass("validate[required]");
                        $("#fieldset_grupoinvestigacion").hide();
                    }
                });

                if($('#id_pertenecegrupoinv').attr('checked')){
                    $("#id_grupoinvestigacion").addClass("validate[required]");
                    $("#fieldset_grupoinvestigacion").show();
                }else{
                    $("#id_grupoinvestigacion").removeClass("validate[required]");
                    $("#fieldset_grupoinvestigacion").hide();
                }

                $('#id_estadosolicitud').val("0").trigger('change');

                $('#id_categoriaconfirmada').change(function(){
                    determinarcategoria();
                });

                if(tiposolicitud != 1)
                    $("#id_categoriaconfirmada").attr("disabled", "disabled");


                {# oculta boton Guardar hasta mientras #}
                {#$("#formbutton").css('display','none');#}

            });
        });
    </script>
{% endblock %}
{% block titulo %}{{ title }}{% endblock %}
{% block atras %}/adm_produccioncientifica?action=solicitudarticulo{% endblock %}
{% block formaction %}/articulosinvestigacion{% endblock %}
{% block formdestinationswal %}/adm_produccioncientifica{% endblock %}
{% block formextra %}
    <input type='hidden' name='action' value='ingresarsolicitudarticulo'/>
    <input type='hidden' name='categoriaarticuloid' id='categoriaarticuloid' value=''/>
    <input type='hidden' name='categoriabaseid' id='categoriabaseid' value=''/>
    <input type='hidden' name='basescielo' id='basescielo' value='N'/>
    <input type='hidden' name='ids' value='{{ idsolicitud|encrypt }}'/>
{% endblock %}
{% block formback %}/adm_produccioncientifica?action=solicitudarticulo{% endblock %}
{% block buttonname %}Guardar{% endblock %}
{% block pre_form %}
    <div class="modal fade static" id="itemspanelagregarrevista" style="display: none;">
        <div class="modal-header">
            <table border="0" width="100%" style="background-color: transparent;">
                <tr>
                    <td style="width: 80%"><h3 class="paneltitlerevista">Agregar Revista</h3></td>
                </tr>
            </table>
        </div>
        <form id="formulario2" style="width: 100%; margin-bottom: 0px;padding-left: 15px;padding-top: 10px; padding-right: 15px; padding-bottom: 0px">
            <input type='hidden' name='action' value='addrevista'/>
            <input type='hidden' name='tiporegistro' id='tiporegistro' value=''/>
            <input type='hidden' name='registromodal' id='registromodal' value='S'/>
            <input type='hidden' name='revistaborradorid' id='revistaborradorid' value='{{ revistaborradorid }}'/>
            <div class="row-fluid">
                {% for field in form2 %}
                    {% if field.field.widget.attrs.separator %}
                        <div style="width: 100%; height: 1px; float: left;"></div>
                    {% endif %}
                    <fieldset id="fieldset_{{ field.name }}" class="control-group nomargins" style="float: left; width: {% if field.field.widget.attrs.formwidth %}{{ field.field.widget.attrs.formwidth }}{% else %}100%{% endif %}">
                        <label class="control-label" for="id_{{ field.name }}">{{ field.label }}</label>
                        <div class="controls">
                            {{ field }}
                            <div class="help-text">{{ field.help_text }} </div>
                        </div>
                    </fieldset>
                {% endfor %}
            </div>

            <div class="row-fluid" id="documentosindexacion">
                <table class="table table-bordered table-striped table-condensed table-hover table-even-widths" id="tbdocumentos">
                    <thead>
                    <tr>
                        <th colspan="15">
                            Documentos Indexación
                        </th>
                    </tr>
                    <tr>
                        <th>Base Indexada</th>
                        <th style="width: 100px; text-align: center">Documento Indexación</th>
                    </tr>
                    </thead>
                    <tbody id="detalle_documentos">

                    </tbody>
                </table>
            </div>

        </form>
        <div class="modal-footer">
            <td id="aprobarcerrar"><a href="javascript:;" class="btn btn-success guardarrevista"> Guardar</a></td>
            <a href="javascript:;" class="btn btn-danger cerrarrevista">Cerrar</a>
        </div>
    </div>
    <div class="modal fade static" id="itemspaneleditarrevista" style="display: none;">
        <div class="modal-header">
            <table border="0" width="100%" style="background-color: transparent;">
                <tr>
                    <td style="width: 80%"><h3 class="paneltitleeditrevista">Editar Revista</h3></td>
                </tr>
            </table>
        </div>
        <form id="formulario3" style="width: 100%; margin-bottom: 0px;padding-left: 15px;padding-top: 10px; padding-right: 15px; padding-bottom: 0px">
            <input type='hidden' name='action' value='editrevistaarticulo'/>
            <input type='hidden' id="idrev" name='idrev' value=''/>
            <div class="row-fluid panelbodyeditarrevista">
            </div>
        </form>
        <div class="modal-footer">
            <td id="aprobarcerrar2"><a href="javascript:;" class="btn btn-success actualizarrevista"> Actualizar</a></td>
            <a href="javascript:;" class="btn btn-danger cerrareditrevista">Cerrar</a>
        </div>
    </div>
{% endblock %}
{% block formsuffix %}
    <div class="alert alert-error" id="alertamensaje">
        <strong><span id="mensaje">El artículo no tiene asignado categoría</span></strong>
    </div>

    <div class="row-fluid">
        <table class="table table-bordered table-striped table-condensed table-hover table-even-widths" id="tbevidencias">
            <thead>
            <tr>
                <th colspan="3">Evidencias</th>
            </tr>
            <tr>
                <th style="width: 3%; text-align: center;">#</th>
                <th style="width: 82%; text-align: center;">Tipo de Evidencia</th>
                <th style="width: 15%; text-align: center;">Archivo</th>
            </tr>
            </thead>
            <tbody id="detalle_evidencias">
                {% if evidencias %}
                    {% for evidencia in evidencias %}
                        <tr>
                            <td style="text-align: center">{{ forloop.counter }}</td>
                            <td style="text-align: justify">{{ evidencia.descripcion|upper }}</td>
                            <td style="text-align: center"><a target="_blank" href="{{ evidencia.archivo.url }}" class="btn btn-info tu" data-toggle="tooltip" data-placement="top" data-original-title="Descargar Archivo"><i class="fa fa-download"></i> Descargar</a></td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="3">NO EXISTEN EVIDENCIAS SUBIDAS</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div class="row-fluid">
        <table class="table table-bordered table-striped table-condensed table-hover table-even-widths" id="tbparticipantes">
            <thead>
            <tr>
                <th colspan="4">Participantes</th>
            </tr>
            <tr>
                <th style="width: 3%; text-align: center;">#</th>
                <th style="width: 57%; text-align: center;">Participante</th>
                <th style="width: 20%; text-align: center;">Tipo</th>
                <th style="width: 20%; text-align: center;">Filiación</th>
            </tr>
            </thead>
            <tbody id="detalle_participantes">
                {% if participantes %}
                    {% for participante in participantes %}
                        <tr>
                            <td style="text-align: center">{{ forloop.counter }}</td>
                            <td style="text-align: justify">{{ participante.nombres }}</td>
                            <td style="text-align: center">{{ participante.tipo }}</td>
                            <td style="text-align: center">{{ participante.filiacion }}</td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="4">NO EXISTEN DETALLES DE PARTICIPANTES</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>


    <div class="row-fluid">
        <div id="separator2_verificacion" style="width: 100%; height: max-content; display: inline-block">
            <h6 style="width:100%; text-align:left; border-bottom: 1px solid #98a3ab; line-height:0.1em; margin:10px 0 20px;"><span id="separator2title_verificacion" style="padding:0 10px; background: #f5f5f5;">Verificación de la Solicitud</span></h6>
        </div>


        <fieldset id="fieldset_estadosolicitud" class="control-group nomargins" style="min-height:45px; float: left; width: 100%" >
            <div class="control-label label-text"  style="display: table;height: 30px;">
                <div style="display: table-cell; vertical-align: middle; line-height: 11px">
                    <label for="id_estadosolicitud" style="padding-right: 20px">Estado de Solicitud</label>
                </div>
            </div>
            <div class="control" style="float: left; width: 0">
                <select class="imp-50" formwidth="100%" id="id_estadosolicitud" name="estadosolicitud">
                    <option value="">-----</option>
                    {% for estado in estadossolicitud %}
                        <option value="{{ estado.id }}">{{ estado.descripcion }}</option>
                    {% endfor %}
                </select>
                <p class="help-text" style="font-size: xx-small; margin-bottom: 0; height: 13px; line-height: 13px"> </p>
            </div>
        </fieldset>

        <fieldset id="fieldset_observacionsolicitud" class="control-group nomargins" style="min-height:45px; float: left; width: 100%" >
            <div class="control-label label-text"  style="display: table;height: 30px;">
                <div style="display: table-cell; vertical-align: middle; line-height: 11px">
                    <label for="observacionsolicitud" style="padding-right: 20px">Observación</label>
                </div>
            </div>
            <div class="control" style="float: left; width: 0">
                <textarea cols="40" id="id_observacionsolicitud" name="observacionsolicitud" rows="5"></textarea>
                <p class="help-text" style="font-size: xx-small; margin-bottom: 0; height: 13px; line-height: 13px"> </p>
            </div>
        </fieldset>
    </div>

    <div class="row-fluid">
        <div class="alert alert-info" id="alertamensajeestado">
            <strong><span id="mensajeestado" style="text-align: justify">
                En caso de que el estado de la solicitud sea <span class="label label-warning">NOVEDADES</span>  o <span class="label label-important">RECHAZADO</span> , no se creará el registro del artículo; sin embargo el solicitante será notificado
                de las novedades presentadas en le revisión de la solicitud.
            </span></strong>
        </div>
    </div>
{% endblock %}