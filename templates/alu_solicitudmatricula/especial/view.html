{% extends "basebs.html" %}
{% load sga_extras %}
{% block heading %}
    <script type="text/javascript" src='/static/js/jquery.validationEngine.js?v=1.0.0'></script>
    <script type="text/javascript" src='/static/js/jquery.validationEngine-es.js?v=1.0.0' ></script>
    <link type='text/css' rel='stylesheet' href="/static/css/validationEngine.jquery.css?v=1.0.0"/>
    <script type="text/javascript" src="/static/js/bootstrap-filestyle.min.js?v=1.0.1"> </script>
    <link rel="stylesheet" href="/static/dropify/css/dropify.min.css">
    <script type="text/javascript" src='/static/dropify/js/dropify.min.js?v=1.0.0'></script>
    <script type="text/javascript" src='/static/js/select2.js?v=1.0.0' ></script>
    <link type='text/css' rel='stylesheet' href="/static/css/select2.css?v=1.0.0"/>
    <link href="/static/css/table-responsive.css?1.0.0" type="text/css" rel="stylesheet" />
    <script src="/static/js/moment/moment.min.js" type="text/javascript"></script>
    <script src="/static/js/moment/moment-with-locales.min.js" type="text/javascript"></script>
    <script src="/static/js/moment/moment-timezone.min.js" type="text/javascript"></script>
    <link href='/static/boxicons-2.0.9/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="/static/eventostyle.css">
    <!--<link rel="stylesheet" href="/static/eventoframework.css">-->
    <style>

        .result-list {
            list-style-type: none;
            margin: 0;
            padding: 0;
            width: 100%
        }

        .result-list:after, .result-list:before {
            content: '';
            display: table;
            clear: both
        }

        .result-list > li {
            border: 1px solid #ddd;
            background: #fff;
            overflow: hidden;
            position: relative;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-flex-wrap: wrap;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
        }

        .result-list > li:after, .result-list > li:before {
            content: '';
            display: table;
            clear: both
        }

        .result-list > li + li {
            margin-top: 10px
        }

        .result-list > li .result-image {
            width: 240px;
            padding: 0;
            overflow: hidden;
            background: #2d353c;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat
        }


        .result-list > li .result-image a {
            display: block
        }

        .result-list > li .result-image img {
            width: 100%
        }

        .result-list > li .result-image:focus, .result-list > li .result-image:hover {
            opacity: .8
        }

        .result-list > li .result-evento {
            padding: 20px;
            position: relative;
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1
        }

        .result-list > li .result-evento .title {
            margin: 0 0 5px;
            font-size: 18px;
            line-height: 22px
        }


        .result-list > li .result-evento .title a {
            color: #2d353c
        }

        .result-list > li .result-evento .location {
            color: #6f8293;
        }

        .result-list > li .result-evento .decs {
            margin-bottom: 20px;
            max-height: 32px;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 16px
        }

        .result-list > li .result-evento .btn-row {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-flex-wrap: wrap;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap
        }

        .result-list > li .result-evento .btn-row:after, .result-list > li .result-evento .btn-row:before {
            content: '';
            display: table;
            clear: both
        }

        .result-list > li .result-evento .btn-row a {
            color: #2d353c;
            background: #f2f3f4;
            font-size: 14px;
            line-height: 18px;
            padding: 8px 10px;
            -webkit-border-radius: 4px;
            border-radius: 4px
        }

        .result-list > li .result-evento .btn-row a + a {
            margin-left: 5px
        }

        .result-list > li .result-evento .btn-row a:focus, .result-list > li .result-evento .btn-row a:hover {
            background: #d5dbe0
        }

        .result-list > li .result-price {
            width: 240px;
            font-size: 28px;
            text-align: center;
            background: #f2f3f4;
            color: #2d353c;
            padding: 20px;
            position: relative;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -ms-flex-direction: column;
            flex-direction: column;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
            justify-content: center;
            -ms-flex-align: center;
            align-items: center
        }


        .result-list > li .result-price small {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: #6f8293
        }

        .result-list > li .result-price .btn {
            margin-top: 30px
        }

        .row > [class^=col-].ui-sortable {
            min-height: 50px
        }

        @-webkit-keyframes rotation {
            from {
                -webkit-transform: rotate(0);
                -moz-transform: rotate(0);
                -ms-transform: rotate(0);
                -o-transform: rotate(0);
                transform: rotate(0)
            }
            to {
                -webkit-transform: rotate(359deg);
                -moz-transform: rotate(359deg);
                -ms-transform: rotate(359deg);
                -o-transform: rotate(359deg);
                transform: rotate(359deg)
            }
        }

        @-moz-keyframes rotation {
            from {
                -webkit-transform: rotate(0);
                -moz-transform: rotate(0);
                -ms-transform: rotate(0);
                -o-transform: rotate(0);
                transform: rotate(0)
            }
            to {
                -webkit-transform: rotate(359deg);
                -moz-transform: rotate(359deg);
                -ms-transform: rotate(359deg);
                -o-transform: rotate(359deg);
                transform: rotate(359deg)
            }
        }

        @-o-keyframes rotation {
            from {
                -webkit-transform: rotate(0);
                -moz-transform: rotate(0);
                -ms-transform: rotate(0);
                -o-transform: rotate(0);
                transform: rotate(0)
            }
            to {
                -webkit-transform: rotate(359deg);
                -moz-transform: rotate(359deg);
                -ms-transform: rotate(359deg);
                -o-transform: rotate(359deg);
                transform: rotate(359deg)
            }
        }

        @keyframes rotation {
            from {
                -webkit-transform: rotate(0);
                -moz-transform: rotate(0);
                -ms-transform: rotate(0);
                -o-transform: rotate(0);
                transform: rotate(0)
            }
            to {
                -webkit-transform: rotate(359deg);
                -moz-transform: rotate(359deg);
                -ms-transform: rotate(359deg);
                -o-transform: rotate(359deg);
                transform: rotate(359deg)
            }
        }

        .single_faq {
            margin-bottom: 15px;
            padding: 15px;
        }

        .faq_question::before {
            font-size: 20px;
            line-height: 35px;
        }

        .faq_question {
            padding: 8px 10px 8px 26px;
        }

        .faq_answer {
            margin-top: 0;
        }
    </style>
    <script type="text/javascript">
        /*$(document).ready(function () {



        });*/
    </script>
{% endblock %}
{% block atras %}/alu_solicitudmatricula{% endblock %}
{% block canvas %}
    <div class="row-fluid">
        <div class="span12">
            <h3>{{ title }}</h3>
        </div>
    </div>
    <div class="row-fluid">
        <div class="span12">
            <div class='span8'>
                <div class="media">
                    <a class="pull-left hidden-phone" href="javascript:;">
                        {% if persona.foto %}
                            <img src="{{ persona.foto.foto.url }}" onerror="this.onerror=null;this.src='/static/images/image.png'" class="media-object img-circle" width="140" height="140">
                        {% else %}
                            <img src="/static/images/iconos/{% if persona.sexo.id == 2 %}hombre.png{% else %}mujer.png{% endif %}" onerror="this.onerror=null;this.src='/static/images/image.png'" class="media-object img-circle" width="140" height="140">
                        {% endif %}
                    </a>
                    <div class="media-body" style="color: #1C3247  !important; padding-left: 20px;">
                        <h3 class="media-heading">{{ persona }} ({{ inscripcion.id }})</h3>
                        <p><b><i class="fa fa-paper-plane"></i> Documento: </b>{% if persona.cedula %}{{ persona.cedula }}{% else %}{{ persona.pasaporte }}{% endif %} &nbsp;&nbsp; <b><i class="fa fa-envelope"></i> Email Inst.:</b> {{ persona.emailinst }} &nbsp;&nbsp; <b><i class="fa fa-envelope"></i> Email:</b> {{ persona.email }}</p>
                        <p><b><i class="fa fa-map-marker"></i> Ciudad:</b> {{ persona.canton.nombre }} &nbsp;&nbsp; <b><i class="fa fa-map-marker"></i> Dirección:</b> {{ persona.direccion_corta }} &nbsp;&nbsp; <b><i class="fa fa-phone"></i> Telf.:</b> {{ persona.telefono }}</p>
                        <p><b><i class="fa fa-graduation-cap"></i> Carrera:</b> {{ inscripcion.carrera }} &nbsp;&nbsp; <b><i class="fa fa-cubes"></i> Malla:</b> {{ inscripcionmalla.malla }}</p>
                    </div>
                </div>
            </div>

            <div class='span4' style="text-align: justify-all">
                <a href="javascript:;" class='btn btn-success btn-large' v-if="puede_solicitar" style="width: 100% !important;" v-on:click="openSolicitar()"><span class="fa fa-paper-plane-o" ></span> SOLICITAR</a>
                <div class="alert alert-danger" v-if="has_error">
                    <h4 class="alert-heading">AVISO</h4>
                    <p v-html="msg_error"></p>
                </div>
            </div>
        </div>
    </div>
    <div class="row-fluid">
        <div class="span12">
            <div id="no-more-tables" style="margin-top: 5px">
                <table class="table table-bordered table-hover">
                    <thead>
                    <tr>
                        <th style="width: 4%; text-align: center; vertical-align: middle">#</th>
                        <th style="width: 10%; text-align: center; vertical-align: middle">Código</th>
                        <th style="width: 15%; text-align: center; vertical-align: middle">Periodo</th>
                        <th style="width: 20%; text-align: center; vertical-align: middle">Descripción</th>
                        <th style="width: 10%; text-align: center; vertical-align: middle">Motivo</th>
                        <th style="width: 8%; text-align: center; vertical-align: middle">Fecha/Hora</th>
                        <th style="width: 8%; text-align: center; vertical-align: middle">Archivo</th>
                        <th style="width: 8%; text-align: center; vertical-align: middle">Estado</th>
                        <th style="width: 20%; text-align: center; vertical-align: middle">Acciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-show="solicitudes.length > 0" v-for="solicitud in solicitudes" :key="solicitud.id">
                        <td data-title="#" style="text-align: center; vertical-align: middle">${solicitud.contador}</td>
                        <td data-title="Código" style="text-align: center; vertical-align: middle">${solicitud.codigo}</td>
                        <td data-title="Periodo" style="text-align: center; vertical-align: middle">${solicitud.periodo}</td>
                        <td style="text-align: left; vertical-align: middle">${solicitud.descripcion}</td>
                        <td data-title="Motivo" style="text-align: center; vertical-align: middle">${solicitud.motivo}</td>
                        <td data-title="Fecha/Hora" style="text-align: center; vertical-align: middle">${solicitud.fecha} ${solicitud.hora}</td>
                        <td data-title="Archivo" style="text-align: center; vertical-align: middle">
                            <a class="btn btn-success" target="_blank" v-if="solicitud.archivo" v-bind:href="solicitud.archivo" >Descargar</a>
                        </td>
                        <td data-title="Estado" style="text-align: center; vertical-align: middle"><span v-bind:class="`label label-`+solicitud.estado_color">${solicitud.estado}</span></td>
                        <td style="vertical-align: middle; text-align: center">
                            <div>
                                <a class="btn btn-info btn-large" v-on:click="viewSolicitud(solicitud)" href="javascript:;">Ver proceso</a>
                                <a v-if="solicitud.puede_cancelar" class="btn btn-danger btn-large" v-on:click="cancelSolicitud(solicitud)" href="javascript:;">Cancelar</a>
                            </div>
                        </td>
                    </tr>
                    <tr v-show="solicitudes.length == 0">
                        <td colspan="9" style="text-align: center"><b>NO EXISTE SOLICITUDES</b></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="modal fade static" id="modalSolicitar" style="display: none;" data-keyboard="false" data-backdrop="static">
        <div class="modal-header">
            <h4 class="paneltitle">Solicitar matícula especial</h4>
        </div>
        <div class="modal-body panelbody">
            <div class='row-fluid'>
                <div class='span12'>
                    <div v-if="procesos.length > 0">
                        <ul class="nav nav-pills nav-justified thumbnail setup-panel">
                            <li v-for="p in procesos" class="" :key="p.id" v-bind:id="`paso`+p.id" v-bind:class="p.class">
                                <a v-bind:href="`#step-`+p.id" >
                                    <h4 class="list-group-item-heading" v-if="p.tipo_entidad == 1"><i class="fa fa-building-o"></i> ${ p.nombre } (Paso ${ p.orden })</h4>
                                    <h4 class="list-group-item-heading" v-else><i class="fa fa-modx"></i> ${ p.nombre } (Paso ${ p.orden })</h4>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="row-fluid">
                <div class="span12">
                    <form action="javascript:;" id="frmSolicitud" name="frmSolicitud">
                        <div class="row-fluid">
                            <div class="span4">
                                <fieldset id="fieldset_motivo" class="control-group nomargins" style="padding: 5px; min-height:45px; margin-left: 0 !important;" >
                                    <div class="control-label label-text" style="display: table;height: 30px;">
                                        <div style="display: table-cell; vertical-align: middle; line-height: 11px">
                                            <label for="id_motivo" style="padding-right: 20px"><b>Motivo</b></label>
                                        </div>
                                    </div>
                                    <div class="control">
                                        <select name="motivo" id="id_motivo" style="width: 100%">
                                            <option value="0">--------</option>
                                            <option v-if="motivos.length > 0" v-for="motivo in motivos" v-bind:value="motivo.id">${motivo.nombre}</option>
                                        </select>
                                        <p class="help-text" style="font-size: xx-small; margin-bottom: 0; height: 13px; line-height: 13px"></p>
                                        <div v-if="motivo && motivo.detalle" class="alert alert-info" style="font-size: x-small; margin-bottom: 0; height: 100%; line-height: 14px">${motivo.detalle}</div>
                                    </div>
                                </fieldset>
                            </div>
                            <div class="span4">
                                <fieldset id="fieldset_descripcion" class="control-group nomargins" style="padding: 5px; min-height:45px; margin-left: 0 !important;" >
                                    <div class="control-label label-text" style="display: table;height: 30px;">
                                        <div style="display: table-cell; vertical-align: middle; line-height: 11px">
                                            <label for="id_descripcion" style="padding-right: 20px"><b>Descripción</b></label>
                                        </div>
                                    </div>
                                    <div class="control">
                                        <textarea name="descripcion" id="id_descripcion" style="width: 100%; resize:inherit; height: 200px; text-transform: none;"> </textarea>
                                        <p class="help-text" style="font-size: xx-small; margin-bottom: 0; height: 13px; line-height: 13px"></p>
                                    </div>
                                </fieldset>
                            </div>
                            <div class="span4">
                                <fieldset id="fieldset_archivo" class="control-group nomargins" style="padding: 5px; min-height:45px; margin-left: 0 !important;" >
                                    <div class="control-label label-text" style="display: table;height: 30px;">
                                        <div style="display: table-cell; vertical-align: middle; line-height: 11px">
                                            <label for="id_archivo" style="padding-right: 20px"><b>Archivo</b></label>
                                        </div>
                                    </div>
                                    <div class="control">
                                        <input type="file" name="archivo" id="id_archivo">
                                        <p class="help-text" style="font-size: xx-small; margin-bottom: 0; height: 13px; line-height: 13px"></p>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                    </form>
                    <h3>Asignaturas de mi malla</h3>
                    <div id="no-more-tables">
                        <table class="table table-bordered table-striped" cellpadding="0" cellspacing="0">
                            <thead>
                            <tr>
                                <th style="text-align: center; vertical-align: middle; width: 10%">Nivel</th>
                                <th style="text-align: center; vertical-align: middle; width: 15%">Eje formativo</th>
                                <th style="text-align: center; vertical-align: middle; width: 35%">Asignatura</th>
                                <th style="text-align: center; vertical-align: middle; width: 10%">Estado</th>
                                <th style="text-align: center; vertical-align: middle; width: 10%">Créditos</th>
                                <th style="text-align: center; vertical-align: middle; width: 10%">Horas</th>
                                <th style="text-align: center; vertical-align: middle; width: 10%"></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="am in asignaturasmalla" :key="am.id">
                                <td data-title="Nivel" style="text-align: center; vertical-align: middle">${am.nivelmalla}</td>
                                <td data-title="Eje formativo" style="text-align: center; vertical-align: middle">${am.ejeformativo}</td>
                                <td style="text-align: left; vertical-align: middle">
                                    <div>${ am.asignatura }</div>
                                    <div v-if="am.itinerario > 0"><label class="label label-info">${am.itinerario_verbose}</label></div>
                                    <div v-if="am.totalrecordasignatura > 1"><label class="label label-warning">${am.totalrecordasignatura} MAT.</label></div>
                                </td>
                                <td data-title="Estado" style="text-align: center; vertical-align: middle">
                                    <div v-if="am.estado === 1">
                                        <span class="label label-success">APROBADA</span>
                                    </div>
                                    <div v-if="am.estado === 2">
                                        <span class="label label-important">REPROBADA</span>
                                    </div>
                                    <div v-if="am.estado === 3">
                                        <span class="label label-warning">PENDIENTE</span>
                                    </div>
                                    <div v-if="am.estado === 0">
                                        <span class="label label-info">NO APLICA</span>
                                    </div>
                                </td>
                                <td data-title="Créditos" style="text-align: center; vertical-align: middle">${am.creditos}</td>
                                <td data-title="Horas" style="text-align: center; vertical-align: middle">${am.horas}</td>
                                <td style="text-align: center; vertical-align: middle">
                                    <div v-if="am.puede_agregar">
                                        <a class="btn btn-large btn-success" v-bind:id="`btn_aplicar_`+am.id" :key="`aplicar_`+am.id" v-on:click="addAsignatura(am)"><i class='bx bx-check'></i> SELECCIONAR</a>
                                        <a class="btn btn-large btn-danger" style="display: none" v-bind:id="`btn_remover_`+am.id" :key="`remover_`+am.id" v-on:click="removeAsignatura(am)"><i class='bx bxs-no-entry'></i> REMOVER</a>
                                        <!--<a href="javascript:;" class="btn btn-large btn-success">SELECCIONAR</a>-->
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" v-bind:class="`btn btn-large btn-`+proceso.boton_ok_label+` action-ok-`+proceso.accion_ok_verbose"> ${proceso.boton_ok_verbose}</a>
            <a href="javascript:;" v-bind:class="`btn btn-large btn-`+proceso.boton_nok_label+` action-nok-`+proceso.accion_nok_verbose"> ${proceso.boton_nok_verbose}</a>
        </div>
    </div>

    <div class="modal fade static" id="modalViewProceso" style="display: none;" data-keyboard="false" data-backdrop="static">
        <div class="modal-header">
            <h4 class="paneltitle">Ver proceso de Solicitud Matícula Especial (${solicitud.codigo}) </h4>
        </div>
        <div class="modal-body panelbody">
            <div class='row-fluid'>
                <div class='span12'>
                    <div v-if="pasos.length > 0">
                        <ul class="nav nav-pills nav-justified thumbnail setup-panel">
                            <li v-for="paso in pasos" class="" :key="paso.id" v-bind:id="`paso`+paso.id" v-bind:class="paso.class">
                                <a v-bind:href="`#step-`+paso.id" v-on:click="showProcess(paso)" >
                                    <h4 class="list-group-item-heading" v-if="paso.tipo_entidad == 3"><i class="fa fa-user"></i> ${ paso.nombre } (Paso ${ paso.orden })</h4>
                                    <h4 class="list-group-item-heading" v-if="paso.tipo_entidad == 1"><i class="fa fa-building-o"></i> ${ paso.nombre } (Paso ${ paso.orden })</h4>
                                    <h4 class="list-group-item-heading" v-if="paso.tipo_entidad == 2"><i class="fa fa-modx"></i> ${ paso.nombre } (Paso ${ paso.orden })</h4>
                                    <p v-if="paso.tipo_entidad == 1"><span v-for="responsable in paso.responsables">${responsable.departamento}</span></p>
                                    <p v-if="paso.tipo_entidad == 2"><span v-for="responsable in paso.responsables">${responsable.coordinacion}</span></p>
                                    <p v-if="paso.tipo_entidad == 3">Estudiante</p>
                                    <!--<p class="list-group-item-text">
                                        <i class="fa fa-calendar"></i> ${paso.fecha}-${paso.hora}
                                    </p>-->
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="setup-content" v-for="paso in pasos" :key="paso.id" v-bind:id="`step-`+paso.id" v-bind:class="paso.active ? `show`:`hidden`">
                <div class='row-fluid'>
                    <div class="span12">
                        <div id="no-more-tables">
                            <table class="table table-bordered table-hover">
                                <thead>
                                <tr>
                                    <th style="text-align: center; vertical-align: middle; width: 10%">${paso.tipo_entidad == 1 ? 'Departamento' : 'Coodinación'}</th>
                                    <th style="text-align: center; vertical-align: middle; width: 20%">Responsable</th>
                                    <th style="text-align: center; vertical-align: middle; width: 5%">Fecha</th>
                                    <th style="text-align: center; vertical-align: middle; width: 5%">Hora</th>
                                    <th style="text-align: center; vertical-align: middle; width: 35%">Observación</th>
                                    <th style="text-align: center; vertical-align: middle; width: 8%">Archivo</th>
                                    <th style="text-align: center; vertical-align: middle; width: 8%">Estado</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr v-if="paso.historial.length > 0" v-for="historial in paso.historial" :key="historial.id">
                                    <td style="text-align: left; vertical-align: middle;">${paso.tipo_entidad == 1 ? historial.departamento : historial.coordinacion}</td>
                                    <td style="text-align: center; vertical-align: middle;">${historial.responsable}</td>
                                    <td style="text-align: center; vertical-align: middle;">${historial.fecha}</td>
                                    <td style="text-align: center; vertical-align: middle;">${historial.hora}</td>
                                    <td style="text-align: left; vertical-align: middle;">${historial.observacion}</td>
                                    <td style="text-align: center; vertical-align: middle;">
                                        <a class="btn btn-success" target="_blank" v-if="historial.archivo" v-bind:href="historial.archivo" >Descargar</a>
                                    </td>
                                    <td style="text-align: center; vertical-align: middle;">
                                        <span v-bind:class="`label label-`+historial.estado_color">${historial.estado}</span>
                                    </td>
                                </tr>
                                <tr v-else>
                                    <td colspan="6"><b>NO EXISTE REGISTRO EN EL PROCESO</b></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="row-fluid">
                        <table style="width: 100%">
                            <tr>
                                <td style="text-align: left; width: 50%"><a class="btn btn-primary btn-large" v-if="!paso.inicio" v-on:click="showProcess(paso.atras)">Atras</a></td>
                                <td style="text-align: right; width: 50%"><a class="btn btn-primary btn-large" v-if="!paso.fin" v-on:click="showProcess(paso.siguiente)">Siguiente</a></td>
                            </tr>
                        </table>
                        <!--<div style="text-align: right; float: left; width: 100%">
                            <a class="btn btn-primary btn-large" v-if="!paso.inicio" v-on:click="showProcess(paso.atras)">Atras</a>
                            <a class="btn btn-primary btn-large" v-if="!paso.fin" v-on:click="showProcess(paso.siguiente)">Siguiente</a>
                        </div>-->
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn btn-inverse btn-large action-close"> Cerrar</a>
        </div>
    </div>
{% endblock %}
{% block extraJs %}
    <script src="/static/js/vue.js"></script>
    <script type="text/javascript">

        const loadAjax = (data, url, pData/*=true*/) => new Promise((resolve, reject) => {
            if (pData == true){
                $.ajax({
                    type: "POST",
                    url: url,
                    data: data,
                    success: function(response) {
                        resolve({
                            error: false,
                            value: response
                        });
                    },
                    error: function() {
                        reject({
                            error: true,
                            message: "Error al enviar los datos."
                        });
                    },
                    dataType: "json"
                });

            }
            else{
                $.ajax({
                    type: "POST",
                    url: url,
                    data: data,
                    processData: false,
                    cache: false,
                    contentType: false,
                    success: function(response) {
                        resolve({
                            error: false,
                            value: response
                        });
                    },
                    error: function() {
                        reject({
                            error: true,
                            message: "Error al enviar los datos."
                        });
                    },
                    dataType: "json"
                });

            }

        });
        var app = new Vue({
            delimiters: ['${', '}'],
            el: '#app',
            data: {
                motivos: [],
                motivo: {},
                solicitudes: [],
                procesos: [],
                proceso: {},
                solicitud: {},
                pasos: [],
                periodomatricula: {},
                asignaturasmalla: [],
                asignaturas: [],
                puede_solicitar: false,
                has_error: false,
                msg_error: "",
            },
            /*components:{
                loader: loader
            },*/
            created(){
                var self = this;

            },
            mounted: function (){
                var self = this;
                moment.tz.add('America/Guayaquil|QMT -05 -04|5e 50 40|0121|-1yVSK 2uILK rz0|27e5');
                self.loadInitial();
                self.$modalSolicitar = $("#modalSolicitar");
                self.$modalViewProceso = $("#modalViewProceso");
                $('.action-nok-'+self.proceso.accion_nok_verbose, self.$modalSolicitar).click(function(){

                    Swal.fire({
                        title: `NOTIFICACIÓN`,
                        text: "Esta seguro de cancelar la solicitud de matrícula especial",
                        type: 'info',
                        icon: 'info',
                        showCancelButton: true,
                        allowOutsideClick: false,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Aceptar',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.value) {
                            self.closeSolicitar();
                        }else{
                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                type: 'info',
                                title: "Puede seguir editando su solicitud",
                                showConfirmButton: false,
                                timer: 6000
                            });
                        }
                    }).catch(error => {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            type: 'error',
                            title: error.mensaje,
                            showConfirmButton: false,
                            timer: 6000
                        });
                    });
                });
                $('.action-ok-'+self.proceso.accion_ok_verbose, self.$modalSolicitar).click(function(){
                    Swal.fire({
                        title: `NOTIFICACIÓN`,
                        text: "Esta seguro de enviar la solicitud de matrícula especial",
                        type: 'info',
                        icon: 'info',
                        showCancelButton: true,
                        allowOutsideClick: false,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Aceptar',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.value) {
                            self.sendSolicitud();
                        }else{
                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                type: 'info',
                                title: "Puede seguir editando su solicitud",
                                showConfirmButton: false,
                                timer: 6000
                            });
                        }
                    }).catch(error => {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            type: 'error',
                            title: error.mensaje,
                            showConfirmButton: false,
                            timer: 6000
                        });
                    });
                });
                $('[name="motivo"]', self.$modalSolicitar).select2({minimumResultsForSearch: 20, width: '100%', dropdownParent: self.$modalSolicitar});
                $('[name="motivo"]', self.$modalSolicitar).change(function (){
                    let id = $(this).val();
                    self.changeMotivo(id);
                });
                $('[name="archivo"]', self.$modalSolicitar).dropify({
                    messages: {
                        default: 'Arrastre y suelte el archivo o haga clic aquí.',
                        replace: 'Arrastre y suelte el archivo o haga clic aquí.',
                        remove: 'Eliminar',
                        error: 'Ocurrió un error!'
                    },
                    error: {
                        fileSize: "El tamaño del archivo debe ser máximo (10MB).",
                        fileExtension: "Sólo puede subir los archivos con las extensiones .pdf"
                    },
                });

                $('.action-close', self.$modalViewProceso).click(function(){
                    self.closeSolicitud();

                });


            },
            methods: {
                loading: function () {
                    if (!$(".blockUI").length) {
                        $.blockUI({message: $('#throbber'),
                            css: {
                                'border': '1px solid',
                                'border-radius': '10px',
                                'left': '46%',
                                'width': '140px',
                                'height': '140px',
                                'padding': '15px',
                                '-webkit-border-radius': '10px',
                                '-moz-border-radius': '10px',
                                opacity: .6,
                                color: '#000'
                            }
                        });
                    }
                },
                loadInitial: function () {
                    var self = this;
                    self.loading();
                    loadAjax({
                        'action': 'loadInitialData'
                    }, '/alu_solicitudmatricula/especial', true)
                        .then(response => {
                            if (response.value.result == 'ok') {
                                self.periodomatricula = response.value.aPeriodoMatricula;
                                self.motivos = response.value.aMotivos;
                                self.solicitudes = response.value.aSolicitudes;
                                self.procesos = response.value.aProcesos;
                                self.proceso = response.value.aProceso;
                                self.asignaturasmalla = response.value.aData;
                                self.puede_solicitar = response.value.puede_solicitar;
                                self.has_error = response.value.has_error;
                                self.msg_error = response.value.msg_error;

                                $.unblockUI();
                            } else {
                                //NotificationJG.error(response.mensaje);
                                $.unblockUI();
                                Swal.fire({
                                    title: `NOTIFICACIÓN`,
                                    text: response.value.mensaje,
                                    type: 'error',
                                    icon: 'error',
                                    showCancelButton: false,
                                    allowOutsideClick: false,
                                    confirmButtonColor: '#3085d6',
                                    cancelButtonColor: '#d33',
                                    confirmButtonText: 'Aceptar',
                                    cancelButtonText: 'Cancelar'
                                }).then((result) => {
                                    if (result.value) {
                                        self.loading();
                                        window.location.href = "/";
                                    } else {
                                        self.loading();
                                        window.location.href = "/";
                                    }
                                }).catch(error => {
                                    self.loading();
                                    window.location.href = "/";
                                });
                            }
                        })
                        .catch(error => {
                            $.unblockUI();
                            Swal.fire({
                                title: `NOTIFICACIÓN`,
                                text: "Error al enviar los datos.",
                                type: 'error',
                                icon: 'error',
                                showCancelButton: false,
                                allowOutsideClick: false,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Aceptar',
                                cancelButtonText: 'Cancelar'
                            }).then((result) => {
                                if (result.value) {
                                    self.loading();
                                    window.location.href = "/";
                                } else {
                                    self.loading();
                                    window.location.href = "/";
                                }
                            }).catch(error => {
                                self.loading();
                                window.location.href = "/";
                            });
                        });
                },
                closeSolicitar: function (){
                    var self = this;
                    self.asignaturas.forEach(function (id, index){
                        $("#btn_aplicar_"+id).show();
                        $("#btn_remover_"+id).hide();
                    });
                    self.asignaturas = [];
                    $("#frmSolicitud", self.$modalSolicitar)[0].reset();
                    $("#id_motivo", self.$modalSolicitar).val(0);
                    $("#id_motivo", self.$modalSolicitar).trigger('change');
                    self.$modalSolicitar.modal('hide');
                },
                openSolicitar: function (){
                    var self = this;
                    self.loading();
                    //var h = $(window).height()-50;
                    //$(".modal-body", self.$modalSolicitar).css("max-height", "calc(100vh - 100px)");
                    self.$modalSolicitar.modal({backdrop:'static', width: '90%'}).modal('show');
                    //$("#id_descripcion", self.$modalSolicitar).css("text-decoration", "none");
                    $.unblockUI();
                },
                changeMotivo: function (id){
                    var self = this;
                    console.log(id);
                    self.motivo = null;
                    self.motivos.forEach(function(motivo, index) {
                        if (motivo.id != id && id!=0){
                            self.motivo = motivo
                        }
                    });
                },
                sendSolicitud: function (){
                    var self = this;
                    var valid = true;
                    if ($("#id_motivo", $("#frmSolicitud", self.$modalSolicitar)).val() == 0){
                        $('.help-text', $("#fieldset_motivo", self.$modalSolicitar)).html("Campo requerido, seleccione un motivo");
                        valid = false;
                    }
                    if (self.proceso.obligar_observacion){
                        //$("#id_descripcion", $("#frmSolicitud", self.$modalSolicitar)).css({'text-transform': 'none'}).addClass("validate[required]");
                        if ($("#id_descripcion", $("#frmSolicitud", self.$modalSolicitar)).val() == ''){
                            $('.help-text', $("#fieldset_descripcion", self.$modalSolicitar)).html("Campo requerido, ingrese una descripción");
                            valid = false;
                        }
                    }
                    if (self.proceso.obligar_archivo){
                        //$("#id_archivo", $("#frmSolicitud", self.$modalSolicitar)).addClass("validate[required]");
                        var rutaimg = $("#id_archivo", $("#frmSolicitud", self.$modalSolicitar)).val();
                        var extension = rutaimg.substring(rutaimg.length - 3, rutaimg.length);
                        if (extension.toLowerCase() != 'pdf') {
                            $(this).val(null);
                            $(this).filestyle('clear');
                            $('.help-text', $("#fieldset_archivo", self.$modalSolicitar)).html("Campo requerido, ingrese un archivo formato .pdf");
                        }
                    }
                    if (!valid){
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            type: 'error',
                            title: `Existe campos por ingresar`,
                            showConfirmButton: false,
                            timer: 6000
                        });
                        setTimeout(function() {
                            $('.help-text', self.$modalSolicitar).each(function () {
                                var field = $(this);
                                if (field.attr('alert')) {
                                    field.html(field.attr('alert'));
                                } else {
                                    field.html('');
                                }
                            });
                        }, 8000);
                        $.unblockUI();
                        return false;
                    }
                    if (self.asignaturas.length == 0){
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            type: 'error',
                            title: `Debe seleccionar al menos una asignatura.`,
                            showConfirmButton: false,
                            timer: 6000
                        });
                        return false;
                    }
                    let _aData = new FormData($("#frmSolicitud", self.$modalSolicitar)[0]);
                    _aData.append('action', 'sendSolicitud');
                    _aData.append('idpm', self.periodomatricula.id);
                    _aData.append('asignaturas', JSON.stringify(self.asignaturas));
                    self.loading();
                    loadAjax(_aData, '/alu_solicitudmatricula/especial', false)
                        .then(response => {
                            $.unblockUI();
                            if (response.value.result == 'ok')
                            {
                                Swal.fire({
                                    title: `NOTIFICACIÓN`,
                                    text: response.value.mensaje,
                                    type: 'success',
                                    icon: 'success',
                                    showCancelButton: false,
                                    allowOutsideClick: false,
                                    confirmButtonColor: '#3085d6',
                                    cancelButtonColor: '#d33',
                                    confirmButtonText: 'Aceptar',
                                    cancelButtonText: 'Cancelar'
                                }).then((result) => {
                                    if (result.value) {
                                        self.closeSolicitar();
                                        self.loadInitial();
                                    }else{
                                        self.closeSolicitar();
                                        self.loadInitial();
                                    }
                                }).catch(error => {
                                    Swal.fire({
                                        toast: true,
                                        position: 'top-end',
                                        type: 'error',
                                        title: error.mensaje,
                                        showConfirmButton: false,
                                        timer: 6000
                                    });
                                });

                            }
                            else
                            {
                                //console.log(response);
                                //NotificationJG.error(response.value.mensaje);
                                Swal.fire({
                                    toast: true,
                                    position: 'top-end',
                                    type: 'error',
                                    title: response.value.mensaje,
                                    showConfirmButton: false,
                                    timer: 6000
                                });
                            }
                        })
                        .catch(error => {
                            $.unblockUI();
                            //console.log(error);
                            //NotificationJG.error(error.message);
                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                type: 'error',
                                title: error.mensaje,
                                showConfirmButton: false,
                                timer: 6000
                            });
                        });

                },
                addAsignatura: function (asignatura){
                    var self = this;
                    if (self.periodomatricula.valida_materias_maxima && (self.asignaturas.length + 1) > self.periodomatricula.num_materias_maxima){
                        Swal.fire({
                            toast: false,
                            position: 'center',
                            icon:"error",
                            type: 'error',
                            title: 'Número de materias',
                            text: `Ha superado la cantidad (${self.periodomatricula.num_materias_maxima}) asignaturas permitidas a seleccionar`,
                            showConfirmButton: false,
                            timer: 6000
                        });
                        $.unblockUI();
                        return true;
                    }
                    $("#btn_aplicar_" + asignatura.id).hide();
                    $("#btn_remover_" + asignatura.id).show();
                    self.asignaturas.push(asignatura.id);
                    /*self.asignaturasmalla.forEach(function (am, index) {
                        if (asignatura.id == self.asignatura.id) {
                            $("#btn_aplicar_" + am.id).hide();
                            $("#btn_remover_" + am.id).show();
                        }
                    });*/
                },
                removeAsignatura: function (asignatura){
                    var self = this;
                    $("#btn_aplicar_"+asignatura.id).show();
                    $("#btn_remover_"+asignatura.id).hide();
                    self.asignaturas.forEach(function (a, index){
                        if (asignatura.id == a.id){
                            $("#btn_aplicar_"+a.id).show();
                            $("#btn_remover_"+a.id).hide();
                            self.asignaturas.splice(index, 1); // 1 es la cantidad de elemento a eliminar
                        }
                    });
                    /*self.loading();
                    self.asignaturasmalla.forEach(function(am, index) {
                        if (asignatura.id == am.id){
                            $("#btn_aplicar_"+am.id).show();
                            $("#btn_remover_"+am.id).hide();
                            self.materias.splice(index, 1); // 1 es la cantidad de elemento a eliminar
                        }
                    });*/
                },
                cancelSolicitud: function (solicitud){
                    var self = this;

                    Swal.fire({
                        title: `NOTIFICACIÓN`,
                        text: `Esta seguro de cancelar la solicitud Nro.${solicitud.codigo} de matrícula especial`,
                        type: 'warning',
                        icon: 'warning',
                        showCancelButton: true,
                        allowOutsideClick: false,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Aceptar',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.value) {
                            self.loading();
                            loadAjax({
                                'action': 'cancelarSolicitud',
                                'ids': solicitud.id,
                            }, '/alu_solicitudmatricula/especial', true)
                                .then(response => {
                                    if (response.value.result == 'ok') {
                                        $.unblockUI();
                                        Swal.fire({
                                            title: `NOTIFICACIÓN`,
                                            text: response.value.mensaje,
                                            type: 'success',
                                            icon: 'success',
                                            showCancelButton: false,
                                            allowOutsideClick: false,
                                            confirmButtonColor: '#3085d6',
                                            cancelButtonColor: '#d33',
                                            confirmButtonText: 'Aceptar',
                                            cancelButtonText: 'Cancelar'
                                        }).then((result) => {
                                            if (result.value) {
                                                self.loadInitial();
                                            }
                                        }).catch(error => {
                                        });

                                    } else {
                                        //NotificationJG.error(response.mensaje);
                                        $.unblockUI();
                                        Swal.fire({
                                            title: `NOTIFICACIÓN`,
                                            text: response.value.mensaje,
                                            type: 'error',
                                            icon: 'error',
                                            showCancelButton: false,
                                            allowOutsideClick: false,
                                            confirmButtonColor: '#3085d6',
                                            cancelButtonColor: '#d33',
                                            confirmButtonText: 'Aceptar',
                                            cancelButtonText: 'Cancelar'
                                        }).then((result) => {
                                            if (result.value) {
                                            }
                                        }).catch(error => {
                                        });
                                    }
                                })
                                .catch(error => {
                                    $.unblockUI();
                                    Swal.fire({
                                        title: `NOTIFICACIÓN`,
                                        text: "Error al enviar los datos.",
                                        type: 'error',
                                        icon: 'error',
                                        showCancelButton: false,
                                        allowOutsideClick: false,
                                        confirmButtonColor: '#3085d6',
                                        cancelButtonColor: '#d33',
                                        confirmButtonText: 'Aceptar',
                                        cancelButtonText: 'Cancelar'
                                    }).then((result) => {
                                        if (result.value) {
                                        }
                                    }).catch(error => {
                                    });
                                });
                        }else{
                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                type: 'info',
                                title: `La lolicitud Nro.(${solicitud.codigo}) de matrícula especial, se mantiene en estado <<${solicitud.estado}>>`,
                                showConfirmButton: false,
                                timer: 6000
                            });
                        }
                    }).catch(error => {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            type: 'error',
                            title: error.mensaje,
                            showConfirmButton: false,
                            timer: 6000
                        });
                    });
                },
                closeSolicitud: function (){
                    var self = this;
                    self.solicitud = {};
                    self.pasos = [];
                    self.$modalViewProceso.modal('hide');

                },
                viewSolicitud: function (solicitud){
                    var self = this;
                    console.log(solicitud);
                    self.loading();
                    loadAjax({
                        'action': 'viewSolicitud',
                        'id': solicitud.id,
                    }, '/alu_solicitudmatricula/especial', true)
                        .then(response => {
                            if (response.value.result == 'ok') {
                                $.unblockUI();
                                self.pasos = response.value.aPasos;
                                self.solicitud = response.value.aSolicitud;
                                self.$modalViewProceso.modal({backdrop:'static', width: '90%'}).modal('show');
                            } else {
                                $.unblockUI();
                                Swal.fire({
                                    title: `NOTIFICACIÓN`,
                                    text: response.value.mensaje,
                                    type: 'error',
                                    icon: 'error',
                                    showCancelButton: false,
                                    allowOutsideClick: false,
                                    confirmButtonColor: '#3085d6',
                                    cancelButtonColor: '#d33',
                                    confirmButtonText: 'Aceptar',
                                    cancelButtonText: 'Cancelar'
                                }).then((result) => {
                                    if (result.value) {
                                    }
                                }).catch(error => {
                                });
                            }
                        })
                        .catch(error => {
                            $.unblockUI();
                            Swal.fire({
                                title: `NOTIFICACIÓN`,
                                text: "Error al enviar los datos.",
                                type: 'error',
                                icon: 'error',
                                showCancelButton: false,
                                allowOutsideClick: false,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Aceptar',
                                cancelButtonText: 'Cancelar'
                            }).then((result) => {
                                if (result.value) {
                                }
                            }).catch(error => {
                            });
                        });
                },
                showProcess: function (paso){
                    var self = this;
                    if (paso.class!='disabled'){
                        $('ul.setup-panel li', self.$modalViewProceso).removeClass('active');
                        $(`#paso${paso.id}`, self.$modalViewProceso).addClass('active');
                        $('.setup-content', self.$modalViewProceso).removeClass('show');
                        $('.setup-content', self.$modalViewProceso).removeClass('hidden');
                        $('.setup-content', self.$modalViewProceso).hide();
                        $(`#step-${paso.id}`, self.$modalViewProceso).show();
                    }
                },
            },
        });
    </script>
{% endblock %}



