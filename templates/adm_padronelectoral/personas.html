{% extends "basebs.html" %}
{% block heading %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.7.7/xlsx.core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xls/0.7.4-a/xls.core.min.js"></script>
    <link href="/static/widget_ppp.css" rel="stylesheet"/>
    <script type="text/javascript" src='/static/js/fontawesomev3.js?v=1.0.0'></script>
    <style>
        .modal-body {
            max-width: 100%;
            overflow-x: auto;
        }

        .list-group {
            width: 180px;
            float: left;
            margin-left: 10px
        }
    </style>
    <script>

        $(function () {
            $("#cargaForm").submit(function (e) {
                bloqueointerface();
            });

            $('#excelfile').on('change', function () {
                var archivo = $(this).val();
                var extension = archivo.substring(archivo.length - 3, archivo.length);
                if (extension.toLowerCase() === 'lsx') {
                } else {
                    $(this).val('');
                    smoke.alert('Debe cargar un archivo con formato .xlsx');
                }
            });
        });

        function cargarExcel() {
            $('#modalCargarExcel').modal({"backdrop": "static", "width": "800px"}).modal("show");
        }

        function cargarExcelMesa() {
            $('#modalCargarExcelMesa').modal({"backdrop": "static", "width": "800px"}).modal("show");
        }

        var intentos = 0;

        function ExportToTable() {
            var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.xlsx|.xls)$/;
            /*Checks whether the file is a valid excel file*/
            if ($("#excelfile").val()) {
                bloqueointerface();
                var xlsxflag = true; /*Flag for checking whether excel is .xls format or .xlsx format*/

                /*Checks whether the browser supports HTML5*/
                if (typeof (FileReader) != "undefined") {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        var data = e.target.result;
                        /*Converts the excel data in to object*/
                        if (xlsxflag) {
                            var workbook = XLSX.read(data, {type: 'binary'});
                        } else {
                            var workbook = XLS.read(data, {type: 'binary'});
                        }
                        /*Gets all the sheetnames of excel in to a variable*/
                        var sheet_name_list = workbook.SheetNames;

                        var cnt = 0; /*This is used for restricting the script to consider only first sheet of excel*/
                        sheet_name_list.forEach(function (y) { /*Iterate through all sheets*/
                            /*Convert the cell value to Json*/
                            if (xlsxflag) {
                                var exceljson = XLSX.utils.sheet_to_json(workbook.Sheets[y]);
                            } else {
                                var exceljson = XLS.utils.sheet_to_row_object_array(workbook.Sheets[y]);
                            }
                            if (exceljson.length > 0 && cnt == 0) {
                                BindTable(exceljson, '#exceltable');
                                cnt++;
                            }
                        });
                        $('#exceltable').show();
                    }
                    if (xlsxflag) {/*If excel file is .xlsx extension than creates a Array Buffer from excel*/
                        reader.readAsArrayBuffer($("#excelfile")[0].files[0]);
                    } else {
                        reader.readAsBinaryString($("#excelfile")[0].files[0]);
                    }
                } else {
                    smoke.alert("Sorry! Your browser does not support HTML5!");
                }
            } else {
                smoke.alert('Archivo no valido, debe ser xlsx')
            }
        }

        function fallorecalculo() {
            $.unblockUI();
            $("#recalcularmodal").modal("hide");
            smoke.alert("Fallo al recalcular los resultados");
        }

        function terminarecalculo() {
            $("#recalcularmodal").modal("hide");
            bloqueointerface();
            location.reload();
        }

        function generar_qr(id) {
            bloqueointerface();
            $.ajax({
                type: "GET",
                url: "/adm_padronelectoral",
                data: {
                    "action": "generarqr",
                    "id": id,
                },
                success: function (data) {
                    $.unblockUI();
                    if (data.result) {
                        window.open(data.url_pdf, '_blank');
                    } else {
                        mensajeWarning(`Error acercarse a mesa informativa ${data.msg}`)
                    }
                },
                error: function () {
                    $.unblockUI();
                },
                dataType: "json"
            });
        }

        function recalculo(lista, elemento, cantidad) {
            var listaexcel = lista[elemento];

            var cp = (100 / (cantidad + 1)) * elemento + '%';
            if (elemento > cantidad) {
                terminarecalculo();
            } else {
                $.unblockUI();
                $("#recalcularmodalprogresshint").html(`<b>${listaexcel.cedula}</b> - ${listaexcel.nombres} - [${listaexcel.lugar}]`);
                $("#progressbar").css({'width': cp});
                $("#progressbar").html(((elemento * 100) / cantidad).toFixed(2) + '%');
                $.ajax({
                    type: "POST",
                    url: "/adm_padronelectoral",
                    data: {
                        "action": "importar_personas",
                        "cab": {{ cab.pk }},
                        "cedula": listaexcel.cedula,
                        "nombres": listaexcel.nombres,
                        "lugar": listaexcel.lugar,
                        "tipo": $('#id_tipo').val()
                    },
                    success: function (data) {
                        if (data.result == 'ok') {
                            intentos = 0;
                            recalculo(lista, elemento + 1, cantidad);
                        } else {
                            intentos += 1;
                            if (intentos >= 1) {
                                fallorecalculo();
                            } else {
                                recalculo(lista, elemento, cantidad);
                            }
                        }
                    },
                    error: function () {
                        intentos += 1;
                        if (intentos >= 100) {
                            fallorecalculo();
                        } else {
                            recalculo(lista, elemento, cantidad);
                        }
                    },
                    dataType: "json"
                });
            }
        }

        function BindTable(jsondata, tableid) {/*Function used to convert the JSON array to Html Table*/
            var columns = BindTableHeader(jsondata, tableid); /*Gets all the column headings of Excel*/
            jsonObj = [];
            for (var i = 0; i < jsondata.length; i++) {
                var row$ = $('<tr/>');
                var nombrepersona = ''
                var cedula = ''
                var lugar = ''

                for (var colIndex = 0; colIndex < columns.length; colIndex++) {
                    var cellValue = jsondata[i][columns[colIndex]];
                    if (cellValue == null)
                        cellValue = "";
                    if (colIndex == 0) {
                        item = {}
                        item ["nombres"] = cellValue;
                    }
                    if (colIndex == 1) {
                        item ["cedula"] = cellValue;
                    }
                    if (colIndex == 2) {
                        item ["lugar"] = cellValue;
                    }
                }
                jsonObj.push(item);
                $(tableid).append(row$);
            }
            $('#recalcularmodal').modal({keyboard: false, backdrop: 'static'}).modal("show");
            jsonString = JSON.stringify(jsonObj);
            var indice = 0;
            var cantidad = parseInt(i);
            var listamarcadas = jsonObj;
            recalculo(listamarcadas, indice, (cantidad - 1));
        }

        function BindTableHeader(jsondata, tableid) {/*Function used to get all column names from JSON and bind the html table header*/
            var columnSet = [];
            var headerTr$ = $('<tr/>');
            for (var i = 0; i < jsondata.length; i++) {
                var rowHash = jsondata[i];
                for (var key in rowHash) {
                    if (rowHash.hasOwnProperty(key)) {
                        if ($.inArray(key, columnSet) == -1) {/*Adding each unique column names to a variable array*/
                            columnSet.push(key);
                            headerTr$.append($('<th/>').html(key));
                        }
                    }
                }
            }

            return columnSet;
        }

        var intentosMesa = 0;

        function ExportToTableMesa() {
            var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.xlsx|.xls)$/;
            if ($("#excelfileMesa").val()) {
                bloqueointerface();
                var xlsxflag = true;

                if (typeof (FileReader) != "undefined") {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        var data = e.target.result;
                        if (xlsxflag) {
                            var workbook = XLSX.read(data, {type: 'binary'});
                        } else {
                            var workbook = XLS.read(data, {type: 'binary'});
                        }
                        var sheet_name_list = workbook.SheetNames;
                        var cnt = 0;
                        sheet_name_list.forEach(function (y) {
                            if (xlsxflag) {
                                var exceljson = XLSX.utils.sheet_to_json(workbook.Sheets[y]);
                            } else {
                                var exceljson = XLS.utils.sheet_to_row_object_array(workbook.Sheets[y]);
                            }
                            if (exceljson.length > 0 && cnt == 0) {
                                BindTableMesa(exceljson, '#exceltable');
                                cnt++;
                            }
                        });
                        $('#exceltable').show();
                    }
                    if (xlsxflag) {
                        reader.readAsArrayBuffer($("#excelfileMesa")[0].files[0]);
                    } else {
                        reader.readAsBinaryString($("#excelfileMesa")[0].files[0]);
                    }
                } else {
                    smoke.alert("Sorry! Your browser does not support HTML5!");
                }
            } else {
                smoke.alert('Archivo no valido, debe ser xlsx')
            }
        }

        function fallorecalculoMesa(mensaje) {
            $.unblockUI();
            $("#recalcularmodal").modal("hide");
            smoke.alert(mensaje);
        }

        function terminarecalculoMesa() {
            $("#recalcularmodal").modal("hide");
            bloqueointerface();
            location.reload();
        }

        function recalculoMesa(lista, elemento, cantidad) {
            var listaexcel = lista[elemento];

            var cp = (100 / (cantidad + 1)) * elemento + '%';
            if (elemento > cantidad) {
                terminarecalculoMesa();
            } else {
                $.unblockUI();
                $("#recalcularmodalprogresshint").html(`<b>${listaexcel.cedula}</b> - ${listaexcel.nombres} - [${listaexcel.lugar}]`);
                $("#progressbar").css({'width': cp});
                $("#progressbar").html(((elemento * 100) / cantidad).toFixed(2) + '%');
                $.ajax({
                    type: "POST",
                    url: "/adm_padronelectoral",
                    data: {
                        "action": "importar_personas_mesa",
                        "cab": {{ cab.pk }},
                        "cedula": listaexcel.cedula,
                        "nombres": listaexcel.nombres,
                        "lugar": listaexcel.lugar,
                        "tipo": listaexcel.tipo
                    },
                    success: function (data) {
                        if (data.result == 'ok') {
                            intentos = 0;
                            recalculoMesa(lista, elemento + 1, cantidad);
                        } else {
                            intentos += 1;
                            if (intentos >= 1) {
                                fallorecalculoMesa(data.mensaje);
                            } else {
                                recalculoMesa(lista, elemento, cantidad);
                            }
                        }
                    },
                    error: function () {
                        intentos += 1;
                        if (intentos >= 100) {
                            fallorecalculoMesa('Intentelo más tarde');
                        } else {
                            recalculoMesa(lista, elemento, cantidad);
                        }
                    },
                    dataType: "json"
                });
            }
        }

        function BindTableMesa(jsondata, tableid) {/*Function used to convert the JSON array to Html Table*/
            var columns = BindTableHeaderMesa(jsondata, tableid); /*Gets all the column headings of Excel*/
            jsonObj = [];
            for (var i = 0; i < jsondata.length; i++) {
                var row$ = $('<tr/>');
                var nombrepersona = ''
                var cedula = ''
                var lugar = ''

                for (var colIndex = 0; colIndex < columns.length; colIndex++) {
                    var cellValue = jsondata[i][columns[colIndex]];
                    if (cellValue == null)
                        cellValue = "";
                    if (colIndex == 0) {
                        item = {}
                        item ["nombres"] = cellValue;
                    }
                    if (colIndex == 1) {
                        item ["cedula"] = cellValue;
                    }
                    if (colIndex == 2) {
                        item ["lugar"] = cellValue;
                    }
                    if (colIndex == 3) {
                        item ["tipo"] = cellValue;
                    }
                }
                jsonObj.push(item);
                $(tableid).append(row$);
            }
            $('#recalcularmodal').modal({keyboard: false, backdrop: 'static'}).modal("show");
            jsonString = JSON.stringify(jsonObj);
            var indice = 0;
            var cantidad = parseInt(i);
            var listamarcadas = jsonObj;
            recalculoMesa(listamarcadas, indice, (cantidad - 1));
        }

        function BindTableHeaderMesa(jsondata, tableid) {/*Function used to get all column names from JSON and bind the html table header*/
            var columnSet = [];
            var headerTr$ = $('<tr/>');
            for (var i = 0; i < jsondata.length; i++) {
                var rowHash = jsondata[i];
                for (var key in rowHash) {
                    if (rowHash.hasOwnProperty(key)) {
                        if ($.inArray(key, columnSet) == -1) {/*Adding each unique column names to a variable array*/
                            columnSet.push(key);
                            headerTr$.append($('<th/>').html(key));
                        }
                    }
                }
            }

            return columnSet;
        }

        function formModal(id, text, action, footer = true) {
            $('.panelbodyform').empty();
            bloqueointerface();
            $.ajax({
                type: "GET",
                url: `{{ request.path }}`,
                data: {
                    'action': action,
                    'id': id,
                },
                success: function (data) {
                    $.unblockUI();
                    if (data.result === true) {
                        if (footer === true) {
                            $('#footermodalform').hide();
                        }
                        $('.panelbodyform').html(data.data);
                        $('#itemspanelform .paneltitleform').html(text);
                        $("#itemspanelform").modal({backdrop: 'static', width: '900px'}).modal('show');
                    } else {
                        smoke.alert(data.mensaje);
                    }
                },
                error: function () {
                    $.unblockUI();
                    smoke.alert("Error de conexión.");
                },
                dataType: "json"
            });
        }

        $(function () {
            $("select:not(.swal2-select)").select2();
            $(".select2hidden").each(function () {
                var id = $(this).attr("id");
                $("#" + id + "_select2").html('<option>' + $(this).attr("descripcion") + '</option>').trigger('change');
            });
        });

        function empadronarAutomatico() {
            $('#modalEmpadronarPersonas').modal({"backdrop": "static", "width": "800px"}).modal("show");
        }

        function procesoEmpadronarPersona() {
            bloqueointerface();
            var tpersona = $('#tipoPersonaEmpadronar').val();
            var cpersona = $('#coordinacionEmpadronar').val();
            $.ajax({
                type: 'POST',
                url: '{{ request.path }}',
                data: {
                    'action': 'consultatotalempadronar',
                    'idevento': '{{ cab.id }}',
                    'tipo': tpersona,
                    'coordinacion': cpersona
                },
                dataType: "json",
                success: function (data) {
                    $.unblockUI();
                    if (data.result) {
                        Swal.fire({
                            title: `Estas a punto de empadronar un total de \n ${data.totalempadronar} personas`,
                            text: "Esta acción es irreversible",
                            type: 'warning',
                            showCancelButton: true,
                            allowOutsideClick: false,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Si, deseo hacerlo',
                            cancelButtonText: 'Cancelar'
                        }).then((result) => {
                            if (result.value) {

                            }
                        })
                    } else {
                        Swal.fire(data.mensaje, '', 'error')
                    }
                },
                error: function () {
                    $.unblockUI();
                    smoke.alert("Error, Intentelo más tarde");
                },
            });
        }

        $(function () {
            $('#tipoPersonaEmpadronar').on('change', function () {
                var tp = $(this).val()
                if (tp == '1') {
                    $('#coordinacionPadron').show();
                } else {
                    $('#coordinacionPadron').hide();
                }
            });
        })

    </script>
    <script src="/static/adicionalesjs/formquestion.js?0.24"></script>
{% endblock %}
{% block atras %}{{ request.path }}{% endblock %}
{% block canvas %}

    <div class="modal fade static" id="itemspanelform" style="display: none;">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            <h4><i class="fa fa-list"></i> <b class="paneltitleform">FORMULARIO MODAL</b></h4>
        </div>
        <div class="modal-body">
            <form autocomplete="off" method="post"
                  enctype="multipart/form-data" action="{{ request.path }}">
                {% csrf_token %}
                <div class="row-fluid panelbodyform">
                </div>
            </form>
        </div>
        <div class="modal-footer" id="footermodalform">
            <a href="javascript:;" class="btn btn-default" data-dismiss="modal"><i
                    class="fa fa-window-close"></i>
                Cerrar</a>
        </div>
    </div>

    <div class="modal static" id="recalcularmodal" style="display: none;">
        <div class="modal-header">
            <h3><i class="fa fa-user"></i> Registrando Personas</h3>
        </div>
        <div class="modal-body">
            <div style='margin-bottom:1px;height: 20px;background-image: linear-gradient(to bottom, #dde2df, #d7e2dd)'
                 class="progress progress-striped active">
                <div class="bar" style="font-weight: bold; width: 0;" id="progressbar" aria-valuenow="25"></div>
            </div>
            <div id="recalcularmodalprogresshint">
            </div>
            <div class="alert alert-danger alert-dismissable">
                Nota: Se excluiran automaticamente los registros ya existentes.
            </div>
        </div>
    </div>

    <div class="modal fade static" id="modalCargarExcel" style="display: none;">
        <div class="modal-header">
            <h3 class="paneltitle"><i class="fa fa-file-excel-o"></i> Importar Empadronados</h3>
        </div>
        <div class="modal-body panelbody">
            <form method="post" enctype="multipart/form-data" id="cargaForm"
                  class="form-horizontal form-label-left">
                {% csrf_token %}
                <div class="form-group">
                    <h3 class="form-label"><b><i class="fa fa-upload"></i> Cargar Formato</b></h3>
                    <input type="hidden" name="action" value="cargarExcel">
                    <select id="id_tipo" class="form-control" style="width: 100%">
                        {% for tp in tipo_persona %}
                            <option value="{{ tp.0 }}" {% if tipo == tp.0 %}selected{% endif %}>{{ tp.1 }}</option>
                        {% endfor %}
                    </select><br>
                    <input type="file" name="excel" required class="form-control"
                           accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                           id="excelfile">
                    <div class="alert alert-warning alert-dismissable">
                        <b>
                            <a href="/static/formatos/enpadronadosformato.xlsx" target="_blank"><i
                                    class="fa fa-download"></i>
                                Descargar Formato</a>
                        </b>
                    </div>
                    <table id="exceltable">
                    </table>
                </div>
                <div class="form-group" align='right'>
                    <a id="submit" class="btn btn-success" onclick="ExportToTable()">
                        <i class="fa fa-upload"></i> Cargar Personal
                    </a>
                    &nbsp;
                    <a href="javascript:;" class="btn btn-danger" data-dismiss="modal"><i
                            class="fa fa-window-close"></i> Cerrar</a>
                </div>
            </form>
        </div>
    </div>

    <div class="modal fade static" id="modalCargarExcelMesa" style="display: none;">
        <div class="modal-header">
            <h3 class="paneltitle"><i class="fa fa-file-excel-o"></i> Importar Personas en Mesa</h3>
        </div>
        <div class="modal-body panelbody">
            <form method="post" enctype="multipart/form-data" id="cargaForm"
                  class="form-horizontal form-label-left">
                {% csrf_token %}
                <div class="form-group">
                    <h3 class="form-label"><b><i class="fa fa-upload"></i> Cargar Formato</b></h3>
                    <input type="hidden" name="action" value="cargarExcelMesa">
                    <input type="file" name="excelMesa" required class="form-control"
                           accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                           id="excelfileMesa">
                    <div class="alert alert-warning alert-dismissable">
                        <b>
                            <a href="/static/formatos/enpadronadosformato.xlsx" target="_blank"><i
                                    class="fa fa-download"></i>
                                Descargar Formato</a>
                        </b>
                    </div>
                    <table id="exceltable">
                    </table>
                </div>
                <div class="form-group" align='right'>
                    <a id="submit" class="btn btn-success" onclick="ExportToTableMesa()">
                        <i class="fa fa-upload"></i> Cargar Personal
                    </a>
                    &nbsp;
                    <a href="javascript:;" class="btn btn-danger" data-dismiss="modal"><i
                            class="fa fa-window-close"></i> Cerrar</a>
                </div>
            </form>
        </div>
    </div>

    <div class="modal fade static" id="modalEmpadronarPersonas" style="display: none;">
        <div class="modal-header">
            <h3 class="paneltitle"><i class="fa fa-users"></i> Empadronar Personas</h3>
        </div>
        <div class="modal-body panelbody">
            <form method="post" enctype="multipart/form-data" id="cargaForm"
                  class="form-horizontal form-label-left">
                {% csrf_token %}
                <div class="alert alert-warning" role="alert">
                    <b><i class="fa fa-warning"></i> Nota:</b> Se tomarán encuenta solo a las personas que no posean
                    rubros vencidos.
                </div>
                <div class="form-group">
                    <input type="hidden" name="action" value="empadronarPersonas">
                    <h5 class="form-label"><b><i class="fa fa-tag"></i> Tipo</b></h5>
                    <select id="tipoPersonaEmpadronar" class="form-control" style="width: 100%">
                        {% for tp in tipo_persona %}
                            <option value="{{ tp.0 }}" {% if tipo == tp.0 %}selected{% endif %}>{{ tp.1 }}</option>
                        {% endfor %}
                    </select><br><br>
                    <div id="coordinacionPadron">
                        <h5 class="form-label"><b><i class="fa fa-building"></i> Coordinación</b></h5>
                        <select id="coordinacionEmpadronar" class="form-control" style="width: 100%">
                            {% for tp in coordinaciones %}
                                <option value="{{ tp.pk }}">{{ tp.nombre }}</option>
                            {% endfor %}
                        </select><br><br>
                    </div>
                </div>
                <div class="form-group" align='right'>
                    <a id="submit" class="btn btn-success" onclick="procesoEmpadronarPersona()">
                        <i class="fa fa-cogs"></i> Cargar Personal
                    </a>
                    &nbsp;
                    <a href="javascript:;" class="btn btn-danger" data-dismiss="modal"><i
                            class="fa fa-window-close"></i> Cerrar</a>
                </div>
            </form>
        </div>
    </div>

    <div class='row-fluid'>
        <div class='span12'>
            <h4><i class="fa fa-check-square"></i> {{ cab.nombre }} </h4>
            <h4>{{ title }} </h4>
        </div>
    </div>

    <div class='row-fluid'>
        <div class="span12">
            <div class="span12">
                <form method="GET" action="{{ request.path }}">
                    <input type="hidden" name="action" value="personas">
                    <input type="hidden" name="id" value="{{ cab.id }}">
                    <div class="btn-group" data-toggle="buttons">
                        <label class="btn btn-default">
                            <input type="radio" name="options" id="option1" autocomplete="off" value="1"
                                   {% if options == 1 %}checked {% endif %} onclick="seleccionar(this.value)"> <strong>En
                            Mesa</strong>
                        </label>
                        <label class="btn btn-default">
                            <input type="radio" name="options" id="option2" autocomplete="off" value="2"
                                   {% if options == 2 %}checked {% endif %} onclick="seleccionar(this.value)"> <strong>Ver
                            Empadronados</strong>
                        </label>
                        <label class="btn btn-default">
                            <input type="radio" name="options" id="option2" autocomplete="off" value="3"
                                   {% if options == 3 %}checked {% endif %} onclick="seleccionar(this.value)"> <strong>Con
                            Justificativos</strong>
                        </label>
                        <label class="btn btn-default">
                            <input type="radio" name="options" id="option4" autocomplete="off" value="4"
                                   {% if options == 4 %}checked {% endif %} onclick="seleccionar(this.value)"> <strong>Excluidos</strong>
                        </label>
                        <label class="btn btn-default">
                            <input type="radio" name="options" id="option5" autocomplete="off" value="5"
                                   {% if options == 5 %}checked {% endif %} onclick="seleccionar(this.value)"> <strong>Con
                            PDF</strong>
                        </label>
                        <label class="btn btn-default">
                            <input type="radio" name="options" id="option6" autocomplete="off" value="6"
                                   {% if options == 6 %}checked {% endif %} onclick="seleccionar(this.value)"> <strong>Sin
                            PDF</strong>
                        </label>
                    </div>
                    <select name="tipo" id="tipo" class="form-control" style="width: 15%">
                        <option value="">------------------------</option>
                        {% for tp in tipo_persona %}
                            <option value="{{ tp.0 }}" {% if tipo == tp.0 %}selected{% endif %}>{{ tp.1 }}</option>
                        {% endfor %}
                    </select>
                    <select name="orderby" id="orderby" class="form-control" style="width: 15%">
                        <option value="">------------------------</option>
                        <option value="1" {% if orderby == 1 %}selected{% endif %}>ORDENAR POR APELLIDOS</option>
                        <option value="2" {% if orderby == 2 %}selected{% endif %}>ORDENAR POR NIVEL</option>
                        <option value="3" {% if orderby == 3 %}selected{% endif %}>ORDENAR POR LUGAR</option>
                    </select>
                    <select name="coordinacion" id="coodinacion" class="form-control" style="width: 15%">
                        <option value="">------------------------</option>
                        {% for tp in coordinaciones %}
                            <option value="{{ tp.pk }}"
                                    {% if coordinacion == tp.pk %}selected{% endif %}>{{ tp.pk }}) {{ tp.alias }}
                                - {{ tp.nombre }}</option>
                        {% endfor %}
                    </select>
                    <input class='searchinput' type='text' name='search' value='{{ search }}' autocomplete="off"
                           placeholder="Apellidos o Cédula"/>
                    <button class="btn btn-success"><i class="fa fa-search"></i></button>
                    {% if url_vars %}
                        <a href="{{ request.path }}?action=personas&id={{ cab.id }}" id='allresults'
                           class='btn btn-default'><span
                                class="fa fa-refresh "></span></a>
                    {% endif %}
                    <a href="{{ request.path }}?export_to_excel=1{{ url_vars }}" id='allresults'
                       class='btn btn-success'><span
                            class="fa fa-file-excel-o"></span>
                    </a>
                </form>

            </div>
        </div>
    </div>

    <div class="row-fluid">
        <div class='span12'>
            <a onclick="formModal('{{ cab.id }}','Adicionar Empadronado','addempadronado')" href="javascript:void(0);"
               class="btn btn-success">
                <i class="fa fa-plus"></i> Adicionar Empadronado
            </a>
            {#            <a onclick="empadronarAutomatico('{{ cab.id }}')" href="javascript:void(0);" class="btn btn-warning">#}
            {#                <i class="fa fa-user-plus"></i> Empadronar#}
            {#            </a>#}
            {#            <a href="javascript:void(0);" onclick="cargarExcel()" class='btn btn-default'><span#}
            {#                    class="fa fa-upload"></span> Importar Personas</a>#}
            {#            <a href="javascript:void(0);" onclick="cargarExcelMesa()" class='btn btn-default'><span#}
            {#                    class="fa fa-upload"></span> Importar Personas En Mesa</a>#}
            <a href="?action=verjustificativosgeneral&id={{ cab.id }}" class="btn btn-primary"><i
                    class="fa fa-check-square"></i> Ver Justificativos de Omisión de Sufragio</a>

        </div>
    </div>

    <div class="row-fluid">
        <div class='span12'>
            <span class="label label-info" style="margin-bottom: 12px"><i class="fa fa-info-circle"></i> {{ listcount }} Registros</span>
            <span class="label label-success" style="margin-bottom: 12px"><i
                    class="fa fa-users"></i> {{ totestudiantes }} Estudiantes</span>
            <span class="label label-warning" style="margin-bottom: 12px"><i
                    class="fa fa-chalkboard-teacher"></i> {{ totdocentes }} Docentes</span>
            <span class="label label-primary" style="margin-bottom: 12px"><i
                    class="fa fa-user-shield"></i> {{ totadministrativos }} Administrativos</span>
            <span class="label label-inverse" style="margin-bottom: 12px"><i
                    class="fa fa-user-shield"></i> {{ totaljustificativos }} Con Justificativos</span>
            <table class='table table-bordered' cellpadding="0" cellspacing="0">
                <thead class="thead-dark">
                <tr>
                    <th colspan="3" style="text-align: center"><i class="fa fa-address-card"></i> DATOS PERSONA</th>
                    <th colspan="4" style="text-align: center"><i class="fa fa-location-arrow"></i> DATOS UBICACIÓN</th>
                    <th colspan="1" style="text-align: center"></th>
                </tr>
                <tr>
                    <th class="column-title" style="text-align: center">Cédula</th>
                    <th class="column-title" style="text-align: center">Nombres</th>
                    <th class="column-title" style="text-align: center">Tipo</th>
                    <th class="column-title" style="text-align: center"><span class="nobr">Sede</span></th>
                    <th class="column-title" style="text-align: center; width: 5%">¿Mesa?</th>
                    <th class="column-title" style="text-align: center"><span class="nobr">Lugar Mesa</span></th>
                    <th class="column-title" style="text-align: center; width: 5%">¿Puede <br> Justificar Falta?</th>
                    <th class="column-title" style="text-align: center; width: 10%"><i class="fa fa-cogs"></i></th>
                </tr>
                </thead>
                <tbody>
                {% for p in lista %}
                    <tr>
                        <td style="text-align: center">
                            {{ p.persona.cedula }} <br><b>Cod. {{ p.id }}</b>{% if p.excluir %}
                            <span class="text-danger">Excluido</span>{% endif %}
                        </td>
                        <td style="text-align: center">
                            {{ p.persona }}<br>
                            <b>Año Nacimiento: {{ p.persona.nacimiento|date:'Y' }}</b>
                        </td>
                        <td style="text-align: center">
                            <b>{{ p.get_tipo }}</b>
                            {% if p.tipo == 1 %}
                                {% if p.matricula or p.inscripcion %}
                                    <div style="text-align: center">
                                        {{ p.inscripcion.carrera }}<br>
                                        {% if p.modalidad_persona %}
                                            <span class="label label-info">VIRTUAL</span>
                                        {% else %}
                                            <span class="label label-success">PRESENCIAL</span>
                                        {% endif %}
                                        <label class="label label-darkgreen">{{ p.inscripcion.coordinacion.alias }}</label>
                                        &nbsp;<label class="label label-warning">{{ p.matricula.nivelmalla }}</label>
                                    </div>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td style="text-align: center; width: 20%">
                            {% if p.lugar %}
                                {{ p.lugar }}<br>
                            {% endif %}
                            {% if p.cab.utiliza_sede %}
                                {% if p.lugarsede %}
                                    <label class="label label-info">{{ p.lugarsede.canton.nombre }}, {{ p.lugarsede.canton.provincia.nombre }}</label>
                                {% else %}
                                    <label class="label label-default"><i class="fa fa-times"></i> SIN SEDE</label>
                                {% endif %}
                            {% endif %}
                            {% if p.mesa %}
                                <br><b>Mesa:</b> {{ p.mesa }}
                            {% endif %}
                            {% if p.codigo_qr %}
                                <b>CodigoQr:</b> {{ p.codigo_qr }}
                                {% if p.validado %}<br>
                                    {{ p.fechavalida|date:"d-m-Y" }}<br>
                                    <i class="fa fa-check-circle text-success"></i> {{ p.persona_valida }}
                                {% endif %}
                            {% endif %}
                            {% if p.pdf %}
                                <a href="{{ p.pdf.url }}" target="_blank" class="btn-link"><i class="fa fa-eye"></i> Ver
                                    PDF</a>
                            {% endif %}
                        </td>
                        <td style="text-align: center">
                            <i class="{{ p.enmesa_get|safe }}"></i>
                        </td>
                        <td style="text-align: center; width: 20%">
                            {% if p.info_mesa %}
                                <b>ROL:</b> {{ p.info_mesa.0 }} <br> <b>LUGAR:</b> {{ p.info_mesa.1 }}
                                {% if p.info_mesa.5 %}
                                    <br><a href="/media/{{ p.info_mesa.5 }}" class="btn btn-primary btn-mini"
                                           target="_blank">
                                    <i class="fa fa-gavel"></i> DESCARGAR ACTA
                                </a><br>
                                    Generada: <b>{{ p.info_mesa.6 }}</b>
                                {% endif %}
                            {% else %}
                                <label class="label label-default"><i class="fa fa-times"></i> NO</label>
                            {% endif %}
                        </td>
                        <td style="text-align: center">
                            <i class="{{ p.puede_justificar_get|safe }}"></i>
                        </td>
                        <td style="text-align: center">
                            <a href="?action=verjustificativos&id={{ p.pk }}" class="btn btn-success btn-mini">
                                <i class="fa fa-check-square"></i> Ver <b>{{ p.total_justificacion }}</b>
                            </a>
                            <a onclick="formModal('{{ p.id }}','Editar Gremio Periodo','editempadronado')"
                               class="tl btn btn-primary btn-mini" title="Editar" href="javascript:void(0);">
                                <i class="fa fa-pencil"></i>
                            </a>
                            <a class="tl btn btn-danger btn-mini" href="javascript:;" title="Eliminar"
                               onclick="eliminarajax('{{ p.id }}', '{{ p.nombre }}', 'deleteempadronado')">
                                <i class="fa fa-trash"></i>
                            </a>


                            <a href="javascript:;" onclick="generar_qr({{ p.id }})"
                               class="tl btn btn-primary btn-mini">
                                QR
                            </a>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="15">
                            NO EXISTEN REGISTROS
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class='row-fluid'>
        <div class="span12">
            {% if paging.num_pages > 10 %}
                <div class='pagination'>
                    <ul>
                        {% if paging.primera_pagina %}
                            <li>
                                <a href="{{ request.path }}?page=1{{ url_vars }}">1</a>
                            </li>
                            <li>
                                <a href="{{ request.path }}?page={{ paging.ellipsis_izquierda }}{{ url_vars }}"
                                   class="active">...</a></li>
                        {% endif %}
                        {% for pagenumber in paging.paginas %}
                            <li {% if pagenumber == page.number %}class='active'{% endif %}><a
                                    href="{{ request.path }}?page={{ pagenumber }}{{ url_vars }}">{{ pagenumber }}</a>
                            </li>
                        {% endfor %}
                        {% if paging.ultima_pagina %}
                            <li>
                                <a href="{{ request.path }}?page={{ paging.ellipsis_derecha }}{{ url_vars }}"
                                   class="active">...</a></li>
                            <li>
                                <a href="{{ request.path }}?page=
                                        {{ paging.num_pages }}{{ url_vars }}">{{ paging.num_pages }}</a>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            {% else %}
                <div class='pagination'>
                    <ul>
                        {% for pagenumber in paging.page_range %}
                            <li {% if pagenumber == page.number %}class='active'{% endif %}><a
                                    href="{{ request.path }}?page={{ pagenumber }}{{ url_vars }}">{{ pagenumber }}</a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        </div>
    </div>

{% endblock %}

