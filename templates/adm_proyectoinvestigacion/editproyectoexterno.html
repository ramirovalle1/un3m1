{% extends "ajaxform.html" %}
{% load sga_extras %}
{% block extraheading %}
    <link href="/static/switchery/switchery.min.css" rel="stylesheet"/>
    <script src="/static/switchery/switchery.min.js"></script>
    <script type="text/javascript">
        var switchery = {};
        $.fn.initSwitchery = function () {
            //Init CheckBox Style
            var searchBy = ".js-switch";
            $(this).find(searchBy).each(function (i, html) {
                debugger;
                if (!$(html).next().hasClass("switchery")) {
                    //switchery[html.getAttribute('id')] = new Switchery(html, $(html).data());
                    switchery[html.getAttribute('id')] = new Switchery(html, {size: 'small', color: '#5DADE2'});
                }
            });
        };

        $(function(){
            $('[data-bs-toggle="tooltip"]').on('click', function () {
                $(this).tooltip('hide');
            });

            let accionbuscar = "buscarprofesor";

            $("body").initSwitchery();

            //Contiene los datos de las instituciones co-ejecutoras borradas
            lista_items1 = [];

            $("#id_categoria, #id_codigo, #id_titulo, #id_convocatoria, #id_lineainvestigacion, #id_sublineainvestigacion").addClass("validate[required]");
            {% if convocatoria.tipo == 2 %}
                $("#id_profesor").addClass("validate[required]");
                $("#id_tiempomes").addClass("validate[required, min[12], max[24]");
            {% else %}
                $("#id_montounemi").prop("readonly", "true");
                $("#id_tiempomes").addClass("validate[required, min[12], max[48]");
            {% endif %}
            $("#id_areaconocimiento, #id_subareaconocimiento, #id_subareaespecificaconocimiento, #id_programainvestigacion, #id_grupoinvestigacion").addClass("validate[required]");
            $("#id_industriapriorizada, #id_tipocobertura, #id_existeinscoejecutora").addClass("validate[required]");
            $("#id_montootrafuente").addClass("validate[required, min[0], max[999999.99]]");
            $("#id_representanteinsejec, #id_cedulainsejec, #id_telefonoinsejec, #id_emailinsejec, #id_direccioninsejec, #id_organoejecutorinsejec").addClass("validate[required]");
            $("#id_emailinsejec").addClass("validate[custom[email]]");

            let nf = {{ totalinscoejec }};
            let ultimoseleccionado = null;

            ItemsDisplay = function (item) {
                if (item.name || item.text){
                    if(item.name)
                        return $('<span>' + item.name+ '</span>');
                    else
                        return $('<span>' + item.text+ '</span>');
                }else{
                    return '-------------------------------------------';
                }
            };

            $("#id_profesor").select2({
                placeholder: "-------------------------------------------",
                language: {
                    inputTooShort: function () {
                        return "Ingresa al menos un caracter...";
                    },
                    "noResults": function () {
                        return "Sin resultados";
                    },
                    "searching": function () {
                        return "Buscando...";
                    },
                    "errorLoading": function () {
                        return "No se pudieron cargar los resultados...";
                    },
                },
                allowClear: true,
                ajax: {
                    url: function (params) {
                        return `/adm_proyectoinvestigacion?action=${accionbuscar}&q=${params.term}`;
                    },
                    dataType: 'json',
                    delay: 400,
                    data: function (params) {
                        return {
                            q: params.term,
                            page: params.page
                        };
                    },
                    processResults: function (data, params) {
                        // parse the results into the format expected by Select2
                        // since we are using custom formatting functions we do not need to
                        // alter the remote JSON data, except to indicate that infinite
                        // scrolling can be used
                        params.page = params.page || 1;

                        return {
                            results: data.results,
                            pagination: {
                                more: (params.page * 30) < data.total_count
                            }
                        };
                    },
                    cache: true
                },
                escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
                minimumInputLength: 1,
                templateResult: ItemsDisplay, // omitted for brevity, see the source of this page
                templateSelection: ItemsDisplay // omitted for brevity, see the source of this page
            }).on("select2:select", function (evt) {

            }).on("select2:unselect", function (evt) {

            });

            $('#id_categoria').change(function(){
                let idtp = $(this).val();
                $("#id_montomaximounemi").val('0.00');
                $("#id_porcentajeequipo").val("");
                if(idtp!=''){
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/adm_proyectoinvestigacion",
                        data: {'action': 'consultamontomaximo', 'idtp': idtp, 'idc': {{ convocatoria.id }} },
                        success: function (data) {
                            $.unblockUI();
                            if (data.result == 'ok') {
                                $("#id_montomaximounemi").val(data.montomaximo);
                                $("#id_porcentajeequipo").val(data.textoporcentaje);
                                {% if convocatoria.tipo == 2 %}
                                    $("#id_montounemi").addClass("validate[required, min[1], max["+data.montomaximo+"]]");
                                {% else %}
                                    $("#id_montootrafuente").addClass("validate[required, min[1], max["+data.montomaximo+"]]");
                                {% endif %}
                            } else {
                                control.val(0).trigger("change");
                                mensajeErrorSwal("No se puede consultar", data.mensaje);
                            }
                        },
                        error: function () {
                            $.unblockUI();
                            control.val(0).trigger("change");
                            mensajeErrorSwal("No se puede consultar", "Error de conexión");
                        },
                        dataType: "json"
                    });
                }
            });

            $('#id_areaconocimiento').change(function(){
                $('#id_subareaconocimiento, #id_subareaespecificaconocimiento').empty().append('<option value="">---------</option>').val(0).trigger("change");
                let control = $(this);
                let id = parseInt($("#id_areaconocimiento").val());
                if (id > 0) {
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/api",
                        data: {'a': 'subareaconocimiento', 'id': id},
                        success: function (data) {
                            $.unblockUI();
                            if (data.result == 'ok') {
                                for (elemento in data.lista) {
                                    $('#id_subareaconocimiento').append('<option value="' + data.lista[elemento][0] + '">' + data.lista[elemento][1] + '</option>');
                                }
                            } else {
                                control.val(0).trigger("change");
                                mensajeErrorSwal("No se puede consultar", data.mensaje);
                            }
                        },
                        error: function () {
                            $.unblockUI();
                            control.val(0).trigger("change");
                            mensajeErrorSwal("No se puede consultar", "Error de conexión");
                        },
                        dataType: "json"
                    });
                }
            });

            $('#id_subareaconocimiento').change(function(){
                $('#id_subareaespecificaconocimiento').empty().append('<option value="">---------</option>').val(0).trigger("change");
                let control = $(this);
                let id = parseInt($("#id_subareaconocimiento").val());
                if (id > 0) {
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/api",
                        data: {'a': 'subareaespecificaconocimiento', 'id': id},
                        success: function (data) {
                            $.unblockUI();
                            if (data.result == 'ok') {
                                for (elemento in data.lista) {
                                    $('#id_subareaespecificaconocimiento').append('<option value="' + data.lista[elemento][0] + '">' + data.lista[elemento][1] + '</option>');
                                }
                            } else {
                                control.val(0).trigger("change");
                                mensajeErrorSwal("No se puede consultar", data.mensaje);
                            }
                        },
                        error: function () {
                            $.unblockUI();
                            control.val(0).trigger("change");
                            mensajeErrorSwal("No se puede consultar", "Error de conexión");
                        },
                        dataType: "json"
                    });
                }
            });

            $('#id_lineainvestigacion').change(function(){
                $('#id_sublineainvestigacion').empty().append('<option value="">---------</option>').val(0).trigger("change");
                let control = $(this);
                let id = parseInt($("#id_lineainvestigacion").val());
                if (id > 0) {
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/api",
                        data: {'a': 'sublineainvestigacion', 'id': id},
                        success: function (data) {
                            $.unblockUI();
                            if (data.result == 'ok') {
                                for (elemento in data.lista) {
                                    $('#id_sublineainvestigacion').append('<option value="' + data.lista[elemento][0] + '">' + data.lista[elemento][1] + '</option>');
                                }
                            } else {
                                control.val(0).trigger("change");
                                mensajeErrorSwal("No se puede consultar", data.mensaje);
                            }
                        },
                        error: function () {
                            $.unblockUI();
                            control.val(0).trigger("change");
                            mensajeErrorSwal("No se puede consultar", "Error de conexión");
                        },
                        dataType: "json"
                    });
                }
            });

            $('#id_sublineainvestigacion').change(function() {
                if($(this).val() != null){
                    if($(this).val().length > 3)
                        $(this).val(ultimoseleccionado).trigger("change");
                    else
                        ultimoseleccionado = $(this).val();
                }
                else{
                    ultimoseleccionado = $(this).val();
                }
            });

            $("#id_requiereconvenio").change(function () {
                switchery["id_requiereconvenio"].setPosition(true);
            });

            $("#id_requiereconvenio").click(function () {
                $("#id_especificaconvenio").val('');
                if ($(this).is(':checked')) {
                    $("#id_especificaconvenio").addClass("validate[required]");
                    $("#fieldset_especificaconvenio").show();
                } else {
                    $("#id_especificaconveio").removeClass("validate[required]");
                    $("#fieldset_especificaconvenio").hide();
                }
            });

            $("#id_requierepermiso").change(function () {
                $("#id_especificapermiso").val('');
                if ($(this).is(':checked')) {
                    $("#id_especificapermiso").addClass("validate[required]");
                    $("#fieldset_especificapermiso").show();
                } else {
                    $("#id_especificapermiso").removeClass("validate[required]");
                    $("#fieldset_especificapermiso").hide();
                }
            });

            /*$("#id_requierepermiso").click(function () {
                $("#id_especificapermiso").val('');
                if ($(this).is(':checked')) {
                    $("#id_especificapermiso").addClass("validate[required]");
                    $("#fieldset_especificapermiso").show();
                } else {
                    $("#id_especificapermiso").removeClass("validate[required]");
                    $("#fieldset_especificapermiso").hide();
                }
            });*/

            $("#id_requiereparroquia").change(function () {
                $("#id_parroquia").val('');
                if ($(this).is(':checked')) {
                    $("#id_parroquia").addClass("validate[required]");
                    $("#fieldset_parroquia").show();
                } else {
                    $("#id_parroquia").removeClass("validate[required]");
                    $("#fieldset_parroquia").hide();
                }
            });

            $('#id_codigo').blur(function(){
                numerico($(this), 0, 999999999, 0);
            });

            $('#id_tiempomes').blur(function(){
                {% if convocatoria.tipo == 2 %}
                    numerico($(this), 1, 24, 0);
                {% else %}
                    numerico($(this), 1, 48, 0);
                {% endif %}
            });

            $('#id_montounemi').blur(function(){
                numerico($(this), 1, 999999, 2);
                let totalproyecto = parseFloat($("#id_montounemi").val()) + parseFloat($("#id_montootrafuente").val());
                $("#id_montototal").val(totalproyecto.toFixed(2));
            });

            $('#id_montootrafuente').blur(function(){
                numerico($(this), 0, 999999, 2);
                let totalproyecto = parseFloat($("#id_montounemi").val()) + parseFloat($("#id_montootrafuente").val());
                $("#id_montototal").val(totalproyecto.toFixed(2));
            });

            $("#id_tipocobertura").change(function() {
                let valor = $(this).val();
                ocultarcamposcobertura();
                $("#id_requiereparroquia").prop("checked", false);
                $("#id_zonas").val('').trigger('change');
                $("#id_provincias").val('').trigger('change');
                $("#id_provincia").val('').trigger('change');
                $("#id_canton").val('').trigger('change');
                $("#id_parroquia").val('');

                if(valor != '' && valor != '1' && valor != '2'){
                    if(valor == '3'){
                        $("#id_zonas").val('').trigger('change');
                        $("#id_zonas").addClass("validate[required]");
                        $("#fieldset_zonas").show();
                    }
                    else if(valor == '4'){
                        $("#id_provincias").val('').trigger('change');
                        $("#id_provincias").addClass("validate[required]");
                        $("#fieldset_provincias").show();
                    }
                    else{
                        $("#id_provincia").val('').trigger('change');
                        $("#id_provincia").addClass("validate[required]");
                        $("#fieldset_provincia").show();
                        $("#id_canton").val('').trigger('change');
                        $("#id_canton").addClass("validate[required]");
                        $("#fieldset_canton").show();
                        $("#fieldset_requiereparroquia").show();
                        switchery["id_requiereparroquia"].setPosition(false);
                    }
                }
            });

            $('#id_provincia').change(function(){
                $('#id_canton').empty().trigger('change');
                let control = $(this);
                let id = parseInt($("#id_provincia").val());
                if (id > 0) {
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/api",
                        data: {'a': 'cantones', 'id': id},
                        success: function (data) {
                            $.unblockUI();
                            if (data.result == 'ok') {
                                for (elemento in data.lista) {
                                    $('#id_canton').append('<option value="' + data.lista[elemento][0] + '">' + data.lista[elemento][1] + '</option>');
                                }
                            } else {
                                control.val(0).trigger("change");
                                mensajeErrorSwal("No se puede consultar", data.mensaje);
                            }
                        },
                        error: function () {
                            $.unblockUI();
                            control.val(0).trigger("change");
                            mensajeErrorSwal("No se puede consultar", "Error de conexión");
                        },
                        dataType: "json"
                    });
                }
            });

            $("#id_existeinscoejecutora").change(function () {
                let valor = $(this).val();

                if(valor == '1'){
                    mostrarcamposcoejecutora();
                }
                else{
                    ocultarcamposcoejecutora();
                }
            });

            ocultarcamposcobertura = function (){
                $("#fieldset_zonas").hide();
                $("#fieldset_provincias").hide();
                $("#fieldset_provincia").hide();
                $("#fieldset_canton").hide();
                $("#fieldset_requiereparroquia").hide();
                $("#fieldset_parroquia").hide();
                $("#id_requiereparroquia").prop("checked", false);

                $("#id_zonas").removeClass("validate[required]");
                $("#id_provincias").removeClass("validate[required]");
                $("#id_provincia").removeClass("validate[required]");
                $("#id_canton").removeClass("validate[required]");
                $("#id_parroquia").removeClass("validate[required]");
            };

            ocultarcamposcoejecutora = function (){
                $("#id_instituciones_aux").removeClass("validate[required]");
                $("#institucioncoejecutora").hide();
            };

            mostrarcamposcoejecutora = function (){
                $("#id_instituciones_aux").addClass("validate[required]");
                $("#id_instituciones_aux").val("");
                $("#institucioncoejecutora").show();
            };

            $(".agregainstitucion").click(function() {
                if(datosinstitucioncompleto()){
                    borrarFilaDefaultInstitucion();
                    nf += 1;

                    let nueva = '<tr id="fila_'+nf.toString()+'">'+
                          '  <td colspan="4">'+
                          '      <table class="table table-bordered">'+
                          '          <thead class="table-light">'+
                          '              <tr>'+
                          '                  <th colspan="4" style="text-align: right">'+
                          '                     <input type="hidden" value="0" id="idinstitucion[]" name="idinstitucion[]"> <a href="javascript:;" class="btn btn-tini btn-danger eliminaritem tu" idins="0" idf="'+nf.toString()+'" data-bs-toggle="tooltip" data-bs-placement="top" title="Eliminar"><i class="fa fa-remove"></i></a>'+
                          '                  </th>'+
                          '              </tr>'+
                          '          </thead>'+
                          '          <tbody>'+
                          '              <tr>'+
                          '                  <td width="20%" style="text-align: right">Institución:<input type="hidden" value="'+nf.toString()+'" id="idfilas[]" name="idfilas[]"></td>'+
                          '                  <td colspan="3"><input style="text-align: left; width: 100%; text-transform: uppercase" maxlength="250" id="nombreinscoejec'+nf.toString()+'" name="nombreinscoejec[]" type="text" value="" class="nombreinsco" > <div class="help-text" style="color: #dc1414; font-size: xx-small; margin-bottom: 0;"> </div></td>'+
                          '              </tr>'+
                          '              <tr>'+
                          '                  <td width="20%" style="text-align: right">Representante Legal:</td>'+
                          '                  <td colspan="3"><input style="text-align: left; width: 100%; text-transform: uppercase" maxlength="250" id="representanteinscoejec'+nf.toString()+'" name="representanteinscoejec[]" type="text" value="" class="repreinsco" > <div class="help-text" style="color: #dc1414; font-size: xx-small; margin-bottom: 0;"> </div></td>'+
                          '              </tr>'+
                          '              <tr>'+
                          '                  <td style="text-align: right">Identificación:</td>'+
                          '                  <td><input style="text-align: left; width: 100%; text-transform: uppercase" maxlength="20" id="cedulainscoejec'+nf.toString()+'" name="cedulainscoejec[]" type="text" value="" class="ceduinsco" > <div class="help-text" style="color: #dc1414; font-size: xx-small; margin-bottom: 0;"> </div></td>'+
                          '                  <td width="20%" style="text-align: right">e-mail:</td>'+
                          '                  <td><input style="text-align: left; width: 100%; text-transform: lowercase" maxlength="250" id="emailinscoejec'+nf.toString()+'" name="emailinscoejec[]" type="text" value="" class="emailinsco" > <div class="help-text" style="color: #dc1414; font-size: xx-small; margin-bottom: 0;"> </div></td>'+
                          '              </tr>'+
                          '              <tr>'+
                          '                  <td style="text-align: right">Teléfonos:</td>'+
                          '                  <td><input style="text-align: left; width: 100%; text-transform: uppercase" maxlength="50" id="telefonoinscoejec'+nf.toString()+'" name="telefonoinscoejec[]" type="text" value="" class="teleinsco" ></td>'+
                          '                  <td style="text-align: right">Fax:</td>'+
                          '                  <td><input style="text-align: left; width: 100%; text-transform: uppercase" maxlength="50" id="faxinscoejec'+nf.toString()+'" name="faxinscoejec[]" type="text" value="" class="faxinsco" ></td>'+
                          '              </tr>'+
                          '              <tr>'+
                          '                  <td style="text-align: right">Dirección:</td>'+
                          '                  <td colspan="3"><input style="text-align: left; width: 100%; text-transform: uppercase" maxlength="250" id="direccioninscoejec'+nf.toString()+'" name="direccioninscoejec[]" type="text" value="" class="dirinsco" ></td>'+
                          '              </tr>'+
                          '              <tr>'+
                          '                  <td style="text-align: right">Página Web:</td>'+
                          '                  <td colspan="3"><input style="text-align: left; width: 100%; text-transform: lowercase" maxlength="250" id="webinscoejec'+nf.toString()+'" name="webinscoejec[]" type="text" value="" class="webinsco" ></td>'+
                          '              </tr>'+
                          '          </tbody>'+
                          '      </table>'+
                          '  </td>'+
                          '</tr>'

                    $("#detalle_instituciones").append(nueva);
                    $("#nombreinscoejec"+nf.toString()).addClass("validate[required]");
                    {% if convocatoria.tipo == 2 %}
                        $("#representanteinscoejec"+nf.toString()).addClass("validate[required]");
                        $("#cedulainscoejec"+nf.toString()).addClass("validate[required]");
                        $("#emailinscoejec"+nf.toString()).addClass("validate[required, custom[email]]");
                    {% endif %}
                    $("#detalle_instituciones").find(".eliminaritem").tooltip();
                    $(".eliminaritem").unbind("click.eliminarItem");
                    $(".eliminaritem").bind("click.eliminarItem", eliminarItem);

                    $(".valorescedula").unbind("blur.valoresCedula");
                    $(".valorescedula").bind("blur.valoresCedula", valoresCedula);

                }else{
                    mensajeWarningSwal("No se puede agregar más filas", "Ingrese los campos obligatorios de la institución co-ejecutora (Institución, representante legal, identificación y e-mail");
                }
            });

            datosinstitucioncompleto = function (){
                let c1e = true, c2e = true;
                let c3e = true, c4e = true;
                let c5e = true, c6e = true;
                let c7e = true;

                $('input[name="nombreinscoejec[]"]').each(function() {
                    if($(this).val().trim()==''){
                        c1e = false;
                        return false;
                    }
                });

                {% if convocatoria.tipo == 2 %}
                    $('input[name="representanteinscoejec[]"]').each(function() {
                        if($(this).val().trim()==''){
                            c2e = false;
                            return false;
                        }
                    });

                    $('input[name="cedulainscoejec[]"]').each(function() {
                        if($(this).val().trim()==''){
                            c3e = false;
                            return false;
                        }
                    });

                    $('input[name="emailinscoejec[]"]').each(function() {
                        if($(this).val().trim()==''){
                            c4e = false;
                            return false;
                        }
                    });
                {% endif %}
                /*$('input[name="telefonoinscoejec[]"]').each(function() {
                    if($(this).val().trim()==''){
                        c5e = false;
                        return false;
                    }
                });

                $('input[name="direccioninscoejec[]"]').each(function() {
                    if($(this).val().trim()==''){
                        c6e = false;
                        return false;
                    }
                });

                $('input[name="webinscoejec[]"]').each(function() {
                    if($(this).val().trim()==''){
                        c7e = false;
                        return false;
                    }
                });*/

                return (c1e && c2e && c3e && c4e && c5e && c6e && c7e);
            };

            agregarFilaDefaultInstitucion = function (){
                let filadefault = '<tr id="fila_default_institucion">'+
                                '<td colspan="4" style="text-align: center">NO EXISTEN DETALLES DE INSTITUCIONES CO-EJECUTORAS</td>'+
                                '</tr>';
                $("#detalle_instituciones").append(filadefault);
                $("#id_instituciones_aux").addClass("validate[required]");
                $("#id_instituciones_aux").val("");
            };

            borrarFilaDefaultInstitucion = function (){
                $("#fila_default_institucion").remove();
                $("#id_instituciones_aux").removeClass("validate[required]");
            };

            eliminarItem = function() {
                $(this).tooltip('hide');
                let id = $(this).attr("idf");
                let idinstitucion = $(this).attr("idins");

                if(idinstitucion != '0'){
                    var item = {idinstitucion: idinstitucion};
                    lista_items1.push(item)
                }

                $("#fila_"+id).remove();

                if($("#detalle_instituciones").children().length == 0)
                    agregarFilaDefaultInstitucion();
            };

            valoresCedula = function (){
                //digitos($(this));
            };

            ocultarcamposcobertura();
            ocultarcamposcoejecutora();
            $("#fieldset_especificapermiso").hide();
            $("#fieldset_especificaconvenio").hide();

            $("#id_titulo, #id_especificapermiso, #id_especificaconvenio").css('text-transform','none');
            $("#id_emailinsejec, #id_emailinscoejec, #id_paginawebinsejec, #id_paginawebinscoejec").css('text-transform','lowercase');
            $("#id_parroquia").css('text-transform','uppercase');

            if($('#id_requiereconvenio').attr('checked')){
                $("#fieldset_especificaconvenio").show();
                $("#id_especificaconvenio").addClass("validate[required]");
            }else{
                $("#fieldset_especificaconvenio").hide();
                $("#id_especificaconvenio").removeClass("validate[required]");
            }

            if($('#id_requierepermiso').attr('checked')){
                $("#fieldset_especificapermiso").show();
                $("#id_especificapermiso").addClass("validate[required]");
            }else{
                $("#fieldset_especificapermiso").hide();
                $("#id_especificapermiso").removeClass("validate[required]");
            }

            if($('#id_requiereparroquia').attr('checked')){
                $("#fieldset_parroquia").show();
                $("#id_parroquia").addClass("validate[required]");
            }else{
                $("#fieldset_parroquia").hide();
                $("#id_parroquia").removeClass("validate[required]");
            }

            let cobertura = parseInt($("#id_tipocobertura").val());
            if (cobertura == 5){
                $("#fieldset_provincia").show();
                $("#fieldset_canton").show();
                $("#fieldset_requiereparroquia").show();
                $("#id_provincia").addClass("validate[required]");
                $("#id_canton").addClass("validate[required]");
            }else if (cobertura == 4){
                $("#fieldset_provincias").show();
                $("#id_provincias").addClass("validate[required]");
            }else if (cobertura == 3){
                $("#fieldset_zonas").show();
                $("#id_zonas").addClass("validate[required]");
            }

            if($('#id_existeinscoejecutora').val()=='1'){
                mostrarcamposcoejecutora();
            }else{
                ocultarcamposcoejecutora();
            }

            $("#id_categoria").val('{{ proyecto.categoria2.id }}').trigger('change');

            {% if parroquia %}
                $("#fieldset_requiereparroquia").show();
                $("#id_requiereparroquia").prop("checked", true);
                $("#fieldset_parroquia").show();
                $("#id_parroquia").val("{{ parroquia }}");
                $("#id_parroquia").addClass("validate[required]");
            {% endif %}

            {% if presupequip %}
                $("#id_compraequipo").attr('disabled', 'disabled');
            {% endif %}

            $("#id_instituciones_aux").removeClass("validate[required]");

            agregarValidacionDetalleInstituciones = function (){
                $(".nombreinsco").each(function(){
                    $(this).addClass("validate[required]");
                });
                {% if convocatoria.tipo == 2 %}
                    $(".repreinsco").each(function(){
                        $(this).addClass("validate[required]");
                    });

                    $(".ceduinsco").each(function(){
                        $(this).addClass("validate[required]");
                    });

                    $(".emailinsco").each(function(){
                        $(this).addClass("validate[required, custom[email]]");
                    });
                {% endif %}
            };

            agregarValidacionDetalleInstituciones();
            $(".eliminaritem").unbind("click.eliminarItem");
            $(".eliminaritem").bind("click.eliminarItem", eliminarItem);

            {% if proyecto.archivodocumento %}
                $("#viewdocumento").click(function (){
                    Fancybox.show([
                        {
                            src: "{{ proyecto.archivodocumento.url }}",
                            width: 2048,
                            height: 1365,
                            caption:"Documento Inscripción"
                        },
                    ]);
                });
            {% else %}
                $("#viewdocumento").hide();
            {% endif %}

            {% if proyecto.profesor %}
                let data;
                let newOption
                data = {
                    id: {{ proyecto.profesor.id }},
                    text: '{{ proyecto.profesor.persona.nombre_completo_inverso }}'
                };
                newOption = new Option(data.text, data.id, true, true);
                $('#id_profesor').append(newOption).trigger('change');
            {% endif %}

            $(':input[readonly]').css({'cursor':'not-allowed'});
            $('textarea').css({'padding':'3px', 'resize':'none'});

        });
    </script>
{% endblock %}
{% block atras %}/adm_proyectoinvestigacion?action=propuestasold&idc={{ convocatoria.id|encrypt }}{% endblock %}
{% block titulo %}{{ title }}{% endblock %}
{% block formaction %}/adm_proyectoinvestigacion?action=propuestasold&idc={{ convocatoria.id|encrypt }}{% endblock %}
{% block formdestinationswal %}/adm_proyectoinvestigacion?action=propuestasold&idc={{ convocatoria.id|encrypt }}{% endblock %}
{% block formextra %}
    <input type='hidden' name='action' value='editpropuestaproyectoexterno'/>
    <input type='hidden' name='id' value='{{ id }}'/>
    <input type='hidden' name='idc' value='{{ convocatoria.id|encrypt }}'/>
{% endblock %}
{% block formback %}/adm_proyectoinvestigacion?action=propuestasold&idc={{ convocatoria.id|encrypt }}{% endblock %}
{% block buttonname %}Guardar{% endblock %}
{% block formsuffix %}
    <div class="row-fluid" id="institucioncoejecutora">
        <div style="width: 100%; height: max-content; display: inline-block">
            <h6 style="width:100%; text-align:left; border-bottom: 1px solid #98a3ab; line-height:0.1em; margin:10px 0 20px;"><span style="padding:0 10px; background: white;">Instituciones Participantes Co-Ejecutoras</span></h6>
        </div>
        <table class="table table-bordered" id="tbcomite">
            <thead class="table-light">
            <tr>
                <th colspan="4" style="text-align: right">
                    <a href="javascript:;" class="btn btn-success btn-mini agregainstitucion" data-bs-toggle="tooltip" data-bs-placement="top" title="Agregar Institución"><i class="fa fa-plus"></i> Agregar</a>
                </th>
            </tr>
            </thead>
            <tbody id="detalle_instituciones">
                {% for institucion in inscoejecutoras %}
                    <tr id="fila_{{ forloop.counter }}">
                        <td colspan="4">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th colspan="4" style="text-align: right">
                                           <input type="hidden" value="{{ institucion.id }}" id="idinstitucion[]" name="idinstitucion[]"> <a href="javascript:;" class="btn btn-tini btn-danger eliminaritem tu" idins="{{ institucion.id }}" idf="{{ forloop.counter }}" data-bs-toggle="tooltip" data-bs-placement="top" title="Eliminar"><i class="fa fa-remove"></i></a>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td width="20%" style="text-align: right">Institución:<input type="hidden" value="{{ forloop.counter }}" id="idfilas[]" name="idfilas[]"></td>
                                        <td colspan="3"><input style="text-align: left; width: 100%; text-transform: uppercase" maxlength="250" id="nombreinscoejecnf{{ forloop.counter }}" name="nombreinscoejec[]" type="text" value="{{ institucion.nombre }}" class="nombreinsco" > <div class="help-text" style="color: #dc1414; font-size: xx-small; margin-bottom: 0;"> </div></td>
                                    </tr>
                                    <tr>
                                        <td width="20%" style="text-align: right">Representante Legal:</td>
                                        <td colspan="3"><input style="text-align: left; width: 100%; text-transform: uppercase" maxlength="250" id="representanteinscoejecnf{{ forloop.counter }}" name="representanteinscoejec[]" type="text" value="{{ institucion.representante }}" class="repreinsco" > <div class="help-text" style="color: #dc1414; font-size: xx-small; margin-bottom: 0;"> </div></td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: right">Identificación:</td>
                                        <td><input style="text-align: left; width: 100%; text-transform: uppercase" maxlength="20" id="cedulainscoejecnf{{ forloop.counter }}" name="cedulainscoejec[]" type="text" value="{{ institucion.cedula }}" class="ceduinsco" > <div class="help-text" style="color: #dc1414; font-size: xx-small; margin-bottom: 0;"> </div></td>
                                        <td width="20%" style="text-align: right">e-mail:</td>
                                        <td><input style="text-align: left; width: 100%; text-transform: lowercase" maxlength="250" id="emailinscoejecnf{{ forloop.counter }}" name="emailinscoejec[]" type="text" value="{{ institucion.email }}" class="emailinsco" > <div class="help-text" style="color: #dc1414; font-size: xx-small; margin-bottom: 0;"> </div></td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: right">Teléfonos:</td>
                                        <td><input style="text-align: left; width: 100%; text-transform: uppercase" maxlength="50" id="telefonoinscoejecnf{{ forloop.counter }}" name="telefonoinscoejec[]" type="text" value="{{ institucion.telefono }}" class="teleinsco" ></td>
                                        <td style="text-align: right">Fax:</td>
                                        <td><input style="text-align: left; width: 100%; text-transform: uppercase" maxlength="50" id="faxinscoejecnf{{ forloop.counter }}" name="faxinscoejec[]" type="text" value="{{ institucion.fax }}" class="faxinsco" ></td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: right">Dirección:</td>
                                        <td colspan="3"><input style="text-align: left; width: 100%; text-transform: uppercase" maxlength="250" id="direccioninscoejecnf{{ forloop.counter }}" name="direccioninscoejec[]" type="text" value="{{ institucion.direccion }}" class="dirinsco" ></td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: right">Página Web:</td>
                                        <td colspan="3"><input style="text-align: left; width: 100%; text-transform: lowercase" maxlength="250" id="webinscoejecnf{{ forloop.counter }}" name="webinscoejec[]" type="text" value="{{ institucion.paginaweb }}" class="webinsco" ></td>
                                    </tr>
                                </tbody>
                            </table>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <input style="visibility: hidden; width: 0px; height: 0px; " type="text" id="id_instituciones_aux" value="">
        <div class="help-text" style="color: #dc1414;font-size: xx-small; margin-bottom: 0; height: 13px; line-height: 13px"></div>
    </div>
{% endblock %}