{% extends "basebs.html" %}
{% load sga_extras %}
{% block heading %}
    <link href="/static/css/table-responsive.css?1.0.0" type="text/css" rel="stylesheet" />
    <link href="/static/widget_ppp.css" rel="stylesheet"/>
    <style type="text/css">

        .radio label,
        .checkbox label {
            display: inline-block;
            cursor: pointer;
            color: #0074D9;
            position: relative;
            padding: 5px 15px 5px 51px;
            font-size: 1em;
            border-radius: 5px;
            -webkit-transition: all 0.3s ease;
            -o-transition: all 0.3s ease;
            transition: all 0.3s ease; }
        .radio label:hover,
        .checkbox label:hover {
            background: rgba(255, 65, 54, 0.1); }
        .radio label:before,
        .checkbox label:before {
            content: "";
            display: inline-block;
            width: 17px;
            height: 17px;
            position: absolute;
            left: 15px;
            border-radius: 50%;
            background: none;
            border: 3px solid #0074D9; }
        input[type="radio"] {
            display: none; }
        input[type="radio"]:checked + label:before {
            display: none; }
        input[type="radio"]:checked + label {
            padding: 5px 15px;
            background: #0074D9;
            border-radius: 2px;
            color: #fff; }
        .checkbox label:before {
            border-radius: 3px; }
        .checkbox input[type="checkbox"] {
            display: none; }
        .checkbox input[type="checkbox"]:checked + label:before {
            display: none; }
        .checkbox input[type="checkbox"]:checked + label {
            background: #0074D9;
            color: #fff;
            padding: 5px 15px; }
    </style>
    <script type="text/javascript">
        var isMobile = {
            Android: function() {
                return navigator.userAgent.match(/Android/i);
            },
            BlackBerry: function() {
                return navigator.userAgent.match(/BlackBerry/i);
            },
            iOS: function() {
                return navigator.userAgent.match(/iPhone|iPad|iPod/i);
            },
            Opera: function() {
                return navigator.userAgent.match(/Opera Mini/i);
            },
            Windows: function() {
                return navigator.userAgent.match(/IEMobile/i);
            },
            any: function() {
                return (isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Opera() || isMobile.Windows());
            }
        };

        $.extend(true, $.fn.dataTable.defaults, {
            oLanguage: {
                sSearch: "<span>Filtro:</span> _INPUT_",
                sLengthMenu: "<span>Mostrar Entradas:</span> _MENU_",
                sZeroRecords: "No se encontraron resultados",
                sProcessing: "Procesando...",
                sEmptyTable: "Ningún dato disponible para visualizar",
                sInfo: "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                sInfoEmpty: "Mostrando registros del 0 al 0 de un total de 0 registros",
                sLoadingRecords: "Cargando...",
                oPaginate: {
                    sFirst: "<i title='Inicio' class='fa fa-step-backward'></i>",
                    sLast: "<i title='Último' class='fa fa-step-forward'></i>",
                    sNext: "<i title='Siguiente' class='fa fa-fast-forward'></i>",
                    sPrevious: "<i title='Anterior' class='fa fa-fast-backward'></i>"
                },
            }
        });

        var ControllerSolicitudes = {
            init: function (){
                var self = this;
                self.$table = $('.datatable table');
                $('[name="tipo_motivo"], [name="estado"]').change(function(){
                    self.$table.dataTable().fnDraw();
                });

                $('[name="tipo_incoveniente"]').change(function(){
                    let tipo_incoveniente = $(this).val();
                    $('[name="tipo_motivo"]').empty().append('<option value="">--TODOS--</option>').val(0).trigger("change");
                    $.ajax({
                        type: "GET",
                        url: "/reportes",
                        data: {"action": 'data', 'model': 'MotivoTipoInconvenienteClaseDiferido:tipo_id='+tipo_incoveniente, 'q': '' },
                        success: function(data) {
                            //$.unblockUI();
                            if (data.result == 'ok') {
                                for (let elemento in data.results) {
                                    $('[name="tipo_motivo"]').append('<option value="' + data.results[elemento]['id'] + '">' + data.results[elemento]['name'] + '</option>');
                                }
                                self.$table.dataTable().fnDraw();
                            }
                            else{
                                NotificationJG.error(data.mensaje);
                            }
                        },
                        error: function() {
                            //$.unblockUI();
                            NotificationJG.error("Error al enviar los datos.");
                        },
                        dataType: "json",
                    });
                });
                $('select').select2({minimumResultsForSearch: 20,})
                self.loadDataTable();
                $("#action_min").click(function(){
                    $("#panel_filter .panel-body").hide();
                    $("#action_min").hide();
                    $("#action_max").show();
                });
                $("#action_max").click(function(){
                    $("#panel_filter .panel-body").show();
                    $("#action_min").show();
                    $("#action_max").hide();
                });

                $(".action-add").click(function(){
                    uiModal.open('new', 0)

                });

                $(".action-view-class-check").click(function(){
                    let idp = $(this).attr('idp');
                    uiViewClassCheckModal.open(idp);

                });

                $("#action_min").trigger("click");
            },
            loadDataTable: function(){
                var self = this;
                self.$table.dataTable({
                    responsive: true,
                    searchDelay: 1000,
                    bJQueryUI: false,
                    bAutoWidth: false,
                    //bProcessing: true,
                    bServerSide: true,
                    bSort: false,
                    sPaginationType: "full_numbers",
                    iDisplayLength: 25,
                    sDom: '<"datatable-header"fl><"datatable-scroll"tr><"datatable-footer"ip>',
                    sAjaxSource: "/pro_aperturaclase",
                    sServerMethod: "POST",
                    /*search:{
                        return: console.log("pasa")
                    },*/
                    fnServerParams: function (aoData)
                    {
                        console.log(aoData);
                        bloqueointerface();
                        /*var valida_asistencia = $('[name="filter_valida_asistencia"]:checked').val();
                        var visible = $('[name="filter_visible"]:checked').val();
                        var activo = $('[name="filter_activo"]:checked').val();
                        var visiblehorario = $('[name="filter_visiblehorario"]:checked').val();
                        var matriculacionactiva = $('[name="filter_matriculacionactiva"]:checked').val();

                        var crontabactivo = $('[name="filter_crontabactivo"]:checked').val();*/
                        var type_request = $('[name="tipo_incoveniente"]').val();
                        var type_motive = $('[name="tipo_motivo"]').val();
                        var state = $('[name="estado"]').val();
                        aoData.push(
                            {"name": "action", "value": 'loadDataTable'},
                            {"name": "type_request", "value": type_request},
                            {"name": "type_motive", "value": type_motive},
                            {"name": "state", "value": state}
                        );
                        //console.log(aoData);
                    },
                    aoColumnDefs:
                        [
                            {
                                aTargets: [0],
                                width: "25%",
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'left');
                                        $(nTd).css('vertical-align', 'middle');
                                        $(nTd).css('padding', '8px');

                                    }
                                }
                            },
                            {
                                aTargets: [1],
                                width: "7%",
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center');
                                        $(nTd).css('vertical-align', 'middle');
                                        $(nTd).css('padding', '8px');
                                        $(nTd).attr('data-title', 'Turno');
                                    }
                                }
                            },
                            {
                                aTargets: [2],
                                width: "9%",
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center');
                                        $(nTd).css('vertical-align', 'middle');
                                        $(nTd).css('padding', '8px');
                                        $(nTd).attr('data-title', 'Fecha Diferido');
                                    }
                                }
                            },
                            {
                                aTargets: [3],
                                width: "9%",
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center')
                                        $(nTd).css('vertical-align', 'middle')
                                        $(nTd).css('padding', '8px')
                                        $(nTd).attr('data-title', 'Fecha Solicitud');
                                    }
                                }
                            },
                            {
                                aTargets: [4],
                                width: "10%",
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center');
                                        $(nTd).css('vertical-align', 'middle');
                                        $(nTd).css('padding', '8px');
                                        $(nTd).attr('data-title', 'Incoveniente');
                                    }
                                }
                            },
                            {
                                aTargets: [5],
                                width: "8%",
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center');
                                        $(nTd).css('vertical-align', 'middle');
                                        $(nTd).css('padding', '8px');
                                        $(nTd).attr('data-title', 'Motivo');
                                    }
                                }
                            },
                            {
                                aTargets: [6],
                                width: "8%",
                                mRender: function (data, type, row)
                                {
                                    var html = '';
                                    if (data){
                                        html += `<a target="_blank" href='${data}' class='btn btn-info btn-mini tu' title="Descargar"><i class="fa fa-arrow-down"></i></a>`;
                                    }else{
                                        html += `<label class="label label-info">Sin Archivo</label>`;
                                    }
                                    return html;
                                },
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center');
                                        $(nTd).css('vertical-align', 'middle');
                                        $(nTd).css('padding', '8px');
                                        $(nTd).attr('data-title', 'Archivo');
                                    }
                                }
                            },
                            {
                                aTargets: [7],
                                width: "8%",
                                mRender: function (data, type, row)
                                {
                                    var html = '';
                                    if (data == 'PENDIENTE'){
                                        html += `<label class="label label-warning">Pendiente</label>`;
                                    }else if (data == 'APROBADO'){
                                        html += `<label class="label label-success">Aprobado</label>`;
                                    }else{
                                        html += `<label class="label label-important">Rechazado</label>`;
                                    }
                                    return html;
                                },
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center');
                                        $(nTd).css('vertical-align', 'middle');
                                        $(nTd).css('padding', '8px');
                                        $(nTd).attr('data-title', 'Estado');
                                    }
                                }
                            },
                            {
                                aTargets: [8],
                                width: "15%",
                                mRender: function (data, type, row)
                                {
                                    return `<input type="hidden" class="dt-col-option" value="${data["id"]}"/> <input type="hidden" class="dt-col-data-text" value="${data["text"]}"/> <input type="hidden" class="dt-col-data-estado" value="${data["estado"]}"/> <input type="hidden" class="dt-col-data-aperturada" value="${data["aperturada"]}"/> <input type="hidden" class="dt-col-data-existe_toma_asistencia" value="${data["existe_toma_asistencia"]}"/> <input type="hidden" class="dt-col-data-esta_aprobada" value="${data["esta_aprobada"]}"/> <input type="hidden" class="dt-col-data-tiposolicitud" value="${data["tiposolicitud"]}"/> <input type="hidden" class="dt-col-data-reemplazo" value="${data["reemplazo"]}"/> <input type="hidden" class="dt-col-data-profesor_principal_id" value="${data["profesor_principal_id"]}"/> <input type="hidden" class="dt-col-data-en_fecha" value="${data["en_fecha"]}"/> <input type="hidden" class="dt-col-data-coordinacion_id" value="${data["coordinacion_id"]}"/> <input type="hidden" class="dt-col-data-debe_subir_enlace" value="${data["debe_subir_enlace"]}"/> <input type="hidden" class="dt-col-data-tiene_enlace_diferido" value="${data["tiene_enlace_diferido"]}"/> <input type="hidden" class="dt-col-data-codigo_enlace_diferido" value="${data["codigo_enlace_diferido"]}"/> <input type="hidden" class="dt-col-data-tiene_clase_abierta" value="${data["tiene_clase_abierta"]}"/> <input type="hidden" class="dt-col-data-clase_lecciongrupo" value="${data["clase_lecciongrupo"]}"/> <input type="hidden" class="dt-col-data-clase_leccion" value="${data["clase_leccion"]}"/>`;
                                },
                                fnCreatedCell: function(nTd, sData, oData, iRow, iCol)
                                {
                                    if(sData != 'NULL') {
                                        $(nTd).css('text-align', 'center')
                                        $(nTd).css('vertical-align', 'middle')
                                        $(nTd).css('padding', '8px')
                                    }
                                }
                            },
                        ]
                    ,
                    fnDrawCallback: function (oSettingst)
                    {
                        bloqueointerface();
                        /*console.log(oSettingst);
                        let api = this.api();
                        console.log(api);*/
                        var count = 0;

                        $('.dt-col-option').each(function(){
                            var id = $(this).val();
                            var text = $('.dt-col-data-text').eq(count).val();
                            var estado = $('.dt-col-data-estado').eq(count).val();
                            var aperturada = $('.dt-col-data-aperturada').eq(count).val() == 1;
                            var existe_toma_asistencia = $('.dt-col-data-existe_toma_asistencia').eq(count).val() == 1;
                            var tiene_enlace_diferido = $('.dt-col-data-tiene_enlace_diferido').eq(count).val() == 1;
                            var esta_aprobada = $('.dt-col-data-esta_aprobada').eq(count).val() == 1;
                            var tiposolicitud = $('.dt-col-data-tiposolicitud').eq(count).val();
                            var reemplazo = $('.dt-col-data-reemplazo').eq(count).val() == 1;
                            var profesor_principal_id = $('.dt-col-data-profesor_principal_id').eq(count).val();
                            var en_fecha = $('.dt-col-data-en_fecha').eq(count).val() == 1;
                            var coordinacion_id = $('.dt-col-data-coordinacion_id').eq(count).val();
                            var debe_subir_enlace = $('.dt-col-data-debe_subir_enlace').eq(count).val();
                            var codigo_enlace_diferido = $('.dt-col-data-codigo_enlace_diferido').eq(count).val();
                            var tiene_clase_abierta = $('.dt-col-data-tiene_clase_abierta').eq(count).val() == 1;
                            var idlg = $('.dt-col-data-clase_lecciongrupo').eq(count).val();
                            var idl = $('.dt-col-data-clase_leccion').eq(count).val();
                            var $html = $('#el-templates [element="table-row-actions"] .table-controls').clone();
                            //console.log(existe_toma_asistencia);

                            if (!existe_toma_asistencia && !tiene_enlace_diferido){
                                $('.dt_action_delete', $html).click(function(){
                                    var question_delete = `<p>Al eliminar el registro no podra volver a recuperar los datos.</p> <p style="text-align: center; font-size: medium">¿Está seguro/a de eliminar la solicitud?</p><p><b>${text}</b></p>`;
                                    Confirm.question(question_delete, function () {
                                        bloqueointerface();
                                        var aData = {"action": "deleteRequest", 'id': id}
                                        $.ajax({
                                            type: "POST",
                                            url: "/pro_aperturaclase",
                                            data: aData,
                                            success: function(data) {
                                                if (data.result == 'ok') {
                                                    self.$table.dataTable().fnDraw(false);
                                                    //NotificationJG.success(data.mensaje)
                                                    Swal.fire({
                                                        toast: true,
                                                        position: 'top-end',
                                                        type: 'success',
                                                        title: data.mensaje,
                                                        showConfirmButton: false,
                                                        timer: 6000
                                                    });
                                                }
                                                else{
                                                    //NotificationJG.error(data.mensaje);
                                                    Swal.fire({
                                                        toast: true,
                                                        position: 'top-end',
                                                        type: 'error',
                                                        title: data.mensaje,
                                                        showConfirmButton: false,
                                                        timer: 6000
                                                    });
                                                }
                                                $.unblockUI();
                                            },
                                            error: function() {
                                                $.unblockUI();
                                                //NotificationJG.error("Error al enviar los datos.");
                                                Swal.fire({
                                                    toast: true,
                                                    position: 'top-end',
                                                    type: 'error',
                                                    title: "Error al enviar los datos.",
                                                    showConfirmButton: false,
                                                    timer: 6000
                                                });
                                            },
                                            dataType: "json",
                                        });
                                    }, function () {
                                        NotificationJG.info("Enhorabuena el registro esta salvado.!");
                                    });
                                });
                                $('.dt_action_delete', $html).removeClass('disabled').removeClass('hidden');
                            }

                            if (esta_aprobada && !aperturada && !tiene_clase_abierta){
                                //if (true){
                                $(".dt_action_open_clase", $html).removeClass('disabled').removeClass('hidden');
                                $('.dt_action_open_clase', $html).click(function(){
                                    var question_open = `<p style="text-align: center; font-size: medium">¿Está seguro/a de aperturar la clase de la solicitud?</p> <p><b>${text}</b></p>`;
                                    Confirm.question(question_open, function () {
                                        let re = reemplazo;
                                        let ids = id;
                                        let idp = profesor_principal_id;
                                        bloqueointerface();
                                        if (re == false) {
                                            var aData = {'action': 'nuevaleccion', 'solicitud': id};
                                        } else {
                                            var aData = {
                                                'action': 'nuevaleccion',
                                                'solicitud': id,
                                                'reemplazo': 'true',
                                                'reemplazoid': idp,
                                                'apertura': '1'
                                            }
                                        }

                                        $.ajax({
                                            type: "POST",
                                            url: "/pro_clases",
                                            data: aData,
                                            success: function(data) {
                                                if (data.result == 'ok') {
                                                    self.$table.dataTable().fnDraw(false);
                                                    bloqueointerface();
                                                    location.href = "/pro_clases?action=view&id=" + data.lg + "&idl=" + data.idlec + "&ret=/pro_aperturaclase";
                                                    bloqueointerface();
                                                    //NotificationJG.success(data.mensaje);
                                                }
                                                else{
                                                    NotificationJG.error(data.mensaje);
                                                }
                                                $.unblockUI();
                                            },
                                            error: function() {
                                                $.unblockUI();
                                                NotificationJG.error("Error al enviar los datos.");
                                            },
                                            dataType: "json",
                                        });
                                    }, function () {
                                        NotificationJG.info("Enhorabuena solicitud de asistencia no fue aperturada.!");
                                    });
                                });
                            }

                            if (esta_aprobada && aperturada && tiene_clase_abierta){
                                $(".dt_action_continue_clase", $html).removeClass('disabled').removeClass('hidden');
                                $('.dt_action_continue_clase', $html).click(function(){
                                    // location.href = "/pro_clases?action=view&id=" + data.lg + "&idl=" + data.idlec + "&ret=/pro_aperturaclase";
                                    bloqueointerface();
                                    location.href = "/pro_clases?action=view&id=" + idlg + "&idl=" + idl + "&ret=/pro_aperturaclase";
                                    bloqueointerface();
                                });
                            }

                            if (esta_aprobada && aperturada && !tiene_clase_abierta) {

                                $(".dt_action_view_clase", $html).removeClass('disabled').removeClass('hidden');
                                $('.dt_action_view_clase', $html).click(function(){
                                    // location.href = "/pro_clases?action=view&id=" + data.lg + "&idl=" + data.idlec + "&ret=/pro_aperturaclase";
                                    /*bloqueointerface();
                                    location.href = "/pro_clases?action=view&id=" + idlg + "&idl=" + idl + "&ret=/pro_aperturaclase";
                                    bloqueointerface();*/
                                    uiViewClassModal.open(text, idlg, idl);
                                });
                            }
                            console.log(esta_aprobada && aperturada, debe_subir_enlace != 0 ,!tiene_enlace_diferido)
                            console.log(esta_aprobada && aperturada && debe_subir_enlace && !tiene_enlace_diferido)
                            if (esta_aprobada && aperturada && debe_subir_enlace != 0 && !tiene_enlace_diferido){
                                $(".dt_action_create_video", $html).removeClass('disabled').removeClass('hidden');
                                $('.dt_action_create_video', $html).click(function(){
                                    uiCreateVideoModal.open(text, id);
                                });
                            }

                            if (esta_aprobada && aperturada && tiene_enlace_diferido && codigo_enlace_diferido > 0){
                                $(".dt_action_view_video", $html).removeClass('disabled').removeClass('hidden');
                                let url = "";
                                if (coordinacion_id == 9){
                                    url = `https://aulanivelacion.unemi.edu.ec/mod/url/view.php?id=${codigo_enlace_diferido}`;
                                }else{
                                    url = `https://aulagrado.unemi.edu.ec/mod/url/view.php?id=${codigo_enlace_diferido}`;
                                }
                                $(".dt_action_view_video", $html).attr('href', url)
                                /*$('.dt_action_view_video', $html).click(function(){
                                    uiCreateVideoModal.open(text, id);
                                });*/

                            }

                            /*$('.dt-action-view', $html).click(function(){
                                uiModal.open('view', id);
                            });

                            $('.dt-action-edit', $html).click(function(){
                                uiModal.open('edit', id);
                            });

                            $('.dt-action-groups', $html).click(function(){
                                var typeform = $(this).attr('typeform');
                                uiGroupModal.open(typeform, id);
                            });

                            $('.dt-action-matriculacion', $html).click(function(){
                                var typeform = $(this).attr('typeform');
                                uiMatriculacionModal.open(typeform, id);
                            });*/

                            count ++;
                            $(this).after( $html );
                        });
                        $.unblockUI();
                    }

                });
                $('#dtViewSolicitudes_filter input').after(` <a href="javascript:;" class="btn btn-inverse action-search-request">Buscar</a> <a href="javascript:;" class="btn btn-info action-clear-search hidden"><i class="fa fa-close"></i></a>`);

                $("#dtViewSolicitudes_filter input").unbind(); // 'x' es el nombre de tu tabla
                $('#dtViewSolicitudes_filter input').bind('keyup', function (e) {
                    //console.log($('#dtViewSolicitudes_filter input').val().length);
                    $(".action-clear-search", $('#dtViewSolicitudes_filter')).addClass('hidden');
                    if ($('#dtViewSolicitudes_filter input').val().length > 0)
                    {
                        $(".action-clear-search", $('#dtViewSolicitudes_filter')).removeClass('hidden');
                    }

                    if (e.keyCode == 13) {
                        //console.log(this.value);
                        self.$table.dataTable().fnFilter(this.value);
                    }
                    if ($('#dtViewSolicitudes_filter input').val().length == 0)
                    {
                        $('#dtViewSolicitudes_filter input').val('').change();
                        self.$table.dataTable().fnFilter("");
                    }
                });
                $(".action-search-request", $('#dtViewSolicitudes_filter')).click(function (){
                    let text = $('#dtViewSolicitudes_filter input').val();
                    if ( text != ''){
                        self.$table.dataTable().fnFilter(text);
                    }else{
                        NotificationJG.warning("Texto a buscar esta vacío.");
                        $('#dtViewSolicitudes_filter input').focus();
                    }

                });
                $(".action-clear-search", $('#dtViewSolicitudes_filter')).click(function (){
                    $('#dtViewSolicitudes_filter input').val('').change();
                    self.$table.dataTable().fnFilter("");
                    $(".action-clear-search", $('#dtViewSolicitudes_filter')).addClass('hidden');
                });

            }

        };

        var uiModal = {
            init: function () {
                var self = this;
                self.$modalForm = $('#modalRequest');
                $('.action-close', self.$modalForm).click(function(){
                    self.close();
                });
                /*$('.action-edit', self.$modalForm).click(function(){
                    self.setFormType('edit');
                });*/
                $('.action-save', self.$modalForm).click(function (){
                    self.actionSave();
                });
            },
            close: function (){
                var self = this;
                self.$modalForm.modal('hide');
            },
            open: function(type, id){

                bloqueointerface();

                var self = this;
                self.setFormType(type);
                $.ajax({
                    type: "GET",
                    url: "/pro_aperturaclase",
                    data: {'action': 'loadFormRequest', 'typeForm': type, 'id': id},
                    success: function(data) {
                        if (data.result == 'ok') {
                            $.unblockUI();
                            $(".modal-body", self.$modalForm).html(data.html);
                            self.$modalForm.modal({backdrop:'static', width: '60%'}).modal('show');
                        } else {
                            $.unblockUI();
                            NotificationJG.error(data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        NotificationJG.error("Error al enviar los datos.");
                    },
                    dataType: "json",
                });
            },
            setFormType: function( type /* new, edit, view */ )
            {
                var self = this;

                if( type == 'new' )
                {
                    $('.modal-header span', self.$modalForm).html('Nueva');

                    $('.action-save', self.$modalForm).show();
                    $('.action-edit', self.$modalForm).hide();
                    self.setFormReadOnly(false);
                }
                else if( type == 'edit' )
                {
                    $('.modal-header span', self.$modalForm).html('Editar');

                    $('.action-save', self.$modalForm).show();
                    $('.action-edit', self.$modalForm).hide();
                    self.setFormReadOnly(false);
                }
                else if( type == 'view' )
                {
                    $('.modal-header span', self.$modalForm).html('Ver');

                    $('.action-save', self.$modalForm).hide();
                    $('.action-edit', self.$modalForm).show();
                    self.setFormReadOnly(true);
                }
            },
            setFormReadOnly: function( isFormReadOnly )
            {
                var self = this;

                $('[name="tipoincoveniente"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="tipoincoveniente"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="tipomotivo"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="tipomotivo"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="fechainicioinasistencia"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="fechainicioinasistencia"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="fechafininasistencia"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="fechafininasistencia"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="especifique"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="especifique"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="materia"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="materia"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="aula"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="aula"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="documento"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="documento"]', self.$modalForm).prop('readonly', isFormReadOnly);
                $('[name="fechadiferido"]', self.$modalForm).prop('disabled', isFormReadOnly);
                $('[name="fechadiferido"]', self.$modalForm).prop('readonly', isFormReadOnly);
            },
            formGetData:function(){
                var self = this;
                var data = new FormData($("#frmAddRequest", self.$modalForm)[0]);
                return data;
            },
            actionSave: function (){
                var self = this;
                $("#frmAddRequest", self.$modalForm).validationEngine('attach',{ scroll: false });
                var valid = $("#frmAddRequest", self.$modalForm).validationEngine('validate', { scroll: false });
                if (!valid){
                    setTimeout(function() {
                        $('.help-text', self.$modalForm).each(function () {
                            var field = $(this);
                            if (field.attr('alert')) {
                                field.html(field.attr('alert'));
                            } else {
                                field.html('');
                            }
                        });
                    }, 8000);
                    $.unblockUI();
                    return false;
                }
                $('.datepicker', self.$modalForm).css({"display": "none"});
                $('.bootstrap-timepicker-widget', self.$modalForm).css({"display": "none"});

                $('.controls input', self.$modalForm).each(function(){
                    if ($(this).attr('type')=='text'){
                        $(this).val($(this).val().trim());
                    }
                    if ($(this).attr('type')!='file'){
                        if ($(this).css('text-transform')=='uppercase'){
                            if ($(this).attr('type')!='password'){
                                $(this).val($(this).val().toUpperCase());
                            }
                        }
                    }
                });

                var aData = self.formGetData();
                console.log(aData);
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/pro_aperturaclase",
                    data: aData,
                    success: function(data) {
                        if (data.result == 'ok') {
                            ControllerSolicitudes.$table.dataTable().fnDraw(false);
                            self.close();
                            //NotificationJG.success(data.mensaje);
                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                type: 'success',
                                title: data.mensaje,
                                showConfirmButton: false,
                                timer: 6000
                            });
                        }
                        else{
                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                type: 'error',
                                title: data.mensaje,
                                showConfirmButton: false,
                                timer: 6000
                            });
                        }
                        $.unblockUI();
                    },
                    error: function() {
                        $.unblockUI();
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            type: 'error',
                            title: "Error de conexion.",
                            showConfirmButton: false,
                            timer: 6000
                        });
                    },
                    dataType: "json",
                    cache: false,
                    contentType: false,
                    processData: false,
                });
            },
        };

        var uiViewClassModal = {
            init: function () {
                var self = this;
                self.$modalForm = $('#modalViewClass');
                $('.action-close', self.$modalForm).click(function(){
                    self.close();
                });
            },
            close: function (){
                var self = this;
                self.$modalForm.modal('hide');
            },
            open: function(text, idlg, idl){
                bloqueointerface();
                var self = this;
                var h = $(window).height()-150;
                let url = `/pro_clases?action=view&id=${idlg}&idl=${idl}`;

                //var iframe = $(".modal-body > iframe", self.$modalForm);
                //var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                //console.debug(iframe);
                bloqueointerface();
                location.href = `${url}&ret=/pro_aperturaclase`;
                bloqueointerface();
                /*if(isMobile.any()) {
                    bloqueointerface();
                    location.href = `${url}&ret=/pro_aperturaclase`;
                    bloqueointerface();
                }else{
                    url += `&useModal=1&ret=/pro_aperturaclase`;
                    $(".modal-body > iframe", self.$modalForm).attr("src", url);
                    $(document, ".modal-body > iframe", self.$modalForm).ready(function(e) {
                        $(".modal-body > iframe", self.$modalForm).load(function (){
                            setTimeout(function(){
                                self.$modalForm.modal({backdrop:'static', width: '95%', height: h}).modal('show');
                                $.unblockUI();
                            },8000);
                        });
                    });
                }*/
            },
        };

        var uiCreateVideoModal = {
            init: function () {
                var self = this;
                self.$modalForm = $('#modalCreateVideo');
                $('.action-close', self.$modalForm).click(function(){
                    self.close();
                });

                $(".action-save", self.$modalForm).click(function(){
                    self.save();
                });
            },
            close: function (){
                var self = this;
                self.$modalForm.modal('hide');
            },
            open: function(text, id){
                bloqueointerface();
                var self = this;
                $('[name="id_s"]', self.$modalForm).val(id);
                $("#id_enlace1video", self.$modalForm).val("");
                $("#id_enlace2video", self.$modalForm).val("");
                $("#id_enlace3video", self.$modalForm).val("");
                bloqueointerface();
                self.$modalForm.modal({backdrop:'static', width: '50%'}).modal('show');
                $.unblockUI();
            },
            save: function (){
                var self = this;
                var ids = $('[name="id_s"]', self.$modalForm).val();
                var link_1 = $("#id_enlace1video", self.$modalForm).val();
                var link_2 = $("#id_enlace2video", self.$modalForm).val();
                var link_3 = $("#id_enlace3video", self.$modalForm).val();
                if(link_1 == ''){
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        type: 'error',
                        title: 'Favor ingrese enlace de la grabación 1',
                        showConfirmButton: false,
                        timer: 6000
                    });
                    return false;
                }
                let aData = {
                    "ids": ids,
                    "link_1": link_1,
                    "link_2": link_2,
                    "link_3": link_3,
                    "action": "addVideoVirtual",
                }
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/pro_aperturaclase",
                    data: aData,
                    success: function(data) {
                        $.unblockUI();
                        if (data.result=='ok'){
                            Swal.fire({
                                title: `NOTIFICACIÓN`,
                                text: data.mensaje,
                                type: 'success',
                                icon: 'success',
                                showCancelButton: false,
                                allowOutsideClick: false,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Aceptar',
                                cancelButtonText: 'Cancelar'
                            }).then((result) => {
                                if (result.value) {
                                    bloqueointerface();
                                    ControllerSolicitudes.$table.dataTable().fnDraw(false);
                                    self.close();
                                    $.unblockUI();
                                }
                            }).catch(error => {
                                Swal.fire({
                                    toast: true,
                                    position: 'top-end',
                                    type: 'error',
                                    title: 'Ocurrio un error inesperado',
                                    showConfirmButton: false,
                                    timer: 6000
                                });
                                $.unblockUI();
                            });
                        } else {
                            Swal.fire({
                                title: `NOTIFICACIÓN`,
                                text: data.mensaje,
                                type: 'error',
                                icon: 'error',
                                showCancelButton: false,
                                allowOutsideClick: false,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Aceptar',
                                cancelButtonText: 'Cancelar'
                            }).then((result) => {
                                $.unblockUI();
                                if (result.value) {
                                    //self.$table.dataTable().fnDraw(false);
                                }
                            }).catch(error => {
                                Swal.fire({
                                    toast: true,
                                    position: 'top-end',
                                    type: 'error',
                                    title: 'Ocurrio un error inesperado',
                                    showConfirmButton: false,
                                    timer: 6000
                                });
                                $.unblockUI();
                            });
                        }

                    },
                    error: function() {
                        $.unblockUI();
                        NotificationJG.error("Error de conexión");

                    },
                    dataType: "json"
                });
            },
        };

        var uiViewClassCheckModal = {
            init: function () {
                var self = this;
                self.$modalForm = $('#modalViewClassCheck');
                $('.action-close', self.$modalForm).click(function(){
                    self.close();
                });

                /*$(".action-save", self.$modalForm).click(function(){
                    self.save();
                });*/
            },
            close: function (){
                var self = this;
                self.$modalForm.modal('hide');
            },
            open: function(id){
                var self = this;
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/api/data/inno",
                    data: {'action': 'loadTeacherClassCalendar', 'idp': id, 'ver': 'M', 'modal': 'modalViewClassCheck'},
                    success: function(data) {
                        if (data.result=='ok')
                        {
                            $(".modal-body", self.$modalForm).html(data.html);
                            self.$modalForm.modal({backdrop:'static', width: '95%'}).modal('show');
                            $.unblockUI();
                        }
                        else
                        {
                            $.unblockUI();
                            NotificationJG.error(data.mensaje);
                        }

                    },
                    error: function() {
                        $.unblockUI();
                        NotificationJG.error("Error de conexión");

                    },
                    dataType: "json"
                });

            },
        };


        $(function() {
            ControllerSolicitudes.init();
            uiModal.init();
            uiViewClassModal.init();
            uiCreateVideoModal.init();
            uiViewClassCheckModal.init();

        });
    </script>
{% endblock %}
{% block atras %}/adm_sistemas{% endblock %}
{% block canvas %}
    <div class='row-fluid'>
        <div class='span12'>
            <h4>{{ title }}</h4>
        </div>
    </div>

    <div class="row-fluid">
        <div class='span8'>
            {% if ePeriodoAcademia and ePeriodoAcademia.puede_solicitar_clase_diferido_pro and ePeriodoAcademia.proceso_solicitud_clase_diferido_pro and  ePeriodoAcademia.proceso_solicitud_clase_diferido_pro.tiene_tipos %}
                <a href="javascript:;" class='btn btn-success action-add'><i class="fa fa-plus"></i> Adicionar</a>
            {% endif %}
            <a href="javascript:;" class='btn btn-primary action-view-class-check' idp="{{ profesor.id }}"><i class="fa fa-calendar-check-o"></i> Calendario de clases</a>
            {#            <div class="btn-group">#}
            {#                <a class="btn dropdown-toggle" data-toggle="dropdown" href="javascript:;">Descargas <span class="caret"></span></a>#}
            {#                <ul class="dropdown-menu pull-left">#}
            {#                    <li><a href="/media/solicitud_clase/Formato de registro de asistencia por inconvenientes.docx" target="_blank"><i class="fa fa-arrow-down"></i> Formato Inconvenientes Tecnológico y Otros</a></li>#}
            {#                    <li><a href="/media/solicitud_clase/Formato clases por diferido.docx" target="_blank"><i class="fa fa-arrow-down"></i> Formato Clases Diferidos</a></li>#}
            {#                </ul>#}
            {#            </div>#}
        </div>
        <div class="span4">
            <div class="panel panel-sga" id="panel_filter">
                <div class="panel-heading">
                    <h3 class="panel-title">Filtro</h3>
                    <div class="pull-right">
                        <a style="margin-right: 5px" href="javascript:;" class='btn btn-mini btn-info tu' id="action_min" title="Minimizar"><span class="fa fa-minus"></span></a>
                        <a style="margin-right: 5px" href="javascript:;" class='btn btn-mini btn-info tu' id="action_max" title="Maximizar"><span class="fa fa-plus"></span></a>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="row-fluid">
                        <div class="span3"><b>Incoveniente:</b></div>
                        <div class="span9">
                            <select name="tipo_incoveniente" style="width: 100%;">
                                <option value="0" selected="selected">--TODOS--</option>
                                {% for t in tipos_incovenientes %}
                                    <option value="{{ t.id }}">{{ t.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row-fluid">
                        <div class="span3"><b>Motivo:</b></div>
                        <div class="span9">
                            <select name="tipo_motivo" style="width: 100%;">
                                <option value="0" selected="selected">--TODOS--</option>
                                {% for t in tipos_motivo %}
                                    <option value="{{ t.0 }}">{{ t.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row-fluid">
                        <div class="span3"><b>Estado:</b></div>
                        <div class="span9">
                            <select name="estado" style="width: 100%;">
                                <option value="0" selected="selected">--TODOS--</option>
                                {% for e in estados %}
                                    <option value="{{ e.0 }}">{{ e.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="no-more-tables">
        <div class='row-fluid'>
            <div class='span12'>
                <div class="datatable" id="divDetailData">
                    <table id="dtViewSolicitudes" class='table table-bordered table-striped'>
                        <thead>
                        <tr>
                            <th style="text-align: center; vertical-align: middle; width: 25%">Detalle</th>
                            <th style="text-align: center; vertical-align: middle; width: 7%">Turno</th>
                            <th style="text-align: center; vertical-align: middle; width: 9%">Fecha Diferido</th>
                            <th style="text-align: center; vertical-align: middle; width: 9%">Fecha Solicitud</th>
                            <th style="text-align: center; vertical-align: middle; width: 10%">Incoveniente</th>
                            <th style="text-align: center; vertical-align: middle; width: 8%">Motivo</th>
                            <th style="text-align: center; vertical-align: middle; width: 8%">Archivo</th>
                            <th style="text-align: center; vertical-align: middle; width: 8%">Estado</th>
                            <th style="text-align: center; vertical-align: middle; width: 15%"></th>
                        </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="el-templates" style="display:none;">
        <div element="table-row-actions">
            <table>
                <tbody>
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>
                        <div class="table-controls">
                            <a href="javascript:;" class="btn btn-success btn-mini dt_action_open_clase hidden disabled"><i class="fa fa-plus"></i> Asistencia</a>
                            <a href="javascript:;" class="btn btn-success btn-mini dt_action_continue_clase hidden disabled"><i class="fa fa-forward"></i> Continuar Asistencia</a>
                            <a href="javascript:;" class="btn btn-success btn-mini dt_action_view_clase hidden disabled"><i class="fa fa-eye"></i> Ver Asistencia</a>
                            <a href="javascript:;" target="_blank" class='btn btn-info btn-mini dt_action_view_video hidden disabled'> <i class="fa fa-video-camera"></i> Ver video</a>
                            <a href="javascript:;" class='btn btn-warning btn-mini dt_action_create_video hidden disabled'> <i class="fa fa-plus"></i> Subir video</a>
                            <a href="javascript:;" class='btn btn-danger btn-mini dt_action_delete hidden disabled' > <i class="fa fa-trash"></i> Eliminar</a>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div element="table-row-coordinacion">
            <table>
                <tbody>
                <tr>
                    <td style="text-align: left; vertical-align: middle"></td>
                    <td style="text-align: center; vertical-align: middle"></td>
                    <td style="text-align: center; vertical-align: middle"></td>
                    <td style="text-align: center; vertical-align: middle"></td>
                    <td style="text-align: center; vertical-align: middle">
                        <div class="btn-group">
                            <!--<a style="margin-right: 5px;" href="javascript:;" class='btn btn-mini btn-info tu action_edit_coordinacion' title="Editar coordinación"><span class="fa fa-edit"></span></a>-->
                            <a style="margin-right: 5px;" href="javascript:;" class='btn btn-mini btn-danger tu action_remove_coordinacion' title="Quitar coordinación"><span class="fa fa-remove"></span></a>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div element="table-row-fecha-rubro">
            <table>
                <tbody>
                <tr>
                    <td style="text-align: center; vertical-align: middle"></td>
                    <td style="text-align: center; vertical-align: middle"></td>
                    <td style="text-align: center; vertical-align: middle">
                        <div class="btn-group">
                            <!--<a style="margin-right: 5px;" href="javascript:;" class='btn btn-mini btn-info tu action_edit_fecha_rurbo' title="Editar Fecha"><span class="fa fa-edit"></span></a>-->
                            <a style="margin-right: 5px;" href="javascript:;" class='btn btn-mini btn-danger tu action_remove_fecha_rurbo' title="Quitar fecha"><span class="fa fa-remove"></span></a>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div element="table-row-grupo-socioeconomico">
            <table>
                <tbody>
                <tr>
                    <td style="text-align: center; vertical-align: middle"></td>
                    <td style="text-align: center; vertical-align: middle"></td>
                    <td style="text-align: center; vertical-align: middle">
                        <div class="btn-group">
                            <a style="margin-right: 5px;" href="javascript:;" class='btn btn-mini btn-info tu action_edit_grupo_socioeconomico' title="Editar Fecha"><span class="fa fa-edit"></span></a>
                            <a style="margin-right: 5px;" href="javascript:;" class='btn btn-mini btn-danger tu action_remove_grupo_socioeconomico' title="Quitar fecha"><span class="fa fa-remove"></span></a>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade static" id="modalRequest" style="display: none;">
        <div class="modal-header">
            <h4 class="paneltitle"><span></span> solicitud</h4>
        </div>
        <div class="modal-body panelbody">
        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn btn-info action-edit"> Editar</a>
            <a href="javascript:;" class="btn btn-success action-save"> Guardar</a>
            <a href="javascript:;" class="btn btn-inverse action-close"> Cerrar</a>
        </div>
    </div>

    <div class="modal fade static" id="modalViewClass" style="display: none;">
        <div class="modal-header">
            <h4 class="paneltitle">Ver Asistencia <span></span></h4>
        </div>
        <div class="modal-body panelbody">
            <iframe src="" loading="lazy" style="width: 100%; height: 98%; border: 0; margin: 0"></iframe>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn btn-danger action-close"> Cerrar</a>
        </div>
    </div>

    <div class="modal fade static" id="modalCreateVideo" style="display: none;">
        <div class="modal-header">
            <h3 class="paneltitle">Crear video <span></span></h3>
        </div>
        <div class="modal-body panelbodyforo">
            <input type="hidden" id="id_s" name="id_s" value="0">
            <h3></h3>
            Enlace a la grabación 1 <span style="color:#FF0000";>* Obligatorio</span><br>
            <textarea rows="3" name="id_enlace1video" id="id_enlace1video" style="width: 100%; resize: none"></textarea><br>
            Enlace a la grabación 2<br>
            <textarea rows="3" name="id_enlace2video" id="id_enlace2video" style="width: 100%; resize: none"></textarea><br>
            Enlace a la grabación 3<br>
            <textarea rows="3" name="id_enlace3video" id="id_enlace3video" style="width: 100%; resize: none"></textarea>
        </div>
        <div class="modal-footer">
            <table class="pull-right">
                <tr>
                    <td><a href="javascript:;" class="btn btn-success action-save">Crear</a></td>
                    <td><a href="javascript:;" class="btn btn-inverse action-close">Cancelar</a></td>
                </tr>
            </table>
        </div>
    </div>

    <div class="modal fade static" id="modalViewClassCheck" style="display: none;">
        <div class="modal-header">
            <h3 class="paneltitle">Calendario de clases <span></span></h3>
        </div>
        <div class="modal-body">
        </div>
        <div class="modal-footer">
{#            <a href="javascript:;" class="btn btn-primary action-select-date">Seleccionar</a>#}
            <a href="javascript:;" class="btn btn-inverse action-close">Cerrar</a>
        </div>
    </div>
{% endblock %}
