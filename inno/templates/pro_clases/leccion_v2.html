{% extends "base.html" %}
{% load sga_extras %}

{% block heading %}
	<link rel="stylesheet" href="/static/css/jquery.fancybox.css?v=1.0.0" type="text/css" media="screen" />
	<script type="text/javascript" src="/static/js/jquery.fancybox.pack.js?v=1.0.0"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

	<!-- Compatibilidad con version anterior ---->
	<script type='text/javascript' src="/static/js/bootstrap-datepicker.js?4.0.0"></script>
	<link href="/static/css/datepicker.css?4.0.0" rel='stylesheet'/>

	<script type="text/javascript">

        lista_items1 = [];
        lista_items2 = [];
        lista_items3 = [];
        
        function addsubtema(codsubtema, indice, tema, leccion){
            bloqueointerface();
            $.ajax({
                type:"POST",
                url:"/pro_clases",
                data:{'action':'selectsubtema', 'idl': leccion, 'idt':tema, 'ids': codsubtema},
                error:function(){
                    mensajeDanger("Error al cerrar la clase.");
                    $.unblockUI();
                },
                success:function(data){
                    if (data.result === "ok"){

                        if (indice.checked){
                            lista_items1.push(parseInt(codsubtema));
                        }else{
                            pop_lista(lista_items1, parseInt(codsubtema));
                            data.marcartema === 2 && pop_lista(lista_items2, parseInt(tema));
                        }

                        data.marcartema && $("#chktem_" + tema).prop('checked', data.marcartema === 1).change();
                        $.unblockUI();
                    } else {
                        indice.checked = !indice.checked;
                        mensajeDanger(data.mensaje);
                        $.unblockUI();
                    }
                }
            });
        }

        function addsubtemaadicional(codsubtema,indice,tema,leccion){
            bandera = 0;
            if (indice.checked){
                for (re=0;re<lista_items2.length;re++){
                    if (lista_items2[re] == tema){bandera=1;}
                }
                if (bandera==0){
                    $("#chktem_"+tema).attr('checked', true);
                    lista_items2.push(tema);
                }
                lista_items1.push(codsubtema);
            }else{
                pop_lista(lista_items3, codsubtema);
            }
            bloqueointerface();
            $.ajax({
                type:"POST",
                url:"/pro_clases",
                data:{'action':'selectsubtemaadicional', 'idl': leccion, 'idt':tema, 'ids': codsubtema},
                error:function(){
                    smoke.alert("Error al cerrar la clase.");
                    $.unblockUI();
                },
                success:function(data){
                    if (data.result=="ok"){
                        if (data.tem>0)
                            $.unblockUI();
                        $("#chktem_" + data.tem).attr('checked', true);
                        $.unblockUI();
                    } else {
                        smoke.alert(data.mensaje);
                    }
                }
            });
        }

        function addtema(codtema, indicetema, leccion){
            let total = $("#total_"+codtema).val();
            if (indicetema.checked) {
                habilitaregistroasistencia = true;
            } else{
                {% if ultimodiaclases %}
                habilitaregistroasistencia = false;
                {% endif %}
            }
            actualizartema(leccion, codtema, indicetema);
        }

        function actualizartema(leccion, codtema, indicetema) {
            bloqueointerface();
            $.ajax({
                type:"POST",
                url:"/pro_clases",
                data:{'action':'selecttema', 'idl': leccion, 'idt':codtema},
                error:function(){
                    smoke.alert("Error al cerrar la clase.");
                    $.unblockUI();
                },
                success:function(data){
                    $.unblockUI();
                    if (data.result === "ok"){
                        data.lista.forEach(pk => {
                            $("#chksub_" + pk).prop('checked', data.checked).change();
                            data.checked ? lista_items1.push(pk) : pop_lista(lista_items1, parseInt(pk));
                        });
                        $("#chktem_" + codtema).prop('checked', data.checked).change();
                    } else {
                        indicetema.checked = !indicetema.checked;
                        if (data.mensaje) {
                            mensajeDanger(data.mensaje);
                        }
                    }
                }
            });
        }

        function addbibli(codbibli,indicebib){
            if (indicebib.checked){
                lista_items3.push(codbibli);
            }else{
                pop_lista(lista_items3, codbibli);
            }
        }

        var solicitudes = 0;

        {% if lecciongrupo.abierta %}
            verificarcontinuaabierta = function  (){
                if (solicitudes < 1){
                    $.ajax({
                        type:"POST",
                        url:"/inno/api",
                        data:{'action':'checkOpenClassContinue', 'id': parseInt('{{ lecciongrupo.id }}') },
                        error:function(){
                        },
                        success:function(data){
                            //console.log(data);
                            if (data.result=="ok"){
                                if (data.abierta == false){
                                    bloqueointerface();
                                    if (data.otras > 0){
                                        bloqueointerface();
                                        location.href = "/pro_clases?action=view&id=" + data.otras;
                                        bloqueointerface();
                                    } else {
                                        bloqueointerface();
                                        location.href = "/pro_clases";
                                        bloqueointerface();
                                    }
                                }else{
                                    $(".action_close_class").hide();
                                    if (data.puede_cerrar_leccion_grupo){
                                        $(".action_close_class").show();
                                    }
                                    //console.table(data.asistencias);
                                    {% if websocket and ePeriodoAcademia and ePeriodoAcademia.utiliza_asistencia_ws %}
                                        $.each(data.asistencias, function(index, value) {
                                            $("#porcientoasist"+value.id).html(value.asistenciafinal+"%");
                                            if (!value.porciento_requerido){
                                                $("#porcientoasist"+value.id).removeClass("badge-success");
                                                $("#porcientoasist"+value.id).addClass("badge-important");
                                            }else{
                                                $("#porcientoasist"+value.id).removeClass("badge-important");
                                                $("#porcientoasist"+value.id).addClass("badge-success");
                                            }
                                            if (value.virtual){
                                                let __obj = `#asistencia_virtual_${value.materiaasignada}`;
                                                let $span = $(__obj);
                                                //$span.show();
                                                let __html = `Ingres√≥ a la clase a las ${value.virtual_hora} desde ${value.browser} con la IP ${value.ip_public}`;
                                                $span.html(__html);
                                            }
                                            if (value.asistio && value.virtual){
                                                //console.log("EN LINEA: " + value.asistio && value.virtual);
                                                let $el = $("#check"+value.id);
                                                if (!$el.is(':checked')){
                                                    $el.prop("checked", true);
                                                    $("#porcientoasist"+value.id).html(value.asistenciafinal+"%");
                                                    if (!value.porciento_requerido){
                                                        $("#porcientoasist"+value.id).removeClass("badge-success");
                                                        $("#porcientoasist"+value.id).addClass("badge-important");
                                                    }else{
                                                        $("#porcientoasist"+value.id).removeClass("badge-important");
                                                        $("#porcientoasist"+value.id).addClass("badge-success");
                                                    }
                                                }
                                            }
                                        });
                                    {% endif %}
                                    actualiza_asistencia();
                                }
                            }
                        },
                        dataType: "json"
                    });
                }
            };
        {% endif %}

        $(function() {
            var chequeo = null;
            $(window).scroll(function() {
                $(".btn-flotante-zoom, .btn-flotante-close").removeClass('show');
                $(".btn-flotante-zoom, .btn-flotante-close").addClass('hidden');
                if ($(window).scrollTop() > 300) {
                    //console.log("ent");
                    $(".btn-flotante-zoom, .btn-flotante-close").removeClass('hidden');
                    $(".btn-flotante-zoom, .btn-flotante-close").addClass('show');
                } else {
                    $(".btn-flotante-zoom, .btn-flotante-close").removeClass('show');
                    $(".btn-flotante-zoom, .btn-flotante-close").addClass('hidden');
                }
            });

            $(".action-observacion").click(function (){
                bloqueointerface();
                let type = $(this).attr('type');
                let ida = $(this).attr('ida');
                $.ajax({
                    type: "POST",
                    url: "/pro_clases",
                    data: {'action': 'viewAsistenciaObservaciones', 'type': type, 'id': ida},
                    success: function(data) {
                        $.unblockUI();
                        if (data.result === 'ok') {
                            $("#modalViewAsistenciaObservacion .panelbody").html(data.html);
                            $("#modalViewAsistenciaObservacion").modal({backdrop:'static', width: '60%'}).modal('show');
                        } else {
                            NotificationJG.error(data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        NotificationJG.error("Error al enviar los datos.");
                    },
                    dataType: "json",
                });
            });

            $('.action-close', $("#modalViewAsistenciaObservacion")).click(function(){
                $("#modalViewAsistenciaObservacion").modal('hide');
            });

            $('.action-save', $("#modalAddAsistenciaObservacion")).click(function(){
                let type = $("[name='type']", $("#modalAddAsistenciaObservacion")).val();
                let ida = $("[name='ida']", $("#modalAddAsistenciaObservacion")).val();
                let ido = $("[name='ido']", $("#modalAddAsistenciaObservacion")).val();
                let observacion = $("[name='observacion']", $("#modalAddAsistenciaObservacion")).val();
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/pro_clases",
                    data: {'action': 'saveAsistenciaObservacion', 'type': type, 'ida': ida, 'ido': ido, 'observacion': observacion},
                    success: function(data) {
                        $.unblockUI();
                        if (data.result == 'ok') {
                            $("#modalAddAsistenciaObservacion").modal('hide');
                            NotificationJG.success(data.mensaje);
                            $(".modal-body", $("#modalViewAsistenciaObservacion")).html(data.html);
                            let __obj = `#btn_action_observacion_${ida} > sup > label > b`;
                            $(__obj).html(data.num_observaciones);
                            //$("#modalViewAsistenciaObservacion").modal({backdrop:'static', width: '90%'}).modal('show');

                        } else {
                            NotificationJG.error(data.mensaje);
                        }
                    },
                    error: function() {
                        $.unblockUI();
                        NotificationJG.error("Error al enviar los datos.");
                    },
                    dataType: "json",
                });
            });

            $(".verdetalleppl").click(function() {
                var idmatricula = $(this).attr('idmat');
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/pro_planificacion",
                    data: {'action': 'verdetalleppl', 'idmatricula':idmatricula },
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error al obtener los datos.");
                    },
                    success: function (data) {
                        if (data.result == "ok") {
                            $.unblockUI();
                            $(".panelbodydetalleppl" ).empty();
                            $(".panelbodydetalleppl" ).html(data.data);
                            $("#itemspanelverdetalleppl").modal({backdrop:'static', width: '900px'}).modal('show');

                        } else {
                            $.unblockUI();
                            smoke.alert(data.mensaje);
                        }
                    }
                });
            });


            $(".action_close_class").hide();

            {% if lecciongrupo.abierta %}
                {% if lecciongrupo.puede_cerrar_leccion_grupo %}
                    $(".action_close_class").show();
                {% endif %}
                chequeo = setInterval(verificarcontinuaabierta, 80000);

                $(".action_close_class").click(function() {
                    Swal.fire({
                        title: 'NOTIFICACI√ìN',
                        text: "¬øEst√° segur{% if persona.sexo.id == 1 %}a{% else %}o{% endif %} de cerrar la clase?",
                        type: 'info',
                        icon: 'info',
                        showCancelButton: true,
                        allowOutsideClick: false,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'SI',
                        cancelButtonText: 'NO'
                    }).then((result) => {
                        if (result.value) {
                            var contenido = undefined;
                            if (solicitudes < 1)
                            {
                                if ($("#contenido").length) {
                                    contenido = $("#contenido").val();
                                    contenido = contenido.trim();
                                    console.log("contenido: ", contenido);
                                    if (!contenido){
                                        NotificationJG.warning("Antes de Cerrar la Leccion introduzca el contenido de la misma.");
                                        return;
                                    }

                                }
                                bloqueointerface();
                                $.ajax({
                                    type:"POST",
                                    url:"/pro_clases",
                                    data:{'action':'cerrar', 'id': '{{ lecciongrupo.id }}' },
                                    error:function(){
                                        NotificationJG.error("Error al cerrar la clase.");
                                        $.unblockUI();
                                    },
                                    success:function(data){
                                        if (data.result=="ok"){
                                            {% if ret %}
                                                bloqueointerface();
                                                location.href = "{{ ret }}";
                                                bloqueointerface();
                                            {% else %}
                                                bloqueointerface();
                                                location.href = "/pro_clases";
                                                bloqueointerface();
                                            {% endif %}
                                        } else {
                                            $.unblockUI();
                                            if (data.result=="bad"){
                                                if (data.motivo=="contenido"){
                                                    actualizarcontenido();
                                                    actualizarobservacion();
                                                    NotificationJG.warning("Antes de Cerrar la Leccion introduzca el contenido de la misma.");
                                                } else {
                                                    NotificationJG.error("Error al cerrar la clase.");
                                                }
                                            }
                                        }
                                    }
                                });







                            }
                            else
                            {

                                NotificationJG.warning("Tiene en proceso envio de asistencia o contenido que no han terminado.");
                            }

                        }else{
                            NotificationJG.info("Enhorabuena su clase sigue abierta")
                        }
                    }).catch(error => {
                        console.log(error);
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            type: 'error',
                            title: 'Ocurrio un error inesperado',
                            showConfirmButton: false,
                            timer: 6000
                        });
                    });

                });

                $("#btn-cerrar").click(function() {
                    $("#incidenciaspanel").modal('hide');
                    return false;
                });

                adicionarincidencia = function(intento, tipo, contenido, tiponombre){
                    if (contenido.trim().length>0){
                        $.ajax({
                            type:"POST",
                            url:"/pro_clases",
                            data:{'action': 'addincidencia', 'lecciongrupo': '{{ lecciongrupo.id }}', 'tipo': tipo, 'contenido': contenido},
                            error:function(){
                                if (intento>=100){
                                    solicitudes -=1;
                                } else {
                                    adicionarincidencia(intento+1, tipo, contenido, tiponombre);
                                }
                            },
                            success:function(data){
                                solicitudes -=1;
                                if (data.result=="ok"){
                                    listaincidencias = $("#listaincidencias").html();
                                    listaincidencias += "<tr class=''><td><h4>"+tiponombre+"</h4><p>"+contenido+"</p></td></tr>";
                                    $("#listaincidencias").html(listaincidencias);
                                    $("#incidenciaspanel").modal('hide');
                                }
                            }
                        });
                    } else {
                        solicitudes -=1;
                    }
                };

                fecha = $(".selectorfecha");

                actualiza_fecha = function(){
                    elemento = $('#fecha');
                    var id = elemento.attr('lg');
                    var fechaanterior = elemento.attr("va");
                    var fechaactual = elemento.val();
                    $('.datepicker').css({"display": "none"});
                    bloqueointerface();
                    $.post("/pro_clases", {'action': 'updatefecha', 'id': id, 'fecha': fechaactual}, function(data) {
                        $.unblockUI();
                        if (data.result=='ok') {
                            $('#fecha').attr({'va': fechaactual});
                        } else {
                            elemento.val(fechaanterior);
                            smoke.alert(data.mensaje);
                        }
                    }).error(function(){
                        $.unblockUI();
                        elemento.val(fechaanterior);
                        smoke.alert("Fallo al cambiar la fecha");
                    });
                };

                fecha.datepicker({format:"dd-mm-yyyy"}).on('changeDate', function(){
                    actualiza_fecha($(this));
                });

                fecha.change(function(){
                    actualiza_fecha($(this));
                });

                $("#btn-ejecutar").click(function() {
                    var tiponombre = $("#id_tipo :selected").text();
                    var contenido = $("#id_contenido").val();
                    var tipo = $("#id_tipo").val();
                    solicitudes +=1;
                    $("#incidenciaspanel").modal('hide');
                    adicionarincidencia(0, tipo, contenido, tiponombre);
                });

                $("#addincidencia").click(function() {
                    $('#id_contenido').val("");
                    $('#incidenciaspanel').modal({keyboard: false, backdrop: 'static'});
                    $('#incidenciasspanel').modal("show");
                    return false;
                });

                $("#subirdeber").click(function(){
                    if (solicitudes<=0){
                        bloqueointerface();
                        location.href = '/pro_clases?action=adddeberes&id={{ lecciongrupo.id }}';
                        bloqueointerface();
                    } else {
                        smoke.alert("Tiene en proceso envio de asistencia o contenido que no han terminado.");
                    }
                });

                actualizarestrategiasmetodologicas = function(intento){
                    var id;
                    var contenido;
                    contenido = $("#estrategiasmetodologicas").val().trim();
                    id = $("#estrategiasmetodologicas").attr("idleccion");
                    $("#estrategiasmetodologicas").css({"background-color":"rgb(217, 237, 247)"});
                    $.ajax({
                        cache:false,
                        type:"POST",
                        url:"/pro_clases",
                        data:{'action': 'estrategiasmetodologicas', 'id': id, 'val': contenido},
                        error:function(){
                            if (intento>=100){
                                solicitudes -= 1;
                                $("#estrategiasmetodologicas").css({"background-color":"rgba(240, 128, 128, 0.21)"});
                                $("#estrategiasmetodologicas").removeAttr("disabled");
                            } else {
                                actualizarestrategiasmetodologicas(intento+1);
                            }
                        },
                        success:function(data){
                            solicitudes -=1;
                            $("#estrategiasmetodologicas").removeAttr("disabled");
                            if (data.result=="ok"){
                                $("#estrategiasmetodologicas").css({"background-color":"rgba(148, 255, 183, 0.23)"});
                            } else {
                                $("#estrategiasmetodologicas").css({"background-color":"rgba(240, 128, 128, 0.21)"});
                            }
                        }
                    });
                };

                $("#estrategiasmetodologicas").change(function() {
                    solicitudes +=1;
                    $(this).prop('disabled', true);
                    actualizarestrategiasmetodologicas(0);
                });

                actualizarasistencia = function(id, valor, intento){
                    var marca = $("#check"+id);
                    $("#tab"+id).css({"background-color":"rgb(217, 237, 247)"});
                    $.ajax({
                        cache:false,
                        type:"POST",
                        url:"/pro_clases",
                        data:{'action':'asistencia', 'id':id, 'val': valor},
                        error:function(){
                            if (intento>=100){
                                solicitudes -= 1;
                                $("#tab"+id).find("#check"+id).removeAttr("disabled");
                                $("#tab"+id).css({"background-color":"rgb(240, 128, 128)"});
                                if (valor=='y'){
                                    $("#check"+id).attr('checked', false);
                                } else {
                                    $("#check"+id).attr('checked', true);
                                }
                                actualiza_asistencia();
                            }else{
                                actualizarasistencia(id,valor,intento+1);
                            }
                        },
                        success:function(data){
                            solicitudes -= 1;
                            $("#tab"+id).find("#check"+id).removeAttr("disabled");
                            if (data.result=="ok"){
                                $("#tab"+id).css({"background-color":"rgba(148, 255, 183, 0.23)"});
                                $("#porcientoasist"+id).html(data.porcientoasist+"%");
                                if (!data.porcientorequerido){
                                    $("#porcientoasist"+id).removeClass("badge-success");
                                    $("#porcientoasist"+id).addClass("badge-important");
                                }else{
                                    $("#porcientoasist"+id).removeClass("badge-important");
                                    $("#porcientoasist"+id).addClass("badge-success");
                                }
                            } else {
                                $("#tab"+id).css({"background-color":"rgb(240, 128, 128)"});
                                if (valor=='y'){
                                    $("#check"+id).attr('checked', false);
                                } else {
                                    $("#check"+id).attr('checked', true);
                                }
                            }
                            actualiza_asistencia();
                        }
                    });
                };

                {% if asistencia_en_grupo %}
                    actualizar_lista = function(){
                        var lista = '';
                        $('.selectorasistencia').each(function() {
                            if ($(this).is(":checked")){
                                lista += $(this).attr('idasis') + ',';
                            }
                        });
                        if (lista.length > 0){
                            lista = lista.substring(0, lista.length-1);
                        }
                        return lista;
                    };

                    actualizarasistenciagrupo = function(){
                        var listagrupo = actualizar_lista();
                        bloqueointerface();
                        $.ajax({
                            type:"POST",
                            url:"/pro_clases",
                            data:{'action':'asistenciagrupo', 'id': '{{ lecciongrupo.id }}', 'lista': listagrupo},
                            error:function(){
                                $.unblockUI();
                                smoke.alert(data.mensaje);
                            },
                            success:function(data){
                                if (data.result=='ok'){
                                    bloqueointerface();
                                    location.href = location.href;
                                    bloqueointerface();
                                } else {
                                    $.unblockUI();
                                    smoke.alert(data.mensaje);
                                }
                            }
                        });
                    };

                    $(".enviarasistencia").click(function() {
                        actualizarasistenciagrupo();
                    });
                {% endif %}

                $(".selectorasistencia").change(function(e) {
                    {% if not asistencia_en_grupo %}
                        bloqueointerface();
                        var val;
                        var id;
                        $(this).prop('disabled', true);
                        id = $(this).attr("idasis");
                        val = $(this).is(":checked");
                        solicitudes += 1;
                        actualizarasistencia(id, ((val)?'y':'n'),0);
                    {% endif %}
                });

                $("#selectortotalasistencia").click(function() {
                    var id = $(this).attr('idl');
                    bloqueointerface();
                    $.ajax({
                        type:"POST",
                        url:"/pro_clases",
                        data:{'action':'asistenciageneral', 'id': id},
                        error:function(){
                            $.unblockUI();
                            smoke.alert("Error al enviar los datos.");
                        },
                        success:function(data){
                            if (data.result == 'ok'){
                                bloqueointerface();
                                location.href = location.href;
                                bloqueointerface();
                            } else {
                                $.unblockUI();
                                smoke.alert("Error al enviar los datos.");
                            }
                        }
                    });
                });

                claseNota = function(v) {
                    if (v>=0 && v<5) {
                        return "badge-error";
                    } else if (v>=5 && v<8) {
                        return "badge-warning";
                    } else {
                        return "badge-success";
                    }
                };

                $(".removeevalbutton").click(function() {
                    bloqueointerface();
                    var id = $(this).attr("idasis");
                    var parent = $(this.parentNode);
                    var ultima = parent.find("#eval"+id+" a").last();
                    var evalid = ultima.attr("evalid");
                    if (parent.find("#eval"+id+" a").length > 0) {
                        $.post("/pro_clases", {'action': 'borrarevaluacion','asisid': id,'evalid': evalid}, function (data) {
                            //ultima.remove();
                            $.unblockUI();
                            let obj = $('.unique-value-' + id);
                            if (data.total === 0) {
                                obj.removeClass('btn-info').addClass('btn-secondary');
                            }
                            obj.html(data.total);
                            $("span#prom" + id).html("<span class='badge " + claseNota(data.promedio) + "'>" + data.promedio + "</span>");
                        }, "json");
                    }
                    return false;
                });

                $(".evalbutton").click(function() {
                    var id = $(this).attr("idasis");
                    var parent = $(this.parentNode);

                    Swal.fire({
                        title: "Digite un puntaje entre 1 y 10",
                        input: "text",
                        inputAttributes: {
                            autocapitalize: "off"
                        },
                        showCancelButton: true,
                        confirmButtonText: "Guardar",
                        showLoaderOnConfirm: true,
                        preConfirm: async (v) => {
                            try {
                                if (v && parseInt(v)>0 && parseInt(v)<=10) {
                                    bloqueointerface()
                                    parent.addClass("ajaxed");
                                    $.post("/pro_clases",{'action': 'evaluar', id: id, val: v}, function(data) {
                                        $.unblockUI();
                                        $('.unique-value-' + id).html(data.total);
                                        // $("span#prom"+id).html("<span class='badge "+claseNota(data.promedio)+"'>"+data.promedio+"</span>");
                                        if (data.total === 0) {
                                            $(".removeevalbutton"+id).hide();
                                            $('.unique-value-' + id).addClass('btn-secondary');
                                        } else {
                                            $(".removeevalbutton"+id).show();
                                            $('.unique-value-' + id).addClass('btn-info');
                                        }
                                        parent.removeClass("ajaxed");
                                        debugger
                                    }, "json");
                                } else {
                                    setTimeout(function (e) {
                                        mensajeDanger('El valor ingresado es incorrecto')
                                    }, 800)
                                }
                            } catch (error) {
                                Swal.showValidationMessage(`
                            Request failed: ${error}
                          `);
                            }
                        },
                        allowOutsideClick: () => !Swal.isLoading()
                    }).then((result) => {

                    });

                    return false;
                });
            {% endif %}

            total_presentes = function(){
                return $('.selectorasistencia:checked').length
            };

            total_alumnos = function(){
                return $('.selectorasistencia').length;
            };

            total_ausentes = function(){
                return total_alumnos() - total_presentes()
            };

            total_presentes_2 = function(){
                return $('.check_presente').length
            };

            total_alumnos_2 = function(){
                return $('.check_count').length;
            };

            total_ausentes_2 = function(){
                return total_alumnos_2() - total_presentes_2()
            };

            actualiza_asistencia = function(){
                //console.log("entro");
                $('#presentes').html(total_presentes());
                $('#ausentes').html(total_ausentes());
                $('#totalasistencias').html(total_alumnos());
                $.unblockUI();
            };

            actualiza_asistencia_2 = function(){
                console.log("entro");
                $('#presentes').html(total_presentes_2());
                $('#ausentes').html(total_ausentes_2());
                $('#totalasistencias').html(total_alumnos_2());
            };

            {% if lecciongrupo.abierta %}
                actualiza_asistencia();
            {% endif %}

            $(".leer").click(function() {
                var descripcion = $(this).attr('descripcion');
                var valor = $(this).attr('v');
                var ver = $(this).attr('ver');
                var texto = ''; var nleer = ''; var accion = '';
                if (ver == 1){
                    $(this).attr({'ver': 2});
                    texto = descripcion;
                    nleer = 'Leer menos';
                }
                if (ver == 2){
                    $(this).attr({'ver': 1});
                    texto = descripcion.substr(0,366) + '...';
                    nleer = 'Leer mas'
                }
                if (valor == 1){
                    accion = 'menmision'
                }
                if (valor == 2){
                    accion ='menperfil'
                }
                if (valor == 3){
                    accion ='menegreso'
                }
                if (valor == 4){
                    accion ='menobjetivo'
                }
                document.getElementById(accion).innerHTML = texto;
                document.getElementById('nleer'+valor).innerHTML = nleer;
            });

            setTimeout(function() {
                $("#contenidocentral").find(".alert").fadeOut("slow");
            }, 34000);

        });

        $(document).ready(function() {
            $(".fancybox").fancybox();
            actualiza_asistencia();
            {% if not lecciongrupo.abierta %}
                actualiza_asistencia_2();
            {% endif %}
            /*
            $.ajax({
                type:"POST",
                url:"/pro_clases",
                data:{'action': 'leccion_silabo','idm': {{ materia.id }},'idc': {{ clase.id }},'idl': {{ lecciongrupo.id }}, 'abierta': '{{ abierta }}' },
                error:function(){
                    $.unblockUI();
                    smoke.alert("Error de conecci√≥n.");
                },
                success:function(data){
                    if (data.results == 'ok'){
                        $("#silabos_temas").html(data.html);
                    } else {
                        $.unblockUI();
                        smoke.alert("Error al cargar los temas del silabo");
                    }
                }
            });
            */

            $('.show-class-performance').click(function(){
                bloqueointerface()
                let pk = $(this).attr('ida');
                let type = $(this).attr('type')
                $.get('{{ request.path }}', {'action': 'view-actuaciones', 'id': pk, 'type': type}, function(data){
                    if (data.result === 'ok') {
                        $('#modalViewAsistenciaObservacion .panelbody').html(data.html);
                        $('#modalViewAsistenciaObservacion').modal({backdrop:'static', width: '90%'}).modal('show');
                    } else {
                        mensajeDanger(data.mensaje);
                    }
                    $.unblockUI();
                });
            });

            $('.add-class-performance').click(function(){
                let id = $(this).attr('ida');
                let alumno = $(this).attr('alu');
                $('#itemspanelactuacionclase .subtitle').html(alumno);
                $('.div-form-add-class-performance [name="id"]').val(id);
                $('#itemspanelactuacionclase .panelbody').html($('.div-form-add-class-performance').html());
                $('#itemspanelactuacionclase').modal({backdrop:'static', width: '90%'}).modal('show');
            });

        });

        const submit_class_performance = () => {
            bloqueointerface();
            var formdata = new FormData($("#itemspanelactuacionclase form")[0]);
            $.ajax({
                type: "POST",
                url: "{{ request.path }}",
                data: formdata,
                success: function (data) {
                    $.unblockUI();
                    if ((data.result === 'ok')) {
                        let id = formdata.get('id');
                        $('#itemspanelactuacionclase').modal('hide');
                        $('.unique-value-' + id).html(data.promedio);
                        $('.unique-value-' + id).removeClass('btn-secondary').addClass('btn-info');
                    } else {
                        if (data.form) {
                            $(".mensaje_error").empty()
                            data.form.forEach(function (val, indx) {
                                var keys = Object.keys(val);
                                keys.forEach(function (val1, indx1) {
                                    {#$("#id_" + val1).addClass("is-invalid");#}
                                    $("#errorMessage" + val1).html('* ' + val[val1]);
                                });
                            });
                        }
                        alertaDanger(data.mensaje);
                    }
                },
                error: function () {
                    $.unblockUI();
                    smoke.alert("Error de conexi√≥n.");
                },
                dataType: "json",
                cache: false,
                contentType: false,
                processData: false
            });
        }

        /*
        const __validacionselecciontema = (obj) => {
            if (habilitaregistroasistencia === false) {
                if (obj) { obj.checked = !obj.checked }
                let __msj = `A√∫n no has seleccionado un <b>Tema</b>. Es necesario hacerlo para registrar la asistencia correctamente`;
                $('#itemspanelalertaregistrotema .cuerpo-mensaje').html(__msj);
                $('#itemspanelalertaregistrotema').modal('show');
                return false;
            }

            return true;
        }
         */


        count = (self) => {
            $('#itemspanelactuacionclase .chars').html(self.value.length + "/150 caracteres");
            $('#itemspanelactuacionclase .words').html((self.value.length > 0) ? self.value.trim().split(/\s+/).length + " palabras" : 0 + " palabras");
        }

	</script>
	<style>
        .fa fa-folder-open{background-position:-408px -120px;width:16px;}
        .well{min-height:20px;padding:19px;margin-bottom:20px;background-color:#f5f5f5;border:1px solid #e3e3e3;-webkit-border-radius:4px;-moz-border-radius:4px;border-radius:4px;-webkit-box-shadow:inset 0 1px 1px rgba(0, 0, 0, 0.05);-moz-box-shadow:inset 0 1px 1px rgba(0, 0, 0, 0.05);box-shadow:inset 0 1px 1px rgba(0, 0, 0, 0.05);}.well blockquote{border-color:#ddd;border-color:rgba(0, 0, 0, 0.15);}
        .well-large{padding:24px;-webkit-border-radius:6px;-moz-border-radius:6px;border-radius:6px;}
        .well-small{padding:9px;-webkit-border-radius:3px;-moz-border-radius:3px;border-radius:3px;}
        .close{float:right;font-size:20px;font-weight:bold;line-height:20px;color:#000000;text-shadow:0 1px 0 #ffffff;opacity:0.2;filter:alpha(opacity=20);}.close:hover,.close:focus{color:#000000;text-decoration:none;cursor:pointer;opacity:0.4;filter:alpha(opacity=40);}
        button.close{padding:0;cursor:pointer;background:transparent;border:0;-webkit-appearance:none;}
        .tree {
            min-height:20px;
            padding:19px;
            margin-bottom:20px;
            background-color:#fbfbfb;
            border:1px solid #999;
            -webkit-border-radius:4px;
            -moz-border-radius:4px;
            border-radius:4px;
            -webkit-box-shadow:inset 0 1px 1px rgba(0, 0, 0, 0.05);
            -moz-box-shadow:inset 0 1px 1px rgba(0, 0, 0, 0.05);
            box-shadow:inset 0 1px 1px rgba(0, 0, 0, 0.05)
        }
        .tree li {
            list-style-type:none;
            margin: 0;
            padding:10px 5px 0 5px;
            position:relative
        }
        .tree li::before, .tree li::after {
            content:'';
            left:-20px;
            position:absolute;
            right:auto
        }
        .tree li::before {
            border-left:1px solid #999;
            bottom:50px;
            height:100%;
            top:0;
            width:1px
        }
        .tree li::after {
            border-top:1px solid #999;
            height:20px;
            top:25px;
            width:25px
        }
        .tree li span {
            -moz-border-radius:5px;
            -webkit-border-radius:5px;
            border:1px solid #999;
            border-radius:5px;
            display:inline-block;
            padding:3px 8px;
            text-decoration:none
        }
        .tree li.parent_li>span {
            cursor:pointer
        }
        .tree>ul>li::before, .tree>ul>li::after {
            border:0
        }
        .tree li:last-child::before {
            height:30px
        }
        .tree li.parent_li>span:hover, .tree li.parent_li>span:hover+ul li span {
            background:#eee;
            border:1px solid #94a0b4;
            color:#000
        }
        .btn-flotante-close {
            font-size: 12px; /* Cambiar el tama√±o de la tipografia */
            text-transform: uppercase; /* Texto en mayusculas */
            font-weight: bold; /* Fuente en negrita o bold */
            color: #ffffff; /* Color del texto */
            border-radius: 15px; /* Borde del boton */
            letter-spacing: 2px; /* Espacio entre letras */
            /*background-color: #51a351;*/ /* Color de fondo */
            padding: 15px 15px; /* Relleno del boton */
            position: fixed;
            bottom: 55px;
            right: 10px;
            transition: all 300ms ease 0ms;
            box-shadow: 0px 8px 15px rgba(0, 0, 0, 0.1);
            z-index: 99;
        }
        .btn-flotante-close:hover {
            /*background-color: #2c2fa5;*/
            box-shadow: 0px 15px 20px rgba(0, 0, 0, 0.3);
            color: #ffffff;
            transform: translateY(-10px);
        }
        .btn-flotante-zoom {
            font-size: 12px; /* Cambiar el tama√±o de la tipografia */
            text-transform: uppercase; /* Texto en mayusculas */
            font-weight: bold; /* Fuente en negrita o bold */
            color: #ffffff; /* Color del texto */
            border-radius: 15px; /* Borde del boton */
            letter-spacing: 2px; /* Espacio entre letras */
            /*background-color: #51a351;*/ /* Color de fondo */
            padding: 15px 15px; /* Relleno del boton */
            position: fixed;
            bottom: 55px;
            right: 220px;
            transition: all 300ms ease 0ms;
            box-shadow: 0px 8px 15px rgba(0, 0, 0, 0.1);
            z-index: 99;

        }
        .btn-flotante-zoom:hover {
            /*background-color: #2c2fa5;*/
            box-shadow: 0px 15px 20px rgba(0, 0, 0, 0.3);
            color: #ffffff;
            transform: translateY(-10px);
        }
        @media only screen and (max-width: 600px) {
            .btn-flotante-close, .btn-flotante-zoom  {
                /*font-size: 14px;
                padding: 12px 20px;
                bottom: 55px;
                right: 10px;*/
                position: inherit;

                padding: 12px 20px;
                font-size: 14px;
                padding: 7px 15px;
                font-size: 14.5px;
                -webkit-border-radius: 6px;
                -moz-border-radius: 6px;
                border-radius: 6px;
                font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            }
            /*.btn-flotante-zoom {
                font-size: 14px;
                padding: 12px 20px;
                bottom: 110px;
                right: 10px;
            }*/
        }

        table.table .label, table.table .badge {
            font-size:12px!important;
        }

        table.table .label > i {
            font-size:9px!important;
        }

        .btn-outline-primary {
            border-color: #3797CF;
            color: #3797CF;
        }

        .btn-outline-primary:hover{
            background-color: #3797CF;
            color: #fff;
            border-color: #3797CF;
        }

        ::-webkit-scrollbar {width: 10px; height: 10px;}

        ::-webkit-scrollbar-track {background-color: #E7F0F8;}

        ::-webkit-scrollbar-thumb {background-color: #A8B4BF;}

        input[type="checkbox"]:checked {
            background-color: #15CA9A;border-color: #15CA9A;
        }

        input[type="checkbox"]:hover {
            cursor:pointer;border-color: #15CA9A;
        }

	</style>
{% endblock %}
{% block atras %}/pro_clases{% endblock %}
{% block canvas %}
	<div class='container'>
		<div class='row'>
			<div class='col-lg-12 ps-1'>
				<div class="headtitle ps-0">
					<h3 class="my-0 py-0">{{ title }}</h3>
					<h6>Aula: {{ lecciongrupo.aula|title }} | Fecha: {{ lecciongrupo.fecha|date:"d-m-Y" }} | Hora Inicio: {{ lecciongrupo.horaentrada }} {% if not lecciongrupo.abierta %}Hora Fin: {{ lecciongrupo.horasalida }}{% endif %} {{ turno }} {% if silabosemanal %}| Semana: {{ silabosemanal.numsemana }}{% endif %}</h6>
				</div>
			</div>
		</div>
		<!-- Alerta con informaci√≥n -->
		<div class="row">
			<div class="col-sm-12 ms-2">
				{% if contar_llenos > 0 %}
					<div id="contenidocentral">
						{% with perfilprofesional=materia.asignaturamalla.malla.perfilprofesional %}
							{% if  perfilprofesional %}
								<div class="row">
									<div class="col-sm-{% if contar_llenos == 4 %}3{% elif contar_llenos == 3 %}4{% elif contar_llenos == 2 %}6{% elif contar_llenos == 1 %}12{% endif %}">
										<div class="alert alert-info" style="text-align: justify">
											<a  href="javascript:;" class="close" data-dismiss="alert">√ó</a>
											<h4 class="alert-heading">PERFIL PROFESIONAL</h4>
											<p id="menperfil">{{  perfilprofesional|substraerconpunto:350|linebreaksbr }}</p>
											{% if  perfilprofesional|contarcaracter:350 %}
												<a href="javascript:;" class="alert-link leer" id="nleer2" descripcion="{{  perfilprofesional|linebreaksbr }}" v="2" ver="1">Leer mas</a>
											{% endif %}
										</div>
									</div>
								</div>
							{% endif %}
						{% endwith %}
					</div>
				{% endif %}
			</div>
		</div>

		{% for leccion in lecciones %}
            <div class="row">
                <div class="col-sm-12">
                    <strong>Materia: </strong>
					{{ leccion.clase.materia.asignaturamalla.asignatura.nombre|title2 }} | {{ leccion.clase.materia.identificacion }} | {{ leccion.clase.materia.paralelo }} | {{ leccion.clase.materia.asignaturamalla.malla.carrera.nombre|title2 }}
					{% if leccion.clase.tipoprofesor.id == 2 and leccion.clase.grupoprofesor and leccion.clase.grupoprofesor.paralelopractica %}
						| <span title="Paralelo de practica">{{ leccion.clase.grupoprofesor.get_paralelopractica_display|lower }}</span>
					{% endif %}
                    {% if DEBUG %}
                        - {{ leccion.clase.materia.pk }}
                    {% endif %}
					<br>
					<strong>Modalidad: </strong> <span class="text-info me-4">{{ leccion.clase.get_tipohorario_display|lower|capfirst }} - {{ leccion.clase.tipoprofesor|lower|capfirst }}</span>
					<strong>Profesor: </strong> {{ leccion.clase.profesor.persona.nombre_completo|title }}
                </div>
            </div>
			<div class='row'>
				<div class='col-sm-8'>
                    <div class="row">
						<div class="col-sm-12 d-flex justify-content-between">
							<div class="headtitle ms-0 ps-1 my-3">
								<h3 class="py-0">Estudiantes</h3>
							</div>
						</div>
					</div>
					<div class="table-responsive">
						<table class='table table_primary table_striped' >
							<thead>
							<tr style="position: sticky;top: 0;">
								<th style="width: 5%; text-align: center; vertical-align: middle;text-transform: capitalize!important;">#</th>
								<th style="width: 6%; text-align: center; vertical-align: middle;text-transform: capitalize!important;">Foto</th>
								<th style="width: 33%; text-align: center; vertical-align: middle;text-transform: capitalize!important;">Estudiantes</th>
								<th style="width: 15%; text-align: center; vertical-align: middle;text-transform: capitalize!important;">Observaciones</th>
								<th style="width: 10%;text-align: center; vertical-align: middle;text-transform: capitalize!important;">% Asistencia</th>
								<th style="width: 8%;text-align: center; vertical-align: middle;text-transform: capitalize!important;">
									{% if lecciongrupo.abierta %}
										{% if clase.tipohorario <= 1 or clase.tipohorario == 7 %}
											<input class="form-check-input tu" type="checkbox" id="selectortotalasistencia" title="Marcar todas" idl="{{ lecciongrupo.id }}">
										{% endif %}
									{% endif %}
								</th>
								<th style="width: 23%; text-align: center; vertical-align: middle;text-transform: none!important;">Actuaci√≥n en clase</th>
							</tr>
							</thead>
							<tbody>
							{% for asistencia in leccion.mis_asistencias %}
								<tr>
									<td style="vertical-align: middle; text-align: center"><strong>{{ forloop.counter }}</strong></td>
									{% with materiaasignada=asistencia.materiaasignada alumno=asistencia.materiaasignada.matricula.inscripcion.persona foto=alumno.foto puede_tomar_asistencia=asistencia.puede_tomar_asistencia %}
										<td style="text-align: center; vertical-align: middle;">
											{% if alumno.foto.foto and verfoto %}
												<a title="{{ alumno.nombre_completo }}" href="{% if DEBUG %}https://sga.unemi.edu.ec{% endif %}{{ alumno.foto.foto.url }}" class="fancybox" rel="group">
													<img style="border-radius: 50% !important;" src="{% if DEBUG %}https://sga.unemi.edu.ec{% endif %}{{ alumno.foto.foto.url }}" onerror="this.onerror=null;this.src='/static/images/image.png'" width="45" height="45">
												</a>
											{% else %}
												{% if alumno.sexo_id == 1 %}
													<img style="width: 20px; height: 20px;border-radius: 50% !important" class="img-circle" src="{% if DEBUG %}https:/sga.unemi.edu.ec{% endif %}/static/images/iconos/mujer.png" width="45" height="45">
												{% else %}
													<img style="width: 20px; height: 20px;border-radius: 50% !important" class="img-circle" src="{% if DEBUG %}https:/sga.unemi.edu.ec{% endif %}/static/images/iconos/hombre.png" width="45" height="45">
												{% endif %}
											{% endif %}
										</td>
										<td style="vertical-align: middle;">
											<strong>{{ alumno|title }}</strong>
                                            <br>
											<span style="font-size: 12px!important;">
												{% if asistencia.materiaasignada.matricula.inscripcion.persona.telefono and asistencia.materiaasignada.matricula.inscripcion.persona.telefono %}
													<span>
                                                        <a href='https://web.whatsapp.com/send?l=en&phone=+593{{ asistencia.materiaasignada.matricula.inscripcion.persona.telefono }}&text=Hola {{ asistencia.materiaasignada.matricula.inscripcion.persona|title }}' target="_blank" class="border-0 tu" title="Enviar mensaje por whatsapp">
                                                            <i class="fa fa-whatsapp text-success"></i> <span class="text-dark">{{ asistencia.materiaasignada.matricula.inscripcion.persona.telefono }}</span>
                                                        </a>
                                                    </span>
												{% endif %}
												{% if materiaasignada.matricula.bloqueomatricula %}
													<span class="label bg-danger">Matricula bloqueada</span>
												{% endif %}
												{% if materiaasignada.matriculas > 1 %}
													<span class="label bg-danger">{{ materiaasignada.matriculas }}{% if materiaasignada.matriculas == 2 %}da {% elif materiaasignada.matriculas == 3 or materiaasignada.matriculas == 1 %}ra {% endif %} matricula</span>
												{% endif %}
												{% if materiaasignada.retiramateria %}
													<span class='label bg-danger'>Retirado</span>
												{% else %}
													{% if alumno.datos_incompletos and incluyedatos %}
														<span class='label label-info'>Datos incompletos</span>
													{% endif %}
												{% endif %}
												{% if alumno.tiene_discapasidad_new %}
													<span class='label label-warning'><i class="fa fa-user"></i>{{ alumno.discapasidad.tipodiscapacidad.nombre }} ({{ alumno.discapasidad.porcientodiscapacidad|floatformat:0 }}%)</span>
												{% endif %}
												{% if materiaasignada.matricula.inscripcion.persona.ppl %}
													<span style="cursor:pointer;" class="label label-warning verdetalleppl" idmat="{{ materiaasignada.matricula.id|encrypt }}" href="javascript:;"><i class="fa fa-user"></i> PPL</span>
												{% endif %}
												<span id="asistencia_virtual_{{ materiaasignada.id }}" class="label label-secondary">{% if asistencia.virtual %}Ingres√≥ a la clase a las {{ asistencia.virtual_hora|date:"h:i:s" }} desde {{ asistencia.browser }} con la IP {{ asistencia.ip_public }}{% endif %}</span>
                                            </span>
										</td>
										<td style="text-align: center; vertical-align: middle">
											<button href="javascript:;" class="btn btn-outline-primary border-2 px-2 py-0 action-observacion" id="btn_action_observacion_{{ asistencia.id }}" type="{% if leccion.abierta and puede_tomar_asistencia %}add{% else %}view{% endif %}" ida="{{ asistencia.id }}">
                                                <span type="button" class="position-relative mt-1">
                                                    <i style="font-size: 16px" class="bi bi-chat-left-text"></i>
                                                    <span id="dot-{{ asistencia.pk }}" {% if not asistencia.num_observacion %}style="display:none;"{% endif %} class="position-absolute top-0 start-100 translate-middle p-1 bg-warning border border-light rounded-circle mt-1">
                                                        <span class="visually-hidden">...</span>
                                                    </span>
                                                </span>
											</button>
										</td>
										<td style="text-align: center; vertical-align: middle;">
											<span id='porcientoasist{{ asistencia.id }}' class="badge {% if not materiaasignada.porciento_requerido %}bg-danger{% else %}bg-success{% endif %}">{{ materiaasignada.asistenciafinal|floatformat:0 }}%</span>
										</td>
										<td style="text-align: center; vertical-align: middle;" id="tab{{ asistencia.id }}">
											{% if leccion.abierta or leccion.solicitada  %}
												{% if not materiaasignada.matricula.bloqueomatricula %}
													<input class="selectorasistencia form-check-input" type='checkbox' id_asist_ma="{{ materiaasignada.id }}" idasis='{{ asistencia.id }}' id='check{{ asistencia.id }}' {% if asistencia.asistio %} checked="true" {% endif %} {% if not puede_tomar_asistencia %} disabled="disabled" {% endif %}/>
												{% else %}
													<i class="fa fa-remove tu" style="color: red" title="Falta"></i>
												{% endif %}
											{% else %}
												{% if asistencia.asistio %}
													<i class="fa fa-check tu check_presente check_count" style="color: darkgreen" title="Presente"></i>
												{% else %}
													<i class="fa fa-remove tu check_ausente check_count" style="color: red" title="Falta"></i>
												{% endif %}
											{% endif %}
										</td>
										<td style="text-align: center; vertical-align: middle; width: 150px">
											{% if leccion.abierta and puede_tomar_asistencia %}
												<button href="javascript:;" ida='{{ asistencia.id }}' type="2" class='xremoveevalbutton removeevalbutton{{ asistencia.id }} btn btn-mini btn-default py-0 show-class-performance'><i class="fa fa-minus" style="font-size:9px;"></i></button>
											{% endif %}
											<span id='eval{{ asistencia.id }}'>
                                            {% with eval=asistencia.evaluaciones %}
                                                {% if eval %}
                                                    {% for evaluacion in eval %}
                                                        {% if forloop.last %}
                                                            <a style="border-radius: 20px;padding-bottom: 0.2rem !important;padding-top: 0.2rem !important;" href="javascript:;" class='btn btn-info px-4 unique-value-{{ asistencia.pk }} show-class-performance' ida="{{ asistencia.pk }}" type="1">
                                                                {{ asistencia.promedio_evaluacion|floatformat:0 }}
                                                            </a>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% else %}
                                                    <a style="border-radius: 20px;padding-bottom: 0.2rem !important;padding-top: 0.2rem !important;" href="javascript:;" class='btn btn-secondary px-4 unique-value-{{ asistencia.pk }} show-class-performance' ida="{{ asistencia.pk }}" type="1">0</a>
                                                {% endif %}
                                            {% endwith %}
                                            </span>
											{% if leccion.abierta and puede_tomar_asistencia %}
												<button alu="{{ alumno|lower|title }}" href="javascript:;" ida='{{ asistencia.id }}' class='btn btn-mini btn-default py-0 add-class-performance'><i class="fa fa-plus" style="font-size:9px;"></i></button>
											{% endif %}
										</td>
									{% endwith %}
								</tr>
							{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
				<div class='col-sm-4'>
					{% if forloop.first %}
						<br>
						<div class="row mb-2">
							<div class="col-sm-12">
								{% if utiliza_zoom %}
									{% if not url %}
										<div class="alert alert-info" style="text-align: justify">
											<h4 class="alert-heading">AVISO</h4>
											<p>
												<b>{% if clase.profesor.persona.es_mujer %}Estimada{% else %}Estimado{% endif %} docente no registra enlace de ZOOM.</b>
											</p>
										</div>
									{% else %}
										{% if url and not clase.tipohorario == 1 %}
											<a href="{{ url }}" target="_blank" class='btn btn-success btn-large'><i class="fa fa-video-camera" ></i> Ir al Meet</a>
										{% elif url and clase.tipohorario == 1 and autorizado_clase_virtual %}
											<a href="{{ url }}" target="_blank" class='btn btn-success btn-large'><i class="fa fa-video-camera" ></i> Ir al Meet</a>
										{% endif %}
									{% endif %}
								{% endif %}
                                {% if lecciongrupo.abierta %}
								    <a href="javascript:;" class='btn btn-danger btn-large px-3 action_close_class'><i class="bi bi-x-circle"></i> Cerrar</a>
                                {% endif %}
								{% if asistencia_en_grupo and lecciongrupo.abierta %}
									<a href="javascript:;"  class="btn btn-info btn-large enviarasistencia tu" title="Guardar asistencias" idl="{{ lecciongrupo.id }}"><i class="fa fa-save" ></i> Guardar Asistencia</a>
								{% endif %}
                                <a href="javascript:;" class="btn border-0 mb-1" style="cursor:default;">&nbsp;</a>
							</div>
						</div>
						<table class="table table_primary table_striped">
							<thead>
							<tr>
								<th colspan="3" style="text-transform:none!important;text-align: center">Asistencias</th>
							</tr>
							</thead>
							<tbody>
							<tr>
								<td style="text-align: center; width: 33%">Presentes</td>
								<td style="text-align: center; width: 33%">Ausentes</td>
								<td style="text-align: center; width: 33%">Total</td>
							</tr>
							<tr>
								<td style="text-align: center" id="presentes">{{ presentes }}</td>
								<td style="text-align: center" id="ausentes">{{ ausentes }}</td>
								<td style="text-align: center" id="totalasistencias">{{ totalasistencias }}</td>
							</tr>
							</tbody>
						</table>
                        <div class="row">
                            {% include 'pro_clases/leccion_silabo_v2.html' %}
                        </div>
						<table class="table table_primary table_striped">
							<thead>
							<tr>
								<th colspan="2" style="text-transform: none!important;">Observaciones</th>
							</tr>
							</thead>
							<tbody>
							<tr>
								<td style="width: 25px;%">
									<div style="width: 15px; height: 15px;background-color: rgb(240, 128, 128)"></div>
								</td>
								<td style="font-size:10px;">Error al enviar los datos, debido a fallas de conectividad.</td>
							</tr>
							<tr>
								<td style="width: 25px;%">
									<div style="width: 15px; height: 15px;background-color: rgb(148, 255, 183)"></div>
								</td>
								<td style="font-size:10px;">Los datos fueron enviados correctamente.</td>
							</tr>
							<tr>
								<td style="width: 25px;%">
									<div style="width: 15px; height: 15px;background-color: rgb(217, 237, 247)"></div>
								</td>
								<td style="font-size:10px;">Los datos estan en proceso de ser enviados.</td>
							</tr>
							<tr>
								<td colspan="2"></td>
							</tr>
							</tbody>
						</table>

						<div class="row">
							<div class="col-sm-12">
								{% if url and clase.tipohorario != 1 %}
									<a href="{{ url }}" target="_blank" class='btn btn-success btn-large'><i class="fa fa-video-camera" ></i> Ir al Meet</a>
								{% elif url and clase.tipohorario == 1 and autorizado_clase_virtual %}
									<a href="{{ url }}" target="_blank" class='btn btn-success btn-large'><i class="fa fa-video-camera" ></i> Ir al Meet</a>
								{% endif %}
								{% if lecciongrupo.abierta %}
									<a href="javascript:;" class='btn btn-danger btn-large action_close_class px-3'><i class="bi bi-x-circle"></i> Cerrar</a>
								{% endif %}
								{% if asistencia_en_grupo and lecciongrupo.abierta %}
									<a href="javascript:;"  class="btn btn-info btn-large enviarasistencia tu" title="Guardar asistencias" idl="{{ lecciongrupo.id }}"><i class="fa fa-save" ></i> Guardar Asistencia</a>
								{% endif %}
							</div>
						</div>
					{% endif %}
				</div>
			</div>
		{% endfor %}
	</div>

	<div class="modal fade static" id="incidenciaspanel" style="display: none;">
		<div class="modal-dialog modal-dialog-centered modal-md">
			<div class="modal-content">
				<div class="modal-header">
					<div class="headtitle"><h3 class="paneltitle fw-bolder py-0" style="font-size: 14px;">Adicionar Incidencia de Clase</h3></div>
					<button type="button" class="btn btn-close btn-default rounded-circle p-3 my-0" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form class="form-horizontal">
						<fieldset class="control-group nomargins">
							<label class="control-label" for="id_tipo">Tipo</label>
							<div class="controls">
								<select id="id_tipo">
									{% for tipoincidencia in tiposincidencias %}
										<option value="{{ tipoincidencia.id }}">{{ tipoincidencia.nombre }}</option>
									{% endfor %}
								</select>
							</div>
						</fieldset>
						<fieldset class="control-group nomargins">
							<label class="control-label" for="id_contenido">Descripci&oacute;n</label>
							<div class="controls">
								<textarea name="id_contenido" id="id_contenido"></textarea>
							</div>
						</fieldset>
					</form>
					<div id="panelalert">
					</div>
				</div>
				<div class="modal-footer">
					<a href="javascript:;" class="btn" id="btn-cerrar">Cerrar</a>
					<a href="javascript:;" class="btn btn-primary" id="btn-ejecutar"><span class="fa fa-plus " ></span> Adicionar</a>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade static" id="mensajepanel" data-backdrop="static" data-keyboard="false" >
		<div class="modal-dialog modal-dialog-centered modal-md">
			<div class="modal-content">
				<div class="modal-header">
					<div class="headtitle">
						<h3 class="paneltitle fw-bolder py-0" style="font-size: 14px;">Mensaje</h3>
					</div>
					<button type="button" class="btn btn-close btn-default rounded-circle p-3 my-0" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body" style="height: 60px;">
					<div id='mensaje'>
					</div>
				</div>
				<div class="modal-footer" hidden="hidden">
					<a href="javascript:;" class="btn btn-cerrar btn-info">Cerrar</a>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade static" id="modalViewAsistenciaObservacion" style="display: none;">
		<div class="modal-dialog modal-dialog-centered modal-lg">
			<div class="modal-content">
				<div class="modal-body">
					<div class="container">
						<div class="panelbody"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade static" id="modalAddAsistenciaObservacion" style="display: none;">
		<div class="modal-dialog modal-dialog-centered modal-lg">
			<div class="modal-content">
				<div class="modal-header border-0">
					<div class="headtitle"><h3 class="paneltitle fw-bolder py-0" style="font-size: 14px;">Observaci√≥n</h3></div>
					<button type="button" class="btn btn-close btn-default rounded-circle p-3 my-0" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="panelbody">
						<input type="hidden" value="" name="ida">
						<input type="hidden" value="" name="ido">
						<input type="hidden" value="{{ type }}" name="type">
						<div class="row">
							<div class="col-sm-12">
								<textarea style="width: 100%!important;" rows="5" name="observacion"></textarea>
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer border-0">
					<a href="javascript:;" class="btn btn-success action-save"> Guardar</a>
					<a href="javascript:;" class="btn btn-info action-close"> Cancelar</a>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade static" id="itemspanelverdetalleppl" style="display: none;">
		<div class="modal-dialog modal-dialog-centered modal-lg">
			<div class="modal-content">
				<div class="modal-header border-0">
					<div class="ps-1"><h3 class="fw-bolder py-0" style="font-size: 14px;">Detalle de PPL</h3></div>
					<button type="button" class="btn btn-close btn-default rounded-circle p-3 my-0" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body border-0">
					<div class="row">
						<div class="col-sm-12">
							<div class="panelbodydetalleppl"></div>
						</div>
					</div>
				</div>
				<div class="modal-footer border-0" style="justify-content:center!important;">
					<a href="javascript:;" class="btn btn-danger" data-bs-dismiss="modal"><i class="bi bi-x-circle"></i> Cerrar</a>
				</div>
			</div>
		</div>
	</div>

    <div class="d-none div-form-add-class-performance">
        <form action="{{ request.path }}" type="POST" id="form-add-class-performance">
            <input type="hidden" name="id" value="">
            <input type="hidden" name="action" value="evaluar">
            <div class="mb-3">
              <b>Puntuaci√≥n: <span class="text-danger">*</span></b><br>
              <input type="number" class="form-control" id="exampleFormControlInput1" value="1" max="10" name="val">
            </div>
            <div class="mb-3">
                <b>Observaci√≥n: <span class="text-danger">*</span></b><br>
                <textarea onkeyup="count(this)" style="width: 100%!important;height: 100px!important;" id="exampleFormControlTextarea1" rows="1" maxlength="150" name="obs" placeholder="Ingrese una observaci√≥n de entre 1 y 150 caracteres..."></textarea>
                <span style="float: right;font-size: 11px;"><span class="chars text-secondary me-2">0/150 caracteres</span><span class="words text-secondary">0 palabras</span></span><br>
            </div>
        </form>
        <br>
        <div class="row-fluid">
            <div class="col-sm-12">
                <div class="btn-group" style="float:right;">
                    <a href="javascript:;" class="btn btn-success me-1 rounded-1" onclick="submit_class_performance()"><i class="bi bi-check-circle"></i> Guardar</a>
                    <a href="javascript:;" class="btn btn-danger rounded-1" data-bs-dismiss="modal"><i class="bi bi-x-circle"></i> Cancelar</a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade static" id="itemspanelactuacionclase" style="display: none;">
		<div class="modal-dialog modal-dialog-centered modal-md">
			<div class="modal-content">
				<div class="modal-header border-0 mt-2">
					<div class="headtitle">
                        <h3 class="fw-bolder py-0 my-0" style="font-size: 14px;">Adicionar actuaci√≥n en clases</h3>
                        <h6 class="subtitle"></h6>
                    </div>
					<button type="button" class="btn btn-close btn-default rounded-circle p-3 my-0" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body border-0 pt-0">
					<div class="container">
                        <div class="row">
						    <div class="col-sm-12">
                                <div class="panelbody"></div>
                            </div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

    <div class="modal fade static" id="itemspanelalertaregistrotema">
		<div class="modal-dialog modal-dialog-centered modal-md">
			<div class="modal-content">
				<div class="modal-body border-0">
					<div class="container">
						<div class="row">
							<div class="col-sm-12">
								<p class="text-center">
									<img src="/static/images/icons/cian-alert.svg" alt="..." width="97" height="97"><br>
									<span class="cuerpo-mensaje fs-3">
                                        Antes de registrar la asistencia, por favor aseg√∫rate de seleccionar un <b>Tema</b> en la secci√≥n <b>Temas y Subtemas</b>
                                    </span>
									<br>
									<br>
									<a href="javascript:;" data-bs-dismiss="modal" class="btn btn-success">Aceptar</a>
								</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

{% endblock %}
{% block extraJs %}
	<link href="/static/switchery/switchery.min.css" rel="stylesheet"/>
	<script src="/static/switchery/switchery.min.js"></script>
	<script>
        $(function(){
            var elems = Array.prototype.slice.call(document.querySelectorAll('.js-switch'));
            elems.forEach(function (html) {
                var switchery = new Switchery(html, {size: 'small', color: '#5DADE2'});
            });
            const key_room = '{{ key_room }}';
            {% if websocket and ePeriodoAcademia and ePeriodoAcademia.utiliza_asistencia_ws %}
                let endPoint = ''
                {% if DEBUG %}
                    endPoint = `ws://127.0.0.1:8000/ws/room/${key_room}`
                {% else %}
                    endPoint = `{{ websocket.url }}/ws/room/${key_room}`
                {% endif %}
                console.log(endPoint);
                const socket = new WebSocket(endPoint);

                socket.onopen = function (e) {
                    console.log('[open] Conexi√≥n establecida clases');
                    socket.send(JSON.stringify({
                        'message': "ping",
                        'type': "puede_entrar_clases",
                        'datos': ""
                    }));
                };
                socket.onmessage = function (event) {
                    console.log(`[message] Datos recibidos del servidor: ${event.data}`);
                    const data = JSON.parse(event.data);
                    console.log(data);
                    if ('type' in data){
                        const type = data['type']
                        if (type == 'entro_clase'){
                            const datos = data['datos']
                            $("#porcientoasist"+datos.id).html(datos.asistenciafinal+"%");
                            if (!datos.porciento_requerido){
                                $("#porcientoasist"+datos.id).removeClass("badge-success");
                                $("#porcientoasist"+datos.id).addClass("badge-important");
                            }else{
                                $("#porcientoasist"+datos.id).removeClass("badge-important");
                                $("#porcientoasist"+datos.id).addClass("badge-success");
                            }
                            if (datos.virtual){
                                let $span = $('#asistencia_virtual_' + datos.materiaasignada);
                                //$span.show();
                                let __html = `Ingres√≥ a la clase a las ${datos.virtual_hora} desde ${datos.browser} con la IP ${datos.ip_public}`;
                                $span.html(__html);
                            }
                            if (datos.asistio && datos.virtual){
                                //console.log("EN LINEA: " + value.asistio && value.virtual);
                                let $el = $("#check"+datos.id);
                                if (!$el.is(':checked')){
                                    $el.prop("checked", true);
                                    $("#porcientoasist"+datos.id).html(datos.asistenciafinal+"%");
                                    if (!datos.porciento_requerido){
                                        $("#porcientoasist"+datos.id).removeClass("badge-success");
                                        $("#porcientoasist"+datos.id).addClass("badge-important");
                                    }else{
                                        $("#porcientoasist"+datos.id).removeClass("badge-important");
                                        $("#porcientoasist"+datos.id).addClass("badge-success");
                                    }
                                }
                            }
                            actualiza_asistencia();
                        }
                    }
                };
                socket.onclose = function (event) {
                    console.log('[close] Conexi√≥n cerrada correctamente clases');
                };
                socket.onerror = function (error) {
                    console.log(`[error] ${error.message}`);
                };
            {% endif %}
        });
	</script>
{% endblock %}
