# -*- coding: latin-1 -*-
import io
import json
import os
import time
import random
# import math
# import statistics as stats
from datetime import datetime, timedelta
from decimal import Decimal
import pandas as pd
# import datetime
import xlrd
import xlwt
import xlsxwriter
from builtins import float
from django.contrib import messages
from django.contrib.auth.models import User
from django.forms.models import model_to_dict
from django.db.models import Q, Sum, Count, F, Max
from django.contrib.auth.decorators import login_required
from django.db import transaction
from django.http import HttpResponseRedirect, HttpResponse, JsonResponse
from django.shortcuts import render, redirect
from django.template import Context
from django.template.loader import get_template
import openpyxl
from openpyxl import load_workbook
from xlwt import *
from django_q.tasks import async_task
from django.db.models.functions import Concat
from Moodle_Funciones import crearhtmlphpmoodle
from decorators import secure_module, last_access
from postulaciondip.models import ESTADO_ADMINISTRATIVO_MATERIA, ActaParalelo, InscripcionPostulante, \
    InscripcionInvitacion, HistorialInvitacion, PasosProceso, InscripcionConvocatoria, Convocatoria, ActaParalelo, \
    PlanificacionMateria, PersonalApoyoMaestria
from postulaciondip.forms import ArchivoInvitacionForm, PlanificacionMateriaForm, PlanificacionMateriaSolicitudForm
from postulaciondip.proccess_background import notificar_planificacion_completa_posgrado
from runback.tasks.sga_niveles import rpt_matriculados_pregrado_sin_modulos
from sagest.models import Rubro, Pago
from settings import MATRICULACION_LIBRE, UTILIZA_GRUPOS_ALUMNOS, NOMBRE_NIVEL_AUTOMATICO, MATRICULACION_POR_NIVEL, \
    CAPACIDAD_MATERIA_INICIAL, CUPO_POR_MATERIA, APROBACION_DISTRIBUTIVO, USA_EVALUACION_INTEGRAL, \
    TIPO_DOCENTE_TEORIA, TIPO_DOCENTE_PRACTICA, TIPO_CUOTA_RUBRO, SITE_STORAGE, TIPO_PERIODO_REGULAR, \
    TIPO_PERIODO_PROPEDEUTICO, HORAS_VIGENCIA, ADMISION_ID, USA_TIPOS_INSCRIPCIONES, NOTA_ESTADO_EN_CURSO, \
    TIPO_INSCRIPCION_INICIAL, TIPO_DOCENTE_FIRMA, TIPO_DOCENTE_AYUDANTIA, MEDIA_URL, JR_USEROUTPUT_FOLDER, DEBUG
from sga.commonviews import adduserdata, obtener_reporte, conflicto_materias_seleccionadas_aux, \
    conflicto_materias_seleccionadas, conflicto_materias_estudiante, matricular_estudiante_enpracticas, \
    actualizar_nota_planificacion, matricular_estudiante_enpracticas_masivo, traerNotificaciones
from sga.excelbackground import reporte_estudiantesaprobadoreprobadosadmision_background, \
    reporte_cumplimiento_titulacion_background, reporte_estudiantesaprobadoreprobadosadmision_matriz_background, \
    reporte_matriculados_nivelacion_background, reporte_matriculados_pregrado_background, reporte_persona_sin_examen, \
    reporte_distributivo_asignaturas_background
from sga.forms import NivelForm, NivelFormEdit, ProfesorMateriaForm, PagoNivelForm, MateriaDividirForm, MateriaNivel, \
    OtroNivelForm, MateriaNivelMalla, CambiarAulaForm, ListaModeloEvaluativoForm, CalificacionDiaForm, \
    FechaExamenesForm, EvaluacionDiaForm, FechafinAsistenciasForm, LaboratorioForm, ImportarArchivoXLSForm, \
    ParaleloForm, PerfilAccesoUsuarioForm, SilaboSemanalForm, SilaboSemanalVirtualForm, \
    VirtualLecturasSilaboForm, VirtualCasosPracticosSilaboForm, VirtualTestSilaboForm, VirtualPresencialSilaboForm, \
    VirtualRecursoSilaboForm, VirtualActividadesSilaboForm, ObservacionSeguimientoSemanalForm, \
    PlanificacionClaseSilaboForm, MateriaParaleloForm, MateriaParalelo2Form, MatricularModuloForm, SubirArchivoForm, MateriaArchivoNotasForm, \
    SubirMatrizInscripcionForm, TurnoForm, MatricularEspecialForm, BloqueForm, ResponsableActaAdmisionForm, PeridooAsignaturaActaAdmisionForm, \
    AsignaturaActaAdmisionForm, PeriodoCalificacionForm
from sga.funciones import log, convertir_fecha, puede_realizar_accion, puede_realizar_accion_afirmativo, \
    null_to_decimal, generar_nombre, fechatope, convertir_fecha_invertida, variable_valor, MiPaginador, \
    null_to_numeric, ok_json, bad_json, notificacion, llenar_requisitostitulacion
from sga.My_Model.Notificacion import My_Notificacion
from sga.My_Model.SubirMatrizSENESCYT import My_SubirMatrizInscripcion, My_RegistroTareaSubirMatrizInscripcion, \
    My_ObservacionSubirMatrizInscripcion, My_HistorialSubirMatrizInscripcion, My_HistorialProcesoSubirMatrizInscripcion, \
    My_CriterioSubirMatrizInscripcion
from sga.My_Model.MatriculaPregrado import My_CoordinacionPregrado, My_MatriculaPregrado, My_InscripcionPregrado, \
    My_CarreraPregrado, My_ConfigMatriculacionPrimerNivel, My_MatriculacionPrimerNivelCarrera
from sga.My_Model.Persona import My_Persona
from sga.models import Periodo, Sede, Carrera, Nivel, Materia, ProfesorMateria, MateriaAsignada, PagoNivel, \
    FirmaPersona, \
    Coordinacion, Asignatura, AsignaturaMalla, BibliograbiaAPASilabo, \
    Malla, ModeloEvaluativo, NivelMalla, EvaluacionGenerica, Leccion, AlumnosPracticaMateria, Matricula, \
    DiasNoLaborable, Clase, HorarioExamen, Inscripcion, RecordAcademico, Archivo, Modalidad, \
    Persona, Sesion, DocumentosDeInscripcion, InscripcionTesDrive, InscripcionTipoInscripcion, EliminarProfesorMateria, \
    PARALELO_CLASE_PRACTICAS, GruposProfesorMateria, TipoProfesor, Paralelo, TopeAlumnosPrimero, Turno, \
    DetalleModeloEvaluativo, PerfilAccesoUsuario, RubricaPreguntas, ProgramaAnaliticoAsignatura, Silabo, \
    DetalleSilaboSemanalTema, DetalleSilaboSemanalSubtema, PlanificacionClaseSilabo, PlanificacionClaseSilabo_Materia, \
    SilaboSemanalVirtual, DetalleSilaboSemanalVirtualSubtema, DetalleSilaboSemanalVirtualTema, VirtualLecturasSilabo, \
    VirtualCasosPracticosSilabo, VirtualTestSilabo, VirtualPresencialSilabo, TIPO_RECURSOS, VirtualMasRecursoSilabo, \
    SubtemaUnidadResultadoProgramaAnalitico, VirtualActividadesSilabo, SilaboSemanal, TIPO_LINK, TIPO_ACTIVIDAD, \
    AuditoriaNotas, AsignaturaMallaPreferencia, Titulacion, ArticuloInvestigacion, RespuestaEvaluacionAcreditacion, \
    ActividadesSakaiAlumno, RespuestaRubrica, LibroKohaProgramaAnaliticoAsignatura, TipoPlanificacionClaseSilabo, \
    Profesor, PracticasPreprofesionalesInscripcion, ParticipantesMatrices, LogDeberes, SoporteAcademicoTutor, \
    HorarioExamenDetalle, MateriaArchivoNotas, ObservacionMateriaArchivoNotas, PerfilUsuario, \
    CriterioSubirMatrizInscripcion, SubirMatrizInscripcion, HistorialProcesoSubirMatrizInscripcion, \
    DetalleDistributivo, ConfirmarMatricula, AuditoriaMatricula, AgregacionEliminacionMaterias, \
    ProfesorDistributivoHoras, Reporte, NivelTitulacion, Bloque, CamposTitulosPostulacion, TIPOHORARIO, Notificacion, \
    SedeVirtual, TipoAula, \
    HorarioExamenDetalleAlumno, Administrativo, RequisitoTitulacionMalla, ProfesorFirmaActaPeriodo, \
    DocumentosFirmadosEvaluaciones, MateriaAsignadaRetiro, RubricaModalidadTipoProfesor, Aula, CriterioDocenciaPeriodo, \
    MateriaTitulacion
from sga.funcionesxhtml2pdf import conviert_html_to_pdf, add_tabla_reportlab, add_graficos_barras_reportlab, \
    generar_pdf_reportlab, add_titulo_reportlab, download_html_to_pdf, convert_html_to_pdf
from sga.templatetags.sga_extras import encrypt
from moodle import moodle
from xml.dom import minidom
from django.db import connections
from sga.celery_task import processMatriculacionPrimerNivel, BackGroundProcessAdmision
from inno.models import PlanificacionParalelo, ResponsableActaAdmision, RequisitoIngresoUnidadIntegracionCurricular,PeriodoActaAdmision, AsignaturaActaAdmision, MateriaAsignadaPlanificacionSedeVirtualExamen, RequisitoMateriaUnidadIntegracionCurricular, HorarioTutoriaAcademica, PresidenteCurso
from inno.funciones import estar_matriculado_todas_asignaturas_ultimo_periodo_academico, \
    asignaturas_aprobadas_primero_penultimo_nivel, ficha_estudiantil_actualizada_completa, \
    haber_aprobado_modulos_ingles, haber_aprobado_modulos_computacion, \
    haber_cumplido_horas_creditos_practicas_preprofesionales, haber_cumplido_horas_creditos_vinculacion, \
    no_adeudar_institucion, tiene_certificacion_segunda_lengua_aprobado_director_carrera, \
    tiene_certificacion_segunda_lengua_sin_aprobar_director_carrera, asignaturas_aprobadas_primero_septimo_nivel, \
    asignaturas_aprobadas_primero_ultimo_nivel
from inno.forms import PresidenteCursoForm

from django.db import transaction, connection
from typing import Any, Hashable, Iterable, Optional
from inno.runBackGround import ReportCalifcacionPeriodo, ReportPlanificacionSedes
from sga.excelbackground import reporte_horarios_y_aulas_background, reporte_reportealumnos_background, reporte_transversales_background

unicode = str
from sga.reportes import elimina_tildes, transform_jasperstarter_new, run_report_v1
import sys


def buscar_dicc(it: Iterable[dict], clave: Hashable, valor: Any) -> Optional[dict]:
    for dicc in it:
        if dicc[clave] == valor:
            return dicc
    return None


def daterange(start_date, end_date):
    for n in range(int((end_date - start_date).days)):
        yield start_date + datetime.timedelta(days=n)


def reporte_planificacion_materias_posgrado(malla_id = 0):
    eMaterias = Materia.objects.filter(status=True,asignaturamalla__malla_id=malla_id)

    output = io.BytesIO()
    workbook = xlsxwriter.Workbook(output)
    ws = workbook.add_worksheet('Listado')
    formatocabeceracolumna = workbook.add_format({
        'bold': 1,
        'border': 1,
        'align': 'center',
        'valign': 'vcenter',
        'bg_color': 'silver',
        'text_wrap': 1,
        'font_size': 10})
    formatocelda = workbook.add_format({
        'border': 1
    })
    fuentecabecera = workbook.add_format({
        'align': 'center',
        'bg_color': 'silver',
        'border': 1,
        'bold': 1
    })
    formatotitulo = workbook.add_format({'align': 'center', 'valign': 'vcenter', 'bold': 1, 'font_size': 14})
    ws.merge_range(0, 0, 0, 20,'UNIVESIDAD ESTATAL DE MILAGRO', formatotitulo)
    columns = [
        (u"PERIODO", 50),
        (u"CARRERA", 50),
        (u"MATERIA", 50),
        (u"PARALELO", 25),
        #
        (u"REQUIERE PROFESOR", 25),
        (u"INICIO PROFESOR", 40),
        (u"FIN PROFESOR", 40),
        (u"REQUIERE PROFESOR AUTOR", 25),
        (u"INICIO PROFESOR AUTOR", 40),
        (u"FIN PROFESOR AUTOR", 40),
        (u"ES INVITADO", 25),
        (u"¿SE LANZA CONVOCATORIA?", 25),
        (u"OBSERVACION PLANIFICACIÓN", 40),
        #
        (u"ESTADO", 40),
        (u"TIPO DOCENTE", 40),
        (u"DENOMINACIÓN", 40),
        (u"TIPO", 40),
        (u"FECHA CONTRATO", 40),
        (u"PAGADO", 40),
        (u"FECHA PAGADO", 40),
        (u"OBSERVACIÓN ADMINISTRATIVO", 40),


    ]
    row_num = 2
    for col_num in range(len(columns)):
        ws.write(row_num, col_num, columns[col_num][0], formatocabeceracolumna)
        ws.set_column(col_num, col_num, columns[col_num][1])
    row_num = 3
    for materia in eMaterias:
        ePlanificacionMateria = PlanificacionMateria.objects.filter(status=True, materia=materia)
        ws.write(row_num, 0, u'%s' % materia.nivel.periodo.__str__(), formatocelda)
        ws.write(row_num, 1, u'%s' % materia.asignaturamalla.malla.carrera.__str__(), formatocelda)
        ws.write(row_num, 2, u'%s' % materia.asignatura.__str__(), formatocelda)
        ws.write(row_num, 3, u'%s' % materia.paralelo.__str__(), formatocelda)
        #solicitud planificacion
        if ePlanificacionMateria.exists():
            ws.write(row_num, 4, u'%s' % 'SI' if ePlanificacionMateria.first().profesor else 'NO', formatocelda)
            ws.write(row_num, 5, u'%s' %  ePlanificacionMateria.first().inicio_profesor.__str__() if ePlanificacionMateria.first().inicio_profesor else 'N/A', formatocelda)
            ws.write(row_num, 6, u'%s' %  ePlanificacionMateria.first().fin_profesor.__str__() if ePlanificacionMateria.first().fin_profesor else 'N/A', formatocelda)
            ws.write(row_num, 7, u'%s' % 'SI' if ePlanificacionMateria.first().autor else 'NO', formatocelda)
            ws.write(row_num, 8, u'%s' %  ePlanificacionMateria.first().inicio_autor.__str__() if ePlanificacionMateria.first().inicio_autor else 'N/A' , formatocelda)
            ws.write(row_num, 9, u'%s' %   ePlanificacionMateria.first().fin_autor.__str__() if ePlanificacionMateria.first().fin_autor else 'N/A', formatocelda)
            ws.write(row_num, 10, u'%s' % 'SI' if ePlanificacionMateria.first().invitado else 'NO', formatocelda)
            ws.write(row_num, 11, u'%s' % 'SI' if ePlanificacionMateria.first().lanzar_convocatoria else 'NO', formatocelda)
            ws.write(row_num, 12, u'%s' % ePlanificacionMateria.first().observacionsolicitud.__str__(), formatocelda)
            #estado administativo
            ws.write(row_num, 13, u'%s' % ePlanificacionMateria.first().get_estado_display().__str__(), formatocelda)
            ws.write(row_num, 14, u'%s' % ePlanificacionMateria.first().tipodocente.__str__() if ePlanificacionMateria.first().tipodocente else 'N/A' , formatocelda)
            ws.write(row_num, 15, u'%s' % ePlanificacionMateria.first().get_denominacion_display().__str__(), formatocelda)
            ws.write(row_num, 16, u'%s' % ePlanificacionMateria.first().get_tipo_display().__str__(), formatocelda)
            ws.write(row_num, 17, u'%s' % ePlanificacionMateria.first().fecha.__str__() if ePlanificacionMateria.first().fecha else 'N/A', formatocelda)
            ws.write(row_num, 18, u'%s' % 'SI' if ePlanificacionMateria.first().pagado else 'NO', formatocelda)
            ws.write(row_num, 19, u'%s' % ePlanificacionMateria.first().fechapago.__str__() if ePlanificacionMateria.first().fechapago else 'N/A', formatocelda)
            ws.write(row_num, 20, u'%s' % ePlanificacionMateria.first().observacion.__str__(), formatocelda)

        else:
            ws.write(row_num, 4, " No planificado", formatocelda)
            ws.write(row_num, 5, " No planificado", formatocelda)
            ws.write(row_num, 6, " No planificado", formatocelda)
            ws.write(row_num, 7, " No planificado", formatocelda)
            ws.write(row_num, 8, " No planificado", formatocelda)
            ws.write(row_num, 9, " No planificado", formatocelda)
            ws.write(row_num, 10, " No planificado", formatocelda)
            ws.write(row_num, 11, " No planificado", formatocelda)
            ws.write(row_num, 12, " No planificado", formatocelda)
            # estado administativo
            ws.write(row_num, 13, " No planificado", formatocelda)
            ws.write(row_num, 14, " No planificado", formatocelda)
            ws.write(row_num, 15, " No planificado", formatocelda)
            ws.write(row_num, 16, " No planificado", formatocelda)
            ws.write(row_num, 17, " No planificado", formatocelda)
            ws.write(row_num, 18, " No planificado", formatocelda)
            ws.write(row_num, 19, " No planificado", formatocelda)
            ws.write(row_num, 20, " No planificado", formatocelda)

        row_num += 1

    workbook.close()
    output.seek(0)
    # Set up the Http response.
    filename = 'reporte_planificacion_materia_posgrado' + random.randint(1, 10000).__str__() + '.xlsx'
    response = HttpResponse(output, content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
    response['Content-Disposition'] = 'attachment; filename=%s' % filename
    return response




@login_required(redirect_field_name='ret', login_url='/loginsga')
# @secure_module
@last_access
@transaction.atomic()
def view(request):
    data = {}
    adduserdata(request, data)
    persona = request.session['persona']
    periodo = request.session['periodo']
    d = datetime.now()
    data['horasegundo'] = d.strftime('%Y%m%d_%H%M%S')
    data['periodos_retencion'] = periodos_retencion = Periodo.objects.filter(status=True, tipo_id=2).exclude(
        pk__in=[15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
                41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66,
                67, 68, 69, 70, 71, 72, 73, 74, 75]).order_by('id')
    if request.method == 'POST':
        action = request.POST['action']

        if action == 'add':
            try:
                periodo = Periodo.objects.get(pk=request.POST['periodo'])
                form = NivelForm(request.POST)
                if not form.is_valid():
                    for k, v in form.errors.items():
                        raise NameError(v[0])
                # if periodo.fin < form.cleaned_data['fin']:
                #     return JsonResponse({"result": "bad", "mensaje": u"Fecha fin no puede ser mayor a la fecha fin del periodo."})
                if periodo.inicio > form.cleaned_data['inicio']:
                    raise NameError(u"Fecha inicio no puede ser mayor a la fecha inicio del periodo.")
                if form.cleaned_data['fechainicioagregacion'] > periodo.inicio:
                    raise NameError(u"Fecha inicio agregación no puede ser mayor a la fecha inicio del periodo.")
                if form.cleaned_data['fechatopematricula'] < form.cleaned_data['fechainicioagregacion']:
                    raise NameError(u"Fecha regular no puede ser menor a la fecha inicio de agregación.")
                if form.cleaned_data['fechatopematriculaext'] < form.cleaned_data['fechatopematricula']:
                    raise NameError(u"Fecha extraordinaria no puede ser menor a la fecha regular.")
                if form.cleaned_data['fechatopematriculaesp'] < form.cleaned_data['fechatopematriculaext']:
                    raise NameError(u"Fecha especial no puede ser menor a la fecha extraordinaria.")
                if form.cleaned_data['fechatopematriculaesp'] > form.cleaned_data['fin']:
                    raise NameError(u"Fecha especial no puede ser mayor a la fecha fin del nivel.")
                if form.cleaned_data['fechafinagregacion'] < form.cleaned_data['fechatopematriculaext']:
                    raise NameError(u"Fecha fin de agregación no puede ser menor a la fecha extraordinaria.")
                if form.cleaned_data['fechafinagregacion'] > form.cleaned_data['fin']:
                    raise NameError(u"Fecha fin de agregación no puede ser mayor a la fecha fin del nivel.")
                if form.cleaned_data['fechafinquitar'] < form.cleaned_data['fechafinagregacion']:
                    raise NameError(u"Fecha fin de retiro no puede ser menor a la fecha fin de agregación.")
                if form.cleaned_data['fechafinquitar'] > form.cleaned_data['fin']:
                    raise NameError(u"Fecha fin de retiro no puede ser mayor a la fecha fin del nivel.")
                if MATRICULACION_LIBRE:
                    coordinacion = Coordinacion.objects.get(pk=request.POST['coordinacion'])
                    if NOMBRE_NIVEL_AUTOMATICO:
                        nombre = form.cleaned_data['sesion'].nombre + ' - ' + coordinacion.alias
                    else:
                        nombre = form.cleaned_data['paralelo']
                    if Nivel.objects.filter(periodo=periodo, sesion=form.cleaned_data['sesion'], modalidad=form.cleaned_data['modalidad'], nivellibrecoordinacion__coordinacion=coordinacion).exists():
                        raise NameError(u"Ya existe un nivel creado en esa sesion y modalidad.")
                    nivel = Nivel(periodo=periodo,
                                  sesion=form.cleaned_data['sesion'],
                                  inicio=form.cleaned_data['inicio'],
                                  fin=form.cleaned_data['fin'],
                                  paralelo=nombre,
                                  modalidad=form.cleaned_data['modalidad'],
                                  sede=coordinacion.sede,
                                  cerrado=False,
                                  fechainicioagregacion=form.cleaned_data['fechainicioagregacion'],
                                  fechatopematricula=form.cleaned_data['fechatopematricula'],
                                  fechatopematriculaex=form.cleaned_data['fechatopematriculaext'],
                                  fechatopematriculaes=form.cleaned_data['fechatopematriculaesp'],
                                  nivelgrado=form.cleaned_data['nivelgrado'],
                                  fechafinagregacion=form.cleaned_data['fechafinagregacion'],
                                  fechafinquitar=form.cleaned_data['fechafinquitar'],
                                  aplicabecas=True if not form.cleaned_data['nivelgrado'] else False)
                    nivel.save(request)
                    nivel.coordinacion(coordinacion)
                else:
                    sede = Sede.objects.get(pk=request.POST['sede'])
                    carrera = Carrera.objects.get(pk=request.POST['carrera'])
                    nivel = Nivel(periodo=periodo,
                                  sede=sede,
                                  carrera=carrera,
                                  malla=form.cleaned_data['malla'],
                                  nivelmalla=form.cleaned_data['nivelmalla'],
                                  sesion=form.cleaned_data['grupo'].sesion if UTILIZA_GRUPOS_ALUMNOS and not MATRICULACION_POR_NIVEL else
                                  form.cleaned_data['sesion'],
                                  modalidad=form.cleaned_data['grupo'].modalidad if UTILIZA_GRUPOS_ALUMNOS and not MATRICULACION_POR_NIVEL else
                                  form.cleaned_data['modalidad'],
                                  grupo=form.cleaned_data['grupo'] if UTILIZA_GRUPOS_ALUMNOS and not MATRICULACION_POR_NIVEL else None,
                                  inicio=form.cleaned_data['inicio'],
                                  fin=form.cleaned_data['fin'],
                                  paralelo=form.cleaned_data['paralelo'],
                                  cerrado=False,
                                  capacidadmatricula=form.cleaned_data['capacidad'],
                                  fechainicioagregacion=form.cleaned_data['fechainicioagregacion'],
                                  fechatopematricula=form.cleaned_data['fechatopematricula'],
                                  fechatopematriculaex=form.cleaned_data['fechatopematriculaext'],
                                  fechatopematriculaes=form.cleaned_data['fechatopematriculaesp'],
                                  fechafinagregacion=form.cleaned_data['fechafinagregacion'],
                                  fechafinquitar=form.cleaned_data['fechafinquitar'],
                                  nivelgrado=form.cleaned_data['nivelgrado'],
                                  aplicabecas=True if not form.cleaned_data['nivelgrado'] else False)
                    nivel.save(request)
                    nivel.coordinacion()
                    malla = form.cleaned_data['malla']
                    nivelmalla = form.cleaned_data['nivelmalla']
                    modelo = ModeloEvaluativo.objects.filter(principal=True)[0]
                    for materiamalla in malla.asignaturamalla_set.filter(nivelmalla=nivelmalla):
                        materianivel = Materia(asignatura=materiamalla.asignatura,
                                               asignaturamalla=materiamalla,
                                               nivel=nivel,
                                               horas=materiamalla.horas,
                                               horassemanales=materiamalla.horas,
                                               creditos=materiamalla.creditos,
                                               identificacion=materiamalla.identificacion,
                                               inicio=periodo.inicio,
                                               fin=periodo.fin,
                                               rectora=materiamalla.rectora,
                                               practicas=materiamalla.practicas,
                                               modeloevaluativo=modelo,
                                               cupo=CAPACIDAD_MATERIA_INICIAL if CUPO_POR_MATERIA else 0,
                                               cerrado=False)
                        materianivel.save(request)
                        materianivel.crear_actualizar_requisitos_uic()
                log(u'Adiciono nivel: %s' % nivel, request, "add")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. <br> %s" % ex.__str__()})

        elif action == 'nivelvisible':
            try:
                nivel = Nivel.objects.get(pk=request.POST['nid'])
                status = True if request.POST['status'] == "1" else False
                ext = nivel.extension()
                ext.visible = status
                ext.save(request)
                log(u'Edito el visibilidad del nivel: %s' % ext, request, "edit")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad"})

        elif action == 'nivelmatricular':
            try:
                nivel = Nivel.objects.get(pk=request.POST['nid'])
                status = True if request.POST['status'] == "1" else False
                ext = nivel.extension()
                ext.puedematricular = status
                ext.save(request)
                log(u'Edito el nivel puede matricular: %s' % ext, request, "edit")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad"})

        elif action == 'afinidad':
            try:
                profesormateria = ProfesorMateria.objects.get(pk=request.POST['idprofesor'])
                data['materia'] = profesormateria.materia
                titulos = profesormateria.titulo_periodo(periodo)
                data['titulacion'] = profesormateria.profesor.persona.mis_titulaciones()
                data['title'] = u'Detalle Título'
                data['titulos'] = titulos
                data['profesormateria'] = profesormateria
                template = get_template("niveles/afinidad.html")
                json_content = template.render(data)
                return JsonResponse({"result": "ok", 'data': json_content})
            except Exception as ex:
                return JsonResponse({"result": "bad"})

        elif action == 'dividir':
            try:
                f = MateriaDividirForm(request.POST)
                if f.is_valid():
                    for ma_id in request.POST.getlist('ins'):
                        ma = MateriaAsignada.objects.get(pk=ma_id, matricula__estado_matricula__in=[2, 3])
                        ma.materia = f.cleaned_data['materia']
                        ma.save(request)
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos."})

        elif action == 'addpagos':
            try:
                nivel = Nivel.objects.get(pk=request.POST['id'])
                f = PagoNivelForm(request.POST)
                if f.is_valid():
                    if PagoNivel.objects.filter(nivel=nivel, tipo=f.cleaned_data['tipo'],
                                                cuota=f.cleaned_data['cuota']).exists():
                        return JsonResponse({"result": "bad", "mensaje": u"Ya existe ese tipo de pago registrado."})
                    pagonivel = PagoNivel(nivel=nivel,
                                          tipo=f.cleaned_data['tipo'],
                                          cuota=f.cleaned_data['cuota'],
                                          fecha=f.cleaned_data['fecha'],
                                          valor=f.cleaned_data['valor'])
                    pagonivel.save(request)
                    log(u'Adiciono pago nivel: %s' % pagonivel, request, "add")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos."})

        elif action == 'editpagos':
            try:
                pagonivel = PagoNivel.objects.get(pk=request.POST['id'])
                nivel = pagonivel.nivel
                f = PagoNivelForm(request.POST)
                if f.is_valid():
                    pagonivel.fecha = f.cleaned_data['fecha']
                    pagonivel.valor = f.cleaned_data['valor']
                    pagonivel.save(request)
                    log(u'Modifico pago nivel: %s' % pagonivel, request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos."})

        elif action == 'edit':
            try:
                f = NivelFormEdit(request.POST)
                nivel = Nivel.objects.get(pk=request.POST['id'])
                if not f.is_valid():
                    for k, v in f.errors.items():
                        raise NameError(v[0])

                if periodo.inicio > f.cleaned_data['inicio']:
                    raise NameError(u"Fecha inicio no puede ser mayor a la fecha inicio del periodo.")
                if f.cleaned_data['fechainicioagregacion'] < periodo.inicio:
                    raise NameError(u"Fecha inicio agregación no puede ser mayor a la fecha inicio del periodo.")
                if f.cleaned_data['fechatopematricula'] < f.cleaned_data['fechainicioagregacion']:
                    raise NameError(u"Fecha regular no puede ser menor a la fecha inicio de agregación.")
                if f.cleaned_data['fechatopematriculaext'] < f.cleaned_data['fechatopematricula']:
                    raise NameError(u"Fecha extraordinaria no puede ser menor a la fecha regular.")
                if f.cleaned_data['fechatopematriculaesp'] < f.cleaned_data['fechatopematriculaext']:
                    raise NameError(u"Fecha especial no puede ser menor a la fecha extraordinaria.")
                if f.cleaned_data['fechatopematriculaesp'] > f.cleaned_data['fin']:
                    raise NameError(u"Fecha especial no puede ser mayor a la fecha fin del nivel.")
                if f.cleaned_data['fechafinagregacion'] < f.cleaned_data['fechatopematriculaext']:
                    raise NameError(u"Fecha fin de agregación no puede ser menor a la fecha extraordinaria.")
                if f.cleaned_data['fechafinagregacion'] > f.cleaned_data['fin']:
                    raise NameError(u"Fecha fin de agregación no puede ser mayor a la fecha fin del nivel.")
                if f.cleaned_data['fechafinquitar'] < f.cleaned_data['fechafinagregacion']:
                    raise NameError(u"Fecha fin de retiro no puede ser menor a la fecha fin de agregación.")
                if f.cleaned_data['fechafinquitar'] > f.cleaned_data['fin']:
                    raise NameError(u"Fecha fin de retiro no puede ser mayor a la fecha fin del nivel.")

                nivel.paralelo = f.cleaned_data['paralelo']
                nivel.inicio = f.cleaned_data['inicio']
                nivel.fin = f.cleaned_data['fin']
                nivel.fechainicioagregacion = f.cleaned_data['fechainicioagregacion']
                nivel.fechatopematricula = f.cleaned_data['fechatopematricula']
                nivel.fechatopematriculaex = f.cleaned_data['fechatopematriculaext']
                nivel.fechatopematriculaes = f.cleaned_data['fechatopematriculaesp']
                nivel.capacidadmatricula = f.cleaned_data['capacidad']
                nivel.fechafinagregacion = f.cleaned_data['fechafinagregacion']
                nivel.fechafinquitar = f.cleaned_data['fechafinquitar']
                log(u'Modifico nivel: %s' % nivel, request, "edit")
                nivel.save(request)
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. <br> %s" % ex.__str__()})

        elif action == 'copy':
            try:
                f = NivelFormEdit(request.POST)
                nivel = Nivel.objects.get(pk=request.POST['id'])
                if not f.is_valid():
                    for k, v in f.errors.items():
                        raise NameError(v[0])
                nuevonivel = Nivel(periodo=nivel.periodo,
                                   sede=nivel.sede,
                                   carrera=nivel.carrera,
                                   modalidad=nivel.modalidad,
                                   malla=nivel.malla,
                                   nivelmalla=nivel.nivelmalla,
                                   sesion=nivel.sesion,
                                   grupo=nivel.grupo,
                                   inicio=f.cleaned_data['inicio'],
                                   fin=f.cleaned_data['fin'],
                                   paralelo=f.cleaned_data['paralelo'],
                                   cerrado=False,
                                   capacidadmatricula=f.cleaned_data['capacidad'],
                                   fechatopematricula=f.cleaned_data['fechatopematricula'],
                                   fechatopematriculaex=f.cleaned_data['fechatopematriculaext'],
                                   fechatopematriculaes=f.cleaned_data['fechatopematriculaesp'],
                                   fechainicioagregacion=f.cleaned_data['fechainicioagregacion'],
                                   fechafinagregacion=f.cleaned_data['fechafinagregacion'],
                                   fechafinquitar=f.cleaned_data['fechafinquitar'],
                                   nivelgrado=nivel.nivelgrado,
                                   aplicabecas=nivel.aplicabecas)
                nuevonivel.save(request)
                for materia in nivel.materia_set.filter(status=True):
                    materianivel = Materia(asignatura=materia.asignatura,
                                           nivel=nuevonivel,
                                           horas=materia.horas,
                                           horassemanales=int(materia.horas / 16),
                                           creditos=materia.creditos,
                                           identificacion=materia.identificacion,
                                           inicio=materia.inicio,
                                           fin=materia.fin,
                                           rectora=materia.rectora,
                                           practicas=materia.practicas,
                                           modeloevaluativo=materia.modeloevaluativo,
                                           cerrado=False)
                    materianivel.save(request)
                    materianivel.crear_actualizar_requisitos_uic()
                for pago in nivel.pagonivel_set.all():
                    pagonivel = PagoNivel(nivel=nuevonivel,
                                          tipo=pago.tipo,
                                          fecha=pago.fecha,
                                          valor=pago.valor)
                    pagonivel.save(request)
                log(u'Adicionó nuevo nivel: %s' % nuevonivel, request, "add")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. <br> %s" % ex.__str__()})

        elif action == 'copypagos':
            try:
                nivel = Nivel.objects.get(pk=request.POST['id'])
                f = OtroNivelForm(request.POST)
                if f.is_valid():
                    nuevonivel = f.cleaned_data['nivel']
                    pagos = nuevonivel.pagonivel_set.all()
                    for pago in pagos:
                        pago.delete()
                    for pago in nivel.pagonivel_set.all():
                        pagonivel = PagoNivel(nivel=nuevonivel,
                                              tipo=pago.tipo,
                                              fecha=pago.fecha,
                                              valor=pago.valor)
                        pagonivel.save(request)
                    log(u'Duplico pagos: %s - %s' % (nivel, f.cleaned_data['nivel']), request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos."})

        elif action == 'horascumplidaspracticavinculacion':
            try:
                periodo = request.POST['idp']
                coordinacion = request.POST['idc']

                periodo = Periodo.objects.filter(pk=int(request.POST['idp']))[0]
                coordinacion = Coordinacion.objects.filter(pk=int(request.POST['idc']))[0]

                output = io.BytesIO()
                workbook = xlsxwriter.Workbook(output)
                ws = workbook.add_worksheet('Listado')

                formatocabeceracolumna = workbook.add_format({
                    'bold': 1,
                    'border': 1,
                    'align': 'center',
                    'valign': 'vcenter',
                    'bg_color': 'silver',
                    'text_wrap': 1,
                    'font_size': 10})

                formatocelda = workbook.add_format({
                    'border': 1
                })

                formatotitulo = workbook.add_format(
                    {'align': 'center', 'valign': 'vcenter', 'bold': 1, 'font_size': 14})

                ws.merge_range(0, 0, 0, 14, 'UNIVERSIDAD ESTATAL DE MILAGRO', formatotitulo)
                ws.merge_range(1, 0, 1, 14, 'DIRECCIÓN DE VINCULACIÓN', formatotitulo)
                ws.merge_range(2, 0, 2, 14, 'HORAS CUMPLIDAS DE PRÁCTICAS LABORALES Y VINCULACIÓN', formatotitulo)
                ws.merge_range(3, 0, 3, 14, coordinacion.nombre + " - " + coordinacion.alias, formatotitulo)

                columns = [
                    (u"MALLA", 20),
                    (u"FACULTAD", 40),
                    (u"CARRERA", 40),
                    (u"NIVEL MALLA", 40),
                    (u"MODALIDAD", 20),
                    (u"CÉDULA", 20),
                    (u"ESTUDIANTE", 15),
                    (u"CORREO INSTITUCIONAL", 35),
                    (u"CORREO PERSONAL", 35),
                    (u"CELULAR", 35),
                    (u"CONVENCIONAL", 35),
                    (u"CANTÓN", 35),
                    (u"HORAS PRÁCTICAS CULMINADAS", 35),
                    (u"HORAS PRÁCTICAS HOMOLOGADAS", 35),
                    (u"HORAS PRÁCTICAS EN ESTADO APROBADO O PENDIENTE", 35),
                    (u"HORAS PRÁCTICAS REQUISITO", 35),
                    (u"HORAS VINCULACIÓN ", 35),
                    (u"HORAS VINCULACIÓN REQUISITO", 35),
                    (u"ASIGNATURAS PENDIENTES", 35)
                ]
                row_num = 4
                for col_num in range(len(columns)):
                    ws.write(row_num, col_num, columns[col_num][0], formatocabeceracolumna)
                    ws.set_column(col_num, col_num, columns[col_num][1])

                matriculas = Matricula.objects.filter(nivel__periodo_id=periodo.id,
                                                      nivel__nivellibrecoordinacion__coordinacion_id=coordinacion.id,
                                                      estado_matricula__in=[2, 3],
                                                      status=True,
                                                      inscripcion__inscripcionnivel__status=True,
                                                      inscripcion__inscripcionnivel__nivel__status=True,
                                                      inscripcion__inscripcionnivel__nivel__orden__in=[7, 8]
                                                      ).exclude(retiradomatricula=True)

                total = matriculas.count()

                # inscripciones = Inscripcion.objects.filter(matricula__nivel__periodo_id=periodo.id,
                #                                       matricula__nivel__nivellibrecoordinacion__coordinacion_id=coordinacion.id,
                #                                       matricula__estado_matricula__in=[2,3],
                #                                       matricula__status=True,
                #                                       inscripcionnivel__status=True,
                #                                       inscripcionnivel__nivel__status=True,
                #                                       inscripcionnivel__nivel__orden__in=[7, 8],
                #                                       inscripcion__persona__cedula='0928892041'
                #                                       ).exclude(matricula__retiradomatricula=True).order_by('persona__apellido1', 'persona__apellido2', 'persona__nombres')
                #
                # totalins = inscripciones.count()

                row_num = 5
                for matricula in matriculas:
                    idins = matricula.inscripcion.persona.perfil_usuario_inscripcion_vigente()
                    inscripcion = Inscripcion.objects.get(pk=idins['inscripcion'])
                    nivelmalla = inscripcion.mi_nivel().nivel

                    if nivelmalla.orden in [7, 8]:
                        malla = inscripcion.carrera.malla()
                        horas_practica_malla = malla.horas_practicas
                        horas_vinculacion_malla = malla.horas_vinculacion

                        facultad = matricula.nivel.coordinacion()
                        carrera = inscripcion.carrera.nombre

                        modalidad = inscripcion.modalidad
                        persona = inscripcion.persona

                        cedula = persona.identificacion()
                        nombres = persona.nombre_completo_inverso()
                        correo_inst = persona.emailinst
                        correo_pers = persona.email
                        celular = persona.telefono
                        telefono = persona.telefono_conv
                        canton = persona.canton.nombre

                        practicas = PracticasPreprofesionalesInscripcion.objects.filter(inscripcion=inscripcion,
                                                                                        status=True,
                                                                                        retirado=False).distinct().order_by(
                            '-fecha_creacion')
                        horas_culminadas = null_to_numeric(
                            practicas.filter(~Q(tiposolicitud=3), culminada=True).aggregate(
                                totalhora=Sum('numerohora'))['totalhora'], 0)
                        horas_culminadas_homo = null_to_numeric(
                            practicas.filter(tiposolicitud=3, culminada=True).aggregate(
                                totalhorahomo=Sum('horahomologacion'))['totalhorahomo'], 0)
                        total_horas_practica_culminada = int(horas_culminadas) + int(horas_culminadas_homo)

                        horas_aprobadas_pend = null_to_numeric(practicas.filter(~Q(tiposolicitud=3), culminada=False,
                                                                                estadosolicitud__in=[2, 4]).aggregate(
                            totalhora=Sum('numerohora'))['totalhora'], 0)
                        horas_aprobadas_pend_homo = null_to_numeric(
                            practicas.filter(tiposolicitud=3, culminada=False, estadosolicitud__in=[2, 4]).aggregate(
                                totalhorahomo=Sum('horahomologacion'))['totalhorahomo'], 0)
                        total_horas_aprobada_pend = int(horas_aprobadas_pend) + int(horas_aprobadas_pend_homo)

                        total_horas_vinculacion = null_to_numeric(
                            ParticipantesMatrices.objects.values('horas').filter(matrizevidencia_id=2, status=True,
                                                                                 proyecto__status=True,
                                                                                 proyecto__tipo=1,
                                                                                 inscripcion__persona=persona).aggregate(
                                totalhoravincu=Sum('horas'))['totalhoravincu'], 0)

                        materias_pendientes = inscripcion.cantidad_materias_pendiente_aprobar()

                        ws.write(row_num, 0, u'%s' % malla, formatocelda)
                        ws.write(row_num, 1, u'%s' % facultad, formatocelda)
                        ws.write(row_num, 2, u'%s' % carrera, formatocelda)
                        ws.write(row_num, 3, u'%s' % nivelmalla, formatocelda)
                        ws.write(row_num, 4, u'%s' % modalidad, formatocelda)
                        ws.write(row_num, 5, u'%s' % cedula, formatocelda)
                        ws.write(row_num, 6, u'%s' % nombres, formatocelda)
                        ws.write(row_num, 7, u'%s' % correo_inst, formatocelda)
                        ws.write(row_num, 8, u'%s' % correo_pers, formatocelda)
                        ws.write(row_num, 9, u'%s' % celular, formatocelda)
                        ws.write(row_num, 10, u'%s' % telefono, formatocelda)
                        ws.write(row_num, 11, u'%s' % canton, formatocelda)
                        if inscripcion.exonerado_practias():
                            ws.write(row_num, 12, 'EXONERADO', formatocelda)
                        else:
                            ws.write(row_num, 12, u'%s' % total_horas_practica_culminada, formatocelda)
                        if inscripcion.exonerado_practias():
                            ws.write(row_num, 13, 'EXONERADO', formatocelda)
                        else:
                            ws.write(row_num, 13, u'%s' % horas_culminadas_homo, formatocelda)
                        if inscripcion.exonerado_practias():
                            ws.write(row_num, 14, 'EXONERADO', formatocelda)
                        else:
                            ws.write(row_num, 14, u'%s' % total_horas_aprobada_pend, formatocelda)
                        if inscripcion.exonerado_practias():
                            ws.write(row_num, 15, 'EXONERADO', formatocelda)
                        else:
                            ws.write(row_num, 15, u'%s' % horas_practica_malla, formatocelda)
                        if inscripcion.exonerado_practias():
                            ws.write(row_num, 16, 'EXONERADO', formatocelda)
                        else:
                            ws.write(row_num, 16, u'%s' % total_horas_vinculacion, formatocelda)
                        ws.write(row_num, 17, u'%s' % horas_vinculacion_malla, formatocelda)
                        ws.write(row_num, 18, u'%s' % materias_pendientes, formatocelda)

                        row_num += 1

                workbook.close()
                output.seek(0)
                # Set up the Http response.
                filename = 'horascumplidaspracvinc_' + coordinacion.alias.lower() + random.randint(1,
                                                                                                   10000).__str__() + '.xlsx'
                response = HttpResponse(output,
                                        content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
                response['Content-Disposition'] = 'attachment; filename=%s' % filename

                return response
            except Exception as ex:
                pass

        elif action == 'horascumplidaspracticavinculacionniveles':
            try:
                periodo = request.POST['idp']
                coordinacion = request.POST['idc']

                periodo = Periodo.objects.filter(pk=int(request.POST['idp']))[0]
                coordinacion = Coordinacion.objects.filter(pk=int(request.POST['idc']))[0]

                output = io.BytesIO()
                workbook = xlsxwriter.Workbook(output)
                ws = workbook.add_worksheet('Listado')

                formatocabeceracolumna = workbook.add_format({
                    'bold': 1,
                    'border': 1,
                    'align': 'center',
                    'valign': 'vcenter',
                    'bg_color': 'silver',
                    'text_wrap': 1,
                    'font_size': 10})

                formatocelda = workbook.add_format({
                    'border': 1
                })

                formatotitulo = workbook.add_format(
                    {'align': 'center', 'valign': 'vcenter', 'bold': 1, 'font_size': 14})

                ws.merge_range(0, 0, 0, 14, 'UNIVERSIDAD ESTATAL DE MILAGRO', formatotitulo)
                ws.merge_range(1, 0, 1, 14, 'DIRECCIÓN DE VINCULACIÓN', formatotitulo)
                ws.merge_range(2, 0, 2, 14, 'HORAS CUMPLIDAS DE PRÁCTICAS LABORALES Y VINCULACIÓN', formatotitulo)
                ws.merge_range(3, 0, 3, 14, coordinacion.nombre + " - " + coordinacion.alias, formatotitulo)

                columns = [
                    (u"MALLA", 20),
                    (u"FACULTAD", 40),
                    (u"CARRERA", 40),
                    (u"NIVEL MALLA", 40),
                    (u"MODALIDAD", 20),
                    (u"CÉDULA", 20),
                    (u"ESTUDIANTE", 15),
                    (u"CORREO INSTITUCIONAL", 35),
                    (u"CORREO PERSONAL", 35),
                    (u"CELULAR", 35),
                    (u"CONVENCIONAL", 35),
                    (u"PAIS", 35),
                    (u"PROVINCIA", 35),
                    (u"CANTÓN", 35),
                    (u"HORAS PRÁCTICAS CULMINADAS", 35),
                    (u"HORAS PRÁCTICAS HOMOLOGADAS", 35),
                    (u"HORAS PRÁCTICAS EN ESTADO APROBADO O PENDIENTE", 35),
                    (u"HORAS PRÁCTICAS REQUISITO", 35),
                    (u"HORAS VINCULACIÓN ", 35),
                    (u"HORAS VINCULACIÓN REQUISITO", 35),
                    (u"ASIGNATURAS PENDIENTES", 35)
                ]
                row_num = 4
                for col_num in range(len(columns)):
                    ws.write(row_num, col_num, columns[col_num][0], formatocabeceracolumna)
                    ws.set_column(col_num, col_num, columns[col_num][1])

                matriculas = Matricula.objects.filter(nivel__periodo_id=periodo.id,
                                                      inscripcion__carrera__coordinacion__id=coordinacion.id,
                                                      status=True,
                                                      retiradomatricula=False
                                                      ).exclude(inscripcion__coordinacion__id__in=[9,7,10] )


                total = matriculas.count()

                row_num = 5
                for matricula in matriculas:
                    # idins = matricula.inscripcion.persona.perfil_usuario_inscripcion_vigente()
                    # inscripcion = Inscripcion.objects.get(pk=idins['inscripcion'])
                    inscripcion = matricula.inscripcion
                    nivelmalla = inscripcion.mi_nivel().nivel
                    nivemallamatricula = matricula.nivelmalla
                    malla = inscripcion.carrera.malla()
                    horas_practica_malla = malla.horas_practicas
                    horas_vinculacion_malla = malla.horas_vinculacion

                    facultad = matricula.nivel.coordinacion()
                    carrera = inscripcion.carrera.nombre

                    modalidad = inscripcion.modalidad
                    persona = inscripcion.persona

                    cedula = persona.identificacion()
                    nombres = persona.nombre_completo_inverso()
                    correo_inst = persona.emailinst
                    correo_pers = persona.email
                    celular = persona.telefono
                    telefono = persona.telefono_conv
                    pais = '' if not persona.pais else persona.pais.nombre
                    provincia = '' if not persona.provincia else persona.provincia.nombre
                    canton = '' if not persona.canton else persona.canton.nombre

                    practicas = PracticasPreprofesionalesInscripcion.objects.filter(inscripcion=inscripcion,
                                                                                    status=True,
                                                                                    retirado=False).distinct().order_by(
                        '-fecha_creacion')
                    horas_culminadas = null_to_numeric(
                        practicas.filter(~Q(tiposolicitud=3), culminada=True).aggregate(
                            totalhora=Sum('numerohora'))['totalhora'], 0)
                    horas_culminadas_homo = null_to_numeric(
                        practicas.filter(tiposolicitud=3, culminada=True).aggregate(
                            totalhorahomo=Sum('horahomologacion'))['totalhorahomo'], 0)
                    total_horas_practica_culminada = int(horas_culminadas) + int(horas_culminadas_homo)

                    horas_aprobadas_pend = null_to_numeric(practicas.filter(~Q(tiposolicitud=3), culminada=False,
                                                                            estadosolicitud__in=[2, 4]).aggregate(
                        totalhora=Sum('numerohora'))['totalhora'], 0)
                    horas_aprobadas_pend_homo = null_to_numeric(
                        practicas.filter(tiposolicitud=3, culminada=False, estadosolicitud__in=[2, 4]).aggregate(
                            totalhorahomo=Sum('horahomologacion'))['totalhorahomo'], 0)
                    total_horas_aprobada_pend = int(horas_aprobadas_pend) + int(horas_aprobadas_pend_homo)

                    total_horas_vinculacion = null_to_numeric(
                        ParticipantesMatrices.objects.values('horas').filter(matrizevidencia_id=2, status=True,
                                                                             inscripcion=inscripcion).aggregate(
                            totalhoravincu=Sum('horas'))['totalhoravincu'], 0)

                    materias_pendientes = inscripcion.cantidad_materias_pendiente_aprobar()

                    ws.write(row_num, 0, u'%s' % malla, formatocelda)
                    ws.write(row_num, 1, u'%s' % facultad, formatocelda)
                    ws.write(row_num, 2, u'%s' % carrera, formatocelda)
                    ws.write(row_num, 3, u'%s' % nivelmalla, formatocelda)
                    ws.write(row_num, 4, u'%s' % modalidad, formatocelda)
                    ws.write(row_num, 5, u'%s' % cedula, formatocelda)
                    ws.write(row_num, 6, u'%s' % nombres, formatocelda)
                    ws.write(row_num, 7, u'%s' % correo_inst, formatocelda)
                    ws.write(row_num, 8, u'%s' % correo_pers, formatocelda)
                    ws.write(row_num, 9, u'%s' % celular, formatocelda)
                    ws.write(row_num, 10, u'%s' % telefono, formatocelda)
                    ws.write(row_num, 11, u'%s' % pais, formatocelda)
                    ws.write(row_num, 12, u'%s' % provincia, formatocelda)
                    ws.write(row_num, 13, u'%s' % canton, formatocelda)
                    if inscripcion.exonerado_practias():
                        ws.write(row_num, 14, 'EXONERADO', formatocelda)
                    else:
                        ws.write(row_num, 14, u'%s' % total_horas_practica_culminada, formatocelda)
                    if inscripcion.exonerado_practias():
                        ws.write(row_num, 15, 'EXONERADO', formatocelda)
                    else:
                        ws.write(row_num, 15, u'%s' % horas_culminadas_homo, formatocelda)
                    if inscripcion.exonerado_practias():
                        ws.write(row_num, 16, 'EXONERADO', formatocelda)
                    else:
                        ws.write(row_num, 16, u'%s' % total_horas_aprobada_pend, formatocelda)
                    if inscripcion.exonerado_practias():
                        ws.write(row_num, 17, 'EXONERADO', formatocelda)
                    else:
                        ws.write(row_num, 17, u'%s' % horas_practica_malla, formatocelda)
                    if inscripcion.exonerado_practias():
                        ws.write(row_num, 18, 'EXONERADO', formatocelda)
                    else:
                        ws.write(row_num, 18, u'%s' % total_horas_vinculacion, formatocelda)
                    ws.write(row_num, 19, u'%s' % horas_vinculacion_malla, formatocelda)
                    ws.write(row_num, 20, u'%s' % materias_pendientes, formatocelda)
                    ws.write(row_num, 21, u'%s' % nivemallamatricula, formatocelda)

                    row_num += 1

                workbook.close()
                output.seek(0)
                # Set up the Http response.
                filename = 'horascumplidaspracvinc_' + coordinacion.alias.lower() + random.randint(1,
                                                                                                   10000).__str__() + '.xlsx'
                response = HttpResponse(output,
                                        content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
                response['Content-Disposition'] = 'attachment; filename=%s' % filename

                return response
            except Exception as ex:
                pass

        elif action == 'reportecumplerequisitostitu':
            try:
                periodo = request.POST['idp']

                periodo = Periodo.objects.filter(pk=int(request.POST['idp']))[0]

                output = io.BytesIO()
                workbook = xlsxwriter.Workbook(output)
                ws = workbook.add_worksheet('Listado')

                formatocabeceracolumna = workbook.add_format({
                    'bold': 1,
                    'border': 1,
                    'align': 'center',
                    'valign': 'vcenter',
                    'bg_color': 'silver',
                    'text_wrap': 1,
                    'font_size': 10})

                formatocelda = workbook.add_format({
                    'border': 1
                })

                formatotitulo = workbook.add_format(
                    {'align': 'center', 'valign': 'vcenter', 'bold': 1, 'font_size': 14})

                ws.merge_range(0, 0, 0, 14, 'UNIVERSIDAD ESTATAL DE MILAGRO', formatotitulo)



                columns = [
                    (u"MALLA", 20),
                    (u"FACULTAD", 40),
                    (u"CARRERA", 40),
                    (u"NIVEL MALLA", 40),
                    (u"MODALIDAD", 20),
                    (u"CÉDULA", 20),
                    (u"ESTUDIANTE", 15),
                    (u"No adeudar valores o aranceles a la institución", 35),
                    (u"Haber cumplido con las horas o créditos de vinculación", 35),
                    (u"Haber cumplido con las horas o créditos de las prácticas pre profesionales", 35),
                    (u"Haber aprobado la suficiencia en computación", 35),
                    (u"Haber aprobado módulos o suficiencia de idioma inglés", 35),
                    (u"Ficha estudiantil actualizada y completa", 35),
                    (u"Asignaturas aprobadas del primer el penúltimo nivel", 35),
                    (u"Estar matriculado en todas las asignaturas del último periodo académico", 35)
                ]
                row_num = 4
                for col_num in range(len(columns)):
                    ws.write(row_num, col_num, columns[col_num][0], formatocabeceracolumna)
                    ws.set_column(col_num, col_num, columns[col_num][1])

                matriculas = Matricula.objects.filter(nivel__periodo_id=periodo.id,
                                                      estado_matricula__in=[2, 3],
                                                      status=True,
                                                      inscripcion__inscripcionnivel__status=True,
                                                      inscripcion__inscripcionnivel__nivel__status=True
                                                      ).exclude(retiradomatricula=True)

                total = matriculas.count()

                # inscripciones = Inscripcion.objects.filter(matricula__nivel__periodo_id=periodo.id,
                #                                       matricula__nivel__nivellibrecoordinacion__coordinacion_id=coordinacion.id,
                #                                       matricula__estado_matricula__in=[2,3],
                #                                       matricula__status=True,
                #                                       inscripcionnivel__status=True,
                #                                       inscripcionnivel__nivel__status=True,
                #                                       inscripcionnivel__nivel__orden__in=[7, 8],
                #                                       inscripcion__persona__cedula='0928892041'
                #                                       ).exclude(matricula__retiradomatricula=True).order_by('persona__apellido1', 'persona__apellido2', 'persona__nombres')
                #
                # totalins = inscripciones.count()

                row_num = 5
                for matricula in matriculas:
                    idins = matricula.inscripcion.persona.perfil_usuario_inscripcion_vigente()
                    inscripcion = Inscripcion.objects.get(pk=idins['inscripcion'])
                    nivelmalla = inscripcion.mi_nivel().nivel


                    malla = inscripcion.carrera.malla()

                    facultad = matricula.nivel.coordinacion()
                    carrera = inscripcion.carrera.nombre


                    persona = inscripcion.persona

                    cedula = persona.identificacion()
                    nombres = persona.nombre_completo_inverso()
                    correo_inst = persona.emailinst
                    correo_pers = persona.email
                    celular = persona.telefono
                    requisito1 = no_adeudar_institucion(inscripcion)
                    requisito2 = haber_cumplido_horas_creditos_vinculacion(inscripcion)
                    requisito3 = haber_cumplido_horas_creditos_practicas_preprofesionales(inscripcion)
                    requisito4 = haber_aprobado_modulos_computacion(inscripcion)
                    requisito5 = haber_aprobado_modulos_ingles(inscripcion)
                    requisito6 = ficha_estudiantil_actualizada_completa(inscripcion)
                    requisito7 = asignaturas_aprobadas_primero_penultimo_nivel(inscripcion)
                    requisito8 = estar_matriculado_todas_asignaturas_ultimo_periodo_academico(inscripcion)


                    ws.write(row_num, 0, u'%s' % malla, formatocelda)
                    ws.write(row_num, 1, u'%s' % facultad, formatocelda)
                    ws.write(row_num, 2, u'%s' % carrera, formatocelda)
                    ws.write(row_num, 3, u'%s' % nivelmalla, formatocelda)
                    ws.write(row_num, 4, u'%s' % cedula, formatocelda)
                    ws.write(row_num, 5, u'%s' % nombres, formatocelda)
                    ws.write(row_num, 6, u'%s' % correo_inst, formatocelda)
                    ws.write(row_num, 7, u'%s' % correo_pers, formatocelda)
                    ws.write(row_num, 8, u'%s' % celular, formatocelda)
                    ws.write(row_num, 8, u'%s' % requisito1, formatocelda)
                    ws.write(row_num, 8, u'%s' % requisito2, formatocelda)
                    ws.write(row_num, 8, u'%s' % requisito3, formatocelda)
                    ws.write(row_num, 8, u'%s' % requisito4, formatocelda)
                    ws.write(row_num, 8, u'%s' % requisito5, formatocelda)
                    ws.write(row_num, 8, u'%s' % requisito6, formatocelda)
                    ws.write(row_num, 8, u'%s' % requisito7, formatocelda)
                    ws.write(row_num, 8, u'%s' % requisito8, formatocelda)

                    row_num += 1

                workbook.close()
                output.seek(0)
                # Set up the Http response.
                filename = 'reporte_estudiantes_requisitos_titulacion' + random.randint(1, 10000).__str__() + '.xlsx'
                response = HttpResponse(output,
                                        content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
                response['Content-Disposition'] = 'attachment; filename=%s' % filename

                return response
            except Exception as ex:
                pass

        elif action == 'modulosaprobadosingles':
            try:
                idperiodo = request.POST['idp']
                periodo = Periodo.objects.filter(pk=int(request.POST['idp']))[0]

                output = io.BytesIO()
                workbook = xlsxwriter.Workbook(output)
                ws = workbook.add_worksheet('Listado')

                formatocabeceracolumna = workbook.add_format({
                    'bold': 1,
                    'border': 1,
                    'align': 'center',
                    'valign': 'vcenter',
                    'bg_color': 'silver',
                    'text_wrap': 1,
                    'font_size': 10})

                formatocelda = workbook.add_format({
                    'border': 1
                })

                formatoceldaentero = workbook.add_format({
                    'border': 1,
                    'num_format': '0'
                })

                formatotitulo = workbook.add_format(
                    {'align': 'center', 'valign': 'vcenter', 'bold': 1, 'font_size': 14})

                ws.merge_range(0, 0, 0, 6, 'UNIVERSIDAD ESTATAL DE MILAGRO', formatotitulo)
                # ws.merge_range(1, 0, 1, 6, '', formatotitulo)
                ws.merge_range(1, 0, 1, 6, 'LISTADO DE ESTUDIANTES CON MÓDULOS DE INGLÉS APROBADOS', formatotitulo)
                ws.merge_range(2, 0, 2, 6, 'PERIODO ' + periodo.nombre, formatotitulo)

                columns = [
                    (u"CÉDULA", 15),
                    (u"ESTUDIANTE", 40),
                    (u"CORREO PERSONAL", 40),
                    (u"CORREO INSTITUCIONAL", 40),
                    (u"TELÉFONO", 40),
                    (u"CARRERA", 40),
                    (u"MODALIDAD", 20),
                    (u"NIVEL MATRICULA", 20),
                    (u"AÑO MALLA", 10),
                    (u"MÓDULOS APROBADOS", 20),
                    (u"MÓDULOS REPROBADOS", 20),
                    (u"CÓDIGO CARRERA", 20),
                    (u"CÓDIGO MÓDULO", 20),
                    (u"ID MATRICULA", 20)
                ]

                row_num = 4
                for col_num in range(len(columns)):
                    ws.write(row_num, col_num, columns[col_num][0], formatocabeceracolumna)
                    ws.set_column(col_num, col_num, columns[col_num][1])

                cursor = connections['sga_select'].cursor()
                sql = """
                    Select pe.nombre as periodo, per.cedula, (per.apellido1 || ' ' || per.apellido2 || ' ' || per.nombres) as estudiante,
                     per.email,per.emailinst,car.nombre as carrera, mo.nombre as modalidad, nm.nombre as nivelmatricula,
                    extract (year from malla.inicio) as aniomalla,
                    (Select count(r.id) From
                    sga_recordacademico r  
                    Inner join sga_malla malla2 on malla2.id=22
                    Inner join sga_asignaturamalla asi on asi.malla_id=malla2.id  
                    Where  r.inscripcion_id=i.id  
                    and r.aprobada=True and r.asignatura_id=asi.asignatura_id
                    and r.asignatura_id<>782) as modulosinglesaprobados,
                    (Select count(reco.id) From
                    sga_recordacademico reco  
                    Inner join sga_malla malla2 on malla2.id=22
                    Inner join sga_asignaturamalla asi on asi.malla_id=malla2.id  
                    Where  reco.inscripcion_id=i.id  
                    and reco.aprobada= FALSE and reco.asignatura_id=asi.asignatura_id
                    and reco.asignatura_id<>782) as modulosinglesreprobados, car.codigo AS cod,
                    per.telefono,mat.id
                    From sga_matricula mat
                    Inner join sga_nivel ni on mat.nivel_id=ni.id
                    Inner join sga_inscripcion i on i.id=mat.inscripcion_id
                    Inner join sga_persona per on per.id=i.persona_id
                    Inner join sga_carrera car on car.id=i.carrera_id
                    Inner join sga_modalidad mo on mo.id=car.modalidad
                    Inner join sga_nivelmalla nm on nm.id=mat.nivelmalla_id
                    Inner join sga_inscripcionmalla im on im.inscripcion_id=i.id
                    Inner join sga_malla malla on malla.id=im.malla_id
                    Inner join sga_periodo pe on pe.id=ni.periodo_id
                    Where pe.id=%s AND i.activo=TRUE AND mat.retiradomatricula=FALSE AND i.id NOT IN (
                            SELECT ret.inscripcion_id
                            FROM sga_retirocarrera ret WHERE ret.status
                            )
                    Order By estudiante asc 
                """ % idperiodo

                cursor.execute(sql)
                results = cursor.fetchall()

                row_num = 5
                for r in results:
                    cedula = r[1]
                    estudiante = r[2]
                    emailper = r[3]
                    emailinst = r[4]
                    carrera = r[5]
                    telefono = r[12]
                    id_matricula = r[13]
                    modalidad = r[6]
                    nivelmatricula = r[7]
                    aniomalla = r[8]
                    totalaprobado = r[9]
                    totalrepro = r[10]
                    cod_carrera = r[11]
                    cod_mod = "ING01"

                    ws.write(row_num, 0, u'%s' % cedula, formatocelda)
                    ws.write(row_num, 1, u'%s' % estudiante, formatocelda)
                    ws.write(row_num, 2, u'%s' % emailper, formatocelda)
                    ws.write(row_num, 3, u'%s' % emailinst, formatocelda)
                    ws.write(row_num, 4, u'%s' % telefono, formatocelda)
                    ws.write(row_num, 5, u'%s' % carrera, formatocelda)
                    ws.write(row_num, 6, u'%s' % modalidad, formatocelda)
                    ws.write(row_num, 7, u'%s' % nivelmatricula, formatocelda)
                    ws.write(row_num, 8, aniomalla, formatoceldaentero)
                    ws.write(row_num, 9, totalaprobado, formatoceldaentero)
                    ws.write(row_num, 10, totalrepro, formatoceldaentero)
                    ws.write(row_num, 11, cod_carrera, formatoceldaentero)
                    ws.write(row_num, 12, cod_mod, formatoceldaentero)
                    ws.write(row_num, 13, id_matricula, formatoceldaentero)

                    row_num += 1

                cursor.close()

                workbook.close()
                output.seek(0)
                # Set up the Http response.
                filename = 'listadoestudiantesmodulosinglesaprobados_' + random.randint(1, 10000).__str__() + '.xlsx'
                response = HttpResponse(output,
                                        content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
                response['Content-Disposition'] = 'attachment; filename=%s' % filename

                return response
            except Exception as ex:
                pass

        elif action == 'practicaspendientesestudiantes':
            try:
                periodo = Periodo.objects.filter(pk=int(request.POST['idp']))[0]
                coordinacion = Coordinacion.objects.filter(pk=int(request.POST['idc']))[0]

                cn = connections['sga_select'].cursor()

                sql = """
                        SELECT MIN(nm.orden) AS nivelminimo
                        FROM sga_itinerariosmalla AS i
                        INNER JOIN sga_nivelmalla AS nm
                        ON i.nivel_id=nm.id
                        INNER JOIN sga_malla AS ma
                            ON i.malla_id=ma.id
                        INNER JOIN sga_carrera AS ca
                            ON ma.carrera_id=ca.id
                        INNER JOIN sga_coordinacion_carrera AS cc
                            ON cc.carrera_id=ca.id
                        INNER JOIN sga_coordinacion AS fa
                            ON cc.coordinacion_id=fa.id
                        WHERE i.status=TRUE AND fa.id=%s
                      """ % coordinacion.id

                cn.execute(sql)
                registro = cn.fetchall()
                nivelminimoiti = registro[0][0] if registro[0][0] else 6
                cn.close()

                output = io.BytesIO()
                workbook = xlsxwriter.Workbook(output)
                ws = workbook.add_worksheet('Listado')

                formatocabeceracolumna = workbook.add_format({
                    'bold': 1,
                    'border': 1,
                    'align': 'center',
                    'valign': 'vcenter',
                    'bg_color': 'silver',
                    'text_wrap': 1,
                    'font_size': 10})

                formatocelda = workbook.add_format({
                    'border': 1
                })

                formatotitulo = workbook.add_format(
                    {'align': 'center', 'valign': 'vcenter', 'bold': 1, 'font_size': 14})

                ws.merge_range(0, 0, 0, 12, 'UNIVERSIDAD ESTATAL DE MILAGRO', formatotitulo)
                ws.merge_range(1, 0, 1, 12, 'DIRECCIÓN DE VINCULACIÓN', formatotitulo)
                ws.merge_range(2, 0, 2, 12, 'LISTADO DE ESTUDIANTES MATRICULADOS CON PRÁCTICAS PENDIENTES',
                               formatotitulo)
                ws.merge_range(3, 0, 3, 12, coordinacion.nombre + " - " + coordinacion.alias, formatotitulo)

                columns = [
                    (u"MALLA", 20),
                    (u"FACULTAD", 40),
                    (u"CARRERA", 40),
                    (u"NIVEL MALLA", 20),
                    (u"MODALIDAD", 20),
                    (u"CÉDULA", 20),
                    (u"ESTUDIANTE", 40),
                    (u"CORREO INSTITUCIONAL", 35),
                    (u"CORREO PERSONAL", 35),
                    (u"CELULAR", 20),
                    (u"CONVENCIONAL", 20),
                    (u"CANTÓN", 20),
                    (u"HORAS PRÁCTICAS REQUISITO", 20),
                    (u"HORAS PRÁCTICAS CULMINADAS", 20),
                    (u"HORAS PRÁCTICAS PENDIENTES", 20),
                    (u"ASIGNATURAS PENDIENTES", 20),
                    (u"OBSERVACIÓN", 50)
                ]
                row_num = 4
                for col_num in range(len(columns)):
                    ws.write(row_num, col_num, columns[col_num][0], formatocabeceracolumna)
                    ws.set_column(col_num, col_num, columns[col_num][1])

                matriculas = Matricula.objects.filter(nivel__periodo_id=periodo.id,
                                                      nivel__nivellibrecoordinacion__coordinacion_id=coordinacion.id,
                                                      estado_matricula__in=[2, 3],
                                                      status=True,
                                                      inscripcion__inscripcionnivel__status=True,
                                                      inscripcion__inscripcionnivel__nivel__status=True,
                                                      inscripcion__inscripcionnivel__nivel__orden__gte=nivelminimoiti
                                                      ).exclude(retiradomatricula=True).order_by(
                    'inscripcion__persona__apellido1', 'inscripcion__persona__apellido2',
                    'inscripcion__persona__nombres')

                # print(matriculas.query)
                row_num = 5
                c = 1
                aptos = 0
                matriculado = True
                for matricula in matriculas:
                    idins = matricula.inscripcion.persona.perfil_usuario_inscripcion_vigente()
                    inscripcion = Inscripcion.objects.get(pk=idins['inscripcion'])
                    nivelmalla = inscripcion.mi_nivel().nivel

                    # Itinerario de la malla
                    itinerario = inscripcion.inscripcionmalla_set.filter(status=True)[0].malla.itinerariosmalla_set.filter(
                        status=True).order_by('nivel__orden')
                    if itinerario:
                        nivelminimoitinerario = itinerario[0].nivel.orden
                        verificar_apto = nivelmalla.orden >= nivelminimoitinerario
                    else:
                        verificar_apto = nivelmalla.orden > 5

                    if verificar_apto:
                        # print("Revisando ", c)
                        c += 1
                        apto = inscripcion.apto_para_realizar_practicas(matriculado)['apto']
                        # print(apto)
                        if apto:
                            aptos += 1
                            # print("Aptos para prácticas:", aptos)

                            # //malla = inscripcion.carrera.malla()

                            malla = inscripcion.mi_malla()

                            horas_practica_malla = malla.horas_practicas
                            facultad = matricula.nivel.coordinacion()
                            carrera = inscripcion.carrera.nombre
                            modalidad = inscripcion.modalidad
                            persona = inscripcion.persona
                            cedula = persona.identificacion()
                            nombres = persona.nombre_completo_inverso()
                            correo_inst = persona.emailinst
                            correo_pers = persona.email
                            celular = persona.telefono
                            telefono = persona.telefono_conv
                            canton = persona.canton.nombre if persona.canton else ''

                            practicas = PracticasPreprofesionalesInscripcion.objects.filter(inscripcion=inscripcion,
                                                                                            status=True,
                                                                                            retirado=False).distinct().order_by(
                                '-fecha_creacion')
                            horas_culminadas = null_to_numeric(
                                practicas.filter(~Q(tiposolicitud=3), culminada=True).aggregate(
                                    totalhora=Sum('numerohora'))['totalhora'], 0)
                            horas_culminadas_homo = null_to_numeric(
                                practicas.filter(tiposolicitud=3, culminada=True).aggregate(
                                    totalhorahomo=Sum('horahomologacion'))['totalhorahomo'], 0)
                            total_horas_practica_culminada = int(horas_culminadas) + int(horas_culminadas_homo)

                            if horas_practica_malla > 0:
                                horas_pendientes = horas_practica_malla - total_horas_practica_culminada
                            else:
                                horas_pendientes = 0

                            materias_pendientes = inscripcion.cantidad_materias_pendiente_aprobar()

                            ws.write(row_num, 0, u'%s' % malla, formatocelda)
                            ws.write(row_num, 1, u'%s' % facultad, formatocelda)
                            ws.write(row_num, 2, u'%s' % carrera, formatocelda)
                            ws.write(row_num, 3, u'%s' % nivelmalla, formatocelda)
                            ws.write(row_num, 4, u'%s' % modalidad, formatocelda)
                            ws.write(row_num, 5, u'%s' % cedula, formatocelda)
                            ws.write(row_num, 6, u'%s' % nombres, formatocelda)
                            ws.write(row_num, 7, u'%s' % correo_inst, formatocelda)
                            ws.write(row_num, 8, u'%s' % correo_pers, formatocelda)
                            ws.write(row_num, 9, u'%s' % celular, formatocelda)
                            ws.write(row_num, 10, u'%s' % telefono, formatocelda)
                            ws.write(row_num, 11, u'%s' % canton, formatocelda)
                            ws.write(row_num, 12, u'%s' % horas_practica_malla, formatocelda)
                            ws.write(row_num, 13, u'%s' % total_horas_practica_culminada, formatocelda)
                            ws.write(row_num, 14, u'%s' % horas_pendientes, formatocelda)
                            ws.write(row_num, 15, u'%s' % materias_pendientes, formatocelda)
                            ws.write(row_num, 16,
                                     u'%s' % "HORAS PRÁCTICAS NO CONFIGURADAS EN LA MALLA" if horas_practica_malla == 0 else "",
                                     formatocelda)

                            row_num += 1
                        else:
                            print("No apto ", inscripcion.persona.cedula)
                    else:
                        print("No califica ni para revision...", inscripcion.persona.cedula)
                workbook.close()
                output.seek(0)
                # Set up the Http response.
                filename = 'estudiantespracticaspendientes_' + coordinacion.alias.lower() + random.randint(1,
                                                                                                           10000).__str__() + '.xlsx'
                response = HttpResponse(output,
                                        content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
                response['Content-Disposition'] = 'attachment; filename=%s' % filename

                return response
            except Exception as ex:
                pass

        elif action == 'practicaspendientesestudiantesnomatricula':
            try:
                periodo = Periodo.objects.filter(pk=int(request.POST['idp']))[0]
                coordinacion = Coordinacion.objects.filter(pk=int(request.POST['idc']))[0]

                output = io.BytesIO()
                workbook = xlsxwriter.Workbook(output)
                ws = workbook.add_worksheet('Listado')

                formatocabeceracolumna = workbook.add_format({
                    'bold': 1,
                    'border': 1,
                    'align': 'center',
                    'valign': 'vcenter',
                    'bg_color': 'silver',
                    'text_wrap': 1,
                    'font_size': 10})

                formatocelda = workbook.add_format({
                    'border': 1
                })

                formatotitulo = workbook.add_format(
                    {'align': 'center', 'valign': 'vcenter', 'bold': 1, 'font_size': 14})

                ws.merge_range(0, 0, 0, 12, 'UNIVERSIDAD ESTATAL DE MILAGRO', formatotitulo)
                ws.merge_range(1, 0, 1, 12, 'DIRECCIÓN DE VINCULACIÓN', formatotitulo)
                ws.merge_range(2, 0, 2, 12, 'LISTADO DE ESTUDIANTES NO MATRICULADOS CON PRÁCTICAS PENDIENTES',
                               formatotitulo)
                ws.merge_range(3, 0, 3, 12, coordinacion.nombre + " - " + coordinacion.alias, formatotitulo)

                columns = [
                    (u"MALLA", 20),
                    (u"FACULTAD", 40),
                    (u"CARRERA", 40),
                    (u"NIVEL MALLA", 20),
                    (u"MODALIDAD", 20),
                    (u"CÉDULA", 20),
                    (u"ESTUDIANTE", 40),
                    (u"CORREO INSTITUCIONAL", 35),
                    (u"CORREO PERSONAL", 35),
                    (u"CELULAR", 20),
                    (u"CONVENCIONAL", 20),
                    (u"CANTÓN", 20),
                    (u"HORAS PRÁCTICAS REQUISITO", 20),
                    (u"HORAS PRÁCTICAS CULMINADAS", 20),
                    (u"HORAS PRÁCTICAS PENDIENTES", 20),
                    (u"ASIGNATURAS PENDIENTES", 20),
                    (u"OBSERVACIÓN", 50)
                ]
                row_num = 4
                for col_num in range(len(columns)):
                    ws.write(row_num, col_num, columns[col_num][0], formatocabeceracolumna)
                    ws.set_column(col_num, col_num, columns[col_num][1])

                cn = connections['sga_select'].cursor()
                sql = """
                    SELECT DISTINCT ins.id,pe.apellido1,pe.apellido2,pe.nombres,f.nombre
                    FROM sga_inscripcion AS ins
                    INNER JOIN sga_matricula AS matria
                        ON matria.inscripcion_id=ins.id
                    INNER JOIN sga_carrera AS ca
                        ON ca.id=ins.carrera_id
                    INNER JOIN sga_perfilusuario AS pu
                        ON pu.inscripcion_id=ins.id
                    INNER JOIN sga_persona AS pe
                        ON ins.persona_id=pe.id
                    INNER JOIN sga_inscripcionmalla AS insmall
                        ON insmall.inscripcion_id=ins.id
                    INNER JOIN sga_malla AS mall
                        ON mall.id=insmall.malla_id
                    INNER JOIN sga_inscripcionnivel AS insniv
                        ON insniv.inscripcion_id=ins.id
                    INNER JOIN sga_nivelmalla AS nm
                        ON insniv.nivel_id=nm.id
                    INNER JOIN sga_coordinacion_carrera AS cc
                        ON cc.carrera_id=ca.id
                    INNER JOIN sga_coordinacion AS f
	                    ON cc.coordinacion_id=f.id
                    WHERE ins."status"=TRUE
                     AND pe."status"=true
                     AND pu.visible=true
                     AND cc.coordinacion_id=%s
                        AND (EXTRACT(YEAR FROM NOW()) - extract(year from matria.fecha))<=5
                        AND ins.id NOT IN (SELECT retiro.inscripcion_id FROM sga_retirocarrera as retiro Where retiro.status=TRUE)
                        AND ins.id NOT IN (SELECT gra.inscripcion_id FROM sga_graduado AS gra WHERE gra.status=TRUE and gra.estadograduado=true)
                        AND ins.id NOT IN (SELECT matri.inscripcion_id 
                                                FROM sga_matricula AS matri
                                                INNER join sga_nivel AS ni
                                                ON matri.nivel_id=ni.id
                                                WHERE matri.estado_matricula in (2,3)
                                                AND matri.retiradomatricula=FALSE
                                                and ni.periodo_id=%s
                                                )
                    ORDER BY pe.apellido1,pe.apellido2,pe.nombres 	                
                    """ % (coordinacion.id, periodo.id)

                cn.execute(sql)
                results = cn.fetchall()

                row_num = 5
                c = 1
                aptos = 0
                matriculado = False

                for r in results:
                    idins = r[0]
                    facultad = r[4]
                    inscripcion = Inscripcion.objects.get(pk=idins)
                    nivelmalla = inscripcion.mi_nivel().nivel

                    # Itinerario de la malla
                    itinerario = inscripcion.inscripcionmalla_set.filter(status=True)[0].malla.itinerariosmalla_set.filter(
                        status=True).order_by('nivel__orden')
                    if itinerario:
                        nivelminimoitinerario = itinerario[0].nivel.orden
                        verificar_apto = nivelmalla.orden >= nivelminimoitinerario
                    else:
                        verificar_apto = nivelmalla.orden > 5

                    if verificar_apto:
                        # print("Revisando ", c)
                        c += 1
                        apto = inscripcion.apto_para_realizar_practicas(matriculado)['apto']
                        # print(apto)
                        if apto:
                            aptos += 1
                            # print("Aptos para prácticas:", aptos)
                            # malla = inscripcion.carrera.malla()
                            malla = inscripcion.mi_malla()
                            horas_practica_malla = malla.horas_practicas

                            carrera = inscripcion.carrera.nombre
                            modalidad = inscripcion.modalidad
                            persona = inscripcion.persona
                            cedula = persona.identificacion()
                            nombres = persona.nombre_completo_inverso()
                            correo_inst = persona.emailinst
                            correo_pers = persona.email
                            celular = persona.telefono
                            telefono = persona.telefono_conv
                            canton = persona.canton.nombre

                            practicas = PracticasPreprofesionalesInscripcion.objects.filter(inscripcion=inscripcion,
                                                                                            status=True,
                                                                                            retirado=False).distinct().order_by(
                                '-fecha_creacion')
                            horas_culminadas = null_to_numeric(
                                practicas.filter(~Q(tiposolicitud=3), culminada=True).aggregate(
                                    totalhora=Sum('numerohora'))['totalhora'], 0)
                            horas_culminadas_homo = null_to_numeric(
                                practicas.filter(tiposolicitud=3, culminada=True).aggregate(
                                    totalhorahomo=Sum('horahomologacion'))['totalhorahomo'], 0)
                            total_horas_practica_culminada = int(horas_culminadas) + int(horas_culminadas_homo)

                            if horas_practica_malla > 0:
                                horas_pendientes = horas_practica_malla - total_horas_practica_culminada
                            else:
                                horas_pendientes = 0

                            materias_pendientes = inscripcion.cantidad_materias_pendiente_aprobar()

                            ws.write(row_num, 0, u'%s' % malla, formatocelda)
                            ws.write(row_num, 1, u'%s' % facultad, formatocelda)
                            ws.write(row_num, 2, u'%s' % carrera, formatocelda)
                            ws.write(row_num, 3, u'%s' % nivelmalla, formatocelda)
                            ws.write(row_num, 4, u'%s' % modalidad, formatocelda)
                            ws.write(row_num, 5, u'%s' % cedula, formatocelda)
                            ws.write(row_num, 6, u'%s' % nombres, formatocelda)
                            ws.write(row_num, 7, u'%s' % correo_inst, formatocelda)
                            ws.write(row_num, 8, u'%s' % correo_pers, formatocelda)
                            ws.write(row_num, 9, u'%s' % celular, formatocelda)
                            ws.write(row_num, 10, u'%s' % telefono, formatocelda)
                            ws.write(row_num, 11, u'%s' % canton, formatocelda)
                            ws.write(row_num, 12, u'%s' % horas_practica_malla, formatocelda)
                            ws.write(row_num, 13, u'%s' % total_horas_practica_culminada, formatocelda)
                            ws.write(row_num, 14, u'%s' % horas_pendientes, formatocelda)
                            ws.write(row_num, 15, u'%s' % materias_pendientes, formatocelda)
                            ws.write(row_num, 16,
                                     u'%s' % "HORAS PRÁCTICAS NO CONFIGURADAS EN LA MALLA" if horas_practica_malla == 0 else "",
                                     formatocelda)

                            row_num += 1
                        else:
                            print("No apto ", inscripcion.persona.cedula)
                    else:
                        print("No califica ni para revision...", inscripcion.persona.cedula)

                cn.close()

                workbook.close()
                output.seek(0)
                # Set up the Http response.
                filename = 'estudiantesnomatriculadospracticaspendientes_' + coordinacion.alias.lower() + random.randint(
                    1, 10000).__str__() + '.xlsx'
                response = HttpResponse(output,
                                        content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
                response['Content-Disposition'] = 'attachment; filename=%s' % filename

                return response
            except Exception as ex:
                pass

        elif action == 'avance_asistencia':
            try:
                periodo = Periodo.objects.get(pk=int(request.POST['idperiodo']))

                coordinaciones = Coordinacion.objects.filter(
                    carrera__malla__asignaturamalla__materia__nivel__periodo=periodo).order_by('-id').distinct()
                diasnolaborables = DiasNoLaborable.objects.filter(periodo=periodo).order_by('fecha')
                # claseshorarios = Clase.objects.filter(materia__nivel__periodo=periodo, activo=True).distinct().order_by('materia__profesormateria__profesor', 'turno__comienza')
                output_folder = os.path.join(os.path.join(SITE_STORAGE, 'media', 'asistencias'))
                __author__ = 'Unemi'
                style0 = easyxf('font: name Times New Roman, color-index blue, bold off', num_format_str='#,##0.00')
                style_nb = easyxf('font: name Times New Roman, color-index blue, bold on', num_format_str='#,##0.00')
                style_sb = easyxf('font: name Times New Roman, color-index blue, bold on')
                title = easyxf(
                    'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                style1 = easyxf(num_format_str='D-MMM-YY')
                font_style = XFStyle()
                font_style.font.bold = True
                font_style2 = XFStyle()
                font_style2.font.bold = False
                wb = Workbook(encoding='utf-8')
                for coordinacion1 in coordinaciones:
                    ws = wb.add_sheet(coordinacion1.alias)
                    coordinacionid = coordinacion1.id
                    ws.write_merge(0, 0, 0, 10, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                    ws.write(1, 0, "Periodo: " + periodo.nombre, font_style2)
                    ws.write(2, 0, "Fecha Corte: " + request.POST['fecha'], font_style2)
                    nombre = "AVANCE_" + datetime.now().strftime('%Y%m%d_%H%M%S') + ".xls"
                    filename = os.path.join(output_folder, nombre)
                    ruta = "media/asistencias/" + nombre
                    book = xlwt.Workbook()
                    columns = [
                        (u"FACULTAD", 6000),
                        (u"CARRERA", 6000),
                        (u"NIVEL", 6000),
                        (u"PARALELO", 6000),
                        (u"DOCENTE", 6000),
                        (u"ASIGNATURA", 6000),
                        (u"HORAS PROGRAMADAS MENSUAL", 6000),
                        (u"HORAS INGRESADAS", 6000),
                        (u"HORAS FALTAS", 6000),
                        (u"HORAS TOTAL ASISTENCIAS", 6000),
                        (u"PORCENTAJE AVANCE FECHA TOPE", 6000),
                        (u"PORCENTAJE AVANCE SEMESTRE", 6000),
                        (u"FECHA INICIO MATERIA", 6000),
                        (u"FECHA FIN MATERIA", 6000),
                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], font_style)
                        ws.col(col_num).width = columns[col_num][1]

                    # profesormateria = ProfesorMateria.objects.filter(materia__nivel__periodo=periodo, principal=True).distinct().order_by('materia__asignaturamalla__malla__carrera','profesor')
                    # asistencialeccion = AsistenciaLeccion.objects.filter(materiaasignada__materia__nivel__periodo=periodo, leccion__fecha__lte=fecha).order_by("materiaasignada__materia").distinct("materiaasignada__materia")
                    cursor = connections['sga_select'].cursor()
                    sql = "select tabladocente.facultad , tabladocente.carrera, tabladocente.nivel, tabladocente.paralelo, tabladocente.docente,tabladocente.asignatura, tabladocente.horas , COALESCE(tablaasistencia.asistencia,0) as asistencia, tabladocente.inicio, tabladocente.fin,  " \
                          " (select count(*) from sga_faltasmateriaperiodo fm1 where fm1.materia_id=tabladocente.materiaid) as faltas " \
                          " from (select pm.id as profesormateriaid, m.inicio, m.fin, m.id as materiaid, co.nombre as facultad, ca.nombre as carrera, nm.nombre as nivel, m.paralelo, (per.apellido1 || ' ' || per.apellido2 || ' ' || per.nombres) as docente,asi.nombre as asignatura, m.horas " \
                          " from sga_profesormateria pm, sga_materia m, sga_nivel n, sga_asignaturamalla am, sga_malla ma,sga_carrera ca, sga_coordinacion_carrera cc, sga_coordinacion co, sga_nivelmalla nm, sga_profesor pr, sga_persona per, sga_asignatura asi " \
                          " where m.id=pm.materia_id and pm.tipoprofesor_id not in (4) and n.id=m.nivel_id and am.id=m.asignaturamalla_id and ma.id=am.malla_id and ca.id=ma.carrera_id and cc.carrera_id=ca.id and co.id=cc.coordinacion_id and nm.id=am.nivelmalla_id and pr.id=pm.profesor_id and per.id=pr.persona_id " \
                          " and asi.id=m.asignatura_id and n.periodo_id= " + request.POST[
                              'idperiodo'] + " and co.id=" + str(
                        coordinacionid) + " order by co.nombre, ca.nombre, nm.nombre, m.paralelo, docente) as tabladocente " \
                                          " left join (select mat1.id as materiaid, count(mat1.id) as asistencia from sga_leccion l1 , sga_clase c1 , sga_materia mat1, sga_nivel ni1 where l1.clase_id=c1.id and c1.materia_id=mat1.id and mat1.nivel_id=ni1.id and l1.fecha<= '" + \
                          request.POST['fecha'] + "' and ni1.periodo_id=" + request.POST['idperiodo'] + " " \
                                                                                                        " and l1.fecha not in (select dnl1.fecha from sga_diasnolaborable dnl1 where dnl1.periodo_id=" + \
                          request.POST[
                              'idperiodo'] + ") GROUP by mat1.id) as tablaasistencia on tablaasistencia.materiaid=tabladocente.materiaid order by tabladocente.facultad , tabladocente.carrera, tabladocente.nivel, tabladocente.paralelo, tabladocente.docente"
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    row_num = 4
                    for r in results:
                        i = 0
                        campo1 = r[0]
                        campo2 = r[1]
                        campo3 = r[2]
                        campo4 = r[3]
                        campo5 = r[4]
                        campo6 = r[5]
                        campo7 = r[6]
                        campo8 = r[7]
                        campo9 = 0
                        if r[6] > 0:
                            porcentajeperiodo = round((float(r[7]) / r[6]) * 100, 2)
                            if porcentajeperiodo > 100:
                                porcentajeperiodo = 100
                            campo9 = porcentajeperiodo
                        campo13 = 0
                        if (r[10] + r[7]) > 0:
                            porcentajefecha = round((float(r[7]) / (r[10] + r[7])) * 100, 2)
                            if porcentajefecha > 100:
                                porcentajefecha = 100
                            campo13 = porcentajefecha

                        campo10 = r[8]
                        campo11 = r[9]
                        campo12 = r[10]

                        ws.write(row_num, 0, campo1, font_style2)
                        ws.write(row_num, 1, campo2, font_style2)
                        ws.write(row_num, 2, campo3, font_style2)
                        ws.write(row_num, 3, campo4, font_style2)
                        ws.write(row_num, 4, campo5, font_style2)
                        ws.write(row_num, 5, campo6, font_style2)
                        ws.write(row_num, 6, campo7, font_style2)
                        ws.write(row_num, 7, campo8, font_style2)
                        ws.write(row_num, 8, campo12, font_style2)
                        ws.write(row_num, 9, campo12 + campo8, font_style2)
                        ws.write(row_num, 10, campo13, font_style2)
                        ws.write(row_num, 11, campo9, font_style2)
                        ws.write(row_num, 12, campo10, style1)
                        ws.write(row_num, 13, campo11, style1)
                        # while i < len(r):
                        #     # ws.write(row_num, i, r[i], font_style)
                        #     # ws.col(i).width = columns[i][1]
                        row_num += 1
                wb.save(filename)
                # return book
                return JsonResponse({'result': 'ok', 'archivo': ruta})
            except Exception as ex:
                pass

        elif action == 'retencion_estudiante':
            try:
                arreglo_semestre = []
                periodo1 = Periodo.objects.get(pk=int(request.POST['periodo1']))
                periodo2 = Periodo.objects.get(pk=int(request.POST['periodo2']))
                periodos = periodos_retencion.filter(id__gte=periodo1.id, id__lte=periodo2.id).order_by('id')
                # carreras = Carrera.objects.filter(malla__asignaturamalla__materia__nivel__periodo__id__in=[periodo1.id,periodo2.id]).order_by('-id').distinct()
                # claseshorarios = Clase.objects.filter(materia__nivel__periodo=periodo, activo=True).distinct().order_by('materia__profesormateria__profesor', 'turno__comienza')
                output_folder = os.path.join(os.path.join(SITE_STORAGE, 'media', 'asistencias'))
                __author__ = 'Unemi'
                style0 = easyxf('font: name Times New Roman, color-index blue, bold off', num_format_str='#,##0.00')
                style_nb = easyxf('font: name Times New Roman, color-index blue, bold on', num_format_str='#,##0.00')
                style_sb = easyxf('font: name Times New Roman, color-index blue, bold on')
                title = easyxf(
                    'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                style1 = easyxf(num_format_str='D-MMM-YY')
                font_style = XFStyle()
                font_style.font.bold = True
                font_style2 = XFStyle()
                font_style2.font.bold = False
                wb = Workbook(encoding='utf-8')
                ws = wb.add_sheet('retencion')
                arreglo_semestre = [1, 2, 3, 4, 5, 6, 7, 8]

                ws.write_merge(0, 0, 0, 10, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                nombre = "AVANCE_" + datetime.now().strftime('%Y%m%d_%H%M%S') + ".xls"
                filename = os.path.join(output_folder, nombre)
                ruta = "media/asistencias/" + nombre
                book = xlwt.Workbook()
                columns = [
                    (u"PERIODO", 6000),
                    (u"CARRERA", 6000),
                    (u"NIVEL1 MATUTINO", 6000),
                    (u"% DESERCIÓN MATUTINO", 6000),
                    (u"NIVEL1 VESPERTINO", 6000),
                    (u"% DESERCIÓN VESPERTINO", 6000),
                    (u"NIVEL1 NOCTURNO", 6000),
                    (u"% DESERCIÓN NOCTURNO", 6000),
                    (u"NIVEL2 MATUTINO", 6000),
                    (u"% DESERCIÓN MATUTINO", 6000),
                    (u"NIVEL2 VESPERTINO", 6000),
                    (u"% DESERCIÓN VESPERTINO", 6000),
                    (u"NIVEL2 NOCTURNO", 6000),
                    (u"% DESERCIÓN NOCTURNO", 6000),
                    (u"NIVEL3 MATUTINO", 6000),
                    (u"% DESERCIÓN MATUTINO", 6000),
                    (u"NIVEL3 VESPERTINO", 6000),
                    (u"% DESERCIÓN VESPERTINO", 6000),
                    (u"NIVEL3 NOCTURNO", 6000),
                    (u"% DESERCIÓN NOCTURNO", 6000),
                    (u"NIVEL4 MATUTINO", 6000),
                    (u"% DESERCIÓN MATUTINO", 6000),
                    (u"NIVEL4 VESPERTINO", 6000),
                    (u"% DESERCIÓN VESPERTINO", 6000),
                    (u"NIVEL4 NOCTURNO", 6000),
                    (u"% DESERCIÓN NOCTURNO", 6000),
                    (u"NIVEL5 MATUTINO", 6000),
                    (u"% DESERCIÓN MATUTINO", 6000),
                    (u"NIVEL5 VESPERTINO", 6000),
                    (u"% DESERCIÓN VESPERTINO", 6000),
                    (u"NIVEL5 NOCTURNO", 6000),
                    (u"% DESERCIÓN NOCTURNO", 6000),
                    (u"NIVEL6 MATUTINO", 6000),
                    (u"% DESERCIÓN MATUTINO", 6000),
                    (u"NIVEL6 VESPERTINO", 6000),
                    (u"% DESERCIÓN VESPERTINO", 6000),
                    (u"NIVEL6 NOCTURNO", 6000),
                    (u"% DESERCIÓN NOCTURNO", 6000),
                    (u"NIVEL7 MATUTINO", 6000),
                    (u"% DESERCIÓN MATUTINO", 6000),
                    (u"NIVEL7 VESPERTINO", 6000),
                    (u"% DESERCIÓN VESPERTINO", 6000),
                    (u"NIVEL7 NOCTURNO", 6000),
                    (u"% DESERCIÓN NOCTURNO", 6000),
                    (u"NIVEL8 MATUTINO", 6000),
                    (u"% DESERCIÓN MATUTINO", 6000),
                    (u"NIVEL8 VESPERTINO", 6000),
                    (u"% DESERCIÓN VESPERTINO", 6000),
                    (u"NIVEL8 NOCTURNO", 6000),
                    (u"% DESERCIÓN NOCTURNO", 6000),
                ]
                row_num = 3
                for col_num in range(len(columns)):
                    ws.write(row_num, col_num, columns[col_num][0], font_style)
                    ws.col(col_num).width = columns[col_num][1]
                row_num = 4
                cantidad = periodos.count()
                columna_p = 0
                for periodo in periodos:
                    periodo_despues = Periodo.objects.filter(status=True, tipo_id=2, id__gt=periodo.id).exclude(
                        id__in=[15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36,
                                37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58,
                                59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75]).order_by('id')[0]
                    ws.write(row_num, 0, periodo.nombre, font_style2)
                    carreras = Carrera.objects.filter(malla__asignaturamalla__materia__nivel__periodo=periodo).exclude(
                        id__in=[34, 37]).exclude(coordinacion__id=9).order_by('-id').distinct()
                    for c in carreras:
                        i = 0
                        campo1 = c.nombre
                        ws.write(row_num, 1, campo1, font_style2)
                        a = 0
                        for s in arreglo_semestre:
                            campo2 = periodo.total_matriculados_nivel_carrera_matutino(s, c)
                            campo3 = 0.00
                            if campo2 > 0:
                                campo3 = round(((periodo.total_matriculados_nivel_carrera_matutino_retencion(s, c,
                                                                                                             periodo_despues) / campo2) * 100),
                                               2)
                            campo4 = periodo.total_matriculados_nivel_carrera_vespertino(s, c)
                            campo5 = 0.00
                            if campo4 > 0:
                                campo5 = round(((periodo.total_matriculados_nivel_carrera_vespertino_retencion(s, c,
                                                                                                               periodo_despues) / campo4) * 100),
                                               2)
                            campo6 = periodo.total_matriculados_nivel_carrera_nocturno(s, c)
                            campo7 = 0.00
                            if campo6 > 0:
                                campo7 = round(((periodo.total_matriculados_nivel_carrera_nocturno_retencion(s, c,
                                                                                                             periodo_despues) / campo6) * 100),
                                               2)
                            ws.write(row_num, 2 + a, campo2, font_style2)
                            ws.write(row_num, 3 + a, str(campo3) + '%', font_style2)
                            ws.write(row_num, 4 + a, campo4, font_style2)
                            ws.write(row_num, 5 + a, str(campo5) + '%', font_style2)
                            ws.write(row_num, 6 + a, campo6, font_style2)
                            ws.write(row_num, 7 + a, str(campo7) + '%', font_style2)
                            a += 6
                        row_num += 1
                    row_num += 1
                    columna_p += 1
                wb.save(filename)
                # return book
                return JsonResponse({'result': 'ok', 'archivo': ruta})
            except Exception as ex:
                pass

        elif action == 'delete':
            try:
                nivel = Nivel.objects.get(pk=request.POST['id'])
                log(u'Elimino nivel: %s' % nivel, request, "del")
                if not nivel.puede_eliminarse():
                    return JsonResponse({"result": "bad", "mensaje": u"No se puede eliminar el nivel."})
                nivel.delete()
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                pass
                return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar los datos."})

        elif action == 'eliminarmatriculas':
            try:
                periodo = Periodo.objects.get(pk=request.POST['id'])
                log(u'Elimino matriculas pendientes de cobro del periodo: %s' % periodo, request, "del")
                for ma in Matricula.objects.filter(estado_matricula=1, nivel__periodo=periodo, status=True,
                                                   inscripcion__carrera__coordinacion__id=9):
                    fechavence = ma.fecha_creacion + timedelta(hours=HORAS_VIGENCIA)
                    if datetime.now() > fechavence:
                        if elimina_rubros(ma):
                            log(u'Eliminación automatica de matricula opcion niveles y materias: %s valor: $ %s' % (
                                ma, ma.total_saldo_rubro()), request, "del")
                            ma.delete()
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar los datos."})

        elif action == 'actualizarmateriascerradas':
            try:
                periodo = Periodo.objects.get(pk=request.POST['id'])
                # resultado = processCloseSubject.delay(periodo.id, persona.id)
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al actualizar materias cerradas."})

        elif action == 'actualizarasistenciapregrado':
            try:

                id_coordinacion=[1,2,3,4,5]
                asistencias = MateriaAsignada.objects.filter(materia__nivel__periodo=periodo, status=True,
                                                             matricula__status=True, retiramateria=False,
                                                             matricula__retiradomatricula=False,
                                                             materia__asignaturamalla__malla__carrera__modalidad=3,
                                                            matricula__inscripcion__coordinacion_id__in=id_coordinacion
                                                             ).exclude(matricula__inscripcion__coordinacion_id=9)
                asignatura = asistencias.first().materia.asignatura.nombre
                for asistencia in asistencias:
                    asistencia.asistenciafinal = 100
                    asistencia.sinasistencia = True

                    asistencia.save(request)
                log(u'Edito Asistencia Virtual Pregrado en Asignaturas: %s' % asignatura, request, "edit")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al actualizar Asistecia Pregrado."})

        elif action == 'actualizarasistenciaadmision':
            try:


                asistencias = MateriaAsignada.objects.filter(materia__nivel__periodo=periodo,
                                                             status=True, retiramateria=False,
                                                             matricula__status=True, matricula__retiradomatricula=False,
                                                             matricula__inscripcion__coordinacion_id=9).exclude(matricula__inscripcion__carrera=223)
                asignatura = asistencias.first().materia.asignatura.nombre
                for asistencia in asistencias:
                    asistencia.asistenciafinal = 100
                    asistencia.sinasistencia = True
                    asistencia.save(request)
                log(u'Edito Asistencia Virtual Admisión en Asignaturas: %s' % asignatura, request, "edit")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al actualizar Asistecia Admisión."})

        elif action == 'actualizarprofesorcrirerio':
            try:
                periodo = Periodo.objects.get(pk=request.POST['id'])
                log(u'Actualizo profesor criterio: %s' % periodo, request, "edit")
                for profesor in Profesor.objects.filter(status=True, profesormateria__materia__nivel__periodo=periodo,
                                                        profesormateria__status=True).distinct():
                    profesor.actualizar_todo_distributivo_docente_todo(request, periodo)
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al actualizar profesor criterio."})

        elif action == 'actualizarnotasmoodle':
            try:
                periodo = Periodo.objects.get(pk=request.POST['id'])
                log(u'Actualizo materias notas moodle: %s' % periodo, request, "edit")
                materias = Materia.objects.values_list('id', flat=True).filter(status=True, nivel__periodo=periodo,
                                                                               asignaturamalla__malla__carrera__coordinacion__id=9).distinct()
                for materia1 in materias:
                    materia = Materia.objects.get(pk=int(materia1), status=True)
                    for alumno in materia.asignados_a_esta_materia_moodle().filter(retiramateria=False):
                        # Extraer datos de moodle
                        for notasmooc in materia.notas_de_moodle(alumno.matricula.inscripcion.persona):
                            campo = alumno.campo(notasmooc[1].upper())
                            if type(notasmooc[0]) is Decimal:
                                if null_to_decimal(campo.valor) != float(notasmooc[0]):
                                    actualizar_nota_planificacion(alumno.id, notasmooc[1].upper(), notasmooc[0])
                                    auditorianotas = AuditoriaNotas(evaluaciongenerica=campo, manual=False,
                                                                    calificacion=notasmooc[0])
                                    auditorianotas.save(request)
                            else:
                                if null_to_decimal(campo.valor) != float(0):
                                    actualizar_nota_planificacion(alumno.id, notasmooc[1].upper(), notasmooc[0])
                                    auditorianotas = AuditoriaNotas(evaluaciongenerica=campo, manual=False,
                                                                    calificacion=0)
                                    auditorianotas.save(request)

                        # for notasmooc in materia.notas_de_moodle(alumno.matricula.inscripcion.persona):
                        #     if type(notasmooc[0]) is Decimal:
                        #         campo = alumno.campo(notasmooc[1].upper())
                        #         if null_to_decimal(campo.valor) != float(notasmooc[0]):
                        #             actualizar_nota_planificacion(alumno.id, notasmooc[1].upper(), notasmooc[0])

                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al actualizar materias cerradas."})

        elif action == 'aprobar':
            try:
                nivel = Nivel.objects.get(pk=request.POST['id'])
                log(u'Aprobo distributivo: %s' % nivel, request, "del")
                nivel.distributivoaprobado = True
                nivel.responsableaprobacion = request.session['persona']
                nivel.fechaprobacion = datetime.now().date()
                nivel.save(request)
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar los datos."})

        elif action == 'addmateria':
            try:
                nivel = Nivel.objects.get(pk=request.POST['nid'])
                f = MateriaNivel(request.POST)
                if f.is_valid():
                    asignatura = f.cleaned_data['asignatura'] if 'asignatura' in request.POST else f.cleaned_data['asignaturamalla'].asignatura
                    paralelo = f.cleaned_data['paralelo'].nombre if 'paralelo' in request.POST else ''
                    if nivel.coordinacion().id == 7:
                        planificacion = PlanificacionParalelo.objects.filter(periodo=periodo,asignatura=asignatura, status=True).first()
                        planif = null_to_decimal(PlanificacionParalelo.objects.filter(periodo=periodo, asignatura=asignatura, status=True).aggregate(paralelo=Max('paralelos'))['paralelo'])

                        eMaterias = Materia.objects.values_list('id', flat=True).filter(asignaturamalla__asignatura=asignatura, nivel__periodo=periodo, status=True)
                        creada = PlanificacionMateria.objects.filter(status=True, materia__in=eMaterias,estado=1).count()

                        if Materia.objects.filter(asignaturamalla__asignatura=asignatura, nivel__periodo=periodo, status=True, paralelo = paralelo).exists():
                            return JsonResponse({"result": "bad","mensaje": f"El paralelo: {paralelo} ya fue creado, intente con otro."})
                        if planificacion:
                            if planificacion.fechalimiteplanificacion:
                                if datetime.now().date() > planificacion.fechalimiteplanificacion:
                                    return JsonResponse({"result": "bad",
                                                         "mensaje": f"No ha cumplido con el registro de la planificación académica solicitada, por favor comunicarse con la gestión de posgrado."})
                        if planif:
                            if not (creada < planif or planif == 0):
                                return JsonResponse({"result": "bad", "mensaje": f"Se ha completado el número de paralelos para este módulo. {creada}/{planif}"})

                    materia = Materia(asignatura=asignatura,
                                      asignaturamalla=f.cleaned_data[
                                          'asignaturamalla'] if 'asignaturamalla' in request.POST else None,
                                      nivel=nivel,
                                      # horas=f.cleaned_data['horas'] if not variable_valor('MATRICULACION_LIBRE') else f.cleaned_data['asignaturamalla'].horas,
                                      horas=f.cleaned_data['asignaturamalla'].horas,
                                      horassemanales=int(f.cleaned_data['horassemanales']),
                                      # creditos=f.cleaned_data['creditos'] if not variable_valor('MATRICULACION_LIBRE') else f.cleaned_data['asignaturamalla'].creditos,
                                      creditos=f.cleaned_data['asignaturamalla'].creditos,
                                      # identificacion=f.cleaned_data['identificacion'] if not variable_valor('MATRICULACION_LIBRE') else f.cleaned_data['asignaturamalla'].identificacion,
                                      identificacion=f.cleaned_data['asignaturamalla'].identificacion,
                                      alias=f.cleaned_data['alias'],
                                      paralelo=paralelo,
                                      paralelomateria=f.cleaned_data['paralelo'],
                                      parcial=f.cleaned_data['parcial'],
                                      inicio=f.cleaned_data['inicio'],
                                      fin=f.cleaned_data['fin'],
                                      cerrado=False,
                                      actualizarhtml=True,
                                      rectora=f.cleaned_data['rectora'],
                                      practicas=f.cleaned_data['practicas'],
                                      tutoria=f.cleaned_data['tutoria'],
                                      grado=f.cleaned_data['grado'],
                                      validacreditos=f.cleaned_data['validacreditos'],
                                      validapromedio=f.cleaned_data['validapromedio'],
                                      tipomateria=f.cleaned_data['tipomateria'],
                                      seevalua=f.cleaned_data['seevalua'],
                                      modeloevaluativo=f.cleaned_data['modelo'],
                                      cupo=f.cleaned_data['cupo'] if 'cupo' in request.POST else 0,
                                      esintroductoria=f.cleaned_data['esintroductoria'],
                                      inglesepunemi=f.cleaned_data['inglesepunemi'],
                                      )
                    materia.save(request)
                    if nivel.coordinacion().id == 7:
                        pm = ProfesorMateria(segmento='MATERIA',
                                             materia=materia,
                                             profesor_id=3834,
                                             tipoprofesor_id=7,
                                             desde=datetime.now().date(),
                                             hasta=datetime.now().date())
                        pm.save(request)

                        materia.fechainiciomatriculacionposgrado = f.cleaned_data['iniciomatriculacionposgrado']
                        materia.fechafinmatriculacionposgrado = f.cleaned_data['finmatriculacionposgrado']
                        if materia.asignaturamalla.malla.carrera.modalidad == 3:
                            materia.sinasistencia = True
                        else:
                            materia.sinasistencia = f.cleaned_data['sinasistencia']
                        materia.save(request)

                    materia.crear_actualizar_requisitos_uic()
                    if materia.rectora:
                        materia.carrerascomunes.clear()
                        for r in f.cleaned_data['carreras']:
                            materia.carrerascomunes.add(r)
                        # materia.save(request)

                    evaluaciones = EvaluacionGenerica.objects.filter(materiaasignada__materia=materia)
                    evaluaciones.delete()
                    for maa in materia.asignados_a_esta_materia():
                        maa.evaluacion()
                        maa.notafinal = 0
                        maa.save(request, actualiza=False)
                    if materia.cronogramaevaluacionmodelo_set.exists():
                        cronograma = materia.cronogramaevaluacionmodelo_set.all()[0]
                        cronograma.materias.remove(materia)
                    log(u'Adiciono materia en nivel: %s' % materia.id, request, "add")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError(f'{[{k:v[0]} for k, v in f.errors.items()]}')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos."})

        elif action == 'addmateriamalla':
            try:
                _message, _paralelos, _error, _extra = '', '', False, {}
                nivel = Nivel.objects.get(pk=request.POST['nid'])
                f = MateriaNivelMalla(request.POST)
                if not request.POST.get('mallaid') in ['353', '22']:
                    f.quitar_inglesepunemi()

                if f.is_valid():
                    materiamalla = AsignaturaMalla.objects.get(id=request.POST.get('asignaturamalla'))
                    if periodo.tipo_id == 3 and periodo.clasificacion==2:
                        planif = null_to_decimal(PlanificacionParalelo.objects.filter(periodo=periodo, asignatura=materiamalla.asignatura, status=True).aggregate(paralelo=Max('paralelos'))['paralelo'])
                        if planif:
                            for paralelo in f.cleaned_data['paralelo']:
                                eMaterias = Materia.objects.values_list('id', flat=True).filter(asignaturamalla__asignatura=materiamalla.asignatura, nivel__periodo=periodo,status=True)
                                creada = PlanificacionMateria.objects.filter(status=True, materia__in=eMaterias,  estado=1).count()
                                if creada < planif:
                                    with transaction.atomic():
                                        try:
                                            materia = Materia(asignatura=materiamalla.asignatura,
                                                              asignaturamalla=materiamalla,
                                                              nivel=nivel,
                                                              horas=materiamalla.horas,
                                                              # horassemanales=int(materiamalla.horas / 16),
                                                              horassemanales=int(materiamalla.horaspresencialessemanales) + int(materiamalla.horaspracticassemanales),
                                                              creditos=materiamalla.creditos,
                                                              identificacion=materiamalla.identificacion,
                                                              paralelo=paralelo.nombre,
                                                              paralelomateria=paralelo,
                                                              inicio=nivel.inicio,
                                                              fin=nivel.fin,
                                                              cerrado=False,
                                                              rectora=True,
                                                              actualizarhtml=True,
                                                              # rectora=materiamalla.rectora,
                                                              practicas=False,
                                                              tutoria=False,
                                                              grado=False,
                                                              validacreditos=True,
                                                              validapromedio=True,
                                                              modeloevaluativo=f.cleaned_data['modelo'],
                                                              tipomateria=f.cleaned_data['tipomateria'],
                                                              cupo=CAPACIDAD_MATERIA_INICIAL if CUPO_POR_MATERIA else 0,
                                                              inglesepunemi=f.cleaned_data['inglesepunemi'] if request.POST.get('inglesepunemi') else False)
                                            materia.save(request)
                                            materia.crear_actualizar_requisitos_uic()
                                            log(u'Adiciono materia en nivel: %s' % materia, request, "add")
                                            _paralelos += f"{paralelo.nombre}, "
                                            _extra = {'count': creada + 1}
                                            pm = ProfesorMateria(segmento= 'MATERIA',
                                                                 materia=materia,
                                                                 profesor_id=3834,
                                                                 tipoprofesor_id=7,
                                                                 desde=datetime.now().date(),
                                                                 hasta=datetime.now().date())
                                            pm.save(request)
                                            
                                        except Exception as ex:
                                            transaction.set_rollback(True)
                                            _paralelos += f"<del>{paralelo.nombre}</del>, "
                                else:
                                    _message, _error = f"Se ha completado el número de paralelos para este módulo. {creada}/{planif}", True
                                    break
                            _message += f"{_paralelos} se tacharon los paralelos que no fueron registrados." if _paralelos else ''
                        else:
                            _message, _error = "No se configuró la planificación de paralelos para este módulo", True

                        return JsonResponse({"result": "ok", 'asignatura': "%s" % materiamalla.asignatura.nombre, 'mensaje': "%s" % _message, "error": _error} | _extra)
                    else:
                        creada=0
                        for paralelo in f.cleaned_data['paralelo']:
                            with transaction.atomic():
                                try:
                                    materia = Materia(asignatura=materiamalla.asignatura,
                                                      asignaturamalla=materiamalla,
                                                      nivel=nivel,
                                                      horas=materiamalla.horas,
                                                      # horassemanales=int(materiamalla.horas / 16),
                                                      horassemanales=int(
                                                          materiamalla.horaspresencialessemanales) + int(
                                                          materiamalla.horaspracticassemanales),
                                                      creditos=materiamalla.creditos,
                                                      identificacion=materiamalla.identificacion,
                                                      paralelo=paralelo.nombre,
                                                      paralelomateria=paralelo,
                                                      inicio=nivel.inicio,
                                                      fin=nivel.fin,
                                                      cerrado=False,
                                                      rectora=True,
                                                      actualizarhtml=True,
                                                      # rectora=materiamalla.rectora,
                                                      practicas=False,
                                                      tutoria=False,
                                                      grado=False,
                                                      validacreditos=True,
                                                      validapromedio=True,
                                                      modeloevaluativo=f.cleaned_data['modelo'],
                                                      tipomateria=f.cleaned_data['tipomateria'],
                                                      cupo=CAPACIDAD_MATERIA_INICIAL if CUPO_POR_MATERIA else 0,
                                                      inglesepunemi=f.cleaned_data[
                                                          'inglesepunemi'] if request.POST.get(
                                                          'inglesepunemi') else False)
                                    materia.save(request)
                                    materia.crear_actualizar_requisitos_uic()
                                    log(u'Adiciono materia en nivel: %s' % materia, request, "add")
                                    _paralelos += f"{paralelo.nombre}, "
                                    _extra = {'count': creada + 1}
                                except Exception as ex:
                                    transaction.set_rollback(True)
                                    _paralelos += f"<del>{paralelo.nombre}</del>, "
                        return JsonResponse({"result": "ok", 'asignatura': "%s" % materiamalla.asignatura.nombre, 'mensaje': "%s" % _message, "error": _error} | _extra)
                else:
                    return JsonResponse({"result": False, "mensaje": f"Error al validar los datos.", "form": [{k: v[0]} for k, v in f.errors.items()]})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'editmateria':
            try:
                materia = Materia.objects.get(pk=request.POST['id'])
                f = MateriaNivel(request.POST)
                if f.is_valid():
                    if not f.cleaned_data['practicas'] and materia.practicas and materia.profesormateria_set.filter(tipoprofesor_id__in=[2, 13]).exists():
                        return JsonResponse({"result": "bad", "mensaje": u"Existen docentes de practica en la materia."})
                    if not f.cleaned_data['practicas'] and materia.practicas and materia.practicapreprofesional_set.exists():
                        return JsonResponse({"result": "bad", "mensaje": u"Existen practicas realizadas en la materia."})
                    # if Leccion.objects.filter(clase__materia=materia, fecha__lt=f.cleaned_data['inicio']).exists():
                    #     return JsonResponse({"result": "bad", "mensaje": u"Existen clases impartidas antes de esta fecha."})
                    if Leccion.objects.filter(clase__materia=materia, fecha__gt=f.cleaned_data['fin']).exists():
                        return JsonResponse({"result": "bad", "mensaje": u"Existen clases impartidas despues de esta fecha."})
                    # if f.cleaned_data['inicio'] < materia.nivel.inicio or f.cleaned_data['inicio'] > materia.nivel.fin or f.cleaned_data['inicio'] > materia.fin:
                    #     return JsonResponse({"result": "bad", "mensaje": u"Fecha inicio incorrecta."})
                    if not f.cleaned_data['practicas'] and materia.practicapreprofesional_set.exists():
                        return JsonResponse({"result": "bad", "mensaje": u"La materia ya tiene prácticas realizadas."})
                    materia.horassemanales = int(f.cleaned_data['horassemanales'])
                    # if not MATRICULACION_LIBRE:
                    # if not variable_valor('MATRICULACION_LIBRE'):
                    #     materia.horas = f.cleaned_data['horas']
                    #     materia.creditos = f.cleaned_data['creditos']
                    if f.cleaned_data['asignaturamalla']:
                        materia.horas = f.cleaned_data['asignaturamalla'].horas
                        materia.creditos = f.cleaned_data['asignaturamalla'].creditos

                    if periodo.tipo_id == 3:
                        materia.creditos = f.cleaned_data['creditos']

                    if 'identificacion' in request.POST:
                        materia.identificacion = f.cleaned_data['identificacion']
                    if 'paralelo' in request.POST:
                        materia.paralelo = f.cleaned_data['paralelo'].nombre
                        materia.paralelomateria = f.cleaned_data['paralelo']

                    inicio, fin = f.cleaned_data.get('inicio'), f.cleaned_data.get('fin')
                    if ActaParalelo.objects.values('id').filter(convocatoria__asignaturamalla=materia.asignaturamalla, paralelo=materia.paralelomateria, status=True).exists():
                        if not materia.inicio == inicio or not materia.fin == fin:
                            notificacion(u"Actualización de fechas",
                                         f"{persona} actualizó las fechas de <b>inicio y finalización</b> del módulo: <br> {materia}. <br><br>Fecha anterior: {materia.inicio}/{materia.fin}<br>Fecha actual:&nbsp;&nbsp;&nbsp;{inicio}/{fin}",
                                         Persona.objects.get(pk=variable_valor('ID_EXPERTO_GESTION_POSGRADO')), None, '',
                                         materia.id, 1, 'sga', Materia, request)

                    materia.inicio = inicio
                    materia.alias = f.cleaned_data['alias']
                    materia.fin = fin
                    materia.validapromedio = f.cleaned_data['validapromedio']
                    materia.aplicamovilidad = f.cleaned_data['aplicamovilidad']
                    materia.validacreditos = f.cleaned_data['validacreditos']
                    materia.rectora = f.cleaned_data['rectora']
                    materia.parcial = f.cleaned_data['parcial']
                    materia.tipomateria = f.cleaned_data['tipomateria']
                    materia.seevalua = f.cleaned_data['seevalua']
                    materia.modeloevaluativo = f.cleaned_data['modelo']
                    materia.actualizarhtml = True
                    if 'esintroductoria' in request.POST:
                        materia.esintroductoria = f.cleaned_data['esintroductoria']
                    materia.inglesepunemi = f.cleaned_data['inglesepunemi']
                    if materia.rectora:
                        materia.carrerascomunes.clear()
                        for r in f.cleaned_data['carreras']:
                            materia.carrerascomunes.add(r) #= f.cleaned_data['carreras']
                    else:
                        materia.carrerascomunes.clear()
                    materia.practicas = f.cleaned_data['practicas']
                    materia.sinasistencia = not f.cleaned_data['sinasistencia']
                    if materia.nivel.coordinacion().id == 7:
                        materia.fechainiciomatriculacionposgrado = f.cleaned_data['iniciomatriculacionposgrado']
                        materia.fechafinmatriculacionposgrado = f.cleaned_data['finmatriculacionposgrado']
                        if materia.asignaturamalla.malla.carrera.modalidad == 3:
                            materia.sinasistencia = True
                    materia.save(request)
                    materia.crear_actualizar_requisitos_uic()
                    if CUPO_POR_MATERIA:
                        if f.cleaned_data['cupo']:
                            if f.cleaned_data['cupo'] < materia.cantidad_matriculas_materia():
                                materia.cupo = materia.cantidad_matriculas_materia()
                            else:
                                materia.cupo = f.cleaned_data['cupo']
                        materia.save(request)
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos."})

        elif action == 'deletemateria':
            try:
                materia = Materia.objects.get(pk=request.POST['id'])
                listaprofesores = ProfesorMateria.objects.values_list('profesor_id', flat=True).filter(materia=materia, status=True).distinct()
                if not materia.tiene_matriculas():
                    log(u'Elimino materia: %s' % materia, request, "del")
                    materia.delete()
                for profe in listaprofesores:
                    nomprofe = Profesor.objects.get(pk=profe)
                    nomprofe.actualizar_todo_distributivo_docente(request, periodo)
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar los datos."})

        elif action == 'deletemateriamasivo':
            try:
                datos = json.loads(request.POST['lista'])
                listaitem = []
                # listadocodigomaterias = datos['id']
                # for materia in Materia.objects.filter(pk__in=[x.get("id") for x in datos]):
                for elemento in datos:
                    materia = Materia.objects.get(pk=int(elemento['id']))
                    listaprofesores = ProfesorMateria.objects.values_list('profesor_id', flat=True).filter(materia=materia, status=True).distinct()
                    for profe in listaprofesores:
                        listaitem.append(profe)
                    if not materia.tiene_matriculas():
                        log(u'Elimino materia: %s' % materia, request, "del")
                        materia.delete()
                        # nomprofesor = Profesor.objects.get(pk=profe)
                        # nomprofesor.actualizar_todo_distributivo_docente(request, periodo)
                for lisprofe in listaitem:
                    nomprofesor = Profesor.objects.get(pk=lisprofe)
                    nomprofesor.actualizar_todo_distributivo_docente(request, periodo)
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar los datos."})

        elif action == 'addprofesor':
            try:
                materia = Materia.objects.get(pk=request.POST['mid'])
                if materia.nivel.coordinacion().id != 7:
                    criterios = CriterioDocenciaPeriodo.objects.filter(status=True, periodo=periodo, criterio_id__in=[121,122])
                    if not criterios:
                        return JsonResponse({"result": "bad",
                                             "mensaje": u"Por favor configure los criterios correspondientes. PLANIFICAR Y ACTUALIZAR CONTENIDOS DE CLASES, SEMINARIOS, TALLERES, ENTRE OTROS. y PREPARAR, ELABORAR, APLICAR Y CALIFICAR EXÁMENES, TRABAJOS Y PRÁCTICAS"})
                    else:
                        for criterio in criterios:
                            if criterio.porcentaje == 0:
                                return JsonResponse({"result": "bad",
                                                     "mensaje": u"Por favor configure los porcentajes en el módulo criterios y actividades."})
                f = ProfesorMateriaForm(request.POST)
                if f.is_valid():
                    inicio = f.cleaned_data['desde']
                    fin = f.cleaned_data['hasta']
                    idtipoprofesor = f.cleaned_data['tipoprofesor'].id
                    # comentado por kerly 12/04/2019
                    # if inicio < materia.inicio or fin > materia.fin:
                    #     return JsonResponse({"result": "bad", "mensaje": u"Fechas incorrectas."})
                    # if f.cleaned_data['tipoprofesor'].id == TIPO_DOCENTE_TEORIA and materia.profesormateria_set.values('id').filter(tipoprofesor__id=TIPO_DOCENTE_TEORIA, activo=True).exists():
                    #     return JsonResponse({"result": "bad", "mensaje": u"Ya existe un docente principal registrado la materia."})
                    if periodo.configurarhora:
                        if not periodo.profesorconfigurarhoras_set.filter(profesor_id=f.cleaned_data['profesor'],
                                                                          status=True).exists():
                            return JsonResponse({"result": "bad",
                                                 "mensaje": u"El Docente no tiene configurada las horas mínimas y máximas."})
                        else:
                            professorcalcular = Profesor.objects.get(pk=f.cleaned_data['profesor'])
                            profesorhoras = periodo.profesorconfigurarhoras_set.get(profesor=professorcalcular,
                                                                                    status=True)
                            numerohorasdocente = null_to_numeric(
                                professorcalcular.profesormateria_set.filter(materia__nivel__periodo=periodo,
                                                                             status=True).aggregate(suma=Sum('hora'))[
                                    'suma'])
                            numerocompara = numerohorasdocente + int(f.cleaned_data['hora'])
                            if numerocompara > profesorhoras.horamaxima:
                                return JsonResponse(
                                    {"result": "bad", "mensaje": u"El Docente sobrepasa las horas máximas."})

                            numeroasignaturadocente = professorcalcular.profesormateria_set.values_list(
                                'materia__asignatura_id', flat=True).filter(materia__nivel__periodo=periodo, hora__gt=0,
                                                                            status=True).distinct()
                            idasignatura = int(materia.asignatura.id)
                            if idasignatura not in (numeroasignaturadocente):
                                totalasignadas = numeroasignaturadocente.count() + 1
                            else:
                                totalasignadas = numeroasignaturadocente.count()
                            if totalasignadas > profesorhoras.horamaximaasignatura:
                                return JsonResponse({"result": "bad",
                                                     "mensaje": u"El Docente sobrepasa el máximo de asignaturas sugeridas."})
                    if materia.profesormateria_set.values('id').filter(profesor_id=f.cleaned_data['profesor'],
                                                                       tipoprofesor=f.cleaned_data[
                                                                           'tipoprofesor']).exists():
                        pm = materia.profesormateria_set.filter(profesor_id=f.cleaned_data['profesor'],
                                                                tipoprofesor=f.cleaned_data['tipoprofesor'])[0]
                        if pm.activo:
                            return JsonResponse(
                                {"result": "bad", "mensaje": u"Ya el docente esta registrado la materia."})
                        else:
                            pm.activo = True
                            pm.save(request)
                    else:
                        pm = ProfesorMateria(segmento=f.cleaned_data['segmento'],
                                             materia=materia,
                                             profesor_id=f.cleaned_data['profesor'],
                                             principal=f.cleaned_data['principal'],
                                             tipoprofesor=f.cleaned_data['tipoprofesor'],
                                             hora=f.cleaned_data['hora'],
                                             evalua=f.cleaned_data['evalua'],
                                             novalidahorario=f.cleaned_data['novalidahorario'],
                                             desde=inicio,
                                             hasta=fin)
                        pm.save(request)
                    if variable_valor('VERIFICAR_CONFLICTO_DOCENTE'):
                        if not pm.tipoprofesor.id == 2:
                            conflicto = conflicto_materias_seleccionadas_aux(
                                pm.profesor.materias_imparte_periodo_aux(periodo, pm.tipoprofesor), pm)
                            if conflicto:
                                transaction.set_rollback(True)
                                return JsonResponse({"result": "bad", "mensaje": conflicto})
                    if materia.profesormateria_set.values("id").count() > 1:
                        materia.practicas = True
                    materia.actualizarhtml = True
                    materia.save(request)
                    # ASIGNAR DOCENTES EN CLASES EN SIN PROFESOR SEGUN EL TIPO
                    #pm.asignar_horario_enblanco_a_profesor(request)
                    profe = Profesor.objects.get(pk=f.cleaned_data['profesor'])
                    if materia.nivel.coordinacion().id == 7:
                        profe.actualizar_todo_distributivo_docenteposgrado(request, periodo, materia)
                    # elif materia.nivel.coordinacion().id != 9:
                    #     profe.actualizar_todo_distributivo_docente(request, periodo)
                    #actualmente el periodo de admision esta en pregrado y debe calcular las horas del distributivo
                    else:
                        profe.actualizar_todo_distributivo_docente(request, periodo)
                    # sirve para verificar que al ingresar en el distributivo no sobrepase el numero de horas segun el tiempo de dedicacion
                    # distributivo=pm.profesor.distributivohoras(pm.materia.nivel.periodo)
                    # if distributivo.sobrepasa_horas():
                    #     transaction.set_rollback(True)
                    #     return JsonResponse({"result": "bad", "mensaje": u"Limite de horas a sobrepasado."})
                    if periodo.fechadesdenotificacion:
                        if periodo.fechadesdenotificacion <= datetime.now().date():
                            descripcion = u'Se adicionó al profesor: %s con tipo profesor: %s en la materia: %s con %s horas desde %s a %s en el periodo de %s' % (
                                pm.profesor.persona.nombre_completo_inverso(), pm.tipoprofesor,
                                pm.materia.nombre_mostrar_solo(), pm.hora, pm.desde.strftime('%d-%m-%Y'),
                                pm.hasta.strftime('%d-%m-%Y'), pm.materia.nivel.periodo)
                            pm.profesor.mail_notificar_procesoevaluacion(request.session['nombresistema'], descripcion,
                                                                         persona, pm.materia.nivel.periodo)
                    log(u'Adiciono profesor de materia: %s' % pm, request, "add")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": f"Error al guardar los datos. {ex} ({sys.exc_info()[-1].tb_lineno})"})

        elif action == 'actualizar_horario_pm':
            try:
                # SE VERIFICA CONFLICTO Y ACTUALIZA HORARIO DEL PROFESOR MATERIA
                listamensajeconflicto = []
                conflictohorario = False
                data = {}
                contar_conflictos = 0
                contar_sin_conflictos = 0
                json_content = None
                pm = ProfesorMateria.objects.get(pk=request.POST['id'])
                fechainicio = convertir_fecha(request.POST['fi'])
                fechafin = convertir_fecha(request.POST['ff'])
                tipoprofesor = pm.tipoprofesor
                if puede_realizar_accion_afirmativo(request, 'sga.puede_modificar_tipoprofesor'):
                    if request.POST['idt'].__len__() == 0:
                        return JsonResponse({"result": "bad", "mensaje": u"Seleccione un tipo de profesor."})
                    tipoprofesor = TipoProfesor.objects.get(pk=int(request.POST['idt']))
                #     comentado por kerlty12/04/2019
                # if fechainicio < pm.materia.inicio or fechafin > pm.materia.fin or fechainicio > fechafin:
                #     return JsonResponse({"result": "bad", "mensaje": u"Fechas incorrectas."})
                if tipoprofesor.id != 4:
                    if pm.materia.profesormateria_set.filter(tipoprofesor=tipoprofesor, profesor=pm.profesor,
                                                             activo=True).exclude(pk=pm.id).exists():
                        return JsonResponse({"result": "bad",
                                             "mensaje": u"El docente ya se encuentra registrado con el mismo tipo profesor en la materia."})
                if variable_valor('VERIFICAR_CONFLICTO_DOCENTE'):
                    if tipoprofesor.id in [1, 2, 4, 5, 6, 7]:
                        clases = Clase.objects.filter(materia=pm.materia, tipoprofesor=pm.tipoprofesor,
                                                      profesor=pm.profesor, activo=True)
                        for clase in clases:
                            verificar_conflito_docente = pm.profesor.existe_conflicto_docente(periodo, clase.materia,
                                                                                              tipoprofesor, fechainicio,
                                                                                              fechafin, clase.dia,
                                                                                              clase.turno, False, clase)
                            if not verificar_conflito_docente[0]:
                                tipoanterioranterior = clase.tipoprofesor
                                fechainicioanterior = clase.inicio
                                fechafinanterior = clase.fin
                                clase.tipoprofesor = tipoprofesor
                                clase.inicio = fechainicio
                                clase.fin = fechafin
                                clase.save(request)
                                contar_sin_conflictos += 1
                                log(
                                    u'Se cambio las fechas de inicio y fin y tipo profesor en el horario del profesor [antes (%s - %s - %s) - actualizacion (%s - %s - %s)] con el profesormateria (%s) en la clase (%s) de materia (%s)' % (
                                        tipoanterioranterior, fechainicioanterior, fechafinanterior, clase.tipoprofesor,
                                        clase.inicio, clase.fin, pm, clase, pm.materia), request, "edit")
                            else:
                                listamensajeconflicto.append(verificar_conflito_docente)
                                conflictohorario = True
                                contar_conflictos += 1
                    if conflictohorario:
                        data['mensajes'] = listamensajeconflicto
                        data['contarclasesconflicto'] = contar_conflictos.__str__()
                        data['clasesafectadas'] = contar_sin_conflictos.__str__()
                        template = get_template("niveles/mensajeconflicto.html")
                        json_content = template.render(data)
                return JsonResponse({"result": "ok", 'segmento': json_content, 'existeconflicto': conflictohorario,
                                     'clasesafectadas': contar_sin_conflictos.__str__()})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al cambiar los datos en el horario."})

        elif action == 'editprofesor':
            try:
                f = ProfesorMateriaForm(request.POST)
                if f.is_valid():
                    pm = ProfesorMateria.objects.get(pk=request.POST['id'])

                    if pm.materia.nivel.coordinacion().id != 7:
                        criterios = CriterioDocenciaPeriodo.objects.filter(status=True, periodo=periodo,
                                                                           criterio_id__in=[121, 122])
                        for criterio in criterios:
                            if criterio.porcentaje == 0:
                                return JsonResponse({"result": "bad",
                                                     "mensaje": u"Por favor configure los porcentajes en el módulo criterios y actividades."})

                    profesor_nuevo = Profesor.objects.get(pk=f.cleaned_data['profesor'])
                    if periodo.configurarhora:
                        if not periodo.profesorconfigurarhoras_set.filter(profesor_id=f.cleaned_data['profesor'], status=True).exists():
                            return JsonResponse({"result": "bad", "mensaje": u"El Docente no tiene configurada las horas mínimas y máximas."})
                        else:
                            # professorcalcular = Profesor.objects.get(pk=f.cleaned_data['profesor'])
                            profesorhoras = periodo.profesorconfigurarhoras_set.get(profesor=profesor_nuevo, status=True)
                            numerohorasdocente = null_to_numeric(pm.profesor.profesormateria_set.filter(materia__nivel__periodo=periodo, status=True).exclude(pk=pm.id).aggregate(suma=Sum('hora'))['suma'])
                            numerocompara = numerohorasdocente + int(f.cleaned_data['hora'])
                            if numerocompara > profesorhoras.horamaxima:
                                return JsonResponse({"result": "bad", "mensaje": u"El Docente sobrepasa las horas máximas."})

                            numeroasignaturadocente = pm.profesor.profesormateria_set.values_list('materia__asignatura_id', flat=True).filter(materia__nivel__periodo=periodo, hora__gt=0, status=True).distinct()
                            idasignatura = int(pm.materia.asignatura.id)
                            if idasignatura not in (numeroasignaturadocente):
                                totalasignadas = numeroasignaturadocente.count() + 1
                            else:
                                totalasignadas = numeroasignaturadocente.count()
                            if totalasignadas > profesorhoras.horamaximaasignatura:
                                return JsonResponse({"result": "bad", "mensaje": u"El Docente sobrepasa el máximo de asignaturas sugeridas."})
                    periodo = pm.materia.nivel.periodo
                    idtipoprofesor = f.cleaned_data['tipoprofesor']
                    if f.cleaned_data['tipoprofesor']:
                        pm.tipoprofesor = f.cleaned_data['tipoprofesor']
                    pm.desde = f.cleaned_data['desde']
                    pm.hasta = f.cleaned_data['hasta']
                    pm.utilizawebex = f.cleaned_data['utilizawebex']
                    pm.hora = f.cleaned_data['hora']
                    pm.evalua = f.cleaned_data['evalua']
                    pm.subactividadtutorvirtual = f.cleaned_data['subactividadtutorvirtual']
                    pm.principal = f.cleaned_data['principal']
                    pm.novalidahorario = f.cleaned_data['novalidahorario']
                    pm.profesor = profesor_nuevo
                    pm.save(request)
                    materia = pm.materia
                    materia.actualizarhtml = True
                    materia.save(request)
                    # ASIGNAR DOCENTES EN CLASES EN SIN PROFESOR SEGUN EL TIPO
                    pm.asignar_horario_enblanco_a_profesor(request)
                    if materia.nivel.coordinacion().id == 7:
                        profesor_nuevo.actualizar_todo_distributivo_docenteposgrado(request, periodo, materia)
                    else:
                        profesor_nuevo.actualizar_todo_distributivo_docente(request, periodo)
                    if periodo.fechadesdenotificacion:
                        if periodo.fechadesdenotificacion <= datetime.now().date():
                            descripcion = u'Se editó al profesor: %s con tipo profesor: %s en la materia: %s con %s horas desde %s a %s en el periodo de %s' % (
                                pm.profesor.persona.nombre_completo_inverso(), pm.tipoprofesor,
                                pm.materia.nombre_mostrar_solo(), pm.hora, pm.desde.strftime('%d-%m-%Y'),
                                pm.hasta.strftime('%d-%m-%Y'), pm.materia.nivel.periodo)
                            pm.profesor.mail_notificar_procesoevaluacion(request.session['nombresistema'], descripcion,
                                                                         persona, pm.materia.nivel.periodo)
                    log(u'Modifico profesor de materia: %s' % pm, request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError(f'{[{k:v[0]} for k, v in f.errors.items()]}')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": 'Error al modificar los datos. {} error en la linea {}'.format(ex, sys.exc_info()[-1].tb_lineno)})

        elif action == 'delprofesor':
            try:
                pm = ProfesorMateria.objects.get(pk=int(encrypt(request.POST['id'])))
                idtipoprofesor = pm.tipoprofesor_id
                profesor = pm.profesor
                periodo = pm.materia.nivel.periodo
                log(u'Elimino profesor de materia: %s' % pm, request, "del")
                materia = pm.materia
                materia.actualizarhtml = True
                materia.save(request)
                # BORRA CAMPO PROFESOR EN CLASE DE HORARIO
                clases = Clase.objects.filter(materia=pm.materia, tipoprofesor=pm.tipoprofesor, profesor=pm.profesor,
                                              activo=True)
                for clase in clases:
                    clase.profesor = None
                    clase.grupoprofesor = None
                    if pm.tipoprofesor.id in [1, 5, 6, 7]:
                        clase.tipoprofesor = None
                    clase.save(request)
                    log(
                        u'Elimino profesor de clase(%s[%s]) porque elimino el profesor (%s) de la materia(%s[%s]) en el modulo de niveles materias' % (
                            clase, clase.id, pm, pm.materia, pm.materia.id), request, "del")
                # GUARDA EL MOTIVO DE LA ELIMINACION DEL PROFESOR
                EliminarProfesorMateria(profesor=pm.profesor, materia=pm.materia,
                                        motivo=request.POST['motivo'].upper()).save(request)
                if periodo.fechadesdenotificacion:
                    if periodo.fechadesdenotificacion <= datetime.now().date():
                        descripcion = u'Se eliminó al profesor: %s con tipo profesor: %s en la materia: %s con %s horas desde %s a %s en el periodo de %s - motivo de eliminación %s' % (
                            pm.profesor.persona.nombre_completo_inverso(), pm.tipoprofesor,
                            pm.materia.nombre_mostrar_solo(), pm.hora, pm.desde.strftime('%d-%m-%Y'),
                            pm.hasta.strftime('%d-%m-%Y'), pm.materia.nivel.periodo, request.POST['motivo'].upper())
                        pm.profesor.mail_notificar_procesoevaluacion(request.session['nombresistema'], descripcion,
                                                                     persona, pm.materia.nivel.periodo)
                if not pm.materia.nivel.distributivoaprobado and not pm.grupoprofesormateria():
                    pm.delete()
                else:
                    pm.activo = False
                    pm.save(request)
                if materia.nivel.coordinacion().id == 7:
                    profesor.actualizar_todo_distributivo_docenteposgrado(request, periodo, materia)
                else:
                    profesor.actualizar_todo_distributivo_docente(request, periodo)
                if idtipoprofesor == 2:
                    if pm.materia.actualizar_cupo_profesores_practicas_grupo():
                        log(
                            u'Actualizo cupos a todos los profesores de materia (%s) porque elimino profesor en materia(%s)' % (
                                pm.materia, pm), request, "edit")
                if pm.grupoprofesormateria():
                    log(
                        u'Elimino todos los alumnos de practicas en todos los grupos del profesor materia: materia - (%s), profesormateria(%s[%s])' % (
                            pm.materia, pm, pm.id), request, "edit")
                    for grupoprofesor in pm.grupoprofesormateria():
                        grupoprofesor.listado_inscritos_grupos_practicas().delete()
                    pm.grupoprofesormateria().delete()
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar los datos."})

        elif action == 'auditoriaprofe':
            try:
                data['materia'] = Materia.objects.get(pk=int(encrypt(request.POST['id'])))
                template = get_template("niveles/auditoriaprofesor.html")
                json_content = template.render(data)
                return JsonResponse({"result": "ok", 'data': json_content})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al consultar los datos."})

        elif action == 'grupospracticas':
            try:
                data['profesormateria'] = profesormat = ProfesorMateria.objects.get(pk=int(encrypt(request.POST['id'])))
                data['grupospracticas'] = profesormat.gruposprofesormateria_set.filter(status=True)
                data['paralelos'] = PARALELO_CLASE_PRACTICAS
                template = get_template("niveles/grupospracticas.html")
                json_content = template.render(data)
                return JsonResponse({"result": "ok", 'data': json_content})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al consultar los datos."})

        elif action == 'addgrupospracticas':
            try:
                profesormateria = ProfesorMateria.objects.get(pk=int(request.POST['id']))
                if not GruposProfesorMateria.objects.filter(profesormateria__materia=profesormateria.materia,
                                                            profesormateria__materia__paralelo=profesormateria.materia.paralelo,
                                                            paralelopractica=int(request.POST['paralelo']),
                                                            status=True).exists():
                    grupo = GruposProfesorMateria(profesormateria=profesormateria, cupo=int(request.POST['cupo']),
                                                  paralelopractica=int(request.POST['paralelo']))
                    grupo.save(request)
                    clases = Clase.objects.filter(materia=profesormateria.materia, profesor=profesormateria.profesor,
                                                  grupoprofesor__isnull=True, activo=True)
                    for clase in clases:
                        clase.grupoprofesor = grupo
                        clase.save(request)
                        log(u'Se asigno grupo en la clase (%s)(%s)' % (clase, clase.id), request, "edit")
                    # profesormateria.materia.actualizar_cupo_profesores_practicas_grupo(grupo)
                    log(u'Adiciono grupo profesor materia cupo(%s) paralelopracticas(%s) profemate(%s)' % (
                        grupo.cupo, grupo.paralelopractica, grupo.profesormateria), request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    return JsonResponse(
                        {"result": "bad", "mensaje": u"Ya existe en la materia registros con el mismo paralelo."})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos."})

        elif action == 'delgrupospracticas':
            try:
                grupo = GruposProfesorMateria.objects.get(pk=int(request.POST['id']))
                clases = Clase.objects.filter(grupoprofesor=grupo, activo=True)
                for clase in clases:
                    clase.grupoprofesor = None
                    clase.save(request)
                log(u'Elimino grupo profesor materia cupo(%s) paralelopracticas(%s) profemate(%s) ' % (
                    grupo.cupo, grupo.paralelopractica, grupo.profesormateria), request, "edit")
                profesormateria = grupo.profesormateria
                grupo.listado_inscritos_grupos_practicas().delete()
                grupo.delete()
                # profesormateria.materia.actualizar_cupo_profesores_practicas_grupo()
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar los datos."})

        elif action == 'cambiarparalelogrupo':
            try:
                grupoprofesor = GruposProfesorMateria.objects.get(pk=int(encrypt(request.POST['id'])))
                if GruposProfesorMateria.objects.filter(paralelopractica=int(request.POST['idp']),
                                                        profesormateria__materia=grupoprofesor.profesormateria.materia,
                                                        profesormateria__materia__paralelo=grupoprofesor.profesormateria.materia.paralelo,
                                                        status=True).exists():
                    return JsonResponse(
                        {"result": "bad", "mensaje": u"Ya existe en la materia registros con el mismo paralelo."})
                paralelo = grupoprofesor.paralelopractica
                grupoprofesor.paralelopractica = int(request.POST['idp'])
                grupoprofesor.save(request)
                log(
                    u'Edito paralelo (%s)nuevo(%s) grupo profesor materia cupo(%s) paralelopracticas(%s) profemate(%s) y se actualizo toda el horario del profesor materia' % (
                        paralelo, grupoprofesor.paralelopractica, grupoprofesor.cupo, grupoprofesor.paralelopractica,
                        grupoprofesor.profesormateria), request, "edit")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos."})

        elif action == 'updatefechainiciosemanal':
            try:
                silabosemanal = SilaboSemanal.objects.get(pk=request.POST['idsilabosemanal'])
                if int(request.POST['tipo']) == 1:
                    fechainicio = convertir_fecha(request.POST['fecha'])
                    silabosemanal.fechainiciosemana = fechainicio
                if int(request.POST['tipo']) == 2:
                    fechainicio = convertir_fecha(request.POST['fecha'])
                    silabosemanal.fechafinciosemana = fechainicio
                silabosemanal.save(request)
                return JsonResponse({'result': 'ok', 'fecha': silabosemanal.fechainiciosemana.strftime("%d-%m-%Y")})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({'result': 'bad'})

        elif action == 'updatefechainicio':
            try:
                materia = Materia.objects.get(pk=request.POST['mid'])
                fechainicio = convertir_fecha(request.POST['fecha'])
                # QUITADO VALIDACION POR LA JEFA 14/03/2018
                # if fechainicio < materia.nivel.inicio or fechainicio > materia.nivel.fin or fechainicio > materia.fin:
                #     return JsonResponse({"result": "bad", "mensaje": u"Fecha inicio incorrecta."})
                # if Leccion.objects.filter(clase__materia=materia, fecha__lt=fechainicio).exists():
                #     return JsonResponse({"result": "bad", "mensaje": u"Existen clases impartidas antes de esta fecha."})
                for pm in materia.profesormateria_set.all():
                    pm.desde = fechainicio
                    pm.save(request)
                if ActaParalelo.objects.values('id').filter(convocatoria__asignaturamalla=materia.asignaturamalla, paralelo=materia.paralelomateria, status=True).exists():
                    notificacion(u"Actualización de fechas", f"{persona} actualizó la fecha de <b>inicio</b> del módulo: <br> {materia}. <br><br>Fecha anterior: {materia.inicio}<br>Fecha actual: <b>{fechainicio}</b>", Persona.objects.get(pk=variable_valor('ID_EXPERTO_GESTION_POSGRADO')), None, '', materia.id, 1, 'sga', Materia, request)
                materia.inicio = fechainicio
                materia.actualizarhtml = True
                materia.save(request)
                return JsonResponse({'result': 'ok', 'fecha': materia.inicio.strftime("%d-%m-%Y"),
                                     'profesores': materia.profesores_materia().count()})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({'result': 'bad'})

        elif action == 'updatefechafin':
            try:
                materia = Materia.objects.get(pk=request.POST['mid'])
                fechafin = convertir_fecha(request.POST['fecha'])
                if Leccion.objects.filter(clase__materia=materia, fecha__gt=fechafin).exists():
                    raise NameError(u"Existen clases impartidas despues de esta fecha.")
                if fechafin < materia.inicio:
                    raise NameError(u"La fecha fin no puede ser menor a la de inicio.")
                for pm in materia.profesormateria_set.all():
                    pm.hasta = fechafin
                    pm.save(request)

                if ActaParalelo.objects.values('id').filter(convocatoria__asignaturamalla=materia.asignaturamalla, paralelo=materia.paralelomateria, status=True).exists():
                    notificacion(u"Actualización de fechas", f"{persona} actualizó la fecha de <b>finalización</b> del módulo: <br> {materia}. <br><br>Fecha anterior: {materia.inicio}<br>Fecha actual: <b>{fechafin}</b>", Persona.objects.get(pk=variable_valor('ID_EXPERTO_GESTION_POSGRADO')), None, '', materia.id, 1, 'sga', Materia, request)

                materia.fin = fechafin
                materia.actualizarhtml = True
                materia.fechafinasistencias = fechafin
                materia.save(request)
                for asig in materia.asignados_a_esta_materia():
                    asig.save(request, actualiza=False)
                    asig.actualiza_estado()
                    asig.actualiza_notafinal()
                return JsonResponse({'result': 'ok', 'fecha': materia.fin.strftime("%d-%m-%Y"), 'profesores': materia.profesores_materia().count()})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al cambiar fecha. %s" % ex})

        elif action == 'updatecupomateria':
            try:
                materia = Materia.objects.get(pk=request.POST['mid'])
                valor = int(request.POST['valor'])
                validarvalor = valor + materia.cupoadicional
                if validarvalor < materia.cantidad_matriculas_materia():
                    return JsonResponse({"result": "bad",
                                         "mensaje": u"No puede establecer un cupo menor a " + materia.cantidad_matriculas_materia().__str__()})
                cupoanterior = materia.cupo - materia.totalmatriculadocupoadicional
                materia.cupo = valor + materia.totalmatriculadocupoadicional
                materia.save(request)
                if materia.actualizar_cupo_profesores_practicas_grupo():
                    log(u'Edito cupo a profesores de grupo de la materia: %s cupo anterior: %s cupo actual: %s' % (
                        materia, str(cupoanterior), str(materia.cupo)), request, "edit")
                log(u'Adiciono cupo a materia: %s cupo anterior: %s cupo actual: %s' % (
                    materia, str(cupoanterior), str(materia.cupo)), request, "add")
                return JsonResponse({'result': 'ok', 'valor': materia.cupo - materia.totalmatriculadocupoadicional})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'updatecupoadicionalmateria':
            try:
                materia = Materia.objects.get(pk=request.POST['mid'])
                valor = int(request.POST['valor'])
                if valor < materia.totalmatriculadocupoadicional:
                    return JsonResponse({"result": "bad",
                                         "mensaje": u"No puede establecer un cupo adicional menor a " + materia.cantidad_matriculas_materia().__str__()})
                cupoanterior = materia.cupoadicional
                materia.cupoadicional = valor
                materia.save(request)
                if materia.actualizar_cupo_profesores_practicas_grupo():
                    log(
                        u'Edito cupo adicional a profesores de grupo de la materia: %s cupo adicionar anterior: %s cupo adicional actual: %s' % (
                            materia, str(cupoanterior), str(materia.cupo)), request, "edit")
                log(u'Adiciono cupo adicional a materia: %s cupo adicional anterior: %s cupo adicional actual: %s' % (
                    materia, str(cupoanterior), str(materia.cupo)), request, "add")
                return JsonResponse({'result': 'ok', 'valor': materia.cupoadicional})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'updatecupomovilidadmateria':
            try:
                materia = Materia.objects.get(pk=request.POST['mid'])
                valor = int(request.POST['valor'])
                # if valor < materia.cupomovilidad:
                #     return JsonResponse({"result": "bad",
                #                          "mensaje": u"No puede establecer un cupo adicional menor a " + materia.cantidad_matriculas_materia().__str__()})
                cupoanterior = materia.cupomovilidad
                materia.cupomovilidad = valor
                materia.save(request)
                if materia.actualizar_cupo_profesores_practicas_grupo():
                    log(
                        u'Edito cupo de movilidad a profesores de grupo de la materia: %s cupo de movilidad anterior: %s cupo de movilidad actual: %s' % (
                            materia, str(cupoanterior), str(materia.cupo)), request, "edit")
                log(u'Adiciono cupo de movilidad a materia: %s cupo de movilidad anterior: %s cupo de movilidad actual: %s' % (
                    materia, str(cupoanterior), str(materia.cupo)), request, "add")
                return JsonResponse({'result': 'ok', 'valor': materia.cupomovilidad})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'updatecodigosakai':
            try:
                materia = Materia.objects.get(pk=request.POST['mid'])
                valor = request.POST['vc']
                materia.codigosakai = valor
                materia.save(request)
                return JsonResponse({'result': 'ok', 'valor': materia.codigosakai})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({'result': 'bad', "mensaje": u"Error al actualizar codigo sakai."})

        elif action == 'cambiaraula':
            try:
                materia = Materia.objects.get(pk=request.POST['id'])
                f = CambiarAulaForm(request.POST)
                if f.is_valid():
                    clases = materia.clase_set.filter(activo=True)
                    for c in clases:
                        c.aula = f.cleaned_data['aula']
                        c.save(request)
                    materia.actualizarhtml = True
                    materia.save()
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos."})

        elif action == 'cambiarmodelo':
            try:
                materia = Materia.objects.get(pk=request.POST['id'])
                f = ListaModeloEvaluativoForm(request.POST)
                if f.is_valid():
                    if materia.cerrado:
                        return JsonResponse({"result": "bad", "mensaje": u"La materia se encuentra cerrada."})
                    # if materia.materiaasignada_set.filter(notafinal__gt=0).exists():
                    #     return JsonResponse({"result": "bad", "mensaje": u"No se puede cambiar el modelo, existen calificaciones ingresadas."})
                    materia.modeloevaluativo = f.cleaned_data['modelo']
                    materia.save(request)
                    evaluaciones = EvaluacionGenerica.objects.filter(materiaasignada__materia=materia)
                    evaluaciones.delete()
                    for maa in materia.asignados_a_esta_materia():
                        maa.evaluacion()
                        maa.notafinal = 0
                        maa.save(request, actualiza=False)
                    if materia.cronogramaevaluacionmodelo_set.exists():
                        cronograma = materia.cronogramaevaluacionmodelo_set.all()[0]
                        cronograma.materias.remove(materia)
                    log(u'Modifico modelo evaluativo: %s' % materia, request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'matricularmodulo':
            try:
                materia = Materia.objects.get(pk=request.POST['id'])
                f = MatricularModuloForm(request.POST)
                if f.is_valid():
                    # if materia.cerrado:
                    #     return JsonResponse({"result": "bad", "mensaje": u"La materia se encuentra cerrada."})
                    if not f.cleaned_data['materia'].modeloevaluativo:
                        return JsonResponse({"result": "bad", "mensaje": u"Asignatura no tiene modelo evaluativo."})
                    for maa in materia.asignados_a_esta_materia():
                        matricula = maa.matricula
                        # Solo se matriculan a la materia los alumnos que no tengan bloqueo
                        if matricula.bloqueomatricula is False:
                            materia = f.cleaned_data['materia']
                            if not MateriaAsignada.objects.filter(matricula=matricula, materia=materia).exists():
                                matriculas = matricula.inscripcion.historicorecordacademico_set.values('id').filter(
                                    asignatura=materia.asignatura, fecha__lt=materia.nivel.fin).count() + 1
                                materiaasignada = MateriaAsignada(matricula=matricula,
                                                                  materia=materia,
                                                                  notafinal=0,
                                                                  asistenciafinal=0,
                                                                  cerrado=False,
                                                                  matriculas=matriculas,
                                                                  observaciones='',
                                                                  estado_id=NOTA_ESTADO_EN_CURSO)
                                materiaasignada.save(request)
                                materiaasignada.asistencias()
                                materiaasignada.evaluacion()
                                materiaasignada.mis_planificaciones()
                                materiaasignada.save(request)
                                matricula.actualizar_horas_creditos()
                                with transaction.atomic():
                                    # if int(cobro) > 0:
                                    #     if matricula.inscripcion.mi_coordinacion().id != 9:
                                    #         # matricula.calcular_rubros_matricula(request,int(cobro))
                                    #         matricula.agregacion_aux(request)
                                    # matricula.actualiza_matricula()
                                    # matricula.inscripcion.actualiza_estado_matricula()
                                    # matricula.grupo_socio_economico(tipo_matricula_ri)
                                    matricula.calcula_nivel()

                                # send_html_mail("Matricula por secretaria", "emails/matricula.html",{'sistema': request.session['nombresistema'], 'matricula': matricula,'t': miinstitucion()}, inscripcion.persona.lista_emails_envio(), [],cuenta=CUENTAS_CORREOS[5][1])
                                log(u'Matricula posgrado por matriculamodulo: %s' % matricula, request, "add")
                                # valorpagar = str(null_to_decimal(matricula.rubro_set.filter(status=True).aggregate(valor=Sum('valortotal'))['valor']))
                                # descripcionarancel = ''
                                # valorarancel = ''
                                # if matricula.rubro_set.filter(status=True, tipo_id=RUBRO_ARANCEL).exists():
                                #     ra = matricula.rubro_set.get(tipo_id=RUBRO_ARANCEL)
                                #     descripcionarancel = ra.nombre
                                #     valorarancel = str(ra.valortotal)
                                #     matricula.aranceldiferido = 2
                                #     matricula.save(request)
                                # ConfirmaCapacidadTecnologica.objects.filter(persona=matricula.inscripcion.persona).update(confirmado=True)

                    # log(u'Modifico modelo evaluativo: %s' % materia, request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'dividirparalelo':
            try:
                materiaseleccionada = Materia.objects.get(pk=request.POST['idmateria'])
                f = MateriaParaleloForm(request.POST)
                if f.is_valid():
                    if materiaseleccionada.cerrado:
                        return JsonResponse({"result": "bad", "mensaje": u"La materia se encuentra cerrada."})
                    nivel = materiaseleccionada.nivel
                    nivelmalla = materiaseleccionada.asignaturamalla.nivelmalla
                    malla = materiaseleccionada.asignaturamalla.malla
                    maas = materiaseleccionada.asignados_a_esta_materia_rango(f.cleaned_data['valor'])
                    for matricula in maas:
                        for materiaasignada in MateriaAsignada.objects.filter(status=True,
                                                                              matricula=matricula.matricula):
                            asignaturamalla = materiaasignada.materia.asignaturamalla
                            for materia in Materia.objects.filter(asignaturamalla=asignaturamalla,
                                                                  paralelomateria=f.cleaned_data['paralelo'],
                                                                  nivel__periodo=nivel.periodo,
                                                                  asignaturamalla__nivelmalla=nivelmalla,
                                                                  asignaturamalla__malla=malla,
                                                                  asignaturamalla__status=True, status=True).distinct()[0:1]:
                                profesormateria = None
                                matriculacupoadicional = False
                                estudiantepractica = None
                                grupoprofesormateria = None
                                # if materia.asignaturamalla.practicas:
                                #     return JsonResponse({"result": "bad", "mensaje": u"Esta opción no mes para materias prácticas"})
                                # if materiaasignada.materia.asignaturamalla.malla.carrera.id.__str__() in variable_valor('LISTA_CARRERA_PARA_MATRICULA_GRUPO_PRACTICA'):
                                #     if not int(request.POST['idp']) > 0:
                                #         return JsonResponse({"result": "bad", "mensaje": u"Seleccione un horario de prácticas."})
                                #     else:
                                #         profesormateria = ProfesorMateria.objects.get(pk=int(request.POST['idp']),materia=materia)
                                #         if not int(request.POST['idg']) > 0 and profesormateria.grupoprofesormateria():
                                #             return JsonResponse({"result": "bad", "mensaje": u"Seleccione un horario de prácticas."})
                                #         else:
                                #             if profesormateria.grupoprofesormateria():
                                #                 grupoprofesormateria = GruposProfesorMateria.objects.get(pk=int(request.POST['idg']), profesormateria__materia=materia,profesormateria=profesormateria)
                                #                 profesormateria = None
                                if MATRICULACION_LIBRE:
                                    if not materia.tiene_capacidad():
                                        if materia.cupoadicional > 0:
                                            if not materia.existen_cupos_con_adicional():
                                                return JsonResponse({"result": "bad",
                                                                     "mensaje": u"No existe cupo adicional para esta materia"})
                                            else:
                                                matriculacupoadicional = True
                                        else:
                                            return JsonResponse(
                                                {"result": "bad", "mensaje": u"No existe cupo para esta materia"})
                                    # if grupoprofesormateria:
                                    #     if not grupoprofesormateria.cuposdisponiblesgrupoprofesor() > 0:
                                    #         return JsonResponse({"result": "bad", "mensaje": u"No existe cupo para en la práctica"})
                                # if AlumnosPracticaMateria.objects.values('id').filter(materiaasignada=materiaasignada).exists():
                                #     return JsonResponse({"result": "bad", "mensaje": u"Esta opción no mes para materias prácticas"})
                                # estudiantepractica = AlumnosPracticaMateria.objects.get(materiaasignada=materiaasignada,status=True)
                                asistencias = materiaasignada.asistencialeccion_set.all()
                                asistencias.delete()
                                evaluaciones = materiaasignada.evaluacion()
                                evaluaciones.delete()
                                materiaasignada.materia.descontar_cupo_adicional(request)
                                materiaasignada.materia = materia
                                materiaasignada.save(request)
                                materiaasignada.notafinal = 0
                                materiaasignada.fechaasignacion = datetime.now().date()
                                materiaasignada.asistenciafinal = 0
                                materiaasignada.save(request)
                                if matriculacupoadicional:
                                    materia.totalmatriculadocupoadicional += 1
                                    materia.cupo += 1
                                    materia.save(request)
                                    log(
                                        u'Estudiante matriculado en cupo adicional materia: %s - estudiante: %s y se aumento un cupo en materia' % (
                                            materia, materiaasignada.matricula), request, "add")
                                # if estudiantepractica:
                                #     if profesormateria:
                                #         actual = estudiantepractica.profesormateria
                                #         estudiantepractica.profesormateria = profesormateria
                                #         estudiantepractica.grupoprofesor = None
                                #         estudiantepractica.save(request)
                                #         log(u'Cambio de profesor de practica actual(%s) y nuevo(%s)' % (actual, profesormateria), request, "edit")
                                #     elif grupoprofesormateria:
                                #         actual = estudiantepractica.profesormateria
                                #         estudiantepractica.profesormateria = grupoprofesormateria.profesormateria
                                #         estudiantepractica.grupoprofesor = grupoprofesormateria
                                #         estudiantepractica.save(request)
                                #         log(u'Cambio de profesor de practica actual(%s) y nuevo(%s) y se adiciono grupoprofesor(%s)' % (actual, profesormateria, estudiantepractica.grupoprofesor), request, "edit")
                                #     else:
                                #         estudiantepractica.delete()
                                #         log(u'Se elimino porque ya no se va a utilizar: %s - materia asig %s - profesormat %s' % (estudiantepractica.id, estudiantepractica.materiaasignada,estudiantepractica.profesormateria), request, "edit")
                                # else:
                                #     if profesormateria:
                                #         alumnopract = AlumnosPracticaMateria.objects.get(materiaasignada=materiaasignada,status=True)
                                #         alumnopract.save(request)
                                #         log(u'Adiciono alumno a practica %s - [%s-%s]' % (alumnopract.id, alumnopract.materiaasignada, alumnopract.profesormateria), request,"edit")
                                #     elif grupoprofesormateria:
                                #         alumnopractica = AlumnosPracticaMateria(materiaasignada=materiaasignada,
                                #                                                 profesormateria=grupoprofesormateria.profesormateria,
                                #                                                 grupoprofesor=grupoprofesormateria)
                                #         alumnopractica.save(request)
                                #         log(u'Materia (%s) con grupo profesor practica (%s) seleccionada matricula: %s en tabla alumnopractica (%s) cambio de paralelo a la materia' % (materia, grupoprofesormateria, materiaasignada, alumnopractica.id), request,"add")

                                # if materia.asignaturamalla.malla.carrera.modalidad != 3:
                                #     conflicto = materiaasignada.matricula.verificar_conflicto_en_materias()
                                #     if conflicto:
                                #         transaction.set_rollback(True)
                                #         return JsonResponse({"result": "bad", "mensaje": conflicto})

                                materiaasignada.asistencias()
                                materiaasignada.evaluacion()
                                materiaasignada.mis_planificaciones()
                                materiaasignada.matricula.actualizar_horas_creditos()
                                # materiaasignada.matricula.agregacion_aux(request)
                                # materiaasignada.matricula.calcula_nivel()
                                log(u'Cambio seccion materia: %s' % materiaasignada, request, "del")

                            # log(u'Modifico paralelo a estudiante: %s' % maa, request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'dividirparalelomateria':
            try:
                materiaseleccionada = Materia.objects.get(pk=request.POST['idmateria'])
                f = MateriaParaleloForm(request.POST)
                if f.is_valid():
                    if materiaseleccionada.cerrado:
                        return JsonResponse({"result": "bad", "mensaje": u"La materia se encuentra cerrada."})
                    nivel = materiaseleccionada.nivel
                    nivelmalla = materiaseleccionada.asignaturamalla.nivelmalla
                    malla = materiaseleccionada.asignaturamalla.malla
                    maas = materiaseleccionada.asignados_a_esta_materia_rango(f.cleaned_data['valor'])
                    for matricula in maas:
                        for materiaasignada in MateriaAsignada.objects.filter(status=True,
                                                                              matricula=matricula.matricula,
                                                                              materia=materiaseleccionada):
                            asignaturamalla = materiaasignada.materia.asignaturamalla
                            for materia in Materia.objects.filter(asignaturamalla=asignaturamalla,
                                                                  paralelomateria=f.cleaned_data['paralelo'],
                                                                  nivel=nivel, asignaturamalla__nivelmalla=nivelmalla,
                                                                  asignaturamalla__malla=malla,
                                                                  asignaturamalla__status=True, status=True).distinct():
                                msel = MateriaAsignada.objects.filter(status=True, matricula=matricula.matricula,
                                                                      materia=materia)
                                if msel:
                                    msel.delete()
                                profesormateria = None
                                matriculacupoadicional = False
                                estudiantepractica = None
                                grupoprofesormateria = None
                                # if materia.asignaturamalla.practicas:
                                #     return JsonResponse({"result": "bad", "mensaje": u"Esta opción no mes para materias prácticas"})
                                # if materiaasignada.materia.asignaturamalla.malla.carrera.id.__str__() in variable_valor('LISTA_CARRERA_PARA_MATRICULA_GRUPO_PRACTICA'):
                                #     if not int(request.POST['idp']) > 0:
                                #         return JsonResponse({"result": "bad", "mensaje": u"Seleccione un horario de prácticas."})
                                #     else:
                                #         profesormateria = ProfesorMateria.objects.get(pk=int(request.POST['idp']),materia=materia)
                                #         if not int(request.POST['idg']) > 0 and profesormateria.grupoprofesormateria():
                                #             return JsonResponse({"result": "bad", "mensaje": u"Seleccione un horario de prácticas."})
                                #         else:
                                #             if profesormateria.grupoprofesormateria():
                                #                 grupoprofesormateria = GruposProfesorMateria.objects.get(pk=int(request.POST['idg']), profesormateria__materia=materia,profesormateria=profesormateria)
                                #                 profesormateria = None
                                if MATRICULACION_LIBRE:
                                    if not materia.tiene_capacidad():
                                        if materia.cupoadicional > 0:
                                            if not materia.existen_cupos_con_adicional():
                                                return JsonResponse({"result": "bad",
                                                                     "mensaje": u"No existe cupo adicional para esta materia"})
                                            else:
                                                matriculacupoadicional = True
                                        else:
                                            return JsonResponse(
                                                {"result": "bad", "mensaje": u"No existe cupo para esta materia"})
                                    # if grupoprofesormateria:
                                    #     if not grupoprofesormateria.cuposdisponiblesgrupoprofesor() > 0:
                                    #         return JsonResponse({"result": "bad", "mensaje": u"No existe cupo para en la práctica"})
                                # if AlumnosPracticaMateria.objects.values('id').filter(materiaasignada=materiaasignada).exists():
                                #     return JsonResponse({"result": "bad", "mensaje": u"Esta opción no mes para materias prácticas"})
                                # estudiantepractica = AlumnosPracticaMateria.objects.get(materiaasignada=materiaasignada,status=True)
                                asistencias = materiaasignada.asistencialeccion_set.all()
                                asistencias.delete()
                                evaluaciones = materiaasignada.evaluacion()
                                evaluaciones.delete()
                                materiaasignada.materia.descontar_cupo_adicional(request)
                                materiaasignada.materia = materia
                                materiaasignada.save(request)
                                materiaasignada.notafinal = 0
                                materiaasignada.fechaasignacion = datetime.now().date()
                                materiaasignada.asistenciafinal = 0
                                materiaasignada.save(request)
                                if matriculacupoadicional:
                                    materia.totalmatriculadocupoadicional += 1
                                    materia.cupo += 1
                                    materia.save(request)
                                    log(
                                        u'Estudiante matriculado en cupo adicional materia: %s - estudiante: %s y se aumento un cupo en materia' % (
                                            materia, materiaasignada.matricula), request, "add")
                                # if estudiantepractica:
                                #     if profesormateria:
                                #         actual = estudiantepractica.profesormateria
                                #         estudiantepractica.profesormateria = profesormateria
                                #         estudiantepractica.grupoprofesor = None
                                #         estudiantepractica.save(request)
                                #         log(u'Cambio de profesor de practica actual(%s) y nuevo(%s)' % (actual, profesormateria), request, "edit")
                                #     elif grupoprofesormateria:
                                #         actual = estudiantepractica.profesormateria
                                #         estudiantepractica.profesormateria = grupoprofesormateria.profesormateria
                                #         estudiantepractica.grupoprofesor = grupoprofesormateria
                                #         estudiantepractica.save(request)
                                #         log(u'Cambio de profesor de practica actual(%s) y nuevo(%s) y se adiciono grupoprofesor(%s)' % (actual, profesormateria, estudiantepractica.grupoprofesor), request, "edit")
                                #     else:
                                #         estudiantepractica.delete()
                                #         log(u'Se elimino porque ya no se va a utilizar: %s - materia asig %s - profesormat %s' % (estudiantepractica.id, estudiantepractica.materiaasignada,estudiantepractica.profesormateria), request, "edit")
                                # else:
                                #     if profesormateria:
                                #         alumnopract = AlumnosPracticaMateria.objects.get(materiaasignada=materiaasignada,status=True)
                                #         alumnopract.save(request)
                                #         log(u'Adiciono alumno a practica %s - [%s-%s]' % (alumnopract.id, alumnopract.materiaasignada, alumnopract.profesormateria), request,"edit")
                                #     elif grupoprofesormateria:
                                #         alumnopractica = AlumnosPracticaMateria(materiaasignada=materiaasignada,
                                #                                                 profesormateria=grupoprofesormateria.profesormateria,
                                #                                                 grupoprofesor=grupoprofesormateria)
                                #         alumnopractica.save(request)
                                #         log(u'Materia (%s) con grupo profesor practica (%s) seleccionada matricula: %s en tabla alumnopractica (%s) cambio de paralelo a la materia' % (materia, grupoprofesormateria, materiaasignada, alumnopractica.id), request,"add")

                                # if materia.asignaturamalla.malla.carrera.modalidad != 3:
                                #     conflicto = materiaasignada.matricula.verificar_conflicto_en_materias()
                                #     if conflicto:
                                #         transaction.set_rollback(True)
                                #         return JsonResponse({"result": "bad", "mensaje": conflicto})

                                materiaasignada.asistencias()
                                materiaasignada.evaluacion()
                                materiaasignada.mis_planificaciones()
                                materiaasignada.matricula.actualizar_horas_creditos()
                                # materiaasignada.matricula.agregacion_aux(request)
                                # materiaasignada.matricula.calcula_nivel()
                                log(u'Cambio seccion materia: %s' % materiaasignada, request, "del")

                            # log(u'Modifico paralelo a estudiante: %s' % maa, request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})


        elif action == 'asignar_estudiante_materias_otro_paralelo':
            try:
                materiaseleccionada = Materia.objects.get(pk=request.POST['idmateria'])
                f = MateriaParalelo2Form(request.POST)
                if f.is_valid():
                    if materiaseleccionada.cerrado:
                        return JsonResponse({"result": "bad", "mensaje": u"La materia se encuentra cerrada."})
                    nivelmalla = materiaseleccionada.asignaturamalla.nivelmalla
                    malla = materiaseleccionada.asignaturamalla.malla
                    for ma_id in request.POST.getlist('ins'):
                        materiaasignada_form = MateriaAsignada.objects.get(pk=ma_id)
                        matricula_estudiante = Matricula.objects.get(id=materiaasignada_form.matricula_id)
                        materias_nuevas = Materia.objects.filter(paralelomateria=f.cleaned_data['paralelo'],
                                                                 asignaturamalla__nivelmalla=nivelmalla,
                                                                 nivel=f.cleaned_data['nivel'],
                                                                 asignaturamalla__malla=malla, nivel__periodo=periodo,
                                                                 asignaturamalla__status=True, status=True)
                        if materias_nuevas:
                            MateriaAsignada.objects.filter(status=True, matricula=matricula_estudiante).delete()
                        else:
                            return JsonResponse({"result": "bad", "mensaje": u"No existen datos para el paralelo y nivel seleccionado."})
                        for materia in materias_nuevas:
                            if not MateriaAsignada.objects.filter(status=True, matricula=matricula_estudiante, materia=materia).exists():
                                materiaasignada = MateriaAsignada(matricula=matricula_estudiante,
                                                                  materia=materia,
                                                                  notafinal=0,
                                                                  asistenciafinal=0,
                                                                  cerrado=False,
                                                                  observaciones='',
                                                                  estado_id=NOTA_ESTADO_EN_CURSO)
                                materiaasignada.save(request)
                                materiaasignada.matriculas = materiaasignada.cantidad_matriculas()
                                materiaasignada.asistencias()
                                materiaasignada.evaluacion()
                                materiaasignada.mis_planificaciones()
                                materiaasignada.matricula.actualizar_horas_creditos()
                                materiaasignada.save(request)
                                profesormateria = None
                                matriculacupoadicional = False
                                estudiantepractica = None
                                grupoprofesormateria = None

                                if MATRICULACION_LIBRE:
                                    if not materia.tiene_capacidad():
                                        if materia.cupoadicional > 0:
                                            if not materia.existen_cupos_con_adicional():
                                                return JsonResponse({"result": "bad",
                                                                     "mensaje": u"No existe cupo adicional para esta materia"})
                                            else:
                                                matriculacupoadicional = True
                                        else:
                                            return JsonResponse(
                                                {"result": "bad", "mensaje": u"No existe cupo para esta materia"})
                                if matriculacupoadicional:
                                    materia.totalmatriculadocupoadicional += 1
                                    materia.cupo += 1
                                    materia.save(request)
                                    log(u'Estudiante matriculado en cupo adicional materia: %s - estudiante: %s y se aumento un cupo en materia' % (
                                        materia, materiaasignada.matricula), request, "add")
                                log(u'Cambio seccion materia: %s' % materiaasignada, request, "del")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})


        elif action == 'vaciarcalificaciones':
            try:
                materia = Materia.objects.get(pk=request.POST['id'])
                if materia.cerrado:
                    return JsonResponse({"result": "bad", "mensaje": u"La materia se encuentra cerrada."})
                if (datetime(materia.inicio.year, materia.inicio.month, materia.inicio.day, 0, 0, 0) + timedelta(
                        days=15)).date() <= datetime.now().date():
                    return JsonResponse({"result": "bad", "mensaje": u"No se pueden eliminar las calificaciones."})
                EvaluacionGenerica.objects.filter(materiaasignada__materia=materia).update(valor=0)
                for asignado in materia.asignados_a_esta_materia():
                    if not asignado.convalidada() and not asignado.homologada():
                        asignado.notafinal = 0
                        asignado.save(request)
                log(u'Elimino calificaciones de materia: %s' % materia, request, "edit")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'delallmateria':
            try:
                nivel = Nivel.objects.get(pk=request.POST['id'])
                for materia in nivel.materia_set.filter(status=True):
                    if not materia.cerrado:
                        log(u'Elimino materia, por masivo: %s' % materia, request, "edit")
                        materia.delete()
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'diasacalificar':
            try:
                materia = Materia.objects.get(pk=request.POST['id'])
                form = CalificacionDiaForm(request.POST)
                if form.is_valid():
                    materia.usaperiodocalificaciones = form.cleaned_data['usaperiodocalificaciones']
                    materia.diasactivacioncalificaciones = form.cleaned_data['diasactivacioncalificaciones'] if not \
                        form.cleaned_data['usaperiodocalificaciones'] else 1
                    materia.save(request)
                    log(u'Cambio en fecha de calificaciones de materia: %s' % materia, request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'laboratorios':
            try:
                materia = Materia.objects.get(pk=request.POST['id'])
                form = LaboratorioForm(request.POST)
                if form.is_valid():
                    materia.laboratorio = form.cleaned_data['laboratorio']
                    materia.save(request)
                    log(u'Asigno Laboratorio a la materia: %s' % materia, request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'diasaevaluar':
            try:
                materia = Materia.objects.get(pk=request.POST['id'])
                form = EvaluacionDiaForm(request.POST)
                if form.is_valid():
                    materia.usaperiodoevaluacion = form.cleaned_data['usaperiodoevaluacion']
                    materia.diasactivacion = form.cleaned_data['diasactivacion'] if not form.cleaned_data[
                        'usaperiodoevaluacion'] else 1
                    materia.save(request)
                    log(u'Cambio en fecha de evaluaciones de materia: %s' % materia, request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'fechaasistencias':
            try:
                materia = Materia.objects.get(pk=request.POST['id'])
                form = FechafinAsistenciasForm(request.POST)
                if form.is_valid():
                    materia.fechafinasistencias = form.cleaned_data['fecha']
                    materia.save(request)
                    materia.recalcularmateria()
                    log(u'Cambio fecha fin de asistencias de materia: %s' % materia, request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'precierrem':
            try:
                nivel = Nivel.objects.get(pk=request.POST['nid'])
                materias = []
                for materia in nivel.materia_set.values("id", "asignatura__nombre", "paralelo").filter(status=True,
                                                                                                       cerrado=False):
                    mo = {'nombre': "%s %s" % (materia.get("asignatura__nombre"), materia.get("paralelo")),
                          'id': materia.get("id")}
                    materias.append(mo)
                return JsonResponse({"result": "ok", "cantidad": len(materias), "materias": materias})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al generar lista de precierre"})

        # elif action == 'presacarestudianteslimpios':
        #     try:
        #         periodo = Periodo.objects.get(pk=request.POST['idp'])
        #         materias = []
        #         for matricula in Matricula.objects.filter(nivel__periodo=periodo, status=True):
        #             mo = {'nombre': unicode(matricula.inscripcion.persona.nombre_completo()), 'id': matricula.id}
        #             materias.append(mo)
        #         return JsonResponse({"result": "ok", "cantidad": len(materias), "materias": materias})
        #     except Exception as ex:
        #         return JsonResponse({"result": "bad", "mensaje": u"Error al generar lista de precierre"})
        #
        elif action == 'bloqueohorarios':
            try:
                nivel = Nivel.objects.get(pk=request.POST['id'])
                extension = nivel.extension()
                extension.visible = True if request.POST['val'] == 'y' else False
                extension.save(request)
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad"})

        elif action == 'duplicarsilabo':
            try:
                lista = []
                materia = Materia.objects.get(pk=request.POST['codigomateria'])
                silabocab = materia.silabo_actual()
                listamaterias = Materia.objects.filter(status=True, nivel__periodo=materia.nivel.periodo,
                                                       asignatura=materia.asignatura,
                                                       asignaturamalla__malla__carrera=materia.asignaturamalla.malla.carrera).exclude(
                    pk=materia.id)
                for listamat in listamaterias:
                    if not Silabo.objects.filter(materia=listamat):
                        silabo = Silabo(materia=listamat,
                                        profesor_id=522,
                                        programaanaliticoasignatura=silabocab.programaanaliticoasignatura)
                        silabo.save(request)

                    else:
                        silabo = Silabo.objects.get(materia=listamat)
                        silabo.profesor = listamat.profesor_principal()
                        silabo.save(request)
                    lista.append(u'%s' % listamat)
                    if PlanificacionClaseSilabo.objects.filter(
                            tipoplanificacion__planificacionclasesilabo_materia__materia=listamat,
                            status=True).exists():
                        for listasemanal in PlanificacionClaseSilabo.objects.filter(
                                tipoplanificacion__planificacionclasesilabo_materia__materia=listamat,
                                status=True).exclude(semana=0).order_by('orden'):
                            semana = None
                            idcodigo = 0

                            if silabocab.silabosemanal_set.filter(fechainiciosemana__gte=listasemanal.fechainicio,
                                                                  fechafinciosemana__lte=listasemanal.fechafin).exists():
                                lissemana = \
                                    silabocab.silabosemanal_set.filter(fechainiciosemana__gte=listasemanal.fechainicio,
                                                                       fechafinciosemana__lte=listasemanal.fechafin)[0]
                                if lissemana:
                                    if not silabo.silabosemanal_set.filter(numsemana=listasemanal.semana).exists():
                                        silabosemana = SilaboSemanal(silabo=silabo,
                                                                     numsemana=listasemanal.semana,
                                                                     semana=listasemanal.fechainicio.isocalendar()[1],
                                                                     fechainiciosemana=listasemanal.fechainicio,
                                                                     fechafinciosemana=listasemanal.fechafin,
                                                                     objetivoaprendizaje='',
                                                                     enfoque='',
                                                                     recursos='',
                                                                     evaluacion=''
                                                                     )
                                        silabosemana.save(request)
                                        if lissemana.detallesilabosemanaltema_set.filter(status=True).exists():
                                            if lissemana.detallesilabosemanaltema_set.filter(status=True,
                                                                                             temaunidadresultadoprogramaanalitico__status=True).exists():
                                                for itemtema in lissemana.detallesilabosemanaltema_set.filter(
                                                        status=True, temaunidadresultadoprogramaanalitico__status=True):
                                                    tema = DetalleSilaboSemanalTema(silabosemanal=silabosemana,
                                                                                    temaunidadresultadoprogramaanalitico=itemtema.temaunidadresultadoprogramaanalitico,
                                                                                    status=True)
                                                    tema.save(request)

                                        if lissemana.detallesilabosemanalsubtema_set.filter(status=True).exists():
                                            if lissemana.detallesilabosemanalsubtema_set.filter(status=True,
                                                                                                subtemaunidadresultadoprogramaanalitico__status=True).exists():
                                                for itemsubtema in lissemana.detallesilabosemanalsubtema_set.filter(
                                                        status=True,
                                                        subtemaunidadresultadoprogramaanalitico__status=True):
                                                    subtema = DetalleSilaboSemanalSubtema(silabosemanal=silabosemana,
                                                                                          subtemaunidadresultadoprogramaanalitico=itemsubtema.subtemaunidadresultadoprogramaanalitico,
                                                                                          status=True)
                                                    subtema.save(request)

                                        if lissemana.virtualactividadessilabo_set.filter(status=True).exists():
                                            if lissemana.virtualactividadessilabo_set.filter(status=True).exists():
                                                for itemactiva in lissemana.virtualactividadessilabo_set.filter(
                                                        status=True):
                                                    actividad = VirtualActividadesSilabo(silabosemanal=silabosemana,
                                                                                         subtema=itemactiva.subtema,
                                                                                         nombre=itemactiva.nombre,
                                                                                         descripcion=itemactiva.descripcion,
                                                                                         status=True)
                                                    actividad.save(request)

                                        if lissemana.virtualcasospracticossilabo_set.filter(status=True).exists():
                                            if lissemana.virtualcasospracticossilabo_set.filter(status=True).exists():
                                                for itemacaso in lissemana.virtualcasospracticossilabo_set.filter(
                                                        status=True):
                                                    esperiencia = VirtualCasosPracticosSilabo(
                                                        silabosemanal=silabosemana, subtema=itemacaso.subtema,
                                                        nombre=itemacaso.nombre, descripcion=itemacaso.descripcion,
                                                        link=itemacaso.link, tipolink=itemacaso.tipolink, status=True)
                                                    esperiencia.save(request)

                                        if lissemana.virtuallecturassilabo_set.filter(status=True).exists():
                                            if lissemana.virtuallecturassilabo_set.filter(status=True).exists():
                                                for itemalectura in lissemana.virtuallecturassilabo_set.filter(
                                                        status=True):
                                                    lectura = VirtualLecturasSilabo(silabosemanal=silabosemana,
                                                                                    subtema=itemalectura.subtema,
                                                                                    nombre=itemalectura.nombre,
                                                                                    descripcion=itemalectura.descripcion,
                                                                                    link=itemalectura.link,
                                                                                    tipolink=itemalectura.tipolink,
                                                                                    status=True)
                                                    lectura.save(request)

                                        if lissemana.virtualmasrecursosilabo_set.filter(status=True).exists():
                                            if lissemana.virtualmasrecursosilabo_set.filter(status=True).exists():
                                                for itemarecurso in lissemana.virtualmasrecursosilabo_set.filter(
                                                        status=True):
                                                    recursos = VirtualMasRecursoSilabo(silabosemanal=silabosemana,
                                                                                       subtema=itemarecurso.subtema,
                                                                                       nombre=itemarecurso.nombre,
                                                                                       descripcion=itemarecurso.descripcion,
                                                                                       link=itemarecurso.link,
                                                                                       tiporecurso=itemarecurso.tiporecurso,
                                                                                       status=True)
                                                    recursos.save(request)

                                        if lissemana.virtualpresencialsilabo_set.filter(status=True).exists():
                                            if lissemana.virtualpresencialsilabo_set.filter(status=True).exists():
                                                for itemapresencial in lissemana.virtualpresencialsilabo_set.filter(
                                                        status=True):
                                                    presencial = VirtualPresencialSilabo(silabosemanal=silabosemana,
                                                                                         subtema=itemapresencial.subtema,
                                                                                         descripcion=itemapresencial.descripcion,
                                                                                         link=itemapresencial.link,
                                                                                         status=True)
                                                    presencial.save(request)

                                        if lissemana.virtualtestsilabo_set.filter(status=True).exists():
                                            if lissemana.virtualtestsilabo_set.filter(status=True).exists():
                                                for itematest in lissemana.virtualtestsilabo_set.filter(status=True):
                                                    test = VirtualTestSilabo(silabosemanal=silabosemana,
                                                                             subtema=itematest.subtema,
                                                                             descripcion=itematest.descripcion,
                                                                             link=itematest.link, status=True)
                                                    test.save(request)

                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad"})

        elif action == 'lista_amterias':
            try:
                materia = Materia.objects.get(pk=int(encrypt(request.POST['id'])))
                # carrerasid = Materia.objects.values_list('asignaturamalla__malla__carrera_id', flat=True).filter(Q(nivel__sesion__id=13), Q(nivel__periodo=periodo), Q(asignatura=materia.asignatura), Q(asignaturamalla__malla__carrera__modalidad=3)).exclude(pk=int(encrypt(request.POST['id']))).distinct()
                carrerasid = Materia.objects.values_list('asignaturamalla__malla__carrera_id', flat=True).filter(
                    Q(nivel__sesion__id=13) | Q(nivel__sesion__id=12), Q(nivel__periodo=periodo),
                    Q(asignatura=materia.asignatura) | Q(asignaturamalla__malla__carrera__modalidad=3), Q(status=True)).exclude(
                    pk=int(encrypt(request.POST['id']))).distinct()

                lista = []
                for car in Carrera.objects.filter(id__in=carrerasid):
                    datadoc = {}
                    datadoc['id'] = car.id
                    # datadoc['descripcion'] = u'%s - %s' % (mat.asignatura.nombre, mat.paralelo)
                    datadoc['carrera'] = car.nombre
                    # datadoc['nivel'] = mat.asignaturamalla.nivelmalla.nombre
                    lista.append(datadoc)

                # for mat in materias:
                #     datadoc = {}
                #     datadoc['id'] = mat.id
                #     datadoc['descripcion'] = u'%s - %s' % (mat.asignatura.nombre, mat.paralelo)
                #     datadoc['carrera'] = mat.asignaturamalla.malla.carrera.nombre
                #     datadoc['nivel'] = mat.asignaturamalla.nivelmalla.nombre
                #     lista.append(datadoc)
                # lista.append([mat.id, u'%s - %s' % (mat.asignatura.nombre, mat.paralelo), mat.asignaturamalla.malla.carrera.nombre, mat.asignaturamalla.nivelmalla.nombre])
                return JsonResponse({'result': 'ok', 'lista': lista, 'materia': 'COPIAR ' + materia.asignatura.nombre})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos."})

        elif action == 'duplicarsilabo_completo':
            try:
                lista = []
                materia = Materia.objects.get(pk=int(encrypt(request.POST['idmat'])))
                listacarrerasid = request.POST['listacarreras'].split(':')
                listasilabo = []
                if listacarrerasid:
                    for item in listacarrerasid:
                        listasilabo.append(int(item))
                    materia.duplicar_silabo(request, listasilabo)
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos. %s" % ex})

        elif action == 'bloqueocupos':
            try:
                nivel = Nivel.objects.get(pk=request.POST['id'])
                extension = nivel.extension()
                extension.puedematricular = True if request.POST['val'] == 'y' else False
                extension.save(request)
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad"})

        elif action == 'modificar_visibledistributivomateria':
            try:
                nivel = Nivel.objects.get(pk=request.POST['id'])
                nivel.visibledistributivomateria = True if request.POST['val'] == 'y' else False
                nivel.save(request)
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad"})

        elif action == 'bloqueoprofesor':
            try:
                nivel = Nivel.objects.get(pk=request.POST['id'])
                extension = nivel.extension()
                extension.modificardocente = True if request.POST['val'] == 'y' else False
                extension.save(request)
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad"})

        elif action == 'cierrema':
            try:
                ma = MateriaAsignada.objects.get(pk=request.POST['maid'])
                if not ma.cerrado:
                    ma.cierre_materia_asignada()
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad"})

        elif action == 'cierremag':
            try:
                materia = Materia.objects.get(pk=request.POST['maid'])
                if not materia.cerrado:
                    for asig in materia.asignados_a_esta_materia():
                        if not asig.cerrado:
                            asig.cerrado = True
                            asig.save(request, actualiza=False)
                            asig.actualiza_estado()
                            asig.cierre_materia_asignada()
                materia.cerrado = True
                materia.fechacierre = datetime.now().date()
                materia.save(request)
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad"})

        elif action == 'eliminaractividad':
            try:
                idcodigoopcion = request.POST['idcodigoopcion']
                if idcodigoopcion == '1':
                    actividad = VirtualActividadesSilabo.objects.get(pk=int(encrypt(request.POST['iddelactividad'])))
                    actividad.delete()
                if idcodigoopcion == '2':
                    caso = VirtualCasosPracticosSilabo.objects.get(pk=int(encrypt(request.POST['iddelactividad'])))
                    caso.delete()
                if idcodigoopcion == '3':
                    lectura = VirtualLecturasSilabo.objects.get(pk=int(encrypt(request.POST['iddelactividad'])))
                    lectura.delete()
                if idcodigoopcion == '4':
                    masrecurso = VirtualMasRecursoSilabo.objects.get(pk=int(encrypt(request.POST['iddelactividad'])))
                    masrecurso.delete()
                if idcodigoopcion == '5':
                    presencial = VirtualPresencialSilabo.objects.get(pk=int(encrypt(request.POST['iddelactividad'])))
                    presencial.delete()
                if idcodigoopcion == '6':
                    test = VirtualTestSilabo.objects.get(pk=int(encrypt(request.POST['iddelactividad'])))
                    test.delete()
                if idcodigoopcion == '7':
                    silabosemanal = SilaboSemanal.objects.get(pk=int(encrypt(request.POST['iddelactividad'])))
                    silabosemanal.status=False
                    silabosemanal.save(request)
                    log(u'Eliminó silabo semanal: %s' % silabosemanal.id, request, "add")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad"})

        elif action == 'cierren':
            try:
                nivel = Nivel.objects.get(pk=request.POST['nid'])
                nivel.cerrado = True
                nivel.fechacierre = datetime.now()
                nivel.save(request)
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad"})

        elif action == 'addsemanaplanificacionvirtual':
            try:
                subtema = ''
                tema = ''
                cronograma = ''
                if 'lista_items1' in request.POST:
                    subtema = json.loads(request.POST['lista_items1'])
                if 'lista_items4' in request.POST:
                    tema = json.loads(request.POST['lista_items4'])
                if 'lista_items6' in request.POST:
                    cronograma = json.loads(request.POST['lista_items6'])
                cadena = request.POST['id'].split("_")
                silabo = Silabo.objects.get(pk=int(encrypt(cadena[0])))
                form = SilaboSemanalForm(request.POST)
                # if form.is_valid():
                silabosemana = SilaboSemanal(silabo=silabo,
                                             numsemana=int(encrypt(cadena[4])),
                                             semana=int(encrypt(cadena[1])),
                                             fechainiciosemana=cadena[2],
                                             fechafinciosemana=cadena[3]
                                             )
                silabosemana.save(request)
                if subtema:
                    for subt in subtema:
                        ingresosubt = DetalleSilaboSemanalSubtema(silabosemanal_id=silabosemana.id,
                                                                  subtemaunidadresultadoprogramaanalitico_id=subt)
                        ingresosubt.save(request)
                if tema:
                    for tem in tema:
                        ingresostemas = DetalleSilaboSemanalTema(silabosemanal_id=silabosemana.id,
                                                                 temaunidadresultadoprogramaanalitico_id=tem)
                        ingresostemas.save(request)

                if 'lista_items7' in request.POST:
                    bibliapa = [x['bibliografiaexterna'] for x in json.loads(request.POST['lista_items7'])]
                    for apa in bibliapa:
                        if not BibliograbiaAPASilabo.objects.filter(silabosemanal_id=silabosemana.id,
                                                                    bibliografia=apa).exists():
                            bapa = BibliograbiaAPASilabo(silabosemanal_id=silabosemana.id, bibliografia=apa)
                            bapa.save(request)
                            log(u'Adicionó Bibliografia Apa: %s al sílabo de la materia %s:' % (
                                bapa, bapa.silabosemanal.silabo.materia), request, "add")

                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'addsemanasilaboactividad':
            try:
                silabosemanal = SilaboSemanal.objects.get(pk=int(encrypt(request.POST['id'])))
                f = VirtualActividadesSilaboForm(request.POST)
                if f.is_valid():
                    actividad = VirtualActividadesSilabo(silabosemanal=silabosemanal,
                                                         nombre=f.cleaned_data['nombre'],
                                                         # subtema=f.cleaned_data['subtema'],
                                                         tema=f.cleaned_data['tema'],
                                                         tipoactividad=f.cleaned_data['tipoactividad'],
                                                         descripcion=f.cleaned_data['descripcion'])
                    actividad.save(request)
                    log(u'Adiciono actividad silabo semanal: %s' % actividad, request, "add")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'editsemanasilaboactividad':
            try:
                f = VirtualActividadesSilaboForm(request.POST)
                actividad = VirtualActividadesSilabo.objects.get(pk=request.POST['id'])
                if f.is_valid():
                    actividad.nombre = f.cleaned_data['nombre']
                    actividad.descripcion = f.cleaned_data['descripcion']
                    actividad.tipoactividad = f.cleaned_data['tipoactividad']
                    actividad.tema = f.cleaned_data['tema']
                    actividad.save(request)
                    log(u'Editó actividad silabo semanal virtual: %s' % actividad, request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'addsemanasilabocasopractico':
            try:
                silabosemanal = SilaboSemanal.objects.get(pk=int(encrypt(request.POST['id'])))
                f = VirtualCasosPracticosSilaboForm(request.POST)
                if f.is_valid():
                    casopractico = VirtualCasosPracticosSilabo(silabosemanal=silabosemanal,
                                                               nombre=f.cleaned_data['nombre'],
                                                               tema=f.cleaned_data['tema'],
                                                               # subtema=f.cleaned_data['subtema'],
                                                               descripcion=f.cleaned_data['descripcion'],
                                                               link='',
                                                               tipolink=1
                                                               )
                    casopractico.save(request)
                    log(u'Adiciono caso practico silabo semanal: %s' % casopractico, request, "add")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'subtemascasos':
            try:
                silabosemanal = SilaboSemanalVirtual.objects.get(pk=request.POST['id'])
                subtemas = SubtemaUnidadResultadoProgramaAnalitico.objects.filter(
                    pk__in=DetalleSilaboSemanalVirtualSubtema.objects.values_list(
                        'subtemaunidadresultadoprogramaanalitico_id', flat=True).filter(
                        silabosemanalvirtual=silabosemanal))
                lista = []
                for sub in subtemas:
                    lista.append([sub.id, sub.descripcion])
                return JsonResponse({'result': 'ok', 'lista': lista})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos."})

        elif action == 'editsemanasilabocasopractico':
            try:
                f = VirtualCasosPracticosSilaboForm(request.POST)
                casopractico = VirtualCasosPracticosSilabo.objects.get(pk=request.POST['id'])
                if f.is_valid():
                    casopractico.nombre = f.cleaned_data['nombre']
                    casopractico.descripcion = f.cleaned_data['descripcion']
                    casopractico.link = ''
                    # casopractico.subtema = f.cleaned_data['subtema']
                    casopractico.tema = f.cleaned_data['tema']
                    casopractico.tipolink = 1
                    casopractico.save(request)
                    log(u'Editó caso practico silabo semanal virtual: %s' % casopractico, request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'addsemanasilabolecturas':
            try:
                silabosemanal = SilaboSemanal.objects.get(pk=int(encrypt(request.POST['id'])))
                f = VirtualLecturasSilaboForm(request.POST)
                if f.is_valid():
                    casopractico = VirtualLecturasSilabo(silabosemanal=silabosemanal,
                                                         nombre=f.cleaned_data['nombre'],
                                                         descripcion=f.cleaned_data['descripcion'],
                                                         link='',
                                                         # subtema=f.cleaned_data['subtema'],
                                                         tema=f.cleaned_data['tema'],
                                                         tipolink=1
                                                         )
                    casopractico.save(request)
                    log(u'Adiciono caso practico silabo semanal: %s' % casopractico, request, "add")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'editsemanasilabolecturas':
            try:
                f = VirtualLecturasSilaboForm(request.POST)
                lectura = VirtualLecturasSilabo.objects.get(pk=request.POST['id'])
                if f.is_valid():
                    lectura.nombre = f.cleaned_data['nombre']
                    lectura.descripcion = f.cleaned_data['descripcion']
                    lectura.tema = f.cleaned_data['tema']
                    lectura.link = ''
                    lectura.tipolink = 1
                    lectura.save(request)
                    log(u'Editó lectura silabo semanal virtual: %s' % lectura, request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'addsemanasilaborecurso':
            try:
                silabosemanal = SilaboSemanal.objects.get(pk=int(encrypt(request.POST['id'])))
                f = VirtualRecursoSilaboForm(request.POST)
                if f.is_valid():
                    recurso = VirtualMasRecursoSilabo(silabosemanal=silabosemanal,
                                                      nombre=f.cleaned_data['nombre'],
                                                      descripcion=f.cleaned_data['descripcion'],
                                                      tema=f.cleaned_data['tema'],
                                                      link='',
                                                      tiporecurso=f.cleaned_data['tiporecurso']
                                                      )
                    recurso.save(request)
                    log(u'Adiciono mas recurso silabo semanal: %s' % recurso, request, "add")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'editsemanasilaborecurso':
            try:
                f = VirtualRecursoSilaboForm(request.POST)
                recurso = VirtualMasRecursoSilabo.objects.get(pk=request.POST['id'])
                if f.is_valid():
                    recurso.nombre = f.cleaned_data['nombre']
                    recurso.descripcion = f.cleaned_data['descripcion']
                    recurso.link = ''
                    recurso.tema = f.cleaned_data['tema']
                    recurso.tiporecurso = f.cleaned_data['tiporecurso']
                    recurso.save(request)
                    log(u'Editó recursoo silabo semanal virtual: %s' % recurso, request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'addsemanasilabotest':
            try:
                silabosemanal = SilaboSemanal.objects.get(pk=int(encrypt(request.POST['id'])))
                f = VirtualTestSilaboForm(request.POST)
                if f.is_valid():
                    test = VirtualTestSilabo(silabosemanal=silabosemanal,
                                             descripcion=f.cleaned_data['descripcion'],
                                             tema=f.cleaned_data['tema'],
                                             link=f.cleaned_data['link']
                                             )
                    test.save(request)
                    log(u'Adiciono test virtual silabo semanal: %s' % test, request, "add")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'editsemanasilabotest':
            try:
                f = VirtualTestSilaboForm(request.POST)
                test = VirtualTestSilabo.objects.get(pk=request.POST['id'])
                if f.is_valid():
                    test.descripcion = f.cleaned_data['descripcion']
                    test.link = f.cleaned_data['link']
                    test.tema = f.cleaned_data['tema']
                    test.save(request)
                    log(u'Editó test silabo semanal virtual: %s' % test, request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'addsemanasilabopresencial':
            try:
                silabosemanal = SilaboSemanal.objects.get(pk=int(encrypt(request.POST['id'])))
                f = VirtualPresencialSilaboForm(request.POST)
                if f.is_valid():
                    presencial = VirtualPresencialSilabo(silabosemanal=silabosemanal,
                                                         descripcion=f.cleaned_data['descripcion'],
                                                         tema=f.cleaned_data['tema'],
                                                         link=f.cleaned_data['link']
                                                         )
                    presencial.save(request)
                    log(u'Adiciono caso presencial virtual silabo semanal: %s' % presencial, request, "add")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'editsemanasilabopresencial':
            try:
                f = VirtualPresencialSilaboForm(request.POST)
                presencial = VirtualPresencialSilabo.objects.get(pk=request.POST['id'])
                if f.is_valid():
                    presencial.descripcion = f.cleaned_data['descripcion']
                    presencial.link = f.cleaned_data['link']
                    presencial.tema = f.cleaned_data['tema']
                    presencial.save(request)
                    log(u'Editó presencial silabo semanal virtual: %s' % presencial, request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'infoasignatura':
            try:
                if MATRICULACION_LIBRE:
                    asignaturamalla = AsignaturaMalla.objects.get(pk=request.POST['aid'])
                    return JsonResponse(
                        {'result': 'ok', 'creditos': asignaturamalla.creditos, 'codigo': asignaturamalla.identificacion,
                         'horas': asignaturamalla.horas,
                         'horassemanales': int(asignaturamalla.horaspresencialessemanales) + int(
                             asignaturamalla.horaspracticassemanales), 'malla': 'si'})
                else:
                    asignatura = Asignatura.objects.get(pk=request.POST['aid'])
                    return JsonResponse({'result': 'ok', 'creditos': asignatura.creditos, 'codigo': asignatura.codigo,
                                         'horas': asignatura.creditos * 16, 'horassemanales': 0, 'malla': 'si'})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos."})

        elif action == 'alumnospractica':
            try:
                profesormateria = ProfesorMateria.objects.get(pk=request.POST['id'])
                seleccionados = MateriaAsignada.objects.filter(id__in=[int(x) for x in request.POST['listamaterias'].split(',')])
                for materiaasignada in profesormateria.materia.asignados_a_esta_materia():
                    if materiaasignada.alumnospracticamateria_set.exists():
                        participantepractica = materiaasignada.alumnospracticamateria_set.all()[0]
                        # if materiaasignada in seleccionados:
                        participantepractica.profesormateria = profesormateria
                        participantepractica.save(request)
                        # else:
                        #     if participantepractica.profesormateria == profesormateria:
                        #         participantepractica.delete()
                    else:
                        # if materiaasignada in seleccionados:
                        participantepractica = AlumnosPracticaMateria(materiaasignada=materiaasignada,
                                                                      profesormateria=profesormateria)
                        participantepractica.save(request)
                log(u'Establecio alumnos de practica: %s' % profesormateria.materia, request, "add")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'designargrupopractica':
            try:
                alumnopractica = AlumnosPracticaMateria.objects.get(pk=int(encrypt(request.POST['idm'])))
                log(u'Elimino estudiante de practica : profemate (%s), materiaasignada (%s)' % (
                    alumnopractica.profesormateria, alumnopractica.materiaasignada), request, "add")
                alumnopractica.delete()
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'asignargrupopractica':
            try:
                profesormateria = ProfesorMateria.objects.get(pk=request.POST['id'])
                materiaasignadaalumno = MateriaAsignada.objects.get(id=int(encrypt(request.POST['idm'])))
                materias = Materia.objects.filter(id__in=materiaasignadaalumno.matricula.materiaasignada_set.values_list('materia__id').filter(sinasistencia=False), status=True)
                alumnaspracticascongrupo = AlumnosPracticaMateria.objects.values_list('profesormateria__id', 'grupoprofesor__id').filter(materiaasignada__materia__id__in=materias.values_list('id'), materiaasignada__matricula=materiaasignadaalumno.matricula, grupoprofesor__isnull=False)
                # conflicto = conflicto_materias_estudiante(materias=materias, lista_pm_grupo=alumnaspracticascongrupo)
                # data['tieneconflicto'] = conflicto
                data['materiaasignada'] = materiaasignadaalumno
                data['profesormateria'] = profesormateria
                template = get_template("niveles/seleccionpracticas.html")
                json_content = template.render(data)
                return JsonResponse({"result": "ok", 'datos': json_content})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos."})

        elif action == 'conflictohorario':
            try:
                mispracticas = json.loads(request.POST['mispracticas'])
                matricula = Matricula.objects.get(pk=int(encrypt(request.POST['idma'])))
                # conflicto = conflicto_estudiante_conpracticas_seleccionadas(matricula, mispracticas)
                # if conflicto:
                #     return JsonResponse({"result": "bad", "mensaje": conflicto})
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                return JsonResponse({"result": "bad", 'mensaje': u'Error al verificar conflicto de horario.'})

        elif action == 'matricularpracticas':
            try:
                matricula = Matricula.objects.get(pk=int(encrypt(request.POST['idma'])))
                return matricular_estudiante_enpracticas(request, matricula, json.loads(request.POST['mispracticas']))
            except Exception as ex:
                return JsonResponse({"result": "bad", 'mensaje': u'Error al matricular estudiante.'})

        elif action == 'matricularpracticasmasivo':
            try:
                materia = Materia.objects.get(pk=request.POST['idm'])
                materiasasignadas = materia.asignados_a_esta_materia()
                for materiaaasignada in materiasasignadas:
                    matricular_estudiante_enpracticas_masivo(request, materiaaasignada.matricula,
                                                             json.loads(request.POST['mispracticas']), materiaaasignada)
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                return JsonResponse({"result": "bad", 'mensaje': u'Error al matricular estudiante.'})

        elif action == 'adicionar_silabovirtual':
            try:
                materia = Materia.objects.get(pk=int(request.POST['idm']))
                programa = ProgramaAnaliticoAsignatura.objects.get(pk=int(request.POST['idp']), status=True,
                                                                   activo=True)
                profesor = materia.profesor_principal()
                if Silabo.objects.filter(materia=materia, programaanaliticoasignatura=programa).exists():
                    return JsonResponse({"result": "bad",
                                         "mensaje": u"El Programa Analítico ya se encuentra en un sílabo para la materia: " + str(
                                             materia.asignaturamalla.asignatura) + " - " + str(
                                             materia.asignaturamalla.nivelmalla.nombre) + " - P. [" + str(
                                             materia.paralelo) + "]."})
                if not Silabo.objects.filter(materia=materia, profesor=profesor, status=True,
                                             programaanaliticoasignatura=programa).exists():
                    crearsilabo = Silabo(materia=materia,
                                         profesor_id=522,
                                         programaanaliticoasignatura=programa)
                    crearsilabo.save(request)
                    log(u'Adicionó nuevo Sílabo: %s' % crearsilabo, request, "add")
                    # materia.silabo_set.filter(profesor=profesor, programaanaliticoasignatura__activo=False).update(status = False)
                    materia.silabo_set.filter(programaanaliticoasignatura__activo=False).update(status=False)
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'deletetemasilabo':
            try:
                valor = False
                if DetalleSilaboSemanalTema.objects.filter(
                        temaunidadresultadoprogramaanalitico_id=request.POST['idtema'],
                        silabosemanal_id=request.POST['idsilabosemanal']).exists():
                    temasilabo = DetalleSilaboSemanalTema.objects.get(
                        temaunidadresultadoprogramaanalitico_id=request.POST['idtema'],
                        silabosemanal_id=request.POST['idsilabosemanal'])
                    subtemasilabo = DetalleSilaboSemanalSubtema.objects.filter(
                        subtemaunidadresultadoprogramaanalitico__temaunidadresultadoprogramaanalitico_id=temasilabo.temaunidadresultadoprogramaanalitico_id,
                        silabosemanal_id=request.POST['idsilabosemanal'])
                    subtemasilabo.delete()
                    temasilabo.delete()
                    valor = False
                else:
                    ingresostemas = DetalleSilaboSemanalTema(silabosemanal_id=request.POST['idsilabosemanal'],
                                                             temaunidadresultadoprogramaanalitico_id=request.POST[
                                                                 'idtema'])
                    ingresostemas.save(request)
                    registrosubtemas = SubtemaUnidadResultadoProgramaAnalitico.objects.filter(
                        temaunidadresultadoprogramaanalitico_id=request.POST['idtema'])
                    for sub in registrosubtemas:
                        ingresossubtemas = DetalleSilaboSemanalSubtema(silabosemanal_id=request.POST['idsilabosemanal'],
                                                                       subtemaunidadresultadoprogramaanalitico_id=sub.id)
                        ingresossubtemas.save(request)
                    valor = True
                silabosemana = SilaboSemanal.objects.get(pk=int(request.POST['idsilabosemanal']))
                # silabosemana.modifico_silabo(persona, request)
                silabosemana.fechainiciosemana = request.POST['fini']
                silabosemana.fechafinciosemana = request.POST['ffin']
                silabosemana.save(request)
                return JsonResponse({"result": "ok", 'valor': valor})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar los datos."})

        elif action == 'deleteteemasilabo':
            try:
                valor = False
                valor = False
                if DetalleSilaboSemanalSubtema.objects.filter(
                        subtemaunidadresultadoprogramaanalitico_id=request.POST['idsubtema'],
                        silabosemanal_id=request.POST['idsilabosemanal']).exists():
                    subtemasilabo = DetalleSilaboSemanalSubtema.objects.get(
                        subtemaunidadresultadoprogramaanalitico_id=request.POST['idsubtema'],
                        silabosemanal_id=request.POST['idsilabosemanal'])
                    subtemasilabo.delete()
                    valor = False
                else:
                    ingresostemas = DetalleSilaboSemanalSubtema(silabosemanal_id=request.POST['idsilabosemanal'],
                                                                subtemaunidadresultadoprogramaanalitico_id=request.POST[
                                                                    'idsubtema'])
                    ingresostemas.save(request)
                    if DetalleSilaboSemanalTema.objects.filter(silabosemanal_id=request.POST['idsilabosemanal'],
                                                               temaunidadresultadoprogramaanalitico_id=ingresostemas.subtemaunidadresultadoprogramaanalitico.temaunidadresultadoprogramaanalitico_id).exists():
                        a = 0
                    else:
                        ingresostemas = DetalleSilaboSemanalTema(silabosemanal_id=request.POST['idsilabosemanal'],
                                                                 temaunidadresultadoprogramaanalitico_id=ingresostemas.subtemaunidadresultadoprogramaanalitico.temaunidadresultadoprogramaanalitico_id)
                        ingresostemas.save(request)
                    valor = True
                silabosemana = SilaboSemanal.objects.get(pk=int(request.POST['idsilabosemanal']))
                silabosemana.modifico_silabo(persona, request)
                silabosemana.fechainiciosemana = request.POST['fini']
                silabosemana.fechafinciosemana = request.POST['fini']
                silabosemana.save(request)
                return JsonResponse({"result": "ok", 'valor': valor})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar los datos."})

        elif action == 'delsilabovirtual':
            try:
                silabo = Silabo.objects.get(pk=int(encrypt(request.POST['id'])))
                # if not silabo.silabosemanal_set.values("id").exists():
                log(u'Eliminó cabecera de Sílabo: %s-%s la persona: %s' % (
                    silabo.materia, silabo.fecha_creacion, persona), request, "del")
                if silabo.aprobarsilabo_set.filter(status=True).exists():
                    silabo.aprobarsilabo_set.filter(status=True).delete()
                DetalleSilaboSemanalTema.objects.filter(silabosemanal__silabo=silabo).delete()
                DetalleSilaboSemanalSubtema.objects.filter(silabosemanal__silabo=silabo).delete()
                silabo.delete()
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'procesar_afinidad':
            try:
                listadoprofesormateria = ProfesorMateria.objects.filter(materia__nivel__periodo=periodo, tipoprofesor__id__in=[1, 11, 12, 14], status=True)
                if DEBUG:
                    listadoprofesormateria = listadoprofesormateria.filter(profesor__persona_id=4379)
                for profemateria in listadoprofesormateria:
                    profemateria.afinidadcampoamplio = False
                    profemateria.afinidadcampoespecifico = False
                    profemateria.afinidadcampodetallado = False
                    if profemateria.materia.asignaturamalla.afinidaddoctorado:
                        if profemateria.profesor.persona.titulacion_set.filter(titulo__grado_id=1, titulo__status=True, status=True):
                            itemtitulo = profemateria.profesor.persona.titulacion_set.filter(titulo__grado_id=1, titulo__status=True, status=True)[0]
                            profemateria.tituloafin = itemtitulo.titulo
                            profemateria.afinidadcampoamplio = True
                            profemateria.afinidadcampodetallado = True
                            profemateria.afinidadcampoespecifico = True
                    else:
                        titulos = profemateria.profesor.persona.titulacion_set.filter(titulo__grado_id__in=[1,2,5], titulo__status=True, status=True)
                        if titulos:
                            eCampos = CamposTitulosPostulacion.objects.filter(status=True, titulo_id__in=titulos.values_list("titulo_id", flat=True))
                            for eCampo in eCampos:
                                ecampoamplios = []
                                ecampoespecificos = []
                                ecampodetallados = []
                                if  profemateria.materia.asignaturamalla.areaconocimientotitulacion:
                                    ecampoamplios = eCampo.campoamplio.filter(pk=profemateria.materia.asignaturamalla.areaconocimientotitulacion.pk)
                                if profemateria.materia.asignaturamalla.subareaconocimiento:
                                    ecampoespecificos = eCampo.campoespecifico.filter(pk=profemateria.materia.asignaturamalla.subareaconocimiento.pk)
                                if profemateria.materia.asignaturamalla.subareaespecificaconocimiento:
                                    ecampodetallados = eCampo.campodetallado.filter(pk=profemateria.materia.asignaturamalla.subareaespecificaconocimiento.pk)
                                if len(ecampoamplios) > 0:
                                    profemateria.afinidadcampoamplio = True
                                if len(ecampoespecificos) > 0:
                                    profemateria.afinidadcampoespecifico = True
                                if len(ecampodetallados) > 0:
                                    profemateria.afinidadcampodetallado = True
                            for item in titulos.order_by('titulo__grado_id'):
                                eCampos = CamposTitulosPostulacion.objects.filter(status=True, titulo=item.titulo).order_by('titulo__grado_id')
                                if eCampos.exists():
                                    eCampo = eCampos.first()
                                    if item.titulo.grado_id in [1,2,5]:
                                        ecampoamplios= []
                                        ecampoespecificos= []
                                        ecampodetallados= []
                                        if profemateria.materia.asignaturamalla.areaconocimientotitulacion:
                                            ecampoamplios = eCampo.campoamplio.filter(pk=profemateria.materia.asignaturamalla.areaconocimientotitulacion.pk)
                                        if profemateria.materia.asignaturamalla.subareaconocimiento:
                                            ecampoespecificos = eCampo.campoespecifico.filter(pk=profemateria.materia.asignaturamalla.subareaconocimiento.pk)
                                        if profemateria.materia.asignaturamalla.subareaespecificaconocimiento:
                                            ecampodetallados = eCampo.campodetallado.filter(pk=profemateria.materia.asignaturamalla.subareaespecificaconocimiento.pk)
                                        if len(ecampoamplios) > 0 or len(ecampoespecificos) > 0 or len(ecampodetallados) > 0:
                                            profemateria.tituloafin=item.titulo
                                            break
                    profemateria.save(request)

                return JsonResponse({"result": "ok"})

            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al procesar. %s"%ex})

        elif action == 'procesar_estado_admision':
            try:
                Matricula.objects.filter(nivel__periodo=periodo,
                                         materiaasignada__materia__asignaturamalla__malla__carrera__coordinacion__id=9).update(
                    aprobado=False)
                cursor = connections['sga_select'].cursor()
                carreras = Carrera.objects.filter(malla__asignaturamalla__materia__nivel__periodo=periodo,
                                                  coordinacion__id=9).distinct()
                for carrera in carreras:
                    asignaturamallas = AsignaturaMalla.objects.filter(status=True, malla__carrera=carrera,
                                                                      materia__nivel__periodo=periodo).order_by(
                        'id').distinct()
                    sql = "select tabla1.cedula, tabla1.apellido, tabla1.nombre, tabla1.nota1, tabla1.nota2, tabla1.nota3, round(((tabla1.nota1+tabla1.nota2+tabla1.nota3)/3),2) as promedionotas, " \
                          " tabla1.asistencia1,tabla1.asistencia2,tabla1.asistencia3, round(((tabla1.asistencia1+tabla1.asistencia2+tabla1.asistencia3)/3),2) as promedioasistencia,tabla1.matricula " \
                          " from (select ma.id as matricula, p.cedula as cedula, (p.apellido1||' '||p.apellido2) as apellido, p.nombres as nombre, "
                    a = 1
                    tope = TopeAlumnosPrimero.objects.filter(carrera=carrera, periodo=periodo, status=True)
                    cantidadtope = 0
                    if tope:
                        cantidadtope = tope[0].cantidad
                    for asignaturamalla in asignaturamallas:
                        sql = sql + " (select notafinal from sga_materiaasignada mas, sga_materia mat where mas.status=true and mat.status=true and mas.materia_id=mat.id and mas.matricula_id=ma.id " \
                                    " and mat.asignaturamalla_id=" + str(asignaturamalla.id) + ") as nota" + str(
                            a) + "," \
                                 " (select asistenciafinal from sga_materiaasignada mas, sga_materia mat where mas.status=true and mat.status=true and mas.materia_id=mat.id and mas.matricula_id=ma.id " \
                                 " and mat.asignaturamalla_id=" + str(asignaturamalla.id) + ") as asistencia" + str(
                            a) + ", "
                        a += 1
                    sql = sql + " ma.id from sga_matricula ma, sga_nivel ni, sga_inscripcion i, sga_persona p where ma.status=true and ma.estado_matricula in (2,3) and ma.nivel_id=ni.id and ni.status=true " \
                                " and ni.periodo_id= " + str(
                        periodo.id) + " and i.id=ma.inscripcion_id and i.status=true and i.carrera_id=" + str(
                        carrera.id) + " and p.id=i.persona_id and p.status=true " \
                                      " order by 2) as tabla1 where 1=1 "
                    aa = 1
                    while (aa < a):
                        sql = sql + " and tabla1.nota" + str(aa) + ">= 70 "
                        aa += 1
                    sql = sql + " order by 7 desc, 11 desc, 2 asc"

                    # tabla1.nota1>=70 and tabla1.nota2>=70 and tabla1.nota3>=70
                    if cantidadtope != 0:
                        sql = sql + " limit " + str(cantidadtope) + ""

                    cursor.execute(sql)
                    inscripciones = cursor.fetchall()
                    for inscripcion in inscripciones:
                        Matricula.objects.filter(pk=int(inscripcion[11])).update(aprobado=True)

                log(u'Realizo cambio de estado admision %s' % periodo, request, "edit")
                return JsonResponse({"result": "ok"})

            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al procesar."})

        elif action == 'procesar_estado_admision_virtual':
            try:
                Matricula.objects.filter(nivel__periodo=periodo,
                                         materiaasignada__materia__asignaturamalla__malla__carrera__coordinacion__id=9,
                                         inscripcion__modalidad_id=3).update(aprobado=False)
                carreras = Carrera.objects.filter(malla__asignaturamalla__materia__nivel__periodo=periodo,
                                                  coordinacion__id=9, modalidad=3).distinct()
                for carrera in carreras:
                    cantidadtope = 0
                    if TopeAlumnosPrimero.objects.filter(carrera=carrera, periodo=periodo, status=True).exists():
                        cantidadtope = TopeAlumnosPrimero.objects.filter(carrera=carrera, periodo=periodo, status=True)[
                            0].cantidad

                    matriculas = Matricula.objects.filter(status=True, nivel__periodo=periodo,
                                                          materiaasignada__materia__asignaturamalla__malla__carrera__coordinacion__id=9,
                                                          inscripcion__modalidad__id=3,
                                                          inscripcion__carrera=carrera).distinct().order_by(
                        'promedionotasvirtual')
                    matriculas.update(aprobado=False)
                    listaconcuposlimpios = []
                    for matricula in matriculas:
                        if matricula.promedionotasvirtual >= 70 and matricula.verificar_todas_materias_aprobadas():
                            listaconcuposlimpios.append(matricula.id)
                    while listaconcuposlimpios.__len__() < cantidadtope:
                        cuposrestantes = cantidadtope - listaconcuposlimpios.__len__()
                        matriculas1 = matriculas.exclude(id__in=listaconcuposlimpios)
                        # listaconcupos.sort(key=lambda clasesimp: (clasesimp[1]), reverse=True)
                        for matricula in matriculas1[:cuposrestantes]:
                            if matricula.promedionotasvirtual >= 70 and matricula.cantidad_examen_rindio_admision_virtual() >= 2 and matricula.cantidad_materias_aprobadas() >= 2:
                                listaconcuposlimpios.append(matricula.id)
                    Matricula.objects.filter(id__in=listaconcuposlimpios).update(aprobado=True)

                    log(u'Realizo cambio de estado admision %s' % periodo, request, "edit")
                    return JsonResponse({"result": "ok"})

                log(u'Realizo cambio de estado admision %s' % periodo, request, "edit")
                return JsonResponse({"result": "ok"})

            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al procesar."})

        elif action == 'copiarhorario':
            try:
                # listamensajeconflicto = []
                # conflictohorario = False
                # data = {}
                # contar_conflictos = 0
                # contar_sin_conflictos = 0
                # json_content = None
                materia_origen = Materia.objects.get(pk=request.POST['id'])
                materia_destino = Materia.objects.get(pk=request.POST['idma'])
                materia_origen.actualizarhtml = True
                materia_origen.save()
                materia_destino.actualizarhtml = True
                materia_destino.save()
                inicio = materia_destino.inicio
                fin = materia_destino.fin
                for cl in Clase.objects.filter(materia=materia_origen, activo=True):
                    if Clase.objects.values('id').filter(
                            Q(inicio__lte=inicio, fin__gte=inicio) | Q(inicio__lte=fin, fin__gte=fin) | Q(
                                inicio__gte=inicio, fin__lte=fin), materia=materia_destino, turno=cl.turno,
                            dia=cl.dia, activo=True).exists():
                        return JsonResponse({"result": "bad",
                                             "mensaje": u"La materia ya existe en este turno y dia en ese rango de fechas."})
                    # verificar_conflito_docente = cl.profesor.existe_conflicto_docente(periodo, materia_destino, cl.tipoprofesor, inicio, fin, cl.dia, cl.turno)
                    # if not verificar_conflito_docente[0]:
                    if Clase.objects.values('id').filter(materia=materia_destino, turno=cl.turno, aula=cl.aula,
                                                         dia=cl.dia, inicio=inicio, fin=fin,
                                                         tipoprofesor=cl.tipoprofesor, activo=True).exists():
                        clase = \
                            Clase.objects.filter(materia=materia_destino, tipoprofesor=cl.tipoprofesor, turno=cl.turno,
                                                 aula=cl.aula, dia=cl.dia, inicio=inicio, fin=fin, activo=True)[0]
                        clase.activo = True
                        clase.save(request)
                        log(u'Se activo clase horario en la opcion copiar horario masivo de la materia: %s' % clase,
                            request, "edit")
                    else:
                        clase = Clase(materia=materia_destino,
                                      turno=cl.turno,
                                      aula=cl.aula,
                                      tipoprofesor=cl.tipoprofesor,
                                      dia=cl.dia,
                                      profesor=cl.profesor,
                                      # grupoprofesor=cl.grupoprofesor,
                                      tipohorario=cl.tipohorario,
                                      inicio=inicio,
                                      fin=fin,
                                      activo=True)
                        clase.save(request)
                    log(u'Adicionado horario: %s' % clase, request, "add")
                    # contar_sin_conflictos += 1
                    # else:
                    #     listamensajeconflicto.append(verificar_conflito_docente)
                    #     conflictohorario = True
                    #     contar_conflictos += 1
                # if conflictohorario:
                #     data['mensajes'] = listamensajeconflicto
                #     data['contarclasesconflicto'] = contar_conflictos.__str__()
                #     data['clasesafectadas'] = contar_sin_conflictos.__str__()
                #     template = get_template("niveles/mensajeconflicto.html")
                #     json_content = template.render(data)
                log(u'Copio turno de: Origen:[%s] Destino:[%s]' % (materia_origen, materia_destino), request, "add")
                # return JsonResponse({"result": 'ok', 'existeconflicto':conflictohorario, 'segmento':json_content, 'clasesafectadas':contar_sin_conflictos.__str__()})
                return JsonResponse({"result": 'ok', 'existeconflicto': False})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'ingresar_horarioexamen':
            try:
                conflicto_horario_editar = None
                conflicto_horario = None
                iddetalle = request.POST['detalle']
                fecha = convertir_fecha(request.POST['fecha'])
                turno = Turno.objects.get(pk=int(request.POST['turno']))
                materia = Materia.objects.get(pk=int(request.POST['materia']))
                materia.actualizarhtml = True
                materia.save()
                if not HorarioExamen.objects.filter(materia=materia, detallemodelo_id=int(iddetalle),
                                                    status=True).values('id').exists():
                    if materia.tipomateria != 2:
                        conflicto_horario = materia.verificar_conflicto_horario_examen(fecha, turno)
                        if not conflicto_horario:
                            horarioexamen = HorarioExamen(materia=materia,
                                                          detallemodelo_id=int(iddetalle),
                                                          fecha=fecha,
                                                          turno=turno)
                            horarioexamen.save(request)
                            log(u'Ingreso horario examen: %s' % horarioexamen, request, "add")
                    else:
                        horarioexamen = HorarioExamen(materia=materia,
                                                      detallemodelo_id=int(iddetalle),
                                                      fecha=fecha,
                                                      turno=turno)
                        horarioexamen.save(request)
                        log(u'Ingreso horario examen: %s' % horarioexamen, request, "add")
                else:
                    conflicto_horario_editar = horarioexamen = \
                        HorarioExamen.objects.filter(materia=materia, detallemodelo_id=int(iddetalle), status=True)[0]
                    if materia.tipomateria != 2:
                        conflicto_horario = materia.verificar_conflicto_horario_examen(fecha, turno, False)
                        if not conflicto_horario:
                            horarioexamen.fecha = fecha
                            horarioexamen.turno = turno
                            horarioexamen.save(request)
                            log(u'Modifico horario examen: %s' % horarioexamen, request, "edit")
                    else:
                        horarioexamen.fecha = fecha
                        horarioexamen.turno = turno
                        horarioexamen.save(request)
                        log(u'Modifico horario examen: %s' % horarioexamen, request, "edit")
                if conflicto_horario:
                    data['conflicto_horario'] = conflicto_horario
                    template = get_template("niveles/mensajeconflicto_horarioexamen.html")
                    json_content = template.render(data)
                    return JsonResponse({"result": "bad", "existeconflicto": True if conflicto_horario else False,
                                         'segmento': json_content,
                                         'conflicto_por_editar': True if conflicto_horario_editar else False,
                                         'idturno_anterior': conflicto_horario_editar.turno_id if conflicto_horario_editar else 0,
                                         'fecha_anterior': conflicto_horario_editar.fecha.strftime(
                                             '%d-%m-%Y') if conflicto_horario_editar else ''})
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'ingresar_horarioexamenhora':
            try:
                iddetalle = request.POST['detalle']
                fecha = convertir_fecha(request.POST['fecha'])
                materia = Materia.objects.get(pk=int(request.POST['materia']))
                materia.actualizarhtml = True
                materia.save()
                if not HorarioExamen.objects.filter(materia=materia, detallemodelo_id=int(iddetalle),
                                                    status=True).values('id').exists():
                    horarioexamen = HorarioExamen(materia=materia,
                                                  detallemodelo_id=int(iddetalle),
                                                  fecha=fecha,
                                                  turno_id=1)
                    horarioexamen.save(request)
                else:
                    horarioexamen = \
                        HorarioExamen.objects.filter(materia=materia, detallemodelo_id=int(iddetalle), status=True)[0]
                    horarioexamen.fecha = fecha
                    horarioexamen.save(request)
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'asignarhorarioprofe':
            try:
                nivel = Nivel.objects.get(pk=request.POST['id'])
                carreras = persona.mis_carreras()
                if MATRICULACION_LIBRE:
                    carreras = carreras.filter(id__in=nivel.coordinacion().carrera.all())
                    mallas = Malla.objects.filter(carrera__in=carreras).distinct()
                    malla = None
                    nivelmalla = None
                    if 'mallaid' in request.POST:
                        malla = mallas.get(pk=int(request.POST['mallaid']))
                    else:
                        if mallas.exists():
                            malla = mallas[0]
                    paraleloid = '0'
                    if 'paraleloid' in request.POST:
                        paraleloid = request.POST['paraleloid']
                    data['paraleloid'] = paraleloid
                    data['malla'] = malla
                    data['mallaid'] = malla.id if malla else 0
                    if 'nivelmallaid' in request.POST and int(request.POST['nivelmallaid']) > 0:
                        nivelmalla = NivelMalla.objects.get(pk=int(request.POST['nivelmallaid']))
                        data['nivelmalla'] = nivelmalla
                        data['nivelmallaid'] = nivelmalla.id if nivelmalla else ""
                    if nivelmalla:
                        if paraleloid == '0':
                            materias = nivel.materia_set.filter(status=True, asignaturamalla__malla=malla, cerrado=False,
                                                                asignaturamalla__nivelmalla=nivelmalla).order_by(
                                'asignaturamalla__nivelmalla', 'asignatura__nombre', 'inicio', 'identificacion', 'id')
                        else:
                            materias = nivel.materia_set.filter(status=True, asignaturamalla__malla=malla, cerrado=False,
                                                                paralelo=paraleloid,
                                                                asignaturamalla__nivelmalla=nivelmalla).order_by(
                                'asignaturamalla__nivelmalla', 'asignatura__nombre', 'inicio', 'identificacion', 'id')
                    else:
                        if paraleloid == '0':
                            materias = nivel.materia_set.filter(status=True, asignaturamalla__malla=malla, cerrado=False).order_by(
                                'asignaturamalla__nivelmalla', 'asignatura__nombre', 'inicio', 'identificacion', 'id')
                        else:
                            materias = nivel.materia_set.filter(status=True, asignaturamalla__malla=malla, paralelo=paraleloid,
                                                                cerrado=False).order_by('asignaturamalla__nivelmalla',
                                                                                        'asignatura__nombre', 'inicio',
                                                                                        'identificacion', 'id')
                else:
                    materias = nivel.materia_set.filter(status=True, cerrado=False).order_by('asignatura__nombre', 'inicio',
                                                                                'identificacion', 'id')
                listamensaje = []
                existeconflicto = False
                json_content = None
                contarclasesconflicto = 0
                contarclasessinconflicto = 0
                for materia in materias:
                    profesor = materia.profesores_materia_segun_tipoprofesor(1)
                    tipoprofesor = TipoProfesor.objects.get(pk=1)
                    if profesor:
                        materia.actualizarhtml = True
                        materia.save()
                        profesor = profesor[0]
                        clases = Clase.objects.filter(Q(materia=materia),
                                                      (Q(tipoprofesor__id=1) | Q(tipoprofesor__isnull=True)),
                                                      Q(activo=True))
                        for clase in clases:
                            verificar_conflito_docente = profesor.existe_conflicto_docente(periodo, materia,
                                                                                           tipoprofesor, clase.inicio,
                                                                                           clase.fin, clase.dia,
                                                                                           clase.turno)
                            if verificar_conflito_docente[0]:
                                listamensaje.append(verificar_conflito_docente)
                                existeconflicto = True
                                contarclasesconflicto += 1
                            else:
                                contarclasessinconflicto += 1
                                clase.tipoprofesor = tipoprofesor
                                clase.profesor = profesor
                                clase.save(request)
                                log(
                                    u'Asigno docente principal de teoria a horario de teoria de la materia: %s[%s] - profesor que se va asignar:%s[%s] - a clase:%s[%s]' % (
                                        materia, materia.id, profesor, profesor.id, clase, clase.id), request, "edit")
                if existeconflicto:
                    data['mensajes'] = listamensaje
                    data['contarclasesconflicto'] = contarclasesconflicto.__str__()
                    data['clasesafectadas'] = contarclasessinconflicto.__str__()
                    template = get_template("niveles/mensajeconflicto.html")
                    json_content = template.render(data)
                return JsonResponse({"result": "ok", "existeconflicto": existeconflicto, 'segmento': json_content,
                                     "clasesafectadas": contarclasessinconflicto.__str__()})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al asignar horario docente."})

        elif action == 'asignargrupoprofe':
            try:
                nivel = Nivel.objects.get(pk=request.POST['id'])
                carreras = persona.mis_carreras()
                if MATRICULACION_LIBRE:
                    carreras = carreras.filter(id__in=nivel.coordinacion().carrera.all())
                    mallas = Malla.objects.filter(carrera__in=carreras).distinct()
                    malla = None
                    nivelmalla = None
                    if 'mallaid' in request.POST:
                        malla = mallas.get(pk=int(request.POST['mallaid']))
                    else:
                        if mallas.exists():
                            malla = mallas[0]
                    paraleloid = '0'
                    if 'paraleloid' in request.POST:
                        paraleloid = request.POST['paraleloid']
                    data['paraleloid'] = paraleloid
                    data['malla'] = malla
                    data['mallaid'] = malla.id if malla else 0
                    if 'nivelmallaid' in request.POST and int(request.POST['nivelmallaid']) > 0:
                        nivelmalla = NivelMalla.objects.get(pk=int(request.POST['nivelmallaid']))
                        data['nivelmalla'] = nivelmalla
                        data['nivelmallaid'] = nivelmalla.id if nivelmalla else ""
                    if nivelmalla:
                        if paraleloid == '0':
                            materias = nivel.materia_set.filter(status=True, sasignaturamalla__malla=malla,
                                                                asignaturamalla__nivelmalla=nivelmalla).order_by(
                                'asignaturamalla__nivelmalla', 'asignatura__nombre', 'inicio', 'identificacion', 'id')
                        else:
                            materias = nivel.materia_set.filter(status=True, asignaturamalla__malla=malla, paralelo=paraleloid,
                                                                asignaturamalla__nivelmalla=nivelmalla).order_by(
                                'asignaturamalla__nivelmalla', 'asignatura__nombre', 'inicio', 'identificacion', 'id')
                    else:
                        if paraleloid == '0':
                            materias = nivel.materia_set.filter(status=True, asignaturamalla__malla=malla).order_by(
                                'asignaturamalla__nivelmalla', 'asignatura__nombre', 'inicio', 'identificacion', 'id')
                        else:
                            materias = nivel.materia_set.filter(status=True, asignaturamalla__malla=malla,
                                                                paralelo=paraleloid).order_by(
                                'asignaturamalla__nivelmalla', 'asignatura__nombre', 'inicio', 'identificacion', 'id')
                else:
                    materias = nivel.materia_set.filter(status=True).order_by('asignatura__nombre', 'inicio', 'identificacion', 'id')
                for materia in materias:
                    profesoresmate = materia.profesores_materia_segun_tipoprofesor_pm(TipoProfesor.objects.get(pk=2))
                    for profemate in profesoresmate:
                        if profemate.contargrupoprofesormateria() < 1:
                            for paralelo in PARALELO_CLASE_PRACTICAS:
                                if not GruposProfesorMateria.objects.filter(profesormateria__materia=profemate.materia,
                                                                            paralelopractica=paralelo[0],
                                                                            status=True).exists() and paralelo[0] > 0:
                                    grupo = GruposProfesorMateria(profesormateria=profemate, cupo=0,
                                                                  paralelopractica=paralelo[0])
                                    grupo.save(request)
                                    log(
                                        u'Adiciono grupo profesor materia cupo(%s) paralelopracticas(%s) profemate(%s) automatico' % (
                                            grupo.cupo, grupo.paralelopractica, grupo.profesormateria), request, "edit")
                                    clases = Clase.objects.filter(materia=materia, tipoprofesor=profemate.tipoprofesor,
                                                                  profesor=profemate.profesor, activo=True)
                                    for clase in clases:
                                        clase.grupoprofesor = grupo
                                        clase.save(request)
                                        log(
                                            u'Asignacion automatico grupoprofesormateria segun la asignacion del grupo al profesor en clase de la materia: %s[%s] - profesor:%s[%s] - a clase:%s[%s] - grupo[%s]' % (
                                                materia, materia.id, grupo.profesormateria.profesor,
                                                grupo.profesormateria.profesor.id, clase, clase.id, grupo.id), request,
                                            "add")
                                    alumnospracticas = AlumnosPracticaMateria.objects.filter(profesormateria=profemate,
                                                                                             status=True,
                                                                                             materiaasignada__materia=profemate.materia)
                                    for grupoalumno in alumnospracticas:
                                        grupoalumno.grupoprofesor = grupo
                                        grupoalumno.save(request)
                                    break
                    # materia.actualizar_cupo_profesores_practicas_grupo()
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al asignar grupo docente."})

        elif action == 'importarmatricula':
            try:
                form = ImportarArchivoXLSForm(request.POST, request.FILES)
                periodo = Periodo.objects.get(pk=request.POST['id'])
                if form.is_valid():
                    nfile = request.FILES['archivo']
                    nfile._name = generar_nombre("importacionmatriculamasiva_", nfile._name)
                    archivo = Archivo(nombre='IMPORTACION_MATRICULAMASIVA',
                                      fecha=datetime.now().date(),
                                      archivo=nfile,
                                      tipo_id=9)
                    archivo.save(request)

                    workbook = xlrd.open_workbook(archivo.archivo.file.name)
                    sheet = workbook.sheet_by_index(0)
                    linea = 1
                    modalidad = Modalidad.objects.get(pk=1)
                    for rowx in range(sheet.nrows):
                        if linea > 1:
                            cols = sheet.row_values(rowx)
                            cedula = cols[0].strip().upper()
                            bandera = True
                            if Persona.objects.filter(cedula=cedula).exists():
                                persona = Persona.objects.filter(cedula=cols[0])[0]
                                sesion = Sesion.objects.get(pk=int(cols[2]))
                                carrera = Carrera.objects.get(pk=int(cols[1]))
                                sede = Sede.objects.get(pk=1)
                                cordinacion_alias = str(carrera.coordinacion_set.all()[0].alias)
                                colegio = persona.inscripcion_set.all()[0].colegio
                                raza_id = 6
                                if not Inscripcion.objects.filter(persona=persona, carrera=carrera).exists():
                                    inscripcion = Inscripcion(persona=persona,
                                                              fecha=datetime.now().date(),
                                                              carrera=carrera,
                                                              modalidad=modalidad,
                                                              sesion=sesion,
                                                              sede=sede,
                                                              colegio=colegio)
                                    inscripcion.save()
                                    persona.crear_perfil(inscripcion=inscripcion)
                                    documentos = DocumentosDeInscripcion(inscripcion=inscripcion,
                                                                         titulo=False,
                                                                         acta=False,
                                                                         cedula=False,
                                                                         votacion=False,
                                                                         actaconv=False,
                                                                         partida_nac=False,
                                                                         pre=False,
                                                                         observaciones_pre='',
                                                                         fotos=False)
                                    documentos.save()
                                    preguntasinscripcion = inscripcion.preguntas_inscripcion()
                                    perfil_inscripcion = inscripcion.persona.mi_perfil()

                                    perfil_inscripcion.raza_id = raza_id
                                    perfil_inscripcion.save()
                                    inscripciontesdrive = InscripcionTesDrive(inscripcion=inscripcion,
                                                                              licencia=False,
                                                                              record=False,
                                                                              certificado_tipo_sangre=False,
                                                                              prueba_psicosensometrica=False,
                                                                              certificado_estudios=False)
                                    inscripciontesdrive.save()
                                    # inscripcion.mi_malla()
                                    inscripcion.malla_inscripcion()
                                    inscripcion.actualizar_nivel()
                                    if USA_TIPOS_INSCRIPCIONES:
                                        inscripciontipoinscripcion = InscripcionTipoInscripcion(inscripcion=inscripcion,
                                                                                                tipoinscripcion_id=TIPO_INSCRIPCION_INICIAL)
                                        inscripciontipoinscripcion.save()
                                    # persona.creacion_persona(request.session['nombresistema'])
                                else:
                                    inscripcion = Inscripcion.objects.filter(persona=persona, carrera=carrera)[0]
                                    perfil_inscripcion = inscripcion.persona.mi_perfil()
                                    perfil_inscripcion.raza_id = raza_id
                                    perfil_inscripcion.save()

                                inscripcion = Inscripcion.objects.filter(persona=persona, carrera=carrera)[0]
                                inscripcion.sesion = sesion
                                inscripcion.save()

                            # considerar si que existe en titulo persona
                            if not persona.tiene_otro_titulo(inscripcion=inscripcion):
                                nivel = Nivel.objects.get(periodo=periodo, sesion=sesion,
                                                          paralelo__icontains=cordinacion_alias)
                                # matricula
                                if not inscripcion.matricula_periodo(periodo):
                                    matricula = Matricula(inscripcion=inscripcion,
                                                          nivel=nivel,
                                                          pago=False,
                                                          iece=False,
                                                          becado=False,
                                                          porcientobeca=0,
                                                          fecha=datetime.now().date(),
                                                          hora=datetime.now().time(),
                                                          estado_matricula__in=[2, 3],
                                                          fechatope=fechatope(datetime.now().date()))
                                    matricula.save()
                                else:
                                    matricula = Matricula.objects.get(inscripcion=inscripcion, nivel=nivel)

                                # asignatura_malla=RecordAcademico.objects.values_list('asignatura__id',flat=True).filter(asignaturamalla__nivelmalla__id__lt=int(cols[4]), aprobada=True)

                                for materia in Materia.objects.filter(status=True, nivel__periodo=periodo,
                                                                      paralelo=str(cols[3].strip()),
                                                                      asignaturamalla__malla__carrera=carrera,
                                                                      nivel__sesion=sesion,
                                                                      asignaturamalla__nivelmalla__id=int(cols[4])):
                                    if not MateriaAsignada.objects.filter(matricula=matricula,
                                                                          materia=materia).exists():
                                        matriculas = matricula.inscripcion.historicorecordacademico_set.filter(
                                            asignatura=materia.asignatura, fecha__lt=materia.nivel.fin).count() + 1
                                        materiaasignada = MateriaAsignada(matricula=matricula,
                                                                          materia=materia,
                                                                          notafinal=0,
                                                                          asistenciafinal=0,
                                                                          cerrado=False,
                                                                          matriculas=matriculas,
                                                                          observaciones='',
                                                                          estado_id=NOTA_ESTADO_EN_CURSO)
                                        materiaasignada.save()
                                        materiaasignada.asistencias()
                                        materiaasignada.evaluacion()
                                        materiaasignada.mis_planificaciones()
                                        materiaasignada.save()
                                matricula.actualizar_horas_creditos()
                                matricula.inscripcion.actualiza_estado_matricula()
                                matricula.grupo_socio_economico(1)
                                matricula.calcula_nivel()
                        linea += 1
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'importarinscripcion':
            try:
                form = ImportarArchivoXLSForm(request.POST, request.FILES)
                periodo = Periodo.objects.get(pk=request.POST['id'])
                if form.is_valid():
                    nfile = request.FILES['archivo']
                    nfile._name = generar_nombre("importacioninscripcionneuvas_", nfile._name)
                    archivo = Archivo(nombre='IMPORTACION_INSCRIPCIONES_NUEVAS',
                                      fecha=datetime.now().date(),
                                      archivo=nfile,
                                      tipo_id=9)
                    archivo.save(request)

                    workbook = xlrd.open_workbook(archivo.archivo.file.name)
                    sheet = workbook.sheet_by_index(0)
                    linea = 1
                    modalidad = Modalidad.objects.get(pk=1)
                    for rowx in range(sheet.nrows):
                        if linea > 1:
                            cols = sheet.row_values(rowx)
                            cedula = cols[0].strip().upper()
                            bandera = True
                            if Persona.objects.filter(cedula=cedula).exists():
                                persona = Persona.objects.filter(cedula=cols[0])[0]
                                carrera = Carrera.objects.get(pk=int(cols[1]))
                                sesion = Sesion.objects.get(pk=int(cols[2]))
                                sede = Sede.objects.get(pk=1)
                                cordinacion_alias = str(carrera.coordinacion_set.all()[0].alias)
                                colegio = persona.inscripcion_set.all()[0].colegio
                                raza_id = 6
                                if not Inscripcion.objects.filter(persona=persona, carrera=carrera).exists():
                                    inscripcion = Inscripcion(persona=persona,
                                                              fecha=datetime.now().date(),
                                                              carrera=carrera,
                                                              modalidad=modalidad,
                                                              sesion=sesion,
                                                              sede=sede,
                                                              colegio=colegio)
                                    inscripcion.save()
                                    persona.crear_perfil(inscripcion=inscripcion)
                                    documentos = DocumentosDeInscripcion(inscripcion=inscripcion,
                                                                         titulo=False,
                                                                         acta=False,
                                                                         cedula=False,
                                                                         votacion=False,
                                                                         actaconv=False,
                                                                         partida_nac=False,
                                                                         pre=False,
                                                                         observaciones_pre='',
                                                                         fotos=False)
                                    documentos.save()
                                    preguntasinscripcion = inscripcion.preguntas_inscripcion()
                                    perfil_inscripcion = inscripcion.persona.mi_perfil()

                                    perfil_inscripcion.raza_id = raza_id
                                    perfil_inscripcion.save()
                                    inscripciontesdrive = InscripcionTesDrive(inscripcion=inscripcion,
                                                                              licencia=False,
                                                                              record=False,
                                                                              certificado_tipo_sangre=False,
                                                                              prueba_psicosensometrica=False,
                                                                              certificado_estudios=False)
                                    inscripciontesdrive.save()
                                    # inscripcion.mi_malla()
                                    inscripcion.malla_inscripcion()
                                    inscripcion.actualizar_nivel()
                                    if USA_TIPOS_INSCRIPCIONES:
                                        inscripciontipoinscripcion = InscripcionTipoInscripcion(inscripcion=inscripcion,
                                                                                                tipoinscripcion_id=TIPO_INSCRIPCION_INICIAL)
                                        inscripciontipoinscripcion.save()
                                    # persona.creacion_persona(request.session['nombresistema'])
                                else:
                                    inscripcion = Inscripcion.objects.filter(persona=persona, carrera=carrera)[0]
                                    perfil_inscripcion = inscripcion.persona.mi_perfil()
                                    perfil_inscripcion.raza_id = raza_id
                                    perfil_inscripcion.save()

                                inscripcion = Inscripcion.objects.filter(persona=persona, carrera=carrera)[0]
                                inscripcion.sesion = sesion
                                inscripcion.fechainicioprimernivel = convertir_fecha_invertida(cols[4])
                                inscripcion.fechainiciocarrera = convertir_fecha_invertida(cols[3])
                                inscripcion.save()

                        linea += 1
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos linea. %s" % linea})

        elif action == 'informeconflictohorarioalumno':
            try:
                # VERIFICAR CONFLICTO ALUMNOS
                listaconflicto = []
                nivel = Nivel.objects.get(pk=int(encrypt(request.POST['idn'])))
                matriculas = nivel.matricula_set.filter(nivel__periodo=periodo, retiradomatricula=False).order_by(
                    'inscripcion__persona')
                for matricula in matriculas:
                    materias = Materia.objects.filter(id__in=matricula.materiaasignada_set.values_list('materia__id').filter(sinasistencia=False), status=True)
                    alumnaspracticascongrupo = AlumnosPracticaMateria.objects.values_list('profesormateria__id',
                                                                                          'grupoprofesor__id').filter(
                        materiaasignada__materia__id__in=materias.values_list('id'),
                        materiaasignada__matricula=matricula, grupoprofesor__isnull=False)
                    conflicto = conflicto_materias_estudiante(materias=materias,
                                                              lista_pm_grupo=alumnaspracticascongrupo,
                                                              extraerlistaclasesconflicto=True)
                    if conflicto:
                        listaconflicto.append([matricula, conflicto[0], conflicto[1]])
                return conviert_html_to_pdf('niveles/informeconflictoestudiante.html',
                                            {'pagesize': 'A4 landscape', 'periodo': periodo,
                                             'listaconflicto': listaconflicto, 'nivel': nivel})
            except Exception as ex:
                return HttpResponseRedirect("/niveles?info=%s" % 'Error al generar informe de conflictos de horarios')

        elif action == 'informeestudiantepractica':
            try:
                nivel = Nivel.objects.get(pk=int(encrypt(request.POST['idn'])))
                carreras = persona.mis_carreras()
                carreras = carreras.filter(id__in=nivel.coordinacion().carrera.all())
                mallas = Malla.objects.filter(carrera__in=carreras).distinct()
                profesorpractica = TipoProfesor.objects.get(pk=TIPO_DOCENTE_PRACTICA)
                malla = None
                nivelmalla = None
                paraleloid = '0'
                if 'mid' in request.POST:
                    malla = mallas.get(pk=int(request.POST['mid']))
                else:
                    if mallas.exists():
                        malla = mallas[0]
                if 'pid' in request.POST:
                    paraleloid = request.POST['pid']
                if 'nmid' in request.POST and int(request.POST['nmid']) > 0:
                    nivelmalla = NivelMalla.objects.get(pk=int(request.POST['nmid']))
                materias = nivel.materia_set.filter(asignaturamalla__malla=malla,
                                                    asignaturamalla__practicas=True, status=True).order_by(
                    'asignaturamalla__nivelmalla', 'asignatura__nombre', 'inicio', 'identificacion', 'id')
                if nivelmalla:
                    materias = materias.filter(asignaturamalla__nivelmalla=nivelmalla).order_by(
                        'asignaturamalla__nivelmalla', 'asignatura__nombre', 'inicio', 'identificacion', 'id')
                if not paraleloid == '0':
                    materias = materias.filter(paralelo=paraleloid).order_by('asignaturamalla__nivelmalla',
                                                                             'asignatura__nombre', 'inicio',
                                                                             'identificacion', 'id')
                data['nivel'] = nivel
                data['malla'] = malla
                data['materias'] = materias
                data['periodo'] = periodo
                data['paraleloid'] = paraleloid
                data['nivelmalla'] = nivelmalla
                data['profesorpractica'] = profesorpractica
                return conviert_html_to_pdf('niveles/listadoestudiantespracticas.html',
                                            {'pagesize': 'A4 landscape', 'datos': data})
            except Exception as ex:
                return HttpResponseRedirect("/niveles?info=%s" % 'Error al generar informe de estudiantes de prácticas')

        # PARALELOS
        elif action == 'addparalelo':
            try:
                form = ParaleloForm(request.POST)
                if not form.is_valid():
                    for k, v in form.errors.items():
                        raise NameError(v[0])
                paralelo = Paralelo(nombre=form.cleaned_data['nombre'])
                paralelo.save(request)
                log(u'Agrego Paralelo: %s - [%s]' % (paralelo, paralelo.id), request, "add")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos: %s" % ex.__str__()})

        elif action == 'editparalelo':
            try:
                form = ParaleloForm(request.POST)
                if not form.is_valid():
                    for k, v in form.errors.items():
                        raise NameError(v[0])
                paralelo = Paralelo.objects.get(pk=int(request.POST['id']))
                paralelo.nombre = form.cleaned_data['nombre']
                paralelo.save(request)
                log(u'Editar paralelo: %s - [%s]' % (paralelo, paralelo.id), request, "edit")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos: %s" % ex.__str__()})

        elif action == 'delparalelo':
            try:
                paralelo = Paralelo.objects.get(pk=int(request.POST['id']))
                if paralelo.matricula_set.all() or paralelo.materia_set.filter(status=True):
                    return JsonResponse({"result": "bad",
                                         "mensaje": u"No se puede Eliminar, se esta utilizando en matricula o en materia.."})
                log(u'Elimino paralelo: %s - [%s]' % (paralelo, paralelo.id), request, "del")
                paralelo.status = False
                paralelo.save(request)
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar los datos."})

        #BLOQUES
        elif action == 'addbloque':
            try:
                if not 'foto' in request.FILES:
                    raise NameError(f"Favor carge una foto")
                fotofile = request.FILES['foto']
                if fotofile.size > 8194304:
                    raise NameError(u"Archivo mayor a 5Mb.")
                fotofileod = fotofile._name
                ext = fotofileod[fotofileod.rfind("."):]
                if not ext in ['.jpg', '.png']:
                    raise NameError(u"Solo archivo con extensión. jpg.")
                fotofile._name = generar_nombre("foto_bloque", fotofile._name)
                form = BloqueForm(request.POST, request.FILES)

                if form.is_valid():
                    bloque = Bloque(descripcion=form.cleaned_data['descripcion'],
                                    # observacion=form.cleaned_data['observacion'],
                                    foto=fotofile,
                                    referencias=form.cleaned_data['referencias'],
                                    latitud=form.cleaned_data['latitud'],
                                    longitud=form.cleaned_data['longitud'],
                                    tipo=form.cleaned_data['tipo']
                                    )
                    bloque.save(request)
                    log(u'Agrego Bloque: %s - [%s]' % (bloque, bloque.id), request, "add")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos: %s" % ex.__str__()})

        elif action == 'editbloque':
            try:
                fotofile = None
                if 'foto' in request.FILES:
                    fotofile = request.FILES['foto']
                    if fotofile.size > 8194304:
                        raise NameError(u"Archivo mayor a 5Mb.")
                    fotofileod = fotofile._name
                    ext = fotofileod[fotofileod.rfind("."):]
                    if not ext in ['.jpg', '.png']:
                        raise NameError(u"Solo archivo con extensión. jpg.")
                    fotofile._name = generar_nombre("foto_bloque", fotofile._name)

                form = BloqueForm(request.POST)
                if form.is_valid():
                    bloque = Bloque.objects.get(pk=int(request.POST['id']))
                    bloque.descripcion = form.cleaned_data['descripcion']
                    # bloque.observacion = form.cleaned_data['observacion']
                    if fotofile is not None:
                        bloque.foto = fotofile
                    bloque.referencias = form.cleaned_data['referencias']
                    bloque.latitud = form.cleaned_data['latitud']
                    bloque.longitud = form.cleaned_data['longitud']
                    bloque.tipo = form.cleaned_data['tipo']
                    bloque.save(request)
                    log(u'Editar bloque: %s - [%s]' % (bloque, bloque.id), request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos: %s" % ex.__str__()})

        elif action == 'delbloque':
            try:
                bloque = Bloque.objects.get(pk=int(request.POST['id']))
                log(u'Elimino bloque: %s - [%s]' % (bloque, bloque.id), request, "del")
                bloque.status = False
                bloque.save(request)
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar los datos."})

        # TURNOS
        elif action == 'addturno':
            try:
                form = TurnoForm(request.POST)
                if form.is_valid():
                    if Turno.objects.filter(sesion=form.cleaned_data['sesion'], comienza=form.cleaned_data['comienza'], termina=form.cleaned_data['termina']).exists():
                        turno = Turno.objects.get(sesion=form.cleaned_data['sesion'], comienza=form.cleaned_data['comienza'], termina=form.cleaned_data['termina'])
                        turno.status = True
                    else:
                        turno = Turno(sesion=form.cleaned_data['sesion'],
                                      turno=form.cleaned_data['turno'],
                                      comienza=form.cleaned_data['comienza'],
                                      termina=form.cleaned_data['termina'],
                                      mostrar=form.cleaned_data['mostrar'],
                                      horas=form.cleaned_data['horas']
                                      )
                    turno.save(request)
                    log(u'Agregó Turno: %s - [%s]' % (turno, turno.id), request, "add")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'editturno':
            try:
                form = TurnoForm(request.POST)
                if form.is_valid():
                    turno = Turno.objects.get(pk=int(request.POST['id']))
                    turno.sesion = form.cleaned_data['sesion']
                    turno.turno = form.cleaned_data['turno']
                    turno.comienza = form.cleaned_data['comienza']
                    turno.termina = form.cleaned_data['termina']
                    turno.horas = form.cleaned_data['horas']
                    turno.mostrar = form.cleaned_data['mostrar']
                    turno.save(request)
                    log(u'Editar turno: %s - [%s]' % (turno, turno.id), request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        # elif action == 'delturno':
        #     try:
        #         turno = Turno.objects.get(pk=int(request.POST['id']))
        #         turno.status = False
        #         turno.save(request)
        #         return JsonResponse({"result": "ok"})
        #     except Exception as ex:
        #         transaction.set_rollback(True)
        #         return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar los datos."})

        elif action == 'actualizar_estudiantes_moodle':
            try:
                materia = Materia.objects.get(pk=request.POST['id'], status=True)
                if materia.coordinacion().id == 9:
                    tipourl = 2
                else:
                    tipourl = 1
                materia.crear_actualizar_estudiantes_curso(moodle, tipourl)
                log(u'Utiliza el boton Actualizar todos los estudiantes moodle %s' % (materia), request, "add")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar los datos."})

        elif action == 'actualizar_docentes_moodle':
            try:
                materia = Materia.objects.get(pk=request.POST['id'], status=True)
                tipourl = 1
                if materia.coordinacion().id == 9:
                    tipourl = 2
                    materia.crear_actualizar_docente_curso_admision(moodle, tipourl)
                else:
                    tipourl = 1
                    materia.crear_actualizar_docente_curso(moodle, tipourl)
                log(u'Utiliza el boton Actualizar docentes moodle %s' % (materia), request, "add")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al actualizar los datos."})

        elif action == 'actualizar_silabos_moodle':
            try:
                materia = Materia.objects.get(pk=request.POST['id'], status=True)
                materia.crear_actualizar_silabo_curso()
                if not materia.actualizarhtml:
                    materia.actualizarhtml = True
                    materia.save(request)
                crearhtmlphpmoodle(materia.id)
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al actualizar los datos."})

        elif action == 'actualizar_modelo_moodle':
            try:
                materia = Materia.objects.get(pk=request.POST['id'], status=True)
                materia.crear_actualizar_categoria_notas_curso()
                log(u'Utiliza el boton Actualizar modelo moodle %s' % (materia), request, "add")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al actualizar los datos."})

        elif action == 'actualizar_silabo_moodle':
            try:
                materia = Materia.objects.get(pk=request.POST['id'], status=True)
                materia.actualizarhtml = True
                materia.save(request)
                materia.actualizar_htmlsilabo_moodle()
                log(u'Utiliza el boton Actualizar silabo moodle %s' % (materia), request, "add")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al actualizar los datos."})

        elif action == 'listadoalumnosexportarmateriamoodlepos':
            try:
                materia = Materia.objects.get(pk=request.POST['idmateria'])
                listadocodigo = materia.materiaasignada_set.values_list('matricula__inscripcion__persona__idusermoodleposgrado', flat=True).filter(status=True)
                cursorpos = connections['moodle_pos'].cursor()
                if listadocodigo:
                    sql = """SELECT DISTINCT  ARRAY_TO_STRING(array_agg(us1.id),',')                                      
                             FROM mooc_role_assignments asi
                            INNER JOIN MOOC_CONTEXT CON ON asi.CONTEXTID=CON.ID
                            INNER JOIN mooc_user us1 ON us1.id=asi.userid
                            AND ASI.ROLEID=%s
                            AND CON.INSTANCEID=%s
                            AND us1.id in %s""" % (10, materia.idcursomoodle, tuple(listadocodigo))
                else:
                    return JsonResponse({"result": "ok", "cantidad": 0, "listagrupoexamenes": 0})
                cursorpos.execute(sql)
                listadosmoodle = []
                row = cursorpos.fetchall()
                if materia.idcursomoodle:
                    if row[0][0]:
                        listadosmoodle = row[0][0].split(",")
                listamatriculados = materia.materiaasignada_set.values('id', 'matricula__inscripcion__persona_id', 'matricula__inscripcion__persona__apellido1', 'matricula__inscripcion__persona__apellido2', 'matricula__inscripcion__persona__nombres').filter(status=True, retiramateria=False).exclude(matricula__inscripcion__persona__idusermoodleposgrado__in=listadosmoodle).order_by('matricula__inscripcion__persona__apellido1', 'matricula__inscripcion__persona__apellido2',
                                                                                                                                                                                                                                                                                                                                                                                               'matricula__inscripcion__persona__nombres')
                return JsonResponse({"result": "ok", "cantidad": len(listamatriculados), "listagrupoexamenes": list(listamatriculados)})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al aprobar."})

        elif action == 'listadoalumnosexportarmateriamoodlepre':
            try:
                materia = Materia.objects.get(pk=request.POST['idmateria'])
                listadocodigo = materia.materiaasignada_set.values_list('matricula__inscripcion__persona__idusermoodle', flat=True).filter(status=True)
                cursorpos = connections['moodle_db'].cursor()
                if listadocodigo:
                    sql = """SELECT DISTINCT  ARRAY_TO_STRING(array_agg(us1.id),',')                                      
                             FROM mooc_role_assignments asi
                            INNER JOIN MOOC_CONTEXT CON ON asi.CONTEXTID=CON.ID
                            INNER JOIN mooc_user us1 ON us1.id=asi.userid
                            AND ASI.ROLEID=%s
                            AND CON.INSTANCEID=%s
                            AND us1.id in %s""" % (10, materia.idcursomoodle, tuple(listadocodigo))
                else:
                    return JsonResponse({"result": "ok", "cantidad": 0, "listagrupoexamenes": 0})
                cursorpos.execute(sql)
                listadosmoodle = []
                row = cursorpos.fetchall()
                if materia.idcursomoodle:
                    if row[0][0]:
                        listadosmoodle = row[0][0].split(",")
                listamatriculados = materia.materiaasignada_set.values('id', 'matricula__inscripcion__persona_id', 'matricula__inscripcion__persona__apellido1', 'matricula__inscripcion__persona__apellido2', 'matricula__inscripcion__persona__nombres').filter(status=True, retiramateria=False).exclude(matricula__inscripcion__persona__idusermoodleposgrado__in=listadosmoodle).order_by('matricula__inscripcion__persona__apellido1', 'matricula__inscripcion__persona__apellido2',
                                                                                                                                                                                                                                                                                                                                                                                               'matricula__inscripcion__persona__nombres')
                return JsonResponse({"result": "ok", "cantidad": len(listamatriculados), "listagrupoexamenes": list(listamatriculados)})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al aprobar."})

        elif action == 'exportar_matriculados_moodle_posgrado':
            try:
                if request.POST['numcantidad'] == '0':
                    materia = Materia.objects.get(pk=request.POST['codigomateria'], status=True)
                    clave = ''
                    materia.crear_materia_categoria_notas_curso_posgrado(clave, 0, 0)
                    return JsonResponse({"result": "ok"})
                else:
                    materia = Materia.objects.get(pk=request.POST['codigomateria'], status=True)
                    idmateriaasignada = request.POST['inscritoexamen']
                    contador = int(request.POST['contador'])
                    clave = 'todo'
                    materia.crear_materia_categoria_notas_curso_posgrado(clave, idmateriaasignada, contador)
                    time.sleep(5)
                    if contador == 0:
                        log(u'Actualizo moodle posgrado: %s' % (materia), request, "edit")
                    return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al actualizar los datos."})

        elif action == 'crear_curso_pregrado':
            try:
                materia = Materia.objects.get(pk=request.POST['idmateria'], status=True)
                materia.crear_materia_categoria_notas_curso_pregrado()
                log(u'Crea curso a moodle pregrado: %s' % (materia), request, "edit")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al actualizar los datos."})

        elif action == 'actualizar_modelo_moodle_posgrado':
            try:
                materia = Materia.objects.get(pk=request.POST['id'], status=True)
                clave = request.POST['clave']
                if materia.idcursomoodle>0:
                    if clave == 'modelo':
                        materia.crear_actualizar_categoria_notas_curso()
                    elif clave == 'estudiante':
                        materia.crear_actualizar_estudiantes_curso_posgrado(moodle, 1)
                    elif clave == 'docente':
                        materia.crear_actualizar_docente_curso_posgrado(moodle, 1)
                    elif clave == 'silabo':
                        materia.crear_actualizar_silabo_curso_posgrado()
                elif clave == 'todo':
                    materia.crear_actualizar_categoria_notas_curso_posgrado(clave)
                log(u'Actualizo moodle posgrado: %s' % (materia), request, "edit")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al actualizar los datos."})

        elif action == 'reporte_horario_pdf':
            nivel = None
            mallaid = 0
            nivelmallaid = 0
            paraleloid = 0
            try:
                data['nivel'] = nivel = Nivel.objects.get(pk=int(encrypt(request.POST['idn'])))
                data['mallaid'] = mallaid = int(request.POST['mid']) if 'mid' in request.POST else 0
                data['nivelmallaid'] = nivelmallaid = int(request.POST['nmid']) if 'nmid' in request.POST else 0
                data['paraleloid'] = paraleloid = request.POST['pid'] if 'pid' in request.POST and not request.POST[
                                                                                                           'pid'] == '0' else 0
                if mallaid > 0:
                    data['malla'] = Malla.objects.get(pk=mallaid)
                if nivelmallaid > 0:
                    data['nivelmalla'] = NivelMalla.objects.get(pk=nivelmallaid)
                data['semanas'] = [[1, 'Lunes'], [2, 'Martes'], [3, 'Miércoles'], [4, 'Jueves'], [5, 'Viernes'],
                                   [6, 'Sábado'], [7, 'Domingo']]
                claseslunes = nivel.obtener_horario_materia_segun_dia(mallaid, nivelmallaid, paraleloid, 1)
                clasesmartes = nivel.obtener_horario_materia_segun_dia(mallaid, nivelmallaid, paraleloid, 2)
                clasesmiercoles = nivel.obtener_horario_materia_segun_dia(mallaid, nivelmallaid, paraleloid, 3)
                clasesjueves = nivel.obtener_horario_materia_segun_dia(mallaid, nivelmallaid, paraleloid, 4)
                clasesviernes = nivel.obtener_horario_materia_segun_dia(mallaid, nivelmallaid, paraleloid, 5)
                clasessabado = nivel.obtener_horario_materia_segun_dia(mallaid, nivelmallaid, paraleloid, 6)
                clasesdomingo = nivel.obtener_horario_materia_segun_dia(mallaid, nivelmallaid, paraleloid, 7)
                totalclaseslunes = claseslunes.count()
                totalclasesmartes = clasesmartes.count()
                totalclasesmiercoles = clasesmiercoles.count()
                totalclasesjueves = clasesjueves.count()
                totalclasesviernes = clasesviernes.count()
                totalclasessabado = clasessabado.count()
                totalclasesdomingo = clasesdomingo.count()
                numeromayor = totalclaseslunes
                if totalclasesmartes > numeromayor:
                    numeromayor = totalclasesmartes
                if totalclasesmiercoles > numeromayor:
                    numeromayor = totalclasesmiercoles
                if totalclasesjueves > numeromayor:
                    numeromayor = totalclasesjueves
                if totalclasesviernes > numeromayor:
                    numeromayor = totalclasesviernes
                if totalclasessabado > numeromayor:
                    numeromayor = totalclasessabado
                if totalclasesdomingo > numeromayor:
                    numeromayor = totalclasesdomingo
                contando = 0
                listaclases = []
                while contando < numeromayor:
                    aux = []
                    if contando < totalclaseslunes:
                        aux.append(claseslunes[contando])
                    else:
                        aux.append(None)
                    if contando < totalclasesmartes:
                        aux.append(clasesmartes[contando])
                    else:
                        aux.append(None)
                    if contando < totalclasesmiercoles:
                        aux.append(clasesmiercoles[contando])
                    else:
                        aux.append(None)
                    if contando < totalclasesjueves:
                        aux.append(clasesjueves[contando])
                    else:
                        aux.append(None)
                    if contando < totalclasesviernes:
                        aux.append(clasesviernes[contando])
                    else:
                        aux.append(None)
                    if contando < totalclasessabado:
                        aux.append(clasessabado[contando])
                    else:
                        aux.append(None)
                    if contando < totalclasesdomingo:
                        aux.append(clasesdomingo[contando])
                    else:
                        aux.append(None)
                    listaclases.append(aux)
                    contando += 1
                data['listaclases'] = listaclases
                return conviert_html_to_pdf('niveles/reporte_horario_pdf.html', {'pagesize': 'A4', 'data': data})
            except Exception as ex:
                return HttpResponseRedirect(
                    '/niveles?action=materias&id=%s&mallaid=%s&nivelmallaid=%s&paraleloid=%s&info=%s' % (
                        nivel.id, mallaid, nivelmallaid, paraleloid, 'Hubieron errores al generar el horario.'))

        elif action == 'reporte_horario_examen_pdf':
            nivel = None
            mallaid = 0
            nivelmallaid = 0
            paraleloid = 0
            try:
                data['detallemodeloevaluativo'] = detallemodeloevaluativo = DetalleModeloEvaluativo.objects.get(
                    pk=int(request.POST['idde']))
                data['nivel'] = nivel = Nivel.objects.get(pk=int(encrypt(request.POST['idn'])))
                data['mallaid'] = mallaid = int(request.POST['mid']) if 'mid' in request.POST else 0
                data['nivelmallaid'] = nivelmallaid = int(request.POST['nmid']) if 'nmid' in request.POST else 0
                data['paraleloid'] = paraleloid = request.POST['pid'] if 'pid' in request.POST and not request.POST[
                                                                                                           'pid'] == '0' else 0
                if mallaid > 0:
                    data['malla'] = Malla.objects.get(pk=mallaid)
                if nivelmallaid > 0:
                    data['nivelmalla'] = NivelMalla.objects.get(pk=nivelmallaid)
                data['semanas'] = [[1, 'Lunes'], [2, 'Martes'], [3, 'Miércoles'], [4, 'Jueves'], [5, 'Viernes'],
                                   [6, 'Sábado'], [7, 'Domingo']]
                claseslunes = nivel.obtener_horario_examen_segun_dia(mallaid, nivelmallaid, paraleloid, 1,
                                                                     detallemodeloevaluativo.id)
                clasesmartes = nivel.obtener_horario_examen_segun_dia(mallaid, nivelmallaid, paraleloid, 2,
                                                                      detallemodeloevaluativo.id)
                clasesmiercoles = nivel.obtener_horario_examen_segun_dia(mallaid, nivelmallaid, paraleloid, 3,
                                                                         detallemodeloevaluativo.id)
                clasesjueves = nivel.obtener_horario_examen_segun_dia(mallaid, nivelmallaid, paraleloid, 4,
                                                                      detallemodeloevaluativo.id)
                clasesviernes = nivel.obtener_horario_examen_segun_dia(mallaid, nivelmallaid, paraleloid, 5,
                                                                       detallemodeloevaluativo.id)
                clasessabado = nivel.obtener_horario_examen_segun_dia(mallaid, nivelmallaid, paraleloid, 6,
                                                                      detallemodeloevaluativo.id)
                clasesdomingo = nivel.obtener_horario_examen_segun_dia(mallaid, nivelmallaid, paraleloid, 7,
                                                                       detallemodeloevaluativo.id)
                totalclaseslunes = claseslunes.count()
                totalclasesmartes = clasesmartes.count()
                totalclasesmiercoles = clasesmiercoles.count()
                totalclasesjueves = clasesjueves.count()
                totalclasesviernes = clasesviernes.count()
                totalclasessabado = clasessabado.count()
                totalclasesdomingo = clasesdomingo.count()
                numeromayor = totalclaseslunes
                if totalclasesmartes > numeromayor:
                    numeromayor = totalclasesmartes
                if totalclasesmiercoles > numeromayor:
                    numeromayor = totalclasesmiercoles
                if totalclasesjueves > numeromayor:
                    numeromayor = totalclasesjueves
                if totalclasesviernes > numeromayor:
                    numeromayor = totalclasesviernes
                if totalclasessabado > numeromayor:
                    numeromayor = totalclasessabado
                if totalclasesdomingo > numeromayor:
                    numeromayor = totalclasesdomingo
                contando = 0
                listaclases = []
                while contando < numeromayor:
                    aux = []
                    if contando < totalclaseslunes:
                        aux.append(claseslunes[contando])
                    else:
                        aux.append(None)
                    if contando < totalclasesmartes:
                        aux.append(clasesmartes[contando])
                    else:
                        aux.append(None)
                    if contando < totalclasesmiercoles:
                        aux.append(clasesmiercoles[contando])
                    else:
                        aux.append(None)
                    if contando < totalclasesjueves:
                        aux.append(clasesjueves[contando])
                    else:
                        aux.append(None)
                    if contando < totalclasesviernes:
                        aux.append(clasesviernes[contando])
                    else:
                        aux.append(None)
                    if contando < totalclasessabado:
                        aux.append(clasessabado[contando])
                    else:
                        aux.append(None)
                    if contando < totalclasesdomingo:
                        aux.append(clasesdomingo[contando])
                    else:
                        aux.append(None)
                    listaclases.append(aux)
                    contando += 1
                data['listaclases'] = listaclases
                return conviert_html_to_pdf('niveles/reporte_horario_examen_pdf.html', {'pagesize': 'A4', 'data': data})
            except Exception as ex:
                return HttpResponseRedirect(
                    '/niveles?action=materias&id=%s&mallaid=%s&nivelmallaid=%s&paraleloid=%s&info=%s' % (
                        nivel.id, mallaid, nivelmallaid, paraleloid, 'Hubieron errores al generar el horario.'))

        elif action == 'listamodeloevaluativoexamen':
            try:
                listadetallemodelo = []
                nivel = Nivel.objects.get(pk=int(encrypt(request.POST['idn'])))
                mallaid = int(request.POST['mid']) if 'mid' in request.POST else 0
                nivelmallaid = int(request.POST['nmid']) if 'nmid' in request.POST else 0
                paraleloid = request.POST['pid'] if 'pid' in request.POST and not request.POST['pid'] == '0' else 0
                materias = nivel.nivel_materias(mallaid, nivelmallaid, paraleloid)
                detallesmodeloevaluativo = DetalleModeloEvaluativo.objects.filter(
                    modelo__materia__id__in=materias.values_list('id'), status=True, alternativa__id=20,
                    modelo__status=True).distinct()
                for detalles in detallesmodeloevaluativo:
                    listadetallemodelo.append([detalles.id.__str__(), detalles.__str__()])
                return JsonResponse({"result": "ok", 'lista': listadetallemodelo})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar los datos."})

        elif action == 'carrerascoordinacion':
            try:
                lista = []
                carreras = Carrera.objects.filter(coordinacion__id=request.POST['idc'])
                for carrera in carreras:
                    lista.append([carrera.id, carrera.__str__()])
                return JsonResponse({'result': 'ok', 'lista': lista})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos."})

        elif action == 'addperfilaccesousuario':
            try:
                form = PerfilAccesoUsuarioForm(request.POST)
                if form.is_valid():
                    for carrera in form.cleaned_data['carrera']:
                        if not PerfilAccesoUsuario.objects.values('id').filter(grupo=form.cleaned_data['grupo'],
                                                                               coordinacion=form.cleaned_data[
                                                                                   'coordinacion'],
                                                                               carrera=carrera).exists():
                            perfilacceso = PerfilAccesoUsuario(grupo=form.cleaned_data['grupo'],
                                                               coordinacion=form.cleaned_data['coordinacion'],
                                                               carrera=carrera)
                            perfilacceso.save(request)
                            log(u'Adiciono perfil acceso usuario: %s - %s - %s - [%s]' % (
                                perfilacceso.grupo, perfilacceso.coordinacion, perfilacceso.carrera, perfilacceso.id),
                                request, "add")
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'editperfilaccesousuario':
            try:
                form = PerfilAccesoUsuarioForm(request.POST)
                if form.is_valid():
                    perfilacceso = PerfilAccesoUsuario.objects.get(pk=int(encrypt(request.POST['id'])))
                    adicionarcarreras = Carrera.objects.filter(pk__in=form.cleaned_data['carrera']).exclude(pk__in=perfilacceso.carreras_grupos_perfil_acceso_usuario().values_list('id', flat=True)).distinct()
                    for carrera in adicionarcarreras:
                        perfilacceso = PerfilAccesoUsuario(grupo=perfilacceso.grupo,
                                                           coordinacion=perfilacceso.coordinacion, carrera=carrera)
                        perfilacceso.save(request)
                        log(u'Adiciono perfil acceso usuario: %s - %s - %s - [%s]' % (
                            perfilacceso.grupo, perfilacceso.coordinacion, perfilacceso.carrera, perfilacceso.id),
                            request,
                            "add")
                    eliminar_perfiles = perfilacceso.grupos_perfil_acceso_usuario().exclude(
                        carrera__in=form.cleaned_data['carrera'])
                    for eliminar_perfil in eliminar_perfiles:
                        log(u'Elimino perfil acceso usuario: %s - %s - %s - [%s]' % (
                            eliminar_perfil.grupo, eliminar_perfil.coordinacion, eliminar_perfil.carrera,
                            eliminar_perfil.id), request, "del")
                        eliminar_perfil.delete()
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'delperfilaccesousuario':
            try:
                perfilacceso = PerfilAccesoUsuario.objects.get(pk=int(encrypt(request.POST['id'])))
                for eliminar_perfil in perfilacceso.grupos_perfil_acceso_usuario():
                    log(u'Elimino perfil acceso usuario: %s - %s - %s - [%s]' % (
                        eliminar_perfil.grupo, eliminar_perfil.coordinacion, eliminar_perfil.carrera,
                        eliminar_perfil.id),
                        request, "del")
                    eliminar_perfil.delete()
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar los datos."})

        elif action == 'ingresofechaevaluacion':
            try:
                cadena = request.POST['listascodigos'].split(',')
                id_fini = request.POST['id_fini']
                id_ffin = request.POST['id_ffin']
                for elemento in cadena:
                    materia = Materia.objects.get(pk=elemento)
                    materia.inicioeval = id_fini
                    materia.fineval = id_ffin
                    materia.usaperiodoevaluacion = False
                    materia.save(request)
                log(u'Actualizó fecha de evaluacion en evaluacion en la materia %s' % (materia), request, "add")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": "Error al guardar los datos."})

        elif action == 'ingresofechaevaluacionauto':
            try:
                cadena = request.POST['listascodigos'].split(',')
                id_fini = request.POST['id_fini']
                id_ffin = request.POST['id_ffin']
                for elemento in cadena:
                    materia = Materia.objects.get(pk=elemento)
                    materia.inicioevalauto = id_fini
                    materia.finevalauto = id_ffin
                    materia.usaperiodoevaluacion = False
                    materia.save(request)
                log(u'Actualizó fecha de auto evaluacion en evaluacion en la materia %s' % (materia), request, "add")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": "Error al guardar los datos."})

        elif action == 'informeevaluacionipec':
            mensaje = "Problemas al generar el informe."
            try:
                materia = Materia.objects.get(pk=request.POST['idmat'])
                # preguntas = RubricaPreguntas.objects.filter(status=True, rubrica__proceso__periodo=periodo ,preguntacaracteristica__caracteristica__id__in =[62,63,64,65,66]).order_by('orden')
                cursor = connections['sga_select'].cursor()
                hoy = datetime.now().date()
                promedio_ponderacion = None
                sql = ""
                sql = "select tp.nombre, " \
                      " r.texto_nosatisfactorio, " \
                      " (select count(distinct re.id) from sga_detallerespuestarubrica drr, sga_respuestarubrica rr, sga_respuestaevaluacionacreditacion re " \
                      " where drr.status=true and drr.rubricapregunta_id=rp.id and drr.respuestarubrica_id=rr.id and rr.status=true and rr.respuestaevaluacion_id=re.id " \
                      " and re.status=true and re.materia_id=" + str(
                    request.POST['idmat']) + " and drr.valor=1) as cantidad_texto_nosatisfactorio, " \
                                             " r.texto_basico,  " \
                                             " (select count(distinct re.id) from sga_detallerespuestarubrica drr, sga_respuestarubrica rr, sga_respuestaevaluacionacreditacion re " \
                                             " where drr.status=true and drr.rubricapregunta_id=rp.id and drr.respuestarubrica_id=rr.id and rr.status=true and rr.respuestaevaluacion_id=re.id " \
                                             " and re.status=true and re.materia_id=" + str(
                    request.POST['idmat']) + " and drr.valor=2) as cantidad_texto_basico, " \
                                             " r.texto_competente,  " \
                                             " (select count(distinct re.id) from sga_detallerespuestarubrica drr, sga_respuestarubrica rr, sga_respuestaevaluacionacreditacion re " \
                                             " where drr.status=true and drr.rubricapregunta_id=rp.id and drr.respuestarubrica_id=rr.id and rr.status=true and rr.respuestaevaluacion_id=re.id " \
                                             " and re.status=true and re.materia_id=" + str(
                    request.POST['idmat']) + " and drr.valor=3) as cantidad_texto_competente, " \
                                             " r.texto_muycompetente, " \
                                             " (select count(distinct re.id) from sga_detallerespuestarubrica drr, sga_respuestarubrica rr, sga_respuestaevaluacionacreditacion re " \
                                             " where drr.status=true and drr.rubricapregunta_id=rp.id and drr.respuestarubrica_id=rr.id and rr.status=true and rr.respuestaevaluacion_id=re.id " \
                                             " and re.status=true and re.materia_id=" + str(
                    request.POST['idmat']) + " and drr.valor=4) as cantidad_texto_muycompetente, " \
                                             " r.texto_destacado, " \
                                             " (select count(distinct re.id) from sga_detallerespuestarubrica drr, sga_respuestarubrica rr, sga_respuestaevaluacionacreditacion re " \
                                             " where drr.status=true and drr.rubricapregunta_id=rp.id and drr.respuestarubrica_id=rr.id and rr.status=true and rr.respuestaevaluacion_id=re.id " \
                                             " and re.status=true and re.materia_id=" + str(
                    request.POST['idmat']) + " and drr.valor=5) as cantidad_texto_destacado,rp.orden " \
                                             " from sga_rubricapreguntas rp, sga_rubrica r, sga_procesoevaluativoacreditacion pe, sga_periodo p, sga_preguntacaracteristicaevaluacionacreditacion pce, " \
                                             " sga_caracteristicaevaluacionacreditacion cea, sga_textopreguntaacreditacion tp " \
                                             " where rp.status=true and rp.rubrica_id=r.id and rp.status=true and r.proceso_id=pe.id and pe.status=true " \
                                             " and pe.periodo_id=p.id and p.status=true and pce.id=rp.preguntacaracteristica_id and pce.status=true and pce.caracteristica_id=cea.id " \
                                             " and cea.status=true and cea.id in (62,63,64,65,66, 84, 85, 86) and pce.pregunta_id=tp.id and tp.status=true and p.id=" + str(
                    periodo.id) + " " \
                                  " order by rp.orden"
                result = cursor.execute(sql)
                preguntas = []
                total = 0
                cantidad_encuestado = materia.profesor_principal_pm().cantidad_evaluacion_docente()
                if result:
                    for p in result:
                        cantidadconstetada = p[2] + p[4] + p[6] + p[8] + p[10]
                        calculo1 = null_to_decimal(((p[2] * 100) / cantidadconstetada), 2)
                        calculo2 = null_to_decimal(((p[4] * 100) / cantidadconstetada), 2)
                        calculo3 = null_to_decimal(((p[6] * 100) / cantidadconstetada), 2)
                        calculo4 = null_to_decimal(((p[8] * 100) / cantidadconstetada), 2)
                        calculo5 = null_to_decimal(((p[10] * 100) / cantidadconstetada), 2)
                        suma_porcentaje = calculo1 + calculo2 + calculo3 + calculo4 + calculo5
                        preguntas.append(
                            [p[10], p[0], p[1], p[2], calculo1, p[3], p[4], calculo2, p[5], p[6], calculo3, p[7], p[8],
                             calculo4, p[9], p[10], calculo5, cantidadconstetada, suma_porcentaje])
                        # preguntas.append([p[10],p[0],p[1]])
                        # preguntas.append([p[10],p[0],p[1]])
                        # preguntas.append([p[10],p[0],p[1]])
                        # preguntas.append([p[10],p[0],p[1]])
                        ponderacion = ((p[2] * 1) + (p[4] * 2) + (p[6] * 3) + (p[8] * 4) + (
                                p[10] * 5)) / cantidad_encuestado
                        total += ponderacion
                    promedio_ponderacion = total / 12
                    cursor.close()
                return conviert_html_to_pdf('niveles/informeevaluacionipec.html',
                                            {'pagesize': 'A4',
                                             'materia': materia,
                                             'persona': persona,
                                             'hoy': hoy,
                                             'periodo': periodo,
                                             'preguntas': preguntas,
                                             'cantidad_encuestado': cantidad_encuestado,
                                             'promedio_ponderacion': promedio_ponderacion
                                             })
            except Exception as ex:
                return HttpResponseRedirect("/niveles?info=%s" % mensaje)

        elif action == 'informeevaluacionipecotro':
            mensaje = "Problemas al generar el informe."
            try:
                materia = Materia.objects.get(pk=request.POST['idmat'])
                # preguntas = RubricaPreguntas.objects.filter(status=True, rubrica__proceso__periodo=periodo ,preguntacaracteristica__caracteristica__id__in =[62,63,64,65,66]).order_by('orden')
                cursor = connections['sga_select'].cursor()
                hoy = datetime.now().date()
                promedio_ponderacion = None
                sql = ""
                # sql="select tp.nombre, " \
                #     " r.texto_nosatisfactorio, " \
                #     " (select count(distinct re.id) from sga_detallerespuestarubrica drr, sga_respuestarubrica rr, sga_respuestaevaluacionacreditacion re " \
                #     " where drr.status=true and drr.rubricapregunta_id=rp.id and drr.respuestarubrica_id=rr.id and rr.status=true and rr.respuestaevaluacion_id=re.id " \
                #     " and re.status=true and re.materia_id="+ str(request.POST['idmat']) +" and drr.valor=1) as cantidad_texto_nosatisfactorio, " \
                #     " r.texto_basico,  " \
                #     " (select count(distinct re.id) from sga_detallerespuestarubrica drr, sga_respuestarubrica rr, sga_respuestaevaluacionacreditacion re " \
                #     " where drr.status=true and drr.rubricapregunta_id=rp.id and drr.respuestarubrica_id=rr.id and rr.status=true and rr.respuestaevaluacion_id=re.id " \
                #     " and re.status=true and re.materia_id="+ str(request.POST['idmat']) +" and drr.valor=2) as cantidad_texto_basico, " \
                #     " r.texto_competente,  " \
                #     " (select count(distinct re.id) from sga_detallerespuestarubrica drr, sga_respuestarubrica rr, sga_respuestaevaluacionacreditacion re " \
                #     " where drr.status=true and drr.rubricapregunta_id=rp.id and drr.respuestarubrica_id=rr.id and rr.status=true and rr.respuestaevaluacion_id=re.id " \
                #     " and re.status=true and re.materia_id="+ str(request.POST['idmat']) +" and drr.valor=3) as cantidad_texto_competente, " \
                #     " r.texto_muycompetente, " \
                #     " (select count(distinct re.id) from sga_detallerespuestarubrica drr, sga_respuestarubrica rr, sga_respuestaevaluacionacreditacion re " \
                #     " where drr.status=true and drr.rubricapregunta_id=rp.id and drr.respuestarubrica_id=rr.id and rr.status=true and rr.respuestaevaluacion_id=re.id " \
                #     " and re.status=true and re.materia_id="+ str(request.POST['idmat']) +" and drr.valor=4) as cantidad_texto_muycompetente, " \
                #     " r.texto_destacado, " \
                #     " (select count(distinct re.id) from sga_detallerespuestarubrica drr, sga_respuestarubrica rr, sga_respuestaevaluacionacreditacion re " \
                #     " where drr.status=true and drr.rubricapregunta_id=rp.id and drr.respuestarubrica_id=rr.id and rr.status=true and rr.respuestaevaluacion_id=re.id " \
                #     " and re.status=true and re.materia_id="+ str(request.POST['idmat']) +" and drr.valor=5) as cantidad_texto_destacado,rp.orden " \
                #     " from sga_rubricapreguntas rp, sga_rubrica r, sga_procesoevaluativoacreditacion pe, sga_periodo p, sga_preguntacaracteristicaevaluacionacreditacion pce, " \
                #     " sga_caracteristicaevaluacionacreditacion cea, sga_textopreguntaacreditacion tp " \
                #     " where rp.status=true and rp.rubrica_id=r.id and rp.status=true and r.proceso_id=pe.id and pe.status=true " \
                #     " and pe.periodo_id=p.id and p.status=true and pce.id=rp.preguntacaracteristica_id and pce.status=true and pce.caracteristica_id=cea.id " \
                #     " and cea.status=true and cea.id in (62,63,64,65,66, 84, 85, 86) and pce.pregunta_id=tp.id and tp.status=true and p.id="+ str(periodo.id) +" " \
                #     " order by rp.orden"
                # result = cursor.execute(sql)
                preguntas = []
                total = 0

                rubricas = RespuestaRubrica.objects.values_list('rubrica_id').filter(
                    respuestaevaluacion__materia=materia, status=True).distinct()
                preguntasrubricas = RubricaPreguntas.objects.filter(rubrica__in=rubricas)
                # cantidad_encuestado= materia.profesor_principal_pm().cantidad_evaluacion_docente()
                # cantidad_encuestado = materia.respuestaevaluacionacreditacion_set.values('evaluador_id').filter(
                #     tipoinstrumento=1, status=True).distinct().count()
                # if result:
                #     for p in result:
                #         cantidadconstetada = p[2]+p[4]+p[6]+p[8]+p[10]
                #         calculo1 = null_to_decimal(((p[2]*100)/cantidadconstetada),2)
                #         calculo2 = null_to_decimal(((p[4] * 100) / cantidadconstetada), 2)
                #         calculo3 = null_to_decimal(((p[6] * 100) / cantidadconstetada), 2)
                #         calculo4 = null_to_decimal(((p[8] * 100) / cantidadconstetada), 2)
                #         calculo5 = null_to_decimal(((p[10] * 100) / cantidadconstetada), 2)
                #         suma_porcentaje = calculo1+calculo2+calculo3+calculo4+calculo5
                #         preguntas.append([p[10],p[0],p[1],p[2],calculo1,p[3],p[4],calculo2,p[5],p[6],calculo3,p[7],p[8],calculo4,p[9],p[10],calculo5,cantidadconstetada,suma_porcentaje])
                #         # preguntas.append([p[10],p[0],p[1]])
                #         # preguntas.append([p[10],p[0],p[1]])
                #         # preguntas.append([p[10],p[0],p[1]])
                #         # preguntas.append([p[10],p[0],p[1]])
                #         ponderacion = ((p[2]*1)+(p[4]*2)+(p[6]*3)+(p[8]*4)+(p[10]*5))/cantidad_encuestado
                #         total += ponderacion
                #     promedio_ponderacion = total/12
                #     cursor.close()
                return conviert_html_to_pdf('niveles/informeevaluacionipec.html',
                                            {'pagesize': 'A4',
                                             'materia': materia,
                                             'persona': persona,
                                             'hoy': hoy,
                                             'periodo': periodo,
                                             'preguntas': preguntasrubricas,
                                             'promedio_ponderacion': promedio_ponderacion
                                             })
            except Exception as ex:
                return HttpResponseRedirect("/niveles?info=%s" % mensaje)

        elif action == 'afinidad_malla':
            try:
                asignaturamallapreferencia = AsignaturaMallaPreferencia.objects.get(pk=request.POST['idp'])
                data['materia'] = asignaturamallapreferencia.asignaturamalla
                data['titulacion'] = Titulacion.objects.filter(persona=asignaturamallapreferencia.profesor.persona,
                                                               status=True, titulo__nivel__id=4).exclude(
                    titulo__grado__id=3).order_by('titulo__grado__id')
                data['title'] = u'Detalle Título'
                template = get_template("pro_cronograma/afinidad.html")
                json_content = template.render(data)
                return JsonResponse({"result": "ok", 'data': json_content})
            except Exception as ex:
                return JsonResponse({"result": "bad"})

        elif action == 'afinidad_publicaciones':
            try:
                # iditem
                asignaturamallapreferencia = AsignaturaMallaPreferencia.objects.get(pk=request.POST['idp'])
                data['materia'] = asignaturamallapreferencia.asignaturamalla
                data['titulacion'] = ArticuloInvestigacion.objects.select_related().filter(
                    participantesarticulos__profesor=asignaturamallapreferencia.profesor, status=True,
                    participantesarticulos__status=True).order_by('-fechapublicacion')
                data['title'] = u'Detalle de Publicaciones de investifación'
                template = get_template("pro_cronograma/afinidadpublicaciones.html")
                json_content = template.render(data)
                return JsonResponse({"result": "ok", 'data': json_content})
            except Exception as ex:
                return JsonResponse({"result": "bad"})

        elif action == 'comentarios_evaluaciones':
            try:
                # iditem
                data['asignatura'] = asignatura = Asignatura.objects.get(pk=request.POST['codigoasignatura'])
                data['evaluaciones'] = RespuestaEvaluacionAcreditacion.objects.filter(
                    materia__asignatura_id=request.POST['codigoasignatura'],
                    profesor_id=request.POST['codigoprofesor']).order_by('-fecha')
                data['title'] = u'Detalle de Publicaciones de investifación'
                template = get_template("pro_cronograma/evaluacionasignatura.html")
                json_content = template.render(data)
                return JsonResponse({"result": "ok", 'data': json_content})
            except Exception as ex:
                return JsonResponse({"result": "bad"})

        elif action == 'migrar_actividades_sakai':
            try:
                materia = Materia.objects.get(pk=request.POST['id'], status=True)
                materiasasignadas = materia.materiaasignada_set.filter(matricula__estado_matricula__in=[2, 3],
                                                                       matricula__nivel__periodo=periodo).order_by(
                    'matricula__inscripcion__persona')
                actividadguardada = None
                for materiaasignada in materiasasignadas:
                    # TAREAS
                    if periodo.usa_sakai:
                        tareas = materiaasignada.matricula.inscripcion.lista_tareas_por_asignatura(
                            materiaasignada.materia.codigosakai)
                        actividadguardada = None
                        for tarea in tareas:
                            id_tarea = tarea[0]
                            id_xml_tarea = tarea[1]
                            xmltext = minidom.parseString(id_xml_tarea)
                            itemlist = xmltext.getElementsByTagName("assignment")
                            nombre_tarea = (itemlist[0].getAttribute('title')).upper()
                            resultados_enviotarea = materiaasignada.matricula.inscripcion.envio_tarea(id_tarea,
                                                                                                      materiaasignada.materia.codigosakai)
                            scaled_grade = 0
                            puntos_posibles = 0
                            if resultados_enviotarea:
                                id_xml_tarea = resultados_enviotarea[0][6]
                                xmltext = minidom.parseString(id_xml_tarea)
                                itemlist = xmltext.getElementsByTagName("submission")
                                if itemlist[0].getAttribute('scaled_grade') != '':
                                    try:
                                        scaled_grade = null_to_decimal(
                                            int(itemlist[0].getAttribute('scaled_grade')) / 100)
                                    except Exception as ex:
                                        scaled_grade = 0
                            try:
                                puntos_posibles = materiaasignada.matricula.inscripcion.puntos_posibles_por_tarea(
                                    id_tarea, materiaasignada.materia.codigosakai)
                            except Exception as ex:
                                puntos_posibles = 0
                            if puntos_posibles.__len__() > 0 and not puntos_posibles == 0:
                                if not ActividadesSakaiAlumno.objects.filter(status=True, idactividadsakai=id_tarea,
                                                                             tipo=1,
                                                                             inscripcion=materiaasignada.matricula.inscripcion).exists():
                                    actividadguardada = ActividadesSakaiAlumno(
                                        inscripcion=materiaasignada.matricula.inscripcion,
                                        materia=materiaasignada.materia,
                                        idactividadsakai=id_tarea, xml=id_xml_tarea,
                                        nombreactividadsakai=nombre_tarea,
                                        tipo=1, nota=scaled_grade,
                                        notaposible=puntos_posibles[0][0] if puntos_posibles.__len__() > 0 else 0)
                                else:
                                    if scaled_grade:
                                        actividadguardada = \
                                            ActividadesSakaiAlumno.objects.filter(status=True,
                                                                                  idactividadsakai=id_tarea)[0]
                                        actividadguardada.nota = scaled_grade
                                        actividadguardada.notaposible = puntos_posibles[0][
                                            0] if puntos_posibles.__len__() > 0 else 0
                                if actividadguardada:
                                    actividadguardada.save(request)
                        # # FOROS
                        actividadguardada = None
                        for foro in materiaasignada.matricula.inscripcion.lista_foros_calificados_asignatura(
                                materiaasignada.materia.codigosakai):
                            id_foro = foro[0] if foro[1] else ""
                            titulo_topico = foro[1].strip() if foro[1] else ""
                            asigname_topico = foro[2].strip() if foro[2] else ""
                            titulo_foro = foro[3].strip() if foro[3] else ""
                            asigname_foro = foro[4].strip() if foro[4] else ""
                            try:
                                calificaciones = materiaasignada.matricula.inscripcion.calificacion_foro(
                                    materiaasignada.materia.codigosakai, asigname_topico, titulo_topico)
                            except Exception as ex:
                                calificaciones = None
                            if not calificaciones:
                                try:
                                    titulo_foro = titulo_foro.replace(u'.', '')
                                    calificaciones = materiaasignada.matricula.inscripcion.calificacion_foro(
                                        materiaasignada.materia.codigosakai, asigname_foro, titulo_foro)
                                except Exception as ex:
                                    calificaciones = None

                            try:
                                puntosposibles = materiaasignada.matricula.inscripcion.puntos_posibles_foro(
                                    materiaasignada.materia.codigosakai, asigname_topico, titulo_topico)
                            except Exception as ex:
                                puntosposibles = 0
                            if not puntosposibles:
                                try:
                                    titulo_foro = titulo_foro.replace(u'.', '')
                                    puntosposibles = materiaasignada.matricula.inscripcion.puntos_posibles_foro(
                                        materiaasignada.materia.codigosakai, asigname_foro, titulo_foro)
                                except Exception as ex:
                                    puntosposibles = 0
                            if puntosposibles[0][0] == 0:
                                return JsonResponse({"result": "bad",
                                                     "mensaje": u"Puntos posibles son o. %s" % materiaasignada.materia.nombre_completo()})
                            if not ActividadesSakaiAlumno.objects.filter(status=True, idactividadsakai=id_foro, tipo=2,
                                                                         inscripcion=materiaasignada.matricula.inscripcion).exists():
                                actividadguardada = ActividadesSakaiAlumno(
                                    inscripcion=materiaasignada.matricula.inscripcion,
                                    materia=materiaasignada.materia,
                                    idactividadsakai=id_foro,
                                    nombreactividadsakai=titulo_topico,
                                    tipo=2, nota=calificaciones[0][0] if calificaciones else 0,
                                    notaposible=puntosposibles[0][0] if puntosposibles.__len__() > 0 else 0)
                            else:
                                if id_foro:
                                    actividadguardada = \
                                        ActividadesSakaiAlumno.objects.filter(status=True, idactividadsakai=id_foro)[0]
                                    actividadguardada.nota = calificaciones[0][0] if calificaciones else 0
                                    actividadguardada.notaposible = puntosposibles[0][0] if puntosposibles else 0
                            if actividadguardada:
                                actividadguardada.save(request)
                        actividadguardada = None
                        # TEST
                        for test in materiaasignada.matricula.inscripcion.lista_test_asignatura(
                                materiaasignada.materia.codigosakai):
                            id_test = test[0]
                            nombre_test = test[1]
                            try:
                                nota = materiaasignada.matricula.inscripcion.calificacion_test(
                                    materiaasignada.materia.codigosakai, test[1])
                            except Exception as ex:
                                nota = None
                            try:
                                notaposible = materiaasignada.matricula.inscripcion.puntos_posibles_test(
                                    materiaasignada.materia.codigosakai, test[1])
                            except Exception as ex:
                                notaposible = None
                            if not ActividadesSakaiAlumno.objects.filter(status=True, idactividadsakai=id_test,
                                                                         inscripcion=materiaasignada.matricula.inscripcion,
                                                                         tipo=3).exists():
                                actividadguardada = ActividadesSakaiAlumno(
                                    inscripcion=materiaasignada.matricula.inscripcion,
                                    materia=materiaasignada.materia,
                                    idactividadsakai=id_test,
                                    nombreactividadsakai=nombre_test,
                                    tipo=3, nota=nota[0][0] if nota else 0,
                                    notaposible=notaposible[0][0] if notaposible else 0)
                            else:
                                if id_test:
                                    actividadguardada = \
                                        ActividadesSakaiAlumno.objects.filter(status=True, idactividadsakai=id_test)[0]
                                    actividadguardada.nota = nota[0][0] if nota else 0
                                    actividadguardada.notaposible = notaposible[0][0] if notaposible else 0
                            if actividadguardada:
                                actividadguardada.save(request)
                    elif periodo.usa_moodle:
                        materiaasignada.matricula.migrar_gestion_moodle_por_asignatura(periodo, materia)

                log(u'Migración de datos de actividades sakai: %s' % persona, request, "add")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Errtror al guardar los datos. %s %s" % (ex)})

        elif action == 'addobservacionseguimiento':
            try:
                form = ObservacionSeguimientoSemanalForm(request.POST)
                if form.is_valid():
                    silabosemanal = SilaboSemanal.objects.get(pk=int(encrypt(request.POST['silabosemanal'])))
                    if form.cleaned_data['observaciontecnica']:
                        silabosemanal.observaciontecnica = form.cleaned_data['observaciontecnica']
                    if form.cleaned_data['observacionacademica']:
                        silabosemanal.observacionacademica = form.cleaned_data['observacionacademica']
                    if form.cleaned_data['estadocumplimiento']:
                        silabosemanal.estadocumplimiento = form.cleaned_data['estadocumplimiento']
                    silabosemanal.personaobservacion = persona
                    silabosemanal.fechaobservacion = datetime.now().date()
                    silabosemanal.save(request)
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'silabopdf':
            try:
                silabo = Silabo.objects.get(pk=int(encrypt(request.POST['id'])), status=True)
                if silabo.materia.tipomateria == 2:
                    return conviert_html_to_pdf(
                        'pro_planificacion/silabo_virtual_pdf.html',
                        {
                            'pagesize': 'A4',
                            'data': silabo.silabo_virtual_pdf(),
                        }
                    )
                else:
                    return conviert_html_to_pdf(
                        'pro_planificacion/silabo_pdf.html',
                        {
                            'pagesize': 'A4',
                            'data': silabo.silabo_pdf(),
                        }
                    )
            except Exception as ex:
                pass

        elif action == 'addbibliografia':
            try:
                silabosemana = SilaboSemanal.objects.get(pk=int(request.POST['id']))
                if 'lista_items4' in request.POST:
                    bibliapa = [x['bibliografiaexterna'] for x in json.loads(request.POST['lista_items4'])]
                    for apa in bibliapa:
                        if not BibliograbiaAPASilabo.objects.filter(silabosemanal_id=silabosemana.id,
                                                                    bibliografia=apa).exists():
                            bapa = BibliograbiaAPASilabo(silabosemanal_id=silabosemana.id, bibliografia=apa)
                            bapa.save(request)
                            log(u'Adicionó Bibliografia Apa: %s al sílabo de la materia %s:' % (
                                bapa, bapa.silabosemanal.silabo.materia), request, "add")
                return JsonResponse({"result": "ok"}, )
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'editbibliografia':
            try:
                silabosemana = SilaboSemanal.objects.get(pk=int(request.POST['id']))
                if 'lista_items4' in request.POST:
                    bibliapa = [x['bibliografiaexterna'] for x in json.loads(request.POST['lista_items4'])]
                    for apa in bibliapa:
                        if not BibliograbiaAPASilabo.objects.filter(silabosemanal_id=silabosemana.id,
                                                                    bibliografia=apa).exists():
                            bapa = BibliograbiaAPASilabo(silabosemanal_id=silabosemana.id, bibliografia=apa)
                            bapa.save(request)
                            log(u'Adicionó Bibliografia Apa: %s al sílabo de la materia %s:' % (
                                bapa, bapa.silabosemanal.silabo.materia), request, "add")
                    if silabosemana.bibliograbiaapasilabo_set.all().exclude(bibliografia__in=bibliapa):
                        for apa in silabosemana.bibliograbiaapasilabo_set.all().exclude(bibliografia__in=bibliapa):
                            log(u'Eliminó Bibliografia Apa: %s del  sílabo de la materia %s:' % (
                                apa, apa.silabosemanal.silabo.materia), request, "del")
                        silabosemana.bibliograbiaapasilabo_set.all().exclude(bibliografia__in=bibliapa).delete()
                return JsonResponse({"result": "ok"}, )
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'editobjetivoact':
            try:
                if 'id' in request.POST and 'obj' in request.POST:
                    semana = SilaboSemanal.objects.get(status=True, pk=int(encrypt(request.POST['id'])))
                    semana.objetivoaprendizaje = request.POST['obj']
                    semana.save(request)
                    semana.modifico_silabo(persona, request)
                    log(u'Editó objetivo de aprendizaje de la semana de: %s' % semana, request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'editenfoqueact':
            try:
                if 'id' in request.POST and 'enf' in request.POST:
                    semana = SilaboSemanal.objects.get(status=True, pk=int(encrypt(request.POST['id'])))
                    semana.enfoque = request.POST['enf']
                    semana.save(request)
                    semana.modifico_silabo(persona, request)
                    log(u'Editó enfoque de evaluasion de la semana de: %s' % semana, request, "edit")
                    return JsonResponse({"result": "ok"})
                else:
                    raise
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        # editar objetivo aprendizaje
        elif action == 'editarobjetivoaprendizaje':
            try:
                silabosemana = SilaboSemanal.objects.get(pk=int(encrypt(request.POST['idso'])))
                objetivo = json.loads(request.POST['objetivo'])
                silabosemana.objetivoaprendizaje = objetivo
                silabosemana.save(request)
                # de rechazado pendiente
                silabosemana.modifico_silabo(persona, request)
                log(u'Editó Objetivo de Aprendizaje: %s' % silabosemana, request, "add")
                return JsonResponse({"result": "ok", "ids": encrypt(silabosemana.silabo.id)})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        # editar enfoque metodologico
        elif action == 'editenfoquemetodologico':
            try:
                silabosemana = SilaboSemanal.objects.get(pk=int(encrypt(request.POST['idse'])))
                enfoque = json.loads(request.POST['enfoque'])
                silabosemana.enfoque = enfoque
                silabosemana.save(request)
                # de rechazado pendiente
                silabosemana.modifico_silabo(persona, request)
                log(u'Editó Objetivo de Aprendizaje: %s' % silabosemana, request, "add")
                return JsonResponse({"result": "ok", "ids": encrypt(silabosemana.silabo.id)})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'avancedistributivo':
            try:
                data['title'] = u'Gráficas avance distributiivo'
                listadoperiodo = Periodo.objects.filter(pk=periodo.id, status=True)
                for lisper in listadoperiodo:
                    chart_data = []
                    listadodistributivomateriascoordinacion = Materia.objects.values_list(
                        'asignaturamalla__malla__carrera__coordinacion__id',
                        'asignaturamalla__malla__carrera__coordinacion__nombre').filter(nivel__periodo_id=lisper.id,
                                                                                        status=True).distinct().exclude(modeloevaluativo_id=27)
                    sumatoriacoordinacion = 0
                    sumatoriacoordinaciondoc = 0
                    sumatoriacoordinacionhorario = 0
                    sumatoriatotalcoordinacion = 0
                    sumatoriatotalcoordinacionhorario = 0
                    vecedividir = 0
                    for lista in listadodistributivomateriascoordinacion:
                        listaasignaturascoor = Materia.objects.values_list('id').filter(
                            asignaturamalla__malla__carrera__coordinacion__id=lista[0], nivel__periodo_id=lisper.id,
                            status=True).exclude(modeloevaluativo_id=27)
                        listaconprofesorcoor = ProfesorMateria.objects.values_list('materia_id').filter(
                            materia_id__in=listaasignaturascoor, status=True).distinct()
                        listaconhorariocoor = Clase.objects.values_list('materia_id').filter(
                            materia_id__in=listaasignaturascoor, status=True).distinct()

                        codigofacu = lista[0]
                        if codigofacu == 2 or codigofacu == 3:
                            sumatoriacoordinacion += listaasignaturascoor.count()
                            sumatoriacoordinaciondoc += listaconprofesorcoor.count()
                            sumatoriacoordinacionhorario += listaconhorariocoor.count()
                            vecedividir += 1
                        else:
                            campo2 = lista[1]
                            porcentajedocente = round(
                                (listaconprofesorcoor.count() * 100) / listaasignaturascoor.count(), 2)
                            porcentajehorario = round(
                                (listaconhorariocoor.count() * 100) / listaasignaturascoor.count(), 2)
                            chart_data.append([campo2, porcentajedocente, porcentajehorario])

                    sumatoriatotalcoordinacion = round(((sumatoriacoordinaciondoc * 100) / sumatoriacoordinacion), 2)
                    sumatoriatotalcoordinacionhorario = round(
                        ((sumatoriacoordinacionhorario * 100) / sumatoriacoordinacion), 2)
                    chart_data.append(
                        ['FACULTAD CIENCIAS SOCIALES, EDUCACION COMERCIAL Y DERECHO', sumatoriatotalcoordinacion,
                         sumatoriatotalcoordinacionhorario])
                chart_data
                add_titulo_reportlab(descripcion=lisper.nombre, tamano=16, espacios=19)
                add_titulo_reportlab(descripcion="PORCENTAJE POR FACULTAD DE AVANCE DISTRIBUTIVO DE DOCENTE Y HORARIO",
                                     tamano=12, espacios=19)
                add_tabla_reportlab(encabezado=[('Nº', 'FACULTAD', '% DOCENTE', '% HORARIO')],
                                    detalles=[(contador + 1, categoria[0], categoria[1], categoria[2]) for
                                              contador, categoria in enumerate(chart_data)],
                                    anchocol=[50, 300, 100, 100],
                                    cabecera_left_center=[True, False, True, True],
                                    detalle_left_center=[True, False, True, True])
                add_graficos_barras_reportlab(datavalor=[[categoria[1] for categoria in chart_data],
                                                         [categoriah[2] for categoriah in chart_data]],
                                              datanombres=[u'%s ' % categoria[0] for categoria in chart_data],
                                              anchografico=300, altografico=125, tamanoletra=6,
                                              posiciongrafico_x=200, posiciongrafico_y=30,
                                              titulo='PORCENTAJE', tamanotitulo=10, maximo=100,
                                              barra_vertical_horizontal=False, ubicaciontitulo_x=140,
                                              ubicaciontitulo_y=12, mostrarleyenda=False)
                return generar_pdf_reportlab()
            except Exception as ex:
                return HttpResponseRedirect("/niveles?info=%s" % 'Error al generar informe')

        elif action == 'editplanificacionsemanal':
            try:
                form = PlanificacionClaseSilaboForm(request.POST)
                if form.is_valid():
                    planificacion = PlanificacionClaseSilabo.objects.get(pk=int(encrypt(request.POST['id'])))
                    if form.cleaned_data['fechainicio'] > form.cleaned_data['fechafin']:
                        return JsonResponse(
                            {"result": "bad", "mensaje": u"La fecha de inicio debe ser menor a la fecha fin."})
                    # if int(form.cleaned_data['semana'])<1:
                    #     return JsonResponse({"result": "bad","mensaje": u"El Numero de Semana debe ser mayor a 0."})
                    if PlanificacionClaseSilabo.objects.filter(tipoplanificacion_id=planificacion.tipoplanificacion.id,
                                                               semana=form.cleaned_data['semana']).exclude(
                        pk=planificacion.id).exclude(semana=0).exists():
                        return JsonResponse({"result": "bad",
                                             "mensaje": u"El Numero de Semana ya a sido ingresado en está Planificación."})
                    if PlanificacionClaseSilabo.objects.filter(
                            Q(tipoplanificacion_id=planificacion.tipoplanificacion.id), (
                                    Q(fechainicio=form.cleaned_data['fechainicio']) | Q(
                                fechafin=form.cleaned_data['fechafin']))).exclude(pk=planificacion.id).exists():
                        return JsonResponse({"result": "bad",
                                             "mensaje": u"Las Fechas ingresadas ya existen en la Planificación Numero de Semana: %s" % planificacion.semana})
                    planificacion.fechainicio = form.cleaned_data['fechainicio']
                    planificacion.fechafin = form.cleaned_data['fechafin']
                    planificacion.semana = form.cleaned_data['semana']
                    planificacion.obejetivosemanal = form.cleaned_data['obejetivosemanal']
                    planificacion.save(request)
                    log(u'Edito la semana: %s de Planificación %s:' % (planificacion.semana, planificacion), request,
                        "add")
                    planificacion.ordenar(request)
                    return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'delplanificacionsemanal':
            try:
                planificacion = PlanificacionClaseSilabo.objects.get(pk=int(encrypt(request.POST['id'])))
                log(u'Eliminó la Planificación %s de la semana  %s' % (planificacion, planificacion.semana), request,
                    "del")
                idtipoplanificacion = planificacion.tipoplanificacion.id
                planificacion.delete()
                plani = PlanificacionClaseSilabo.objects.filter(tipoplanificacion_id=idtipoplanificacion)
                if plani:
                    plani[0].ordenar(request)
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'silaboposgradopdf':
            try:
                silabo = Silabo.objects.get(pk=int(encrypt(request.POST['id'])), status=True)
                return conviert_html_to_pdf(
                    'niveles/silabo_virtual_posgrado_pdf.html',
                    {
                        'pagesize': 'A4',
                        'data': silabo.silabo_virtual_posgrado_pdf(),
                    }
                )
            except Exception as ex:
                pass

        elif action == 'programanaliticoposgradopdf':
            try:
                if 'ban' in request.POST:
                    data['proanalitico'] = pro = ProgramaAnaliticoAsignatura.objects.get(
                        pk=int(encrypt(request.POST['id'])))
                else:
                    materia = Materia.objects.get(pk=int(encrypt(request.POST['id'])))
                    data['proanalitico'] = pro = ProgramaAnaliticoAsignatura.objects.get(
                        asignaturamalla=materia.asignaturamalla, status=True, activo=True)
                return conviert_html_to_pdf('mallas/programanaliticoposgrado_pdf.html',
                                            {
                                                'pagesize': 'A4',
                                                'data': pro.plananalitico_pdf(periodo)
                                            }
                                            )
            except Exception as ex:
                pass

        elif action == 'detalleaprobacion':
            try:
                data['silabo'] = silabo = Silabo.objects.get(pk=int(request.POST['id']))
                data['historialaprobacion'] = silabo.aprobarsilabo_set.filter(status=True).order_by('-id').exclude(
                    estadoaprobacion=variable_valor('PENDIENTE_SILABO'))
                data['aprobar'] = variable_valor('APROBAR_SILABO')
                data['rechazar'] = variable_valor('RECHAZAR_SILABO')
                data['pendiente'] = variable_valor('PENDIENTE_SILABO')
                template = get_template("niveles/detalleaprobacion.html")
                json_content = template.render(data)
                return JsonResponse({"result": "ok", 'data': json_content})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos."})

        elif action == 'detalleaprobaciondecano':
            try:
                data['silabo'] = silabo = Silabo.objects.get(pk=int(request.POST['id']))
                data['historialaprobacion'] = silabo.aprobarsilabodecano_set.filter(status=True).order_by(
                    '-id').exclude(estadoaprobacion=variable_valor('PENDIENTE_SILABO'))
                data['aprobar'] = variable_valor('APROBAR_SILABO')
                data['rechazar'] = variable_valor('RECHAZAR_SILABO')
                data['pendiente'] = variable_valor('PENDIENTE_SILABO')
                template = get_template("niveles/detalleaprobacion.html")
                json_content = template.render(data)
                return JsonResponse({"result": "ok", 'data': json_content})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos."})

        elif action == 'recalcular':
            try:
                cursor = connections['moodle_db'].cursor()
                periodo = Periodo.objects.get(pk=request.POST['id'])
                LogDeberes.objects.filter(periodo=periodo).delete()
                for materia in Materia.objects.filter(nivel__periodo=periodo, status=True, idcursomoodle__gt=0):
                    cursomoodle = materia.idcursomoodle
                    profesor = materia.profesor_principal()
                    estudiantes = materia.cantidad_matriculas_materia()
                    sql = "SELECT b.name, u.idnumber FROM mooc_assign AS b INNER JOIN mooc_assign_grades AS c ON c.ASSIGNMENT=b.id " \
                          " INNER JOIN mooc_user as u ON c.grader=u.id WHERE b.course=" + str(
                        cursomoodle) + " GROUP by b.name, u.idnumber"
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    cedula = ''
                    for r in results:
                        if cedula != str(r[1]):
                            cedula = str(r[1])
                            revisoraux = Persona.objects.filter(Q(cedula=str(r[1])) or Q(pasaporte=str(r[1])))
                            revisor = None
                            if revisoraux:
                                revisor = revisoraux[0]
                        sql1 = "SELECT TO_TIMESTAMP(c.timemodified) FROM mooc_assign AS b " \
                               " INNER JOIN mooc_assign_grades AS c ON c.ASSIGNMENT=b.id WHERE b.course=" + str(
                            cursomoodle) + " and b.name='" + str(r[0]) + "' order by b.name, c.timemodified"
                        cursor.execute(sql1)
                        resultaux = cursor.fetchall()
                        # esto me ayudara a sacar la desviacion estandar

                        cantidad = resultaux.__len__()
                        suma = 0
                        i = 0
                        acumulador = 0
                        minimo = 500
                        maximo = 0
                        arreglo = []
                        while i < cantidad - 1:
                            fecha = (resultaux[i][0]).date()
                            tiempo = resultaux[i][0]
                            tiemposiguiente = resultaux[i + 1][0]
                            i += 1
                            restar = (tiemposiguiente - tiempo).seconds
                            if restar <= 300:
                                acumulador = acumulador + restar
                            else:
                                restar = 300
                                acumulador = acumulador + restar
                            if minimo > restar:
                                minimo = restar
                            if maximo < restar:
                                maximo = restar
                            arreglo.append(restar)
                        # desviacionestandar = 0
                        # try:
                        #     desviacionestandar=int(round(stats.pstdev(arreglo),2))
                        # except:
                        #     raise
                        # # desviacionestandar=0

                        l = LogDeberes(periodo=periodo,
                                       profesor=profesor,
                                       revisor=revisor,
                                       materia=materia,
                                       deber=str(r[0]),
                                       estudiantes=estudiantes,
                                       tiempo=acumulador,
                                       tiempominimo=minimo,
                                       tiempomaximo=maximo,
                                       fecha=fecha)
                        l.save(request)

                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al calcular los rubros."})

        elif action == 'addfechas':
            try:
                ##AGREGAR FECHA DE HORARIO
                iddetalle = request.POST['detalle']
                fecha = convertir_fecha(request.POST['fecha'])
                materia = Materia.objects.get(pk=int(request.POST['materia']))
                materia.actualizarhtml = True
                materia.save()
                if not HorarioExamen.objects.filter(materia=materia, detallemodelo_id=int(iddetalle),
                                                    status=True).values('id').exists():
                    horarioexamen = HorarioExamen(materia=materia,
                                                  detallemodelo_id=int(iddetalle),
                                                  fecha=fecha,
                                                  turno_id=1)
                    horarioexamen.save(request)
                else:
                    horarioexamen = HorarioExamen.objects.filter(materia=materia, detallemodelo_id=int(iddetalle), status=True)[0]
                    horarioexamen.fecha = fecha
                    horarioexamen.save(request)
                # return JsonResponse({"result": "ok"})

                # Guardar el rango de horas
                # horarioexamen = HorarioExamen.objects.get(pk=request.POST['idhorariexamen'])
                fin = datetime.strptime(request.POST['horafin'], '%H:%M').time()
                inicio = datetime.strptime(request.POST['horaini'], '%H:%M').time()
                diferencia = timedelta(hours=fin.hour, minutes=fin.minute) - timedelta(hours=inicio.hour, minutes=inicio.minute)
                mensaje = u"El tiempo debe ser de "
                if horarioexamen.materia.nivel.modalidad.id <= 2 and not materia.nivel.coordinacion().pk == 1:
                    tiempo = timedelta(hours=1, minutes=15)
                    mensaje = f'{mensaje} una hora y quince minutos'
                elif horarioexamen.materia.nivel.modalidad.id == 3 and not materia.nivel.coordinacion().pk == 1:
                    tiempo = timedelta(hours=1, minutes=15)
                    mensaje = f'{mensaje} una hora y quince minutos'
                else:
                    tiempo = timedelta(hours=1, minutes=15)
                    mensaje = f'{mensaje} una hora y quince minutos'
                if diferencia == tiempo:
                    mensaje = u"Ya existe horario en la jornada ingresada"
                    horario = HorarioExamenDetalle.objects.filter(status=True, horarioexamen=horarioexamen, horarioexamen__materia=horarioexamen.materia)
                    if not horario.filter(tipogrupo=1).exists() and not horario.filter(horainicio=request.POST['horaini'], horafin=request.POST['horafin']).exists():
                        mensaje = u'No puede ingresar mas alumnos en este rango de horas, debe crear una nueva jornada con un rango de horas o fecha diferente'
                        aula = Aula.objects.get(id=int(request.POST['aula']))
                        if int(request.POST['cantalumnos']) > aula.capacidad and not aula.id==218:
                            raise NameError('La cantidad de alumnos de este curso sobrepasa la capacidad del aula, por favor elige otra aula')
                        if horarioexamen.maximo_por_hora(horarioexamen.fecha, inicio, fin, request.POST['cantalumnos']):
                            mensaje = u'Esta ingresando mas alumnos de los disponibles'
                            if horarioexamen.materia.ingreso_maximo_horario(horario=horarioexamen.pk) >= int(request.POST['cantalumnos']):
                                tipo = int(request.POST['tipo']) if 'tipo' in request.POST else None
                                fechasdocentes = HorarioExamenDetalle(horarioexamen=horarioexamen,
                                                                      # tipogrupo=request.POST['idgrupo'],
                                                                      horainicio=request.POST['horaini'],
                                                                      horafin=request.POST['horafin'],
                                                                      cantalumnos=request.POST['cantalumnos'],
                                                                      tiporesponsable=tipo,
                                                                      aula_id=int(request.POST['aula']))

                                rep = int(request.POST['pro']) if 'pro' in request.POST and not request.POST['pro'] == '' and not request.POST['pro'] == 'null' else None
                                if tipo == 1:
                                    fechasdocentes.profesormateria_id = rep
                                elif tipo == 2:
                                    fechasdocentes.profesor_id = rep
                                elif tipo == 3:
                                    fechasdocentes.administrativo_id = rep
                                fechasdocentes.save(request)
                                eAlumnos = MateriaAsignada.objects.filter(status=True, retiramateria=False, materia=materia, matricula__retiradomatricula=False, matricula__status=True).order_by('matricula__inscripcion__persona__apellido1', 'matricula__inscripcion__persona__apellido2', 'matricula__inscripcion__persona__nombres')
                                eAsignados = HorarioExamenDetalleAlumno.objects.filter(horarioexamendetalle__in=horario, status=True, materiaasignada__in=eAlumnos)
                                if eAsignados.values("id").exists():
                                    eAsignados.delete()
                                eAsignados = HorarioExamenDetalleAlumno.objects.filter(horarioexamendetalle__in=horario, status=True, materiaasignada__in=eAlumnos)
                                for eAlumno in eAlumnos.exclude(pk__in=eAsignados.values_list('materiaasignada_id', flat=True)):
                                    eHorarioExamenDetalleAlumno = HorarioExamenDetalleAlumno(materiaasignada=eAlumno, horarioexamendetalle=horario.first())
                                    eHorarioExamenDetalleAlumno.save(request)
                                    log(u'Adiciono alumno al Horario de examenes: %s' % eHorarioExamenDetalleAlumno, request, "add")
                                #transaction.set_rollback(True)
                                return JsonResponse({"result": "ok"})
                raise NameError(mensaje)
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": ex.__str__()})

        elif action == 'editfechas':
            try:
                ##BUSCAR FECHA DE HORARIO
                fecha = convertir_fecha(request.POST['fecha'])
                iddetalle = request.POST['detalle']
                materia = Materia.objects.get(pk=int(request.POST['materia']))
                #profesormateria = ProfesorMateria.objects.filter(status=True, profesor=profesor, materia=materia)[0]
                #horarioexamen = materia.horarioexamen_set.filter(detallemodelo_id=int(iddetalle), status=True, pk='33411')[0]
                horarioexamen = materia.horarioexamen_set.get(pk=int(request.POST['idhorariexamen']))

                # Guardar el rango de horas
                fin = datetime.strptime(request.POST['horafin'], '%H:%M').time()
                inicio = datetime.strptime(request.POST['horaini'], '%H:%M').time()
                diferencia = timedelta(hours=fin.hour, minutes=fin.minute) - timedelta(hours=inicio.hour, minutes=inicio.minute)
                mensaje = u"El tiempo debe ser de "
                if horarioexamen.materia.nivel.modalidad.id <= 2 and not materia.nivel.coordinacion().pk == 1:
                    tiempo = timedelta(hours=1, minutes=15)
                    mensaje = f'{mensaje} una hora y quince minutos'
                elif horarioexamen.materia.nivel.modalidad.id == 3 and not materia.nivel.coordinacion().pk == 1:
                    tiempo = timedelta(hours=1, minutes=15)
                    mensaje = f'{mensaje} una hora y quince minutos'
                else:
                    tiempo = timedelta(hours=1, minutes=15)
                    mensaje = f'{mensaje} una hora y quince minutos'
                if diferencia == tiempo:
                    mensaje = u"Ya existe horario en la jornada ingresada"
                    horario = HorarioExamenDetalle.objects.filter(status=True, horarioexamen=horarioexamen)
                    # if not horario.exists():
                    #     horario = HorarioExamenDetalle(horarioexamen=horarioexamen, profesormateria=profesormateria,
                    #                                    aula=materia.aulas[0])
                    #     horario.save(request)
                    #     horario = HorarioExamenDetalle.objects.filter(status=True, horarioexamen=horarioexamen)
                    if not horario.filter(tipogrupo=1).exclude(id=horario.first().id).exists() \
                            and not horario.filter(horainicio=request.POST['horaini'], horafin=request.POST['horafin'], horarioexamen__fecha=fecha).exclude(id=horario.first().id).exists():
                        # mensaje = u'No puede ingresar mas alumnos en este rango de horas, debe crear una nueva jornada con un rango de horas o fecha diferente'
                        aula = Aula.objects.filter(id=int(request.POST['aula'])).first()
                        # # editar fecha de cabecera de examen
                        # mensaje = u'Esta ingresando mas alumnos de los disponibles'
                        horarioexamen.fecha = fecha
                        horarioexamen.save(request)
                        #editar detalle de horario de examen con rango de fechas

                        tipo = int(request.POST['tipo']) if 'tipo' in request.POST else None
                        fechasdocentes = horario.first()
                        fechasdocentes.aula = aula
                        fechasdocentes.horainicio=request.POST['horaini']
                        fechasdocentes.horafin=request.POST['horafin']
                        rep = int(request.POST['pro']) if 'pro' in request.POST and not request.POST['pro'] == '' and not request.POST['pro'] == 'null' else None
                        fechasdocentes.tiporesponsable = tipo
                        if tipo == 1:
                            fechasdocentes.administrativo_id = None
                            fechasdocentes.profesormateria_id = rep
                            fechasdocentes.profesor_id = None
                        elif tipo == 2:
                            fechasdocentes.profesormateria_id = None
                            fechasdocentes.administrativo_id = None
                            fechasdocentes.profesor_id = rep
                        elif tipo == 3:
                            fechasdocentes.profesor_id = None
                            fechasdocentes.profesormateria_id = None
                            fechasdocentes.administrativo_id = rep
                        fechasdocentes.save(request)
                        log(u'Edito Horario de examenes: %s' % fechasdocentes, request, "edit")
                        eAlumnos = MateriaAsignada.objects.filter(status=True, retiramateria=False, materia=materia, matricula__retiradomatricula=False, matricula__status=True).order_by('matricula__inscripcion__persona__apellido1', 'matricula__inscripcion__persona__apellido2', 'matricula__inscripcion__persona__nombres')
                        eAsignados = HorarioExamenDetalleAlumno.objects.filter(horarioexamendetalle__in=horario, status=True, materiaasignada__in=eAlumnos)
                        if eAsignados.values("id").exists():
                            eAsignados.delete()
                        eAsignados = HorarioExamenDetalleAlumno.objects.filter(horarioexamendetalle__in=horario, status=True, materiaasignada__in=eAlumnos)
                        for eAlumno in eAlumnos.exclude(pk__in=eAsignados.values_list('materiaasignada_id', flat=True)):
                                    eHorarioExamenDetalleAlumno = HorarioExamenDetalleAlumno(materiaasignada=eAlumno, horarioexamendetalle=horario.first())
                                    eHorarioExamenDetalleAlumno.save(request)
                                    log(u'Adiciono alumno al Horario de examenes: %s' % eHorarioExamenDetalleAlumno, request, "add")
                        return JsonResponse({"result": "ok"})
                    transaction.set_rollback(True)
                return JsonResponse({"result": "bad", 'mensaje': str(mensaje)})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": "Error al guardar los datos."})

        elif action == 'detalle_estudiantes':
            try:
                data['profesor'] = profesor = Profesor.objects.get(pk=int(request.POST['idprofesor']))
                data['estudiantes'] = Inscripcion.objects.filter(status=True, matricula__estado_matricula__in=[2, 3],
                                                                 matricula__materiaasignada__soporteacademicotutor__periodo=periodo,
                                                                 matricula__materiaasignada__soporteacademicotutor__tutor=profesor).order_by(
                    'carrera').distinct()
                template = get_template("niveles/detalle.html")
                json_content = template.render(data)
                return JsonResponse({"result": "ok", 'html': json_content})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos."})

        elif action == 'subirarchivo':
            try:
                f = SubirArchivoForm(request.POST, request.FILES)
                periodo_id = request.POST['idperiodo']
                newfiles = None
                if 'archivo' in request.FILES:
                    d = request.FILES['archivo']
                    if d.size > 10485760:
                        return JsonResponse({"result": "bad", "mensaje": u"Error, archivo mayor a 10 Mb."})
                    newfiles = request.FILES['archivo']
                    newfilesd = newfiles._name
                    ext = newfilesd[newfilesd.rfind("."):]
                    # extension = newfilesd._name.split('.')
                    # tam = len(extension)
                    # ext = extension[tam - 1]
                    if ext != '.xls' and ext != '.xlsx':
                        return JsonResponse({"result": "bad", "mensaje": u"Error, solo archivos .xls, .xlsx"})
                else:
                    return JsonResponse({"result": "bad", "mensaje": u"Seleccione un Archivo."})
                workbook = xlrd.open_workbook(newfiles.name)
                sheet = workbook.sheet_by_index(0)
                n = 1
                bandera = 0
                bandera2 = 0
                nprofesores = ""
                npersonas = ""
                for rowx in range(sheet.nrows):
                    row = sheet.row_values(rowx)
                    if n > 1:
                        nprofesor = row[0]
                        napellido1 = nprofesor.split(" ")[0].strip()
                        napellido2 = nprofesor.split(" ")[1].strip()
                        nnombres = nprofesor.split(" ")[2].strip() + " " + nprofesor.split(" ")[3].strip()
                        persona = Persona.objects.filter(apellido1=napellido1, apellido2=napellido2, nombres=nnombres,
                                                         status=True).exclude(cedula='0')
                        if persona:
                            profesor = Profesor.objects.filter(persona=persona[0])
                            if profesor:
                                profesor1 = profesor[0]
                                if SoporteAcademicoTutor.objects.filter(periodo_id=periodo_id,
                                                                        tutor=profesor1).exists():
                                    SoporteAcademicoTutor.objects.filter(periodo_id=periodo_id,
                                                                         tutor=profesor1).delete()
                            else:
                                bandera = 1
                                nprofesores = nprofesores + nprofesor + ","
                        else:
                            bandera2 = 1
                            npersonas = npersonas + nprofesor + ","
                    n = n + 1
                if bandera2 == 1:
                    return JsonResponse({"result": "bad", "mensaje": u"No existen estas personas %s." % npersonas})
                if bandera == 1:
                    return JsonResponse({"result": "bad", "mensaje": u"No existen estos profesores %s." % nprofesores})

                # guardar
                n = 1
                for rowx in range(sheet.nrows):
                    row = sheet.row_values(rowx)
                    if n > 1:
                        nprofesor = row[0]
                        napellido1 = nprofesor.split(" ")[0].strip()
                        napellido2 = nprofesor.split(" ")[1].strip()
                        nnombres = nprofesor.split(" ")[2].strip() + " " + nprofesor.split(" ")[3].strip()
                        persona = Persona.objects.filter(apellido1=napellido1, apellido2=napellido2, nombres=nnombres,
                                                         status=True).exclude(cedula='0')
                        if persona:
                            profesor = Profesor.objects.filter(persona=persona[0])
                            if profesor:
                                idprofesor = profesor[0].id
                                idmatricula = int(row[1])
                                for materias in MateriaAsignada.objects.filter(status=True, matricula__id=idmatricula):
                                    bandera = 1
                                    s = SoporteAcademicoTutor(periodo_id=periodo_id,
                                                              tutor_id=idprofesor,
                                                              materiaasignada=materias)
                                    s.save(request)
                    n = n + 1
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'deletehora':
            try:
                detallehora = HorarioExamenDetalle.objects.get(pk=request.POST['id'])
                detallehora.horarioexamen.delete()
                detallehora.delete()
                res_json = {"error": False}
                #return JsonResponse({"result": "ok"})
            except Exception as ex:
                # transaction.set_rollback(True)
                # return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})
                res_json = {'error': True, "message": "Error: {}".format(ex)}
            return JsonResponse(res_json, safe=False)

        elif action == 'deletecabhorario':
            try:
                cabhorario = HorarioExamen.objects.get(pk=request.POST['id'])
                cabhorario.delete()
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'addsubirnotas':
            try:
                f = MateriaArchivoNotasForm(request.POST, request.FILES)
                materia = None
                if 'materia_id' in request.POST:
                    materia = Materia.objects.get(pk=int(request.POST['materia_id']))

                if not materia:
                    return JsonResponse({"result": "bad", "mensaje": u"Error, no se encontro la materia."})

                if materia:
                    if materia.cerrado:
                        return JsonResponse({"result": "bad", "mensaje": u"Error, materia se encuentra cerrada."})

                if 'archivo' in request.FILES:
                    d = request.FILES['archivo']
                    if d.size > 10485760:
                        return JsonResponse({"result": "bad", "mensaje": u"Error, archivo mayor a 10 Mb."})
                    newfiles = request.FILES['archivo']
                    newfilesd = newfiles._name
                    ext = newfilesd[newfilesd.rfind("."):]
                    if ext != '.xls' and ext != '.xlsx':
                        return JsonResponse({"result": "bad", "mensaje": u"Error, solo archivos .xls, .xlsx"})
                if f.is_valid():
                    if 'archivo' in request.FILES:
                        newfile = request.FILES['archivo']
                        newfile._name = generar_nombre("archivonotas_", newfile._name)
                    if MateriaArchivoNotas.objects.filter(status=True, descripcion=f.cleaned_data['descripcion'],
                                                          materia=materia).exists():
                        return JsonResponse({"result": "bad", "mensaje": u"La descripcion ya existe."})
                    if not f.cleaned_data['criteriomodeloevaluativo']:
                        return JsonResponse(
                            {"result": "bad", "mensaje": u"Debe seleccionar al menos un criterio a validar"})
                    archivonotas = MateriaArchivoNotas(descripcion=f.cleaned_data['descripcion'],
                                                       observacion=f.cleaned_data['observacion'],
                                                       archivo=newfile,
                                                       materia=materia)
                    archivonotas.save(request)
                    for data in f.cleaned_data['criteriomodeloevaluativo']:
                        archivonotas.criteriovalidar.add(data)
                    log(u'Adiciono Materia Archivo Notas: %s' % archivonotas, request, "add")
                    return JsonResponse({"result": "ok", "mensaje": u"Archivo guardado correctamente"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'editsubirnotas':
            try:
                materia = None
                if 'materia_id' in request.POST:
                    materia = Materia.objects.get(pk=int(request.POST['materia_id']))

                if not materia:
                    return JsonResponse({"result": "bad", "mensaje": u"Error, no se encontro la materia."})

                if materia:
                    if materia.cerrado:
                        return JsonResponse({"result": "bad", "mensaje": u"Error, materia se encuentra cerrada."})

                archivonotas = MateriaArchivoNotas.objects.get(pk=request.POST['id'])
                f = MateriaArchivoNotasForm(request.POST, request.FILES)
                if 'archivo' in request.FILES:
                    d = request.FILES['archivo']
                    if d.size > 10485760:
                        return JsonResponse({"result": "bad", "mensaje": u"Error, archivo mayor a 10 Mb."})
                    newfiles = request.FILES['archivo']
                    newfilesd = newfiles._name
                    ext = newfilesd[newfilesd.rfind("."):]
                    if ext != '.xls' and ext != '.xlsx':
                        return JsonResponse({"result": "bad", "mensaje": u"Error, solo archivos .xls, .xlsx"})
                if f.is_valid():
                    if MateriaArchivoNotas.objects.filter(status=True,
                                                          descripcion=f.cleaned_data['descripcion']).exclude(
                        pk=archivonotas.id).exists():
                        return JsonResponse({"result": "bad", "mensaje": u"La descripcion ya existe."})
                    if not f.cleaned_data['criteriomodeloevaluativo']:
                        return JsonResponse(
                            {"result": "bad", "mensaje": u"Debe seleccionar al menos un criterio a validar"})
                    archivonotas.descripcion = f.cleaned_data['descripcion']
                    archivonotas.observacion = f.cleaned_data['observacion']
                    if 'archivo' in request.FILES:
                        newfile = request.FILES['archivo']
                        newfile._name = generar_nombre("archivonotas_", newfile._name)
                        archivonotas.archivo = newfile
                    archivonotas.save(request)
                    archivonotas.criteriovalidar.clear()
                    for data in f.cleaned_data['criteriomodeloevaluativo']:
                        archivonotas.criteriovalidar.add(data)
                    log(u'Modifico Materia Archivo Notas: %s' % archivonotas, request, "edit")
                    return JsonResponse({"result": "ok", "mensaje": u"Archivo modificado correctamente"})
                else:
                    raise NameError('Error')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'deletesubirnotas':
            try:
                archivonotas = MateriaArchivoNotas.objects.get(pk=request.POST['id'])
                archivonotas.estado = 3
                archivonotas.status = False
                archivonotas.save(request)
                log(u'Elimino materia archivo de notas: %s' % archivonotas, request, "del")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar los datos."})

        elif action == 'alu_tomando_materia':
            try:
                data['title'] = u'Tomando la materia'
                data['materia'] = materia = Materia.objects.get(pk=request.POST['id'])
                data['materiasasignadas'] = materia.materiaasignada_set.filter(matricula__status=True).order_by('matricula__inscripcion__persona')
                template = get_template("niveles/materia_archivo_notas/alu_tomandomateria.html")
                json_content = template.render(data)
                return JsonResponse({"result": "ok", 'html': json_content})
            except Exception as ex:
                pass

        elif action == 'processSubjectGrades':
            try:
                archivonotas = MateriaArchivoNotas.objects.get(pk=request.POST['id'])
                for obs in archivonotas.observacionmateriaarchivonotas_set.filter(status=True):
                    obs.status = False
                    obs.save(request)

                nombre = archivonotas.archivo.file.name
                workbook = load_workbook(nombre)
                sheet = workbook._sheets[0]
                # listaactas = []
                linealectura = 0
                # linea = 1
                errorfichero = False
                criteriovalidar = archivonotas.criteriovalidar.all()
                criterios = []
                criteriosX = []
                criterios.append('ID')
                for criterio in criteriovalidar:
                    criterios.append(criterio.nombre)
                # print(criterios)
                cCri = 0
                for rowx in sheet.rows:
                    linealectura += 1
                    iCell = 0
                    iCell = 0
                    if linealectura == 1:
                        for criterio in criterios:
                            iCell = 0
                            for cell in rowx:
                                iCell += 1
                                if cell.value != None:
                                    if criterio.upper().strip() == (cell.value).upper().strip():
                                        criteriosX.append(iCell)
                                        cCri += 1
                    else:
                        break
                # print(criteriosX)
                if cCri != len(criterios) or cCri != len(criteriosX):
                    oObservacionMateria = ObservacionMateriaArchivoNotas(archivonotas=archivonotas,
                                                                         observacion='No se encontro los criterios a validar [%s]' % (
                                                                             ", ".join(criterios)))
                    oObservacionMateria.save(request)
                    errorfichero = True

                row = 0
                for rowx in sheet.rows:
                    row += 1
                    if row > 1:
                        print(rowx)
                        for iColumn in range(len(criteriosX)):
                            column = criteriosX[iColumn]
                            valor = sheet.cell(row=row, column=column).value
                            if valor != None:
                                if criterios[iColumn] == 'ID':
                                    if not MateriaAsignada.objects.filter(pk=valor).exists():
                                        oObservacionMateria = ObservacionMateriaArchivoNotas(archivonotas=archivonotas,
                                                                                             observacion='No se encontro el ID [%s] en la materia, error en la fila %s' % (valor, row))
                                        oObservacionMateria.save(request)
                                        errorfichero = True
                                    else:
                                        materiasignada = MateriaAsignada.objects.get(pk=valor)
                                        if materiasignada.materia.id != archivonotas.materia.id:
                                            oObservacionMateria = ObservacionMateriaArchivoNotas(archivonotas=archivonotas,
                                                                                                 observacion='Alumno no se encuentra en materia ID [%s], error en la fila %s' % (valor, row))
                                            oObservacionMateria.save(request)
                                            errorfichero = True
                                else:
                                    if float(valor) < 0:
                                        oObservacionMateria = ObservacionMateriaArchivoNotas(archivonotas=archivonotas,
                                                                                             observacion='Nota minima debe ser mayor a cero, el valor: %s, error en la fila %s' % (valor, row))
                                        oObservacionMateria.save(request)
                                        errorfichero = True
                if errorfichero:
                    data['observaciones'] = archivonotas.observacionmateriaarchivonotas_set.filter(status=True)
                    template = get_template("niveles/materia_archivo_notas/observaciones.html")
                    json_content = template.render(data)
                    archivonotas.estado = 4
                    archivonotas.save(request)
                    log(u'Proceso materia archivo de notas: %s' % archivonotas, request, "edit")
                    return JsonResponse({"result": "ok", "obs": True, "html": json_content})

                row = 0
                for rowx in sheet.rows:
                    row += 1
                    if row > 1:
                        print(rowx)
                        materiasignada = None
                        for iColumn in range(len(criteriosX)):
                            column = criteriosX[iColumn]
                            valor = sheet.cell(row=row, column=column).value
                            if valor != None:
                                if criterios[iColumn] == 'ID':
                                    materiasignada = MateriaAsignada.objects.get(pk=valor)
                                else:
                                    detalleCriterio = archivonotas.materia.modeloevaluativo.detallemodeloevaluativo_set.filter(nombre=criterios[iColumn])[0]
                                    if materiasignada:
                                        evaluacion_generica = materiasignada.evaluaciongenerica_set.filter(detallemodeloevaluativo=detalleCriterio)[0]
                                        if evaluacion_generica:
                                            if not evaluacion_generica.valor == valor:
                                                evaluacion_generica.valor = valor if isinstance(valor, float) else float(valor)
                                                evaluacion_generica.save(request)
                                                materiasignada.actualiza_notafinal()
                                                auditorianotas = AuditoriaNotas(evaluaciongenerica=evaluacion_generica,
                                                                                manual=False, calificacion=valor)
                                                auditorianotas.save(request)
                                        else:
                                            evaluacion = EvaluacionGenerica(materiaasignada=materiasignada,
                                                                            detallemodeloevaluativo=detalleCriterio,
                                                                            valor=valor)
                                            evaluacion.save(request)
                                            materiasignada.actualiza_notafinal()
                                            auditorianotas = AuditoriaNotas(evaluaciongenerica=evaluacion, manual=False,
                                                                            calificacion=valor)
                                            auditorianotas.save(request)
                archivonotas.estado = 2
                archivonotas.save(request)
                log(u'Proceso materia archivo de notas: %s' % archivonotas, request, "edit")
                return JsonResponse({"result": "ok", "obs": False})

            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'addsubirmatriz':
            try:
                if My_SubirMatrizInscripcion.objects.filter(periodo=periodo, estado__in=[1, 2, 3]).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"Error, En el periodo académico %s se encuentra un registro en estado [PENDIENTE, PROCESADO, ERROR]." % periodo.nombre})
                form = SubirMatrizInscripcionForm(request.POST)
                # form = SubirMatrizInscripcionForm(request.POST, request.FILES)
                # if not 'archivo' in request.FILES:
                #     return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro ningun archivo a procesar" % periodo.nombre})
                # d = request.FILES['archivo']
                # if d.size > 20000000:
                #     return JsonResponse({"result": "bad", "mensaje": u"Error, archivo mayor a 20 Mb."})
                # newfiles = request.FILES['archivo']
                # newfilesd = newfiles._name
                # ext = newfilesd[newfilesd.rfind("."):]
                # if ext != '.xls' and ext != '.xlsx':
                #     return JsonResponse({"result": "bad", "mensaje": u"Error, solo archivos .xls, .xlsx"})
                if not form.is_valid():
                    for k, v in form.errors.items():
                        raise NameError(v[0])
                # if 'archivo' in request.FILES:
                #     newfile = request.FILES['archivo']
                #     newfile._name = generar_nombre("matrizsenescyt_", newfile._name)
                if My_SubirMatrizInscripcion.objects.filter(status=True, descripcion=form.cleaned_data['descripcion'], periodo=periodo).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"La descripcion ya existe."})
                subirMatriz = My_SubirMatrizInscripcion(descripcion=form.cleaned_data['descripcion'],
                                                        observacion=form.cleaned_data['observacion'],
                                                        # archivo=newfile,
                                                        periodo=periodo,
                                                        proceso=form.cleaned_data['proceso'],
                                                        periodo_id_sag=form.cleaned_data['periodo_id_sag'],
                                                        )
                subirMatriz.save(request)
                # criterios_obligatorios = My_CriterioSubirMatrizInscripcion.objects.filter(is_obligatorio=True, status=True)
                # criterios = criterios_obligatorios
                # if form.cleaned_data['criterios_adicionar']:
                #     criterios_adicionar = form.cleaned_data['criterios_adicionar']
                #     criterios = criterios_obligatorios | criterios_adicionar
                # subirMatriz.criterios.clear()
                # for criterio in criterios:
                #     subirMatriz.criterios.add(criterio.id)
                log(u'Adiciono Archivo de Matriz de SENESCYT: %s' % subirMatriz, request, "add")
                for proceso in subirMatriz.listado_procesos():
                    historial_proceso = My_HistorialProcesoSubirMatrizInscripcion(matriz=subirMatriz, proceso=proceso, estado=1)
                    historial_proceso.save(request)
                    log(u'Adiciono historial del proceso de Matriz de SENESCYT: %s' % historial_proceso, request, "add")
                messages.add_message(request, messages.SUCCESS, f'Se guardo correctamente el registro')
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'editsubirmatriz':
            try:
                subirMatriz = My_SubirMatrizInscripcion.objects.get(pk=request.POST['id'])
                if not subirMatriz:
                    return JsonResponse({"result": "bad", "mensaje": u"Error, no se encontro información a editar en periodo académico %s" % periodo.nombre})
                if not subirMatriz.puede_editar():
                    return JsonResponse({"result": "bad", "mensaje": u"Error, no se puede editar porque existe un proceso en ejecución en el periodo %s" % periodo.nombre})
                form = SubirMatrizInscripcionForm(request.POST)
                if 'archivo' in request.FILES:
                    d = request.FILES['archivo']
                    if d.size > 20000000:
                        return JsonResponse({"result": "bad", "mensaje": u"Error, archivo mayor a 20 Mb."})
                    newfiles = request.FILES['archivo']
                    newfilesd = newfiles._name
                    ext = newfilesd[newfilesd.rfind("."):]
                    if ext != '.xls' and ext != '.xlsx':
                        return JsonResponse({"result": "bad", "mensaje": u"Error, solo archivos .xls, .xlsx"})
                if not form.is_valid():
                    for k, v in form.errors.items():
                        raise NameError(v[0])
                if My_SubirMatrizInscripcion.objects.filter(status=True, descripcion=form.cleaned_data['descripcion']).exclude(pk=subirMatriz.id).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"La descripcion ya existe."})
                subirMatriz.descripcion = form.cleaned_data['descripcion']
                subirMatriz.observacion = form.cleaned_data['observacion']
                subirMatriz.periodo_id_sag = form.cleaned_data['periodo_id_sag']
                # subirMatriz.proceso = form.cleaned_data['proceso']
                subirMatriz.periodo = periodo
                if 'archivo' in request.FILES:
                    newfile = request.FILES['archivo']
                    newfile._name = generar_nombre("matrizsenescyt_", newfile._name)
                    subirMatriz.archivo = newfile
                subirMatriz.save(request)
                # criterios_obligatorios = My_CriterioSubirMatrizInscripcion.objects.filter(is_obligatorio=True, status=True)
                # criterios = criterios_obligatorios
                # if form.cleaned_data['criterios_adicionar']:
                #     criterios_adicionar = form.cleaned_data['criterios_adicionar']
                #     criterios = criterios_obligatorios | criterios_adicionar
                # subirMatriz.criterios.clear()
                # for criterio in criterios:
                #     subirMatriz.criterios.add(criterio.id)
                log(u'Modifico Archivo de Matriz de SENESCYT: %s' % subirMatriz, request, "edit")
                return JsonResponse({"result": "ok", "mensaje": u"Archivo modificado correctamente"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'deletesubirmatriz':
            try:
                subirMatriz = My_SubirMatrizInscripcion.objects.get(pk=request.POST['id'])
                subirMatriz.inactivar_procesos(request)
                log(u'Elimino archivo de matriz de SENESCYT: %s' % subirMatriz, request, "del")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar los datos."})

        elif action == 'processMatrizSENESCYT':
            try:
                matriz = My_SubirMatrizInscripcion.objects.get(pk=request.POST['id'])
                if not matriz:
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                if not matriz.siguiente_proceso():
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro proceso activo para continuar"})
                if not matriz.puede_ejecutar_matriz():
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se ejecutar el proceso, porque existe un proceso en ejecución"})
                # resultado = processMatrizSENESCYT.delay(persona.id, matriz.id, periodo.id)
                BackGroundProcessAdmision(persona.id, matriz.id, periodo.id, request).start()
                return JsonResponse({"result": "ok", "mensaje": u"El proceso se esta ejecutando..."})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al ejecutar el proceso."})

        elif action == 'viewProcessMatrizSENESCYT':
            try:
                data['subirmatriz'] = matriz = My_SubirMatrizInscripcion.objects.get(pk=request.POST['id'])
                if not matriz:
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                data['title'] = u'Proceso de matriz de SENESCYT'
                # if not subirmatriz.ultimo_proceso():
                #    return HttpResponseRedirect("niveles?action=importar_matriz_senescyt&info=%s" % u"No se encontro proceso asociado.")
                data['ultimo_proceso'] = matriz.ultimo_proceso()
                template = get_template("niveles/importar_matriz_senescyt/proceso.html")
                json_content = template.render(data)
                return JsonResponse({"result": "ok", 'html': json_content})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al ejecutar el proceso."})

        elif action == 'loadProcessMatriculaMatrizSENESCYT':
            try:
                data['subirmatriz'] = matriz = My_SubirMatrizInscripcion.objects.get(pk=request.POST['id'])
                if not matriz:
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})

                aData = matriz.cargar_distributivo_matriz_admision(periodo)

                return JsonResponse({"result": "ok", "aData": aData})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al ejecutar el proceso."})

        elif action == 'LoadDataTableAlumnos':
            try:
                id = int(request.POST['id']) if request.POST['id'] else 0
                level = request.POST['level'] if request.POST['level'] else ''
                level_filter = request.POST['level_filter'] if request.POST['level_filter'] else ''
                txt_filter = request.POST['sSearch'] if request.POST['sSearch'] else ''
                limit = int(request.POST['iDisplayLength']) if request.POST['iDisplayLength'] else 25
                offset = int(request.POST['iDisplayStart']) if request.POST['iDisplayStart'] else 0
                aaData = []
                tCount = 0
                if not id or not level:
                    raise NameError(u"Error al cargar los datos.")

                if level == 'nivel':
                    if not Nivel.objects.filter(pk=id).exists():
                        raise NameError(u"Error no se encontro el nivel.")
                    nivel = Nivel.objects.get(pk=id)
                    matriculas = Matricula.objects.filter(nivel=nivel)
                elif level == 'modalidad':
                    if not Modalidad.objects.filter(pk=id).exists():
                        raise NameError(u"Error no se encontro la modalidad.")
                    modalidad = Modalidad.objects.get(pk=id)
                    txt_nivel, nivel_id = level_filter.split("=")
                    if txt_nivel != 'nivel_id':
                        raise NameError(u"Error no se encontro el nivel.")
                    if not Nivel.objects.filter(pk=nivel_id).exists():
                        raise NameError(u"Error no se encontro el nivel.")
                    nivel = Nivel.objects.get(pk=nivel_id)
                    matriculas = Matricula.objects.filter(nivel=nivel, inscripcion__modalidad=modalidad)
                elif level == 'carrera':
                    if not Carrera.objects.filter(pk=id).exists():
                        raise NameError(u"Error no se encontro la carrera.")
                    carrera = Carrera.objects.get(pk=id)
                    arrNivel, arrModalidad = level_filter.split(",")
                    txt_nivel, nivel_id = arrNivel.split("=")
                    txt_modalidad, modalidad_id = arrModalidad.split("=")
                    if txt_nivel != 'nivel_id':
                        raise NameError(u"Error no se encontro el nivel.")
                    if txt_modalidad != 'modalidad_id':
                        raise NameError(u"Error no se encontro la modalidad.")
                    if not Nivel.objects.filter(pk=nivel_id).exists():
                        raise NameError(u"Error no se encontro el nivel.")
                    nivel = Nivel.objects.get(pk=nivel_id)
                    if not Modalidad.objects.filter(pk=modalidad_id).exists():
                        raise NameError(u"Error no se encontro la modalidad.")
                    modalidad = Modalidad.objects.get(pk=modalidad_id)
                    matriculas = Matricula.objects.filter(nivel=nivel, inscripcion__modalidad=modalidad, inscripcion__carrera=carrera)
                elif level == 'materia':
                    if not Asignatura.objects.filter(pk=id).exists():
                        raise NameError(u"Error no se encontro la asignatura.")
                    asignatura = Asignatura.objects.get(pk=id)
                    arrNivel, arrModalidad, arrCarrera = level_filter.split(",")
                    txt_nivel, nivel_id = arrNivel.split("=")
                    txt_modalidad, modalidad_id = arrModalidad.split("=")
                    txt_carrera, carrera_id = arrCarrera.split("=")
                    if txt_nivel != 'nivel_id':
                        raise NameError(u"Error no se encontro el nivel.")
                    if txt_modalidad != 'modalidad_id':
                        raise NameError(u"Error no se encontro la modalidad.")
                    if txt_carrera != 'carrera_id':
                        raise NameError(u"Error no se encontro la carrera.")
                    if not Nivel.objects.filter(pk=nivel_id).exists():
                        raise NameError(u"Error no se encontro el nivel.")
                    nivel = Nivel.objects.get(pk=nivel_id)
                    if not Modalidad.objects.filter(pk=modalidad_id).exists():
                        raise NameError(u"Error no se encontro la modalidad.")
                    modalidad = Modalidad.objects.get(pk=modalidad_id)
                    if not Carrera.objects.filter(pk=carrera_id).exists():
                        raise NameError(u"Error no se encontro la carrera.")
                    carrera = Carrera.objects.get(pk=carrera_id)
                    matriculas = Matricula.objects.filter(nivel=nivel, inscripcion__modalidad=modalidad, inscripcion__carrera=carrera, materiaasignada__materia__asignaturamalla__asignatura=asignatura)
                elif level == 'paralelo':
                    if not Materia.objects.filter(pk=id, status=True).exists():
                        raise NameError(u"Error no se encontro el paralelo.")
                    materia = Materia.objects.get(pk=id)
                    arrNivel, arrModalidad, arrCarrera, arrAsignatura = level_filter.split(",")
                    txt_nivel, nivel_id = arrNivel.split("=")
                    txt_modalidad, modalidad_id = arrModalidad.split("=")
                    txt_carrera, carrera_id = arrCarrera.split("=")
                    txt_asignatura, asignatura_id = arrAsignatura.split("=")
                    if txt_nivel != 'nivel_id':
                        raise NameError(u"Error no se encontro el nivel.")
                    if txt_modalidad != 'modalidad_id':
                        raise NameError(u"Error no se encontro la modalidad.")
                    if txt_carrera != 'carrera_id':
                        raise NameError(u"Error no se encontro la carrera.")
                    if txt_asignatura != 'materia_id':
                        raise NameError(u"Error no se encontro la asignatura.")
                    if not Nivel.objects.filter(pk=nivel_id).exists():
                        raise NameError(u"Error no se encontro el nivel.")
                    nivel = Nivel.objects.get(pk=nivel_id)
                    if not Modalidad.objects.filter(pk=modalidad_id).exists():
                        raise NameError(u"Error no se encontro la modalidad.")
                    modalidad = Modalidad.objects.get(pk=modalidad_id)
                    if not Carrera.objects.filter(pk=carrera_id).exists():
                        raise NameError(u"Error no se encontro la carrera.")
                    carrera = Carrera.objects.get(pk=carrera_id)
                    if not Asignatura.objects.filter(pk=asignatura_id).exists():
                        raise NameError(u"Error no se encontro la asignatura.")
                    asignatura = Asignatura.objects.get(pk=asignatura_id)
                    matriculas = Matricula.objects.filter(nivel=nivel, materiaasignada__materia=materia, inscripcion__modalidad=modalidad, inscripcion__carrera=carrera, materiaasignada__materia__asignaturamalla__asignatura=asignatura)
                else:
                    raise NameError(u"Error al cargar los datos.")
                # materia_asignada = MateriaAsignada.objects.filter(materia=materia)
                isView = 1
                if not persona.usuario.is_staff:
                    matriculas = matriculas.filter(status=True)
                    isView = 0

                if txt_filter:
                    matriculas = matriculas.filter(Q(inscripcion__persona__nombres__icontains=txt_filter) |
                                                   Q(inscripcion__persona__apellido1__icontains=txt_filter) |
                                                   Q(inscripcion__persona__apellido2__icontains=txt_filter) |
                                                   Q(inscripcion__persona__cedula__icontains=txt_filter) |
                                                   Q(inscripcion__persona__pasaporte__icontains=txt_filter))

                matriculas = matriculas.order_by('inscripcion__persona__apellido1', 'inscripcion__persona__apellido2', 'inscripcion__persona__nombres')

                tCount = matriculas.count()
                if offset == 0:
                    matriculasRows = matriculas[offset:limit]
                elif offset == limit:
                    matriculasRows = matriculas[offset:tCount]
                else:
                    matriculasRows = matriculas[offset:offset + limit]
                aaData = []

                for dataRow in matriculasRows:
                    persona = u'%s %s %s' % (dataRow.inscripcion.persona.apellido1, dataRow.inscripcion.persona.apellido2, dataRow.inscripcion.persona.nombres)
                    documento = dataRow.inscripcion.persona.cedula if dataRow.inscripcion.persona.cedula else dataRow.inscripcion.persona.pasaporte
                    dataMateria = []
                    for materiaasignada in dataRow.materias():
                        dataMateria.append("%s-[%s]" % (materiaasignada.materia.asignaturamalla.asignatura.nombre, materiaasignada.materia.paralelomateria.nombre))
                    valortotal = 0.0
                    saldo = 0.0
                    for rubro in dataRow.rubro_set.filter(status=True):
                        valortotal += float(rubro.valortotal)
                        saldo += float(rubro.saldo)
                    tiene_perfilusuario = False
                    tiene_perfilusuario_visible = False
                    if PerfilUsuario.objects.filter(persona=dataRow.inscripcion.persona, inscripcion=dataRow.inscripcion).exists():
                        tiene_perfilusuario = True
                        if PerfilUsuario.objects.filter(persona=dataRow.inscripcion.persona, inscripcion=dataRow.inscripcion, visible=True).exists():
                            tiene_perfilusuario_visible = True
                    aaData.append([documento,
                                   persona,
                                   dataRow.inscripcion.carrera.nombre,
                                   dataRow.inscripcion.modalidad.nombre,
                                   "No registra asignaturas" if not dataMateria else "<br> ".join(dataMateria),
                                   {
                                       'valortotal': valortotal,
                                       'saldo': saldo
                                   },
                                   {
                                       'usuario': dataRow.inscripcion.persona.usuario.username,
                                       'tiene_perfilusuario': tiene_perfilusuario,
                                       'tiene_perfilusuario_visible': tiene_perfilusuario_visible,
                                   },
                                   dataRow.id])
                return JsonResponse({"result": "ok", "mensaje": u"Cargo los datos.", "data": aaData, "iTotalRecords": tCount, "iTotalDisplayRecords": tCount})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al cargar los datos: %s" % ex, "data": [], "iTotalRecords": 0, "iTotalDisplayRecords": 0})

        elif action == 'processMatriculaMatrizSENESCYT':
            try:

                if not 'id' in request.POST or not request.POST['id']:
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                if not My_SubirMatrizInscripcion.objects.filter(pk=request.POST['id']).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                matriz = My_SubirMatrizInscripcion.objects.get(pk=request.POST['id'])
                level = request.POST['level'] if request.POST['level'] else ''
                level_filter = request.POST['level_filter'] if request.POST['level_filter'] else ''
                carrera_id = None
                carrera = None
                if level == 'carrera':
                    txt_carrera, carrera_id = level_filter.split("=")
                    if txt_carrera != 'carrera_id' or not Carrera.objects.filter(pk=carrera_id).exists():
                        return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                    carrera = Carrera.objects.get(pk=carrera_id)
                # if not matriz.puede_ejecutar_matricular(carrera):
                #    return JsonResponse({"result": "info", "mensaje": u"Información, No puede continuar con el proceso de matriculación porque existe un proceso en ejecución en la carrera %s" % carrera.nombre})
                # resultado = processMatriculaMatrizSENESCYT.delay(persona.id, matriz.id, periodo.id, carrera_id)
                if carrera:
                    vrProcess = matriz.matriculacion_senescyt(periodo, persona, carrera)
                    return JsonResponse({"result": "ok", "mensaje": u"Se matriculo a los postulantes"})
                else:
                    vrProcess = matriz.matriculacion_senescyt(periodo, persona)
                return JsonResponse({"result": "ok", "mensaje": u"Se matriculo a los postulantes"})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al ejecutar el proceso."})

        elif action == 'processDeleteMatriculaAdmision':
            try:

                if not 'id' in request.POST or not request.POST['id']:
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                if not My_SubirMatrizInscripcion.objects.filter(pk=request.POST['id']).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                matriz = My_SubirMatrizInscripcion.objects.get(pk=request.POST['id'])
                level = request.POST['level'] if request.POST['level'] else ''
                level_filter = request.POST['level_filter'] if request.POST['level_filter'] else ''
                carrera_id = None
                carrera = None
                if level == 'carrera':
                    txt_carrera, carrera_id = level_filter.split("=")
                    if txt_carrera != 'carrera_id' or not Carrera.objects.filter(pk=carrera_id).exists():
                        return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                    carrera = Carrera.objects.get(pk=carrera_id)
                    vr = matriz.eliminar_matricula(periodo, persona, carrera)
                    if vr:
                        return JsonResponse({"result": "ok", "mensaje": u"Se eliminaron las matriculas"})
                    else:
                        return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar matriculas"})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar matriculas"})


        elif action == 'processActiveProfilesUserAdmision':
            try:

                if not 'id' in request.POST or not request.POST['id']:
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                if not My_SubirMatrizInscripcion.objects.filter(pk=request.POST['id']).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                matriz = My_SubirMatrizInscripcion.objects.get(pk=request.POST['id'])
                level = request.POST['level'] if request.POST['level'] else ''
                level_filter = request.POST['level_filter'] if request.POST['level_filter'] else ''
                carrera_id = None
                carrera = None
                if level == 'carrera':
                    txt_carrera, carrera_id = level_filter.split("=")
                    if txt_carrera != 'carrera_id' or not Carrera.objects.filter(pk=carrera_id).exists():
                        return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                    carrera = Carrera.objects.get(pk=carrera_id)
                # resultado = processActiveProfilesUser.delay(persona.id, matriz.id, periodo.id, carrera_id)
                if carrera:
                    resultado = matriz.activar_perfiles_usuarios_admision(periodo, persona, carrera)
                    return JsonResponse({"result": "ok", "mensaje": u"Se activaron los perfiles"})
                else:
                    resultado = matriz.activar_perfiles_usuarios_admision(periodo, persona)
                    return JsonResponse({"result": "ok", "mensaje": u"Se activaron los perfiles"})
                return JsonResponse({"result": "ok", "mensaje": u"El proceso se esta ejecutando..."})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": f"Error al ejecutar el proceso. {ex.__str__()}"})

        elif action == 'process2MatriculaAdmision':
            try:
                if not 'id' in request.POST or not request.POST['id']:
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                if not My_SubirMatrizInscripcion.objects.filter(pk=request.POST['id']).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                matriz = My_SubirMatrizInscripcion.objects.get(pk=request.POST['id'])
                if not 'idc' in request.POST or not request.POST['idc']:
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                if not Carrera.objects.filter(pk=request.POST['idc']).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                carrera = Carrera.objects.get(pk=request.POST['idc'])
                if not 'idpa' in request.POST or not request.POST['idpa']:
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                if not Periodo.objects.filter(pk=request.POST['idpa']).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                periodoanterior = Periodo.objects.get(pk=request.POST['idpa'])
                if not 'idn' in request.POST or not request.POST['idn']:
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                if not Nivel.objects.filter(pk=request.POST['idn']).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                nivel = Nivel.objects.get(pk=request.POST['idn'])
                aData = json.loads(request.POST['aData'])
                print(aData)
                periodoactual = periodo
                # resultado = processActiveProfilesUser.delay(persona.id, matriz.id, periodo.id, carrera_id)
                resultado = matriz.matricula_2_repetidores_admision(periodoactual, periodoanterior, persona, carrera, nivel, aData)
                return JsonResponse({"result": "ok", "mensaje": u"Se matriculo a los repetidores"})
                # return JsonResponse({"result": "ok", "mensaje": u"El proceso se esta ejecutando..."})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": f"Error al ejecutar el proceso. {ex.__str__()}"})

        elif action == 'processCancelarMatriculaMatrizSENESCYT':
            try:
                if not 'id' in request.POST or not request.POST['id']:
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                if not My_SubirMatrizInscripcion.objects.filter(pk=request.POST['id']).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                matriz = My_SubirMatrizInscripcion.objects.get(pk=request.POST['id'])
                matriz.cancelar_proceso_matricula()
                return JsonResponse({"result": "ok", "mensaje": u"El proceso fue cancelado..."})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al cancelar el proceso."})

        elif action == 'loadAsignaturasByCareers':
            try:
                if not 'idp' in request.POST or not request.POST['idp']:
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro el periodo de admisión"})
                if not 'idm' in request.POST or not request.POST['idm']:
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                if not My_SubirMatrizInscripcion.objects.filter(pk=request.POST['idm']).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                matriz = My_SubirMatrizInscripcion.objects.get(pk=request.POST['idm'])
                level = request.POST['level'] if request.POST['level'] else ''
                level_filter = request.POST['level_filter'] if request.POST['level_filter'] else ''
                carrera_id = None
                carrera = None
                nivel, carrera = level.split(",")
                filter_nivel, filter_carrera = level_filter.split(",")
                if nivel == 'nivel':
                    txt_nivel, nivel_id = filter_nivel.split("=")
                    if txt_nivel != 'nivel_id' or not Nivel.objects.filter(pk=nivel_id).exists():
                        return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                    nivel = Nivel.objects.get(pk=nivel_id)
                if carrera == 'carrera':
                    txt_carrera, carrera_id = filter_carrera.split("=")
                    if txt_carrera != 'carrera_id' or not Carrera.objects.filter(pk=carrera_id).exists():
                        return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro información"})
                    carrera = Carrera.objects.get(pk=carrera_id)
                data['matriz'] = matriz
                data['carrera_admision'] = carrera
                data['nivel_admision'] = nivel
                data['periodo_admision'] = periodo_admision = Periodo.objects.get(pk=request.POST['idp'])
                data['materias_repro'] = materias_repro = Asignatura.objects.filter(pk__in=Materia.objects.filter(status=True, nivel__periodo=periodo_admision, asignaturamalla__malla__carrera=carrera).values_list('asignatura_id').distinct())
                data['materias_dist'] = materias_dist = Asignatura.objects.filter(pk__in=Materia.objects.filter(status=True, nivel__periodo=periodo, asignaturamalla__malla__carrera=carrera).values_list('asignatura_id').distinct())
                if not materias_repro.exists() or not materias_dist.exists():
                    return JsonResponse({"result": "bad", "mensaje": u"Error, No se encontro asignaturas en la carrera seleccionada"})
                template = get_template("niveles/importar_matriz_senescyt/repetidores.html")
                json_content = template.render(data)
                return JsonResponse({"result": "ok", 'html': json_content})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error no se encontrol la información"})

        elif action == 'enrollment_list_by_careers_and_period':
            try:
                idca = int(request.POST['idca']) if 'idca' in request.POST and request.POST['idca'] else 0
                idcp = int(request.POST['idcp']) if 'idcp' in request.POST and request.POST['idcp'] else 0
                idpa = int(request.POST['idpa']) if 'idpa' in request.POST and request.POST['idpa'] else 0
                idpp = int(request.POST['idpp']) if 'idpp' in request.POST and request.POST['idpp'] else 0
                txt_filter = request.POST['sSearch'] if request.POST['sSearch'] else ''
                limit = int(request.POST['iDisplayLength']) if request.POST['iDisplayLength'] else 25
                offset = int(request.POST['iDisplayStart']) if request.POST['iDisplayStart'] else 0
                # estados = json.loads(request.POST['estados'])
                # if not estados:
                #    estados = []
                # estado_pendiente = False
                # estado_matriculado = False
                # for key, value in range(estados):
                #    if key == 1:
                #        estado_pendiente = True
                #    if key == 2:
                #        estado_matriculado = True

                aaData = []
                tCount = 0
                periodoadmision = Periodo.objects.get(pk=idpa)
                periodopregrado = Periodo.objects.get(pk=idpp)
                carreraadmision = My_CarreraPregrado.objects.get(pk=idca)
                carrerapregrado = None
                if My_CarreraPregrado.objects.filter(pk=idcp).exists():
                    carrerapregrado = My_CarreraPregrado.objects.get(pk=idcp)
                matriculas = Matricula.objects.filter(nivel__periodo=periodoadmision, inscripcion__carrera=carreraadmision, aprobado=True)
                isView = 1
                if not persona.usuario.is_staff:
                    matriculas = matriculas.filter(status=True)
                    isView = 0

                if txt_filter:
                    matriculas = matriculas.filter(Q(inscripcion__persona__nombres__icontains=txt_filter) |
                                                   Q(inscripcion__persona__apellido1__icontains=txt_filter) |
                                                   Q(inscripcion__persona__apellido2__icontains=txt_filter) |
                                                   Q(inscripcion__persona__cedula__icontains=txt_filter) |
                                                   Q(inscripcion__persona__pasaporte__icontains=txt_filter))

                matriculas = matriculas.order_by('inscripcion__persona__apellido1', 'inscripcion__persona__apellido2', 'inscripcion__persona__nombres')

                tCount = matriculas.count()
                if offset == 0:
                    matriculasRows = matriculas[offset:limit]
                elif offset == limit:
                    matriculasRows = matriculas[offset:tCount]
                else:
                    matriculasRows = matriculas[offset:offset + limit]
                aaData = []

                for dataRow in matriculasRows:
                    persona = u'%s %s %s' % (dataRow.inscripcion.persona.apellido1, dataRow.inscripcion.persona.apellido2, dataRow.inscripcion.persona.nombres)
                    documento = dataRow.inscripcion.persona.cedula if dataRow.inscripcion.persona.cedula else dataRow.inscripcion.persona.pasaporte

                    aaData.append([documento,
                                   persona,
                                   1 if Matricula.objects.filter(nivel__periodo=periodopregrado, inscripcion__persona=dataRow.inscripcion.persona).exists() else 2,
                                   dataRow.id])
                return JsonResponse({"result": "ok", "mensaje": u"Cargo los datos.", "data": aaData, "iTotalRecords": tCount, "iTotalDisplayRecords": tCount})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al cargar los datos: %s" % ex, "data": [], "iTotalRecords": 0, "iTotalDisplayRecords": 0})

        elif action == 'list_careers_first_level_by_period':
            try:
                pcid = int(request.POST['pcid']) if request.POST['pcid'] else 0
                ppid = int(request.POST['ppid']) if request.POST['ppid'] else 0
                periodoc = Periodo.objects.get(pk=pcid)  # periodo_pregrado
                periodop = Periodo.objects.get(pk=ppid)  # periodo_admision
                config = My_ConfigMatriculacionPrimerNivel.objects.filter(periodoadmision=periodop, periodopregrado=periodoc, status=True)
                if not config.exists():
                    config = My_ConfigMatriculacionPrimerNivel(periodoadmision=periodop, periodopregrado=periodoc)
                    config.save(request)
                else:
                    config = config[0]

                if not config.has_detail():
                    carreras_ids = My_MatriculaPregrado.objects.values_list('inscripcion__carrera_id').filter(nivel__periodo=periodop, aprobado=True).distinct()
                    # carreras_ids = My_InscripcionPregrado.objects.values_list('carrera_id').filter(id__in=inscripcion_ids).distinct()
                    carreras_admision = My_CarreraPregrado.objects.filter(id__in=carreras_ids).distinct()
                    for carrera_a in carreras_admision:
                        car = My_MatriculacionPrimerNivelCarrera(configuracion=config, carreraadmision=carrera_a)
                        car.save(request)
                data['periodoc'] = periodoc
                data['periodop'] = periodop
                data['config'] = config
                data['can_add_detail'] = config.can_add_detail(periodop)
                data['detalles'] = detalles = config.list_careers_first_level()
                template = get_template("niveles/matriculacion_primer_nivel/list_careers.html")
                json_content = template.render(data)
                return JsonResponse({"result": "ok", "contenido": json_content})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al cargar los datos: %s" % ex})

        elif action == 'contenido_nuevo_detalle':
            try:
                id = int(request.POST['id']) if request.POST['id'] else 0
                config = My_ConfigMatriculacionPrimerNivel.objects.get(pk=id)
                data['config'] = config
                data['carreras_admision'] = config.list_careers_admision_add_detail(config.periodoadmision)
                data['carreras_pregrado'] = config.list_careers_pregrado_add_detail(config.periodopregrado)
                template = get_template("niveles/matriculacion_primer_nivel/contenido_nuevo_detalle.html")
                json_content = template.render(data)
                return JsonResponse({"result": "ok", "contenido": json_content})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al cargar los datos: %s" % ex})

        elif action == 'contenido_edit_detalle':
            try:
                id = int(request.POST['id']) if request.POST['id'] else 0
                detalle = My_MatriculacionPrimerNivelCarrera.objects.get(pk=id)
                data['detalle'] = detalle
                data['config'] = detalle.configuracion
                carrera_ids = Materia.objects.values_list('asignaturamalla__malla__carrera_id').filter(nivel__periodo=detalle.configuracion.periodopregrado, status=True).distinct()
                carreras = My_CarreraPregrado.objects.filter(id__in=carrera_ids).distinct()
                data['carreras_pregrado'] = carreras
                template = get_template("niveles/matriculacion_primer_nivel/contenido_edit_detalle.html")
                json_content = template.render(data)
                return JsonResponse({"result": "ok", "contenido": json_content})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al cargar los datos: %s" % ex})

        elif action == 'load_sesion_by_carrera':
            try:
                q = request.POST['q'] if 'q' in request.POST and request.POST['q'] else ''
                id_config = int(request.POST['id_config']) if request.POST['id_config'] else 0
                id_detalle = int(request.POST['id_detalle']) if request.POST['id_detalle'] else 0
                id_carrera = int(request.POST['id_carrera']) if request.POST['id_carrera'] else 0
                sesiones_ids = ()
                sesiones = []
                carrera = None
                if My_MatriculacionPrimerNivelCarrera.objects.filter(pk=id_detalle).exists():
                    detalle = My_MatriculacionPrimerNivelCarrera.objects.get(pk=id_detalle)
                    if detalle.sesiones:
                        sesiones_ids = My_MatriculacionPrimerNivelCarrera.objects.get(pk=id_detalle).sesiones.all().values_list('id')
                    if detalle.carrerapregrado and id_carrera and detalle.carrerapregrado.id == id_carrera:
                        niveles = Nivel.objects.filter(periodo=periodo, materia__asignaturamalla__malla__carrera=detalle.carrerapregrado).distinct()
                        sesiones = Sesion.objects.filter(pk__in=niveles.values_list('sesion_id').distinct())
                    elif My_CarreraPregrado.objects.filter(pk=id_carrera).exists():
                        carrera = My_CarreraPregrado.objects.get(pk=id_carrera)
                        niveles = Nivel.objects.filter(periodo=periodo, materia__asignaturamalla__malla__carrera=carrera).distinct()
                        sesiones = Sesion.objects.filter(pk__in=niveles.values_list('sesion_id').distinct())
                elif My_ConfigMatriculacionPrimerNivel.objects.filter(pk=id_config).exists():
                    configuracion = My_ConfigMatriculacionPrimerNivel.objects.get(pk=id_config)
                    carrera = My_CarreraPregrado.objects.get(pk=id_carrera)
                    niveles = Nivel.objects.filter(periodo=configuracion.periodopregrado, materia__asignaturamalla__malla__carrera=carrera).distinct()
                    sesiones = Sesion.objects.filter(pk__in=niveles.values_list('sesion_id').distinct())
                else:
                    sesiones = Sesion.objects.filter(status=True)
                aData = []
                for sesion in sesiones:
                    aData.append({'id': sesion.id, 'text': sesion.__str__(), 'selected': True if sesion.id in sesiones_ids else False})
                return JsonResponse({"result": "ok", "mensaje": u"", "aData": aData})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error no se pudo cargar los datos.", "aData": []})

        elif action == 'delete_detail_config':
            try:
                id = int(request.POST['id']) if request.POST['id'] else 0
                if not My_MatriculacionPrimerNivelCarrera.objects.filter(pk=id).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"Error no se encontro el detalle"})
                detail = My_MatriculacionPrimerNivelCarrera.objects.get(pk=id)
                # detail.sesiones.filter().delete()
                detail.delete()
                return JsonResponse({"result": "ok", "mensaje": u"Se elimino correctamente.!"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar los datos: %s" % ex})

        elif action == 'save_add_detail_config':
            try:
                idc = int(request.POST['idc']) if request.POST['idc'] else 0
                if not My_ConfigMatriculacionPrimerNivel.objects.filter(pk=idc).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"Error no se pudo guardar"})
                idca = int(request.POST['idca']) if request.POST['idca'] else 0
                if not My_CarreraPregrado.objects.filter(pk=idca).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"Error no se encontro la carrera de admisión"})
                idcp = int(request.POST['idcp']) if request.POST['idcp'] else 0
                if not My_CarreraPregrado.objects.filter(pk=idcp).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"Error no se encontro la carrera de pregrado"})
                config = My_ConfigMatriculacionPrimerNivel.objects.get(pk=idc)
                carrera_admision = My_CarreraPregrado.objects.get(pk=idca)
                carrera_pregrado = My_CarreraPregrado.objects.get(pk=idcp)
                if My_MatriculacionPrimerNivelCarrera.objects.filter(carreraadmision=carrera_admision, carrerapregrado=carrera_pregrado, configuracion=config).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"Error información ya se encuentra registrada"})
                detail = My_MatriculacionPrimerNivelCarrera(carreraadmision=carrera_admision,
                                                            carrerapregrado=carrera_pregrado,
                                                            configuracion=config)
                detail.save(request)
                sesiones_ids = json.loads(request.POST['sesiones'])
                for id in sesiones_ids:
                    sesion = Sesion.objects.get(pk=id)
                    detail.sesiones.add(sesion)
                detail.save(request)
                return JsonResponse({"result": "ok", "mensaje": u"Se guardo correctamente.!"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos: %s" % ex})

        elif action == 'save_edit_detail_config':
            try:
                id = int(request.POST['id']) if request.POST['id'] else 0
                if not My_MatriculacionPrimerNivelCarrera.objects.filter(pk=id).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"Error no se pudo guardar"})
                idcp = int(request.POST['idcp']) if request.POST['idcp'] else 0
                if not My_CarreraPregrado.objects.filter(pk=idcp).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"Error no se encontro la carrera de pregrado"})
                sesiones_ids = json.loads(request.POST['sesiones'])
                if not sesiones_ids:
                    return JsonResponse({"result": "bad", "mensaje": u"Error debe seleccionar secciones"})
                detail = My_MatriculacionPrimerNivelCarrera.objects.get(pk=id)
                sesionesb = detail.mis_sesiones()
                carrera_pregrado = My_CarreraPregrado.objects.get(pk=idcp)
                detail.carrerapregrado = carrera_pregrado
                detail.save(request)
                ids_s = []
                for id in sesiones_ids:
                    sesion = Sesion.objects.get(pk=id)
                    ids_s.append(sesion.id)
                    detail.sesiones.add(sesion)
                for sesioni in sesionesb:
                    if not sesioni.id in ids_s:
                        detail.sesiones.remove(Sesion.objects.get(pk=sesioni.id))
                detail.save(request)
                return JsonResponse({"result": "ok", "mensaje": u"Se guardo correctamente.!"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos: %s" % ex})

        elif action == 'enrollment_by_career':
            try:
                idpa = int(request.POST['idpa']) if 'idpa' in request.POST and request.POST['idpa'] else 0
                idca = int(request.POST['idca']) if 'idca' in request.POST and request.POST['idca'] else 0
                idcp = int(request.POST['idcp']) if 'idca' in request.POST and request.POST['idcp'] else 0
                if not Periodo.objects.filter(pk=idpa).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"No se encontro el periodo académico de admisión"})
                if not My_CarreraPregrado.objects.filter(pk=idca).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"No se encontro carrera de admisión"})
                if not My_CarreraPregrado.objects.filter(pk=idcp).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"No se encontro carrera de pregrado"})
                periodopregrado = periodo
                periodoadmision = Periodo.objects.get(pk=idpa)
                carreraadmision = My_CarreraPregrado.objects.get(pk=idca)
                carrerapregrado = My_CarreraPregrado.objects.get(pk=idcp)
                # AMBIENTE DE PRUEBA SIN CELERY
                # config = My_ConfigMatriculacionPrimerNivel.objects.get(periodoadmision=periodoadmision,periodopregrado=periodopregrado)
                # detalle = My_MatriculacionPrimerNivelCarrera.objects.get(configuracion=config, carreraadmision=carreraadmision, carrerapregrado=carrerapregrado)
                # detalle.matricular_primer_nivel_by_carrera(persona)
                # AMBEINTE DE PRODUCCION CON CELERY
                resultado = processMatriculacionPrimerNivel(persona.id, periodoadmision.id, carreraadmision.id, periodopregrado.id, carrerapregrado.id)
                return JsonResponse({"result": "ok", "mensaje": u"El proceso de matriculación de la carrera %s se esta ejecutando." % carrerapregrado.nombre})
            except Exception as ex:
                # AMBIENTE DE PRUEBA SIN CELERY
                # transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al procesar los datos: %s" % ex})

        elif action == 'enrollment_massively':
            try:
                idpa = int(request.POST['idpa']) if 'idpa' in request.POST and request.POST['idpa'] else 0
                if not Periodo.objects.filter(pk=idpa).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"No se encontro el periodo académico de admisión"})
                periodopregrado = periodo
                periodoadmision = Periodo.objects.get(pk=idpa)
                carreras_ids = json.loads(request.POST['carreras'])
                if not carreras_ids:
                    return JsonResponse({"result": "bad", "mensaje": u"No se encontro carreras"})
                for carrera_id in carreras_ids:
                    if not My_CarreraPregrado.objects.filter(pk=carrera_id['idca']).exists():
                        return JsonResponse({"result": "bad", "mensaje": u"No se encontro carrera de admisión"})
                    if not My_CarreraPregrado.objects.filter(pk=carrera_id['idcp']).exists():
                        return JsonResponse({"result": "bad", "mensaje": u"No se encontro carrera de pregrado"})
                for carrera_id in carreras_ids:
                    carreraadmision = My_CarreraPregrado.objects.get(pk=carrera_id['idca'])
                    carrerapregrado = My_CarreraPregrado.objects.get(pk=carrera_id['idcp'])
                    resultado = processMatriculacionPrimerNivel(persona.id, periodoadmision.id, carreraadmision.id, periodopregrado.id, carrerapregrado.id)
                return JsonResponse({"result": "ok", "mensaje": u"El proceso de matriculación masiva se esta ejecutando."})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al procesar los datos: %s" % ex})

        elif action == 'load_statistics':
            try:
                id = int(request.POST['id']) if 'id' in request.POST and request.POST['id'] else 0
                if not My_ConfigMatriculacionPrimerNivel.objects.filter(pk=id).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"No se encontro datos a consultar"})
                configuracion = My_ConfigMatriculacionPrimerNivel.objects.get(pk=id)
                estadisticas = configuracion.load_statistics()
                return JsonResponse({"result": "ok", "mensaje": u"Se actualizaron datos estadísticos", 'estadisticas': estadisticas})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al procesar los datos: %s" % ex})

        elif action == 'buscardatos':
            try:
                carrera = Carrera.objects.get(pk=int(request.POST['id']))
                lista = []
                listanivel = []
                matriculas = Matricula.objects.filter(status=True, inscripcion__carrera=carrera, nivel__periodo=periodo, retiradomatricula=False)
                sesionesid = matriculas.values('nivel__sesion_id').order_by('nivel__sesion_id').distinct()
                nivelesid = matriculas.values('nivelmalla_id').order_by('nivelmalla_id').distinct()
                sesiones = Sesion.objects.filter(id__in=sesionesid)
                niveles = NivelMalla.objects.filter(id__in=nivelesid)
                for sesion in sesiones:
                    lista.append([sesion.id, sesion.nombre])

                for nivel in niveles:
                    listanivel.append([nivel.id, nivel.nombre])

                return JsonResponse({"result": "ok", "lista": lista, "listanivel": listanivel})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos"})


        elif action == 'buscarmatriculas':
            try:
                data['limite'] = int(request.POST['limite'])
                carrera = Carrera.objects.get(pk=int(request.POST['idcarr']))
                sesion = Sesion.objects.get(pk=int(request.POST['idsecc']))
                cursor = connection.cursor()
                listaestudiante = """
                                    SELECT DISTINCT "sga_matricula"."id"
                                    FROM "sga_matricula"
                                    INNER JOIN "sga_nivel" ON ("sga_matricula"."nivel_id" = "sga_nivel"."id")
                                    INNER JOIN "sga_periodo" ON ("sga_nivel"."periodo_id" = "sga_periodo"."id")
                                    INNER JOIN "sga_materiaasignada" ON ("sga_matricula"."id" = "sga_materiaasignada"."matricula_id")
                                    INNER JOIN "sga_materia" ON ("sga_materiaasignada"."materia_id" = "sga_materia"."id")
                                    INNER JOIN "sga_asignatura" ON ("sga_materia"."asignatura_id" = "sga_asignatura"."id")
                                    INNER JOIN "sga_inscripcion" ON ("sga_matricula"."inscripcion_id" = "sga_inscripcion"."id")
                                    WHERE  "sga_nivel"."periodo_id" = %s
                                    AND "sga_matricula"."status" = TRUE 
                                    AND "sga_asignatura"."modulo" = TRUE                                 
                                    AND NOT ("sga_inscripcion"."carrera_id" IN (
                                    SELECT U3."carrera_id" AS Col1
                                    FROM "sga_coordinacion_carrera" U3
                                    WHERE U3."coordinacion_id" = 9))                                 
                                    AND NOT ("sga_inscripcion"."carrera_id" = 7)
                                    AND NOT ("sga_matricula"."retiradomatricula" = TRUE)                                
                                    AND ((
                                    SELECT COUNT(mta.id)
                                    FROM sga_materiaasignada mta
                                    WHERE mta.matricula_id=sga_matricula.id) = 1) 
                                    """ % periodo.id
                cursor.execute(listaestudiante)
                results = cursor.fetchall()
                respuestas = []
                for idm in results:
                    respuestas.append(idm[0])
                matriculas = Matricula.objects.filter(status=True, nivel__periodo=periodo,
                                                      inscripcion__carrera=carrera,
                                                      nivel__sesion=sesion,
                                                      retiradomatricula=False
                                                      ).exclude(materiaasignada__soporteacademicotutor__periodo=periodo).exclude(pk__in=respuestas).distinct()

                if int(request.POST['idniv']) > 0:
                    nivel = NivelMalla.objects.get(pk=int(request.POST['idniv']))
                    matriculas = matriculas.filter(nivelmalla=nivel).order_by('inscripcion__persona__apellido1', 'inscripcion__persona__apellido2', 'inscripcion__persona__nombres')
                    data['matriculas'] = matriculas
                else:
                    matriculas = matriculas.order_by('nivelmalla__nombre')
                    data['matriculas'] = matriculas
                template = get_template("niveles/buscarmatriculas.html")
                json_content = template.render(data)
                return JsonResponse({"result": "ok", 'resultados': json_content, 'total': matriculas.count()})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos"})

        elif action == 'guardarconfiguracion':
            try:
                profesor = Profesor.objects.get(pk=int(request.POST['profesor']))
                matriculas = Matricula.objects.filter(id__in=[int(x) for x in request.POST['lista'].split(',')])
                for matricula in matriculas:
                    for materiaasignada in MateriaAsignada.objects.filter(status=True, matricula=matricula).exclude(materia__asignaturamalla__malla_id__in=[353, 22]):
                        if not SoporteAcademicoTutor.objects.filter(status=True, periodo=periodo,
                                                                    tutor=profesor,
                                                                    materiaasignada=materiaasignada).exists():
                            s = SoporteAcademicoTutor(periodo=periodo,
                                                      tutor=profesor,
                                                      materiaasignada=materiaasignada)
                            s.save(request)
                cantidad = SoporteAcademicoTutor.objects.values_list('materiaasignada__matricula_id', flat=True).filter(
                    status=True, tutor=profesor, periodo=periodo).order_by(
                    'materiaasignada__matricula_id').distinct().count()
                log(u'Configura estudiantes con su docente tutor  %s' % profesor, request, "add")
                return JsonResponse({"result": "ok", "cantidad": cantidad})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos: %s" % ex})

        elif action == 'consultarasignacion':
            try:
                profesor = Profesor.objects.get(pk=int(request.POST['profesor']))
                cantidad = SoporteAcademicoTutor.objects.values_list('materiaasignada__matricula_id', flat=True).filter(status=True, tutor=profesor, periodo=periodo).order_by('materiaasignada__matricula_id').distinct().count()
                return JsonResponse({"result": "ok", "cantidad": cantidad})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos: %s" % ex})

        elif action == 'eliminarasignacion':
            try:
                profesor = Profesor.objects.get(pk=request.POST['id'])
                SoporteAcademicoTutor.objects.filter(status=True, tutor=profesor, periodo=periodo).delete()
                log(u'Elimina asignaciones de tutor: %s' % profesor, request, "del")
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar los datos."})

        elif action == 'matricularInternado':
            try:
                puede_realizar_accion(request, 'sga.puede_matricular_masivo_internado')
                periodo_destino = Periodo.objects.get(pk=request.POST['periodo_id'])
                carrera = Carrera.objects.get(pk=request.POST['carrera_id'])
                nivelmalla = NivelMalla.objects.get(pk=request.POST['nivelmalla_id'])
                items = json.loads(request.POST['items'])
                for d in items:
                    d = json.loads(d)
                    inscripcion_id = int(d['inscripcion_id'])
                    materia_id = int(d['materia_id'])
                    if not Inscripcion.objects.filter(pk=inscripcion_id).exists():
                        raise NameError('Inscripción no existe. %s' % inscripcion_id)
                    if not Materia.objects.filter(pk=materia_id, status=True).exists():
                        raise NameError('Materia no existe. %s' % materia_id)
                    inscripcion = Inscripcion.objects.get(pk=inscripcion_id)
                    materia = Materia.objects.get(pk=materia_id)
                    matricula = None
                    if not Matricula.objects.filter(inscripcion=inscripcion, nivel__periodo=periodo_destino).exists():
                        matricula = Matricula(inscripcion=inscripcion,
                                              nivel=materia.nivel,
                                              pago=False,
                                              iece=False,
                                              becado=False,
                                              porcientobeca=0,
                                              fecha=datetime.now().date(),
                                              hora=datetime.now().time(),
                                              fechatope=fechatope(datetime.now().date()),
                                              automatriculapregrado=True,
                                              fechaautomatriculapregrado=datetime.now(),
                                              estado_matricula__in=[2, 3])
                        matricula.save(request)
                        log(u'Creación de matricula: %s' % matricula, request, "add")
                    else:
                        matricula = Matricula.objects.get(inscripcion=inscripcion, nivel__periodo=periodo_destino)

                    if not MateriaAsignada.objects.filter(matricula=matricula, materia=materia).exists():
                        matriculas = matricula.inscripcion.historicorecordacademico_set.filter(asignatura=materia.asignatura, fecha__lt=materia.nivel.fin).count() + 1
                        materiaasignada = MateriaAsignada(matricula=matricula,
                                                          materia=materia,
                                                          notafinal=0,
                                                          asistenciafinal=0,
                                                          cerrado=False,
                                                          matriculas=matriculas,
                                                          observaciones='',
                                                          estado_id=NOTA_ESTADO_EN_CURSO)
                        materiaasignada.save(request)
                        materiaasignada.asistencias()
                        materiaasignada.evaluacion()
                        materiaasignada.mis_planificaciones()
                        materiaasignada.save(request)
                        registro = AgregacionEliminacionMaterias(matricula=matricula,
                                                                 agregacion=True,
                                                                 asignatura=materiaasignada.materia.asignatura,
                                                                 responsable=request.session['persona'],
                                                                 fecha=datetime.now().date(),
                                                                 creditos=materiaasignada.materia.creditos,
                                                                 nivelmalla=materiaasignada.materia.nivel.nivelmalla if materiaasignada.materia.nivel.nivelmalla else None,
                                                                 matriculas=materiaasignada.matriculas)
                        registro.save(request)
                        log(u'Adiciono materia: %s' % materiaasignada, request, "add")

                    inscripcion.actualizar_nivel()
                    matricula.actualiza_matricula()
                    matricula.inscripcion.actualiza_estado_matricula()
                    matricula.grupo_socio_economico(1)
                    matricula.calcula_nivel()
                    confirmarmatricula = ConfirmarMatricula(matricula=matricula,
                                                            estado=True)
                    confirmarmatricula.save(request)
                    log(u'Confirma matricula: %s' % confirmarmatricula, request, "add")
                    auditoria = AuditoriaMatricula(inscripcion=confirmarmatricula.matricula.inscripcion,
                                                   periodo=confirmarmatricula.matricula.nivel.periodo,
                                                   tipo=1)
                    auditoria.save(request)

                return JsonResponse({"result": "ok", "mensaje": u"Se matricularon correctamente"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al matricular. %s" % ex})

        elif action == 'matricular_especial':
            try:
                puede_realizar_accion(request, 'sga.puede_matricular_alumno_materia')
                materia = Materia.objects.get(pk=request.POST['id'])
                form = MatricularEspecialForm(request.POST, request.FILES)
                archivo = None
                if 'archivo' in request.FILES:
                    archivo = request.FILES['archivo']
                    if archivo.size > 20971520:
                        return JsonResponse({"result": "bad", "mensaje": u"Error, archivo mayor a 20 Mb."})
                    newfilesd = archivo._name
                    ext = newfilesd[newfilesd.rfind("."):]
                    if ext != '.xls' and ext != '.xlsx':
                        return JsonResponse({"result": "bad", "mensaje": u"Error, solo archivos .xls, .xlsx"})
                if form.is_valid():
                    archivo._name = generar_nombre("importacion_matricula_especial_", archivo._name)
                    archivo_guardado = Archivo(nombre='IMPORTACION MATRICULA CASOS ESPECIAL',
                                               fecha=datetime.now().date(),
                                               archivo=archivo,
                                               tipo_id=9)
                    archivo_guardado.save()
                    # workbook = xlrd.open_workbook(archivo_guardado.archivo.file.name)
                    # sheet = workbook.sheet_by_index(0)
                    miarchivo = openpyxl.load_workbook(archivo_guardado.archivo.file.name)
                    lista = miarchivo.get_sheet_by_name('Hoja1')
                    totallista = lista.rows
                    linea = 1
                    for filas in totallista:
                        if linea >= 2:
                            # cols = sheet.row_values(rowx)
                            cedula = str(filas[0].value).strip()
                            persona = None
                            if not Persona.objects.filter(Q(cedula=cedula) | Q(pasaporte=cedula), status=True).exists():
                                raise NameError('Persona con la cedula %s no existe. ' % cedula)
                            alumno = Persona.objects.filter(Q(cedula=cedula) | Q(pasaporte=cedula), status=True)[0]
                            if Inscripcion.objects.filter(status=True, persona=alumno, carrera=materia.asignaturamalla.malla.carrera, activo=True).exists():
                                inscripcion = Inscripcion.objects.get(status=True, persona=alumno, carrera=materia.asignaturamalla.malla.carrera, activo=True)
                                matricula = None
                                if not Matricula.objects.filter(inscripcion=inscripcion, nivel__periodo=materia.nivel.periodo).exists():
                                    matricula = Matricula(inscripcion=inscripcion,
                                                          nivel=materia.nivel,
                                                          pago=False,
                                                          iece=False,
                                                          becado=False,
                                                          porcientobeca=0,
                                                          fecha=datetime.now().date(),
                                                          hora=datetime.now().time(),
                                                          fechatope=fechatope(datetime.now().date()),
                                                          automatriculapregrado=False,
                                                          estado_matricula=2, termino=True)
                                    matricula.save(request)
                                    log(u'Creación de matricula: %s' % matricula, request, "add")
                                else:
                                    matricula = Matricula.objects.get(inscripcion=inscripcion, nivel__periodo=materia.nivel.periodo)

                                if not MateriaAsignada.objects.filter(matricula=matricula, materia=materia).exists():
                                    # matriculas = matricula.inscripcion.historicorecordacademico_set.filter(asignatura=materia.asignatura, fecha__lt=materia.nivel.fin).count() + 1
                                    materiaasignada = MateriaAsignada(matricula=matricula,
                                                                      materia=materia,
                                                                      notafinal=0,
                                                                      asistenciafinal=0,
                                                                      cerrado=False,
                                                                      matriculas=1,
                                                                      observaciones='',
                                                                      estado_id=NOTA_ESTADO_EN_CURSO)
                                    materiaasignada.save(request)
                                    materiaasignada.evaluacion()
                                    materiaasignada.mis_planificaciones()
                                    materiaasignada.save(request)
                                    registro = AgregacionEliminacionMaterias(matricula=matricula,
                                                                             agregacion=True,
                                                                             asignatura=materiaasignada.materia.asignatura,
                                                                             responsable=request.session['persona'],
                                                                             fecha=datetime.now().date(),
                                                                             creditos=materiaasignada.materia.creditos,
                                                                             nivelmalla=materiaasignada.materia.nivel.nivelmalla if materiaasignada.materia.nivel.nivelmalla else None,
                                                                             matriculas=materiaasignada.matriculas)
                                    registro.save(request)
                                    log(u'Adiciono materia: %s' % materiaasignada, request, "add")

                                inscripcion.actualizar_nivel()
                                matricula.actualiza_matricula()
                                matricula.inscripcion.actualiza_estado_matricula()
                                matricula.grupo_socio_economico(1)
                                matricula.calcula_nivel()
                                confirmarmatricula = ConfirmarMatricula(matricula=matricula,
                                                                        estado=True)
                                confirmarmatricula.save(request)
                                log(u'Confirma matricula: %s' % confirmarmatricula, request, "add")
                                auditoria = AuditoriaMatricula(inscripcion=confirmarmatricula.matricula.inscripcion,
                                                               periodo=confirmarmatricula.matricula.nivel.periodo,
                                                               tipo=1)
                                auditoria.save(request)
                            else:
                                filas[1].value = "NO HAY INSCRIPCION"
                        linea += 1
                miarchivo.save(u"%s" % archivo_guardado.archivo.file.name)
                # response = HttpResponse(content_type="application/ms-excel")
                # response['Content-Disposition'] = 'attachment; filename=' + archivo_guardado.archivo.file.name

                return JsonResponse({"result": "ok", "mensaje": u"%s" % archivo_guardado.archivo.file.name, "resultados": u"%s" % archivo_guardado.archivo.file.name})
                # return response
                # wb.save(response)
                # return archivo_guardado.archivo.file.name
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al matricular. %s" % ex})

        elif action == 'recalcula_asistenciazoom':
            try:
                if Materia.objects.filter(pk=request.POST['id'], nivel__modalidad_id=3, status=True).exists():
                    return JsonResponse({"result": "bad", "mensaje": u"No puede recalcular asistencias, esta materia es en línea"})

                mat = Materia.objects.get(pk=request.POST['id'])
                for asignadomateria in mat.asignados_a_esta_materia():

                    if asignadomateria.asistencias_zoom_valida() > 0:
                        asistvalida = asignadomateria.asistencias_zoom_valida()
                        asistotal = asignadomateria.cantidad_asistencias_zoom()
                        por = round(((asistvalida * 100) / asistotal), 0)
                        if por >= 69.5 and por < 70:
                            por = 70
                            print(asignadomateria, por)
                        asignadomateria.asistenciafinal = por
                        asignadomateria.save()
                        asignadomateria.actualiza_estado()
                        asignadomateria.actualiza_notafinal()

                return JsonResponse({"result": "ok", "mensaje": u"Asistencias recalculadas"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al recalcular asistencias. %s" % ex})

        elif action == 'delplanificacion':
            try:
                planificacion = TipoPlanificacionClaseSilabo.objects.get(pk=int(encrypt(request.POST['id'])), periodo=periodo)
                if planificacion.planificacionclasesilabo_materia_set.filter(status=True).exists():
                    for materia in planificacion.planificacionclasesilabo_materia_set.filter(status=True):
                        log(u'Eliminó la materia %s de la planificacion : %s' % (materia, planificacion), request, "del")
                        materia = planificacion.planificacionclasesilabo_materia_set.all()
                        materia.delete()
                if planificacion.planificacionclasesilabo_set.filter(status=True).exists():
                    for semana in planificacion.planificacionclasesilabo_set.filter(status=True):
                        log(u'Eliminó la semana %s de la Planificacion la semana  %s' % (semana, planificacion), request, "del")
                        semana.delete()
                log(u'Eliminó Planificación de Silabo: %s del periodo %s' % (planificacion, periodo), request, "del")
                planificacion.delete()
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'delplanificacionexclude':
            try:
                planificacion = PlanificacionClaseSilabo_Materia.objects.get(tipoplanificacion_id=int(encrypt(request.POST['id'])), materia_id=request.POST['idmate'])
                planificacion.delete()
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex})

        elif action == 'viewMateriasMoverParaleloAdmision':
            try:
                if not 'idp' in request.POST:
                    raise NameError(u"No se encontro parametro de paralelo")
                if not Paralelo.objects.filter(pk=request.POST['idp']):
                    raise NameError(u"No se encontro el paralelo")
                data['paralelo'] = paralelo = Paralelo.objects.get(pk=request.POST['idp'])
                if not 'idc' in request.POST:
                    raise NameError(u"No se encontro parametro de carrera")
                if not Carrera.objects.filter(pk=request.POST['idc']):
                    raise NameError(u"No se encontro la carrera")
                data['carrera'] = carrera = Carrera.objects.get(pk=request.POST['idc'])
                if not 'idm' in request.POST:
                    raise NameError(u"No se encontro parametro de modalidad")
                if not Modalidad.objects.filter(pk=request.POST['idm']):
                    raise NameError(u"No se encontro la modalidad")
                data['modalidad'] = modalidad = Modalidad.objects.get(pk=request.POST['idm'])
                if not 'idn' in request.POST:
                    raise NameError(u"No se encontro parametro de nivel")
                if not Nivel.objects.filter(pk=request.POST['idn']):
                    raise NameError(u"No se encontro la nivel")
                data['nivel'] = nivel = Nivel.objects.get(pk=request.POST['idn'])
                data['materias'] = materias = Materia.objects.filter(status=True, nivel=nivel, asignaturamalla__malla__carrera=carrera, asignaturamalla__malla__modalidad=modalidad, paralelomateria=paralelo)
                template = get_template("niveles/mover_alumnos_masivo_admision/ver_materias.html")
                json_content = template.render(data)
                return JsonResponse({"result": "ok", "html": json_content})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos."})

        elif action == 'viewMoverAlumnosMasivoAdmision':
            try:
                data['title'] = u'Mover alumnos masivo'
                data['niveles'] = niveles = Nivel.objects.filter(status=True, periodo=periodo)
                template = get_template("niveles/mover_alumnos_masivo_admision/data_inicial.html")
                json_content = template.render(data)
                return JsonResponse({"result": "ok", "html": json_content})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos."})

        elif action == 'viewParalelosMove':
            try:
                if not 'idp' in request.POST:
                    raise NameError(u"No se encontro parametro de paralelo")
                if not Paralelo.objects.filter(pk=request.POST['idp']):
                    raise NameError(u"No se encontro el paralelo")
                data['paralelo'] = paralelo = Paralelo.objects.get(pk=request.POST['idp'])
                if not 'idc' in request.POST:
                    raise NameError(u"No se encontro parametro de carrera")
                if not Carrera.objects.filter(pk=request.POST['idc']):
                    raise NameError(u"No se encontro la carrera")
                data['carrera'] = carrera = Carrera.objects.get(pk=request.POST['idc'])
                if not 'idm' in request.POST:
                    raise NameError(u"No se encontro parametro de modalidad")
                if not Modalidad.objects.filter(pk=request.POST['idm']):
                    raise NameError(u"No se encontro la modalidad")
                data['modalidad'] = modalidad = Modalidad.objects.get(pk=request.POST['idm'])
                if not 'idn' in request.POST:
                    raise NameError(u"No se encontro parametro de nivel")
                if not Nivel.objects.filter(pk=request.POST['idn']):
                    raise NameError(u"No se encontro la nivel")
                data['nivel'] = nivel = Nivel.objects.get(pk=request.POST['idn'])
                data['gear'] = gear = request.POST['gear']
                if gear == 'one':
                    if not 'idma' in request.POST:
                        raise NameError(u"No se encontro parametro de materia asignada")
                    if not MateriaAsignada.objects.filter(pk=request.POST['idma']):
                        raise NameError(u"No se encontro la materia asignada")

                    data['materiaasignada'] = materiaasignada = MateriaAsignada.objects.get(pk=request.POST['idma'])
                    data['materias'] = materias = Materia.objects.filter(status=True, nivel=materiaasignada.materia.nivel, asignaturamalla__malla__carrera=materiaasignada.matricula.inscripcion.carrera, asignaturamalla__malla__modalidad=materiaasignada.matricula.inscripcion.modalidad).exclude(paralelomateria=materiaasignada.materia.paralelomateria).order_by('paralelomateria__nombre')
                    data['paralelos'] = paralelos = Paralelo.objects.filter(pk__in=materias.values_list("paralelomateria_id", flat=True).distinct()).order_by('nombre')

                if gear == 'all':
                    materiaasignadas = None
                    lista_items1 = json.loads(request.POST['lista_items1'])
                    lista = []
                    for l in lista_items1:
                        lista.append(l['id'])
                    if lista:
                        materiaasignadas = MateriaAsignada.objects.filter(pk__in=lista)
                    data['materiaasignadas'] = materiaasignadas
                    data['materias'] = materias = Materia.objects.filter(status=True, nivel=nivel, asignaturamalla__malla__carrera=carrera, asignaturamalla__malla__modalidad=modalidad).exclude(paralelomateria=paralelo).order_by('paralelomateria__nombre')
                    data['paralelos'] = paralelos = Paralelo.objects.filter(pk__in=materias.values_list("paralelomateria_id", flat=True).distinct()).order_by('nombre')

                template = get_template("niveles/mover_alumnos_masivo_admision/open_materias.html")
                json_content = template.render(data)
                return JsonResponse({"result": "ok", "html": json_content})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex.__str__()})

        elif action == 'moveParaleloAllAdmision':
            try:
                if not 'idp' in request.POST:
                    raise NameError(u"No se encontro parametro de paralelo")
                if not Paralelo.objects.filter(pk=request.POST['idp']):
                    raise NameError(u"No se encontro el paralelo")
                paralelo = Paralelo.objects.get(pk=request.POST['idp'])
                if not 'idc' in request.POST:
                    raise NameError(u"No se encontro parametro de carrera")
                if not Carrera.objects.filter(pk=request.POST['idc']):
                    raise NameError(u"No se encontro la carrera")
                carrera = Carrera.objects.get(pk=request.POST['idc'])
                if not 'idm' in request.POST:
                    raise NameError(u"No se encontro parametro de modalidad")
                if not Modalidad.objects.filter(pk=request.POST['idm']):
                    raise NameError(u"No se encontro la modalidad")
                modalidad = Modalidad.objects.get(pk=request.POST['idm'])
                if not 'idn' in request.POST:
                    raise NameError(u"No se encontro parametro de nivel")
                if not Nivel.objects.filter(pk=request.POST['idn']):
                    raise NameError(u"No se encontro la nivel")
                nivel = Nivel.objects.get(pk=request.POST['idn'])
                if not 'idpf' in request.POST:
                    raise NameError(u"No se encontro parametro de paralelo a mover")
                if not Paralelo.objects.filter(pk=request.POST['idpf']):
                    raise NameError(u"No se encontro parametro de paralelo a mover")
                paralelo_f = Paralelo.objects.get(pk=request.POST['idpf'])
                materiaasignadas = None
                lista_items1 = json.loads(request.POST['lista_items1'])
                lista = []
                for l in lista_items1:
                    lista.append(l['id'])
                if lista:
                    materiaasignadas = MateriaAsignada.objects.filter(pk__in=lista)
                if not materiaasignadas.exists():
                    raise NameError(u"No se encontro alumnos a mover")
                for materiasignada in materiaasignadas:
                    elimino = False
                    if materiasignada.cerrado:
                        raise NameError(u"La materia se encunetra cerradda")
                    matricula = materiasignada.matricula
                    # mis_materias = matricula.materias()

                    materias = Materia.objects.filter(status=True, nivel=nivel, asignaturamalla__malla__carrera=carrera, asignaturamalla__malla__modalidad=modalidad, paralelomateria=paralelo_f, asignaturamalla=materiasignada.materia.asignaturamalla)
                    if not materias.exists():
                        raise NameError(f"Materia {materiasignada.materia.asignatura} no encontrada")
                    materia = materias[0]
                    if materiasignada.materia.id != materia.id:
                        materiaasignada_aux = materiasignada
                        materiasignada.delete()
                        elimino = True
                        agrego = False
                        if not MateriaAsignada.objects.filter(matricula=matricula, materia=materia).exists():
                            eMateriaAsignada = MateriaAsignada(matricula=matricula,
                                                               materia=materia,
                                                               notafinal=0,
                                                               asistenciafinal=100,
                                                               cerrado=False,
                                                               observaciones='',
                                                               estado_id=NOTA_ESTADO_EN_CURSO,
                                                               status=materiaasignada_aux.status)
                            eMateriaAsignada.save(request)
                            eMateriaAsignada.matriculas = eMateriaAsignada.cantidad_matriculas()
                            eMateriaAsignada.asistencias()
                            eMateriaAsignada.evaluacion()
                            eMateriaAsignada.mis_planificaciones()
                            eMateriaAsignada.matricula.actualizar_horas_creditos()
                            eMateriaAsignada.save(request)
                            agrego = True
                            profesormateria = None
                            matriculacupoadicional = False
                            estudiantepractica = None
                            grupoprofesormateria = None
                            if MATRICULACION_LIBRE:
                                if not materia.tiene_capacidad_all():
                                    if materia.cupoadicional > 0:
                                        if not materia.existen_cupos_con_adicional_all():
                                            raise NameError(f"No existe cupo adicional para esta materia {eMateriaAsignada.materia.asignatura}")
                                        else:
                                            matriculacupoadicional = True
                                    else:
                                        raise NameError(f"No existe cupo para esta materia {eMateriaAsignada.materia.asignatura}")
                            if matriculacupoadicional:
                                materia.totalmatriculadocupoadicional += 1
                                materia.cupo += 1
                                materia.save(request)
                                log(u'Estudiante matriculado en cupo adicional materia: %s - estudiante: %s y se aumento un cupo en materia' % (materia, eMateriaAsignada.matricula), request, "add")
                        if elimino:
                            log(u'Se quita materia: %s del paralelo %s. Al alumno: %s' % (materia.asignatura, materiaasignada_aux.materia.paralelomateria, matricula), request, "del")
                        if agrego:
                            log(u'Se agrega materia: %s del paralelo %s. Al alumno: %s' % (materia.asignatura, eMateriaAsignada.materia.paralelomateria, matricula), request, "add")

                return JsonResponse({"result": "ok", "mensaje": u"Se realizo el cambio de paralelo correctamente"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex.__str__()})

        elif action == 'moveParaleloOneToOneAdmision':
            try:
                if not 'idma' in request.POST:
                    raise NameError(u"No se encontro parametro de materia asignada")
                if not MateriaAsignada.objects.filter(pk=request.POST['idma']):
                    raise NameError(u"No se encontro la materia asignada")
                materiaasignada = MateriaAsignada.objects.get(pk=request.POST['idma'])
                if not 'idmat' in request.POST:
                    raise NameError(u"No se encontro parametro de materia")
                if not Materia.objects.filter(pk=request.POST['idmat'], status=True):
                    raise NameError(u"No se encontro la materia")
                materia = Materia.objects.get(pk=request.POST['idmat'])
                elimino = False
                if materiaasignada.cerrado:
                    raise NameError(u"La materia se encunetra cerrada")
                matricula = materiaasignada.matricula
                # mis_materias = matricula.materias()
                if materiaasignada.materia.id != materia.id:
                    materiaasignada_aux = materiaasignada
                    materiaasignada.delete()
                    elimino = True
                    agrego = False
                    if not MateriaAsignada.objects.filter(matricula=matricula, materia=materia).exists():
                        eMateriaAsignada = MateriaAsignada(matricula=matricula,
                                                           materia=materia,
                                                           notafinal=0,
                                                           asistenciafinal=100,
                                                           cerrado=False,
                                                           observaciones='',
                                                           estado_id=NOTA_ESTADO_EN_CURSO,
                                                           status=materiaasignada_aux.status)
                        eMateriaAsignada.save(request)
                        eMateriaAsignada.matriculas = eMateriaAsignada.cantidad_matriculas()
                        eMateriaAsignada.asistencias()
                        eMateriaAsignada.evaluacion()
                        eMateriaAsignada.mis_planificaciones()
                        eMateriaAsignada.matricula.actualizar_horas_creditos()
                        eMateriaAsignada.save(request)
                        agrego = True
                        profesormateria = None
                        matriculacupoadicional = False
                        estudiantepractica = None
                        grupoprofesormateria = None
                        if MATRICULACION_LIBRE:
                            if not materia.tiene_capacidad_all():
                                if materia.cupoadicional > 0:
                                    if not materia.existen_cupos_con_adicional_all():
                                        raise NameError(f"No existe cupo adicional para esta materia {eMateriaAsignada.materia.asignatura}")
                                    else:
                                        matriculacupoadicional = True
                                else:
                                    raise NameError(f"No existe cupo para esta materia {eMateriaAsignada.materia.asignatura}")
                        if matriculacupoadicional:
                            materia.totalmatriculadocupoadicional += 1
                            materia.cupo += 1
                            materia.save(request)
                            log(u'Estudiante matriculado en cupo adicional materia: %s - estudiante: %s y se aumento un cupo en materia' % (materia, eMateriaAsignada.matricula), request, "add")
                    if elimino:
                        log(u'Se quita materia: %s del paralelo %s. Al alumno: %s' % (materia.asignatura, materiaasignada_aux.materia.paralelomateria, matricula), request, "del")
                    if agrego:
                        log(u'Se agrega materia: %s del paralelo %s. Al alumno: %s' % (materia.asignatura, eMateriaAsignada.materia.paralelomateria, matricula), request, "add")

                return JsonResponse({"result": "ok", "mensaje": u"Se realizo el cambio de paralelo correctamente"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. %s" % ex.__str__()})

        elif action == 'actualizar_un_estudiante_moodle':
            try:
                matricula = Matricula.objects.get(pk=request.POST['matricula'], status=True)
                materia = Materia.objects.get(pk=request.POST['materia'], status=True)
                if materia.coordinacion().id == 9:
                    tipourl = 2
                else:
                    tipourl = 1
                materia.crear_actualizar_un_estudiante_curso(moodle, tipourl, matricula)
                # time.sleep(60)
                return JsonResponse({"result": "ok", "mensaje": u"Estudiante creado/actualizado en moodle."})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al crear/actualizar estudiante en moodle."})

        elif action == 'listAlumnos_x_Materia':
            try:
                if not 'idm' in request.POST:
                    raise NameError(u"Parametro de materia no encontrada")
                if not Materia.objects.values("id").filter(pk=request.POST['idm'], status=True).exists():
                    raise NameError(u"Materia no eonctrada")
                materia = Materia.objects.get(pk=request.POST['idm'])
                matriculas = []
                asignados = materia.asignados_a_esta_materia_moodle()
                for materiaasignada in asignados:
                    matriculas.append({"id": materiaasignada.matricula.id, "alumno": materiaasignada.matricula.inscripcion.persona.__str__()})
                return JsonResponse({"result": "ok", "mensaje": u"", "aData": matriculas, "Total": asignados.count()})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos. %s" % ex.__str__(), "aData": [], "Total": 0})

        elif action == 'actualizar_asistencia':
            try:
                materia = Materia.objects.get(pk=encrypt(request.POST['id']))
                materiasasignadas = materia.asignados_a_esta_materia().filter(cerrado=False)
                for materiaasignada in materiasasignadas:
                    materiaasignada.save(actualiza=True)
                    materiaasignada.actualiza_estado()
                return JsonResponse({"result": "ok", "mensaje": "Se actualizo correctamente las asistencias"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos."})

        elif action == 'invitacionpdf':
            nombre_mes = lambda x: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre","Noviembre", "Diciembre"][int(x) - 1]
            try:
                data = {}
                import unicodedata
                hoy = datetime.now().date()
                data['materia'] = materia = Materia.objects.get(pk=request.POST['idmateria'])
                data['horariotutoria'] = HorarioTutoriaAcademica.objects.filter(profesormateria__materia=materia, status=True).order_by('dia')
                inscripcionconvocatoria = InscripcionConvocatoria.objects.get(pk=request.POST.get('idpostulante'))
                data['inscripcionpostulante'] = inscripcionconvocatoria.postulante
                name = unicodedata.normalize('NFD', u"%s" % inscripcionconvocatoria.postulante.persona).encode('ascii', 'ignore').decode("utf-8").replace(' ', '_').lower()
                filename = generar_nombre(f"/invitaciondip_{name}_", "") + ".pdf"
                month, day = "%02d" % hoy.month, "%02d" % hoy.day
                filepath = u"invitaciondip/%s/%s/%s" % (hoy.year, month, day)
                folder_pdf = os.path.join(os.path.join(SITE_STORAGE, 'media', 'invitaciondip', hoy.year.__str__(), ''))

                os.makedirs(folder_pdf, exist_ok=True)
                os.makedirs(os.path.join(folder_pdf, month, ''), exist_ok=True)
                os.makedirs(os.path.join(folder_pdf, month, day, ''), exist_ok=True)

                if not InscripcionInvitacion.objects.filter(status=True, materia_id=materia.id, inscripcion_id=inscripcionconvocatoria.id).exists():
                    invitacion = InscripcionInvitacion(materia_id=materia.id, pasosproceso_id=1, inscripcion_id=inscripcionconvocatoria.id)
                else:
                    invitacion = InscripcionInvitacion.objects.get(materia_id=materia.id, inscripcion_id=inscripcionconvocatoria.id, status=True)

                invitacion.estadoinvitacion = 2
                invitacion.archivo = filepath + filename
                invitacion.save(request)

                historial = HistorialInvitacion(invitacion=invitacion, pasosproceso_id=1, estadoinvitacion=2, personaaprobador=persona, observacion='Envío de invitación')
                historial.archivo = filepath + filename
                historial.save(request)

                data['firma'] = FirmaPersona.objects.filter(persona__pk=26497, status=True).first()
                mes = "%s" % nombre_mes(int(hoy.strftime("%m")))
                data['fechacabecera'] = f"Milagro, {day} de {mes.lower()} del {hoy.year}"

                newfile = convert_html_to_pdf('adm_postulacion/docs/invitacionpdf.html', {'pagesize': 'A4', 'data': data}, filename, os.path.join(os.path.join(SITE_STORAGE, 'media', filepath, '')))

                if not newfile:
                    transaction.set_rollback(True)
                    return JsonResponse({"result": False, "mensaje": f"Error al crear el archivo."})

                return JsonResponse({"result": True, "url": f"{invitacion.archivo.url}"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": False, "mensaje": f"Error de conexión. %s" % ex.__str__()})

        elif action == 'subirinvitacion':
            try:
                f = ArchivoInvitacionForm(request.POST, request.FILES)
                hoy = datetime.now().date()
                d = request.FILES['archivo']
                extension = d._name.split('.')
                tam = len(extension)
                exte = extension[tam - 1]
                if d.size > 6291456:
                    return JsonResponse({"result": "bad", "mensaje": u"Error, archivo mayor a 6 Mb."})
                if not exte.lower() == 'pdf':
                    return JsonResponse({"result": "bad", "mensaje": u"Solo se permiten archivos .pdf"})
                if f.is_valid():
                    if 'archivo' in request.FILES:
                        newfile = request.FILES['archivo']
                        newfile._name = generar_nombre("invitaciondip_", newfile._name)
                        idmate=request.POST['idmate']
                        idpostu=request.POST['idpostu']
                        if not InscripcionInvitacion.objects.filter(status=True, materia_id=idmate, inscripcion_id=idpostu).exists():
                            invitacion = InscripcionInvitacion(materia_id=idmate, archivo=newfile, pasosproceso_id=1, inscripcion_id=idpostu)
                        else:
                            invitacion = InscripcionInvitacion.objects.get(materia_id=idmate, inscripcion_id=idpostu, status=True)
                            invitacion.archivo = newfile

                        invitacion.estadoinvitacion = 4
                        invitacion.save(request)
                        # postu = invitacion.inscripcion.postulante
                        # postu.estado = 2
                        # postu.save()
                        historial = HistorialInvitacion(invitacion=invitacion, pasosproceso_id=1, estado=2, personaaprobador=persona, observacion='Envío de invitación')
                        historial.archivo = newfile if newfile else None
                        historial.save(request)
                    return JsonResponse({"result": "ok"})
                else:
                    raise NameError('Error al validar los datos. Algunos campos estan vacíos')
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos.%s " % ex.__str__()})

        elif action == 'savePeriodoActaAdmision':
            try:
                id = int(request.POST['id']) if 'id' in request.POST and request.POST['id'] and int(request.POST['id']) != 0 else None
                typeForm = 'new'
                # periodomatricula = None
                # if not f.is_valid():
                #     # [(k, v[0]) for k, v in f.errors.items()]
                #     for k, v in f.errors.items():
                #         raise NameError(v[0])
                if typeForm in ['new', 'edit']:
                    puede_realizar_accion(request, 'inno.puede_editar_configuracion_acta_calificacion_admision')
                    ePeriodoActaAdmision= PeriodoActaAdmision.objects.filter(pk=id).first()
                    if ePeriodoActaAdmision:
                        # Editar periodo  asignatruas y responsables para el periodo acta de admision
                        if 'asignaturas' in request.POST:
                            asignaturas = json.loads(request.POST['asignaturas'])
                            if asignaturas:
                                idas = []
                                for asignatura in asignaturas:
                                    asignatura_id = int(asignatura['id'])
                                    accionasig = 'edit'
                                    eAsignaturaActaAdmision = ePeriodoActaAdmision.responsablesasignaturas.filter(asignatura_id=asignatura_id).first()
                                    if not eAsignaturaActaAdmision:
                                        eAsignaturaActaAdmision = AsignaturaActaAdmision(asignatura_id=asignatura['id'])
                                        accionasig = 'add'
                                        eAsignaturaActaAdmision.save(request)

                                    idresps = []
                                    for responsable in asignatura['responsables']:
                                        #si no vienen fecha se  trata de que se creara un nuevo registro caso contratio sera editado
                                        responsable_id = int(responsable['id'])
                                        accion = 'edit'
                                        if not 'fecha_creacion' in responsable:
                                            eResponsableActaAdmision = ResponsableActaAdmision(
                                                persona_id=int(responsable['persona_id']) if int(
                                                    responsable['persona_id']) else None,
                                                tipoprofesor_id=int(responsable['tipoprofesor_id']) if responsable[
                                                    'tipoprofesor_id'] else None,
                                                tipo=int(responsable['tipo_id']),
                                                cargo=responsable['cargo'],
                                                firmadigital=responsable['firmadigital'],
                                            )
                                            accion = 'add'
                                        else:
                                            eResponsableActaAdmision = eAsignaturaActaAdmision.responsables.filter(id=responsable_id).first()
                                            eResponsableActaAdmision.cargo = responsable['cargo']
                                            eResponsableActaAdmision.firmadigital = responsable['firmadigital']

                                        eResponsableActaAdmision.save(request)
                                        log(u'%s un responsable acta de admisión: %s' %('Adiciono' if accion=='add' else 'Edito', eResponsableActaAdmision), request, accion)
                                        eAsignaturaActaAdmision.responsables.add(eResponsableActaAdmision)
                                        idresps.append(eResponsableActaAdmision.id)
                                        log(u'%s un responsable acta de admisión: %s' % ('Adiciono' if accion == 'add' else 'Edito', eAsignaturaActaAdmision), request, accionasig)

                                    #Responsables Acta Admision eliminat de la configuración
                                    eResponsablesActaAdmisionEliminar = eAsignaturaActaAdmision.responsables.all().exclude(id__in=idresps)
                                    for eResponsableActaAdmision in eResponsablesActaAdmisionEliminar:
                                        registro = eResponsableActaAdmision
                                        eAsignaturaActaAdmision.responsables.remove(eResponsableActaAdmision)
                                        eResponsableActaAdmision.delete()
                                        log(u'Elimino un responsable acta de admisión: %s' % registro, request, "del")


                                    idas.append(eAsignaturaActaAdmision.id)

                                #Asignaturas Acta Admisión a eliminar de la configuración
                                eAsignaturasActaAdmisionEliminar= ePeriodoActaAdmision.responsablesasignaturas.all().exclude(id__in=idas)
                                for eAsignaturaActa in eAsignaturasActaAdmisionEliminar:
                                    registro = eAsignaturaActa
                                    ePeriodoActaAdmision.responsablesasignaturas.remove(eAsignaturaActa)
                                    eAsignaturaActa.delete()
                                    log(u'Elimino un responsables asignatura acta de admisión: %s' % registro, request, "del")
                    else:
                        puede_realizar_accion(request, 'inno.puede_crear_configuracion_acta_calificacion_admision')
                        #Crear  asignatruas y responsables para el periodo acta de admision
                        ePeriodoActaAdmision = PeriodoActaAdmision(periodo=periodo)
                        ePeriodoActaAdmision.save(request)
                        if 'asignaturas' in request.POST:
                            asignaturas = json.loads(request.POST['asignaturas'])
                            if asignaturas:
                                for asignatura in asignaturas:
                                    eAsignaturaActaAdmision = AsignaturaActaAdmision(asignatura_id=asignatura['id'])
                                    eAsignaturaActaAdmision.save(request)

                                    for responsable in asignatura['responsables']:
                                        eResponsableActaAdmision = ResponsableActaAdmision(
                                            persona_id=int(responsable['persona_id'])if int(responsable['persona_id']) else None,
                                            tipoprofesor_id=int(responsable['tipoprofesor_id'])if responsable['tipoprofesor_id'] else None,
                                            tipo=int(responsable['tipo_id']),
                                            cargo=responsable['cargo'],
                                            firmadigital=responsable['firmadigital'],
                                        )
                                        eResponsableActaAdmision.save(request)
                                        log(u'Adiciono un responsable acta de admisión: %s' % eResponsableActaAdmision, request, "add")
                                        eAsignaturaActaAdmision.responsables.add(eResponsableActaAdmision)
                                    log(u'Adiciono un asignatura acta de admisión: %s' % eAsignaturaActaAdmision, request, "add")
                                    ePeriodoActaAdmision.responsablesasignaturas.add(eAsignaturaActaAdmision)
                                    log(u'Adiciono un  Peridoo asignatura acta de admisión: %s' % eAsignaturaActaAdmision, request, "add")

                return JsonResponse({"result": "ok", "mensaje": u"Se guardo correctamente la configuración de la período acta admisión"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos. <br> %s" % ex.__str__()})

        elif action == 'estadoactivorequisitomateria':
            try:
                with transaction.atomic():
                    requisitomateria = RequisitoMateriaUnidadIntegracionCurricular.objects.get(pk=int(request.POST['id']))
                    if requisitomateria.activo:
                        requisitomateria.activo = False
                    else:
                        requisitomateria.activo = True
                    requisitomateria.save(request)
                    log(u'cambio estado activo materia titulacion: %s' % requisitomateria, request, "estadoactivar")
                    res_json = {"error": False}
            except Exception as ex:
                res_json = {'error': True, "message": "Error: {}".format(ex)}
            return JsonResponse(res_json, safe=False)

        elif action == 'estadoinscripcionrequisitomateria':
            try:
                with transaction.atomic():
                    requisitomateria = RequisitoMateriaUnidadIntegracionCurricular.objects.get(pk=int(request.POST['id']))
                    if requisitomateria.inscripcion:
                        requisitomateria.inscripcion = False
                    else:
                        requisitomateria.inscripcion = True
                    requisitomateria.save(request)
                    log(u'cambio estado inscripcion materia titulacion: %s' % requisitomateria, request, "estadoactivar")
                    res_json = {"error": False}
            except Exception as ex:
                res_json = {'error': True, "message": "Error: {}".format(ex)}
            return JsonResponse(res_json, safe=False)

        elif action == 'estadotitulacionrequisitomateria':
            try:
                with transaction.atomic():
                    requisitomateria = RequisitoMateriaUnidadIntegracionCurricular.objects.get(pk=int(request.POST['id']))
                    if requisitomateria.titulacion:
                        requisitomateria.titulacion = False
                    else:
                        requisitomateria.titulacion = True
                    requisitomateria.save(request)
                    log(u'cambio estado titulacion materia titulacion: %s' % requisitomateria, request, "estadoactivar")
                    res_json = {"error": False}
            except Exception as ex:
                res_json = {'error': True, "message": "Error: {}".format(ex)}
            return JsonResponse(res_json, safe=False)

        elif action == 'listadorequisitostitulacion':
            try:
                lista = []
                idmate = int(request.POST['idmate'])
                idmalla = int(request.POST['idmalla'])
                listadorequisitostitulacion = RequisitoTitulacionMalla.objects.filter(malla_id=idmalla, status=True).exclude(requisito_id__in=RequisitoMateriaUnidadIntegracionCurricular.objects.values_list('requisito_id').filter(materia_id=idmate, status=True)).order_by('id')
                for lis in listadorequisitostitulacion:
                    lista.append([lis.requisito.id, lis.requisito.nombre])
                data = {"results": "ok", 'listado': lista}
                return JsonResponse(data)
            except Exception as ex:
                pass

        elif action == 'adicionarrequisitomateria':
            try:
                idmateria = request.POST['idmateria']
                lista = request.POST['lista'].split(',')
                for elemento in lista:
                    if not RequisitoMateriaUnidadIntegracionCurricular.objects.filter(requisito_id=elemento,
                                                                                      materia_id=idmateria, status=True).exists():
                        requisitomateria = RequisitoMateriaUnidadIntegracionCurricular(requisito_id=elemento,
                                                                                       materia_id=idmateria,
                                                                                       titulacion=True,
                                                                                       inscripcion = True)
                        requisitomateria.save(request)
                return JsonResponse({'result': 'ok'})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos."})

        elif action == 'estadoobligatoriorequisitomateria':
            try:
                with transaction.atomic():
                    requisitomateria = RequisitoMateriaUnidadIntegracionCurricular.objects.get(pk=int(request.POST['id']))
                    if requisitomateria.obligatorio:
                        requisitomateria.obligatorio = False
                    else:
                        requisitomateria.obligatorio = True
                    requisitomateria.save(request)
                    log(u'cambio estado obligatorio materia titulacion: %s' % requisitomateria, request, "estadoactivar")
                    res_json = {"error": False}
            except Exception as ex:
                res_json = {'error': True, "message": "Error: {}".format(ex)}
            return JsonResponse(res_json, safe=False)

        elif action == 'estadoenlinearequisitomateria':
            try:
                with transaction.atomic():
                    requisitomateria = RequisitoMateriaUnidadIntegracionCurricular.objects.get(pk=int(request.POST['id']))
                    if requisitomateria.enlineamatriculacion:
                        requisitomateria.enlineamatriculacion = False
                    else:
                        requisitomateria.enlineamatriculacion = True
                    requisitomateria.save(request)
                    log(u'cambio estado enlineamatriculacion materia titulacion: %s' % requisitomateria, request, "estadoactivar")
                    res_json = {"error": False}
            except Exception as ex:
                res_json = {'error': True, "message": "Error: {}".format(ex)}
            return JsonResponse(res_json, safe=False)

        elif action == 'deleterequisitomateria':
            try:
                with transaction.atomic():
                    requisitomateria = RequisitoMateriaUnidadIntegracionCurricular.objects.get(pk=int(request.POST['id']))
                    log(u'elimino requisito materia titulacion: %s' % requisitomateria, request, "del")
                    requisitomateria.delete()
                    res_json = {"error": False}
            except Exception as ex:
                res_json = {'error': True, "message": "Error: {}".format(ex)}
            return JsonResponse(res_json, safe=False)

        elif action == 'addplanificacionmateria':
            try:
                f = PlanificacionMateriaForm(request.POST)
                materia = Materia.objects.get(pk=request.POST['id'])
                actaparalelo = ActaParalelo.objects.filter(convocatoria__asignaturamalla__asignatura=materia.asignaturamalla.asignatura, paralelo=materia.paralelomateria, status=True).first()
                if f.is_valid():
                    if plan := PlanificacionMateria.objects.filter(materia=materia, status=True).first():
                        plan.estado = f.cleaned_data['estado']
                        plan.observacion = f.cleaned_data['observacion']
                        plan.denominacion = f.cleaned_data['denominacion']
                        plan.tipo = f.cleaned_data['tipo']
                        plan.fecha = f.cleaned_data['fecha']
                        plan.fechapago = f.cleaned_data['fechapago']
                        plan.tipodocente=f.cleaned_data['tipodocente']
                        plan.pagado=f.cleaned_data['pagado']
                    else:
                        plan = PlanificacionMateria(materia=materia, fechapago = f.cleaned_data['fechapago'], actaparalelo=actaparalelo, estado=f.cleaned_data['estado'], tipodocente=f.cleaned_data['tipodocente'],pagado = f.cleaned_data['pagado'],denominacion = f.cleaned_data['denominacion'],tipo = f.cleaned_data['tipo'],fecha = f.cleaned_data['fecha'],observacion=f.cleaned_data['observacion'] )
                    plan.save(request)
                    log(u'Adiciono / actualizo PlanificacionMateria posgrado: %s' % plan, request, "add")
                return JsonResponse({"result": True})
            except Exception as ex:
                pass

        elif action == 'save_planificacion_solicitud':
            try:
                id = request.POST.get('id', 0)
                eMateria= Materia.objects.get(pk=id)
                requiere_profesor = json.loads(request.POST.get('requiere_profesor',False))
                requiere_autor = json.loads(request.POST.get('requiere_autor',False))
                requiere_invitado = json.loads(request.POST.get('requiere_invitado',False))
                f = PlanificacionMateriaSolicitudForm(request.POST)
                if f.is_valid():
                    if plan := PlanificacionMateria.objects.filter(materia=eMateria, status=True).first():
                        plan.profesor = requiere_profesor
                        plan.autor = requiere_autor
                        plan.invitado = requiere_invitado
                        plan.lanzar_convocatoria = f.cleaned_data['lanzar_convocatoria']
                        if requiere_profesor and not requiere_invitado and not requiere_autor:
                            plan.inicio_profesor = f.cleaned_data['inicio_profesor']
                            plan.fin_profesor = f.cleaned_data['fin_profesor']
                            plan.inicio_autor = None
                            plan.fin_autor = None
                            plan.inicio_invitado = None
                            plan.fin_invitado = None

                            #
                            eMateria.inicio = f.cleaned_data['inicio_profesor']
                            eMateria.fin = f.cleaned_data['fin_profesor']
                            eMateria.save(request)
                            #
                        if requiere_invitado and not requiere_profesor and not requiere_autor:
                            plan.inicio_invitado = f.cleaned_data['inicio_invitado']
                            plan.fin_invitado = f.cleaned_data['fin_invitado']
                            plan.inicio_profesor = None
                            plan.fin_profesor = None
                            plan.inicio_autor = None
                            plan.fin_autor = None
                            plan.lanzar_convocatoria =False
                            #
                            eMateria.inicio = f.cleaned_data['inicio_invitado']
                            eMateria.fin = f.cleaned_data['fin_invitado']
                            eMateria.save(request)
                            #
                        if requiere_profesor and requiere_autor and not requiere_invitado:
                            plan.inicio_profesor = f.cleaned_data['inicio_profesor']
                            plan.fin_profesor = f.cleaned_data['fin_profesor']
                            plan.inicio_autor = f.cleaned_data['inicio_autor']
                            plan.fin_autor = f.cleaned_data['fin_autor']

                            plan.inicio_invitado = None
                            plan.fin_invitado = None
                            #
                            eMateria.inicio = f.cleaned_data['inicio_profesor']
                            eMateria.fin = f.cleaned_data['fin_profesor']
                            eMateria.save(request)
                            #
                        if requiere_invitado and requiere_autor and not requiere_profesor:
                            plan.inicio_invitado = f.cleaned_data['inicio_invitado']
                            plan.fin_invitado = f.cleaned_data['fin_invitado']
                            plan.inicio_autor = f.cleaned_data['inicio_autor']
                            plan.fin_autor = f.cleaned_data['fin_autor']

                            plan.inicio_profesor = None
                            plan.fin_profesor = None
                            #
                            eMateria.inicio = f.cleaned_data['inicio_invitado']
                            eMateria.fin = f.cleaned_data['fin_invitado']
                            eMateria.save(request)
                            #


                        plan.observacionsolicitud=f.cleaned_data['observacionsolicitud']
                    else:
                        plan = PlanificacionMateria(
                            materia=eMateria,
                            estado=0,
                            tipo=3,
                            denominacion=5,
                            profesor =  requiere_profesor,
                            autor = requiere_autor,
                            invitado = requiere_invitado,
                            lanzar_convocatoria = f.cleaned_data['lanzar_convocatoria'],
                            inicio_profesor = f.cleaned_data['inicio_profesor'] ,
                            fin_profesor = f.cleaned_data['fin_profesor'],
                            inicio_autor = f.cleaned_data['inicio_autor'] ,
                            fin_autor = f.cleaned_data['fin_autor'] ,
                            inicio_invitado=f.cleaned_data['inicio_invitado'],
                            fin_invitado=f.cleaned_data['fin_invitado'],
                            observacionsolicitud = f.cleaned_data['observacionsolicitud'])

                        if requiere_profesor and not requiere_invitado and not requiere_autor:
                            eMateria.inicio = f.cleaned_data['inicio_profesor']
                            eMateria.fin = f.cleaned_data['fin_profesor']
                            eMateria.save(request)
                        if requiere_invitado and not requiere_profesor and not requiere_autor:
                            plan.lanzar_convocatoria = False
                            eMateria.inicio = f.cleaned_data['inicio_invitado']
                            eMateria.fin = f.cleaned_data['fin_invitado']
                            eMateria.save(request)
                        if requiere_profesor and requiere_autor and not requiere_invitado:
                            eMateria.inicio = f.cleaned_data['inicio_profesor']
                            eMateria.fin = f.cleaned_data['fin_profesor']
                            eMateria.save(request)
                        if requiere_invitado and requiere_autor and not requiere_profesor:
                            eMateria.inicio = f.cleaned_data['inicio_invitado']
                            eMateria.fin = f.cleaned_data['fin_invitado']
                            eMateria.save(request)

                    plan.save(request)

                    log(u'Adiciono / actualizo PlanificacionMateria solicitud posgrado: %s' % plan, request, "add")
                return JsonResponse({"result": False})
            except Exception as ex:
                pass

        elif action == 'notificar_planificacion_completa':
            try:
                pk = request.POST.get('id',0)
                if pk == 0:
                    raise NameError("No se encontro el parametro")
                eMateria = Materia.objects.get(pk=pk)
                ePlanificacionMateria = PlanificacionMateria.objects.filter(status=True, materia = eMateria).first()
                ePlanificacionMateria.estado = 2
                ePlanificacionMateria.save(request)
                eUsers = User.objects.filter(groups__id=422)
                ePersonalApoyoMaestrias = None

                if ePlanificacionMateria:
                    carrera = ePlanificacionMateria.materia.asignaturamalla.malla.carrera
                    ePersonalApoyoMaestrias = PersonalApoyoMaestria.objects.filter(status=True, carrera=carrera,periodo=periodo)

                a=notificar_planificacion_completa_posgrado(request,eUsers,ePersonalApoyoMaestrias,eMateria)
                a.start()





                return JsonResponse({"result": "ok"})
            except Exception as ex:
                return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos."})
                pass

        elif action =='reporte_planificacion_materias_posgrado':
            try:
                malla_id = request.POST.get('id')
                return reporte_planificacion_materias_posgrado(int(malla_id))
            except Exception as ex:
                pass

        elif action == 'cargarcursos':
            try:
                with transaction.atomic():
                    idmallas = Materia.objects.values_list('asignaturamalla__malla__id').filter(
                        nivel__periodo=periodo, status=True)
                    # carreras = Carrera.objects.filter(pk__in=idcarreras, status=True)
                    mallas = Malla.objects.filter(status=True, pk__in=idmallas,carrera__coordinacion__id__in=[1,2,3,4,5,7,9])
                    for malla in mallas:
                        malla = Malla.objects.get(status=True, pk=malla.id)
                        for nivel in malla.niveles_malla():
                            paralelos = Paralelo.objects.filter(nombre__in=Materia.objects.values_list('paralelo', flat=True).filter(status=True, asignaturamalla__malla=malla, nivel__periodo=periodo).distinct(), status=True)
                            for paralelo in paralelos:
                                if not PresidenteCurso.objects.filter(status=True, carrera_id=malla.carrera.id, nivel_id=nivel.id, paralelo_id=paralelo.id, activo=True, desde=periodo.inicio, hasta=periodo.fin).exists():
                                    curso = PresidenteCurso(
                                        carrera_id = malla.carrera.id,
                                        nivel_id = nivel.id,
                                        paralelo_id = paralelo.id,
                                        desde = periodo.inicio,
                                        hasta = periodo.fin,
                                        activo = True
                                    )
                                    curso.save(request)

                    return JsonResponse({"result": "ok"})
                    #res_json = {"error": False}
            except Exception as ex:
                res_json = {'error': True, "message": "Error: {}".format(ex)}
            return JsonResponse(res_json, safe=False)

        elif action == 'editpresidentecurso':
            try:
                presidente = PresidenteCurso.objects.get(id=int(request.POST['id']),status=True)
                form = PresidenteCursoForm(request.POST)
                if not form.is_valid():
                    raise NameError("%s" % [{k: v[0]} for k, v in form.errors.items()])
                if form.cleaned_data['presidente']:
                    presidente.matricula_id=form.cleaned_data['presidente']
                presidente.desde=form.cleaned_data['desde']
                presidente.hasta=form.cleaned_data['hasta']
                presidente.activo=form.cleaned_data['activo']
                presidente.save(request)
                log("Edito presidente de curso: %s" % presidente.carrera.__str__(), request, 'change')
                return JsonResponse({"result": False})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": True, "mensaje": u"Error al guardar los datos."})

        elif action == 'delpresidentecurso':
            try:
                presidente = PresidenteCurso.objects.get(pk=int(request.POST['id']))
                # if periodo.esta_cap_evento_periodo_activo():
                #     return JsonResponse({"result": "bad","mensaje": u"No se puede Eliminar el Periodo, tiene planificacion de evento Activas.."})
                presidente.status=False
                presidente.save(request)
                log("Elimino presidente de curso: %s" % presidente.carrera.__str__(), request, 'del')
                return JsonResponse({"result": "ok"})
            except Exception as ex:
                transaction.set_rollback(True)
                return JsonResponse({"result": "bad", "mensaje": u"Error al eliminar los datos."})

        elif action == 'generateReportMatriculados':
            try:
                params = {
                    "periodo_id": periodo.id,
                    "persona_id": persona.id
                }
                async_task(rpt_matriculados_pregrado_sin_modulos, params)
                # rpt_matriculados_pregrado_sin_modulos(params)
                return JsonResponse({"result": True, "mensaje": u"Reporte se esta generando en segundo plano."})
            except Exception as ex:
                return JsonResponse({"result": False, "mensaje": u"Error al generar el reporte."})
        elif action == 'reportetransversales':
            try:
                data = {"periodo_id": periodo.id}
                eNotificacion = Notificacion(cuerpo='Generación de reporte de excel en progreso',
                titulo=f'Reportes de est'.strip(),
                destinatario=persona, url='', prioridad=1, app_label='SGA', fecha_hora_visible=datetime.now() + timedelta(days=1),
                                             tipo=2, en_proceso=True)
                eNotificacion.save(request)
                reporte_transversales_background(request=request, data=data, notiid=eNotificacion.id, periodo=periodo).start()
                return JsonResponse({"result": True,
                                     "mensaje": u"El reporte se está realizando. Verifique su apartado de notificaciones después de unos minutos.",
                                     "btn_notificaciones": traerNotificaciones(request, data, persona)})
            except Exception as ex:
                return JsonResponse({"result": False, "mensaje": u"Error al generar el reporte."})
        elif action == 'reportedistributivo':
            try:
                data = {"periodo_id": periodo.id}
                eNotificacion = Notificacion(cuerpo='Generación de reporte de excel en progreso',
                                             titulo=f'Reporte del distributivo de asignaturas',
                                             destinatario=persona, url='', prioridad=1, app_label='SGA',
                                             fecha_hora_visible=datetime.now() + timedelta(days=1),
                                             tipo=2, en_proceso=True)
                eNotificacion.save(request)
                reporte_distributivo_asignaturas_background(request=request, data=data, notiid=eNotificacion.id,
                                                            periodo=periodo.id).start()
                return JsonResponse({"result": True,
                                     "mensaje": u"El reporte se está realizando. Verifique su apartado de notificaciones después de unos minutos.",
                                     "btn_notificaciones": traerNotificaciones(request, data, persona)})
            except Exception as ex:
                return JsonResponse({"result": False, "mensaje": f"Error al generar el reporte {ex}"})

        return JsonResponse({"result": "bad", "mensaje": u"Solicitud Incorrecta."})

    else:
        if 'action' in request.GET:
            data['action'] = action = request.GET['action']

            if action == 'generar-invitacion':
                try:
                    hoy = datetime.now().date()
                    nombre_mes = lambda x: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"][int(x) - 1]
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['idmateria'])
                    data['horariotutoria'] = HorarioTutoriaAcademica.objects.filter(profesormateria__materia=materia, status=True).order_by('dia')
                    inscripcionconvocatoria = InscripcionConvocatoria.objects.get(pk=request.GET.get('idpostulante'))
                    data['inscripcionpostulante'] = inscripcionconvocatoria.postulante
                    data['firma'] = FirmaPersona.objects.filter(persona__pk=26497, status=True).first()
                    mes = nombre_mes(int(hoy.month))
                    data['fechacabecera'] = f"Milagro, {hoy.strftime('%d')} de {mes.lower()} del {hoy.strftime('%Y')}"
                    return download_html_to_pdf('niveles/invitacionpdf.html', {'pagesize': 'A4', 'data': data})
                except Exception as ex:
                    pass

            if action == 'addplanificacionmateria':
                try:
                    if materia := PlanificacionMateria.objects.filter(materia__id=request.GET.get('id'), status=True).first():
                        f = PlanificacionMateriaForm(initial=model_to_dict(materia))
                    else:
                        f = PlanificacionMateriaForm()
                    data['form2'] = f
                    data['id'] = request.GET.get('id')
                    template = get_template('adm_postulacion/modal/formmodal.html')
                    return JsonResponse({"result": True, 'data': template.render(data)})
                except Exception as ex:
                    pass

            if action == 'planificacionmateria':
                try:
                    ePlanificacionMateria = PlanificacionMateria.objects.get(pk=request.GET.get('id'))

                    data['ePlanificacionMateria'] = ePlanificacionMateria
                    template = get_template('adm_postulacion/modal/formmodaldetalleplanmateria.html')
                    return JsonResponse({"result": True, 'data': template.render(data)})
                except Exception as ex:
                    pass

            if action == 'subirinvitacion':
                try:
                    data['title'] = u'Subir y enviar invitación'
                    data['idmate'] = Materia.objects.get(pk=request.GET['idmate'])
                    data['idpostu'] = request.GET['idpostu']
                    data['idasign'] = request.GET['idasign']
                    data['idcv'] = request.GET['idcv']
                    form = ArchivoInvitacionForm()
                    data['form2'] = form
                    template = get_template("niveles/addarchivoinvitacion.html")
                    json_content = template.render(data)
                    return JsonResponse({"result": "ok", 'data': json_content, 'title': data['title']})
                except Exception as ex:
                    pass

            if action == 'add':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_niveles')
                    data['title'] = u'Adicionar nivel académico'
                    periodo = request.session['periodo']
                    coordinacion = Coordinacion.objects.get(pk=request.GET['coordinacion'])
                    form = NivelForm(initial={'coordinacion': coordinacion,
                                              'aplicabecas': True,
                                              'paralelo': periodo.nombre,
                                              'inicio': periodo.inicio,
                                              'fin': periodo.fin,
                                              'fechatopematricula': periodo.fin,
                                              'fechatopematriculaext': periodo.fin,
                                              'fechatopematriculaesp': periodo.fin,
                                              'fechainicioagregacion': periodo.fechainicioagregacion,
                                              'fechafinagregacion': periodo.fechafinagregacion,
                                              'fechafinquitar': periodo.fechafinquitar,
                                              })
                    form.nivellibrecoordinacion(periodo)
                    data['formulario'] = 'nivellibreform'
                    data['coordinacion'] = coordinacion
                    data['form'] = form
                    data['periodo'] = periodo
                    return render(request, "niveles/add.html", data)
                except Exception as ex:
                    pass

            elif action == 'abrirn':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_niveles')
                    n = Nivel.objects.get(pk=request.GET['nid'])
                    n.cerrado = False
                    n.save(request)
                    log(u'Abrio nivel: %s' % n, request, "edit")
                    return HttpResponseRedirect("/niveles?action=materias&id=" + request.GET['nid'])
                except Exception as ex:
                    transaction.set_rollback(True)
                    pass

            elif action == 'edit':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_niveles')
                    data['title'] = u'Editar nivel académico'
                    data['nivel'] = nivel = Nivel.objects.get(pk=request.GET['id'])
                    form = NivelFormEdit(initial={'paralelo': nivel.paralelo,
                                                  'inicio': nivel.inicio,
                                                  'fin': nivel.fin,
                                                  'fechatopematricula': nivel.fechatopematricula,
                                                  'capacidad': nivel.capacidadmatricula,
                                                  'fechatopematriculaext': nivel.fechatopematriculaex,
                                                  'fechatopematriculaesp': nivel.fechatopematriculaes,
                                                  'fechafinagregacion': nivel.fechafinagregacion,
                                                  'fechafinquitar': nivel.fechafinquitar,
                                                  'fechainicioagregacion': nivel.fechainicioagregacion,
                                                  })
                    if MATRICULACION_LIBRE:
                        form.nivellibrecoordinacion()
                    data['form'] = form
                    return render(request, "niveles/edit.html", data)
                except Exception as ex:
                    pass

            elif action == 'copy':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_niveles')
                    data['title'] = u'Duplicar nivel'
                    data['nivel'] = nivel = Nivel.objects.get(pk=request.GET['id'])
                    data['form'] = NivelFormEdit(initial={'paralelo': nivel.paralelo,
                                                          'inicio': nivel.inicio,
                                                          'fin': nivel.fin,
                                                          'fechatopematricula': nivel.fechatopematricula,
                                                          'fechatopematriculaesp': nivel.fechatopematriculaes,
                                                          'fechatopematriculaext': nivel.fechatopematriculaex,
                                                          'fechafinagregacion': nivel.fechafinagregacion,
                                                          'fechafinquitar': nivel.fechafinquitar,
                                                          'fechainicioagregacion': nivel.fechainicioagregacion,
                                                          })
                    return render(request, "niveles/copy.html", data)
                except Exception as ex:
                    pass

            elif action == 'copypagos':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_niveles')
                    data['title'] = u'Copia cronograma de pagos a otro nivel'
                    data['nivel'] = nivel = Nivel.objects.get(pk=request.GET['id'])
                    form = OtroNivelForm()
                    form.sin_minivel(nivel)
                    data['form'] = form
                    return render(request, "niveles/copypagos.html", data)
                except Exception as ex:
                    pass

            elif action == 'del':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_niveles')
                    data['title'] = u'Borrar nivel académico'
                    data['nivel'] = nivel = Nivel.objects.get(pk=request.GET['id'])
                    return render(request, "niveles/del.html", data)
                except Exception as ex:
                    pass

            elif action == 'eliminarmatriculas':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_niveles')
                    data['nivel'] = periodo = Periodo.objects.get(pk=request.GET['id'])
                    data['title'] = u'Eliminar matriculas pendientes de pago del periodo'
                    return render(request, "niveles/eliminamatriculas.html", data)
                except Exception as ex:
                    pass

            elif action == 'actualizarmateriascerradas':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_niveles')
                    data['nivel'] = periodo = Periodo.objects.get(pk=request.GET['id'])
                    data['title'] = u'Actualizar Materias Cerradas'
                    return render(request, "niveles/actualizarmateriascerradas.html", data)
                except Exception as ex:
                    pass

            elif action == 'actualizarasistenciapregrado':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_niveles')
                    data['nivel'] = periodo
                    data['title'] = u'Actualizar Asistencia Pregrado'
                    return render(request, "niveles/actualizarasistenciapregrado.html", data)
                except Exception as ex:
                    pass

            elif action == 'actualizarasistenciaadmision':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_niveles')
                    data['nivel'] = periodo
                    data['title'] = u'Actualizar Asistencia Admisión'
                    return render(request, "niveles/actualizarasistenciaadmision.html", data)
                except Exception as ex:
                    pass

            elif action == 'actualizarprofesorcrirerio':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_niveles')
                    data['nivel'] = periodo = Periodo.objects.get(pk=request.GET['id'])
                    data['title'] = u'Actualizar Profesor Criterio'
                    return render(request, "niveles/actualizarprofesorcrirerio.html", data)
                except Exception as ex:
                    pass

            elif action == 'actualizarnotasmoodle':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_niveles')
                    data['nivel'] = periodo = Periodo.objects.get(pk=request.GET['id'])
                    data['title'] = u'Actualizar Notas Moodle'
                    return render(request, "niveles/actualizarnotasmoodle.html", data)
                except Exception as ex:
                    pass

            elif action == 'vaciarcalificaciones':
                try:
                    puede_realizar_accion(request, 'sga.puede_eliminar_calificaciones_materia')
                    data['title'] = u'Vaciar calificaciones'
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = mallaid = request.GET['nivelmallaid']
                    data['materia'] = Materia.objects.get(pk=request.GET['id'])
                    return render(request, "niveles/vaciarcalificaciones.html", data)
                except Exception as ex:
                    pass

            elif action == 'delallmateria':
                try:
                    puede_realizar_accion(request, 'sga.puede_elimnar_materias')
                    data['title'] = u'Elminación masiva de materias'
                    data['nivelid'] = mallaid = request.GET['id']
                    return render(request, "niveles/delallmateria.html", data)
                except Exception as ex:
                    pass

            elif action == 'diasacalificar':
                try:
                    # puede_realizar_accion(request, 'sga.puede_modificar_materias')
                    data['title'] = u'Dias para calificar la materia'
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = mallaid = request.GET['nivelmallaid']
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['id'])
                    data['form'] = CalificacionDiaForm(
                        initial={'usaperiodocalificaciones': materia.usaperiodocalificaciones,
                                 'diasactivacioncalificaciones': materia.diasactivacioncalificaciones})
                    return render(request, "niveles/diasacalificar.html", data)
                except Exception as ex:
                    pass

            elif action == 'laboratorios':
                try:
                    # puede_realizar_accion(request, 'sga.puede_modificar_materias')
                    data['title'] = u'Asignar Laboratorio'
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = mallaid = request.GET['nivelmallaid']
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['id'])
                    data['form'] = LaboratorioForm(initial={'laboratorio': materia.laboratorio})
                    return render(request, "niveles/laboratorios.html", data)
                except Exception as ex:
                    pass

            elif action == 'fechaasistencias':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_materias')
                    data['title'] = u'Fechas a tomar en cuenta para asistencias'
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = mallaid = request.GET['nivelmallaid']
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['id'])
                    data['form'] = FechafinAsistenciasForm(initial={'fecha': materia.fechafinasistencias})
                    return render(request, "niveles/fechafinasistencias.html", data)
                except Exception as ex:
                    pass

            elif action == 'diasaevaluar':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_autorizacion_evaluacion')
                    data['title'] = u'Dias para evaluar la materia'
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = mallaid = request.GET['nivelmallaid']
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['id'])
                    data['form'] = EvaluacionDiaForm(initial={'usaperiodoevaluacion': materia.usaperiodoevaluacion,
                                                              'diasactivacion': materia.diasactivacion})
                    return render(request, "niveles/diasaevaluar.html", data)
                except Exception as ex:
                    pass

            elif action == 'abrirm':
                try:
                    puede_realizar_accion(request, 'sga.puede_abrir_materia')
                    mallaid = None
                    nivelmallaid = None
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = nivelmallaid = request.GET['nivelmallaid']
                    materia = Materia.objects.get(pk=request.GET['id'])
                    materia.cerrado = False
                    materia.save(request)
                    log(u'Se abrió el acta: codigomateria(%s) - %s' % (materia.id, materia), request, "edit")
                    for asig in materia.asignados_a_esta_materia():
                        asig.cerrado = True
                        asig.save(request, actualiza=False)
                    return HttpResponseRedirect("/niveles?action=materias&id=" + str(materia.nivel.id) + (("&mallaid=" + mallaid) if mallaid else '') + (("&nivelmallaid=" + nivelmallaid) if nivelmallaid else ''))
                except Exception as ex:
                    transaction.set_rollback(True)

            elif action == 'cerrarm':
                try:
                    puede_realizar_accion(request, 'sga.puede_cerrar_materia')
                    mallaid = None
                    nivelmallaid = None
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = nivelmallaid = request.GET['nivelmallaid']
                    materia = Materia.objects.get(pk=request.GET['id'])
                    debe_cerrar_periodo = True
                    if periodo.periodo_academia():
                        if not periodo.periodo_academia().cierra_materia:
                            debe_cerrar_periodo = False
                            raise Exception('En este periodo no debe cerrarse las materias.')
                    if debe_cerrar_periodo:
                        materia.cerrado = True
                        materia.fechacierre = datetime.now().date()
                        materia.save(request)
                        log(u'Se cerró el acta: codigomateria(%s) - %s' % (materia.id, materia), request, "del")
                        for asig in materia.asignados_a_esta_materia():
                            asig.cerrado = True
                            asig.save(request, actualiza=False)
                            asig.actualiza_estado()
                        for asig in materia.asignados_a_esta_materia():
                            asig.cierre_materia_asignada()
                        # materia.materiaasignada_set.all()[0].cierre_materia_asignada_pre()
                    return HttpResponseRedirect("/niveles?action=materias&id=" + str(materia.nivel.id) + (("&mallaid=" + mallaid) if mallaid else '') + (("&nivelmallaid=" + nivelmallaid) if nivelmallaid else ''))
                except Exception as ex:
                    transaction.set_rollback(True)
                    return HttpResponseRedirect("/niveles?action=materias&id=" + str(materia.nivel.id) + (("&mallaid=" + mallaid) if mallaid else '') + (("&nivelmallaid=" + nivelmallaid) if nivelmallaid else '') + ("&info=%s" % ex))
                    # return HttpResponseRedirect("/pro_evaluaciones?materiaid=%s&info=%s" % (request.GET['materiaid'],ex))

            elif action == 'tomandom':
                try:
                    data['title'] = u'Tomando la materia'
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['id'])
                    data['materiasasignadas'] = materia.materiaasignada_set.filter(status=True, matricula__status=True).order_by(
                        'matricula__inscripcion__persona')
                    data['nivel'] = materia.nivel
                    if 'mallaid' in request.GET:
                        data['mallaid'] = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = request.GET['nivelmallaid']
                    return render(request, "niveles/tomandom.html", data)
                except Exception as ex:
                    pass

            elif action == 'verificarenrolado':
                try:
                    tipourl = int(request.GET['tipourl'])
                    idusermoodle = int(request.GET['idusermoodle'])
                    idcursomoodle = int(request.GET['idcursomoodle'])
                    if tipourl == 1:
                        cursor = connections['moodle_db'].cursor()
                    if tipourl == 2:
                        cursor = connections['db_moodle_virtual'].cursor()
                    if tipourl == 3:
                        cursor = connections['moodle_pos'].cursor()

                    if idusermoodle > 0:
                        queryest = """
                                        SELECT DISTINCT asi.userid, asi.roleid
                                        FROM  mooc_role_assignments asi
                                        INNER JOIN MOOC_CONTEXT CON ON asi.CONTEXTID=CON.ID AND ASI.ROLEID=%s 
                                        AND CON.INSTANCEID=%s AND asi.userid =%s
                                            """ % (periodo.rolestudiante, idcursomoodle, idusermoodle)
                        cursor.execute(queryest)
                        rowest = cursor.fetchall()
                        return JsonResponse({"result":"ok","rowest":rowest})
                    else:
                        return JsonResponse({"result":"bad", "mensaje": u"El usuario no se encuentra enrolado"})
                except Exception as ex:
                    return JsonResponse({"result":"bad","mensaje": u"Error al obtener los datos"})

            elif action == 'reporteinscritoenrolado':
                try:
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=reporteenrolados.xls'
                    style0 = easyxf('font: name Times New Roman, color-index blue, bold off', num_format_str='#,##0.00')
                    style_nb = easyxf('font: name Times New Roman, color-index blue, bold on',
                                      num_format_str='#,##0.00')
                    style_sb = easyxf('font: name Times New Roman, color-index blue, bold on')
                    title = easyxf(
                        'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    style1 = easyxf(num_format_str='D-MMM-YY')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = xlwt.Workbook()
                    ws = wb.add_sheet('Sheetname')
                    estilo = xlwt.easyxf(
                        'font: height 350, name Arial, colour_index black, bold on, italic on; align: wrap on, vert centre, horiz center;')
                    ws.write_merge(0, 0, 0, 9, 'UNIVERSIDAD ESTATAL DE MILAGRO', estilo)
                    output_folder = os.path.join(os.path.join(SITE_STORAGE, 'media'))
                    nombre = "Lista" + datetime.now().strftime('%Y%m%d_%H%M%S') + ".xls"
                    filename = os.path.join(output_folder, nombre)
                    columns = [(u"Carrera", 6000),
                               (u"Sesion", 6000),
                               (u"Nivel", 6000),
                               (u"id materia", 6000),
                               (u"Materia", 6000),
                               (u"Paralelo", 6000),
                               (u"Estudiante", 6000),
                               (u"cedula", 6000),
                               (u"Enrolado moodle", 6000),
                               ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], font_style)
                        ws.col(col_num).width = columns[col_num][1]
                    row_num = 4
                    materia = Materia.objects.get(status=True, pk=int(request.GET['materia']))
                    tipourl = int(request.GET['tipourl'])
                    if tipourl == 1:
                        cursor = connections['moodle_db'].cursor()
                    if tipourl == 2:
                        cursor = connections['db_moodle_virtual'].cursor()
                    if tipourl == 3:
                        cursor = connections['moodle_pos'].cursor()

                    for materiaasignada in materia.asignados_a_esta_materia_moodle():
                        enrolado = "SI"
                        query = """ SELECT DISTINCT asi.userid, asi.roleid
                                            FROM  mooc_role_assignments asi
                                            INNER JOIN MOOC_CONTEXT CON ON asi.CONTEXTID=CON.ID AND ASI.ROLEID=%s
                                            AND CON.INSTANCEID=%s AND asi.userid =%s
                                    """ % (materia.nivel.periodo.rolestudiante, materia.idcursomoodle,
                                           materiaasignada.matricula.inscripcion.persona.idusermoodle)
                        cursor.execute(query)
                        row = cursor.fetchall()
                        if not row:
                            enrolado = "NO"
                        ws.write(row_num, 0, u'%s' % materia.asignaturamalla.malla.carrera.nombre_completo(),
                                 font_style2)
                        ws.write(row_num, 1, u'%s' % materia.nivel.sesion.nombre, font_style2)
                        ws.write(row_num, 2, u'%s' % materia.asignaturamalla.nivelmalla.nombre, font_style2)
                        ws.write(row_num, 3, u'%s' % materia.id, font_style2)
                        ws.write(row_num, 4, u'%s' % materia.asignatura.nombre, font_style2)
                        ws.write(row_num, 5, u'%s' % materia.paralelo, font_style2)
                        ws.write(row_num, 6,
                                 u'%s' % materiaasignada.matricula.inscripcion.persona.nombre_completo_inverso(),
                                 font_style2)
                        ws.write(row_num, 7, u'%s' % materiaasignada.matricula.inscripcion.persona.identificacion(),
                                 font_style2)
                        ws.write(row_num, 8, u'%s' % enrolado, font_style2)
                        # print(u"%s" % materiaasignada)
                        row_num += 1
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass


            elif action == 'copyhorario':
                try:
                    data['title'] = u'Copiar Horario'
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['materiaid'])
                    periodos = Clase.objects.values_list("materia__nivel__periodo").filter(
                        materia__asignaturamalla=materia.asignaturamalla, activo=True).distinct()
                    data['periodos'] = Periodo.objects.filter(pk__in=periodos)
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = request.GET['nivelmallaid']
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    return render(request, "niveles/copiarhorario.html", data)
                except Exception as ex:
                    pass

            elif action == 'copiarhorario':
                try:
                    # puede_realizar_accion(request, 'sga.puede_modificar_administrativos')
                    data['title'] = u'Copiar horario'
                    data['materia'] = Materia.objects.get(pk=request.GET['id'])
                    data['materia_ori'] = Materia.objects.get(pk=request.GET['idmo'])
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = request.GET['nivelmallaid']
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    return render(request, "niveles/confirmarcopia.html", data)
                except Exception as ex:
                    pass

            elif action == 'asignarhorarioprofe':
                try:
                    data['title'] = u'Asignar profesor en horarios de tipo teoria'
                    data['materia'] = Materia.objects.get(pk=int(encrypt(request.GET['id'])))
                    if 'mallaid' in request.GET:
                        data['mallaid'] = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = request.GET['nivelmallaid']
                    return render(request, "niveles/confirmarasignarhorario.html", data)
                except Exception as ex:
                    pass

            elif action == 'materias':
                try:
                    url_vars, count_, estado = '' , 0, int(request.GET.get('estado', 0))
                    for var_ in request.GET.keys():
                        if 'page' in request.GET:
                            if not var_ == 'page':
                                url_vars += '{}{}={}'.format('&' if count_ == 0 else '&', var_, request.GET[var_])
                        else:
                            url_vars += '&{}={}'.format(var_, request.GET[var_])
                        count_ += 1
                    data['title'] = u'Materias del nivel académico'
                    data['nivel'] = nivel = Nivel.objects.get(pk=request.GET['id'])
                    # data['id'] = request.GET['id']
                    # data['mallaid'] = request.GET['mallaid']
                    # data['nivelmallaid'] = request.GET['nivelmallaid']
                    # data['paraleloid'] = request.GET['paraleloid']
                    data['reporte_0'] = obtener_reporte('mate_cronogramaperiodo')
                    data['reporte_1'] = obtener_reporte('clases_consolidado')
                    if nivel.materia_set.values('id').filter(status=True).exists():
                        if nivel.materia_set.filter(status=True)[0].asignaturamalla.malla.carrera.coordinacion_carrera().id == 9:
                            data['reporte_2'] = obtener_reporte('acta_notas_admision')
                        else:
                            data['reporte_2'] = obtener_reporte('acta_notas')
                    data['posgrado'] = False
                    data['nivelacion'] = False
                    if nivel.materia_set.filter(status=True):
                        if nivel.materia_set.filter(status=True)[0].asignaturamalla.malla.carrera.coordinacion_carrera().id == 7:
                            data['posgrado'] = True
                        elif nivel.materia_set.filter(status=True)[0].asignaturamalla.malla.carrera.coordinacion_carrera().id == 9:
                            data['nivelacion'] = True
                    data['reporte_3'] = obtener_reporte('lista_alumnos_matriculados_materia')
                    data['reporte_4'] = obtener_reporte('listado_asistencia_dias')
                    data['reporte_5'] = obtener_reporte('lista_control_calificaciones')
                    data['reporte_6'] = obtener_reporte('control_academico')
                    data['reporte_7'] = obtener_reporte('acta_notas_parcial')
                    data['reporte_8'] = obtener_reporte('mate_cronogramaperiodo_carrera')
                    data['reporte_9'] = obtener_reporte('horario_carrera')
                    data['reporte_10'] = obtener_reporte('horario_carrera_nivelmalla')
                    data['reporte_11'] = obtener_reporte('total_matriculados_asignaturas')
                    data['reporte_12'] = obtener_reporte('listados_alumnos_materia_tp')
                    data['reporte_13'] = obtener_reporte('horario_carrera_nivel')
                    data['reporte_14'] = obtener_reporte('acta_notas_modulo_2')
                    data['reporte_17'] = obtener_reporte('acta_calificaciones_enlinea')
                    data['reporte_15'] = obtener_reporte('acta_notas_parcial_modulo')
                    data['reporte_16'] = obtener_reporte('acta_calificaciones_recuperacion_ipec')
                    data['reporte_19'] = obtener_reporte('acta_calificaciones_admision')
                    data['reporte_20'] = obtener_reporte('lista_alumnos_matriculados_materia_ingles')
                    data['reporte_21'] = obtener_reporte('lista_alumnos_matriculados_materia_ingles_excel')
                    data['reporte_22'] = obtener_reporte('rpt_modelo_subida_acta_nivel_materia')
                    data['reporte_23'] = obtener_reporte('rpt_listado_asistencias')
                    carreras = persona.mis_carreras()
                    carreras = carreras.filter(id__in=nivel.coordinacion().carrera.all())
                    mallas = Malla.objects.filter(carrera__in=carreras).distinct()
                    malla = None
                    nivelmalla = None
                    if 'mallaid' in request.GET:
                        malla = Malla.objects.get(pk=int(request.GET['mallaid']))
                    else:
                        if mallas.exists():
                            malla = mallas[0]
                    if MATRICULACION_LIBRE:
                        paraleloid = '0'
                        if 'paraleloid' in request.GET:
                            paraleloid = request.GET['paraleloid']
                        data['paraleloid'] = paraleloid
                        data['malla'] = malla
                        data['mallaid'] = malla.id if malla else 0
                        if 'nivelmallaid' in request.GET and int(request.GET['nivelmallaid']) > 0:
                            nivelmalla = NivelMalla.objects.get(pk=int(request.GET['nivelmallaid']))
                            data['nivelmalla'] = nivelmalla
                            data['nivelmallaid'] = nivelmalla.id if nivelmalla else ""
                        search = request.GET.get('s', '').upper()
                        if nivelmalla:
                            if paraleloid == '0':
                                materias = nivel.materia_set.filter(status=True, asignaturamalla__malla_id=malla.id, asignaturamalla__nivelmalla=nivelmalla)
                                if search:
                                    materias = materias.filter(Q(asignatura__nombre__icontains=search) | Q(profesormateria__profesor__persona__apellido2__icontains=search)
                                                               | Q(profesormateria__profesor__persona__apellido1__icontains=search)
                                                               | Q(profesormateria__profesor__persona__nombres__icontains=search))
                                materias = materias.order_by('asignaturamalla__nivelmalla', 'asignatura__nombre', 'paralelo', 'inicio', 'identificacion', 'id').annotate(nummatri=Count('materiaasignada__id',distinct=True, filter=Q(materiaasignada__materiaasignadaretiro__isnull=True, materiaasignada__matricula__estado_matricula__in=[2, 3], materiaasignada__status=True))).annotate(sinretiradosinscritos=Count('materiaasignada__id',distinct=True, filter=Q(materiaasignada__materiaasignadaretiro__isnull=True, materiaasignada__matricula__estado_matricula=1, materiaasignada__status=True)))
                            else:
                                materias = nivel.materia_set.filter(status=True, asignaturamalla__malla_id=malla.id, paralelo=paraleloid, asignaturamalla__nivelmalla=nivelmalla)
                                if search:
                                    materias = materias.filter(Q(asignatura__nombre__icontains=search) | Q(profesormateria__profesor__persona__apellido2__icontains=search)
                                                               | Q(profesormateria__profesor__persona__apellido1__icontains=search)
                                                               | Q(profesormateria__profesor__persona__nombres__icontains=search))
                                materias = materias.order_by('asignaturamalla__nivelmalla', 'asignatura__nombre', 'paralelo', 'inicio', 'identificacion', 'id').annotate(nummatri=Count('materiaasignada__id',distinct=True, filter=Q(materiaasignada__materiaasignadaretiro__isnull=True, materiaasignada__matricula__estado_matricula__in=[2, 3], materiaasignada__status=True))).annotate(sinretiradosinscritos=Count('materiaasignada__id',distinct=True, filter=Q(materiaasignada__materiaasignadaretiro__isnull=True, materiaasignada__matricula__estado_matricula=1, materiaasignada__status=True)))
                        else:
                            if paraleloid == '0':
                                materias = nivel.materia_set.filter(status=True, asignaturamalla__malla_id=malla.id)
                                if search:
                                    s = search.split(' ')
                                    if s.__len__() > 1:
                                        materias = materias.filter(Q(asignatura__nombre__unaccent__icontains=search) | Q(profesormateria__profesor__persona__apellido2__unaccent__icontains=s[1]) | Q(profesormateria__profesor__persona__apellido1__unaccent__icontains=s[0]) | Q(profesormateria__profesor__persona__nombres__unaccent__icontains=search))
                                    else:
                                        materias = materias.filter(Q(asignatura__nombre__unaccent__icontains=search)|Q(profesormateria__profesor__persona__apellido2__unaccent__icontains=search)
                                                                   |Q(profesormateria__profesor__persona__apellido1__unaccent__icontains=search)
                                                                   |Q(profesormateria__profesor__persona__nombres__unaccent__icontains=search))
                                materias = materias.order_by('asignaturamalla__nivelmalla', 'asignatura__nombre', 'paralelo', 'inicio', 'identificacion', 'id').annotate(nummatri=Count('materiaasignada__id',distinct=True, filter=Q(materiaasignada__materiaasignadaretiro__isnull=True, materiaasignada__matricula__estado_matricula__in=[2, 3], materiaasignada__status=True))).annotate(sinretiradosinscritos=Count('materiaasignada__id',distinct=True, filter=Q(materiaasignada__materiaasignadaretiro__isnull=True, materiaasignada__matricula__estado_matricula=1, materiaasignada__status=True)))
                            else:
                                materias = nivel.materia_set.filter(status=True, asignaturamalla__malla_id=malla.id, paralelo=paraleloid)
                                if search:
                                    materias = materias.filter(Q(asignatura__nombre__icontains=search) | Q(profesormateria__profesor__persona__apellido2__icontains=search)
                                                               | Q(profesormateria__profesor__persona__apellido1__icontains=search)
                                                               | Q(profesormateria__profesor__persona__nombres__icontains=search))
                                materias = materias.order_by('asignaturamalla__nivelmalla', 'asignatura__nombre', 'paralelo', 'inicio', 'identificacion', 'id').annotate(nummatri=Count('materiaasignada__id',distinct=True, filter=Q(materiaasignada__materiaasignadaretiro__isnull=True, materiaasignada__matricula__estado_matricula__in=[2, 3], materiaasignada__status=True))).annotate(sinretiradosinscritos=Count('materiaasignada__id',distinct=True, filter=Q(materiaasignada__materiaasignadaretiro__isnull=True, materiaasignada__matricula__estado_matricula=1, materiaasignada__status=True)))
                        data['mallas'] = mallas
                    else:
                        materias = nivel.materia_set.filter(status=True).order_by('asignatura__nombre', 'paralelo', 'inicio', 'identificacion', 'id').annotate(nummatri=Count('materiaasignada__id',distinct=True, filter=Q(materiaasignada__materiaasignadaretiro__isnull=True, materiaasignada__matricula__estado_matricula__in=[2, 3], materiaasignada__status=True))).annotate(sinretiradosinscritos=Count('materiaasignada__id',distinct=True, filter=Q(materiaasignada__materiaasignadaretiro__isnull=True, materiaasignada__matricula__estado_matricula=1, materiaasignada__status=True)))

                    if estado == 1:
                        materias = materias.filter(cerrado=False)
                    elif estado == 2:
                        materias = materias.filter(cerrado=True)

                    eadmin = int(request.GET.get('eadmin', '0'))
                    if eadmin:
                        data['eadmin'] = eadmin
                        materias = materias.filter(pk__in=PlanificacionMateria.objects.filter(estado=eadmin, status=True).values_list('materia_id', flat=True))

                    data['num_paginacion'] = num_paginacion = request.GET.get('num_paginacion', 20)
                    paging = MiPaginador(materias, int(num_paginacion))
                    p = 1
                    try:
                        paginasesion = 1
                        if 'paginador' in request.session:
                            paginasesion = int(request.session['paginador'])
                        if 'page' in request.GET:
                            p = int(request.GET['page'])
                            p = int(request.GET['page'])
                        else:
                            p = paginasesion
                        try:
                            page = paging.page(p)
                        except:
                            p = 1
                        page = paging.page(p)
                    except:
                        page = paging.page(p)
                    request.session['paginador'] = p
                    data['paging'] = paging
                    data['rangospaging'] = paging.rangos_paginado(p)
                    data['page'] = page
                    data["url_vars"] = url_vars
                    data['materias'] = page.object_list
                    data['bloqueado'] = nivel.bloqueado() and not persona.usuario.groups.filter(id__in=[143])
                    data['nivelesmalla'] = NivelMalla.objects.all()
                    data['nobloqueadocupos'] = nivel.extension().puedematricular
                    data['nobloqueadodocente'] = nivel.extension().modificardocente if MATRICULACION_LIBRE else True
                    data['matriculacion_libre'] = MATRICULACION_LIBRE
                    data['cupo_por_materia'] = CUPO_POR_MATERIA
                    data['usa_evaluacion_integral'] = USA_EVALUACION_INTEGRAL
                    data['paralelos'] = Paralelo.objects.filter(nombre__in=nivel.materia_set.values_list('paralelo', flat=True).filter(status=True, asignaturamalla__malla=malla).distinct(), status=True)
                    data['urlmodle'] = periodo.urlmoodle
                    data['persona'] = persona
                    data['estado'] = estado
                    if 's' in request.GET:
                        data['s'] = request.GET['s']
                    # data['paralelos'] = ['A1', 'A2', 'A3', 'ADM01','ADM02','ADM03','ADM04','ADM05','ADM06','ADM07','ADM08','ADM09', 'B1', 'B2','BIO01', 'BIO02', 'BIO03', 'BIO04', 'C1', 'C2', 'COM01', 'COM02', 'COM03', 'COM04', 'CPA01', 'CPA02', 'CPA03', 'CPA04', 'DIS01', 'DIS02', 'EDI01', 'EDI02', 'EDI03', 'EDI04', 'EDU01','EDU02', 'EDU03', 'EDU04',  'GES01', 'GES02', 'IND01','IND02','IND03','IND04','IND05','LCS01','LE01','LE02', 'LE04', 'LNH01', 'LNH02', 'LNH03', 'LT01', 'MKT01', 'MKT02', 'NG01', 'NG02', 'NG03', 'NG04', 'NG05', 'NG06', 'NG07', 'NG08', 'NG09', 'NG10', 'NG11', 'NG12', 'NG13', 'NG14', 'NG15', 'NG16', 'NG17', 'NG18', 'PDE01', 'PDE02', 'PSC01', 'PSC02', 'PSC03', 'PSC04','S1', 'S2','SIS01','SIS02','SIS03','SIS04','SIS05', 'TUR01', 'TUR02', 'TUR03', 'TUR04']

                    if periodo.tipo_id in[3, 4]:
                        if request.GET.get('v') == '2':
                            return render(request, "niveles/materiasdip.html", data)
                        else:
                            data['estados_admin'] = tuple(elemento for elemento in ESTADO_ADMINISTRATIVO_MATERIA if elemento[0] != 0)
                            return render(request, "niveles/materiasdip_v2.html", data)
                    else:
                        return render(request, "niveles/materias.html", data)
                except Exception as ex:
                    messages.error(request, str(ex))

            if action == 'acta_notas_modulo_ingles':
                try:
                    materia = Materia.objects.get(pk=int(encrypt(request.GET['id'])))
                    data['coordinacion'] = materia.nivel.nivellibrecoordinacion_set.filter(status=True).first()
                    data['materia'] = materia
                    observaciones = ""
                    listaRetirados = MateriaAsignadaRetiro.objects.values_list('materiaasignada_id', flat=True).filter(Q(valida=True) | Q(valida=None))
                    materiaasignada = materia.materiaasignada_set.filter(status=True, retiramateria=False).order_by('matricula__inscripcion__persona__apellido1', 'matricula__inscripcion__persona__apellido2').exclude(pk__in=listaRetirados)
                    listaRubrosVencidos = Rubro.objects.values_list('matricula_id', flat=True).filter(matricula_id__in=materiaasignada.values_list('matricula_id', flat=True), status=True, cancelado=False, saldo__gt=0)
                    # for ma in materiaasignada:
                    #     observaciones += u"%s - %s. " % (ma.matricula.inscripcion.persona.nombre_completo_inverso().title(), ma.observaciones) if ma.observaciones else ''
                    data['materiaasignada'] = materiaasignada
                    data['listaRubrosVencidos'] = listaRubrosVencidos
                    firmaResponsables = DocumentosFirmadosEvaluaciones.objects.filter(configuraciondoc__materia=materia, configuraciondoc__materia__status=True, configuraciondoc__status=True, status=True)

                    eListRes, temp = [], []
                    for x in range(0, len(firmaResponsables), 2):
                        eListRes.append([firmaResponsables[x], firmaResponsables[x+1]] if (x+1) < len(firmaResponsables) else [firmaResponsables[x]])

                    data['observaciones'] = observaciones
                    return download_html_to_pdf('niveles/acta_final_calificaciones.html', {'pagesize': 'A4', 'data': data, 'firmaResponsables': eListRes})
                except Exception as ex:
                    return HttpResponseRedirect(f"{request.path}?info={ex.__str__()}")

            elif action == 'loadPlanificacionExamenesSedes':
                try:
                    data['title'] = u'Planificación de examenes en sedes'
                    if not 'idm' in request.GET:
                        raise NameError(u"No existe parametro de materia")
                    if not Materia.objects.values("id").filter(pk=encrypt(request.GET['idm']), status=True).exists():
                        raise NameError(u"No existe la materia")
                    data['eMateria'] = eMateria = Materia.objects.get(pk=encrypt(request.GET['idm']))
                    eMateriaAsignadaPlanificacionSedeVirtualExamenes = MateriaAsignadaPlanificacionSedeVirtualExamen.objects.filter(materiaasignada__materia=eMateria,
                                                                                                                                    aulaplanificacion__turnoplanificacion__fechaplanificacion__periodo=periodo)
                    eSedes = SedeVirtual.objects.filter(pk__in=eMateriaAsignadaPlanificacionSedeVirtualExamenes.values_list('aulaplanificacion__turnoplanificacion__fechaplanificacion__sede__id', flat=True))
                    data['eSedes'] = eSedes
                    data['title'] = u"Planificación de examenes en sedes"
                    eTipoAulas = TipoAula.objects.filter(pk__in=eMateriaAsignadaPlanificacionSedeVirtualExamenes.values_list('aulaplanificacion__aula__tipo__id', flat=True))
                    aTipoAulas = []
                    for eTipoAula in eTipoAulas:
                        total = len(eMateriaAsignadaPlanificacionSedeVirtualExamenes.values("id").filter(aulaplanificacion__aula__tipo=eTipoAula))
                        aTipoAulas.append({'nombre': eTipoAula.nombre, 'total': total})
                    data['eTipoAulas'] = aTipoAulas

                    # template = get_template("pro_planificacion/detalleplanificacionexamen.html")
                    # json_content = template.render(data)
                    # return JsonResponse({"result": "ok", 'data': json_content, 'title': data['title']})
                    return render(request, "pro_planificacion/detalleplanificacionexamen.html", data)
                except Exception as ex:
                    return HttpResponseRedirect(f"{request.path}?info={ex.__str__()}")

            elif action == 'verificarmoodle':
                try:
                    materia=Materia.objects.get(pk=int(request.GET['id']),nivel__periodo=periodo)
                    idnumber = request.GET['idnumber']
                    result=materia.nombre_curso_moodlepos(idnumber)
                    return JsonResponse({"result": "ok",'resultado':result})
                except Exception as ex:
                    return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos."})

            elif action == 'logdeberes':
                try:
                    search = None
                    data['title'] = u'Log Deberes'
                    data['periodo'] = periodo = Periodo.objects.get(pk=request.GET['id'])
                    data['coordinaciones'] = coordinaciones = Coordinacion.objects.filter(
                        carrera__malla__asignaturamalla__materia__nivel__periodo=periodo, status=True).distinct()
                    data['coordinacion'] = coordinacion = coordinaciones[0]
                    if 'idcoordinacion' in request.GET:
                        data['coordinacion'] = coordinacion = Coordinacion.objects.get(pk=request.GET['idcoordinacion'])
                    if 's' in request.GET:
                        search = request.GET['s']
                    if search:
                        log1 = periodo.logdeberes_set.filter(Q(profesor__persona__nombres__icontains=search) |
                                                             Q(profesor__persona__apellido1__icontains=search) |
                                                             Q(profesor__persona__apellido2__icontains=search) |
                                                             Q(profesor__persona__cedula__icontains=search) |
                                                             Q(profesor__persona__pasaporte__icontains=search),
                                                             status=True,
                                                             materia__asignaturamalla__malla__carrera__coordinacion=coordinacion).order_by(
                            'profesor')
                    else:
                        log1 = periodo.logdeberes_set.filter(status=True,
                                                             materia__asignaturamalla__malla__carrera__coordinacion=coordinacion).order_by(
                            'profesor')
                    paging = MiPaginador(log1, 25)
                    p = 1
                    try:
                        paginasesion = 1
                        if 'paginador' in request.session:
                            paginasesion = int(request.session['paginador'])
                        if 'page' in request.GET:
                            p = int(request.GET['page'])
                        else:
                            p = paginasesion
                        try:
                            page = paging.page(p)
                        except:
                            p = 1
                        page = paging.page(p)
                    except:
                        page = paging.page(p)
                    request.session['paginador'] = p
                    data['paging'] = paging
                    data['rangospaging'] = paging.rangos_paginado(p)
                    data['page'] = page
                    data['search'] = search if search else ""
                    data['log'] = page.object_list
                    return render(request, "niveles/logdeberes.html", data)
                except Exception as ex:
                    pass

            elif action == 'tutores':
                try:
                    search = None
                    data['title'] = u'Tutores virtual'
                    data['periodo'] = periodo = Periodo.objects.get(pk=request.GET['id'])
                    data['coordinaciones'] = coordinaciones = Coordinacion.objects.filter(
                        carrera__malla__asignaturamalla__materia__nivel__periodo=periodo, status=True).distinct()
                    data['coordinacion'] = coordinacion = coordinaciones[0]
                    if 'idcoordinacion' in request.GET:
                        data['coordinacion'] = coordinacion = Coordinacion.objects.get(pk=request.GET['idcoordinacion'])
                    if 's' in request.GET:
                        search = request.GET['s']
                    if search:
                        profesores = Profesor.objects.filter(Q(persona__nombres__icontains=search) |
                                                             Q(persona__apellido1__icontains=search) |
                                                             Q(persona__apellido2__icontains=search) |
                                                             Q(persona__cedula__icontains=search) |
                                                             Q(persona__pasaporte__icontains=search),
                                                             soporteacademicotutor__periodo=periodo, status=True,
                                                             profesormateria__materia__asignaturamalla__malla__carrera__coordinacion=coordinacion).order_by(
                            'persona').distinct()
                    else:
                        profesores = Profesor.objects.filter(soporteacademicotutor__periodo=periodo, status=True,
                                                             profesormateria__materia__asignaturamalla__malla__carrera__coordinacion=coordinacion).order_by(
                            'persona').distinct()
                    paging = MiPaginador(profesores, 25)
                    p = 1
                    try:
                        paginasesion = 1
                        if 'paginador' in request.session:
                            paginasesion = int(request.session['paginador'])
                        if 'page' in request.GET:
                            p = int(request.GET['page'])
                        else:
                            p = paginasesion
                        try:
                            page = paging.page(p)
                        except:
                            p = 1
                        page = paging.page(p)
                    except:
                        page = paging.page(p)
                    request.session['paginador'] = p
                    data['paging'] = paging
                    data['rangospaging'] = paging.rangos_paginado(p)
                    data['page'] = page
                    data['search'] = search if search else ""
                    data['profesores'] = page.object_list
                    return render(request, "niveles/tutores.html", data)
                except Exception as ex:
                    pass

            if action == 'subirarchivo':
                try:
                    data['title'] = u'Subir archivo'
                    f = SubirArchivoForm()
                    data['form'] = f
                    data['idperiodo'] = request.GET['idperiodo']
                    return render(request, "niveles/subirarchivo.html", data)
                except Exception as ex:
                    pass

            if action == 'recalcular':
                try:
                    data['title'] = u'Recalculra Log Deberes'
                    data['periodo'] = Periodo.objects.get(pk=request.GET['id'])
                    return render(request, "niveles/recalcular.html", data)
                except Exception as ex:
                    pass

            elif action == 'pagos':
                try:
                    data['title'] = u'Cronograma de pagos del nivel académico'
                    data['nivel'] = nivel = Nivel.objects.get(pk=request.GET['id'])
                    data['pagos'] = nivel.pagonivel_set.all()
                    return render(request, "niveles/pagos.html", data)
                except Exception as ex:
                    pass

            elif action == 'addpagos':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_pagos_nivel')
                    data['title'] = u'Adicionar cronograma de pagos al nivel académico'
                    data['nivel'] = nivel = Nivel.objects.get(pk=request.GET['id'])
                    data['form'] = PagoNivelForm()
                    data['tipo_cuota_rubro'] = TIPO_CUOTA_RUBRO
                    return render(request, "niveles/addpagos.html", data)
                except Exception as ex:
                    pass

            elif action == 'cambiarmodelo':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_modelo_evaluativo_materia')
                    data['title'] = u'Cambiar modelo evaluativo'
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['id'])
                    form = ListaModeloEvaluativoForm()
                    if materia.nivel.coordinacion().id == 7:
                        form.excluir_modeloactualposgrado(materia.modeloevaluativo)
                    else:
                        form.excluir_modeloactual(materia.modeloevaluativo)
                    data['form'] = form
                    data['nivel'] = materia.nivel
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = request.GET['nivelmallaid']
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    return render(request, "niveles/cambiarmodelo.html", data)
                except Exception as ex:
                    pass

            elif action == 'matricularmodulo':
                try:
                    data['title'] = u'Matricular Módulo'
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['id'])
                    data['materiamatriculasbloqueadas'] = materia.asignados_a_esta_materia().filter(matricula__bloqueomatricula=True).exclude(matricula__retiradomatricula=True)

                    form = MatricularModuloForm()
                    form.materias(materia)
                    data['form'] = form
                    data['nivel'] = materia.nivel
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = request.GET['nivelmallaid']
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    return render(request, "niveles/matricularmodulo.html", data)
                except Exception as ex:
                    pass

            elif action == 'requisitosmateriatitulacion':
                try:
                    data['title'] = u'Requisitos titulacion'
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['id'])
                    atras = 'niveles?action=materias&id={}'.format(materia.id)
                    requisitos = materia.requisitomateriaunidadintegracioncurricular_set.filter(status=True)
                    existegraduado = MateriaTitulacion.objects.values("id").filter(materiaasignada__materia=materia, estadograduado=True).exists()
                    if not requisitos and not existegraduado:
                        response = llenar_requisitostitulacion(materia, request)
                        if response['resp'] == 'error':
                            return HttpResponseRedirect("/niveles?info={}".format(response['msg']))
                    # if not requisitos:
                    #     materia.crear_actualizar_requisitos_uic()
                    data['listadorequisitos'] = requisitos.order_by('requisito__nombre')
                    data['nivel'] = materia.nivel
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                        atras += '&mallaid={}'.format(mallaid)
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = request.GET['nivelmallaid']
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = paraleloid = request.GET['paraleloid']
                    data['atras'] = atras
                    return render(request, "niveles/requisitosmateriatitulacion.html", data)
                except Exception as ex:
                    pass

            elif action == 'dividirparalelo':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_matriculas')
                    data['title'] = u'Cambiar Paralelo'
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['id'])
                    asignatura = materia.asignatura
                    paraleloactual = materia.paralelomateria
                    malla = Malla.objects.get(pk=request.GET['mallaid'])
                    data['nivel'] = nivel = materia.nivel
                    form = MateriaParaleloForm()
                    form.paralelo_materia(nivel, malla, asignatura, paraleloactual)
                    data['form'] = form
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = nivelmallaid = request.GET['nivelmallaid']
                        # atras += '&nivelmallaid={}'.format(nivelmallaid)
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    return render(request, "niveles/dividirparalelo.html", data)
                except Exception as ex:
                    pass

            elif action == 'dividirparalelomateria':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_matriculas')
                    data['title'] = u'Cambiar Paralelo Materia'
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['id'])
                    asignatura = materia.asignatura
                    paraleloactual = materia.paralelomateria
                    malla = Malla.objects.get(pk=request.GET['mallaid'])
                    data['nivel'] = nivel = materia.nivel
                    form = MateriaParaleloForm()
                    form.paralelo_materia(nivel, malla, asignatura, paraleloactual)
                    data['form'] = form
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = request.GET['nivelmallaid']
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    return render(request, "niveles/dividirparalelomateria.html", data)
                except Exception as ex:
                    pass

            elif action == 'dividir':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_materias')
                    data['title'] = u'Dividir matriculados en una materia'
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['id'])
                    form = MateriaDividirForm()
                    form.desde_materia_pregrado(materia, periodo)
                    data['form'] = form
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = request.GET['nivelmallaid']
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    return render(request, "niveles/dividir.html", data)
                except Exception as ex:
                    pass

            elif action == 'asignar_estudiante_materias_otro_paralelo':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_materias')
                    data['title'] = u'Dividir matriculados por paralelo'
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['id'])
                    asignatura = materia.asignatura
                    paraleloactual = materia.paralelomateria
                    malla = Malla.objects.get(pk=request.GET['mallaid'])
                    data['nivel'] = nivel = materia.nivel

                    form = MateriaParalelo2Form()
                    form.paralelo_materia(nivel, malla, asignatura, paraleloactual)
                    data['form'] = form
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = request.GET['nivelmallaid']
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    return render(request, "niveles/dividirparcial.html", data)
                except Exception as ex:
                    pass

            elif action == 'editpagos':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_niveles')
                    data['title'] = u'Editar cronograma de pagos del nivel'
                    data['pagonivel'] = pagonivel = PagoNivel.objects.get(pk=request.GET['id'])
                    data['nivel'] = pagonivel.nivel
                    form = PagoNivelForm(initial={'fecha': pagonivel.fecha,
                                                  'tipo': pagonivel.tipo,
                                                  'cuota': pagonivel.cuota,
                                                  'valor': pagonivel.valor})
                    form.editar()
                    data['form'] = form
                    return render(request, "niveles/editpagos.html", data)
                except Exception as ex:
                    pass

            elif action == 'delpagos':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_niveles')
                    pagonivel = PagoNivel.objects.get(pk=request.GET['id'])
                    nivel = pagonivel.nivel
                    pagonivel.delete()
                    return HttpResponseRedirect("/niveles?action=pagos&id=" + str(nivel.id))
                except Exception as ex:
                    transaction.set_rollback(True)
                    pass

            elif action == 'editmateria':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_materias')
                    data['title'] = u'Editar materia de nivel académico'
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['id'])
                    form = MateriaNivel(initial={'asignatura': materia.asignatura,
                                                 'asignaturamalla': materia.asignaturamalla,
                                                 'horas': materia.horas,
                                                 'horassemanales': materia.horassemanales,
                                                 'modelo': materia.modeloevaluativo,
                                                 'creditos': materia.creditos,
                                                 'cupo': materia.cupo,
                                                 'identificacion': materia.identificacion,
                                                 'alias': materia.alias,
                                                 'paralelo': materia.paralelomateria,
                                                 'parcial': materia.parcial,
                                                 'tutoria': materia.tutoria,
                                                 'practicas': materia.practicas,
                                                 'validacreditos': materia.validacreditos,
                                                 'validapromedio': materia.validapromedio,
                                                 'rectora': materia.rectora,
                                                 'carreras': materia.carrerascomunes.all(),
                                                 'tipomateria': materia.tipomateria,
                                                 'inicio': materia.inicio,
                                                 'seevalua': materia.seevalua,
                                                 'fin': materia.fin,
                                                 'esintroductoria': materia.esintroductoria,
                                                 'inglesepunemi': materia.inglesepunemi,
                                                 'iniciomatriculacionposgrado': materia.fechainiciomatriculacionposgrado,
                                                 'finmatriculacionposgrado': materia.fechafinmatriculacionposgrado,
                                                 'sinasistencia': materia.sinasistencia,
                                                 'aplicamovilidad': materia.aplicamovilidad,
                                                 })
                    if not materia.tipomateria == 2:
                        form.sin_modificarla(materia.nivel, materia.asignaturamalla)
                        form.quitar_introductoria()
                    else:
                        form.matriculacion_libre(materia.asignaturamalla.malla_id, materia.asignaturamalla.nivelmalla_id)
                    # form.sin_modelo()
                    mallaid = None
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = nivelmallaid = request.GET['nivelmallaid']
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    # if materia.nivel.coordinacion().id == 7:
                    #     form.modeloposgrado()
                    if materia.nivel.coordinacion().id != 7:
                        form.excluir_fechasmatriculacionposgrado()
                    if materia.nivel.coordinacion().id != 6 and not (mallaid == '353' or mallaid == '22'):
                        form.quitar_inglesepunemi()
                    data['form'] = form
                    return render(request, "niveles/editmateria.html", data)
                except Exception as ex:
                    pass

            elif action == 'addmateria':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_materias')
                    data['title'] = u'Adicionar materia a nivel académico'
                    data['nivel'] = nivel = Nivel.objects.get(pk=request.GET['id'])
                    form = MateriaNivel(initial={'inicio': nivel.inicio,
                                                 'fin': nivel.fin,
                                                 'creditos': 0,
                                                 'horassemanales': 0,
                                                 'horas': 0,
                                                 'cupo': CAPACIDAD_MATERIA_INICIAL})
                    mallaid = None
                    nivelmallaid = None
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = nivelmallaid = request.GET['nivelmallaid']
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    form.matriculacion_libre(mallaid, nivelmallaid)

                    if nivel.coordinacion().id == 7:
                        form.excluir_modeloactualposgrado(None)
                    else:
                        form.excluir_fechasmatriculacionposgrado()

                    # if variable_valor('MATRICULACION_LIBRE'):
                    #     form.matriculacion_libre(mallaid, nivelmallaid)
                    # else:
                    #     form.matriculacion_regular()
                    if nivel.coordinacion().id != 9:
                        form.quitar_introductoria()
                    # if nivel.coordinacion().id == 7:
                    #     form.mostrar_campos_profesor()
                    if nivel.coordinacion().id != 6 and not (mallaid == '353' or mallaid == '22'):
                        form.quitar_inglesepunemi()
                    data['form'] = form
                    return render(request, "niveles/addmateria.html", data)
                except Exception as ex:
                    pass

            elif action == 'materiasmalla':
                try:
                    malla = Malla.objects.get(pk=request.GET['mid'])
                    asignaturas = malla.asignaturamalla_set.all().order_by('nivelmalla')

                    if periodo.clasificacion == 2 or periodo.tipo_id == 3:
                        if paralelos_por_asignatura := [x.pk for x in asignaturas if not Materia.objects.filter(asignaturamalla=x, status=True).count() == null_to_decimal(PlanificacionParalelo.objects.filter(periodo=periodo, detallefuncionsustantivadocencia__asignatura=x.asignatura, status=True).aggregate(paralelo=Max('paralelos'))['paralelo'])]:
                            asignaturas = asignaturas.filter(pk__in=paralelos_por_asignatura)

                    data['posgrado'] = True if periodo.tipo_id == 3 and periodo.clasificacion== 2 else False
                    data['materiasmalla'] = asignaturas
                    template = get_template("niveles/materiasmalla.html")
                    json_content = template.render(data)
                    return JsonResponse({"result": "ok", "segmento": json_content})
                except Exception as ex:
                    return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos."})

            elif action == 'addmateriamalla':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_materias')
                    data['title'] = u'Adicionar materia a nivel académico de una malla'
                    data['nivel'] = nivel = Nivel.objects.get(pk=request.GET['id'])
                    if 'mallaid' not in request.GET:
                        return HttpResponseRedirect('/niveles?action=materias&id=' + request.GET['id'])
                    data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = nivelmallaid = request.GET['nivelmallaid']
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    form = MateriaNivelMalla(initial={'malla': mallaid})
                    form.mallas(mallaid)
                    if nivel.coordinacion().id == 7:
                        form.modeloposgrado()
                        form.quitar_parcial()
                    if not mallaid in ['353', '22']:
                        form.quitar_inglesepunemi()
                    data['form'] = form
                    return render(request, "niveles/addmateriamalla.html", data)
                except Exception as ex:
                    pass

            elif action == 'deletemateria':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_materias')
                    data['title'] = u'Borrar materia de nivel académico'
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['id'])
                    data['nivel'] = materia.nivel
                    if 'mallaid' in request.GET:
                        data['mallaid'] = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = request.GET['nivelmallaid']
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    return render(request, "niveles/deletemateria.html", data)
                except Exception as ex:
                    pass

            elif action == 'alumnospractica':
                try:
                    data['title'] = u'Alumnos de practica'
                    data['profesormateria'] = profesormateria = ProfesorMateria.objects.get(pk=request.GET['id'])
                    # quito porque no se puede asignar todos los alumnos matriculados CARLOS RODRIGUEZ
                    # materiasasignadas = profesormateria.materia.asignados_a_esta_materia()
                    materiasasignadas = profesormateria.materia.materiaasignada_set.filter(status=True, retiramateria=False).order_by('matricula__inscripcion__persona__apellido1', 'matricula__inscripcion__persona__apellido2', 'matricula__inscripcion__persona__nombres')
                    if periodo.id >= 76:
                        listaestudiantes = []
                        listadoprofemate = profesormateria.materia.profesormateria_set.filter(activo=True, tipoprofesor_id__in=[2, 13]).order_by('profesor__persona')
                        # for profesormate in profesormateria.materia.profesores_materia_segun_tipoprofesor_pm(2):
                        for profesormate in listadoprofemate:
                            for grupoprofe in profesormate.grupoprofesormateria():
                                listaestudiantes.extend(AlumnosPracticaMateria.objects.values_list('materiaasignada__id', flat=True).filter(profesormateria=profesormate, grupoprofesor=grupoprofe, status=True))

                        # alumnospracticascongrupos = AlumnosPracticaMateria.objects.values_list('materiaasignada__id').filter(materiaasignada__id__in = materiasasignadas.values_list('id'), grupoprofesor__isnull=False, status=True)
                        materiasasignadas = materiasasignadas.exclude(pk__in=listaestudiantes).distinct()
                    data['materiasasignadas'] = materiasasignadas
                    data['nivel'] = profesormateria.materia.nivel
                    if 'mallaid' in request.GET:
                        data['mallaid'] = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = request.GET['nivelmallaid']
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    return render(request, "niveles/alumnospractica.html", data)
                except Exception as ex:
                    pass

            elif action == 'reporte_matri_prac':
                try:
                    idmateria = request.GET['idmateria']
                    idprofesor = request.GET['idprofesor']
                    data['profesormateria'] = profesormateria = ProfesorMateria.objects.get(materia_id=idmateria, profesor_id=idprofesor, tipoprofesor_id__in=[2,13])
                    materiasasignadas = profesormateria.materia.asignados_a_esta_materia()
                    records = []
                    for materiasasignada in materiasasignadas:
                        mat = materiasasignada.seleccionado_practica(profesormateria)
                        if mat:
                            records.append(materiasasignada)
                    return conviert_html_to_pdf('niveles/inf_matriculado_prac.html',
                                                {'pagesize': 'A4 ',
                                                 'data': data,
                                                 'profesormateria': profesormateria,
                                                 'materiasasignadas': records})
                except Exception as ex:
                    pass

            elif action == 'aprobar':
                try:
                    puede_realizar_accion(request, 'sga.puede_autorizar_distributivo')
                    data['title'] = u'Aprobar distributivo de nivel académico'
                    data['nivel'] = Nivel.objects.get(pk=request.GET['id'])
                    return render(request, "niveles/aprobar.html", data)
                except Exception as ex:
                    pass

            elif action == 'cambiaraula':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_aula_horario')
                    data['title'] = u'Cambiar aula de materia en el horario'
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['id'])
                    form = CambiarAulaForm()
                    # form.excluir_aulas_actuales(materia.nivel, materia.nivel.coordinacion())
                    if 'mallaid' in request.GET:
                        data['mallaid'] = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = request.GET['nivelmallaid']
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    data['form'] = form
                    data['nivel'] = materia.nivel
                    return render(request, "niveles/cambiaraula.html", data)
                except Exception as ex:
                    pass

            elif action == 'addprofesor':
                try:
                    data['reporte_1'] = obtener_reporte('hoja_vida_sagest')
                    puede_realizar_accion(request, 'sga.puede_modificar_profesor_materia')
                    data['title'] = u'Adicionar profesor a materia de nivel académico'
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['mid'])
                    data['form'] = ProfesorMateriaForm(initial={'segmento': 'MATERIA',
                                                                'desde': materia.inicio,
                                                                'hasta': materia.fin,
                                                                'hora': materia.horassemanales, })
                    if 'mallaid' in request.GET:
                        data['mallaid'] = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = request.GET['nivelmallaid']
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    data['preferencias'] = AsignaturaMallaPreferencia.objects.filter(asignaturamalla=materia.asignaturamalla, periodo=materia.nivel.periodo)
                    return render(request, "niveles/addprofesor.html", data)
                except Exception as ex:
                    pass

            elif action == 'convocatorias':
                hoy = datetime.now().date()
                try:
                    s, url_vars, mid = request.GET.get('s', ''), '', ''
                    if 'mallaid' in request.GET: url_vars += f"&mallaid={request.GET['mallaid']}"
                    if 'nivelmallaid' in request.GET: url_vars += f"&nivelmallaid={request.GET['nivelmallaid']}"
                    if 'paraleloid' in request.GET: url_vars += f"&paraleloid={request.GET['paraleloid']}"

                    if 'mid' in request.GET:
                        mid=int(request.GET['mid'])
                        url_vars+=f"&mid={mid}"

                    data['url_static_vars'] = url_vars
                    data['materia'] = materia = Materia.objects.get(pk=mid)
                    asignatura = materia.asignaturamalla.asignatura
                    filtro = Q(asignaturamalla__asignatura_id=asignatura.pk, periodo=periodo, status=True)
                    if s:
                        filtro = filtro & (Q(nombre__icontains=s) | Q(perfilrequeridopac__titulacion__titulo__nombre__icontains=s))
                        data['s'] = s
                        url_vars += f"&s={s}"

                    paging = MiPaginador(Convocatoria.objects.filter(filtro).order_by('nombre'), 25)
                    p = 1
                    try:
                        paginasesion = 1
                        if 'paginador' in request.session:
                            paginasesion = int(request.session['paginador'])
                        if 'page' in request.GET:
                            p = int(request.GET['page'])
                        else:
                            p = paginasesion
                        try:
                            page = paging.page(p)
                        except:
                            p = 1
                        page = paging.page(p)
                    except:
                        page = paging.page(p)
                    request.session['paginador'] = p
                    data['paging'] = paging
                    data['rangospaging'] = paging.rangos_paginado(p)
                    data['page'] = page
                    data['convocatoria'] = page.object_list
                    data['title'] = u"%s" % asignatura
                    data["url_vars"] = url_vars
                    return render(request, "niveles/convocatorias.html", data)
                except Exception as ex:
                    return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos. %s" % ex.__str__()})

            elif action == 'docentesafinidad':
                try:
                    data['title'] = u"Docentes afinidad"
                    data['mallaid'] = request.GET.get('mallaid', '')
                    data['nivelmallaid'] = request.GET.get('nivelmallaid', '')
                    data['paraleloid'] = request.GET.get('paraleloid', '')
                    data['convocatoria'] = convocatoria = Convocatoria.objects.get(pk=request.GET['idcv'])
                    data['materia'] = materia = Materia.objects.get(pk=int(request.GET['mid']))
                    coordinadorcarrera = periodo.coordinadorcarrera_set.filter(carrera=materia.asignaturamalla.malla.carrera, status=True)
                    data['coordinadorcarrera'] = coordinadorcarrera[0] if coordinadorcarrera else ''
                    data['invitaciones'] = invitaciones = InscripcionInvitacion.objects.filter(materia=materia, inscripcion__convocatoria_id=convocatoria.pk,  status=True).order_by('inscripcion__postulante__persona__apellido1', 'inscripcion__postulante__persona__apellido2')
                    excluirinvitados = InscripcionInvitacion.objects.values_list('inscripcion_id', flat=True).filter(status=True)
                    postulantes = InscripcionConvocatoria.objects.filter(convocatoria__periodo=periodo, convocatoria_id=convocatoria.pk, status=True).exclude(id__in=excluirinvitados).order_by('postulante__persona__apellido1', 'postulante__persona__apellido2')
                    if postulantes.filter(estado=1):
                        data['inscripcionespendientes'] = f"Existen <b>{postulantes.filter(estado=1).count()}</b> inscripciones sin aceptar."

                    data['postulantes'] = postulantes.filter(estado=2)
                    data['listadopasos'] = PasosProceso.objects.filter(proceso=invitaciones[0].pasosproceso.proceso, status=True).order_by('secuencia') if invitaciones else []
                    return render(request, "niveles/docentesafinidad.html", data)
                except Exception as ex:
                    return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos. %s" % ex.__str__()})

            if action == 'verdatospersonales':
                try:
                    data['inscripcion'] = InscripcionPostulante.objects.get(pk=int(encrypt(request.GET['id'])))
                    data['niveltituloposgrado'] = NivelTitulacion.objects.filter(pk__in=[3, 4], status=True).order_by('-rango')
                    template = get_template('adm_postulacion/modal/verdatospersonales.html')
                    return JsonResponse({"result": True, 'data': template.render(data)})
                except Exception as ex:
                    return JsonResponse({"result": False, "mensaje": ex})

            elif action == 'editprofesor':
                try:
                    puede_realizar_accion(request, 'sga.puede_modificar_profesor_materia')
                    data['title'] = u'Editar profesor a materia de nivel académico'
                    data['profesormateria'] = profesormateria = ProfesorMateria.objects.get(pk=request.GET['id'])
                    data['materia'] = profesormateria.materia
                    data['tipoprofesor'] = profesormateria.tipoprofesor
                    data['profesor'] = profesormateria.profesor
                    data['segmento'] = profesormateria.segmento
                    data['desde'] = profesormateria.desde
                    data['hasta'] = profesormateria.hasta
                    data['hora'] = profesormateria.hora
                    data['principal'] = profesormateria.principal
                    data['id'] = pk = request.GET['id']
                    form = ProfesorMateriaForm(initial={'segmento': profesormateria.segmento,
                                                        'desde': profesormateria.desde,
                                                        'hasta': profesormateria.hasta,
                                                        'materia': profesormateria.materia,
                                                        'utilizawebex': profesormateria.utilizawebex,
                                                        'tipoprofesor': profesormateria.tipoprofesor,
                                                        'profesor': profesormateria.profesor.id,
                                                        'principal': profesormateria.principal,
                                                        'evalua': profesormateria.evalua,
                                                        'subactividadtutorvirtual': profesormateria.subactividadtutorvirtual,
                                                        'novalidahorario': profesormateria.novalidahorario,
                                                        'hora': profesormateria.hora})
                    form.fields['profesor'].widget.attrs['descripcion'] = profesormateria.profesor
                    form.fields['profesor'].widget.attrs['value'] = profesormateria.profesor.id
                    if puede_realizar_accion_afirmativo(request, 'sga.puede_modificar_tipoprofesor'):
                        form.editar_tipo()
                    else:
                        form.editar()
                    data['puede_modificar_tipoprofesor'] = puede_realizar_accion_afirmativo(request,
                                                                                            'sga.puede_modificar_tipoprofesor')
                    if 'mallaid' in request.GET:
                        data['mallaid'] = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = request.GET['nivelmallaid']
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    data['form'] = form
                    return render(request, "niveles/editprofesor.html", data)
                except Exception as ex:
                    pass

            elif action == 'reporte':
                try:
                    periodo = request.GET['periodo']
                    coordinacion = request.GET['coordinacion']
                    __author__ = 'Unemi'
                    style0 = easyxf('font: name Times New Roman, color-index blue, bold off', num_format_str='#,##0.00')
                    style_nb = easyxf('font: name Times New Roman, color-index blue, bold on',
                                      num_format_str='#,##0.00')
                    style_sb = easyxf('font: name Times New Roman, color-index blue, bold on')
                    title = easyxf(
                        'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    style1 = easyxf(num_format_str='D-MMM-YY')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('exp_xls_post_part')
                    ws.write_merge(0, 0, 0, 10, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=exp_xls_post_part_' + random.randint(1,
                                                                                                                 10000).__str__() + '.xls'

                    columns = [
                        (u"PERIODO", 6000),
                        (u"FACULTAD", 6000),
                        (u"CARRERA", 6000),
                        (u"NIVEL", 6000),
                        (u"PARALELO", 6000),
                        (u"DOCENTE", 6000),
                        (u"ASIGNATURA", 6000),
                        (u"PROMEDIO PARCIAL 1", 6000),
                        (u"PROMEDIO PARCIAL 1 CON NOTA", 6000),
                        (u"PROMEDIO PARCIAL 2", 6000),
                        (u"PROMEDIO PARCIAL 2 CON NOTA", 6000),
                        (u"PROMEDIO NOTA FINAL", 6000),
                        (u"PROMEDIO NOTA FINAL CON NOTA", 6000),
                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], font_style)
                        ws.col(col_num).width = columns[col_num][1]
                    cursor = connections['sga_select'].cursor()
                    sql = "SELECT DISTINCT sga_periodo.nombre AS Periodo, sga_coordinacion.nombre AS Facultad, sga_carrera.nombre AS Carrera, " \
                          " sga_nivelmalla.nombre as Nivel, sga_materia.paralelo as Paralelo, (sga_persona.apellido1 || ' ' || sga_persona.apellido2 || ' ' || sga_persona.nombres) AS Docente, " \
                          " sga_asignatura.nombre AS Asignatura, (select round(avg(valor),2) from public.sga_materiaasignada sga_materiaasignada, public.sga_matricula sga_matricula , public.sga_evaluaciongenerica sga_evaluaciongenerica, public.sga_detallemodeloevaluativo sga_detallemodeloevaluativo where sga_materiaasignada.matricula_id=sga_matricula.id and sga_matricula.estado_matricula in (2,3) " \
                          " and sga_materiaasignada.materia_id=sga_materia.id and sga_evaluaciongenerica.materiaasignada_id=sga_materiaasignada.id and sga_detallemodeloevaluativo.id=sga_evaluaciongenerica.detallemodeloevaluativo_id and sga_detallemodeloevaluativo.id in (14,4)) as P1COMPLETO, " \
                          " (select round(avg(valor),2) from public.sga_materiaasignada sga_materiaasignada, public.sga_matricula sga_matricula ,public.sga_evaluaciongenerica sga_evaluaciongenerica, public.sga_detallemodeloevaluativo sga_detallemodeloevaluativo where sga_materiaasignada.matricula_id=sga_matricula.id and sga_matricula.estado_matricula in (2,3) and sga_materiaasignada.materia_id=sga_materia.id " \
                          " and sga_evaluaciongenerica.materiaasignada_id=sga_materiaasignada.id and sga_detallemodeloevaluativo.id=sga_evaluaciongenerica.detallemodeloevaluativo_id and sga_detallemodeloevaluativo.id in (14,4) and sga_materiaasignada.notafinal>0) as P1CONNOTA, " \
                          " (select round(avg(valor),2) from public.sga_materiaasignada sga_materiaasignada,  public.sga_matricula sga_matricula, public.sga_evaluaciongenerica sga_evaluaciongenerica, public.sga_detallemodeloevaluativo sga_detallemodeloevaluativo where sga_materiaasignada.matricula_id=sga_matricula.id and sga_matricula.estado_matricula in (2,3) and sga_materiaasignada.materia_id=sga_materia.id " \
                          " and sga_evaluaciongenerica.materiaasignada_id=sga_materiaasignada.id and sga_detallemodeloevaluativo.id=sga_evaluaciongenerica.detallemodeloevaluativo_id and sga_detallemodeloevaluativo.nombre='P2') as P2COMPLETO, " \
                          " (select round(avg(valor),2) from public.sga_materiaasignada sga_materiaasignada, public.sga_matricula sga_matricula ,public.sga_evaluaciongenerica sga_evaluaciongenerica, public.sga_detallemodeloevaluativo sga_detallemodeloevaluativo where sga_materiaasignada.matricula_id=sga_matricula.id and sga_matricula.estado_matricula i (2,3) and sga_materiaasignada.materia_id=sga_materia.id " \
                          " and sga_evaluaciongenerica.materiaasignada_id=sga_materiaasignada.id and sga_detallemodeloevaluativo.id=sga_evaluaciongenerica.detallemodeloevaluativo_id and sga_detallemodeloevaluativo.nombre='P2'  and sga_materiaasignada.notafinal>0) as P2CONNOTA, " \
                          " (select round(avg(m1.notafinal),2) from sga_materiaasignada m1, sga_matricula mat where m1.matricula_id=mat.id and mat.estado_matricula in (2,3) and m1.materia_id=sga_materia.id and m1.notafinal>0) as Nota_FinalCONNOTA, " \
                          " (select round(avg(m1.notafinal),2) from sga_materiaasignada m1, sga_matricula mat where m1.matricula_id=mat.id and mat.estado_matricula in (2,3) and m1.materia_id=sga_materia.id) as Nota_FinalCOMPLETO FROM public.sga_profesor sga_profesor RIGHT OUTER JOIN public.sga_profesormateria sga_profesormateria ON sga_profesor.id = sga_profesormateria.profesor_id inner JOIN public.sga_persona sga_persona ON sga_profesor.persona_id = sga_persona.id inner JOIN public.sga_materia sga_materia ON sga_profesormateria.materia_id = sga_materia.id inner JOIN public.sga_nivel sga_nivel ON sga_materia.nivel_id = sga_nivel.id inner JOIN public.sga_asignatura sga_asignatura ON sga_materia.asignatura_id = sga_asignatura.id inner JOIN public.sga_asignaturamalla sga_asignaturamalla ON sga_materia.asignaturamalla_id = sga_asignaturamalla.id inner join public.sga_nivelmalla sga_nivelmalla ON sga_nivelmalla.id=sga_asignaturamalla.nivelmalla_id inner JOIN public.sga_malla sga_malla ON sga_asignaturamalla.malla_id = sga_malla.id inner JOIN public.sga_carrera sga_carrera ON sga_malla.carrera_id = sga_carrera.id inner JOIN public.sga_coordinacion_carrera sga_coordinacion_carrera ON sga_carrera.id = sga_coordinacion_carrera.carrera_id inner JOIN public.sga_coordinacion sga_coordinacion ON sga_coordinacion_carrera.coordinacion_id = sga_coordinacion.id inner JOIN public.sga_periodo sga_periodo ON sga_nivel.periodo_id = sga_periodo.id WHERE sga_profesormateria.principal = True And sga_periodo.id = '" + periodo + "' And sga_coordinacion.id = '" + coordinacion + "' ORDER BY sga_carrera.nombre ASC, Docente ASC, sga_asignatura.nombre ASC"
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    row_num = 4
                    for r in results:
                        i = 0
                        campo1 = r[0]
                        campo2 = r[1]
                        campo3 = r[2]
                        campo4 = r[3]
                        campo5 = r[4]
                        campo6 = r[5]
                        campo7 = r[6]
                        campo8 = r[7]
                        campo9 = r[8]
                        campo10 = r[9]
                        campo11 = r[10]
                        campo12 = r[12]
                        campo13 = r[11]
                        ws.write(row_num, 0, campo1, font_style2)
                        ws.write(row_num, 1, campo2, font_style2)
                        ws.write(row_num, 2, campo3, font_style2)
                        ws.write(row_num, 3, campo4, font_style2)
                        ws.write(row_num, 4, campo5, font_style2)
                        ws.write(row_num, 5, campo6, font_style2)
                        ws.write(row_num, 6, campo7, font_style2)
                        ws.write(row_num, 7, campo8, font_style2)
                        ws.write(row_num, 8, campo9, font_style2)
                        ws.write(row_num, 9, campo10, font_style2)
                        ws.write(row_num, 10, campo11, font_style2)
                        ws.write(row_num, 11, campo12, font_style2)
                        ws.write(row_num, 12, campo13, font_style2)
                        # while i < len(r):
                        #     # ws.write(row_num, i, r[i], font_style)
                        #     # ws.col(i).width = columns[i][1]
                        row_num += 1
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'reporteafinidad':
                try:
                    periodo = request.GET['periodo']
                    __author__ = 'Unemi'
                    style0 = easyxf('font: name Times New Roman, color-index blue, bold off', num_format_str='#,##0.00')
                    style_nb = easyxf('font: name Times New Roman, color-index blue, bold on', num_format_str='#,##0.00')
                    style_sb = easyxf('font: name Times New Roman, color-index blue, bold on')
                    title = easyxf('font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    style1 = easyxf(num_format_str='D-MMM-YY')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('exp_xls_post_part')
                    ws.write_merge(0, 0, 0, 10, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=exp_xls_post_part_' + random.randint(1, 10000).__str__() + '.xls'
                    columns = [
                        (u"FACULTAD", 6000),
                        (u"CARRERA", 6000),
                        (u"ASIGNATURA", 6000),
                        (u"PARALELO", 6000),
                        (u"CAMPO AMPLIO ASIGNATURA", 6000),
                        (u"CAMPO ESPECIFICO ASIGNATURA", 6000),
                        (u"CAMPO DETALLADO ASIGNATURA", 6000),
                        (u"MATERIA TIENE AFINIDAD DOCTORADO", 6000),
                        (u"PROFESOR", 6000),
                        (u"TITULO PROFESOR", 6000),
                        (u"NIVEL TITULO PROFESOR", 6000),
                        (u"CAMPO AMPLIO TITULO PROFESOR", 6000),
                        (u"CAMPO ESPECIFICO TITULO PROFESOR", 6000),
                        (u"CAMPO DETALLADO TITULO PROFESOR", 6000),
                        (u"CUMPLE CAMPO AMPLIO TITULO PROFESOR", 6000),
                        (u"CUMPLE CAMPO ESPECIFICO TITULO PROFESOR", 6000),
                        (u"CUMPLE CAMPO DETALLADO TITULO PROFESOR", 6000),
                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], font_style)
                        ws.col(col_num).width = columns[col_num][1]
                    profesormaterias = ProfesorMateria.objects.filter(status=True, materia__nivel__periodo=periodo).exclude(materia__asignaturamalla__malla__carrera__coordinacion__id__in=[7,9]).order_by('materia__asignaturamalla__malla__carrera__coordinacion', 'materia__asignaturamalla__malla__carrera', 'materia')
                    row_num = 4
                    for profemateria in profesormaterias:
                        print(u"%s --- %s"%(profemateria.id,profemateria))
                        ws.write(row_num, 0, u"%s"%profemateria.materia.asignaturamalla.malla.carrera.mi_coordinacion(), font_style2)
                        ws.write(row_num, 1, u"%s"%profemateria.materia.asignaturamalla.malla.carrera.nombre_completo(), font_style2)
                        ws.write(row_num, 2, u"%s"%profemateria.materia.asignaturamalla.asignatura.nombre, font_style2)
                        ws.write(row_num, 3, u"%s"%profemateria.materia.paralelo, font_style2)
                        ws.write(row_num, 4, u"%s"%profemateria.materia.asignaturamalla.areaconocimientotitulacion.nombre if profemateria.materia.asignaturamalla.areaconocimientotitulacion else "NO TIENE CONFGURADO", font_style2)
                        ws.write(row_num, 5, u"%s"%profemateria.materia.asignaturamalla.subareaconocimiento.nombre if profemateria.materia.asignaturamalla.subareaconocimiento else "NO TIENE CONFIGURADO", font_style2)
                        ws.write(row_num, 6, u"%s"%profemateria.materia.asignaturamalla.subareaespecificaconocimiento.nombre if profemateria.materia.asignaturamalla.subareaespecificaconocimiento else "NO TIENE CONFIGURADO", font_style2)
                        ws.write(row_num, 7, u"%s"% "SI" if profemateria.materia.asignaturamalla.afinidaddoctorado else "NO", font_style2)
                        ws.write(row_num, 8, u"%s"%profemateria.profesor.persona.nombre_completo_inverso(), font_style2)
                        if profemateria.materia.asignaturamalla.afinidaddoctorado:
                            if profemateria.profesor.persona.titulacion_set.filter(titulo__grado_id=1, titulo__status=True, status=True):
                                itemtitulo = profemateria.profesor.persona.titulacion_set.filter(titulo__grado_id=1,titulo__status=True, status=True)[0]
                                campodoctor=None
                                if CamposTitulosPostulacion.objects.filter(status=True,titulo=itemtitulo.titulo).exists():
                                    campodoctor=CamposTitulosPostulacion.objects.filter(status=True,titulo=itemtitulo.titulo)[0]
                                ws.write(row_num, 9, u"%s" % itemtitulo.titulo,font_style2)
                                ws.write(row_num, 10, u"%s" % itemtitulo.titulo.grado.nombre,font_style2)
                                ws.write(row_num, 11, u"%s" % campodoctor.campoamplio.all()[0].nombre if campodoctor else "TITULO PROFESOR NO TIENE CAMPO",font_style2)
                                ws.write(row_num, 12, u"%s" % campodoctor.campoespecifico.all()[0].nombre if campodoctor else "TITULO PROFESOR NO TIENE CAMPO",font_style2)
                                ws.write(row_num, 13, u"%s" % campodoctor.campodetallado.all()[0].nombre if campodoctor else "TITULO PROFESOR NO TIENE CAMPO",font_style2)
                                ws.write(row_num, 14, u"SI" ,font_style2)
                                ws.write(row_num, 15, u"SI" ,font_style2)
                                ws.write(row_num, 16, u"SI" ,font_style2)
                            else:
                                ws.write(row_num, 9, u"NO REGISTRA", font_style2)
                                ws.write(row_num, 10, u"NO REGISTRA", font_style2)
                                ws.write(row_num, 11, u"NO REGISTRA", font_style2)
                                ws.write(row_num, 12, u"NO REGISTRA", font_style2)
                                ws.write(row_num, 13, u"NO REGISTRA", font_style2)
                                ws.write(row_num, 14, u"NO", font_style2)
                                ws.write(row_num, 15, u"NO", font_style2)
                                ws.write(row_num, 16, u"NO", font_style2)
                        else:
                            titulos = profemateria.profesor.persona.titulacion_set.filter(titulo__grado_id__in=[1, 2, 5], titulo__status=True, status=True)
                            if titulos:
                                for item in titulos.order_by('titulo__grado_id'):
                                    eCampos = CamposTitulosPostulacion.objects.filter(status=True, titulo=item.titulo).order_by('titulo__grado_id')
                                    if eCampos.exists():
                                        eCampo = eCampos.first()
                                        if item.titulo.grado_id in [1, 2, 5]:
                                            ecampoamplios = []
                                            ecampoespecificos = []
                                            ecampodetallados = []
                                            if profemateria.materia.asignaturamalla.areaconocimientotitulacion:
                                                ecampoamplios = eCampo.campoamplio.filter( pk=profemateria.materia.asignaturamalla.areaconocimientotitulacion.pk)
                                            if profemateria.materia.asignaturamalla.subareaconocimiento:
                                                ecampoespecificos = eCampo.campoespecifico.filter( pk=profemateria.materia.asignaturamalla.subareaconocimiento.pk)
                                            if profemateria.materia.asignaturamalla.subareaespecificaconocimiento:
                                                ecampodetallados = eCampo.campodetallado.filter( pk=profemateria.materia.asignaturamalla.subareaespecificaconocimiento.pk)
                                            if len(ecampoamplios) > 0 or len(ecampoespecificos) > 0 or len( ecampodetallados) > 0:
                                                ws.write(row_num, 9, u"%s" % item.titulo, font_style2)
                                                ws.write(row_num, 10, u"%s" % item.titulo.grado.nombre, font_style2)
                                                ws.write(row_num, 11, u"%s" % eCampo.campoamplio.all()[0].nombre  if eCampo.campoamplio.all() else "TITULO PROFESOR NO TIENE CAMPO",font_style2)
                                                ws.write(row_num, 12, u"%s" % eCampo.campoespecifico.all()[0].nombre if eCampo.campoespecifico.all() else "TITULO PROFESOR NO TIENE CAMPO", font_style2)
                                                ws.write(row_num, 13, u"%s" % eCampo.campodetallado.all()[0].nombre if eCampo.campodetallado.all() else "TITULO PROFESOR NO TIENE CAMPO", font_style2)
                                                ws.write(row_num, 14, u"SI" if profemateria.afinidadcampoamplio else "NO", font_style2)
                                                ws.write(row_num, 15, u"SI" if profemateria.afinidadcampoespecifico else "NO", font_style2)
                                                ws.write(row_num, 16, u"SI" if profemateria.afinidadcampodetallado else "NO", font_style2)
                                                break
                                        else:
                                            ws.write(row_num, 9, u"%s" % item.titulo, font_style2)
                                            ws.write(row_num, 10, u"%s" % item.titulo.grado.nombre, font_style2)
                                            ws.write(row_num, 11, u"TITULO DE PROFESOR NO CUMPLE PARAMETRO", font_style2)
                                            ws.write(row_num, 12, u"TITULO DE PROFESOR NO CUMPLE PARAMETRO", font_style2)
                                            ws.write(row_num, 13, u"TITULO DE PROFESOR NO CUMPLE PARAMETRO", font_style2)
                                            ws.write(row_num, 14, u"SI" if profemateria.afinidadcampoamplio else "NO", font_style2)
                                            ws.write(row_num, 15, u"SI" if profemateria.afinidadcampoespecifico else "NO", font_style2)
                                            ws.write(row_num, 16, u"SI" if profemateria.afinidadcampodetallado else "NO", font_style2)
                                            break
                                    else:
                                        ws.write(row_num, 9, u"%s" % item.titulo, font_style2)
                                        ws.write(row_num, 10, u"%s" % item.titulo.grado.nombre, font_style2)
                                        ws.write(row_num, 11, u"TITULO DE PROFESOR NO TIENE CONFIGURADO CAMPOS", font_style2)
                                        ws.write(row_num, 12, u"TITULO DE PROFESOR NO TIENE CONFIGURADO CAMPOS", font_style2)
                                        ws.write(row_num, 13, u"TITULO DE PROFESOR NO TIENE CONFIGURADO CAMPOS", font_style2)
                                        ws.write(row_num, 14, u"SI" if profemateria.afinidadcampoamplio else "NO", font_style2)
                                        ws.write(row_num, 15, u"SI" if profemateria.afinidadcampoespecifico else "NO",  font_style2)
                                        ws.write(row_num, 16, u"SI" if profemateria.afinidadcampodetallado else "NO", font_style2)
                                        break
                            else:
                                ws.write(row_num, 9, u"PROFESOR NO TIENE TITULOS", font_style2)
                                ws.write(row_num, 10, u"PROFESOR NO TIENE TITULOS", font_style2)
                                ws.write(row_num, 11, u"PROFESOR NO TIENE TITULOS", font_style2)
                                ws.write(row_num, 12, u"PROFESOR NO TIENE TITULOS", font_style2)
                                ws.write(row_num, 13, u"PROFESOR NO TIENE TITULOS", font_style2)
                                ws.write(row_num, 14, u"SI" if profemateria.afinidadcampoamplio else "NO", font_style2)
                                ws.write(row_num, 15, u"SI" if profemateria.afinidadcampoespecifico else "NO", font_style2)
                                ws.write(row_num, 16, u"SI" if profemateria.afinidadcampodetallado else "NO", font_style2)
                        row_num += 1
                    wb.save(response)
                    return response
                except Exception as ex:
                    print('Error on line {} - {}'.format(sys.exc_info()[-1].tb_lineno, ex))
                    pass

            elif action == 'preferenciasasignaturas':
                try:
                    periodo = request.GET['periodo']
                    __author__ = 'Unemi'
                    style0 = easyxf('font: name Times New Roman, color-index blue, bold off', num_format_str='#,##0.00')
                    style_nb = easyxf('font: name Times New Roman, color-index blue, bold on',
                                      num_format_str='#,##0.00')
                    style_sb = easyxf('font: name Times New Roman, color-index blue, bold on')
                    title = easyxf(
                        'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    style1 = easyxf(num_format_str='D-MMM-YY')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('preferenciasasignaturas')
                    ws.write_merge(0, 0, 0, 10, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=exp_xls_post_part_' + random.randint(1,
                                                                                                                 10000).__str__() + '.xls'
                    columns = [
                        (u"CEDULA", 6000),
                        (u"DOCENTE", 6000),
                        (u"ASIGNATURA", 6000),
                        (u"CARRERA", 6000),
                        (u"MALLA", 6000),
                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], font_style)
                        ws.col(col_num).width = columns[col_num][1]
                    cursor = connections['sga_select'].cursor()
                    sql = ""
                    sql = "SELECT per.cedula, (per.apellido1 || ' ' || per.apellido2 || ' ' || per.nombres) AS profesor, asi.nombre AS asignatura, car.nombre AS carrera, ma.inicio AS malla " \
                          " FROM sga_asignaturamallapreferencia pre " \
                          " INNER JOIN sga_profesor pro ON pre.profesor_id=pro.id and pro.status=true " \
                          " INNER JOIN sga_persona per ON per.id=pro.persona_id and per.status=true " \
                          " INNER JOIN sga_asignaturamalla am ON am.id=pre.asignaturamalla_id and am.status=true " \
                          " INNER JOIN sga_asignatura asi ON asi.id=am.asignatura_id and asi.status=true " \
                          " INNER JOIN sga_malla ma ON ma.id=am.malla_id and ma.status=true " \
                          " INNER JOIN sga_carrera car ON car.id=ma.carrera_id and car.status=true " \
                          " where pre.periodo_id=" + str(periodo) + " " \
                                                                    " ORDER BY per.apellido1, per.apellido2"

                    # profesormaterias = ProfesorMateria.objects.filter(status=True, materia__nivel__periodo=periodo).exclude(materia__asignaturamalla__malla__carrera__coordinacion__id__in=[7,9]).order_by('materia__asignaturamalla__malla__carrera__coordinacion', 'materia__asignaturamalla__malla__carrera', 'materia')
                    cursor.execute(sql)
                    profesormaterias = cursor.fetchall()
                    row_num = 4
                    for pm in profesormaterias:
                        i = 0
                        campo1 = pm[0]
                        campo2 = pm[1]
                        campo3 = pm[2]
                        campo4 = pm[3]
                        campo5 = pm[4]
                        ws.write(row_num, 0, campo1, font_style2)
                        ws.write(row_num, 1, campo2, font_style2)
                        ws.write(row_num, 2, campo3, font_style2)
                        ws.write(row_num, 3, campo4, font_style2)
                        ws.write(row_num, 4, campo5, style1)
                        row_num += 1
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'preferenciashorarios':
                try:
                    periodo = request.GET['periodo']
                    __author__ = 'Unemi'
                    style0 = easyxf('font: name Times New Roman, color-index blue, bold off', num_format_str='#,##0.00')
                    style_nb = easyxf('font: name Times New Roman, color-index blue, bold on',
                                      num_format_str='#,##0.00')
                    style_sb = easyxf('font: name Times New Roman, color-index blue, bold on')
                    title = easyxf(
                        'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    style1 = easyxf(num_format_str='D-MMM-YY')
                    style2 = easyxf(num_format_str='HH:mm')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('preferenciashorarios')
                    ws.write_merge(0, 0, 0, 10, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=exp_xls_post_part_' + random.randint(1,
                                                                                                                 10000).__str__() + '.xls'
                    columns = [
                        (u"FACULTAD", 6000),
                        (u"CEDULA", 6000),
                        (u"DOCENTE", 6000),
                        (u"DÍA", 6000),
                        (u"HORA INICIO", 6000),
                        (u"HORA FIN", 6000),
                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], font_style)
                        ws.col(col_num).width = columns[col_num][1]
                    cursor = connections['sga_select'].cursor()
                    sql = ""
                    sql = "select fac.nombre, per.cedula,  " \
                          " (per.apellido1 || ' ' || per.apellido2 || ' ' || per.nombres) as profesor,  " \
                          " dia.nombre as dia, tur.comienza, tur.termina " \
                          " from sga_horariopreferencia pre  " \
                          " inner join sga_profesor pro on pre.profesor_id=pro.id  " \
                          " inner join sga_persona per on per.id=pro.persona_id  " \
                          " inner join sga_diasemana dia on dia.id=pre.dia  " \
                          " inner join sga_turno tur on tur.id=pre.turno_id  " \
                          " inner join sga_profesordistributivohoras dis on dis.profesor_id=pro.id  " \
                          " inner join sga_coordinacion fac on fac.id=dis.coordinacion_id  " \
                          " where pre.periodo_id=" + str(periodo) + " " \
                                                                    " order by per.apellido1, per.apellido2, dia asc, tur.comienza asc"

                    # profesormaterias = ProfesorMateria.objects.filter(status=True, materia__nivel__periodo=periodo).exclude(materia__asignaturamalla__malla__carrera__coordinacion__id__in=[7,9]).order_by('materia__asignaturamalla__malla__carrera__coordinacion', 'materia__asignaturamalla__malla__carrera', 'materia')
                    cursor.execute(sql)
                    profesormaterias = cursor.fetchall()
                    row_num = 4
                    for pm in profesormaterias:
                        i = 0
                        campo1 = pm[0]
                        campo2 = pm[1]
                        campo3 = pm[2]
                        campo4 = pm[3]
                        campo5 = pm[4]
                        campo6 = pm[5]
                        ws.write(row_num, 0, campo1, font_style2)
                        ws.write(row_num, 1, campo2, font_style2)
                        ws.write(row_num, 2, campo3, font_style2)
                        ws.write(row_num, 3, campo4, font_style2)
                        ws.write(row_num, 4, campo5, style2)
                        ws.write(row_num, 5, campo6, style2)
                        row_num += 1
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'reportedistributivo_preferencias':
                try:
                    __author__ = 'Unemi'
                    title = easyxf(
                        'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    style1 = easyxf(num_format_str='D-MMM-YY')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('exp_xls_post_part')
                    ws.write_merge(0, 0, 0, 10, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                    response = HttpResponse(content_type="application/ms-excel")
                    response[
                        'Content-Disposition'] = 'attachment; filename=DISTRIBUTIVO ASIGNATURA ' + periodo.nombre.__str__() + '.xls'

                    periodo_id = request.GET['periodo']
                    row_num = 3
                    date_format = xlwt.XFStyle()
                    date_format.num_format_str = 'yyyy/mm/dd'
                    columns = [
                        (u"FACULTAD", 6000), (u"CARRERA", 6000),
                        (u"SECCIÓN", 6000), (u"NIVEL", 6000),
                        (u"PARALELO", 6000), (u"IDMATERIA", 2500), (u"DOCENTE", 6000),
                        (u"ASIGNATURA", 6000),
                        (u"HORAS SEMANALES", 4000), (u"MALLA (HORAS PRESENCIALES SEMANALES)", 4000),
                        (u"TIPO", 4000), (u"CEDULA", 4000),
                        (u"TIPO PROFESOR", 4000), (u"DEDICACION", 5000),
                        (u"CATEGORIA", 4000), (u"ACEPTACION", 2500),
                        (u"OBSERVACION ACEPTACION", 10000), (u"HORARIO ACEPTACION", 10000),
                        (u"HORARIO OBSERVACION ACEPTACION", 10000), (u"PREFERENCIA DE ASIGNATURA", 10000),
                        (u"SI PREFERENCIA", 10000),
                        (u"ASIGNATURA DE CONCURSO", 10000), (u"SI CONCURSO", 10000),
                        (u"HISTORICO", 10000), (u"SI HISTORICO", 10000), (u"PERIODO", 10000)
                    ]
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], font_style)
                        ws.col(col_num).width = columns[col_num][1]
                    cursor = connections['sga_select'].cursor()
                    sql = """
                    SELECT sga_coordinacion.nombre AS Facultad, 
                     sga_carrera.nombre AS Carrera, 
                     sga_sesion.nombre AS Seccion, 
                     sga_nivelmalla.nombre AS Nivel, 
                     sga_materia.paralelo AS Paralelo, 
                     sga_materia.id AS Idmateria, 
                     sga_persona.apellido1 || ' ' || sga_persona.apellido2 || ' ' || sga_persona.nombres AS Docente, 
                     sga_asignatura.nombre AS Asignatura, 
                     sga_profesormateria.hora AS sga_profesormateria_hora, 
                     sga_asignaturamalla.horaspresencialessemanales AS horaspresencialessemanales, 
                     (CASE sga_profesormateria.principal WHEN TRUE THEN 'PRINCIPAL' ELSE 'PRACTICA' END) AS Tipo, 
                     sga_persona.cedula,
                     sga_tipoprofesor.nombre AS Tipoprofesor, 
                    (SELECT ti.nombre
                    FROM sga_profesordistributivohoras dis,sga_tiempodedicaciondocente ti
                    WHERE dis.dedicacion_id=ti.id AND dis.profesor_id=sga_profesor.id AND periodo_id= sga_periodo.id AND dis.status= TRUE LIMIT 1) AS dedicacion, 
                    (SELECT ca.nombre
                    FROM sga_profesordistributivohoras dis,sga_categorizaciondocente ca
                    WHERE dis.categoria_id=ca.id AND dis.profesor_id=sga_profesor.id AND dis.periodo_id=sga_periodo.id AND dis.status= TRUE LIMIT 1) AS categoria, 
                     sga_profesormateria.aceptarmateria AS aceptarmateria, 
                     sga_profesormateria.aceptarmateriaobs AS aceptarmateriaobs, 
                     sga_profesormateria.aceptarhorario AS aceptarhorario, 
                     sga_profesormateria.aceptarhorarioobs AS aceptarhorarioobs,
                    (SELECT string_agg(DISTINCT a.nombre, ', ')
                    FROM sga_asignaturamallapreferencia pre
                    INNER JOIN sga_asignaturamalla am ON am.id=pre.asignaturamalla_id
                    INNER JOIN sga_asignatura a ON a.id=am.asignatura_id
                    WHERE pre.periodo_id = sga_periodo.id AND pre.profesor_id=sga_profesor.id AND pre."status"= TRUE) AS preferencias,
                    (SELECT pre.id
                    FROM sga_asignaturamallapreferencia pre
                    INNER JOIN sga_asignaturamalla am ON am.id=pre.asignaturamalla_id
                    WHERE pre.periodo_id = sga_periodo.id AND pre.profesor_id=sga_profesor.id AND pre."status"= TRUE AND am.asignatura_id=sga_materia.asignatura_id LIMIT 1) AS sipreferencia,
                    (SELECT string_agg(DISTINCT a.nombre, ', ')
                    FROM sga_profesor_asignatura pa
                    INNER JOIN sga_asignatura a ON a.id=pa.asignatura_id
                    WHERE pa.profesor_id=sga_profesor.id) AS concurso,
                    (SELECT pa.id
                    FROM sga_profesor_asignatura pa
                    WHERE pa.profesor_id=sga_profesor.id AND pa.asignatura_id=sga_materia.asignatura_id LIMIT 1) AS concursosi,
                    (SELECT string_agg(DISTINCT a.nombre, ', ')
                    FROM sga_periodo per
                    INNER JOIN sga_nivel ni ON ni.periodo_id=per.id
                    INNER JOIN sga_materia ma ON ma.nivel_id=ni.id
                    INNER JOIN sga_asignaturamalla am ON am.id=ma.asignaturamalla_id
                    INNER JOIN sga_asignatura a ON a.id=am.asignatura_id
                    INNER JOIN sga_profesormateria pm ON pm.materia_id=ma.id
                    WHERE per.id = 90 AND pm.activo= TRUE AND pm.profesor_id=sga_profesor.id AND pm."status"= TRUE AND ma."status"= TRUE ) AS historico,
                    (SELECT ma.id
                    FROM sga_periodo per
                    INNER JOIN sga_nivel ni ON ni.periodo_id=per.id
                    INNER JOIN sga_materia ma ON ma.nivel_id=ni.id
                    INNER JOIN sga_profesormateria pm ON pm.materia_id=ma.id
                    WHERE per.id = 90 AND pm.activo= TRUE AND pm.profesor_id=sga_profesor.id AND ma.asignatura_id=sga_materia.asignatura_id AND pm."status"= TRUE AND ma."status"= TRUE
                    LIMIT 1 ) AS historicosi
                    FROM public.sga_materia sga_materia
                    LEFT JOIN public.sga_profesormateria sga_profesormateria ON sga_materia.id = sga_profesormateria.materia_id AND sga_profesormateria.status= TRUE AND sga_profesormateria.activo= TRUE
                    LEFT JOIN public.sga_profesor sga_profesor ON sga_profesor.id = sga_profesormateria.profesor_id AND sga_profesor.status= TRUE
                    LEFT JOIN public.sga_tipoprofesor sga_tipoprofesor ON sga_tipoprofesor.id = sga_profesormateria.tipoprofesor_id AND sga_tipoprofesor.status= TRUE
                    LEFT JOIN public.sga_persona sga_persona ON sga_profesor.persona_id = sga_persona.id AND sga_persona.status= TRUE
                    INNER JOIN public.sga_nivel sga_nivel ON sga_materia.nivel_id = sga_nivel.id AND sga_nivel.status= TRUE
                    INNER JOIN public.sga_asignatura sga_asignatura ON sga_materia.asignatura_id = sga_asignatura.id AND sga_asignatura.status= TRUE
                    INNER JOIN public.sga_asignaturamalla sga_asignaturamalla ON sga_materia.asignaturamalla_id = sga_asignaturamalla.id AND sga_asignaturamalla.status= TRUE
                    INNER JOIN public.sga_nivelmalla sga_nivelmalla ON sga_asignaturamalla.nivelmalla_id = sga_nivelmalla.id AND sga_nivelmalla.status= TRUE
                    INNER JOIN public.sga_malla sga_malla ON sga_asignaturamalla.malla_id = sga_malla.id AND sga_malla.status= TRUE
                    INNER JOIN public.sga_carrera sga_carrera ON sga_malla.carrera_id = sga_carrera.id AND sga_carrera.status= TRUE
                    INNER JOIN public.sga_coordinacion_carrera sga_coordinacion_carrera ON sga_carrera.id = sga_coordinacion_carrera.carrera_id
                    INNER JOIN public.sga_coordinacion sga_coordinacion ON sga_coordinacion_carrera.coordinacion_id = sga_coordinacion.id AND sga_coordinacion.status= TRUE
                    INNER JOIN public.sga_sesion sga_sesion ON sga_nivel.sesion_id = sga_sesion.id
                    INNER JOIN public.sga_periodo sga_periodo ON sga_nivel.periodo_id = sga_periodo.id AND sga_periodo.status= TRUE
                    WHERE sga_periodo.id = %s AND sga_materia.status= TRUE
                    ORDER BY sga_coordinacion.nombre, sga_carrera.nombre, sga_sesion.nombre, sga_nivelmalla.nombre,sga_materia.paralelo,sga_asignatura.nombre                    
                    """ % periodo_id
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    row_num = 4

                    for r in results:
                        i = 0
                        campo1 = r[0].__str__()  # faculta
                        campo2 = r[1].__str__()  # carrera
                        campo3 = r[2].__str__()  # sesion
                        campo4 = r[3].__str__()  # nivel
                        campo5 = r[4].__str__()  # paralelo
                        campo6 = r[5].__str__()  # salta numero
                        campo7 = r[6].__str__()  # docente
                        campo8 = r[7].__str__()  # asignatura
                        campo9 = r[8]  # horas semanales
                        campo10 = r[9]  # horas presenciales
                        campo11 = r[10].__str__()  # tipo
                        campo12 = r[11].__str__()  # cedula
                        campo13 = r[12].__str__()  # TIPOPROFESOR
                        campo14 = r[13].__str__()  # DEDICACION
                        campo15 = r[14].__str__()  # CATEGORIA
                        if r[16] == None or r[16] == '':
                            campo16 = ''
                        elif r[15]:  # ACEPTACION
                            campo16 = 'SI'
                        else:
                            campo16 = 'NO'
                        campo17 = r[16].__str__() if r[16] else ''
                        if r[18] == None or r[18] == '':
                            campo18 = ''
                        elif r[17]:  # ACEPTACION HORARIO
                            campo18 = 'SI'
                        else:
                            campo18 = 'NO'
                        campo19 = r[18].__str__() if r[18] else ''
                        campo20 = r[19].__str__() if r[19] else ''
                        if r[20] != None:  # SI PREFERENCIAS
                            campo21 = 'SI'
                        else:
                            campo21 = 'NO'

                        campo22 = r[21].__str__() if r[21] else ''
                        if r[22] != None:  # SI CONCURSO
                            campo23 = 'SI'
                        else:
                            campo23 = 'NO'

                        campo24 = r[23].__str__() if r[23] else ''
                        if r[24] != None:  # SI HISTORICO
                            campo25 = 'SI'
                        else:
                            campo25 = 'NO'
                        campo26 = '%s' % periodo

                        ws.write(row_num, 0, campo1, font_style2)
                        ws.write(row_num, 1, campo2, font_style2)
                        ws.write(row_num, 2, campo3, font_style2)
                        ws.write(row_num, 3, campo4, font_style2)
                        ws.write(row_num, 4, campo5, font_style2)
                        ws.write(row_num, 5, campo6, font_style2)
                        ws.write(row_num, 6, campo7, font_style2)
                        ws.write(row_num, 7, campo8, font_style2)
                        ws.write(row_num, 8, campo9, font_style2)
                        ws.write(row_num, 9, campo10, font_style2)
                        ws.write(row_num, 10, campo11, font_style2)
                        ws.write(row_num, 11, campo12, font_style2)
                        ws.write(row_num, 12, campo13, font_style2)
                        ws.write(row_num, 13, campo14, font_style2)
                        ws.write(row_num, 14, campo15, font_style2)
                        ws.write(row_num, 15, campo16, font_style2)
                        ws.write(row_num, 16, campo17, font_style2)
                        ws.write(row_num, 17, campo18, font_style2)
                        ws.write(row_num, 18, campo19, font_style2)
                        ws.write(row_num, 19, campo20, font_style2)
                        ws.write(row_num, 20, campo21, font_style2)
                        ws.write(row_num, 21, campo22, font_style2)
                        ws.write(row_num, 22, campo23, font_style2)
                        ws.write(row_num, 23, campo24, font_style2)
                        ws.write(row_num, 24, campo25, font_style2)
                        ws.write(row_num, 25, campo26, font_style2)
                        row_num += 1
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'sinhorarios':
                try:
                    periodo = request.GET['periodo']
                    __author__ = 'Unemi'
                    style0 = easyxf('font: name Times New Roman, color-index blue, bold off', num_format_str='#,##0.00')
                    style_nb = easyxf('font: name Times New Roman, color-index blue, bold on',
                                      num_format_str='#,##0.00')
                    style_sb = easyxf('font: name Times New Roman, color-index blue, bold on')
                    title = easyxf(
                        'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    style1 = easyxf(num_format_str='D-MMM-YY')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('exp_xls_post_part')
                    ws.write_merge(0, 0, 0, 10, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                    response = HttpResponse(content_type="application/ms-excel")
                    response[
                        'Content-Disposition'] = 'attachment; filename=asignaturassinhorarios_' + random.randint(
                        1, 10000).__str__() + '.xls'
                    columns = [
                        (u"MATERIA", 10000),
                        (u"PARALELO", 3000),
                        (u"SECCIÓN", 6000),
                        (u"NIVEL", 6000),
                        (u"CARRERA", 6000)
                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], font_style)
                        ws.col(col_num).width = columns[col_num][1]
                    cursor = connections['sga_select'].cursor()
                    sql = "select a.nombre, m.paralelo, n.paralelo, nm.nombre, car.nombre, c.turno_id from sga_materia m " \
                          "inner join sga_nivel n on m.nivel_id=n.id and n.periodo_id=" + periodo + " " \
                                                                                                    "left join sga_clase c on c.materia_id=m.id " \
                                                                                                    "inner join sga_asignatura a on a.id=m.asignatura_id " \
                                                                                                    "inner join sga_asignaturamalla am on am.id=m.asignaturamalla_id " \
                                                                                                    "inner join sga_nivelmalla nm on nm.id=am.nivelmalla_id " \
                                                                                                    "inner join sga_malla malla on malla.id=am.malla_id " \
                                                                                                    "inner join sga_carrera car on car.id=malla.carrera_id " \
                                                                                                    "where c.turno_id is null "
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    row_num = 4
                    for r in results:
                        i = 0
                        campo1 = r[0]
                        campo2 = r[1]
                        campo3 = r[2]
                        campo4 = r[3]
                        campo5 = r[4]
                        ws.write(row_num, 0, campo1, font_style2)
                        ws.write(row_num, 1, campo2, font_style2)
                        ws.write(row_num, 2, campo3, font_style2)
                        ws.write(row_num, 3, campo4, font_style2)
                        ws.write(row_num, 4, campo5, font_style2)
                        row_num += 1
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass



            elif action == 'reporteestudiantessingrupospracticas':
                try:
                    periodo = request.GET['periodo']
                    __author__ = 'Unemi'
                    style0 = easyxf('font: name Times New Roman, color-index blue, bold off', num_format_str='#,##0.00')
                    style_nb = easyxf('font: name Times New Roman, color-index blue, bold on',
                                      num_format_str='#,##0.00')
                    style_sb = easyxf('font: name Times New Roman, color-index blue, bold on')
                    title = easyxf(
                        'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    style1 = easyxf(num_format_str='D-MMM-YY')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('exp_xls_post_part')
                    ws.write_merge(0, 0, 0, 10, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                    response = HttpResponse(content_type="application/ms-excel")
                    response[
                        'Content-Disposition'] = 'attachment; filename=estudiantessingrupospracticas_' + random.randint(
                        1, 10000).__str__() + '.xls'
                    columns = [
                        (u"MATERIA_ID", 3000),
                        (u"ESTUDIANTE", 13000),
                        (u"CEDULA", 3000),
                        (u"ASIGNATURA", 13000),
                        (u"PARALELO", 3000),
                        (u"CANTIDAD GRUPO", 5000)
                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], font_style)
                        ws.col(col_num).width = columns[col_num][1]
                    cursor = connections['sga_select'].cursor()

                    sql = f'''
                            SELECT * FROM 
                                ( SELECT mateasi.id,per.cedula, per.nombres||' '||per.apellido1||' '||per.apellido2 AS alumno,
                                asi.nombre asignatura,
                                ma.paralelo,
                                ( SELECT COUNT(ap.id) FROM sga_alumnospracticamateria ap 
                                        inner join sga_materiaasignada ma1 ON ma1.id=ap.materiaasignada_id 
                                    WHERE ma1.id=mateasi.id ) AS cant_grupos
                                 FROM sga_materiaasignada mateasi 
                                 INNER JOIN sga_matricula matric ON matric.id=mateasi.matricula_id 
                                 INNER JOIN sga_inscripcion ins ON ins.id=matric.inscripcion_id 
                                 INNER JOIN sga_persona per ON per.id=ins.persona_id 
                                 INNER JOIN sga_nivel niv ON niv.id=matric.nivel_id 
                                 inner join sga_materia ma ON ma.id=mateasi.materia_id 
                                 INNER JOIN sga_asignatura asi ON asi.id=ma.asignatura_id 
                                 INNER JOIN sga_asignaturamalla asimall ON asimall.id=ma.asignaturamalla_id 
                                WHERE niv.periodo_id={periodo} AND asimall.practicas= TRUE ) as tabla1 
                                WHERE tabla1.cant_grupos=0
                            '''
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    row_num = 4
                    for r in results:
                        i = 0
                        campo1 = r[0]
                        campo2 = r[2]
                        campo3 = r[1]
                        campo4 = r[3]
                        campo5 = r[4]
                        campo6 = r[5]
                        ws.write(row_num, 0, campo1, font_style2)
                        ws.write(row_num, 1, campo2, font_style2)
                        ws.write(row_num, 2, campo3, font_style2)
                        ws.write(row_num, 3, campo4, font_style2)
                        ws.write(row_num, 4, campo5, font_style2)
                        ws.write(row_num, 5, campo6, font_style2)
                        row_num += 1
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass
            # elif action == 'sinhorariospracticas':
            #     try:
            #         periodo = request.GET['periodo']
            #         __author__ = 'Unemi'
            #         style0 = easyxf('font: name Times New Roman, color-index blue, bold off', num_format_str='#,##0.00')
            #         style_nb = easyxf('font: name Times New Roman, color-index blue, bold on', num_format_str='#,##0.00')
            #         style_sb = easyxf('font: name Times New Roman, color-index blue, bold on')
            #         title = easyxf('font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
            #         style1 = easyxf(num_format_str='D-MMM-YY')
            #         font_style = XFStyle()
            #         font_style.font.bold = True
            #         font_style2 = XFStyle()
            #         font_style2.font.bold = False
            #         wb = Workbook(encoding='utf-8')
            #         ws = wb.add_sheet('exp_xls_post_part')
            #         ws.write_merge(0, 0, 0, 10, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
            #         response = HttpResponse(content_type="application/ms-excel")
            #         response[
            #             'Content-Disposition'] = 'attachment; filename=exp_xls_post_part_' + random.randint(
            #             1, 10000).__str__() + '.xls'
            #         columns = [
            #             (u"PROFESOR", 3000),
            #             (u"MATERIA", 10000),
            #             (u"PARALELO", 3000),
            #             (u"SECCIÓN", 6000),
            #             (u"NIVEL", 6000),
            #             (u"CARRERA", 6000)
            #         ]
            #         row_num = 3
            #         for col_num in range(len(columns)):
            #             ws.write(row_num, col_num, columns[col_num][0], font_style)
            #             ws.col(col_num).width = columns[col_num][1]
            #
            #         for coordinacion in persona.mis_coordinaciones():
            #             for nivel in persona.mis_niveles(coordinacion, periodo):
            #                 materias = nivel.materia_set.filter(asignaturamalla__practicas=True).order_by('asignatura__nombre', 'inicio', 'identificacion', 'id')
            #                 for materia in materias:
            #                     profesoresmateria = materia.profesores_materia().filter(tipoprofesor=2)
            #                     for profesormateria in profesoresmateria:
            #                         if profesormateria.horario_profesor_materia():
            #                             ws.write(row_num, 0, profesormateria.profesor, font_style2)
            #                             ws.write(row_num, 1, profesormateria.materia, font_style2)
            #                             ws.write(row_num, 1, profesormateria.materia, font_style2)
            #                             ws.write(row_num, 2, profesormateria.materia.nivel, font_style2)
            #                             ws.write(row_num, 3, profesormateria.materia, font_style2)
            #                             ws.write(row_num, 4, profesormateria, font_style2)
            #                             row_num += 1
            #         wb.save(response)
            #         return response
            #     except Exception as ex:
            #         pass

            elif action == 'reporteaula':
                try:
                    periodo = Periodo.objects.get(status=True, pk=int(request.GET['periodo']))

                    notifi = Notificacion(cuerpo='Generación de reporte de excel en progreso',
                                        titulo='Reporte de horarios y aulas', destinatario=persona,
                                        url='',
                                        prioridad=1, app_label='SGA',
                                        fecha_hora_visible=datetime.now() + timedelta(days=1), tipo=2,
                                        en_proceso=True)
                    notifi.save(request)
                    reporte_horarios_y_aulas_background(request=request, notiid=notifi.id, periodo=periodo).start()
                    return JsonResponse({"result": True,
                                         "mensaje": u"El reporte de horarios y aulas se está realizando. Verifique su apartado de notificaciones después de unos minutos.",
                                         "btn_notificaciones": traerNotificaciones(request, data, persona)})
                except Exception as ex:
                    print('Error on line {}'.format(sys.exc_info()[-1].tb_lineno))
                    pass

            elif action == 'reporteaulayactividad':
                try:
                    periodo = request.GET['periodo']
                    __author__ = 'Unemi'
                    style0 = easyxf('font: name Times New Roman, color-index blue, bold off', num_format_str='#,##0.00')
                    style_nb = easyxf('font: name Times New Roman, color-index blue, bold on',
                                      num_format_str='#,##0.00')
                    style_sb = easyxf('font: name Times New Roman, color-index blue, bold on')
                    title = easyxf(
                        'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    style1 = easyxf(num_format_str='D-MMM-YY')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('exp_xls_post_part')
                    ws.write_merge(0, 0, 0, 12, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                    response = HttpResponse(content_type="application/ms-excel")
                    response[
                        'Content-Disposition'] = 'attachment; filename=exp_xls_post_part_' + random.randint(
                        1, 10000).__str__() + '.xls'
                    columns = [
                        (u"TIPO", 3000),
                        (u"AULA", 6000),
                        (u"CAPACIDAD AULA", 6000),
                        (u"CUPO MATRICULA", 6000),
                        (u"MATRICULADOS", 6000),
                        (u"DÍAS", 6000),
                        (u"INICIO HORARIO", 6000),
                        (u"FIN HORARIO", 6000),
                        (u"HORARIOS", 6000),
                        (u"ASIGNATURA/ACTIVIDAD", 6000),
                        (u"TEORICA PRACTICA", 6000),
                        (u"JORNADA", 6000),
                        (u"NIVEL", 6000),
                        (u"PARALELO", 6000),
                        (u"CARRERA", 6000),
                        (u"DOCENTE", 6000),
                        (u"PRINCIPAL", 6000),
                        (u"FACULTAD", 6000),
                        # (u"TIPO MATERIA", 6000),
                        (u"ID HORARIO", 4000),
                        (u"INICIO MATERIA", 4000),
                        (u"FIN MATERIA", 4000),
                        # (u"ID MATERIA", 4000),
                        (u"ESTADO SOLICITUD ACTIVIDAD", 6000)

                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], font_style)
                        ws.col(col_num).width = columns[col_num][1]
                    cursor = connections['sga_select'].cursor()
                    # lista_json = []
                    # data = {}
                    sql = "select 'Materias', al.nombre as Aula, al.capacidad as capacidad_aula, mat.cupo as cupo_matriculas," \
                          " (select count(*) from sga_materiaasignada mas1, sga_matricula mat1, sga_nivel ni1 where mat1.estado_matricula in (2,3) and mas1.matricula_id=mat1.id and mat1.nivel_id=ni1.id and ni1.periodo_id=ni.periodo_id and mas1.materia_id=mat.id) as Matriculados," \
                          " (case cl.dia  when 1 then 'LUNES' when 2 then 'MARTES' when 3 then 'MIERCOLES' when 4 then 'JUEVES' when 5 then 'VIERNES' when 6 then 'SABADO' when 7 then 'DOMINGO'  end) as dia ," \
                          " cl.inicio , cl.fin , (tu.comienza|| '  ' || tu.termina) as Horario, asi.nombre as Asignatura , ni.paralelo as jornada , nmall.nombre as nivel , ca.nombre as Carrera, mat.paralelo as paralelo , per.apellido1 ||' '|| per.apellido2 ||' '|| per.nombres as docente," \
                          " (case pm.principal when true then 'SI' else 'NO' end) as principal, cor.nombre as facultad, (case asimall.practicas when true then 'SI' else 'NO' end) as tipomateria, cl.id as Id, mat.inicio as Inicio_materia, mat.fin as Fin_materia, mat.id as id_materia, null " \
                          " from sga_clase cl, sga_aula al, sga_materia mat, sga_nivel ni, sga_asignatura asi ,sga_asignaturamalla asimall, sga_nivelmalla nmall, sga_malla mall , sga_carrera ca ,  sga_turno tu , sga_profesormateria pm," \
                          " sga_profesor pr, sga_persona per, sga_coordinacion_carrera cc, sga_coordinacion cor " \
                          " where cl.aula_id=al.id and cl.materia_id=mat.id and mat.nivel_id=ni.id and mat.asignatura_id=asi.id and cl.activo=true and  mat.asignaturamalla_id = asimall.id and" \
                          " pm.materia_id=mat.id and pr.id=pm.profesor_id and per.id=pr.persona_id and asimall.nivelmalla_id = nmall.id and asimall.malla_id = mall.id and tu.id=cl.turno_id and  mall.carrera_id=ca.id" \
                          " and cc.carrera_id=ca.id  and cor.id=cc.coordinacion_id and ni.periodo_id='" + periodo + "'" \
                                                                                                                    "union " \
                                                                                                                    "select 'Docencia', null as Aula, null as capacidad_aula, null as cupo_matriculas, null as Matriculados,  " \
                                                                                                                    "(case actividad.dia  when 1 then 'LUNES' when 2 then 'MARTES' when 3 then 'MIERCOLES' when 4 then 'JUEVES' when 5 then 'VIERNES' when 6 then 'SABADO' when 7 then 'DOMINGO'  end) as dia ,  " \
                                                                                                                    "actividad.inicio, actividad.fin, (tur.comienza|| '  ' || tur.termina) as Horario,  " \
                                                                                                                    "critdoc.nombre as Asignatura, null as jornada, null as nivel, null as Carrera,  " \
                                                                                                                    "null as paralelo , per.apellido1 ||' '|| per.apellido2 ||' '|| per.nombres as docente, null as principal, null as facultad,  " \
                                                                                                                    "null as tipomateria, null as Id, null as Inicio_materia, null as Fin_materia, null as id_materia, (case actividad.estadosolicitud  when 1 then 'SOLICITADO' when 2 then 'APROBADO' when 3 then 'RECHAZADO'  end) as estadosolicitud  " \
                                                                                                                    "from 	sga_claseactividad actividad  " \
                                                                                                                    "inner join sga_detalledistributivo dist on actividad.detalledistributivo_id = dist.id " \
                                                                                                                    "inner join sga_criteriodocenciaperiodo critdocper on dist.criteriodocenciaperiodo_id = critdocper.id " \
                                                                                                                    "inner join sga_criteriodocencia critdoc on critdocper.criterio_id = critdoc.id " \
                                                                                                                    "inner join sga_profesordistributivohoras pdh on dist.distributivo_id = pdh.id " \
                                                                                                                    "inner join sga_profesor pf on pdh.profesor_id = pf.id  " \
                                                                                                                    "inner join sga_persona per on pf.persona_id = per.id " \
                                                                                                                    "inner join sga_turno tur on actividad.turno_id = tur.id  " \
                                                                                                                    "where pdh.periodo_id = '" + periodo + "' and actividad.status=True and actividad.activo=True	and dist.criteriogestionperiodo_id is null and dist.criterioinvestigacionperiodo_id is null " \
                                                                                                                                                           "union " \
                                                                                                                                                           "select 'Gestion', null as Aula, 	null as capacidad_aula, null as cupo_matriculas, null as Matriculados,  " \
                                                                                                                                                           "(case actividad.dia  when 1 then 'LUNES' when 2 then 'MARTES' when 3 then 'MIERCOLES' when 4 then 'JUEVES' when 5 then 'VIERNES' when 6 then 'SABADO' when 7 then 'DOMINGO'  end) as dia ,  " \
                                                                                                                                                           "actividad.inicio, actividad.fin, (tur.comienza|| '  ' || tur.termina) as Horario, critdoc.nombre as Asignatura ,  " \
                                                                                                                                                           "null as jornada , null as nivel , null as Carrera, null as paralelo ,  " \
                                                                                                                                                           "per.apellido1 ||' '|| per.apellido2 ||' '|| per.nombres as docente, null as principal, null as facultad,  " \
                                                                                                                                                           "null as tipomateria, null as Id, 	null as Inicio_materia, 	null as Fin_materia, null as id_materia, (case actividad.estadosolicitud  when 1 then 'SOLICITADO' when 2 then 'APROBADO' when 3 then 'RECHAZADO'  end) as estadosolicitud    " \
                                                                                                                                                           "from 	sga_claseactividad actividad " \
                                                                                                                                                           "inner join sga_detalledistributivo dist on actividad.detalledistributivo_id = dist.id " \
                                                                                                                                                           "inner join sga_criteriogestionperiodo critdocper on dist.criteriogestionperiodo_id = critdocper.id " \
                                                                                                                                                           "inner join sga_criteriogestion critdoc on critdocper.criterio_id = critdoc.id " \
                                                                                                                                                           "inner join sga_profesordistributivohoras pdh on dist.distributivo_id = pdh.id " \
                                                                                                                                                           "inner join sga_profesor pf on pdh.profesor_id = pf.id  " \
                                                                                                                                                           "inner join sga_persona per on pf.persona_id = per.id " \
                                                                                                                                                           "inner join sga_turno tur on actividad.turno_id = tur.id  " \
                                                                                                                                                           "where pdh.periodo_id = '" + periodo + "' and actividad.status=True and actividad.activo=True	and dist.criteriodocenciaperiodo_id is null and dist.criterioinvestigacionperiodo_id is null " \
                                                                                                                                                                                                  "union " \
                                                                                                                                                                                                  "select 'Investigación', null as Aula, 	null as capacidad_aula, 	null as cupo_matriculas,  null as Matriculados,  " \
                                                                                                                                                                                                  "(case actividad.dia  when 1 then 'LUNES' when 2 then 'MARTES' when 3 then 'MIERCOLES' when 4 then 'JUEVES' when 5 then 'VIERNES' when 6 then 'SABADO' when 7 then 'DOMINGO'  end) as dia ,  " \
                                                                                                                                                                                                  "actividad.inicio , 	actividad.fin , 	(tur.comienza|| '  ' || tur.termina) as Horario, critdoc.nombre as Asignatura ,  " \
                                                                                                                                                                                                  "null as jornada , null as nivel , null as Carrera, null as paralelo ,  " \
                                                                                                                                                                                                  "per.apellido1 ||' '|| per.apellido2 ||' '|| per.nombres as docente,  null as principal, null as facultad, 	null as tipomateria, 	null as Id, 	null as Inicio_materia, 	null as Fin_materia,	null as id_materia , (case actividad.estadosolicitud  when 1 then 'SOLICITADO' when 2 then 'APROBADO' when 3 then 'RECHAZADO'  end) as estadosolicitud   " \
                                                                                                                                                                                                  "from	sga_claseactividad actividad " \
                                                                                                                                                                                                  "inner join sga_detalledistributivo dist on actividad.detalledistributivo_id = dist.id " \
                                                                                                                                                                                                  "inner join sga_criterioinvestigacionperiodo critdocper on dist.criterioinvestigacionperiodo_id = critdocper.id " \
                                                                                                                                                                                                  "inner join sga_criterioinvestigacion critdoc on critdocper.criterio_id = critdoc.id " \
                                                                                                                                                                                                  "inner join sga_profesordistributivohoras pdh on dist.distributivo_id = pdh.id " \
                                                                                                                                                                                                  "inner join sga_profesor pf on pdh.profesor_id = pf.id  " \
                                                                                                                                                                                                  "inner join sga_persona per on pf.persona_id = per.id " \
                                                                                                                                                                                                  "inner join sga_turno tur on actividad.turno_id = tur.id  " \
                                                                                                                                                                                                  "where pdh.periodo_id = '" + periodo + "' and actividad.status=True and actividad.activo=True	and dist.criteriodocenciaperiodo_id is null and dist.criteriogestionperiodo_id is null "
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    row_num = 4
                    for r in results:
                        i = 0
                        campo1 = r[1]
                        campo2 = r[2]
                        campo3 = r[3]
                        campo4 = r[4]
                        campo5 = r[5]
                        campo6 = r[6]
                        campo7 = r[7]
                        campo8 = r[8]
                        campo9 = r[9]
                        campo10 = r[10]
                        campo11 = r[11]
                        campo12 = r[13]
                        campo13 = r[12]
                        campo14 = r[14]
                        campo15 = r[15]
                        campo16 = r[16]
                        campo17 = r[17]
                        campo18 = r[18]
                        campo19 = r[19]
                        campo20 = r[20]
                        campo21 = r[0]
                        campo22 = r[22]

                        ws.write(row_num, 0, campo21, font_style2)
                        ws.write(row_num, 1, campo1, font_style2)
                        ws.write(row_num, 2, campo2, font_style2)
                        ws.write(row_num, 3, campo3, font_style2)
                        ws.write(row_num, 4, campo4, font_style2)
                        ws.write(row_num, 5, campo5, font_style2)
                        ws.write(row_num, 6, campo6, style1)
                        ws.write(row_num, 7, campo7, style1)
                        ws.write(row_num, 8, campo8, font_style2)
                        ws.write(row_num, 9, campo9, font_style2)
                        ws.write(row_num, 10, campo17, font_style2)
                        ws.write(row_num, 11, campo10, font_style2)
                        ws.write(row_num, 12, campo11, font_style2)
                        ws.write(row_num, 13, campo12, font_style2)
                        ws.write(row_num, 14, campo13, font_style2)
                        ws.write(row_num, 15, campo14, font_style2)
                        ws.write(row_num, 16, campo15, font_style2)
                        ws.write(row_num, 17, campo16, font_style2)
                        ws.write(row_num, 18, campo18, font_style2)
                        ws.write(row_num, 19, campo19, style1)
                        ws.write(row_num, 20, campo20, style1)
                        ws.write(row_num, 21, campo22, font_style2)
                        row_num += 1
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'reportealumnos':
                try:
                    noti = Notificacion(cuerpo='Generación de reporte de excel en progreso',
                                        titulo='Reporte de asignaturas y estudiantes',
                                        destinatario=persona, url='', prioridad=1, app_label='SGA',
                                        fecha_hora_visible=datetime.now() + timedelta(days=1), tipo=2, en_proceso=True)
                    noti.save(request)

                    reporte_reportealumnos_background(request=request, data=data, notiid=noti.pk, periodo=periodo).start()

                    return JsonResponse({"result": True,
                                         "mensaje": u"El reporte se está realizando. Verifique su apartado de notificaciones después de unos minutos.",
                                         "btn_notificaciones": traerNotificaciones(request, data, persona)})
                except Exception as ex:
                    print('Error on line {}'.format(sys.exc_info()[-1].tb_lineno))
                    pass

            elif action == 'reportealumnosporcarreras':
                try:
                    __author__ = 'Unemi'
                    periodo = request.GET['periodo']
                    output = io.BytesIO()
                    workbook = xlsxwriter.Workbook(output, {'constant_memory': True})
                    ws = workbook.add_worksheet('exp_xls_post_part')
                    ws.set_column(0, 37, 30)
                    formatoceldaleft = workbook.add_format({'text_wrap': True, 'align': 'left'})
                    decimalformat = workbook.add_format({'num_format': '#,##0.00'})
                    ws.write('A1', 'FACULTAD')
                    ws.write('B1', 'CARRERA')
                    ws.write('C1', 'SECCION')
                    ws.write('D1', 'NIVEL')
                    ws.write('E1', 'ASIGNATURA')
                    ws.write('F1', 'CEDULA ALUMN.')
                    ws.write('G1', 'ALUMNO')
                    ws.write('H1', 'SEXO')
                    ws.write('I1', 'LGTBI')
                    ws.write('J1', 'GRUPO SOCIOECONOMICO')
                    ws.write('K1', 'ESTADO CIVIL')
                    ws.write('L1', 'ETNIA')
                    ws.write('M1', 'DISCAPACIDAD')
                    ws.write('N1', 'PORCENTAJE')
                    ws.write('O1', 'CARNET')
                    ws.write('P1', 'VERIFICADO')
                    ws.write('Q1', 'BECA')
                    ws.write('R1', 'NOTA FINAL')
                    ws.write('S1', 'ASISTENCIA')
                    ws.write('T1', 'ESTADO')
                    ws.write('U1', 'CEDULA DOC.')
                    ws.write('V1', 'DOCENTE')
                    ws.write('W1', 'SEXO')
                    ws.write('X1', 'TIPO DOCENTE')
                    ws.write('Y1', 'DEDICACION DOCENTE')
                    ws.write('Z1', 'TELEFONO')
                    ws.write('AA1', 'EMAIL')
                    ws.write('AB1', 'EMAIL INST')
                    ws.write('AC1', 'CIUDAD')
                    ws.write('AD1', 'DIRECCION')
                    ws.write('AE1', 'PARALELO')
                    ws.write('AF1', 'VECES DE MATRICULA')
                    ws.write('AG1', 'CREDITOS')
                    ws.write('AH1', 'TIPO MATRICULA')
                    ws.write('AI1', 'GRATUIDAD')
                    ws.write('AJ1', 'CARRERA DE LA ASIGNATURA')
                    ws.write('AK1', 'CODIGO MATERIA')

                    coordinaciones_ = tuple(persona.mis_coordinaciones().values_list('id', flat=True))
                    cursor = connections['sga_select'].cursor()
                    sql = "SELECT DISTINCT " \
                          "   sga_coordinacion.nombre as sga_coordinacion_nombre, " \
                          "   sga_carrera.nombre AS sga_carrera_nombre, " \
                          "   sga_sesion.nombre AS sga_sesion_nombre, " \
                          "   sga_nivelmalla.nombre as sga_nivelmalla_nombre, " \
                          "   sga_asignatura.nombre as sga_asignatura_nombre, " \
                          "   sga_persona.apellido1 || ' ' || sga_persona.apellido2  || ' ' ||  sga_persona.nombres AS sga_persona_nombres, " \
                          "   sga_materiaasignada.notafinal as notafinal, " \
                          "   sga_materiaasignada.asistenciafinal as asistenciafinal, " \
                          "   (select p.apellido1 || ' ' || p.apellido2 || ' ' || p.nombres from sga_persona p where p.id=sga_profesor.persona_id) as docente, " \
                          "   sga_tipoestado.nombre as estado, " \
                          "   sga_nivelmalla.id as sga_nivelmalla_id," \
                          "   sga_persona.telefono, sga_persona.email, sga_persona.emailinst, sga_persona.ciudad, " \
                          "   sga_persona.direccion || ', ' || sga_persona.direccion2 || ' #:' || sga_persona.num_direccion || ' , SECTOR:' || sga_persona.sector as direccion, sga_materia.paralelo, sga_materiaasignada.matriculas, sga_asignaturamalla.creditos," \
                          "   (select p.cedula from sga_persona p where p.id=sga_profesor.persona_id) as cedula, " \
                          "   (select s.nombre from sga_persona p INNER JOIN sga_sexo s on s.id=p.sexo_id where p.id=sga_profesor.persona_id) as sexo, " \
                          "   (select tp.nombre from sga_tipoprofesor tp where tp.id=sga_profesormateria.tipoprofesor_id) as tipoprofesor, " \
                          "   (select de.nombre from sga_tiempodedicaciondocente de where de.id=sga_profesor.dedicacion_id) as dedicacion, " \
                          "   sga_persona.cedula, (select s.nombre from sga_sexo s where s.id=sga_persona.sexo_id ) as sexoalu , sga_persona.lgtbi, " \
                          "   (select gr.nombre from socioecon_fichasocioeconomicainec f inner join socioecon_gruposocioeconomico gr on gr.id=f.grupoeconomico_id where persona_id=sga_persona.id) as socioeco, " \
                          "   (select r.nombre from sga_perfilinscripcion pa inner join sga_raza r on r.id=pa.raza_id where persona_id=sga_persona.id) as etnia, " \
                          "   (select d.nombre from sga_perfilinscripcion pa inner join sga_discapacidad d on d.id=pa.tipodiscapacidad_id where persona_id=sga_persona.id) as discapacidad, " \
                          "   (select pe.porcientodiscapacidad from sga_perfilinscripcion pe where persona_id=sga_persona.id) as porcentaje, " \
                          "   (select pe.carnetdiscapacidad from sga_perfilinscripcion pe where persona_id=sga_persona.id) as carnetdiscapacidad, " \
                          "   (select pe.verificadiscapacidad from sga_perfilinscripcion pe where persona_id=sga_persona.id) as verificadiscapacidad, " \
                          "   (select be.id from sga_inscripcionbecario be where be.inscripcion_id=sga_inscripcion.id) as tienebeca, " \
                          "   (select pe.nombre from med_personaextension es inner join sga_personaestadocivil pe on pe.id=es.estadocivil_id where es.persona_id=sga_persona.id) as estadocivil, " \
                          " (case gru.tipomatricula when 1 then 'REGULAR'  when 2 then 'IREGULAR' else '' end) as tipomatricula, " \
                          " (case gru.estado_gratuidad when 1 then 'GRATUIDAD COMPLETA'  when 2 then 'GRATUIDAD PARCIAL' when 3 then 'PERDIDA DE GRATUIDAD' else '' end) as estado_gratuidad," \
                          "   (select carr.nombre from sga_asignaturamalla asig inner join sga_malla mall on mall.id=asig.malla_id inner join sga_carrera carr on carr.id=mall.carrera_id where asig.id=sga_asignaturamalla.id) as Carrera_de_la_asignatura," \
                          "sga_materia.id as id " \
                          " FROM sga_persona sga_persona " \
                          "      RIGHT OUTER JOIN sga_inscripcion sga_inscripcion ON sga_persona.id = sga_inscripcion.persona_id " \
                          "     INNER JOIN sga_matricula sga_matricula ON sga_matricula.inscripcion_id=sga_inscripcion.id " \
                          " left JOIN sga_matriculagruposocioeconomico gru ON gru.matricula_id=sga_matricula.id " \
                          "    inner join sga_materiaasignada sga_materiaasignada on sga_materiaasignada.matricula_id=sga_matricula.id " \
                          "     inner join sga_materia sga_materia on sga_materia.id=sga_materiaasignada.materia_id " \
                          "     LEFT join sga_profesormateria on sga_profesormateria.materia_id=sga_materia.id " \
                          "     LEFT join sga_profesor on sga_profesor.id=sga_profesormateria.profesor_id " \
                          "     inner join sga_asignatura sga_asignatura on sga_asignatura.id=sga_materia.asignatura_id " \
                          "      inner join sga_asignaturamalla sga_asignaturamalla on sga_asignaturamalla.id=sga_materia.asignaturamalla_id " \
                          "    inner join sga_nivel sga_nivel ON sga_nivel.id=sga_matricula.nivel_id and sga_nivel.periodo_id= '" + periodo + "' " \
                                                                                                                                              "      inner join sga_nivelmalla sga_nivelmalla on sga_nivelmalla.id=sga_asignaturamalla.nivelmalla_id " \
                                                                                                                                              "     INNER JOIN sga_carrera sga_carrera ON sga_inscripcion.carrera_id = sga_carrera.id " \
                                                                                                                                              "     INNER JOIN sga_coordinacion_carrera on sga_coordinacion_carrera.carrera_id=sga_carrera.id " \
                                                                                                                                              "     INNER JOIN sga_coordinacion on sga_coordinacion.id=sga_coordinacion_carrera.coordinacion_id " \
                                                                                                                                              "     INNER JOIN sga_modalidad sga_modalidad ON sga_inscripcion.modalidad_id = sga_modalidad.id " \
                                                                                                                                              "     INNER JOIN sga_sesion sga_sesion ON sga_inscripcion.sesion_id = sga_sesion.id " \
                                                                                                                                              "     inner join sga_tipoestado on sga_tipoestado.id=sga_materiaasignada.estado_id " \
                                                                                                                                              "    where sga_matricula.estado_matricula in (2,3) and sga_matricula.id not in (select ret.matricula_id from sga_retiromatricula ret) and sga_profesormateria.activo=True and sga_profesormateria.id = (select pm.id from sga_profesormateria pm inner join sga_profesor profe on pm.profesor_id=profe.id inner join sga_persona p on p.id=profe.persona_id  where pm.materia_id=sga_materiaasignada.materia_id and pm.status=True and pm.activo=True AND sga_coordinacion.id IN " + str(coordinaciones_) + " and (pm.tipoprofesor_id=1 or pm.tipoprofesor_id=3) order by pm.tipoprofesor_id LIMIT 1) order by sga_carrera.nombre,sga_nivelmalla.id,sga_sesion.nombre,sga_persona_nombres "
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    row_num = 1
                    for r in results:
                        i = 0
                        campo1 = u"%s" % r[0]
                        campo2 = u"%s" % r[1]
                        campo3 = u"%s" % r[2]
                        campo4 = u"%s" % r[3]
                        campo5 = u"%s" % r[4]
                        campo6 = u"%s" % r[5]
                        campo7 = float(r[6])
                        campo8 = int(r[7])
                        campo9 = u"%s" % r[8]
                        campo10 = u"%s" % r[9]
                        campo33 = u"%s" % r[33]
                        campo11 = u"%s" % r[11]
                        campo12 = u"%s" % r[12]
                        campo13 = u"%s" % r[13]
                        campo14 = u"%s" % r[14]
                        campo15 = u"%s" % r[15]
                        campo16 = u"%s" % r[16]
                        campo17 = int(r[17])
                        campo18 = float(r[18])
                        campo19 = u"%s" % r[19]
                        campo20 = u"%s" % r[20]
                        campo21 = u"%s" % r[21]
                        campo22 = u"%s" % r[22]
                        campo23 = u"%s" % r[23]
                        campo24 = u"%s" % r[24]
                        campo25 = "SI" if r[25] else "NO"
                        campo26 = u"%s" % r[26]
                        campo27 = u"%s" % r[27]
                        campo28 = u"%s" % r[28] if r[28] else "NINGUNA"
                        campo29 = float(r[29])
                        campo30 = u"%s" % r[30]
                        campo31 = "SI" if r[31] else "NO"
                        campo32 = "SI" if r[31] else "NO"
                        campo34 = u"%s" % r[34]
                        campo35 = u"%s" % r[35]
                        campo36 = u"%s" % r[36]
                        campo37 = int(r[37])
                        ws.write(row_num, 0, str(campo1), formatoceldaleft)
                        ws.write(row_num, 1, str(campo2), formatoceldaleft)
                        ws.write(row_num, 2, str(campo3), formatoceldaleft)
                        ws.write(row_num, 3, str(campo4), formatoceldaleft)
                        ws.write(row_num, 4, str(campo5), formatoceldaleft)
                        ws.write(row_num, 5, str(campo23), formatoceldaleft)
                        ws.write(row_num, 6, str(campo6), formatoceldaleft)
                        ws.write(row_num, 7, str(campo24), formatoceldaleft)
                        ws.write(row_num, 8, str(campo25), formatoceldaleft)
                        ws.write(row_num, 9, str(campo26), formatoceldaleft)
                        ws.write(row_num, 10, str(campo33), formatoceldaleft)
                        ws.write(row_num, 11, str(campo27), formatoceldaleft)
                        ws.write(row_num, 12, str(campo28), formatoceldaleft)
                        ws.write(row_num, 13, campo29, decimalformat)
                        ws.write(row_num, 14, str(campo30), formatoceldaleft)
                        ws.write(row_num, 15, str(campo31), formatoceldaleft)
                        ws.write(row_num, 16, str(campo32), formatoceldaleft)
                        ws.write(row_num, 17, campo7, decimalformat)
                        ws.write(row_num, 18, campo8)
                        ws.write(row_num, 19, str(campo10), formatoceldaleft)
                        ws.write(row_num, 20, str(campo19), formatoceldaleft)
                        ws.write(row_num, 21, str(campo9), formatoceldaleft)
                        ws.write(row_num, 22, str(campo20), formatoceldaleft)
                        ws.write(row_num, 23, str(campo21), formatoceldaleft)
                        ws.write(row_num, 24, str(campo22), formatoceldaleft)
                        ws.write(row_num, 25, str(campo11), formatoceldaleft)
                        ws.write(row_num, 26, str(campo12), formatoceldaleft)
                        ws.write(row_num, 27, str(campo13), formatoceldaleft)
                        ws.write(row_num, 28, str(campo14), formatoceldaleft)
                        ws.write(row_num, 29, str(campo15), formatoceldaleft)
                        ws.write(row_num, 30, str(campo16), formatoceldaleft)
                        ws.write(row_num, 31, campo17)
                        ws.write(row_num, 32, campo18, decimalformat)
                        ws.write(row_num, 33, str(campo34), formatoceldaleft)
                        ws.write(row_num, 34, str(campo35), formatoceldaleft)
                        ws.write(row_num, 35, str(campo36), formatoceldaleft)
                        ws.write(row_num, 36, campo37)
                        row_num += 1
                    workbook.close()
                    output.seek(0)
                    # filename = 'reporte_asignaturas_estudiantes.xlsx'
                    response = HttpResponse(output, content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
                    response['Content-Disposition'] = 'attachment; filename=reporte_asignaturas_estudiantes' + random.randint(
                        1, 10000).__str__() + '.xlsx'

                    return response
                except Exception as ex:
                    print('Error on line {}'.format(sys.exc_info()[-1].tb_lineno))
                    pass

            elif action == 'reportealumnosenfoctavo':
                try:
                    __author__ = 'Unemi'
                    periodo = request.GET['periodo']
                    output = io.BytesIO()
                    workbook = xlsxwriter.Workbook(output, {'constant_memory': True})
                    ws = workbook.add_worksheet('exp_xls_post_part')
                    ws.set_column(0, 37, 30)
                    formatoceldaleft = workbook.add_format({'text_wrap': True, 'align': 'left'})
                    decimalformat = workbook.add_format({'num_format': '#,##0.00'})
                    ws.write('A1', 'CODIGO_IES')
                    ws.write('B1', 'NOMBRE_IES')
                    ws.write('C1', 'CODIGO_CARRERA')
                    ws.write('D1', 'TIPO_IDENTIFICACION')
                    ws.write('E1', 'IDENTIFICACION')
                    ws.write('F1', 'SEXO')
                    ws.write('G1', 'PRIMER_APELLIDO')
                    ws.write('H1', 'SEGUNDO_APELLIDO')
                    ws.write('I1', 'NOMBRES')
                    ws.write('J1', 'FECHA_INICIO_PRIMER_NIVEL')
                    ws.write('K1', 'FECHA_INGRESO_CONVALIDACION')
                    ws.write('L1', 'FECHA_GRADUACION')
                    ws.write('M1', 'FECHA_INICIO')
                    ws.write('N1', 'FECHA_FIN')
                    ws.write('O1', 'TOTAL_CREDITOS_SIN_TITULACION')
                    ws.write('P1', 'NUMERO_CREDITOS_APROBADOS')

                    cursor = connections['sga_select'].cursor()
                    sql = """SELECT  insti.codigo, insti.nombre , ca.codigo AS codigo_carrera ,'cedula' AS tipo_identificacion, perso.cedula AS identifiacion,
                            (SELECT se.nombre
                            FROM sga_sexo se
                            WHERE se.id=perso.sexo_id AND se.status= TRUE) AS sexo,  perso.apellido1 AS primer_apellido, perso.apellido2 AS segundo_apellido, perso.nombres AS nombres,
                            ins.fechainicioprimernivel AS fecha_inicio_primer_nivel, ins.fechainicioconvalidacion AS fecha_ingreso_convalidacion,
                            (SELECT grad.fechagraduado FROM  sga_graduado grad
                            WHERE grad.inscripcion_id=ins.id) AS fecha_graduacion, 
                            '' AS fecha_inicio, '' AS fecha_fin,
                            '' AS total_creditos_sin_titulacion, 
                             (SELECT round(SUM(recordac.creditos),2)
                            FROM sga_recordacademico recordac
                            WHERE (recordac.inscripcion_id=ins.id AND recordac.status AND recordac.valida=True)) AS numero_creditos_aprobados,
                            ins.id AS idinscripcion
                            FROM sga_matricula matri, sga_nivel ni,sga_inscripcion ins, sga_persona perso,sga_periodo peri,sga_nivelmalla nimalla,sga_sesion sesion, sga_modalidad modal,
                            sga_institucioneducacionsuperior insti, sga_carrera ca
                            WHERE matri.nivel_id=ni.id AND ni.periodo_id=peri.id AND matri.nivelmalla_id=nimalla.id AND insti.id=1024
                            AND matri.inscripcion_id=ins.id AND ins.persona_id=perso.id AND ins.sesion_id=sesion.id 
                            AND ins.modalidad_id=modal.id AND ins.status= TRUE AND ni.periodo_id='%s' 
                            AND matri.status= TRUE AND ni.status= TRUE AND matri.retiradomatricula= FALSE 
                            AND ins.coordinacion_id =1 AND matri.nivelmalla_id=8 AND ins.carrera_id=1 AND ins.carrera_id=ca.id 
                            union all
                            SELECT  insti.codigo, insti.nombre , ca.codigo AS codigo_carrera ,'cedula' AS tipo_identificacion, perso.cedula AS identifiacion,
                            (SELECT se.nombre
                            FROM sga_sexo se
                            WHERE se.id=perso.sexo_id AND se.status= TRUE) AS sexo,  perso.apellido1 AS primer_apellido, perso.apellido2 AS segundo_apellido, perso.nombres AS nombres,
                            ins.fechainicioprimernivel AS fecha_inicio_primer_nivel, ins.fechainicioconvalidacion AS fecha_ingreso_convalidacion,
                            (SELECT grad.fechagraduado FROM  sga_graduado grad
                            WHERE grad.inscripcion_id=ins.id) AS fecha_graduacion, 
                            '' AS fecha_inicio, '' AS fecha_fin,
                            '' AS total_creditos_sin_titulacion, 
                             (SELECT round(SUM(recordac.creditos),2)
                            FROM sga_recordacademico recordac
                            WHERE (recordac.inscripcion_id=ins.id AND recordac.status AND recordac.valida=True)) AS numero_creditos_aprobados,
                            ins.id AS idinscripcion
                            FROM sga_matricula matri, sga_nivel ni,sga_inscripcion ins, sga_persona perso,sga_periodo peri,sga_nivelmalla nimalla,sga_sesion sesion, sga_modalidad modal,
                            sga_institucioneducacionsuperior insti, sga_carrera ca
                            WHERE matri.nivel_id=ni.id AND ni.periodo_id=peri.id AND matri.nivelmalla_id=nimalla.id AND insti.id=1024
                            AND matri.inscripcion_id=ins.id AND ins.persona_id=perso.id AND ins.sesion_id=sesion.id 
                            AND ins.modalidad_id=modal.id AND ins.status= TRUE AND ni.periodo_id='%s' 
                            AND matri.status= TRUE AND ni.status= TRUE AND matri.retiradomatricula= FALSE 
                            AND ins.coordinacion_id =1 AND matri.nivelmalla_id=9 AND ins.carrera_id=110 AND ins.carrera_id=ca.id ORDER BY 7,8""" % (periodo, periodo)
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    row_num = 1
                    for r in results:
                        i = 0
                        campo1 = u"%s" % r[0]
                        campo2 = u"%s" % r[1]
                        campo3 = u"%s" % r[2]
                        campo4 = u"%s" % r[3]
                        campo5 = u"%s" % r[4]
                        campo6 = u"%s" % r[5]
                        campo7 = u"%s" % r[6]
                        campo8 = u"%s" % r[7]
                        campo9 = u"%s" % r[8]
                        campo10 = u"%s" % r[9]
                        campo11 = u"%s" % r[10]
                        campo12 = u"%s" % r[11]
                        campo13 = u"%s" % r[12]
                        campo14 = u"%s" % r[13]
                        # campo15 = u"%s" % r[14]
                        campo16 = u"%s" % r[15]
                        inscripcion = Inscripcion.objects.get(pk=r[16])
                        campo15 = inscripcion.total_creditos_malla()
                        ws.write(row_num, 0, str(campo1), formatoceldaleft)
                        ws.write(row_num, 1, str(campo2), formatoceldaleft)
                        ws.write(row_num, 2, str(campo3), formatoceldaleft)
                        ws.write(row_num, 3, str(campo4), formatoceldaleft)
                        ws.write(row_num, 4, str(campo5), formatoceldaleft)
                        ws.write(row_num, 5, str(campo6), formatoceldaleft)
                        ws.write(row_num, 6, str(campo7), formatoceldaleft)
                        ws.write(row_num, 7, str(campo8), formatoceldaleft)
                        ws.write(row_num, 8, str(campo9), formatoceldaleft)
                        ws.write(row_num, 9, str(campo10), formatoceldaleft)
                        ws.write(row_num, 10, str(campo11), formatoceldaleft)
                        ws.write(row_num, 11, str(campo12), formatoceldaleft)
                        ws.write(row_num, 12, str(campo13), formatoceldaleft)
                        ws.write(row_num, 13, str(campo14), formatoceldaleft)
                        ws.write(row_num, 14, '', formatoceldaleft)
                        ws.write(row_num, 15, str(campo15), formatoceldaleft)
                        row_num += 1
                    workbook.close()
                    output.seek(0)
                    # filename = 'reporte_asignaturas_estudiantes.xlsx'
                    response = HttpResponse(output, content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
                    response['Content-Disposition'] = 'attachment; filename=reporte_aptos_EHEP' + random.randint(
                        1, 10000).__str__() + '.xlsx'

                    return response
                except Exception as ex:
                    print('Error on line {}'.format(sys.exc_info()[-1].tb_lineno))
                    pass


            # elif action == 'reportealumnos':
            #     try:
            #         periodo = request.GET['periodo']
            #         __author__ = 'Unemi'
            #         title = easyxf(
            #             'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
            #
            #         wb = Workbook(encoding='utf-8')
            #         ws = wb.add_sheet('exp_xls_post_part')
            #         ws.write_merge(0, 0, 0, 7, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
            #         response = HttpResponse(content_type="application/ms-excel")
            #         response[
            #             'Content-Disposition'] = 'attachment; filename=reporte_asignaturas_estudiantes' + random.randint(
            #             1, 10000).__str__() + '.xls'
            #         columns = [
            #             (u"FACULTAD", 6000),
            #             (u"CARRERA", 6000),
            #             (u"SECCION", 6000),
            #             (u"NIVEL", 6000),
            #             (u"ASIGNATURA", 6000),
            #             (u"CEDULA ALUMN.", 4000),
            #             (u"ALUMNO", 6000),
            #             (u"SEXO", 6000),
            #             (u"LGTBI", 3000),
            #             (u"GRUPO SOCIOECONOMICO", 5000),
            #             (u"ESTADO CIVIL", 5000),
            #             (u"ETNIA", 4000),
            #             (u"DISCAPACIDAD", 4000),
            #             (u"PORCENTAJE", 3000),
            #             (u"CARNET", 3000),
            #             (u"VERIFICADO", 3000),
            #             (u"BECA", 3000),
            #             (u"NOTA FINAL", 6000),
            #             (u"ASISTENCIA", 6000),
            #             (u"ESTADO", 6000),
            #             (u"CEDULA DOC.", 3000),
            #             (u"DOCENTE", 6000),
            #             (u"SEXO", 4000),
            #             (u"TIPO DOCENTE", 4000),
            #             (u"DEDICACION DOCENTE", 4000),
            #             (u"TELEFONO", 6000),
            #             (u"EMAIL", 6000),
            #             (u"EMAIL INST", 6000),
            #             (u"CIUDAD", 6000),
            #             (u"DIRECCION", 12000),
            #             (u"PARALELO", 12000),
            #             (u"VECES DE MATRICULA", 6000),
            #             (u"CREDITOS", 6000),
            #             (u"TIPO MATRICULA", 6000),
            #             (u"GRATUIDAD", 6000),
            #             (u"CARRERA DE LA ASIGNATURA", 6000),
            #             (u"CODIGO MATERIA", 6000),
            #         ]
            #         row_num = 3
            #         for col_num in range(len(columns)):
            #             ws.write(row_num, col_num, columns[col_num][0])
            #             ws.col(col_num).width = columns[col_num][1]
            #
            #
            #         cursor = connections['sga_select'].cursor()
            #         sql = "SELECT DISTINCT " \
            #               "   sga_coordinacion.nombre as sga_coordinacion_nombre, " \
            #               "   sga_carrera.nombre AS sga_carrera_nombre, " \
            #               "   sga_sesion.nombre AS sga_sesion_nombre, " \
            #               "   sga_nivelmalla.nombre as sga_nivelmalla_nombre, " \
            #               "   sga_asignatura.nombre as sga_asignatura_nombre, " \
            #               "   sga_persona.apellido1 || ' ' || sga_persona.apellido2  || ' ' ||  sga_persona.nombres AS sga_persona_nombres, " \
            #               "   sga_materiaasignada.notafinal as notafinal, " \
            #               "   sga_materiaasignada.asistenciafinal as asistenciafinal, " \
            #               "   (select p.apellido1 || ' ' || p.apellido2 || ' ' || p.nombres from sga_persona p where p.id=sga_profesor.persona_id) as docente, " \
            #               "   sga_tipoestado.nombre as estado, " \
            #               "   sga_nivelmalla.id as sga_nivelmalla_id," \
            #               "   sga_persona.telefono, sga_persona.email, sga_persona.emailinst, sga_persona.ciudad, " \
            #               "   sga_persona.direccion || ', ' || sga_persona.direccion2 || ' #:' || sga_persona.num_direccion || ' , SECTOR:' || sga_persona.sector as direccion, sga_materia.paralelo, sga_materiaasignada.matriculas, sga_asignaturamalla.creditos," \
            #               "   (select p.cedula from sga_persona p where p.id=sga_profesor.persona_id) as cedula, " \
            #               "   (select s.nombre from sga_persona p INNER JOIN sga_sexo s on s.id=p.sexo_id where p.id=sga_profesor.persona_id) as sexo, " \
            #               "   (select tp.nombre from sga_tipoprofesor tp where tp.id=sga_profesormateria.tipoprofesor_id) as tipoprofesor, " \
            #               "   (select de.nombre from sga_tiempodedicaciondocente de where de.id=sga_profesor.dedicacion_id) as dedicacion, " \
            #               "   sga_persona.cedula, (select s.nombre from sga_sexo s where s.id=sga_persona.sexo_id ) as sexoalu , sga_persona.lgtbi, " \
            #               "   (select gr.nombre from socioecon_fichasocioeconomicainec f inner join socioecon_gruposocioeconomico gr on gr.id=f.grupoeconomico_id where persona_id=sga_persona.id) as socioeco, " \
            #               "   (select r.nombre from sga_perfilinscripcion pa inner join sga_raza r on r.id=pa.raza_id where persona_id=sga_persona.id) as etnia, " \
            #               "   (select d.nombre from sga_perfilinscripcion pa inner join sga_discapacidad d on d.id=pa.tipodiscapacidad_id where persona_id=sga_persona.id) as discapacidad, " \
            #               "   (select pe.porcientodiscapacidad from sga_perfilinscripcion pe where persona_id=sga_persona.id) as porcentaje, " \
            #               "   (select pe.carnetdiscapacidad from sga_perfilinscripcion pe where persona_id=sga_persona.id) as carnetdiscapacidad, " \
            #               "   (select pe.verificadiscapacidad from sga_perfilinscripcion pe where persona_id=sga_persona.id) as verificadiscapacidad, " \
            #               "   (select be.id from sga_inscripcionbecario be where be.inscripcion_id=sga_inscripcion.id) as tienebeca, " \
            #               "   (select pe.nombre from med_personaextension es inner join sga_personaestadocivil pe on pe.id=es.estadocivil_id where es.persona_id=sga_persona.id) as estadocivil, " \
            #               " (case gru.tipomatricula when 1 then 'REGULAR'  when 2 then 'IREGULAR' else '' end) as tipomatricula, " \
            #               " (case gru.estado_gratuidad when 1 then 'GRATUIDAD COMPLETA'  when 2 then 'GRATUIDAD PARCIAL' when 3 then 'PERDIDA DE GRATUIDAD' else '' end) as estado_gratuidad," \
            #               "   (select carr.nombre from sga_asignaturamalla asig inner join sga_malla mall on mall.id=asig.malla_id inner join sga_carrera carr on carr.id=mall.carrera_id where asig.id=sga_asignaturamalla.id) as Carrera_de_la_asignatura," \
            #               "sga_materia.id as id " \
            #               " FROM sga_persona sga_persona " \
            #               "      RIGHT OUTER JOIN sga_inscripcion sga_inscripcion ON sga_persona.id = sga_inscripcion.persona_id " \
            #               "     INNER JOIN sga_matricula sga_matricula ON sga_matricula.inscripcion_id=sga_inscripcion.id " \
            #               " left JOIN sga_matriculagruposocioeconomico gru ON gru.matricula_id=sga_matricula.id " \
            #               "    inner join sga_materiaasignada sga_materiaasignada on sga_materiaasignada.matricula_id=sga_matricula.id " \
            #               "     inner join sga_materia sga_materia on sga_materia.id=sga_materiaasignada.materia_id " \
            #               "     LEFT join sga_profesormateria on sga_profesormateria.materia_id=sga_materia.id " \
            #               "     LEFT join sga_profesor on sga_profesor.id=sga_profesormateria.profesor_id " \
            #               "     inner join sga_asignatura sga_asignatura on sga_asignatura.id=sga_materia.asignatura_id " \
            #               "      inner join sga_asignaturamalla sga_asignaturamalla on sga_asignaturamalla.id=sga_materia.asignaturamalla_id " \
            #               "    inner join sga_nivel sga_nivel ON sga_nivel.id=sga_matricula.nivel_id and sga_nivel.periodo_id= '" + periodo + "' " \
            #                                                                                                                                   "      inner join sga_nivelmalla sga_nivelmalla on sga_nivelmalla.id=sga_asignaturamalla.nivelmalla_id " \
            #                                                                                                                                   "     INNER JOIN sga_carrera sga_carrera ON sga_inscripcion.carrera_id = sga_carrera.id " \
            #                                                                                                                                   "     INNER JOIN sga_coordinacion_carrera on sga_coordinacion_carrera.carrera_id=sga_carrera.id " \
            #                                                                                                                                   "     INNER JOIN sga_coordinacion on sga_coordinacion.id=sga_coordinacion_carrera.coordinacion_id " \
            #                                                                                                                                   "     INNER JOIN sga_modalidad sga_modalidad ON sga_inscripcion.modalidad_id = sga_modalidad.id " \
            #                                                                                                                                   "     INNER JOIN sga_sesion sga_sesion ON sga_inscripcion.sesion_id = sga_sesion.id " \
            #                                                                                                                                   "     inner join sga_tipoestado on sga_tipoestado.id=sga_materiaasignada.estado_id " \
            #                                                                                                                                   "    where sga_matricula.estado_matricula in (2,3) and sga_matricula.id not in (select ret.matricula_id from sga_retiromatricula ret) and sga_profesormateria.activo=True and sga_profesormateria.id = (select pm.id from sga_profesormateria pm inner join sga_profesor profe on pm.profesor_id=profe.id inner join sga_persona p on p.id=profe.persona_id  where pm.materia_id=sga_materiaasignada.materia_id and pm.status=True and pm.activo=True and (pm.tipoprofesor_id=1 or pm.tipoprofesor_id=3) order by pm.tipoprofesor_id LIMIT 1) order by sga_carrera.nombre,sga_nivelmalla.id,sga_sesion.nombre,sga_persona_nombres "
            #         cursor.execute(sql)
            #         results = cursor.fetchall()
            #         row_num = 4
            #         for r in results:
            #             i = 0
            #             campo1 = u"%s" % r[0]
            #             campo2 = u"%s" % r[1]
            #             campo3 = u"%s" % r[2]
            #             campo4 = u"%s" % r[3]
            #             campo5 = u"%s" % r[4]
            #             campo6 = u"%s" % r[5]
            #             campo7 = u"%s" % r[6]
            #             campo8 = u"%s" % r[7]
            #             campo9 = u"%s" % r[8]
            #             campo10 = u"%s" % r[9]
            #             campo33 = u"%s" % r[33]
            #             campo11 = u"%s" % r[11]
            #             campo12 = u"%s" % r[12]
            #             campo13 = u"%s" % r[13]
            #             campo14 = u"%s" % r[14]
            #             campo15 = u"%s" % r[15]
            #             campo16 = u"%s" % r[16]
            #             campo17 = u"%s" % r[17]
            #             campo18 = u"%s" % r[18]
            #             campo19 = u"%s" % r[19]
            #             campo20 = u"%s" % r[20]
            #             campo21 = u"%s" % r[21]
            #             campo22 = u"%s" % r[22]
            #             campo23 = u"%s" % r[23]
            #             campo24 = u"%s" % r[24]
            #             campo25 = "SI" if r[25] else "NO"
            #             campo26 = u"%s" % r[26]
            #             campo27 = u"%s" % r[27]
            #             campo28 = u"%s" % r[28] if r[28] else "NINGUNA"
            #             campo29 = u"%s" % r[29]
            #             campo30 = u"%s" % r[30]
            #             campo31 = "SI" if r[31] else "NO"
            #             campo32 = "SI" if r[31] else "NO"
            #             campo34 = u"%s" % r[34]
            #             campo35 = u"%s" % r[35]
            #             campo36 = u"%s" % r[36]
            #             campo37 = u"%s" % r[37]
            #             ws.write(row_num, 0, str(campo1))
            #             ws.write(row_num, 1, str(campo2))
            #             ws.write(row_num, 2, str(campo3))
            #             ws.write(row_num, 3, str(campo4))
            #             ws.write(row_num, 4, str(campo5))
            #             ws.write(row_num, 5, str(campo23))
            #             ws.write(row_num, 6, str(campo6))
            #             ws.write(row_num, 7, str(campo24))
            #             ws.write(row_num, 8, str(campo25))
            #             ws.write(row_num, 9, str(campo26))
            #             ws.write(row_num, 10, str(campo33))
            #             ws.write(row_num, 11, str(campo27))
            #             ws.write(row_num, 12, str(campo28))
            #             ws.write(row_num, 13, str(campo29))
            #             ws.write(row_num, 14, str(campo30))
            #             ws.write(row_num, 15, str(campo31))
            #             ws.write(row_num, 16, str(campo32))
            #             ws.write(row_num, 17, str(campo7))
            #             ws.write(row_num, 18, str(campo8))
            #             ws.write(row_num, 19, str(campo10))
            #             ws.write(row_num, 20, str(campo19))
            #             ws.write(row_num, 21, str(campo9) )
            #             ws.write(row_num, 22, str(campo20) )
            #             ws.write(row_num, 23, str(campo21) )
            #             ws.write(row_num, 24, str(campo22) )
            #             ws.write(row_num, 25, str(campo11) )
            #             ws.write(row_num, 26, str(campo12) )
            #             ws.write(row_num, 27, str(campo13) )
            #             ws.write(row_num, 28, str(campo14) )
            #             ws.write(row_num, 29, str(campo15) )
            #             ws.write(row_num, 30, str(campo16) )
            #             ws.write(row_num, 31, str(campo17) )
            #             ws.write(row_num, 32, str(campo18) )
            #             ws.write(row_num, 33, str(campo34) )
            #             ws.write(row_num, 34, str(campo35) )
            #             ws.write(row_num, 35, str(campo36) )
            #             ws.write(row_num, 36, str(campo37) )
            #             row_num += 1
            #         wb.save(response)
            #         return response
            #     except Exception as ex:
            #         pass

            elif action == 'reportealumnosfacu':
                try:
                    periodo = request.GET['periodo']
                    idfacultad = request.GET['idcoor']
                    __author__ = 'Unemi'
                    title = easyxf(
                        'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('exp_xls_post_part')
                    ws.write_merge(0, 0, 0, 7, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                    response = HttpResponse(content_type="application/ms-excel")
                    response[
                        'Content-Disposition'] = 'attachment; filename=reporte_asignaturas_estudiantes' + random.randint(
                        1, 10000).__str__() + '.xls'
                    columns = [
                        (u"FACULTAD", 6000),
                        (u"CARRERA", 6000),
                        (u"SECCION", 6000),
                        (u"NIVEL", 6000),
                        (u"ASIGNATURA", 6000),
                        (u"CEDULA ALUMN.", 4000),
                        (u"ALUMNO", 6000),
                        (u"SEXO", 6000),
                        (u"LGTBI", 3000),
                        (u"GRUPO SOCIOECONOMICO", 5000),
                        (u"ESTADO CIVIL", 5000),
                        (u"ETNIA", 4000),
                        (u"DISCAPACIDAD", 4000),
                        (u"PORCENTAJE", 3000),
                        (u"CARNET", 3000),
                        (u"VERIFICADO", 3000),
                        (u"BECA", 3000),
                        (u"NOTA FINAL", 6000),
                        (u"ASISTENCIA", 6000),
                        (u"ESTADO", 6000),
                        (u"CEDULA DOC.", 3000),
                        (u"DOCENTE", 6000),
                        (u"SEXO", 4000),
                        (u"TIPO DOCENTE", 4000),
                        (u"DEDICACION DOCENTE", 4000),
                        (u"TELEFONO", 6000),
                        (u"EMAIL", 6000),
                        (u"EMAIL INST", 6000),
                        (u"CIUDAD", 6000),
                        (u"DIRECCION", 12000),
                        (u"PARALELO", 12000),
                        (u"VECES DE MATRICULA", 6000),
                        (u"CREDITOS", 6000),
                        (u"TIPO MATRICULA", 6000),
                        (u"GRATUIDAD", 6000),
                        (u"CARRERA DE LA ASIGNATURA", 6000),
                        (u"CODIGO MATERIA", 6000),
                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], font_style)
                        ws.col(col_num).width = columns[col_num][1]
                    cursor = connections['sga_select'].cursor()
                    sql = "SELECT DISTINCT " \
                          "   sga_coordinacion.nombre as sga_coordinacion_nombre, " \
                          "   sga_carrera.nombre AS sga_carrera_nombre, " \
                          "   sga_sesion.nombre AS sga_sesion_nombre, " \
                          "   sga_nivelmalla.nombre as sga_nivelmalla_nombre, " \
                          "   sga_asignatura.nombre as sga_asignatura_nombre, " \
                          "   sga_persona.apellido1 || ' ' || sga_persona.apellido2  || ' ' ||  sga_persona.nombres AS sga_persona_nombres, " \
                          "   sga_materiaasignada.notafinal as notafinal, " \
                          "   sga_materiaasignada.asistenciafinal as asistenciafinal, " \
                          "   (select p.apellido1 || ' ' || p.apellido2 || ' ' || p.nombres from sga_persona p where p.id=sga_profesor.persona_id) as docente, " \
                          "   sga_tipoestado.nombre as estado, " \
                          "   sga_nivelmalla.id as sga_nivelmalla_id," \
                          "   sga_persona.telefono, sga_persona.email, sga_persona.emailinst, sga_persona.ciudad, " \
                          "   sga_persona.direccion || ', ' || sga_persona.direccion2 || ' #:' || sga_persona.num_direccion || ' , SECTOR:' || sga_persona.sector as direccion, sga_materia.paralelo, sga_materiaasignada.matriculas, sga_asignaturamalla.creditos," \
                          "   (select p.cedula from sga_persona p where p.id=sga_profesor.persona_id) as cedula, " \
                          "   (select s.nombre from sga_persona p INNER JOIN sga_sexo s on s.id=p.sexo_id where p.id=sga_profesor.persona_id) as sexo, " \
                          "   (select tp.nombre from sga_tipoprofesor tp where tp.id=sga_profesormateria.tipoprofesor_id) as tipoprofesor, " \
                          "   (select de.nombre from sga_tiempodedicaciondocente de where de.id=sga_profesor.dedicacion_id) as dedicacion, " \
                          "   sga_persona.cedula, (select s.nombre from sga_sexo s where s.id=sga_persona.sexo_id ) as sexoalu , sga_persona.lgtbi, " \
                          "   (select gr.nombre from socioecon_fichasocioeconomicainec f inner join socioecon_gruposocioeconomico gr on gr.id=f.grupoeconomico_id where persona_id=sga_persona.id) as socioeco, " \
                          "   (select r.nombre from sga_perfilinscripcion pa inner join sga_raza r on r.id=pa.raza_id where persona_id=sga_persona.id) as etnia, " \
                          "   (select d.nombre from sga_perfilinscripcion pa inner join sga_discapacidad d on d.id=pa.tipodiscapacidad_id where persona_id=sga_persona.id) as discapacidad, " \
                          "   (select pe.porcientodiscapacidad from sga_perfilinscripcion pe where persona_id=sga_persona.id) as porcentaje, " \
                          "   (select pe.carnetdiscapacidad from sga_perfilinscripcion pe where persona_id=sga_persona.id) as carnetdiscapacidad, " \
                          "   (select pe.verificadiscapacidad from sga_perfilinscripcion pe where persona_id=sga_persona.id) as verificadiscapacidad, " \
                          "   (select be.id from sga_inscripcionbecario be where be.inscripcion_id=sga_inscripcion.id) as tienebeca, " \
                          "   (select pe.nombre from med_personaextension es inner join sga_personaestadocivil pe on pe.id=es.estadocivil_id where es.persona_id=sga_persona.id) as estadocivil, " \
                          " (case gru.tipomatricula when 1 then 'REGULAR'  when 2 then 'IREGULAR' else '' end) as tipomatricula, " \
                          " (case gru.estado_gratuidad when 1 then 'GRATUIDAD COMPLETA'  when 2 then 'GRATUIDAD PARCIAL' when 3 then 'PERDIDA DE GRATUIDAD' else '' end) as estado_gratuidad," \
                          "   (select carr.nombre from sga_asignaturamalla asig inner join sga_malla mall on mall.id=asig.malla_id inner join sga_carrera carr on carr.id=mall.carrera_id where asig.id=sga_asignaturamalla.id) as Carrera_de_la_asignatura," \
                          "sga_materia.id as id " \
                          " FROM sga_persona sga_persona " \
                          "      RIGHT OUTER JOIN sga_inscripcion sga_inscripcion ON sga_persona.id = sga_inscripcion.persona_id " \
                          "     INNER JOIN sga_matricula sga_matricula ON sga_matricula.inscripcion_id=sga_inscripcion.id " \
                          " left JOIN sga_matriculagruposocioeconomico gru ON gru.matricula_id=sga_matricula.id " \
                          "    inner join sga_materiaasignada sga_materiaasignada on sga_materiaasignada.matricula_id=sga_matricula.id " \
                          "     inner join sga_materia sga_materia on sga_materia.id=sga_materiaasignada.materia_id " \
                          "     LEFT join sga_profesormateria on sga_profesormateria.materia_id=sga_materia.id " \
                          "     LEFT join sga_profesor on sga_profesor.id=sga_profesormateria.profesor_id " \
                          "     inner join sga_asignatura sga_asignatura on sga_asignatura.id=sga_materia.asignatura_id " \
                          "      inner join sga_asignaturamalla sga_asignaturamalla on sga_asignaturamalla.id=sga_materia.asignaturamalla_id " \
                          "    inner join sga_nivel sga_nivel ON sga_nivel.id=sga_matricula.nivel_id and sga_nivel.periodo_id= '" + periodo + "' " \
                                                                                                                                              "      inner join sga_nivelmalla sga_nivelmalla on sga_nivelmalla.id=sga_asignaturamalla.nivelmalla_id " \
                                                                                                                                              "     INNER JOIN sga_carrera sga_carrera ON sga_inscripcion.carrera_id = sga_carrera.id " \
                                                                                                                                              "     INNER JOIN sga_coordinacion_carrera on sga_coordinacion_carrera.carrera_id=sga_carrera.id " \
                                                                                                                                              "     INNER JOIN sga_coordinacion on sga_coordinacion.id=sga_coordinacion_carrera.coordinacion_id " \
                                                                                                                                              "     INNER JOIN sga_modalidad sga_modalidad ON sga_inscripcion.modalidad_id = sga_modalidad.id " \
                                                                                                                                              "     INNER JOIN sga_sesion sga_sesion ON sga_inscripcion.sesion_id = sga_sesion.id " \
                                                                                                                                              "     inner join sga_tipoestado on sga_tipoestado.id=sga_materiaasignada.estado_id " \
                                                                                                                                              "    where sga_matricula.estado_matricula in (2,3) and sga_matricula.id not in (select ret.matricula_id from sga_retiromatricula ret) and sga_profesormateria.activo=True and sga_coordinacion.id='" + idfacultad + "' and sga_profesormateria.id = (select pm.id from sga_profesormateria pm inner join sga_profesor profe on pm.profesor_id=profe.id inner join sga_persona p on p.id=profe.persona_id  where pm.materia_id=sga_materiaasignada.materia_id and pm.status=True and pm.activo=True and (pm.tipoprofesor_id=1 or pm.tipoprofesor_id=3) order by pm.tipoprofesor_id LIMIT 1) order by sga_carrera.nombre,sga_nivelmalla.id,sga_sesion.nombre,sga_persona_nombres "
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    row_num = 4
                    for r in results:
                        i = 0
                        campo1 = r[0]
                        campo2 = r[1]
                        campo3 = r[2]
                        campo4 = r[3]
                        campo5 = r[4]
                        campo6 = r[5]
                        campo7 = r[6]
                        campo8 = r[7]
                        campo9 = r[8]
                        campo10 = r[9]
                        campo33 = r[33]
                        campo11 = r[11]
                        campo12 = r[12]
                        campo13 = r[13]
                        campo14 = r[14]
                        campo15 = r[15]
                        campo16 = r[16]
                        campo17 = r[17]
                        campo18 = r[18]
                        campo19 = r[19]
                        campo20 = r[20]
                        campo21 = r[21]
                        campo22 = r[22]
                        campo23 = r[23]
                        campo24 = u"%s" % r[24]
                        campo25 = "SI" if r[25] else "NO"
                        campo26 = u"%s" % r[26]
                        campo27 = u"%s" % r[27]
                        campo28 = u"%s" % r[28] if r[28] else "NINGUNA"
                        campo29 = u"%s" % r[29]
                        campo30 = u"%s" % r[30]
                        campo31 = "SI" if r[31] else "NO"
                        campo32 = "SI" if r[31] else "NO"
                        campo34 = r[34]
                        campo35 = r[35]
                        campo36 = r[36]
                        campo37 = r[37]
                        ws.write(row_num, 0, campo1, font_style2)
                        ws.write(row_num, 1, campo2, font_style2)
                        ws.write(row_num, 2, campo3, font_style2)
                        ws.write(row_num, 3, campo4, font_style2)
                        ws.write(row_num, 4, campo5, font_style2)
                        ws.write(row_num, 5, campo23, font_style2)
                        ws.write(row_num, 6, campo6, font_style2)
                        ws.write(row_num, 7, campo24, font_style2)
                        ws.write(row_num, 8, campo25, font_style2)
                        ws.write(row_num, 9, campo26, font_style2)
                        ws.write(row_num, 10, campo33, font_style2)
                        ws.write(row_num, 11, campo27, font_style2)
                        ws.write(row_num, 12, campo28, font_style2)
                        ws.write(row_num, 13, campo29, font_style2)
                        ws.write(row_num, 14, campo30, font_style2)
                        ws.write(row_num, 15, campo31, font_style2)
                        ws.write(row_num, 16, campo32, font_style2)
                        ws.write(row_num, 17, campo7, font_style2)
                        ws.write(row_num, 18, campo8, font_style2)
                        ws.write(row_num, 19, campo10, font_style2)
                        ws.write(row_num, 20, campo19, font_style2)
                        ws.write(row_num, 21, campo9, font_style2)
                        ws.write(row_num, 22, campo20, font_style2)
                        ws.write(row_num, 23, campo21, font_style2)
                        ws.write(row_num, 24, campo22, font_style2)
                        ws.write(row_num, 25, campo11, font_style2)
                        ws.write(row_num, 26, campo12, font_style2)
                        ws.write(row_num, 27, campo13, font_style2)
                        ws.write(row_num, 28, campo14, font_style2)
                        ws.write(row_num, 29, campo15, font_style2)
                        ws.write(row_num, 30, campo16, font_style2)
                        ws.write(row_num, 31, campo17, font_style2)
                        ws.write(row_num, 32, campo18, font_style2)
                        ws.write(row_num, 33, campo34, font_style2)
                        ws.write(row_num, 34, campo35, font_style2)
                        ws.write(row_num, 35, campo36, font_style2)
                        ws.write(row_num, 36, campo37, font_style2)
                        row_num += 1
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'reporteresultadosnivelacion':
                try:
                    periodo = request.GET['periodo']
                    coordinacion = request.GET['coordinacion']
                    output = io.BytesIO()
                    workbook = xlsxwriter.Workbook(output)
                    ws = workbook.add_worksheet('Listado')

                    merge_format = workbook.add_format({
                        'bold': 1,
                        'border': 1,
                        'align': 'center',
                        'valign': 'vcenter',
                        'bg_color': 'silver',
                        'text_wrap': 1})

                    formatocelda = workbook.add_format({
                        'border': 1
                    })

                    ws.merge_range(0, 0, 0, 11, 'UNIVERSIDAD ESTATAL DE MILAGRO',
                                   workbook.add_format({'align': 'center',
                                                        'valign': 'vcenter',
                                                        'bold': 1,
                                                        'font_size': 16}))
                    columns = [
                        (u"CÉDULA", 20),
                        (u"APELLIDOS", 40),
                        (u"NOMBRES", 40),
                        (u"CARRERA", 40),
                        (u"MODALIDAD", 20),
                        (u"ESTATUS", 20),
                        (u"PROMEDIO FINAL", 15),
                        (u"MATERIA 1", 35),
                        (u"MATERIA 2", 35),
                        (u"MATERIA 3", 35),
                        (u"MATERIA 4", 35),
                        (u"NÚMERO DE MATRÍCULA", 15)
                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], merge_format)
                        ws.set_column(col_num, col_num, columns[col_num][1])

                    cursor = connections['default'].cursor()
                    sql = """select p.cedula AS cedula, p.apellido1||' '||p.apellido2 AS apellidos, p.nombres AS nombres, car.nombre as carrera,  
                            mo.nombre as modalidad,Case When mat.aprobado=TRUE THEN 'APROBADO' ELSE 'REPROBADO' End AS status,
                            (select avg(notafinal)
                            from sga_matricula m
                            inner join sga_materiaasignada ma on ma.matricula_id=m.id
                            where m.id=mat.id) as promedio,
                            (select ma.matriculas
                            from sga_matricula matri
                            inner join sga_materiaasignada ma on ma.matricula_id=matri.id
                            where matri.id=mat.id and ma.matriculas=1 order by ma.id limit 1) primeravez,
                            (select ma.matriculas
                            from sga_matricula matri
                            inner join sga_materiaasignada ma on ma.matricula_id=matri.id
                            where matri.id=mat.id and ma.matriculas>1 order by ma.id limit 1) segundavez,
                            (select a.nombre
                            from sga_matricula matri
                            inner join sga_materiaasignada ma on ma.matricula_id=matri.id
                            inner join sga_materia mate on mate.id=ma.materia_id
                            inner join sga_asignatura a on a.id=mate.asignatura_id
                            where matri.id=mat.id order by ma.id  limit 1 offset 0) as asignatura1,
                            (select a.nombre
                            from sga_matricula matri
                            inner join sga_materiaasignada ma on ma.matricula_id=matri.id
                            inner join sga_materia mate on mate.id=ma.materia_id
                            inner join sga_asignatura a on a.id=mate.asignatura_id
                            where matri.id=mat.id order by ma.id  limit 1 offset 1) as asignatura2,
                            (select a.nombre
                            from sga_matricula matri
                            inner join sga_materiaasignada ma on ma.matricula_id=matri.id
                            inner join sga_materia mate on mate.id=ma.materia_id
                            inner join sga_asignatura a on a.id=mate.asignatura_id
                            where matri.id=mat.id order by ma.id  limit 1 offset 2) as asignatura3,
                            (select a.nombre
                            from sga_matricula matri
                            inner join sga_materiaasignada ma on ma.matricula_id=matri.id
                            inner join sga_materia mate on mate.id=ma.materia_id
                            inner join sga_asignatura a on a.id=mate.asignatura_id
                            where matri.id=mat.id order by ma.id  limit 1 offset 3) as asignatura4
                            from sga_matricula mat
                            inner join sga_nivel ni on ni.id=mat.nivel_id  
                            inner join sga_inscripcion i on i.id=mat.inscripcion_id
                            inner join sga_persona p on p.id=i.persona_id
                            inner join sga_carrera car on car.id=i.carrera_id
                            inner join sga_modalidad mo on mo.id=car.modalidad
                            inner join sga_coordinacion_carrera cc on cc.carrera_id=car.id
                            where ni.periodo_id=%s  and cc.coordinacion_id=%s
                            order by p.apellido1, p.apellido2
                        """ % (periodo, coordinacion)

                    cursor.execute(sql)
                    results = cursor.fetchall()
                    row_num = 4
                    for r in results:
                        i = 0
                        cedula = r[0]
                        apellidos = r[1]
                        nombres = r[2]
                        carrera = r[3]
                        modalidad = r[4]
                        status = r[5]
                        promedio = r[6]
                        primeravez = r[7]
                        segundavez = r[8]
                        asignatura1 = r[9]
                        asignatura2 = r[10]
                        asignatura3 = r[11]
                        asignatura4 = r[12]

                        ws.write(row_num, 0, u'%s' % cedula, formatocelda)
                        ws.write(row_num, 1, u'%s' % apellidos, formatocelda)
                        ws.write(row_num, 2, u'%s' % nombres, formatocelda)
                        ws.write(row_num, 3, u'%s' % carrera, formatocelda)
                        ws.write(row_num, 4, u'%s' % modalidad, formatocelda)
                        ws.write(row_num, 5, u'%s' % status, formatocelda)
                        ws.write(row_num, 6, promedio, formatocelda)
                        ws.write(row_num, 7, u'%s' % asignatura1 if asignatura1 else '', formatocelda)
                        ws.write(row_num, 8, u'%s' % asignatura2 if asignatura2 else '', formatocelda)
                        ws.write(row_num, 9, u'%s' % asignatura3 if asignatura3 else '', formatocelda)
                        ws.write(row_num, 10, u'%s' % asignatura4 if asignatura4 else '', formatocelda)
                        ws.write(row_num, 11, u'%s' % 'PRIMERA' if primeravez else 'SEGUNDA', formatocelda)
                        row_num += 1

                    workbook.close()
                    output.seek(0)
                    # Set up the Http response.
                    filename = 'ReporteResultadosFinalesNivelacion' + random.randint(1, 10000).__str__() + '.xlsx'
                    response = HttpResponse(output,
                                            content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
                    response['Content-Disposition'] = 'attachment; filename=%s' % filename

                    return response
                except Exception as ex:
                    pass

            elif action == 'reportealumnosmatriculados':
                try:
                    noti = Notificacion(cuerpo='Generación de reporte de excel en progreso',
                                        titulo='Excel Matriculados en Pregrado',
                                        destinatario=persona,
                                        url='',
                                        prioridad=1, app_label='SGA',
                                        fecha_hora_visible=datetime.now() + timedelta(days=1), tipo=2,
                                        en_proceso=True)
                    noti.save()

                    reporte_matriculados_pregrado_background(request=request, data=data, notif=noti.pk,periodo=periodo).start()
                    return JsonResponse({"result": True,
                                         "mensaje": u"El reporte se está realizando. Verifique su apartado de notificaciones después de unos minutos.",
                                         "btn_notificaciones": traerNotificaciones(request, data, persona)})


                except Exception as ex:
                    print('Error on line {}'.format(sys.exc_info()[-1].tb_lineno))
                    pass

            elif action == 'reportealumnosinprofesor':
                try:
                    output = io.BytesIO()
                    workbook = xlsxwriter.Workbook(output)
                    ws = workbook.add_worksheet('exp_xls_post_part')

                    merge_format = workbook.add_format({
                        'bold': 1,
                        'border': 1,
                        'align': 'center',
                        'valign': 'vcenter'})

                    ws.merge_range(0, 0, 0, 7, 'UNIVERSIDAD ESTATAL DE MILAGRO',
                                   workbook.add_format({'align': 'center', 'valign': 'vcenter'}))
                    columns = [
                        (u"FACULTAD", 40),
                        (u"CARRERA", 40),
                        (u"CEDULA", 25),
                        (u"PRIMER APELLIDO", 40),
                        (u"SEGUNDO APELLIDO", 40),
                        (u"NOMBRES", 40),
                        (u"EMAIL", 40),
                        (u"EMAIL INSTITUCIONAL", 40),
                        (u"CELULAR", 25),
                        (u"TELEFONO", 25),
                        (u"MATERIA", 40),
                        (u"PARALELO", 25),
                        (u"NIVEL", 25),
                        (u"NOTA FINAL", 40),
                        (u"ASISTENCIA FINAL", 40),
                        (u"ESTADO", 25),
                        (u"NUMERO DE MATRICULA", 25),
                        (u"ANIO MALLA", 25),
                        (u"FECHA NACIMIENTO", 25),
                        (u"MODALIDAD", 25),
                        (u"SEXO", 25),
                        (u"CANTON RESIDENCIA", 25),
                        (u"PROVINCIA", 25),
                        (u"PAIS", 25),
                        (u"GRUPO SOCIECONOMICO", 25),
                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], merge_format)
                        ws.set_column(col_num, col_num, columns[col_num][1])
                    cursor = connections['default'].cursor()
                    sql = """SELECT coordinacion.nombre as coordinacion, CASE WHEN carrera.mencion = '' THEN carrera.nombre ELSE (carrera.nombre || ' CON MENCION EN ' || carrera.mencion) END as carrera, 
                            persona.cedula, persona.apellido1, persona.apellido2, persona.nombres, persona.email, persona.emailinst, persona.telefono, persona.telefono_conv, 
                            (asignatura.nombre || CASE WHEN materia.alias = '' THEN '' ELSE (' - ('|| materia.alias || ')') END  || CASE WHEN materia.identificacion = '' THEN '' ELSE (' - ['|| materia.identificacion || ']') END) as materia, 
                            materia.paralelo as paralelo, nivelmalla.nombre as nivel, materiaasig.notafinal as notafinal, materiaasig.asistenciafinal as asistenciafinal, tipoestado.nombre as estado,  materiaasig.matriculas as veces, extract(year from malla.inicio) as aniomalla,  
                            persona.nacimiento, modalidad.nombre, genero.nombre, canton.nombre, gruposocio.nombre, provincia.nombre, pais.nombre  
                            from sga_materiaasignada materiaasig 
                            inner join sga_materia materia on materia.id = materiaasig.materia_id 
                            inner join sga_nivel nivel on nivel.id = materia.nivel_id 
                            inner join sga_modalidad modalidad on nivel.modalidad_id = modalidad.id 
                            inner join sga_asignaturamalla asigmalla on asigmalla.id = materia.asignaturamalla_id 
                            inner join sga_malla malla on malla.id = asigmalla.malla_id 
                            inner join sga_carrera carrera on carrera.id = malla.carrera_id 
                            inner join sga_matricula matricula on matricula.id = materiaasig.matricula_id 
                            inner join sga_inscripcion inscripcion on inscripcion.id = matricula.inscripcion_id 
                            inner join sga_persona persona on persona.id = inscripcion.persona_id 
                            left join sga_sexo genero on genero.id = persona.sexo_id 
                            left join sga_canton canton on canton.id = persona.canton_id 
                            left join sga_provincia provincia on provincia.id = persona.provincia_id 
                            left join sga_pais pais on pais.id = persona.pais_id 
                            inner join sga_asignatura asignatura on asignatura.id = materia.asignatura_id 
                            inner join sga_nivelmalla nivelmalla on nivelmalla.id = asigmalla.nivelmalla_id 
                            inner join sga_tipoestado tipoestado on tipoestado.id = materiaasig.estado_id 
                            inner join sga_coordinacion_carrera coordinacioncarrera on coordinacioncarrera.carrera_id = carrera.id 
                            inner join sga_coordinacion coordinacion on coordinacion.id = coordinacioncarrera.coordinacion_id 
                            left join sga_matriculagruposocioeconomico matri_gruposocio on matri_gruposocio.matricula_id = matricula.id
                            left join socioecon_gruposocioeconomico gruposocio on matri_gruposocio.gruposocioeconomico_id = gruposocio.id
                            where coordinacion.id not in(9) and materia.status=True and materiaasig.status=True AND materiaasig.retiramateria = False
                              and matricula.status and  nivel.periodo_id = %s""" % periodo.id
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    row_num = 4
                    for r in results:
                        ws.write(row_num, 0, u'%s' % r[0])
                        ws.write(row_num, 1, u'%s' % r[1])
                        ws.write(row_num, 2, u'%s' % r[2])
                        ws.write(row_num, 3, u'%s' % r[3])
                        ws.write(row_num, 4, u'%s' % r[4])
                        ws.write(row_num, 5, u'%s' % r[5])
                        ws.write(row_num, 6, u'%s' % r[6])
                        ws.write(row_num, 7, u'%s' % r[7])
                        ws.write(row_num, 8, u'%s' % r[8])
                        ws.write(row_num, 9, u'%s' % r[9])
                        ws.write(row_num, 10, u'%s' % r[10])
                        ws.write(row_num, 11, u'%s' % r[11])
                        ws.write(row_num, 12, u'%s' % r[12])
                        ws.write(row_num, 13, r[13])
                        ws.write(row_num, 14, r[14])
                        ws.write(row_num, 15, u'%s' % r[15])
                        ws.write(row_num, 16, 3 if r[16]>3 else r[16])
                        ws.write(row_num, 17, r[17])
                        ws.write(row_num, 18, u'%s' % r[18])
                        ws.write(row_num, 19, u'%s' % r[19])
                        ws.write(row_num, 20, u'%s' % r[20])
                        ws.write(row_num, 21, u'%s' % r[21])
                        ws.write(row_num, 22, u'%s' % r[23])
                        ws.write(row_num, 23, u'%s' % r[24])
                        ws.write(row_num, 24, u'%s' % r[22])
                        row_num += 1
                    workbook.close()
                    output.seek(0)
                    # Set up the Http response.
                    filename = 'reporte_asignaturas_estudiantes_sin_profesor' + random.randint(1, 10000).__str__() + '.xlsx'
                    response = HttpResponse(output, content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
                    response['Content-Disposition'] = 'attachment; filename=%s' % filename

                    return response
                except Exception as ex:
                    pass

            elif action == 'reportealumnossinprofesornivelación':
                try:
                    output = io.BytesIO()
                    workbook = xlsxwriter.Workbook(output)
                    ws = workbook.add_worksheet('exp_xls_post_part')

                    merge_format = workbook.add_format({
                        'bold': 1,
                        'border': 1,
                        'align': 'center',
                        'valign': 'vcenter'})

                    ws.merge_range(0, 0, 0, 7, 'UNIVERSIDAD ESTATAL DE MILAGRO',
                                   workbook.add_format({'align': 'center', 'valign': 'vcenter'}))
                    columns = [
                        (u"FACULTAD", 40),
                        (u"CARRERA", 40),
                        (u"CEDULA", 25),
                        (u"PRIMER APELLIDO", 40),
                        (u"SEGUNDO APELLIDO", 40),
                        (u"NOMBRES", 40),
                        (u"EMAIL", 40),
                        (u"EMAIL INSTITUCIONAL", 40),
                        (u"CELULAR", 25),
                        (u"TELEFONO", 25),
                        (u"MATERIA", 40),
                        (u"PARALELO", 25),
                        (u"NIVEL", 25),
                        (u"NOTA FINAL", 40),
                        (u"ASISTENCIA FINAL", 40),
                        (u"ESTADO", 25),
                        (u"NUMERO DE MATRICULA", 25),
                        (u"ANIO MALLA", 25),
                        (u"FECHA NACIMIENTO", 25),
                        (u"MODALIDAD", 25),
                        (u"SEXO", 25),
                        (u"CANTON RESIDENCIA", 25),
                        (u"GRUPO SOCIECONOMICO", 25)
                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], merge_format)
                        ws.set_column(col_num, col_num, columns[col_num][1])
                    cursor = connections['default'].cursor()
                    sql = """SELECT coordinacion.nombre as coordinacion, CASE WHEN carrera.mencion = '' THEN carrera.nombre ELSE (carrera.nombre || ' CON MENCION EN ' || carrera.mencion) END as carrera, 
                            persona.cedula, persona.apellido1, persona.apellido2, persona.nombres, persona.email, persona.emailinst, persona.telefono, persona.telefono_conv, 
                            (asignatura.nombre || CASE WHEN materia.alias = '' THEN '' ELSE (' - ('|| materia.alias || ')') END  || CASE WHEN materia.identificacion = '' THEN '' ELSE (' - ['|| materia.identificacion || ']') END) as materia, 
                            materia.paralelo as paralelo, nivelmalla.nombre as nivel, materiaasig.notafinal as notafinal, materiaasig.asistenciafinal as asistenciafinal, tipoestado.nombre as estado,  materiaasig.matriculas as veces, extract(year from malla.inicio) as aniomalla,  
                            persona.nacimiento, modalidad.nombre, genero.nombre, canton.nombre, gruposocio.nombre  
                            from sga_materiaasignada materiaasig 
                            inner join sga_materia materia on materia.id = materiaasig.materia_id 
                            inner join sga_nivel nivel on nivel.id = materia.nivel_id 
                            inner join sga_modalidad modalidad on nivel.modalidad_id = modalidad.id 
                            inner join sga_asignaturamalla asigmalla on asigmalla.id = materia.asignaturamalla_id 
                            inner join sga_malla malla on malla.id = asigmalla.malla_id 
                            inner join sga_carrera carrera on carrera.id = malla.carrera_id 
                            inner join sga_matricula matricula on matricula.id = materiaasig.matricula_id 
                            inner join sga_inscripcion inscripcion on inscripcion.id = matricula.inscripcion_id 
                            inner join sga_persona persona on persona.id = inscripcion.persona_id 
                            left join sga_sexo genero on genero.id = persona.sexo_id 
                            left join sga_canton canton on canton.id = persona.canton_id 
                            inner join sga_asignatura asignatura on asignatura.id = materia.asignatura_id 
                            inner join sga_nivelmalla nivelmalla on nivelmalla.id = asigmalla.nivelmalla_id 
                            inner join sga_tipoestado tipoestado on tipoestado.id = materiaasig.estado_id 
                            inner join sga_coordinacion_carrera coordinacioncarrera on coordinacioncarrera.carrera_id = carrera.id 
                            inner join sga_coordinacion coordinacion on coordinacion.id = coordinacioncarrera.coordinacion_id 
                            left join sga_matriculagruposocioeconomico matri_gruposocio on matri_gruposocio.matricula_id = matricula.id
                            left join socioecon_gruposocioeconomico gruposocio on matri_gruposocio.gruposocioeconomico_id = gruposocio.id
                            where coordinacion.id in(9) and materia.status=True and materiaasig.status=True AND materiaasig.retiramateria = False
                              and matricula.status and  nivel.periodo_id = %s""" % periodo.id
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    row_num = 4
                    for r in results:
                        ws.write(row_num, 0, u'%s' % r[0])
                        ws.write(row_num, 1, u'%s' % r[1])
                        ws.write(row_num, 2, u'%s' % r[2])
                        ws.write(row_num, 3, u'%s' % r[3])
                        ws.write(row_num, 4, u'%s' % r[4])
                        ws.write(row_num, 5, u'%s' % r[5])
                        ws.write(row_num, 6, u'%s' % r[6])
                        ws.write(row_num, 7, u'%s' % r[7])
                        ws.write(row_num, 8, u'%s' % r[8])
                        ws.write(row_num, 9, u'%s' % r[9])
                        ws.write(row_num, 10, u'%s' % r[10])
                        ws.write(row_num, 11, u'%s' % r[11])
                        ws.write(row_num, 12, u'%s' % r[12])
                        ws.write(row_num, 13, r[13])
                        ws.write(row_num, 14, r[14])
                        ws.write(row_num, 15, u'%s' % r[15])
                        ws.write(row_num, 16, 3 if r[16]>3 else r[16])
                        ws.write(row_num, 17, r[17])
                        ws.write(row_num, 18, u'%s' % r[18])
                        ws.write(row_num, 19, u'%s' % r[19])
                        ws.write(row_num, 20, u'%s' % r[20])
                        ws.write(row_num, 21, u'%s' % r[21])
                        ws.write(row_num, 22, u'%s' % r[22])
                        row_num += 1
                    workbook.close()
                    output.seek(0)
                    # Set up the Http response.
                    filename = 'reporte_asignaturas_estudiantes_sin_profesor' + random.randint(1, 10000).__str__() + '.xlsx'
                    response = HttpResponse(output, content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
                    response['Content-Disposition'] = 'attachment; filename=%s' % filename

                    return response
                except Exception as ex:
                    pass

            elif action == 'reportematriculadosnivelacion':
                try:
                    noti = Notificacion(cuerpo='Generación de reporte de excel en progreso',
                                        titulo='Excel Matriculados en Nivelación',
                                        destinatario=persona,
                                        url='',
                                        prioridad=1, app_label='SGA',
                                        fecha_hora_visible=datetime.now() + timedelta(days=1), tipo=2,
                                        en_proceso=True)
                    noti.save()

                    reporte_matriculados_nivelacion_background(request=request, data=data, notif=noti.pk, periodo=periodo).start()
                    return JsonResponse({"result": True,
                                         "mensaje": u"El reporte se está realizando. Verifique su apartado de notificaciones después de unos minutos.",
                                         "btn_notificaciones": traerNotificaciones(request, data, persona)})


                except Exception as ex:
                    print('Error on line {}'.format(sys.exc_info()[-1].tb_lineno))
                    pass


            elif action == 'reportealumnosinprofesoradmision':
                try:
                    __author__ = 'Unemi'
                    title = easyxf(
                        'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('exp_xls_post_part')
                    ws.write_merge(0, 0, 0, 7, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                    response = HttpResponse(content_type="application/ms-excel")
                    response[
                        'Content-Disposition'] = 'attachment; filename=reporte_asignaturas_estudiantes_sin_profesor' + random.randint(
                        1, 10000).__str__() + '.xls'
                    columns = [
                        (u"FACULTAD", 6000),
                        (u"CARRERA", 6000),
                        (u"CEDULA", 3000),
                        (u"PRIMER APELLIDO", 6000),
                        (u"SEGUNDO APELLIDO", 6000),
                        (u"NOMBRES", 6000),
                        (u"EMAIL", 6000),
                        (u"EMAIL INSTITUCIONAL", 6000),
                        (u"CELULAR", 3000),
                        (u"TELEFONO", 3000),
                        (u"MATERIA", 6000),
                        (u"PARALELO", 3000),
                        (u"NIVEL", 3000),
                        (u"NOTA FINAL", 6000),
                        (u"ASISTENCIA FINAL", 6000),
                        (u"ESTADO", 3000),
                        (u"NUMERO DE MATRICULA", 3000),
                        (u"CUPO", 3000)
                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], font_style)
                        ws.col(col_num).width = columns[col_num][1]
                    cursor = connections['sga_select'].cursor()
                    sql = """
                            select coordinacion.nombre as coordinacion, CASE WHEN carrera.mencion = '' THEN carrera.nombre ELSE (carrera.nombre || ' CON MENCION EN ' || carrera.mencion) END as carrera, 
                            persona.cedula, persona.apellido1, persona.apellido2, persona.nombres, persona.email, persona.emailinst, persona.telefono, persona.telefono_conv, 
                            (asignatura.nombre || CASE WHEN materia.alias = '' THEN '' ELSE (' - ('|| materia.alias || ')') END  || CASE WHEN materia.identificacion = '' THEN '' ELSE (' - ['|| materia.identificacion || ']') END) as materia, 
                            materia.paralelo as paralelo, nivelmalla.nombre as nivel, materiaasig.notafinal as notafinal, materiaasig.asistenciafinal as asistenciafinal, CASE WHEN materiaasig.notafinal >=70 THEN 'APROBADO' ELSE 'REPROBADO' END,  materiaasig.matriculas as veces, matricula.aprobado as cupo   
                            from sga_materiaasignada materiaasig 
                            inner join sga_materia materia on materia.id = materiaasig.materia_id 
                            inner join sga_nivel nivel on nivel.id = materia.nivel_id 
                            inner join sga_asignaturamalla asigmalla on asigmalla.id = materia.asignaturamalla_id 
                            inner join sga_malla malla on malla.id = asigmalla.malla_id 
                            inner join sga_carrera carrera on carrera.id = malla.carrera_id 
                            inner join sga_matricula matricula on matricula.id = materiaasig.matricula_id 
                            inner join sga_inscripcion inscripcion on inscripcion.id = matricula.inscripcion_id 
                            inner join sga_persona persona on persona.id = inscripcion.persona_id 
                            inner join sga_asignatura asignatura on asignatura.id = materia.asignatura_id 
                            inner join sga_nivelmalla nivelmalla on nivelmalla.id = asigmalla.nivelmalla_id 
                            inner join sga_tipoestado tipoestado on tipoestado.id = materiaasig.estado_id 
                            inner join sga_coordinacion_carrera coordinacioncarrera on coordinacioncarrera.carrera_id = carrera.id 
                            inner join sga_coordinacion coordinacion on coordinacion.id = coordinacioncarrera.coordinacion_id 
                            where matricula.status=true and materiaasig.retiramateria=false and materiaasig.status=true and coordinacion.id in(9) and nivel.periodo_id = %s
                    """ % periodo.id
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    row_num = 4
                    for r in results:
                        i = 0
                        campo1 = r[0]
                        campo2 = r[1]
                        campo3 = r[2]
                        campo4 = r[3]
                        campo5 = r[4]
                        campo6 = r[5]
                        campo7 = r[6]
                        campo8 = r[7]
                        campo9 = r[8]
                        campo10 = r[9]
                        campo11 = r[10]
                        campo12 = r[11]
                        campo13 = r[12]
                        campo14 = r[13]
                        campo15 = r[14]
                        campo16 = r[15]
                        campo17 = r[16]
                        campo18 = r[17]
                        ws.write(row_num, 0, "%s" % campo1, font_style2)
                        ws.write(row_num, 1, "%s" % campo2, font_style2)
                        ws.write(row_num, 2, "%s" % campo3, font_style2)
                        ws.write(row_num, 3, "%s" % campo4, font_style2)
                        ws.write(row_num, 4, "%s" % campo5, font_style2)
                        ws.write(row_num, 5, "%s" % campo6, font_style2)
                        ws.write(row_num, 6, "%s" % campo7, font_style2)
                        ws.write(row_num, 7, "%s" % campo8, font_style2)
                        ws.write(row_num, 8, "%s" % campo9, font_style2)
                        ws.write(row_num, 9, "%s" % campo10, font_style2)
                        ws.write(row_num, 10, "%s" % campo11, font_style2)
                        ws.write(row_num, 11, "%s" % campo12, font_style2)
                        ws.write(row_num, 12, "%s" % campo13, font_style2)
                        ws.write(row_num, 13, "%d" % campo14, font_style2)
                        ws.write(row_num, 14, "%d" % campo15, font_style2)
                        ws.write(row_num, 15, "%s" % campo16, font_style2)
                        ws.write(row_num, 16, "%d" % campo17, font_style2)
                        ws.write(row_num, 17, "%d" % campo18, font_style2)
                        row_num += 1
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'reportealumnocalificacionesadmisionvirtual':
                try:
                    __author__ = 'Unemi'
                    title = easyxf(
                        'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('todos alumnos')
                    ws.write_merge(0, 0, 0, 7, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                    response = HttpResponse(content_type="application/ms-excel")
                    response[
                        'Content-Disposition'] = 'attachment; filename=reporte_asignaturas_estudiantes_virtual_notas' + random.randint(
                        1, 10000).__str__() + '.xls'
                    columns = [
                        (u"CARRERA", 6000),
                        (u"CEDULA", 3000),
                        (u"PRIMER APELLIDO", 6000),
                        (u"SEGUNDO APELLIDO", 6000),
                        (u"NOMBRES", 6000),
                        (u"EMAIL", 6000),
                        (u"EMAIL INSTITUCIONAL", 6000),
                        (u"CELULAR", 3000),
                        (u"TELEFONO", 3000),
                        (u"MATERIA", 6000),
                        (u"PARALELO", 3000),
                        (u"GESTION", 6000),
                        (u"EXAMEN", 6000),
                        (u"NOTA FINAL", 3000),
                        (u"ESTADO", 3000),
                        (u"ESTADO FINAL", 3000),
                        (u"NÚMERO MATRICULAS", 3000),
                        (u"AULA", 3000),
                        (u"PASO AYUDA", 3000),
                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], font_style)
                        ws.col(col_num).width = columns[col_num][1]
                    cursor = connections['sga_select'].cursor()
                    idp = periodo.id.__str__()
                    sql = """
                        SELECT DISTINCT 
                        CASE WHEN carrera.mencion = '' THEN carrera.nombre ELSE (carrera.nombre || ' CON MENCION EN ' || carrera.mencion) END AS carrera, 
                         persona.cedula, persona.apellido1, persona.apellido2, persona.nombres, persona.email, persona.emailinst, persona.telefono, persona.telefono_conv, 
                         (asignatura.nombre || CASE WHEN materia.alias = '' THEN '' ELSE (' - ('|| materia.alias || ')') END || CASE WHEN materia.identificacion = '' THEN '' ELSE (' - ['|| materia.identificacion || ']') END) AS materia, 
                         materia.paralelo AS paralelo, 
                         (
                        SELECT SUM (evalge.valor)
                        FROM sga_materiaasignada A
                        INNER JOIN sga_matricula B ON A.matricula_id = B.id
                        INNER JOIN sga_nivel niv ON niv.id=B.nivel_id
                        INNER JOIN sga_periodo per ON per.id=niv.periodo_id
                        INNER JOIN sga_inscripcion ins ON B.inscripcion_id=ins.id
                        INNER JOIN sga_evaluaciongenerica evalge ON evalge.materiaasignada_id=A.id 
                        INNER JOIN sga_detallemodeloevaluativo deta ON deta.id=evalge.detallemodeloevaluativo_id
                        INNER JOIN sga_modeloevaluativo model ON model.id=deta.modelo_id
                        WHERE per.id=%s AND deta.id IN (83,84,85,68,69,70) AND B.id=matricula.id AND A.materia_id=materia.id
                        ) AS gestion,
                         (
                        SELECT SUM (evalge.valor)
                        FROM sga_materiaasignada A
                        INNER JOIN sga_matricula B ON A.matricula_id = B.id
                        INNER JOIN sga_nivel niv ON niv.id=B.nivel_id
                        INNER JOIN sga_periodo per ON per.id=niv.periodo_id
                        INNER JOIN sga_inscripcion ins ON B.inscripcion_id=ins.id
                        INNER JOIN sga_evaluaciongenerica evalge ON evalge.materiaasignada_id=A.id 
                        INNER JOIN sga_detallemodeloevaluativo deta ON deta.id=evalge.detallemodeloevaluativo_id
                        INNER JOIN sga_modeloevaluativo model ON model.id=deta.modelo_id
                        WHERE per.id=%s AND deta.id IN (86,71) AND B.id=matricula.id AND A.materia_id=materia.id
                        ) AS examen, materiaasig.notafinal AS notafinal, tipoestado.nombre AS estado,
                         matricula.id,materiaasig.matriculas AS cant_matriculas, 
                          (
                             SELECT  aula.nombre
                             FROM sga_materia materi
                        INNER JOIN sga_clase clase ON clase.materia_id=materi.id
                        INNER JOIN sga_aula aula ON aula.id=clase.aula_id
                        WHERE materi.id=materia.id
                        LIMIT 1
                        ) as aula, matricula.pasoayuda
                        FROM sga_materiaasignada materiaasig
                        INNER JOIN sga_evaluaciongenerica eval ON eval.materiaasignada_id=materiaasig.id
                        INNER JOIN sga_detallemodeloevaluativo detmod ON detmod.id=eval.detallemodeloevaluativo_id
                        INNER JOIN sga_materia materia ON materia.id = materiaasig.materia_id
                        INNER JOIN sga_nivel nivel ON nivel.id = materia.nivel_id
                        INNER JOIN sga_asignaturamalla asigmalla ON asigmalla.id = materia.asignaturamalla_id
                        INNER JOIN sga_malla malla ON malla.id = asigmalla.malla_id
                        INNER JOIN sga_carrera carrera ON carrera.id = malla.carrera_id
                        INNER JOIN sga_matricula matricula ON matricula.id = materiaasig.matricula_id
                        INNER JOIN sga_inscripcion inscripcion ON inscripcion.id = matricula.inscripcion_id
                        INNER JOIN sga_persona persona ON persona.id = inscripcion.persona_id
                        INNER JOIN sga_asignatura asignatura ON asignatura.id = materia.asignatura_id
                        INNER JOIN sga_nivelmalla nivelmalla ON nivelmalla.id = asigmalla.nivelmalla_id
                        INNER JOIN sga_tipoestado tipoestado ON tipoestado.id = materiaasig.estado_id
                        INNER JOIN sga_coordinacion_carrera coordinacioncarrera ON coordinacioncarrera.carrera_id = carrera.id
                        INNER JOIN sga_coordinacion coordinacion ON coordinacion.id = coordinacioncarrera.coordinacion_id
                        WHERE coordinacion.id IN(9) AND nivel.periodo_id = %s  AND carrera.modalidad IN (3) 
                        AND materia.esintroductoria = FALSE AND matricula.estado_matricula in (2,3)
                        GROUP BY matricula.id,materia.id, coordinacion.nombre, carrera, persona.cedula, persona.apellido1, persona.apellido2, persona.nombres, persona.email, persona.emailinst, persona.telefono, persona.telefono_conv, materia,
                         materia.paralelo, nivelmalla.nombre, materiaasig.notafinal, materiaasig.asistenciafinal, tipoestado.nombre, materiaasig.matriculas
                         
                    """ % (idp, idp, idp)
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    row_num = 4
                    for r in results:
                        campo1 = r[0]
                        campo2 = r[1]
                        campo3 = r[2]
                        campo4 = r[3]
                        campo5 = r[4]
                        campo6 = r[5]
                        campo7 = r[6]
                        campo8 = r[7]
                        campo9 = r[8]
                        campo10 = r[9]
                        campo11 = r[10]
                        campo12 = r[11]
                        campo13 = r[12]
                        campo14 = r[13]
                        campo15 = r[14]
                        campo16 = r[16]
                        campo17 = r[17]
                        estadofinal = "APROBADO"
                        matricula = Matricula.objects.get(id=r[15])
                        materiasasignadas = MateriaAsignada.objects.values_list('id', flat=True).filter(status=True,
                                                                                                        notafinal__lt=69.5,
                                                                                                        matricula=matricula,
                                                                                                        materia__esintroductoria=False)
                        if materiasasignadas.__len__() > 0:
                            estadofinal = "REPROBADO"
                        ws.write(row_num, 0, campo1.__str__(), font_style2)
                        ws.write(row_num, 1, campo2.__str__(), font_style2)
                        ws.write(row_num, 2, campo3.__str__(), font_style2)
                        ws.write(row_num, 3, campo4.__str__(), font_style2)
                        ws.write(row_num, 4, campo5.__str__(), font_style2)
                        ws.write(row_num, 5, campo6.__str__(), font_style2)
                        ws.write(row_num, 6, campo7.__str__(), font_style2)
                        ws.write(row_num, 7, campo8.__str__(), font_style2)
                        ws.write(row_num, 8, campo9.__str__(), font_style2)
                        ws.write(row_num, 9, campo10.__str__(), font_style2)
                        ws.write(row_num, 10, campo11.__str__(), font_style2)
                        ws.write(row_num, 11, campo12.__str__(), font_style2)
                        ws.write(row_num, 12, campo13.__str__(), font_style2)
                        ws.write(row_num, 13, campo14.__str__(), font_style2)
                        ws.write(row_num, 14, campo15.__str__(), font_style2)
                        ws.write(row_num, 15, estadofinal.__str__(), font_style2)
                        ws.write(row_num, 16, campo16.__str__(), font_style2)
                        ws.write(row_num, 17, campo17.__str__(), font_style2)
                        row_num += 1

                    ws = wb.add_sheet('alumnos reprobados')
                    ws.write_merge(0, 0, 0, 7, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                    response = HttpResponse(content_type="application/ms-excel")
                    response[
                        'Content-Disposition'] = 'attachment; filename=reporte_asignaturas_estudiantes_virtual_notas' + random.randint(
                        1, 10000).__str__() + '.xls'
                    columns = [
                        (u"CARRERA", 6000),
                        (u"CEDULA", 3000),
                        (u"PRIMER APELLIDO", 6000),
                        (u"SEGUNDO APELLIDO", 6000),
                        (u"NOMBRES", 6000),
                        (u"EMAIL", 6000),
                        (u"EMAIL INSTITUCIONAL", 6000),
                        (u"CELULAR", 3000),
                        (u"TELEFONO", 3000),
                        (u"PROMEDIO TOTAL", 6000),
                        (u"ASIGNATURAS REPROBADAS", 3000),
                        (u"ASIGNATURAS APROBADAS", 6000),
                        (u"ESTADO FINAL", 3000),
                        (u"NÚMERO MATRICULAS", 3000),
                        (u"PASO AYUDA", 3000),
                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], font_style)
                        ws.col(col_num).width = columns[col_num][1]
                    cursor = connections['sga_select'].cursor()
                    idp = periodo.id.__str__()
                    sql = """
                        SELECT DISTINCT CASE WHEN carrera.mencion = '' THEN carrera.nombre ELSE (carrera.nombre || ' CON MENCION EN ' || carrera.mencion) END AS carrera, 
                         persona.cedula, persona.apellido1, persona.apellido2, persona.nombres, persona.email, persona.emailinst, persona.telefono, persona.telefono_conv,
                         (
                         SELECT AVG(asig.notafinal)
                         FROM sga_materiaasignada asig
                         INNER JOIN sga_materia mt ON mt.id=asig.materia_id
                         WHERE asig.matricula_id=matricula.id AND mt.esintroductoria=False
                         ) AS promediototal,
                         (
                          SELECT count(asig.estado_id)
                         FROM sga_materiaasignada asig
                         INNER JOIN sga_materia mt ON mt.id=asig.materia_id
                         WHERE asig.matricula_id=matricula.id AND asig.estado_id=2 AND mt.esintroductoria=False
                         ) AS asignaturas_reprobadas,
                         (
                           SELECT count(asig.estado_id)
                         FROM sga_materiaasignada asig
                         INNER JOIN sga_materia mt ON mt.id=asig.materia_id
                         WHERE asig.matricula_id=matricula.id AND asig.estado_id=1 AND mt.esintroductoria=False
                         ) AS asignaturas_aprobadas , matricula.id, materiaasig.matriculas, matricula.pasoayuda
                        FROM sga_materiaasignada materiaasig
                        INNER JOIN sga_evaluaciongenerica eval ON eval.materiaasignada_id=materiaasig.id
                        INNER JOIN sga_detallemodeloevaluativo detmod ON detmod.id=eval.detallemodeloevaluativo_id
                        INNER JOIN sga_materia materia ON materia.id = materiaasig.materia_id
                        INNER JOIN sga_nivel nivel ON nivel.id = materia.nivel_id
                        INNER JOIN sga_asignaturamalla asigmalla ON asigmalla.id = materia.asignaturamalla_id
                        INNER JOIN sga_malla malla ON malla.id = asigmalla.malla_id
                        INNER JOIN sga_carrera carrera ON carrera.id = malla.carrera_id
                        INNER JOIN sga_matricula matricula ON matricula.id = materiaasig.matricula_id
                        INNER JOIN sga_inscripcion inscripcion ON inscripcion.id = matricula.inscripcion_id
                        INNER JOIN sga_persona persona ON persona.id = inscripcion.persona_id
                        INNER JOIN sga_asignatura asignatura ON asignatura.id = materia.asignatura_id
                        INNER JOIN sga_nivelmalla nivelmalla ON nivelmalla.id = asigmalla.nivelmalla_id
                        INNER JOIN sga_tipoestado tipoestado ON tipoestado.id = materiaasig.estado_id
                        INNER JOIN sga_coordinacion_carrera coordinacioncarrera ON coordinacioncarrera.carrera_id = carrera.id
                        INNER JOIN sga_coordinacion coordinacion ON coordinacion.id = coordinacioncarrera.coordinacion_id
                        WHERE coordinacion.id IN(9) AND nivel.periodo_id = %s AND carrera.modalidad IN (3) AND materia.esintroductoria = FALSE AND matricula.estado_matricula in (2,3)
                        GROUP BY matricula.id,materia.id, coordinacion.nombre, carrera, persona.cedula, persona.apellido1, persona.apellido2, persona.nombres, persona.email, persona.emailinst, persona.telefono, persona.telefono_conv, materia,
                         materia.paralelo, nivelmalla.nombre, materiaasig.notafinal, materiaasig.asistenciafinal, tipoestado.nombre, materiaasig.matriculas
                         
                                        """ % (idp)
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    row_num = 4
                    for r in results:
                        campo1 = r[0]
                        campo2 = r[1]
                        campo3 = r[2]
                        campo4 = r[3]
                        campo5 = r[4]
                        campo6 = r[5]
                        campo7 = r[6]
                        campo8 = r[7]
                        campo9 = r[8]
                        campo10 = r[9]
                        campo11 = r[10]
                        campo12 = r[11]
                        campo13 = r[12]
                        campo14 = r[13]
                        campo15 = r[14]
                        estadofinal = "APROBADO"
                        matricula = Matricula.objects.get(id=campo13)
                        materiasasignadas = MateriaAsignada.objects.values_list('id', flat=True).filter(status=True,
                                                                                                        notafinal__lt=69.5,
                                                                                                        matricula=matricula,
                                                                                                        materia__esintroductoria=False)
                        if materiasasignadas.__len__() > 0:
                            estadofinal = "REPROBADO"
                        ws.write(row_num, 0, campo1.__str__(), font_style2)
                        ws.write(row_num, 1, campo2.__str__(), font_style2)
                        ws.write(row_num, 2, campo3.__str__(), font_style2)
                        ws.write(row_num, 3, campo4.__str__(), font_style2)
                        ws.write(row_num, 4, campo5.__str__(), font_style2)
                        ws.write(row_num, 5, campo6.__str__(), font_style2)
                        ws.write(row_num, 6, campo7.__str__(), font_style2)
                        ws.write(row_num, 7, campo8.__str__(), font_style2)
                        ws.write(row_num, 8, campo9.__str__(), font_style2)
                        ws.write(row_num, 9, campo10.__str__(), font_style2)
                        ws.write(row_num, 10, campo11.__str__(), font_style2)
                        ws.write(row_num, 11, campo12.__str__(), font_style2)
                        ws.write(row_num, 12, estadofinal.__str__(), font_style2)
                        ws.write(row_num, 13, campo14, font_style2)
                        ws.write(row_num, 14, campo15, font_style2)
                        row_num += 1
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'reportealumnocalificacionesadmisionpresencial':
                try:
                    __author__ = 'Unemi'
                    title = easyxf(
                        'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('todos alumnos')
                    ws.write_merge(0, 0, 0, 7, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                    response = HttpResponse(content_type="application/ms-excel")
                    response[
                        'Content-Disposition'] = 'attachment; filename=reporte_asignaturas_estudiantes_presencial_notas' + random.randint(
                        1, 10000).__str__() + '.xls'
                    columns = [
                        (u"CARRERA", 6000),
                        (u"CEDULA", 3000),
                        (u"PRIMER APELLIDO", 6000),
                        (u"SEGUNDO APELLIDO", 6000),
                        (u"NOMBRES", 6000),
                        (u"EMAIL", 6000),
                        (u"EMAIL INSTITUCIONAL", 6000),
                        (u"CELULAR", 3000),
                        (u"TELEFONO", 3000),
                        (u"MATERIA", 6000),
                        (u"PARALELO", 3000),
                        (u"GESTION", 6000),
                        (u"EXAMEN", 6000),
                        (u"NOTA FINAL", 3000),
                        (u"ASISTENCIA FINAL", 3000),
                        (u"ESTADO", 3000),
                        (u"ESTADO FINAL", 3000),
                        (u"NÚMERO MATRICULAS", 3000),
                        (u"AULA", 3000),
                        (u"PASO AYUDA", 3000),
                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], font_style)
                        ws.col(col_num).width = columns[col_num][1]
                    cursor = connections['sga_select'].cursor()
                    idp = periodo.id.__str__()
                    sql = """
                        SELECT DISTINCT 
                        CASE WHEN carrera.mencion = '' THEN carrera.nombre ELSE (carrera.nombre || ' CON MENCION EN ' || carrera.mencion) END AS carrera, 
                         persona.cedula, persona.apellido1, persona.apellido2, persona.nombres, persona.email, persona.emailinst, persona.telefono, persona.telefono_conv, 
                         (asignatura.nombre || CASE WHEN materia.alias = '' THEN '' ELSE (' - ('|| materia.alias || ')') END || CASE WHEN materia.identificacion = '' THEN '' ELSE (' - ['|| materia.identificacion || ']') END) AS materia, 
                         materia.paralelo AS paralelo, 
                         (
                        SELECT SUM (evalge.valor)
                        FROM sga_materiaasignada A
                        INNER JOIN sga_matricula B ON A.matricula_id = B.id
                        INNER JOIN sga_nivel niv ON niv.id=B.nivel_id
                        INNER JOIN sga_periodo per ON per.id=niv.periodo_id
                        INNER JOIN sga_inscripcion ins ON B.inscripcion_id=ins.id
                        INNER JOIN sga_evaluaciongenerica evalge ON evalge.materiaasignada_id=A.id 
                        INNER JOIN sga_detallemodeloevaluativo deta ON deta.id=evalge.detallemodeloevaluativo_id
                        INNER JOIN sga_modeloevaluativo model ON model.id=deta.modelo_id
                        WHERE per.id=%s AND deta.id IN (77,78,79,80,63,64,65) AND B.id=matricula.id AND A.materia_id=materia.id
                        ) AS gestion,
                         (
                        SELECT SUM (evalge.valor)
                        FROM sga_materiaasignada A
                        INNER JOIN sga_matricula B ON A.matricula_id = B.id
                        INNER JOIN sga_nivel niv ON niv.id=B.nivel_id
                        INNER JOIN sga_periodo per ON per.id=niv.periodo_id
                        INNER JOIN sga_inscripcion ins ON B.inscripcion_id=ins.id
                        INNER JOIN sga_evaluaciongenerica evalge ON evalge.materiaasignada_id=A.id 
                        INNER JOIN sga_detallemodeloevaluativo deta ON deta.id=evalge.detallemodeloevaluativo_id
                        INNER JOIN sga_modeloevaluativo model ON model.id=deta.modelo_id
                        WHERE per.id=%s AND deta.id IN (81,66) AND B.id=matricula.id AND A.materia_id=materia.id
                        ) AS examen, materiaasig.notafinal AS notafinal,materiaasig.asistenciafinal ,
                        tipoestado.nombre AS estado,matricula.id, 
                        materiaasig.matriculas AS cant_matriculas, 
                         (
                         SELECT  aula.nombre
                         FROM sga_materia materi
                        INNER JOIN sga_clase clase ON clase.materia_id=materi.id
                        INNER JOIN sga_aula aula ON aula.id=clase.aula_id
                        WHERE materi.id=materia.id
                        LIMIT 1
                        ) as aula, matricula.pasoayuda
                        FROM sga_materiaasignada materiaasig
                        INNER JOIN sga_evaluaciongenerica eval ON eval.materiaasignada_id=materiaasig.id
                        INNER JOIN sga_detallemodeloevaluativo detmod ON detmod.id=eval.detallemodeloevaluativo_id
                        INNER JOIN sga_materia materia ON materia.id = materiaasig.materia_id
                        INNER JOIN sga_nivel nivel ON nivel.id = materia.nivel_id
                        INNER JOIN sga_asignaturamalla asigmalla ON asigmalla.id = materia.asignaturamalla_id
                        INNER JOIN sga_malla malla ON malla.id = asigmalla.malla_id
                        INNER JOIN sga_carrera carrera ON carrera.id = malla.carrera_id
                        INNER JOIN sga_matricula matricula ON matricula.id = materiaasig.matricula_id
                        INNER JOIN sga_inscripcion inscripcion ON inscripcion.id = matricula.inscripcion_id
                        INNER JOIN sga_persona persona ON persona.id = inscripcion.persona_id
                        INNER JOIN sga_asignatura asignatura ON asignatura.id = materia.asignatura_id
                        INNER JOIN sga_nivelmalla nivelmalla ON nivelmalla.id = asigmalla.nivelmalla_id
                        INNER JOIN sga_tipoestado tipoestado ON tipoestado.id = materiaasig.estado_id
                        INNER JOIN sga_coordinacion_carrera coordinacioncarrera ON coordinacioncarrera.carrera_id = carrera.id
                        INNER JOIN sga_coordinacion coordinacion ON coordinacion.id = coordinacioncarrera.coordinacion_id
                        WHERE coordinacion.id IN(9) AND nivel.periodo_id = %s  AND carrera.modalidad IN (1,2) 
                        AND materia.esintroductoria = FALSE AND matricula.estado_matricula in (2,3)
                        GROUP BY matricula.id,materia.id, coordinacion.nombre, carrera, persona.cedula, persona.apellido1, persona.apellido2, persona.nombres, persona.email, persona.emailinst, persona.telefono, persona.telefono_conv, materia,
                         materia.paralelo, nivelmalla.nombre, materiaasig.notafinal, materiaasig.asistenciafinal, tipoestado.nombre, materiaasig.matriculas 

                    """ % (idp, idp, idp)
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    row_num = 4
                    for r in results:
                        i = 0
                        campo1 = r[0]
                        campo2 = r[1]
                        campo3 = r[2]
                        campo4 = r[3]
                        campo5 = r[4]
                        campo6 = r[5]
                        campo7 = r[6]
                        campo8 = r[7]
                        campo9 = r[8]
                        campo10 = r[9]
                        campo11 = r[10]
                        campo12 = r[11]
                        campo13 = r[12]
                        campo14 = r[13]
                        campo15 = r[14]
                        campo16 = r[15]
                        campo17 = r[16]
                        campo18 = r[17]
                        campo19 = r[18]
                        campo20 = r[19]

                        estadofinal = "APROBADO"
                        matricula = Matricula.objects.get(id=campo17)
                        materiasasignadas = MateriaAsignada.objects.values_list('id', flat=True).filter(status=True,
                                                                                                        notafinal__lt=69.5,
                                                                                                        matricula=matricula,
                                                                                                        materia__esintroductoria=False)
                        if materiasasignadas.__len__() > 0:
                            estadofinal = "REPROBADO"
                        ws.write(row_num, 0, campo1.__str__(), font_style2)
                        ws.write(row_num, 1, campo2.__str__(), font_style2)
                        ws.write(row_num, 2, campo3.__str__(), font_style2)
                        ws.write(row_num, 3, campo4.__str__(), font_style2)
                        ws.write(row_num, 4, campo5.__str__(), font_style2)
                        ws.write(row_num, 5, campo6.__str__(), font_style2)
                        ws.write(row_num, 6, campo7.__str__(), font_style2)
                        ws.write(row_num, 7, campo8.__str__(), font_style2)
                        ws.write(row_num, 8, campo9.__str__(), font_style2)
                        ws.write(row_num, 9, campo10.__str__(), font_style2)
                        ws.write(row_num, 10, campo11.__str__(), font_style2)
                        ws.write(row_num, 11, campo12.__str__(), font_style2)
                        ws.write(row_num, 12, campo13.__str__(), font_style2)
                        ws.write(row_num, 13, campo14.__str__(), font_style2)
                        ws.write(row_num, 14, campo15.__str__(), font_style2)
                        ws.write(row_num, 15, campo16.__str__(), font_style2)
                        ws.write(row_num, 16, estadofinal, font_style2)
                        ws.write(row_num, 17, campo18, font_style2)
                        ws.write(row_num, 18, campo19, font_style2)
                        ws.write(row_num, 19, campo20, font_style2)
                        row_num += 1

                    ws = wb.add_sheet('alumnos reprobados')
                    ws.write_merge(0, 0, 0, 7, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                    response = HttpResponse(content_type="application/ms-excel")
                    response[
                        'Content-Disposition'] = 'attachment; filename=reporte_asignaturas_estudiantes_presencial_notas' + random.randint(
                        1, 10000).__str__() + '.xls'
                    columns = [
                        (u"CARRERA", 6000),
                        (u"CEDULA", 3000),
                        (u"PRIMER APELLIDO", 6000),
                        (u"SEGUNDO APELLIDO", 6000),
                        (u"NOMBRES", 6000),
                        (u"EMAIL", 6000),
                        (u"EMAIL INSTITUCIONAL", 6000),
                        (u"CELULAR", 3000),
                        (u"TELEFONO", 3000),
                        (u"PROMEDIO TOTAL", 6000),
                        (u"ASIGNATURAS REPROBADAS", 3000),
                        (u"ASIGNATURAS APROBADAS", 6000),
                        (u"ESTADO FINAL", 3000),
                        (u"NUMERO MATRICULAS", 3000),
                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], font_style)
                        ws.col(col_num).width = columns[col_num][1]
                    cursor = connections['sga_select'].cursor()
                    idp = periodo.id.__str__()
                    sql = """
                                            SELECT DISTINCT CASE WHEN carrera.mencion = '' THEN carrera.nombre ELSE (carrera.nombre || ' CON MENCION EN ' || carrera.mencion) END AS carrera, 
                                             persona.cedula, persona.apellido1, persona.apellido2, persona.nombres, persona.email, persona.emailinst, persona.telefono, persona.telefono_conv,
                                             (
                                             SELECT AVG(asig.notafinal)
                                             FROM sga_materiaasignada asig
                                             INNER JOIN sga_materia mt ON mt.id=asig.materia_id
                                             WHERE asig.matricula_id=matricula.id AND mt.esintroductoria=False
                                             ) AS promediototal,
                                             (
                                              SELECT count(asig.estado_id)
                                             FROM sga_materiaasignada asig
                                             INNER JOIN sga_materia mt ON mt.id=asig.materia_id
                                             WHERE asig.matricula_id=matricula.id AND asig.estado_id=2 AND mt.esintroductoria=False
                                             ) AS asignaturas_reprobadas,
                                             (
                                               SELECT count(asig.estado_id)
                                             FROM sga_materiaasignada asig
                                             INNER JOIN sga_materia mt ON mt.id=asig.materia_id
                                             WHERE asig.matricula_id=matricula.id AND asig.estado_id=1 AND mt.esintroductoria=False
                                             ) AS asignaturas_aprobadas , matricula.id, materiaasig.matriculas, matricula.pasoayuda
                                            FROM sga_materiaasignada materiaasig
                                            INNER JOIN sga_evaluaciongenerica eval ON eval.materiaasignada_id=materiaasig.id
                                            INNER JOIN sga_detallemodeloevaluativo detmod ON detmod.id=eval.detallemodeloevaluativo_id
                                            INNER JOIN sga_materia materia ON materia.id = materiaasig.materia_id
                                            INNER JOIN sga_nivel nivel ON nivel.id = materia.nivel_id
                                            INNER JOIN sga_asignaturamalla asigmalla ON asigmalla.id = materia.asignaturamalla_id
                                            INNER JOIN sga_malla malla ON malla.id = asigmalla.malla_id
                                            INNER JOIN sga_carrera carrera ON carrera.id = malla.carrera_id
                                            INNER JOIN sga_matricula matricula ON matricula.id = materiaasig.matricula_id
                                            INNER JOIN sga_inscripcion inscripcion ON inscripcion.id = matricula.inscripcion_id
                                            INNER JOIN sga_persona persona ON persona.id = inscripcion.persona_id
                                            INNER JOIN sga_asignatura asignatura ON asignatura.id = materia.asignatura_id
                                            INNER JOIN sga_nivelmalla nivelmalla ON nivelmalla.id = asigmalla.nivelmalla_id
                                            INNER JOIN sga_tipoestado tipoestado ON tipoestado.id = materiaasig.estado_id
                                            INNER JOIN sga_coordinacion_carrera coordinacioncarrera ON coordinacioncarrera.carrera_id = carrera.id
                                            INNER JOIN sga_coordinacion coordinacion ON coordinacion.id = coordinacioncarrera.coordinacion_id
                                            WHERE coordinacion.id IN(9) AND nivel.periodo_id = %s  AND carrera.modalidad IN (1,2) AND materia.esintroductoria = FALSE AND matricula.estado_matricula in (2,3)
                                            GROUP BY matricula.id,materia.id, coordinacion.nombre, carrera, persona.cedula, persona.apellido1, persona.apellido2, persona.nombres, persona.email, persona.emailinst, persona.telefono, persona.telefono_conv, materia,
                                             materia.paralelo, nivelmalla.nombre, materiaasig.notafinal, materiaasig.asistenciafinal, tipoestado.nombre, materiaasig.matriculas
                                        
                                                            """ % (idp)
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    row_num = 4
                    for r in results:
                        campo1 = r[0]
                        campo2 = r[1]
                        campo3 = r[2]
                        campo4 = r[3]
                        campo5 = r[4]
                        campo6 = r[5]
                        campo7 = r[6]
                        campo8 = r[7]
                        campo9 = r[8]
                        campo10 = r[9]
                        campo11 = r[10]
                        campo12 = r[11]
                        campo13 = r[12]
                        campo14 = r[13]
                        campo15 = r[14]
                        estadofinal = "APROBADO"
                        matricula = Matricula.objects.get(id=campo13)
                        materiasasignadas = MateriaAsignada.objects.values_list('id', flat=True).filter(status=True,
                                                                                                        notafinal__lt=69.5,
                                                                                                        matricula=matricula,
                                                                                                        materia__esintroductoria=False)
                        if materiasasignadas.__len__() > 0:
                            estadofinal = "REPROBADO"
                        ws.write(row_num, 0, campo1.__str__(), font_style2)
                        ws.write(row_num, 1, campo2.__str__(), font_style2)
                        ws.write(row_num, 2, campo3.__str__(), font_style2)
                        ws.write(row_num, 3, campo4.__str__(), font_style2)
                        ws.write(row_num, 4, campo5.__str__(), font_style2)
                        ws.write(row_num, 5, campo6.__str__(), font_style2)
                        ws.write(row_num, 6, campo7.__str__(), font_style2)
                        ws.write(row_num, 7, campo8.__str__(), font_style2)
                        ws.write(row_num, 8, campo9.__str__(), font_style2)
                        ws.write(row_num, 9, campo10.__str__(), font_style2)
                        ws.write(row_num, 10, campo11.__str__(), font_style2)
                        ws.write(row_num, 11, campo12.__str__(), font_style2)
                        ws.write(row_num, 12, estadofinal.__str__(), font_style2)
                        ws.write(row_num, 13, campo14.__str__(), font_style2)
                        ws.write(row_num, 14, campo15.__str__(), font_style2)
                        row_num += 1
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'reportealumnocalificacionespregradovirtual':
                try:
                    __author__ = 'Unemi'
                    title = easyxf(
                        'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('exp_xls_post_part')
                    ws.write_merge(0, 0, 0, 7, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                    response = HttpResponse(content_type="application/ms-excel")
                    response[
                        'Content-Disposition'] = 'attachment; filename=reporte_asignaturas_estudiantes_notas' + random.randint(
                        1, 10000).__str__() + '.xls'
                    columns = [
                        (u"CARRERA", 6000),
                        (u"CEDULA", 3000),
                        (u"PRIMER APELLIDO", 6000),
                        (u"SEGUNDO APELLIDO", 6000),
                        (u"NOMBRES", 6000),
                        (u"EMAIL", 6000),
                        (u"EMAIL INSTITUCIONAL", 6000),
                        (u"CELULAR", 3000),
                        (u"TELEFONO", 3000),
                        (u"MATERIA", 6000),
                        (u"PARALELO", 3000),
                        (u"N1", 6000),
                        (u"N2", 6000),
                        (u"EX1", 6000),
                        (u"P1", 6000),
                        (u"N3", 6000),
                        (u"N4", 6000),
                        (u"EX2", 6000),
                        (u"P2", 6000),
                        (u"NOTA FINAL", 6000),
                        (u"ASISTENCIA FINAL", 6000),
                        (u"ESTADO", 6000),
                        (u"SEXO", 6000),
                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], font_style)
                        ws.col(col_num).width = columns[col_num][1]
                    cursor = connections['sga_select'].cursor()
                    idp = periodo.id.__str__()
                    sql = """
                        SELECT DISTINCT 
                        CASE WHEN carrera.mencion = '' THEN carrera.nombre ELSE (carrera.nombre || ' CON MENCION EN ' || carrera.mencion) END AS carrera, 
                         persona.cedula, persona.apellido1, persona.apellido2, persona.nombres, persona.email, persona.emailinst, persona.telefono, persona.telefono_conv, 
                         (asignatura.nombre || CASE WHEN materia.alias = '' THEN '' ELSE (' - ('|| materia.alias || ')') END || CASE WHEN materia.identificacion = '' THEN '' ELSE (' - ['|| materia.identificacion || ']') END) AS materia, 
                         materia.paralelo AS paralelo, 
                         (
                        SELECT SUM (evalge.valor)
                        FROM sga_materiaasignada A
                        INNER JOIN sga_matricula B ON A.matricula_id = B.id
                        INNER JOIN sga_nivel niv ON niv.id=B.nivel_id
                        INNER JOIN sga_periodo per ON per.id=niv.periodo_id
                        INNER JOIN sga_inscripcion ins ON B.inscripcion_id=ins.id
                        INNER JOIN sga_evaluaciongenerica evalge ON evalge.materiaasignada_id=A.id 
                        INNER JOIN sga_detallemodeloevaluativo deta ON deta.id=evalge.detallemodeloevaluativo_id
                        INNER JOIN sga_modeloevaluativo model ON model.id=deta.modelo_id
                        WHERE per.id=%s AND deta.id IN (31) AND B.id=matricula.id AND A.materia_id=materia.id
                        ) AS N1,
                          (
                        SELECT SUM (evalge.valor)
                        FROM sga_materiaasignada A
                        INNER JOIN sga_matricula B ON A.matricula_id = B.id
                        INNER JOIN sga_nivel niv ON niv.id=B.nivel_id
                        INNER JOIN sga_periodo per ON per.id=niv.periodo_id
                        INNER JOIN sga_inscripcion ins ON B.inscripcion_id=ins.id
                        INNER JOIN sga_evaluaciongenerica evalge ON evalge.materiaasignada_id=A.id 
                        INNER JOIN sga_detallemodeloevaluativo deta ON deta.id=evalge.detallemodeloevaluativo_id
                        INNER JOIN sga_modeloevaluativo model ON model.id=deta.modelo_id
                        WHERE per.id=%s AND deta.id IN (32) AND B.id=matricula.id AND A.materia_id=materia.id
                        ) AS N2,
                         (
                        SELECT SUM (evalge.valor)
                        FROM sga_materiaasignada A
                        INNER JOIN sga_matricula B ON A.matricula_id = B.id
                        INNER JOIN sga_nivel niv ON niv.id=B.nivel_id
                        INNER JOIN sga_periodo per ON per.id=niv.periodo_id
                        INNER JOIN sga_inscripcion ins ON B.inscripcion_id=ins.id
                        INNER JOIN sga_evaluaciongenerica evalge ON evalge.materiaasignada_id=A.id 
                        INNER JOIN sga_detallemodeloevaluativo deta ON deta.id=evalge.detallemodeloevaluativo_id
                        INNER JOIN sga_modeloevaluativo model ON model.id=deta.modelo_id
                        WHERE per.id=%s AND deta.id IN (33) AND B.id=matricula.id AND A.materia_id=materia.id
                        ) AS EX1,
                         (
                        SELECT SUM (evalge.valor)
                        FROM sga_materiaasignada A
                        INNER JOIN sga_matricula B ON A.matricula_id = B.id
                        INNER JOIN sga_nivel niv ON niv.id=B.nivel_id
                        INNER JOIN sga_periodo per ON per.id=niv.periodo_id
                        INNER JOIN sga_inscripcion ins ON B.inscripcion_id=ins.id
                        INNER JOIN sga_evaluaciongenerica evalge ON evalge.materiaasignada_id=A.id 
                        INNER JOIN sga_detallemodeloevaluativo deta ON deta.id=evalge.detallemodeloevaluativo_id
                        INNER JOIN sga_modeloevaluativo model ON model.id=deta.modelo_id
                        WHERE per.id=%s AND deta.id IN (34) AND B.id=matricula.id AND A.materia_id=materia.id
                        ) AS P1,
                         (
                        SELECT SUM (evalge.valor)
                        FROM sga_materiaasignada A
                        INNER JOIN sga_matricula B ON A.matricula_id = B.id
                        INNER JOIN sga_nivel niv ON niv.id=B.nivel_id
                        INNER JOIN sga_periodo per ON per.id=niv.periodo_id
                        INNER JOIN sga_inscripcion ins ON B.inscripcion_id=ins.id
                        INNER JOIN sga_evaluaciongenerica evalge ON evalge.materiaasignada_id=A.id 
                        INNER JOIN sga_detallemodeloevaluativo deta ON deta.id=evalge.detallemodeloevaluativo_id
                        INNER JOIN sga_modeloevaluativo model ON model.id=deta.modelo_id
                        WHERE per.id=%s AND deta.id IN (35) AND B.id=matricula.id AND A.materia_id=materia.id
                        ) AS N3,
                         (
                        SELECT SUM (evalge.valor)
                        FROM sga_materiaasignada A
                        INNER JOIN sga_matricula B ON A.matricula_id = B.id
                        INNER JOIN sga_nivel niv ON niv.id=B.nivel_id
                        INNER JOIN sga_periodo per ON per.id=niv.periodo_id
                        INNER JOIN sga_inscripcion ins ON B.inscripcion_id=ins.id
                        INNER JOIN sga_evaluaciongenerica evalge ON evalge.materiaasignada_id=A.id 
                        INNER JOIN sga_detallemodeloevaluativo deta ON deta.id=evalge.detallemodeloevaluativo_id
                        INNER JOIN sga_modeloevaluativo model ON model.id=deta.modelo_id
                        WHERE per.id=%s AND deta.id IN (36) AND B.id=matricula.id AND A.materia_id=materia.id
                        ) AS N4,
                        
                          (
                        SELECT SUM (evalge.valor)
                        FROM sga_materiaasignada A
                        INNER JOIN sga_matricula B ON A.matricula_id = B.id
                        INNER JOIN sga_nivel niv ON niv.id=B.nivel_id
                        INNER JOIN sga_periodo per ON per.id=niv.periodo_id
                        INNER JOIN sga_inscripcion ins ON B.inscripcion_id=ins.id
                        INNER JOIN sga_evaluaciongenerica evalge ON evalge.materiaasignada_id=A.id 
                        INNER JOIN sga_detallemodeloevaluativo deta ON deta.id=evalge.detallemodeloevaluativo_id
                        INNER JOIN sga_modeloevaluativo model ON model.id=deta.modelo_id
                        WHERE per.id=%s AND deta.id IN (37) AND B.id=matricula.id AND A.materia_id=materia.id
                        ) AS EX2 ,
                         (
                        SELECT SUM (evalge.valor)
                        FROM sga_materiaasignada A
                        INNER JOIN sga_matricula B ON A.matricula_id = B.id
                        INNER JOIN sga_nivel niv ON niv.id=B.nivel_id
                        INNER JOIN sga_periodo per ON per.id=niv.periodo_id
                        INNER JOIN sga_inscripcion ins ON B.inscripcion_id=ins.id
                        INNER JOIN sga_evaluaciongenerica evalge ON evalge.materiaasignada_id=A.id 
                        INNER JOIN sga_detallemodeloevaluativo deta ON deta.id=evalge.detallemodeloevaluativo_id
                        INNER JOIN sga_modeloevaluativo model ON model.id=deta.modelo_id
                        WHERE per.id=%s AND deta.id IN (38) AND B.id=matricula.id AND A.materia_id=materia.id
                        ) AS P2
                         , materiaasig.notafinal AS notafinal, tipoestado.nombre AS estado,(select gen.nombre from sga_sexo as gen where gen.id=persona.sexo_id) as sexo
                        FROM sga_materiaasignada materiaasig
                        INNER JOIN sga_evaluaciongenerica eval ON eval.materiaasignada_id=materiaasig.id
                        INNER JOIN sga_detallemodeloevaluativo detmod ON detmod.id=eval.detallemodeloevaluativo_id
                        INNER JOIN sga_materia materia ON materia.id = materiaasig.materia_id
                        INNER JOIN sga_nivel nivel ON nivel.id = materia.nivel_id
                        INNER JOIN sga_asignaturamalla asigmalla ON asigmalla.id = materia.asignaturamalla_id
                        INNER JOIN sga_malla malla ON malla.id = asigmalla.malla_id
                        INNER JOIN sga_carrera carrera ON carrera.id = malla.carrera_id
                        INNER JOIN sga_matricula matricula ON matricula.id = materiaasig.matricula_id
                        INNER JOIN sga_inscripcion inscripcion ON inscripcion.id = matricula.inscripcion_id
                        INNER JOIN sga_persona persona ON persona.id = inscripcion.persona_id
                        INNER JOIN sga_asignatura asignatura ON asignatura.id = materia.asignatura_id
                        INNER JOIN sga_nivelmalla nivelmalla ON nivelmalla.id = asigmalla.nivelmalla_id
                        INNER JOIN sga_tipoestado tipoestado ON tipoestado.id = materiaasig.estado_id
                        INNER JOIN sga_coordinacion_carrera coordinacioncarrera ON coordinacioncarrera.carrera_id = carrera.id
                        INNER JOIN sga_coordinacion coordinacion ON coordinacion.id = coordinacioncarrera.coordinacion_id
                        WHERE nivel.periodo_id = %s AND matricula.estado_matricula in (2,3)
                        AND detmod.id IN (31, 32, 33, 34, 35, 36, 37, 38,39) AND carrera.id IN (133, 134, 129, 127, 135, 131, 130, 126, 128, 132)
                        AND materia.esintroductoria = FALSE 
                        GROUP BY matricula.id,materia.id, coordinacion.nombre, carrera, persona.cedula, persona.apellido1, persona.apellido2, persona.nombres, persona.email, persona.emailinst, persona.telefono, persona.telefono_conv, materia,
                         materia.paralelo, nivelmalla.nombre, materiaasig.notafinal, materiaasig.asistenciafinal, tipoestado.nombre, materia.id ,sexo

                    """ % (idp, idp, idp, idp, idp, idp, idp, idp, idp)
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    row_num = 4
                    for r in results:
                        i = 0
                        campo1 = r[0]
                        campo2 = r[1]
                        campo3 = r[2]
                        campo4 = r[3]
                        campo5 = r[4]
                        campo6 = r[5]
                        campo7 = r[6]
                        campo8 = r[7]
                        campo9 = r[8]
                        campo10 = r[9]
                        campo11 = r[10]
                        campo12 = r[11]
                        campo13 = r[12]
                        campo14 = r[13]
                        campo15 = r[14]
                        campo16 = r[15]
                        campo17 = r[16]
                        campo18 = r[17]
                        campo19 = r[18]
                        campo20 = r[19]
                        campo21 = r[20]
                        campo22 = r[21]
                        estadofinal = "APROBADO"
                        if campo20 < 69.5:
                            estadofinal = "REPROBADO"
                        ws.write(row_num, 0, campo1.__str__(), font_style2)
                        ws.write(row_num, 1, campo2.__str__(), font_style2)
                        ws.write(row_num, 2, campo3.__str__(), font_style2)
                        ws.write(row_num, 3, campo4.__str__(), font_style2)
                        ws.write(row_num, 4, campo5.__str__(), font_style2)
                        ws.write(row_num, 5, campo6.__str__(), font_style2)
                        ws.write(row_num, 6, campo7.__str__(), font_style2)
                        ws.write(row_num, 7, campo8.__str__(), font_style2)
                        ws.write(row_num, 8, campo9.__str__(), font_style2)
                        ws.write(row_num, 9, campo10.__str__(), font_style2)
                        ws.write(row_num, 10, campo11.__str__(), font_style2)
                        ws.write(row_num, 11, campo12.__str__(), font_style2)
                        ws.write(row_num, 12, campo13.__str__(), font_style2)
                        ws.write(row_num, 13, campo14.__str__(), font_style2)
                        ws.write(row_num, 14, campo15.__str__(), font_style2)
                        ws.write(row_num, 15, campo16.__str__(), font_style2)
                        ws.write(row_num, 16, campo17.__str__(), font_style2)
                        ws.write(row_num, 17, campo18.__str__(), font_style2)
                        ws.write(row_num, 18, campo19.__str__(), font_style2)
                        ws.write(row_num, 19, campo20.__str__(), font_style2)
                        ws.write(row_num, 20, campo21.__str__(), font_style2)
                        ws.write(row_num, 21, estadofinal.__str__(), font_style2)
                        ws.write(row_num, 22, campo22.__str__(), font_style2)
                        row_num += 1
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'reportealumnospre':
                try:
                    periodo = request.GET['periodo']
                    __author__ = 'Unemi'
                    title = easyxf(
                        'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('exp_xls_post_part')
                    ws.write_merge(0, 0, 0, 7, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=exp_xls_post_part_' + random.randint(1,
                                                                                                                 10000).__str__() + '.xls'
                    columns = [
                        (u"FACULTAD", 6000),
                        (u"CARRERA", 6000),
                        (u"SECCION", 6000),
                        (u"NIVEL", 6000),
                        (u"ASIGNATURA", 6000),
                        (u"CEDULA", 6000),
                        (u"ALUMNO", 6000),
                        (u"NOTA FINAL", 6000),
                        (u"PROMEDIO", 6000),
                        (u"ASISTENCIA", 6000),
                        (u"ESTADO", 6000),
                        (u"DOCENTE", 6000),
                        (u"TELEFONO", 6000),
                        (u"EMAIL", 6000),
                        (u"EMAIL INST", 6000),
                        (u"CIUDAD", 6000),
                        (u"DIRECCION", 12000),
                        (u"PARALELO", 12000)
                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], font_style)
                        ws.col(col_num).width = columns[col_num][1]
                    cursor = connections['sga_select'].cursor()
                    sql = "SELECT DISTINCT " \
                          "   sga_coordinacion.nombre as sga_coordinacion_nombre, " \
                          "   sga_carrera.nombre AS sga_carrera_nombre, " \
                          "   sga_sesion.nombre AS sga_sesion_nombre, " \
                          "   sga_nivelmalla.nombre as sga_nivelmalla_nombre, " \
                          "   sga_asignatura.nombre as sga_asignatura_nombre, " \
                          "   sga_persona.apellido1 || ' ' || sga_persona.apellido2  || ' ' ||  sga_persona.nombres AS sga_persona_nombres, " \
                          "   sga_materiaasignada.notafinal as notafinal, " \
                          "   sga_materiaasignada.asistenciafinal as asistenciafinal, " \
                          "   (select p.apellido1 || ' ' || p.apellido2 || ' ' || p.nombres from sga_persona p where p.id=sga_profesor.persona_id) as docente, " \
                          "   sga_tipoestado.nombre as estado, " \
                          "   sga_nivelmalla.id as sga_nivelmalla_id," \
                          "   sga_persona.telefono, sga_persona.email, sga_persona.emailinst, sga_persona.ciudad, " \
                          "   sga_persona.direccion || ', ' || sga_persona.direccion2 || ' #:' || sga_persona.num_direccion || ' , SECTOR:' || sga_persona.sector as direccion, sga_materia.paralelo, " \
                          " (select sum((case when a1.id = '1939' then(ma1.notafinal * 0.15) else (case when mo1.id = 4 then(ma1.notafinal * 0.10) else (ma1.notafinal * 0.25) end) end) ) " \
                          " from sga_materiaasignada ma1, sga_materia m1, sga_modeloevaluativo mo1, sga_asignatura a1 where ma1.matricula_id = sga_matricula.id and ma1.status = true and m1.id = ma1.materia_id and m1.status = true " \
                          " and mo1.id = m1.modeloevaluativo_id and mo1.status = true and a1.id = m1.asignatura_id and a1.status = true) as notapromedio, sga_persona.cedula " \
                          " FROM sga_persona sga_persona " \
                          "      RIGHT OUTER JOIN sga_inscripcion sga_inscripcion ON sga_persona.id = sga_inscripcion.persona_id " \
                          "     INNER JOIN sga_matricula sga_matricula ON sga_matricula.inscripcion_id=sga_inscripcion.id " \
                          "    inner join sga_materiaasignada sga_materiaasignada on sga_materiaasignada.matricula_id=sga_matricula.id " \
                          "     inner join sga_materia sga_materia on sga_materia.id=sga_materiaasignada.materia_id " \
                          "     LEFT join sga_profesormateria on sga_profesormateria.materia_id=sga_materia.id " \
                          "     LEFT join sga_profesor on sga_profesor.id=sga_profesormateria.profesor_id " \
                          "     inner join sga_asignatura sga_asignatura on sga_asignatura.id=sga_materia.asignatura_id " \
                          "      inner join sga_asignaturamalla sga_asignaturamalla on sga_asignaturamalla.id=sga_materia.asignaturamalla_id " \
                          "    inner join sga_nivel sga_nivel ON sga_nivel.id=sga_matricula.nivel_id and sga_nivel.periodo_id= '" + periodo + "' " \
                                                                                                                                              "      inner join sga_nivelmalla sga_nivelmalla on sga_nivelmalla.id=sga_asignaturamalla.nivelmalla_id " \
                                                                                                                                              "     INNER JOIN sga_carrera sga_carrera ON sga_inscripcion.carrera_id = sga_carrera.id " \
                                                                                                                                              "     INNER JOIN sga_coordinacion_carrera on sga_coordinacion_carrera.carrera_id=sga_carrera.id " \
                                                                                                                                              "     INNER JOIN sga_coordinacion on sga_coordinacion.id=sga_coordinacion_carrera.coordinacion_id " \
                                                                                                                                              "     INNER JOIN sga_modalidad sga_modalidad ON sga_inscripcion.modalidad_id = sga_modalidad.id " \
                                                                                                                                              "     INNER JOIN sga_sesion sga_sesion ON sga_inscripcion.sesion_id = sga_sesion.id " \
                                                                                                                                              "     inner join sga_tipoestado on sga_tipoestado.id=sga_materiaasignada.estado_id " \
                                                                                                                                              "    where sga_matricula.id not in (select ma.id from (select mat.id as id, count(ma.materia_id)  as numero " \
                                                                                                                                              "    from sga_Matricula mat, sga_Nivel n, sga_materiaasignada  ma, sga_materia mate, sga_asignatura asi " \
                                                                                                                                              "    where mat.nivel_id = n.id and mat.id = ma.matricula_id and ma.materia_id = mate.id and mate.asignatura_id = asi.id and n.periodo_id = '" + periodo + "' " \
                                                                                                                                                                                                                                                                                                        "    and asi.modulo = True group by mat.id)  ma, (select mat.id as id, count(ma.materia_id) as numero from sga_Matricula mat, sga_Nivel n, sga_materiaasignada ma, " \
                                                                                                                                                                                                                                                                                                        "    sga_materia mate, sga_asignatura asi where mat.nivel_id = n.id and mat.id = ma.matricula_id and ma.materia_id = mate.id and mate.asignatura_id = asi.id and n.periodo_id = '" + periodo + "' " \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "    group by mat.id) mo where ma.id = mo.id and ma.numero = mo.numero) order by sga_carrera.nombre,sga_nivelmalla.id,sga_sesion.nombre,sga_persona_nombres"
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    row_num = 4
                    for r in results:
                        i = 0
                        campo1 = r[0]
                        campo2 = r[1]
                        campo3 = r[2]
                        campo4 = r[3]
                        campo5 = r[4]
                        campo6 = r[5]
                        campo7 = r[6]
                        campo8 = r[7]
                        campo9 = r[8]
                        campo10 = r[9]
                        campo11 = r[11]
                        campo12 = r[12]
                        campo13 = r[13]
                        campo14 = r[14]
                        campo15 = r[15]
                        campo16 = r[16]
                        campo17 = round(r[17], 0)
                        campo18 = r[18]
                        ws.write(row_num, 0, campo1, font_style2)
                        ws.write(row_num, 1, campo2, font_style2)
                        ws.write(row_num, 2, campo3, font_style2)
                        ws.write(row_num, 3, campo4, font_style2)
                        ws.write(row_num, 4, campo5, font_style2)
                        ws.write(row_num, 5, campo18, font_style2)
                        ws.write(row_num, 6, campo6, font_style2)
                        ws.write(row_num, 7, campo7, font_style2)
                        ws.write(row_num, 8, campo17, font_style2)
                        ws.write(row_num, 9, campo8, font_style2)
                        ws.write(row_num, 10, campo10, font_style2)
                        ws.write(row_num, 11, campo9, font_style2)
                        ws.write(row_num, 12, campo11, font_style2)
                        ws.write(row_num, 13, campo12, font_style2)
                        ws.write(row_num, 14, campo13, font_style2)
                        ws.write(row_num, 15, campo14, font_style2)
                        ws.write(row_num, 16, campo15, font_style2)
                        ws.write(row_num, 17, campo16, font_style2)
                        row_num += 1
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'reporteprematriculados':
                try:
                    idcarrera = request.GET['id']
                    cursor = connections['sga_select'].cursor()
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=prematricula_asignaturas.xls'
                    __author__ = 'Unemi'
                    style0 = easyxf('font: name Times New Roman, color-index blue, bold off', num_format_str='#,##0.00')
                    style_nb = easyxf('font: name Times New Roman, color-index blue, bold on',
                                      num_format_str='#,##0.00')
                    style_sb = easyxf('font: name Times New Roman, color-index blue, bold on')
                    title = easyxf(
                        'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    style1 = easyxf(num_format_str='D-MMM-YY')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('exp_xls_post_part')
                    # ws.write_merge(0, 0, 0, 10, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)

                    columns = [
                        (u"N.", 2000),
                        (u"CARRERA", 6000),
                        (u"MALLA", 3000),
                        (u"IDENTIFICACION", 6000),
                        (u"ASIGNATURA", 6000),
                        (u"NIVEL", 4000),
                        (u"MATUTINA", 2000),
                        (u"VESPERTINA", 2000),
                        (u"NOCTURNA", 2000),
                        (u"FIN DE SEMANA", 2000),
                        (u"TOTAL", 2000),
                    ]
                    row_num = 0
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], font_style)
                        ws.col(col_num).width = columns[col_num][1]
                    date_format = xlwt.XFStyle()
                    date_format.num_format_str = 'yyyy/mm/dd'
                    a = 0
                    listaestudiante = "select codigomalla,carreras,identificacion,asignatura,nivel,totalmanana,vespertina,nocturna,finsemana," \
                                      "(totalmanana+vespertina+nocturna+finsemana) as total,inicio " \
                                      "from (select  smalla.id as codigomalla,carr.nombre as carreras,smalla.inicio,asi.identificacion,(mat.nombre || ' [' || mat.codigo || ']' ) as asignatura," \
                                      "nmall.nombre as nivel,(SELECT count(sga_asignatura.id) FROM sga_asignatura " \
                                      "INNER JOIN sga_prematricula_asignaturas ON (sga_asignatura.id = sga_prematricula_asignaturas.asignatura_id) " \
                                      "INNER JOIN sga_prematricula ON (sga_prematricula_asignaturas.prematricula_id = sga_prematricula.id) " \
                                      "INNER JOIN sga_inscripcion ON (sga_prematricula.inscripcion_id = sga_inscripcion.id) " \
                                      "INNER JOIN sga_inscripcionmalla ON (sga_inscripcion.id = sga_inscripcionmalla.inscripcion_id) " \
                                      "WHERE sga_prematricula.periodo_id = '" + str(
                        periodo.id) + "' AND sga_inscripcion.sesion_id = 1 " \
                                      "AND sga_inscripcionmalla.malla_id = smalla.id " \
                                      "AND sga_asignatura.id = asi.asignatura_id )as totalmanana,(SELECT count(sga_asignatura.id) " \
                                      "FROM sga_asignatura INNER JOIN sga_prematricula_asignaturas ON (sga_asignatura.id = sga_prematricula_asignaturas.asignatura_id) " \
                                      "INNER JOIN sga_prematricula ON (sga_prematricula_asignaturas.prematricula_id = sga_prematricula.id) " \
                                      "INNER JOIN sga_inscripcion ON (sga_prematricula.inscripcion_id = sga_inscripcion.id) " \
                                      "INNER JOIN sga_inscripcionmalla ON (sga_inscripcion.id = sga_inscripcionmalla.inscripcion_id) " \
                                      "WHERE sga_prematricula.periodo_id = '" + str(
                        periodo.id) + "'  AND sga_inscripcion.sesion_id = 4 " \
                                      "AND sga_inscripcionmalla.malla_id = smalla.id  AND sga_asignatura.id = asi.asignatura_id )as vespertina," \
                                      "(SELECT count(sga_asignatura.id)FROM sga_asignatura " \
                                      "INNER JOIN sga_prematricula_asignaturas ON sga_asignatura.id = sga_prematricula_asignaturas.asignatura_id " \
                                      "INNER JOIN sga_prematricula ON sga_prematricula_asignaturas.prematricula_id = sga_prematricula.id " \
                                      "INNER JOIN sga_inscripcion ON sga_prematricula.inscripcion_id = sga_inscripcion.id " \
                                      "INNER JOIN sga_inscripcionmalla ON sga_inscripcion.id = sga_inscripcionmalla.inscripcion_id " \
                                      "WHERE sga_prematricula.periodo_id = '" + str(
                        periodo.id) + "'  AND sga_inscripcion.sesion_id = 5  " \
                                      "AND sga_inscripcionmalla.malla_id = smalla.id  AND sga_asignatura.id = asi.asignatura_id )as nocturna," \
                                      "(SELECT count(sga_asignatura.id) FROM sga_asignatura " \
                                      "INNER JOIN sga_prematricula_asignaturas ON sga_asignatura.id = sga_prematricula_asignaturas.asignatura_id " \
                                      "INNER JOIN sga_prematricula ON sga_prematricula_asignaturas.prematricula_id = sga_prematricula.id " \
                                      "INNER JOIN sga_inscripcion ON sga_prematricula.inscripcion_id = sga_inscripcion.id " \
                                      "INNER JOIN sga_inscripcionmalla ON sga_inscripcion.id = sga_inscripcionmalla.inscripcion_id " \
                                      "WHERE sga_prematricula.periodo_id = '" + str(
                        periodo.id) + "'  AND sga_inscripcion.sesion_id = 7 " \
                                      "AND sga_inscripcionmalla.malla_id = smalla.id  AND sga_asignatura.id = asi.asignatura_id )as finsemana " \
                                      "from sga_asignaturamalla asi left join sga_asignatura mat on asi.asignatura_id=mat.id " \
                                      "left join sga_nivelmalla  nmall on nmall.id=asi.nivelmalla_id " \
                                      "left join sga_malla  smalla on smalla.id=asi.malla_id " \
                                      "left join sga_carrera  carr on carr.id=smalla.carrera_id " \
                                      "where carr.id='" + idcarrera + "' order by nmall.id, mat.nombre) as d"
                    cursor.execute(listaestudiante)
                    results = cursor.fetchall()
                    for per in results:
                        a += 1
                        ws.write(a, 0, a)
                        ws.write(a, 1, per[1])
                        ws.write(a, 2, per[10], date_format)
                        ws.write(a, 3, per[2])
                        ws.write(a, 4, per[3])
                        ws.write(a, 5, per[4])
                        ws.write(a, 6, per[5])
                        ws.write(a, 7, per[6])
                        ws.write(a, 8, per[7])
                        ws.write(a, 9, per[8])
                        ws.write(a, 10, per[9])
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'totalmatriculados':
                try:
                    periodo = request.GET['periodo']
                    cursor = connections['sga_select'].cursor()
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=listado_alumnos.xls'
                    wb = xlwt.Workbook()
                    ws = wb.add_sheet('Sheetname')
                    estilo = xlwt.easyxf(
                        'font: height 350, name Arial, colour_index black, bold on, italic on; align: wrap on, vert centre, horiz center;')
                    ws.write_merge(0, 0, 0, 9, 'UNIVERSIDAD ESTATAL DE MILAGRO', estilo)
                    ws.col(0).width = 1000
                    ws.col(1).width = 6000
                    ws.col(2).width = 3000
                    ws.col(3).width = 3000
                    ws.col(4).width = 3000
                    ws.col(5).width = 6000
                    ws.col(6).width = 6000
                    ws.col(7).width = 6000
                    ws.col(8).width = 6000
                    ws.col(9).width = 6000
                    ws.col(10).width = 6000
                    ws.col(11).width = 1000
                    ws.write(4, 0, 'N.')
                    ws.write(4, 1, 'PERIODO')
                    ws.write(4, 2, 'NIVEL')
                    ws.write(4, 3, 'SECCION')
                    ws.write(4, 4, 'CEDULA')
                    ws.write(4, 5, 'APELLIDOS')
                    ws.write(4, 6, 'NOMBRES')
                    ws.write(4, 7, 'SEXO')
                    ws.write(4, 8, 'FECHANACIMIENTO')
                    ws.write(4, 9, 'EMAIL')
                    ws.write(4, 10, 'EMAILINST')
                    ws.write(4, 11, 'COORDINACION')
                    ws.write(4, 12, 'CARRERA')
                    ws.write(4, 13, 'TELEFONO')
                    a = 4
                    date_format = xlwt.XFStyle()
                    date_format.num_format_str = 'yyyy/mm/dd'
                    listaestudiante = "select mat.id,per.nombre as periodo,nv.nombre as nivel,p.cedula,p.apellido1,p.apellido2,p.nombres,p.email,p.emailinst," \
                                      "coor.nombre as coordinacion,car.nombre as carrera, ses.nombre as sesion,p.telefono,p.sexo_id as sexo,p.nacimiento " \
                                      "from sga_matricula mat,sga_inscripcion i,sga_persona p,sga_nivel n,sga_carrera car,sga_coordinacion coor,sga_coordinacion_carrera cca, sga_periodo per, sga_nivelmalla nv,sga_inscripcionnivel inniv,sga_sesion ses " \
                                      "where mat.estado_matricula in (2,3) and mat.inscripcion_id=i.id and i.persona_id=p.id and mat.nivel_id=n.id and i.carrera_id=car.id and " \
                                      "car.id=cca.carrera_id and cca.coordinacion_id=coor.id and n.periodo_id=per.id and i.id=inniv.inscripcion_id and " \
                                      "inniv.nivel_id=nv.id and n.periodo_id = '" + periodo + "' and i.sesion_id=ses.id"
                    cursor.execute(listaestudiante)
                    results = cursor.fetchall()
                    for per in results:
                        a += 1
                        ws.write(a, 0, a - 4)
                        ws.write(a, 1, per[1])
                        ws.write(a, 2, per[2])
                        ws.write(a, 3, per[11])
                        ws.write(a, 4, per[3])
                        ws.write(a, 5, per[4] + ' ' + per[5])
                        ws.write(a, 6, per[6])
                        if per[13] == 1:
                            sexo = 'FEMENINO'
                        else:
                            sexo = 'MASCULINO'
                        ws.write(a, 7, sexo)
                        ws.write(a, 8, per[14], date_format)
                        ws.write(a, 9, per[7])
                        ws.write(a, 10, per[8])
                        ws.write(a, 11, per[9])
                        ws.write(a, 12, per[10])
                        ws.write(a, 13, per[12])
                    # # ws.write(a+2, 0, 'Fecha:')
                    # ws.write(a+2, 1, datetime.today(),date_format)
                    # ws.write_merge(a + 2, a + 2, 0, 1, datetime.today(), date_format)
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'reporteestudiantesadmision':
                try:
                    __author__ = 'Unemi'
                    title = easyxf(
                        'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('todos alumnos')
                    ws.write_merge(0, 0, 0, 7, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                    response = HttpResponse(content_type="application/ms-excel")
                    response[
                        'Content-Disposition'] = 'attachment; filename=reporte_estudiantes_aprobados_reprobados_admision' + random.randint(
                        1, 10000).__str__() + '.xls'
                    columns = [
                        (u"CARRERA", 6000),
                        (u"PERIODO ACADÉMICO", 6000),
                        (u"CÉDULA", 6000),
                        (u"APELLIDO PATERNO", 6000),
                        (u"APELLIDO MATERNO", 6000),
                        (u"NOMBRES", 3000),
                        (u"EMAIL PERSONAL", 3000),
                        (u"EMAIL INSTITUCIONAL", 6000),
                        (u"#CELULAR", 3000),
                        (u"#TELÉFONO CONVENCIONAL", 6000),
                        (u"GÉNERO", 6000),
                        (u"LGBTI", 3000),
                        (u"MODALIDAD", 3000),
                        (u"TÉRMINOS", 3000),
                        (u"Nro. ASIGNATURAS", 3000),
                        (u"PROMEDIO FINAL", 3000),
                        (u"ESTATUS FINAL", 3000),
                        (u"OBSERVACIÓN", 3000),
                        (u"ESTADO GRATUIDAD", 3000),
                        (u"Nro. MATRICULAS", 3000),
                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], font_style)
                        ws.col(col_num).width = columns[col_num][1]
                    #profesormaterias = ProfesorMateria.objects.filter(status=True, materia__nivel__periodo=periodo).exclude(materia__asignaturamalla__malla__carrera__coordinacion__id__in=[7, 9]).order_by('materia__asignaturamalla__malla__carrera__coordinacion', 'materia__asignaturamalla__malla__carrera', 'materia')

                    periodoanterior = Periodo.objects.filter(status=True, clasificacion=3, fin__lt=periodo.fin).order_by('-inicio')[0]
                    inscripciones = Inscripcion.objects.filter(status=True, carrera__coordinacion__id=9, matricula__nivel__periodo__id=periodo.id)

                    row_num = 4
                    col_num = 20

                    for inscripcion in inscripciones:
                        if Matricula.objects.filter(inscripcion=inscripcion, nivel__periodo__id=periodo.id).exists():
                            matricula = Matricula.objects.get(inscripcion=inscripcion, nivel__periodo__id=periodo.id)
                            if Matricula.objects.filter(nivel__periodo__id=periodoanterior.id, inscripcion__persona=inscripcion.persona).exists():
                                matriculant = Matricula.objects.get(nivel__periodo__id=periodoanterior.id, inscripcion__persona=inscripcion.persona)
                            else:
                                matriculant = matricula



                        ws.write(row_num, 0, u"%s" % matricula.inscripcion.carrera.nombre, font_style2)
                        ws.write(row_num, 1, u"%s" % matricula.nivel.periodo.nombre, font_style2)
                        ws.write(row_num, 2, u"%s" % matricula.inscripcion.persona.cedula, font_style2)
                        ws.write(row_num, 3, u"%s" % matricula.inscripcion.persona.apellido1, font_style2)
                        ws.write(row_num, 4, u"%s" % matricula.inscripcion.persona.apellido2, font_style2)
                        ws.write(row_num, 5, u"%s" % matricula.inscripcion.persona.nombres, font_style2)
                        ws.write(row_num, 6, u"%s" % matricula.inscripcion.persona.email if matricula.inscripcion.persona.email else "", font_style2)
                        ws.write(row_num, 7, u"%s" % matricula.inscripcion.persona.emailinst if matricula.inscripcion.persona.emailinst else "", font_style2)
                        ws.write(row_num, 8, u"%s" % matricula.inscripcion.persona.telefono if matricula.inscripcion.persona.telefono else "", font_style2)
                        ws.write(row_num, 9, u"%s" % matricula.inscripcion.persona.telefono_conv if matricula.inscripcion.persona.telefono_conv else "", font_style2)
                        ws.write(row_num, 10, u"%s" % matricula.inscripcion.persona.sexo.nombre if matricula.inscripcion.persona.sexo.nombre else "", font_style2)
                        ws.write(row_num, 11, u"%s" % "SI" if matricula.inscripcion.persona.lgtbi else "NO", font_style2)
                        ws.write(row_num, 12, u"%s" % matricula.inscripcion.modalidad, font_style2)
                        ws.write(row_num, 13, u"%s" % "SI" if matricula.termino == True else "NO", font_style2)
                        ws.write(row_num, 14, u"%s" % matricula.cantidad_materias(), font_style2)
                        ws.write(row_num, 15, u"%s" % matricula.promedio_nota(), font_style2)
                        ws.write(row_num, 16, u"%s" % "APROBADO" if matricula.materias_aprobadas_todas() else "REPROBADO", font_style2)
                        ws.write(row_num, 17, u"%s" % "Aprueba la Nivelación solo si en cada asignatura obtuvo como mínimo 70", font_style2)
                        ws.write(row_num, 18, u"%s" % matricula.inscripcion.gratuidad(), font_style2)
                        ws.write(row_num, 19, u"%s" % "1" if matriculant.materias_aprobadas_todas() else "2", font_style2)
                        materias = MateriaAsignada.objects.filter(matricula_id=matricula.id)
                        numcolu = 20
                        numcolu1 = 21
                        for materia in materias:
                            ws.write(row_num, numcolu, u"%s" % materia.materia.nombre_mostrar_alias(), font_style2)
                            ws.write(row_num, numcolu1, u"%s" % materia.notafinal, font_style2)
                            numcolu += 2
                            numcolu1 += 2

                        row_num += 1
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'oracle':
                try:
                    cursor = connections['sga_select'].cursor()
                    hoy = datetime.now().date()
                    response = HttpResponse(content_type="application/ms-excel")
                    response[
                        'Content-Disposition'] = 'attachment; filename=MATRICULADOS DE ' + periodo.nombre.__str__() + '.xls'
                    wb = xlwt.Workbook()
                    ws = wb.add_sheet('Sheetname')
                    estilo = xlwt.easyxf(
                        'font: height 350, name Arial, colour_index black, bold on, italic on; align: wrap on, vert centre, horiz center;')
                    ws.write_merge(0, 0, 0, 4, 'UNIVERSIDAD ESTATAL DE MILAGRO', estilo)
                    ws.col(0).width = 9000
                    ws.col(1).width = 9000
                    ws.col(2).width = 3000
                    ws.col(3).width = 3000
                    ws.write(2, 0, 'PERIODO REGULARES')
                    date_format = xlwt.XFStyle()
                    date_format.num_format_str = 'yyyy/mm/dd'
                    fila = 3
                    # periodos regular
                    for periodo in Periodo.objects.filter(status=True, activo=True, tipo__id=2, inicio__lte=hoy,
                                                          fin__gte=hoy):
                        nombreperiodo = str(periodo.nombre)
                        idperiodo = str(periodo.id)
                        sql = ""
                        sql = "SELECT DISTINCT sga_carrera.nombre as carrera, sga_nivelmalla.orden , count(sga_persona.cedula) as cantidad FROM sga_inscripcion sga_inscripcion " \
                              "RIGHT OUTER JOIN sga_matricula sga_matricula ON sga_inscripcion.id=sga_matricula.inscripcion_id " \
                              " LEFT OUTER JOIN sga_persona sga_persona ON sga_inscripcion.persona_id=sga_persona.id " \
                              " LEFT OUTER JOIN sga_carrera sga_carrera ON sga_inscripcion.carrera_id=sga_carrera.id " \
                              " LEFT OUTER JOIN sga_nivelmalla sga_nivelmalla ON sga_matricula.nivelmalla_id=sga_nivelmalla.id " \
                              " LEFT OUTER JOIN sga_nivel sga_nivel ON sga_matricula.nivel_id=sga_nivel.id " \
                              " LEFT OUTER JOIN sga_periodo sga_periodo ON sga_nivel.periodo_id=sga_periodo.id " \
                              " LEFT OUTER JOIN sga_nivellibrecoordinacion sga_nivellibrecoordinacion ON sga_nivel.id=sga_nivellibrecoordinacion.nivel_id " \
                              " LEFT OUTER JOIN sga_coordinacion sga_coordinacion ON sga_nivellibrecoordinacion.coordinacion_id=sga_coordinacion.id " \
                              " inner join sga_coordinacion_carrera sga_coordinacion_carrera on sga_coordinacion_carrera.carrera_id = sga_carrera.id and sga_coordinacion_carrera.coordinacion_id = sga_coordinacion.id " \
                              " WHERE sga_periodo.id=" + idperiodo + "  AND sga_coordinacion.id not in (9) " \
                                                                     " and sga_matricula.estado_matricula in (2,3) and sga_matricula.id not in (select ret.matricula_id from sga_retiromatricula ret) " \
                                                                     " and sga_matricula.id not in(select ma.id from (select  mat.id as id,count(ma.materia_id)  as numero " \
                                                                     " from sga_matricula mat , sga_Nivel n,sga_materiaasignada ma,sga_materia mate, " \
                                                                     " sga_asignatura asi where mat.nivel_id=n.id and mat.id=ma.matricula_id " \
                                                                     " and ma.materia_id=mate.id and mate.asignatura_id=asi.id and n.periodo_id=" + idperiodo + " " \
                                                                                                                                                                " and asi.modulo=True and ma.retiramateria=False group by mat.id) as ma,(select  mat.id as id, count(ma.materia_id) as numero " \
                                                                                                                                                                " from sga_Matricula mat , sga_Nivel n,sga_materiaasignada ma, " \
                                                                                                                                                                " sga_materia mate, sga_asignatura asi where mat.nivel_id=n.id and mat.id=ma.matricula_id " \
                                                                                                                                                                " and ma.materia_id=mate.id and mate.asignatura_id=asi.id and  ma.retiramateria=False and n.periodo_id=" + idperiodo + " group by mat.id) as mo " \
                                                                                                                                                                                                                                                                                       " where ma.id=mo.id and ma.numero=mo.numero) GROUP by sga_carrera.nombre, sga_nivelmalla.orden " \
                                                                                                                                                                                                                                                                                       " order by sga_carrera.nombre, sga_nivelmalla.orden"
                        cursor.execute(sql)
                        results = cursor.fetchall()
                        ws.write(fila, 0, u'PERIODO: %s' % nombreperiodo)
                        fila += 1
                        ws.write(fila, 1, u'CARRRERA')
                        ws.write(fila, 2, u'SEMESTRE')
                        ws.write(fila, 3, u'NÚMERO')
                        fila += 1
                        for resultado in results:
                            ws.write(fila, 1, resultado[0])
                            ws.write(fila, 2, str(resultado[1]))
                            ws.write(fila, 3, str(resultado[2]))
                            fila += 1

                    # periodos posgrado
                    fila += 1
                    ws.write(fila, 0, 'PERIODO IPEC')
                    fila += 1
                    for periodo in Periodo.objects.filter(status=True, activo=True, tipo__id=3, inicio__lte=hoy,
                                                          fin__gte=hoy):
                        nombreperiodo = str(periodo.nombre)
                        idperiodo = str(periodo.id)
                        sql = ""
                        sql = "SELECT DISTINCT sga_carrera.nombre as carrera, count(sga_persona.cedula) as cantidad FROM sga_inscripcion sga_inscripcion " \
                              "RIGHT OUTER JOIN sga_matricula sga_matricula ON sga_inscripcion.id=sga_matricula.inscripcion_id " \
                              " LEFT OUTER JOIN sga_persona sga_persona ON sga_inscripcion.persona_id=sga_persona.id " \
                              " LEFT OUTER JOIN sga_carrera sga_carrera ON sga_inscripcion.carrera_id=sga_carrera.id " \
                              " LEFT OUTER JOIN sga_nivel sga_nivel ON sga_matricula.nivel_id=sga_nivel.id " \
                              " LEFT OUTER JOIN sga_periodo sga_periodo ON sga_nivel.periodo_id=sga_periodo.id " \
                              " LEFT OUTER JOIN sga_nivellibrecoordinacion sga_nivellibrecoordinacion ON sga_nivel.id=sga_nivellibrecoordinacion.nivel_id " \
                              " LEFT OUTER JOIN sga_coordinacion sga_coordinacion ON sga_nivellibrecoordinacion.coordinacion_id=sga_coordinacion.id " \
                              " WHERE sga_periodo.id=" + idperiodo + "  AND sga_coordinacion.id not in (9) " \
                                                                     " and sga_matricula.estado_matricula in (2,3) and sga_matricula.id not in (select ret.matricula_id from sga_retiromatricula ret) " \
                                                                     " and sga_matricula.id not in(select ma.id from (select  mat.id as id,count(ma.materia_id)  as numero " \
                                                                     " from sga_matricula mat , sga_Nivel n,sga_materiaasignada ma,sga_materia mate, " \
                                                                     " sga_asignatura asi where mat.nivel_id=n.id and mat.id=ma.matricula_id " \
                                                                     " and ma.materia_id=mate.id and mate.asignatura_id=asi.id and n.periodo_id=" + idperiodo + " " \
                                                                                                                                                                " and asi.modulo=True and ma.retiramateria=False group by mat.id) as ma,(select  mat.id as id, count(ma.materia_id) as numero " \
                                                                                                                                                                " from sga_Matricula mat , sga_Nivel n,sga_materiaasignada ma, " \
                                                                                                                                                                " sga_materia mate, sga_asignatura asi where mat.nivel_id=n.id and mat.id=ma.matricula_id " \
                                                                                                                                                                " and ma.materia_id=mate.id and mate.asignatura_id=asi.id and  ma.retiramateria=False and n.periodo_id=" + idperiodo + " group by mat.id) as mo " \
                                                                                                                                                                                                                                                                                       " where ma.id=mo.id and ma.numero=mo.numero) GROUP by sga_carrera.nombre"
                        cursor.execute(sql)
                        results = cursor.fetchall()
                        ws.write(fila, 0, u'PERIODO: %s' % nombreperiodo)
                        fila += 1
                        ws.write(fila, 1, u'CARRRERA')
                        ws.write(fila, 2, u'NÚMERO')
                        fila += 1
                        for resultado in results:
                            ws.write(fila, 1, resultado[0])
                            ws.write(fila, 2, str(resultado[1]))
                            fila += 1
                    # DOCENTES
                    sql = "select 0,  tabla.nombre, count(tabla.cedula) from " \
                          " (SELECT dp.nombre, p.cedula , COALESCE(pro.categoria_id,1) as categoria_id " \
                          " from sga_persona p, auth_user usua, sagest_distributivopersona d, sagest_nivelocupacional nio, " \
                          " sagest_modalidadlaboral mod, sagest_regimenlaboral r, " \
                          " sagest_denominacionpuesto de, sagest_departamento dep , sga_profesor pro, sga_tiempodedicaciondocente dp " \
                          " where p.id=d.persona_id and d.status=true and d.estadopuesto_id=1  " \
                          " and r.id=d.regimenlaboral_id and d.regimenlaboral_id=2 and pro.persona_id=p.id and pro.activo= true " \
                          " and dp.id=pro.dedicacion_id  " \
                          " and usua.id=p.usuario_id and d.nivelocupacional_id=nio.id and d.modalidadlaboral_id=mod.id and " \
                          " de.id=d.denominacionpuesto_id " \
                          " and dep.id=d.unidadorganica_id) as tabla where tabla.categoria_id<>9 GROUP by tabla.nombre " \
                          " union " \
                          " SELECT 1, 'TECNICO DOCENTE', count(p.cedula) from sga_persona p, auth_user usua, " \
                          " sagest_distributivopersona d, sagest_nivelocupacional nio, sagest_modalidadlaboral mod, sagest_regimenlaboral r, " \
                          " sagest_denominacionpuesto de, sagest_departamento dep , sga_profesor pro, sga_tiempodedicaciondocente dp " \
                          " where p.id=d.persona_id and d.status=true and d.estadopuesto_id=1  " \
                          " and r.id=d.regimenlaboral_id and d.regimenlaboral_id=2 and pro.persona_id=p.id and pro.activo= true and dp.id=pro.dedicacion_id " \
                          " and usua.id=p.usuario_id and d.nivelocupacional_id=nio.id and d.modalidadlaboral_id=mod.id and de.id=d.denominacionpuesto_id  " \
                          " and pro.categoria_id=9 and dep.id=d.unidadorganica_id order by 1"
                    fila += 1
                    ws.write(fila, 0, 'DOCENTES')
                    fila += 1
                    ws.write(fila, 1, u'TIPO')
                    ws.write(fila, 2, u'NÚMERO')
                    fila += 1
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    for resultado in results:
                        ws.write(fila, 1, resultado[1])
                        ws.write(fila, 2, str(resultado[2]))
                        fila += 1

                    # TRABAJADORES Y ADMINISTRATIVOS
                    sql = "select (case r.id when 1 then 'ADMINISTRATIVOS' else 'TRABAJADORES' end) , count(p.cedula) " \
                          " from sga_persona p, sagest_distributivopersona d, sagest_regimenlaboral r " \
                          " where p.id=d.persona_id and d.status=true and d.estadopuesto_id=1 and r.id=d.regimenlaboral_id and r.id<>2 GROUP by r.id"
                    fila += 1
                    ws.write(fila, 0, 'TRABAJADORES Y ADMINISTRATIVOS')
                    fila += 1
                    ws.write(fila, 1, u'TIPO')
                    ws.write(fila, 2, u'NÚMERO')
                    fila += 1
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    for resultado in results:
                        ws.write(fila, 1, resultado[0])
                        ws.write(fila, 2, str(resultado[1]))
                        fila += 1

                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'totalmatriculadossinmodulosvirtual':
                try:
                    cursor = connections['sga_select'].cursor()
                    response = HttpResponse(content_type="application/ms-excel")
                    response[
                        'Content-Disposition'] = 'attachment; filename=MATRICULADOS DE ' + periodo.nombre.__str__() + '.xls'
                    periodo = request.GET['periodo']
                    wb = xlwt.Workbook()
                    ws = wb.add_sheet('Sheetname')
                    estilo = xlwt.easyxf(
                        'font: height 350, name Arial, colour_index black, bold on, italic on; align: wrap on, vert centre, horiz center;')
                    ws.write_merge(0, 0, 0, 9, 'UNIVERSIDAD ESTATAL DE MILAGRO', estilo)
                    ws.col(0).width = 1000
                    ws.col(1).width = 6000
                    ws.col(2).width = 3000
                    ws.col(3).width = 3000
                    ws.col(4).width = 6000
                    ws.col(5).width = 6000
                    ws.col(6).width = 6000
                    ws.col(7).width = 6000
                    ws.col(8).width = 4000
                    ws.col(9).width = 6000
                    ws.col(10).width = 6000
                    ws.col(11).width = 1000
                    ws.col(14).width = 4000
                    ws.col(15).width = 4000
                    ws.col(16).width = 4000
                    ws.write(4, 0, 'N.')
                    ws.write(4, 1, 'PERIODO')
                    ws.write(4, 2, 'NIVEL_CRE')
                    ws.write(4, 3, 'NIVEL_MAT')
                    ws.write(4, 4, 'SECCION')
                    ws.write(4, 5, 'CEDULA')
                    ws.write(4, 6, 'APELLIDOS')
                    ws.write(4, 7, 'NOMBRES')
                    ws.write(4, 8, 'SEXO')
                    ws.write(4, 9, 'FECHANACIMIENTO')
                    ws.write(4, 10, 'EMAIL')
                    ws.write(4, 11, 'EMAILINST')
                    ws.write(4, 12, 'COORDINACION')
                    ws.write(4, 13, 'CARRERA')
                    ws.write(4, 14, 'COD. SENESCYT')
                    ws.write(4, 15, 'TELEFONO')
                    # ws.write(4, 16, 'USUARIO')
                    ws.write(4, 16, 'INSCRIPCION')
                    ws.write(4, 17, 'LGTBI')
                    ws.write(4, 18, 'ETNIA')
                    ws.write(4, 19, 'NACIONALIDAD')
                    ws.write(4, 20, 'PAIS')
                    ws.write(4, 21, 'PROVINCIA')
                    ws.write(4, 22, 'CANTON')
                    ws.write(4, 23, 'DIRECCION')
                    ws.write(4, 24, 'ESTADO SOCIO ECONOMICO')
                    ws.write(4, 25, 'REALIZADO')
                    # ws.write(4, 26, 'HORAS PRACTICAS')
                    # ws.write(4, 27, 'HORAS VINCULACION')
                    ws.write(4, 26, 'FECHA INICIO PRIMER NIVEL')
                    ws.write(4, 27, 'FECHA CONVALIDACION')
                    ws.write(4, 28, 'PROMEDIO ASISTENCIA')
                    ws.write(4, 29, 'PROMEDIO NOTAS')
                    ws.write(4, 30, 'ULTIMO MODULO')
                    ws.write(4, 31, 'MATRICULADO MODULO')
                    ws.write(4, 32, 'TIENE DISCAPASIDAD')
                    ws.write(4, 33, 'DISCAPASIDAD')
                    ws.write(4, 34, 'ITINETARIOS CUMPLIDOS')
                    ws.write(4, 35, 'ID MATRICULA')
                    ws.write(4, 36, 'TIPO MATRICULA')
                    a = 4
                    date_format = xlwt.XFStyle()
                    date_format.num_format_str = 'yyyy/mm/dd'
                    matriculados = Matricula.objects.filter(nivel__periodo=periodo, estado_matricula__in=[2, 3], status=True,
                                                            materiaasignada__materia__tipomateria=2).exclude(
                        retiromatricula__isnull=False).exclude(inscripcion__carrera__coordinacion__id=9).distinct()
                    for matri in matriculados:
                        a += 1
                        nombreperiodo = matri.nivel.periodo.nombre
                        nivelperiodo = matri.inscripcion.mi_nivel().nivel.nombre
                        etnia = matri.inscripcion.persona.mi_perfil()
                        fichasoc = matri.inscripcion.persona.mi_ficha()
                        # horasprac = matri.inscripcion.numero_horas_practicas_pre_profesionales()
                        # horasvin = matri.inscripcion.numero_horas_vinculacion()
                        promasis = matri.promedio_asistencias()
                        promnota = matri.promedio_nota()
                        ultimomodulo = matri.inscripcion.ultimomoduloingles()
                        modulomatriculado = matri.modulomatriculadoingles()
                        if matri.inscripcion.coordinacion.nombre:
                            facultad = matri.inscripcion.coordinacion.nombre
                        else:
                            facultad = ''
                        if etnia and etnia.raza:
                            etnia = etnia.raza.nombre
                        else:
                            etnia = ''
                        if matri.inscripcion.persona.lgtbi:
                            lgtbi = 'SI'
                        else:
                            lgtbi = 'NO'
                        tienediscapasidad = 'NO'
                        discapasidad = ''
                        if matri.inscripcion.persona.mi_perfil().tienediscapacidad:
                            tienediscapasidad = 'SI'
                            discapasidad = matri.inscripcion.persona.mi_perfil().tipodiscapacidad.nombre
                        itinerarioscumplido = matri.inscripcion.contar_itinerario_realizados().__str__()
                        ws.write(a, 0, a - 4)
                        ws.write(a, 1, nombreperiodo)
                        ws.write(a, 2, nivelperiodo)
                        ws.write(a, 3, matri.nivelmalla.nombre)
                        ws.write(a, 4, matri.inscripcion.sesion.nombre)
                        ws.write(a, 5, matri.inscripcion.persona.cedula)
                        ws.write(a, 6, matri.inscripcion.persona.apellido1 + ' ' + matri.inscripcion.persona.apellido2)
                        ws.write(a, 7, matri.inscripcion.persona.nombres)
                        ws.write(a, 8, matri.inscripcion.persona.sexo.nombre)
                        ws.write(a, 9, matri.inscripcion.persona.nacimiento, date_format)
                        ws.write(a, 10, matri.inscripcion.persona.email)
                        ws.write(a, 11, matri.inscripcion.persona.emailinst)
                        ws.write(a, 12, facultad)
                        ws.write(a, 13, matri.inscripcion.carrera.nombre + (
                            " MENCION " + matri.inscripcion.carrera.mencion if matri.inscripcion.carrera.mencion else ""))
                        # ws.write(a, 14, matri.inscripcion.carrera.codigo)
                        ws.write(a, 14, matri.inscripcion.mi_malla().codigo if matri.inscripcion.mi_malla() else '')
                        ws.write(a, 15, matri.inscripcion.persona.telefono)
                        ws.write(a, 16, matri.inscripcion.id)
                        ws.write(a, 17, lgtbi)
                        ws.write(a, 18, etnia)
                        ws.write(a, 19, matri.inscripcion.persona.nacionalidad)
                        ws.write(a, 20,
                                 matri.inscripcion.persona.pais.nombre if matri.inscripcion.persona.pais_id else "")
                        ws.write(a, 21,
                                 matri.inscripcion.persona.provincia.nombre if matri.inscripcion.persona.provincia_id else "")
                        ws.write(a, 22,
                                 matri.inscripcion.persona.canton.nombre if matri.inscripcion.persona.canton_id else "")
                        ws.write(a, 23,
                                 matri.inscripcion.persona.direccion + ' ' + matri.inscripcion.persona.direccion2)
                        ws.write(a, 24, fichasoc.grupoeconomico.codigo + ' ' + fichasoc.grupoeconomico.nombre)
                        ws.write(a, 25, 'SI')
                        # ws.write(a, 26, horasprac)
                        # ws.write(a, 27, horasvin)
                        ws.write(a, 26, matri.inscripcion.fechainicioprimernivel, date_format)
                        ws.write(a, 27, matri.inscripcion.fechainicioconvalidacion, date_format)
                        ws.write(a, 28, promasis)
                        ws.write(a, 29, promnota)
                        ws.write(a, 30, ultimomodulo)
                        ws.write(a, 31, modulomatriculado)
                        ws.write(a, 32, tienediscapasidad)
                        ws.write(a, 33, discapasidad)
                        ws.write(a, 34, itinerarioscumplido)
                        ws.write(a, 35, matri.id)
                        ws.write(a, 36, matri.tipomatricula.nombre if matri.tipomatricula else '')
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'totalmatriculadosadeudan':
                try:
                    idperiodo = request.GET['periodo']
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=listado_alumnos_adeudan.xls'
                    wb = xlwt.Workbook()
                    ws = wb.add_sheet('Sheetname')
                    estilo = xlwt.easyxf(
                        'font: height 350, name Arial, colour_index black, bold on, italic on; align: wrap on, vert centre, horiz center;')
                    # ws.write_merge(0, 0, 0, 9, 'UNIVERSIDAD ESTATAL DE MILAGRO', estilo)
                    ws.col(0).width = 1000
                    ws.col(1).width = 7500
                    ws.col(2).width = 4000
                    ws.col(3).width = 10000
                    ws.col(4).width = 3000
                    ws.col(5).width = 6000
                    ws.col(6).width = 6000
                    ws.col(7).width = 10000
                    ws.col(8).width = 10000
                    ws.col(9).width = 3500
                    ws.col(10).width = 6000
                    ws.col(11).width = 6000
                    ws.col(13).width = 10000
                    ws.col(14).width = 8000
                    ws.col(15).width = 3500
                    ws.write(4, 0, 'N.')
                    ws.write(4, 1, 'PERIODO')
                    ws.write(4, 2, 'CEDULA')
                    ws.write(4, 3, 'APELLIDOS Y NOMBRES')
                    ws.write(4, 4, 'SEXO')
                    ws.write(4, 5, 'EMAIL')
                    ws.write(4, 6, 'EMAILINST')
                    ws.write(4, 7, 'FACULTAD')
                    ws.write(4, 8, 'CARRERA')
                    ws.write(4, 9, 'TELEFONO')
                    ws.write(4, 10, 'PAIS')
                    ws.write(4, 11, 'PROVINCIA')
                    ws.write(4, 12, 'CANTON')
                    ws.write(4, 13, 'DIRECCION')
                    ws.write(4, 14, 'ESTADO SOCIO ECONOMICO')
                    ws.write(4, 15, 'TOTAL')
                    a = 4
                    date_format = xlwt.XFStyle()
                    date_format.num_format_str = 'yyyy/mm/dd'
                    matriculados = periodo.lista_total_matriculados_con_deuda()
                    for matri in matriculados:
                        a += 1
                        nombreperiodo = matri.nivel.periodo.nombre
                        fichasoc = matri.inscripcion.persona.fichasocioeconomicainec_set.filter(status=True)[0]
                        facultad = ''
                        if matri.inscripcion.coordinacion.nombre:
                            facultad = matri.inscripcion.coordinacion.nombre
                        totalpagar = 0.0
                        if Rubro.objects.filter(status=True, persona=matri.inscripcion.persona, cancelado=False,
                                                matricula__nivel__periodo=periodo).exists():
                            totalpagar = null_to_decimal(
                                Rubro.objects.filter(status=True, persona=matri.inscripcion.persona, cancelado=False,
                                                     matricula__nivel__periodo=periodo).aggregate(
                                    totalpagar=Sum('saldo'))['totalpagar'], 2)
                        ws.write(a, 0, a - 4)
                        ws.write(a, 1, nombreperiodo)
                        ws.write(a, 2, matri.inscripcion.persona.cedula)
                        ws.write(a, 3, matri.inscripcion.persona.apellido1 + ' ' + matri.inscripcion.persona.apellido2 + ' ' + matri.inscripcion.persona.nombres)
                        alu_sexo = matri.inscripcion.persona.sexo.nombre if matri.inscripcion.persona.sexo else 'SIN DEFINIR'
                        ws.write(a, 4, alu_sexo)
                        ws.write(a, 5, matri.inscripcion.persona.email)
                        ws.write(a, 6, matri.inscripcion.persona.emailinst)
                        ws.write(a, 7, facultad)
                        ws.write(a, 8, str(matri.inscripcion.carrera))
                        ws.write(a, 9, matri.inscripcion.persona.telefono)
                        ws.write(a, 10, matri.inscripcion.persona.pais.nombre if matri.inscripcion.persona.pais_id else "")
                        ws.write(a, 11, matri.inscripcion.persona.provincia.nombre if matri.inscripcion.persona.provincia_id else "")
                        ws.write(a, 12, matri.inscripcion.persona.canton.nombre if matri.inscripcion.persona.canton_id else "")
                        ws.write(a, 13, matri.inscripcion.persona.direccion + ' ' + matri.inscripcion.persona.direccion2)
                        alu_grupoeco = fichasoc.grupoeconomico.nombre if fichasoc.grupoeconomico else 'NINGUNO'
                        alu_grupoecocod = fichasoc.grupoeconomico.codigo if fichasoc.grupoeconomico else ''
                        ws.write(a, 14, "{} {}".format(alu_grupoecocod, alu_grupoeco))
                        ws.write(a, 15, totalpagar)
                    wb.save(response)
                    return response
                except Exception as ex:
                    print('Error on line {}'.format(sys.exc_info()[-1].tb_lineno))
                    HttpResponseRedirect("/niveles?info=%s" % ex)

            elif action == 'totalmatriculadospagado':
                try:
                    idperiodo = request.GET['periodo']
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=listado_alumnos_pagado.xls'
                    wb = xlwt.Workbook()
                    ws = wb.add_sheet('Sheetname')
                    estilo = xlwt.easyxf(
                        'font: height 350, name Arial, colour_index black, bold on, italic on; align: wrap on, vert centre, horiz center;')
                    # ws.write_merge(0, 0, 0, 9, 'UNIVERSIDAD ESTATAL DE MILAGRO', estilo)
                    ws.col(0).width = 1000
                    ws.col(1).width = 7500
                    ws.col(2).width = 4000
                    ws.col(3).width = 10000
                    ws.col(4).width = 3000
                    ws.col(5).width = 6000
                    ws.col(6).width = 6000
                    ws.col(7).width = 10000
                    ws.col(8).width = 10000
                    ws.col(9).width = 3500
                    ws.col(10).width = 6000
                    ws.col(11).width = 6000
                    ws.col(13).width = 10000
                    ws.col(14).width = 8000
                    ws.col(15).width = 3500
                    ws.write(4, 0, 'N.')
                    ws.write(4, 1, 'PERIODO')
                    ws.write(4, 2, 'CEDULA')
                    ws.write(4, 3, 'APELLIDOS Y NOMBRES')
                    ws.write(4, 4, 'SEXO')
                    ws.write(4, 5, 'EMAIL')
                    ws.write(4, 6, 'EMAILINST')
                    ws.write(4, 7, 'FACULTAD')
                    ws.write(4, 8, 'CARRERA')
                    ws.write(4, 9, 'TELEFONO')
                    ws.write(4, 10, 'PAIS')
                    ws.write(4, 11, 'PROVINCIA')
                    ws.write(4, 12, 'CANTON')
                    ws.write(4, 13, 'DIRECCION')
                    ws.write(4, 14, 'ESTADO SOCIO ECONOMICO')
                    ws.write(4, 15, 'TOTAL')
                    a = 4
                    date_format = xlwt.XFStyle()
                    date_format.num_format_str = 'yyyy/mm/dd'
                    matriculasid = Pago.objects.values_list('rubro__matricula__id', flat=False).filter(status=True,
                                                                                                       rubro__matricula__nivel__periodo=periodo).exclude(
                        rubro__matricula__inscripcion__carrera__coordinacion__id=ADMISION_ID).exclude(
                        rubro__matricula__retiradomatricula=True)
                    matriculasid = matriculasid.order_by().distinct()
                    matriculados = Matricula.objects.filter(pk__in=matriculasid)
                    for matri in matriculados:
                        a += 1
                        nombreperiodo = matri.nivel.periodo.nombre
                        fichasoc = matri.inscripcion.persona.fichasocioeconomicainec_set.filter(status=True)[0]
                        facultad = ''
                        if matri.inscripcion.coordinacion.nombre:
                            facultad = matri.inscripcion.coordinacion.nombre
                        totalpagado = 0.0
                        if Pago.objects.filter(status=True, rubro__matricula=matri,
                                               rubro__matricula__nivel__periodo=periodo).exists():
                            totalpagado = null_to_decimal(Pago.objects.filter(status=True, rubro__matricula=matri,rubro__status=True,
                                                                              rubro__matricula__nivel__periodo=periodo).aggregate(
                                totalpagado=Sum('valortotal'))['totalpagado'], 2)
                        ws.write(a, 0, a - 4)
                        ws.write(a, 1, nombreperiodo)
                        ws.write(a, 2, matri.inscripcion.persona.cedula)
                        ws.write(a, 3,
                                 matri.inscripcion.persona.apellido1 + ' ' + matri.inscripcion.persona.apellido2 + ' ' + matri.inscripcion.persona.nombres)
                        ws.write(a, 4, matri.inscripcion.persona.sexo.nombre)
                        ws.write(a, 5, matri.inscripcion.persona.email)
                        ws.write(a, 6, matri.inscripcion.persona.emailinst)
                        ws.write(a, 7, facultad)
                        ws.write(a, 8, str(matri.inscripcion.carrera))
                        ws.write(a, 9, matri.inscripcion.persona.telefono)
                        ws.write(a, 10,
                                 matri.inscripcion.persona.pais.nombre if matri.inscripcion.persona.pais_id else "")
                        ws.write(a, 11,
                                 matri.inscripcion.persona.provincia.nombre if matri.inscripcion.persona.provincia_id else "")
                        ws.write(a, 12,
                                 matri.inscripcion.persona.canton.nombre if matri.inscripcion.persona.canton_id else "")
                        ws.write(a, 13,
                                 matri.inscripcion.persona.direccion + ' ' + matri.inscripcion.persona.direccion2)
                        ws.write(a, 14, fichasoc.grupoeconomico.codigo + ' ' + fichasoc.grupoeconomico.nombre)
                        ws.write(a, 15, totalpagado)
                    wb.save(response)
                    return response
                except Exception as ex:
                    HttpResponseRedirect("/niveles?info=%s" % ex)

            elif action == 'totalmatriculadospagadoadmision':
                try:
                    idperiodo = request.GET['periodo']
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=listado_alumnos_pagado.xls'
                    wb = xlwt.Workbook()
                    ws = wb.add_sheet('Sheetname')
                    estilo = xlwt.easyxf(
                        'font: height 350, name Arial, colour_index black, bold on, italic on; align: wrap on, vert centre, horiz center;')
                    # ws.write_merge(0, 0, 0, 9, 'UNIVERSIDAD ESTATAL DE MILAGRO', estilo)
                    ws.col(0).width = 1000
                    ws.col(1).width = 7500
                    ws.col(2).width = 4000
                    ws.col(3).width = 10000
                    ws.col(4).width = 3000
                    ws.col(5).width = 6000
                    ws.col(6).width = 6000
                    ws.col(7).width = 10000
                    ws.col(8).width = 10000
                    ws.col(9).width = 3500
                    ws.col(10).width = 6000
                    ws.col(11).width = 6000
                    ws.col(13).width = 10000
                    ws.col(14).width = 8000
                    ws.col(15).width = 3500
                    ws.write(4, 0, 'N.')
                    ws.write(4, 1, 'PERIODO')
                    ws.write(4, 2, 'CEDULA')
                    ws.write(4, 3, 'APELLIDOS Y NOMBRES')
                    ws.write(4, 4, 'SEXO')
                    ws.write(4, 5, 'EMAIL')
                    ws.write(4, 6, 'EMAILINST')
                    ws.write(4, 7, 'FACULTAD')
                    ws.write(4, 8, 'CARRERA')
                    ws.write(4, 9, 'TELEFONO')
                    ws.write(4, 10, 'PAIS')
                    ws.write(4, 11, 'PROVINCIA')
                    ws.write(4, 12, 'CANTON')
                    ws.write(4, 13, 'DIRECCION')
                    ws.write(4, 14, 'ESTADO SOCIO ECONOMICO')
                    ws.write(4, 15, 'TOTAL')
                    a = 4
                    date_format = xlwt.XFStyle()
                    date_format.num_format_str = 'yyyy/mm/dd'
                    matriculasid = Pago.objects.values_list('rubro__matricula__id', flat=False).filter(status=True,
                                                                                                       rubro__matricula__nivel__periodo=periodo,
                                                                                                       rubro__matricula__inscripcion__carrera__coordinacion__id=ADMISION_ID).exclude(
                        rubro__matricula__retiradomatricula=True)
                    matriculasid = matriculasid.order_by().distinct()
                    matriculados = Matricula.objects.filter(pk__in=matriculasid)
                    for matri in matriculados:
                        a += 1
                        nombreperiodo = matri.nivel.periodo.nombre
                        fichasoc = matri.inscripcion.persona.fichasocioeconomicainec_set.filter(status=True)[0]
                        facultad = ''
                        if matri.inscripcion.coordinacion.nombre:
                            facultad = matri.inscripcion.coordinacion.nombre
                        totalpagado = 0.0
                        if Pago.objects.filter(status=True, rubro__matricula=matri,
                                               rubro__matricula__nivel__periodo=periodo).exists():
                            totalpagado = null_to_decimal(Pago.objects.filter(status=True, rubro__matricula=matri,
                                                                              rubro__matricula__nivel__periodo=periodo).aggregate(
                                totalpagado=Sum('valortotal'))['totalpagado'], 2)
                        ws.write(a, 0, a - 4)
                        ws.write(a, 1, nombreperiodo)
                        ws.write(a, 2, matri.inscripcion.persona.cedula)
                        ws.write(a, 3,
                                 matri.inscripcion.persona.apellido1 + ' ' + matri.inscripcion.persona.apellido2 + ' ' + matri.inscripcion.persona.nombres)
                        ws.write(a, 4, matri.inscripcion.persona.sexo.nombre)
                        ws.write(a, 5, matri.inscripcion.persona.email)
                        ws.write(a, 6, matri.inscripcion.persona.emailinst)
                        ws.write(a, 7, facultad)
                        ws.write(a, 8, str(matri.inscripcion.carrera))
                        ws.write(a, 9, matri.inscripcion.persona.telefono)
                        ws.write(a, 10,
                                 matri.inscripcion.persona.pais.nombre if matri.inscripcion.persona.pais_id else "")
                        ws.write(a, 11,
                                 matri.inscripcion.persona.provincia.nombre if matri.inscripcion.persona.provincia_id else "")
                        ws.write(a, 12,
                                 matri.inscripcion.persona.canton.nombre if matri.inscripcion.persona.canton_id else "")
                        ws.write(a, 13,
                                 matri.inscripcion.persona.direccion + ' ' + matri.inscripcion.persona.direccion2)
                        ws.write(a, 14, fichasoc.grupoeconomico.codigo + ' ' + fichasoc.grupoeconomico.nombre)
                        ws.write(a, 15, totalpagado)
                    wb.save(response)
                    return response
                except Exception as ex:
                    HttpResponseRedirect("/niveles?info=%s" % ex)

            elif action == 'silabovirtual':
                try:
                    data['title'] = u'Sílabos'
                    data['materia'] = materia = Materia.objects.get(pk=int(encrypt(request.GET['idm'])))
                    data['idmallavirtual'] = materia.asignaturamalla.malla.id
                    data['facultad'] = facultad = materia.asignaturamalla.malla.carrera.coordinaciones()[0]
                    # data['silabos'] = Silabo.objects.filter(materia_id=materia_id, profesor=profesor)
                    # data['silabos'] = Silabo.objects.filter(materia_id=materia_id)
                    data['silabos'] = materia.silabo_set.all()
                    data['aprobar'] = variable_valor('APROBAR_SILABO')
                    data['rechazar'] = variable_valor('RECHAZAR_SILABO')
                    data['pendiente'] = variable_valor('PENDIENTE_SILABO')
                    if 'mid' in request.GET:
                        request.session['mallaid'] = request.GET['mid']
                    elif 'mid' in request.GET or 'nmid' in request.GET or 'pid' in request.GET:
                        request.session['mallaid'] = None
                    if 'nmid' in request.GET:
                        request.session['nivelmallaid'] = request.GET['nmid']
                    elif 'mid' in request.GET or 'nmid' in request.GET or 'pid' in request.GET:
                        request.session['nivelmallaid'] = None
                    if 'pid' in request.GET:
                        request.session['paraleloid'] = request.GET['pid']
                    elif 'mid' in request.GET or 'nmid' in request.GET or 'pid' in request.GET:
                        request.session['paraleloid'] = None
                    if 's' in request.GET:
                        request.session['s'] = request.GET['s']
                    elif 'mid' in request.GET or 'nmid' in request.GET or 'pid' in request.GET:
                        request.session['s'] = None
                    data['mallaid'] = request.session['mallaid']
                    data['nivelmallaid'] = request.session['nivelmallaid']
                    data['paraleloid'] = request.session['paraleloid']
                    data['s'] = request.session['s']
                    if facultad.id == 7:
                        return render(request, "niveles/silabodocenteposgrado.html", data)
                    else:
                        return render(request, "niveles/silabodocentevirtual.html", data)
                except Exception as ex:
                    pass

            elif action == 'tiene_programaanalitico':
                try:
                    materia = Materia.objects.get(pk=int(encrypt(request.GET['id'])))
                    if not materia.asignaturamalla.programaanaliticoasignatura_set.filter(activo=True).exists():
                        return JsonResponse({"result": "bad", "mensaje": u"No Tiene Programa Analitico."})
                    return JsonResponse({"result": "ok"})
                except Exception as ex:
                    return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos."})

            elif action == 'planclasevirtualposgrado':
                try:
                    data['title'] = u'PLANIFICACIÓN SEMANAL DE SÍLABO'
                    lista_nueva = []
                    lista_semanas = []
                    panalitico = 0
                    data['silabocab'] = silabocab = Silabo.objects.get(pk=int(encrypt(request.GET['silaboid'])), status=True)
                    data['materia'] = materia = silabocab.materia
                    data['mallaid'] = materia.asignaturamalla.malla_id
                    data['nivelmallaid'] = materia.asignaturamalla.nivelmalla_id
                    data['tiporecurso'] = TIPO_RECURSOS
                    data['tipolink'] = TIPO_LINK
                    data['tipoactividad'] = TIPO_ACTIVIDAD
                    if not PlanificacionClaseSilabo.objects.filter(
                            tipoplanificacion__planificacionclasesilabo_materia__materia=silabocab.materia,
                            status=True).exists():
                        return JsonResponse({"result": "bad", "mensaje": u"Noo tiene cronograma académico."})
                    data['planificacion'] = PlanificacionClaseSilabo.objects.filter(tipoplanificacion__planificacionclasesilabo_materia__materia=silabocab.materia, status=True).exclude(semana=0).order_by('orden')
                    lista = []
                    for p in PlanificacionClaseSilabo.objects.filter(tipoplanificacion__planificacionclasesilabo_materia__materia=silabocab.materia,status=True).exclude(semana=0).order_by('orden'):
                        semana = None
                        idcodigo = 0
                        eva = ''
                        rec = ''
                        if silabocab.silabosemanal_set.filter(fechainiciosemana__gte=p.fechainicio, fechafinciosemana__lte=p.fechafin, status=True).exists():
                            lissemana = silabocab.silabosemanal_set.filter(fechainiciosemana__gte=p.fechainicio, fechafinciosemana__lte=p.fechafin, status=True)[0]
                            idcodigo = lissemana.id
                            semana = lissemana
                            eva = lissemana.evaluacion
                            rec = lissemana.recursos
                        idcodigo = idcodigo
                        modelosilabo = semana
                        lista.append([p.fechainicio.isocalendar()[1], p.fechainicio, p.fechafin, idcodigo, modelosilabo, rec, eva])
                    if silabocab.silabosemanal_set.filter(status=True).exists():
                        panalitico = 1
                    # aux = 0
                    data['panalitico'] = panalitico
                    data['fechas'] = lista
                    data['listasemanal'] = silabocab.silabosemanal_set.filter(status=True).order_by('fechainiciosemana')
                    # data['porcentaje_semanas_registradas'] = silabocab.estado_semanas_llenas(lista.__len__())
                    # data['tiene_practica'] = silabocab.materia.asignaturamalla.practicas
                    # data['aprobar'] = variable_valor('APROBAR_SILABO')
                    # data['rechazar'] = variable_valor('RECHAZAR_SILABO')
                    # data['pendiente'] = variable_valor('PENDIENTE_SILABO')
                    # pruede_modificar = False
                    # hora_principal_0 = False
                    # ban = 0
                    # if silabocab.materia.profesormateria_set.filter(Q(status=True), Q(activo=True), (Q(tipoprofesor_id=TIPO_DOCENTE_TEORIA) | Q(tipoprofesor_id=TIPO_DOCENTE_FIRMA) | Q(tipoprofesor_id=TIPO_DOCENTE_AYUDANTIA)), profesor=silabocab.profesor).exists():
                    #     pruede_modificar = True
                    # else:
                    #     if silabocab.materia.profesormateria_set.filter(Q(status=True), Q(activo=True), (Q(tipoprofesor_id=TIPO_DOCENTE_TEORIA) | Q(tipoprofesor_id=TIPO_DOCENTE_FIRMA) | Q(tipoprofesor_id=TIPO_DOCENTE_AYUDANTIA))).exists():
                    #         if silabocab.materia.profesormateria_set.filter(Q(status=True), Q(activo=True), (Q(tipoprofesor_id=TIPO_DOCENTE_TEORIA) | Q(tipoprofesor_id=TIPO_DOCENTE_FIRMA) | Q(tipoprofesor_id=TIPO_DOCENTE_AYUDANTIA)))[0].hora == 0:
                    #             hora_principal_0 = True
                    #         for pro in silabocab.materia.profesormateria_set.filter(status=True, profesor=silabocab.profesor, activo=True).exclude(tipoprofesor_id=4).exclude(pk__in=silabocab.materia.profesormateria_set.values_list('id', flat=False).filter(Q(status=True), Q(activo=True), (Q(tipoprofesor_id=TIPO_DOCENTE_TEORIA) | Q(tipoprofesor_id=TIPO_DOCENTE_FIRMA) | Q(tipoprofesor_id=TIPO_DOCENTE_AYUDANTIA)))):
                    #             if pro.hora > 0:
                    #                 ban = 1
                    #                 pruede_modificar = True
                    #                 break
                    # if ban == 1:
                    #     if hora_principal_0 and pruede_modificar:
                    #         pruede_modificar = True
                    #     else:
                    #         pruede_modificar = False
                    # data['pruede_modificar'] = pruede_modificar
                    return render(request, "niveles/listado_plancasevirtualposgrado.html", data)
                except Exception as ex:
                    pass

            elif action == 'adicionar_silabovirtual':
                try:
                    data['materia'] = materia = Materia.objects.get(
                        pk=request.GET['id'])  # int(encrypt(request.GET['id'])))
                    lista = []
                    if materia.asignaturamalla.programaanaliticoasignatura_set.filter(activo=True,
                                                                                      status=True).exists():
                        for prog in materia.asignaturamalla.programaanaliticoasignatura_set.filter(activo=True,
                                                                                                   status=True):
                            lista.append([prog.id, prog])
                        data['lista_programaanalitico'] = lista
                        template = get_template("niveles/adicionarsilabovirtual.html")
                        json_content = template.render(data)
                        return JsonResponse({"result": "ok", 'data': json_content})
                    else:
                        return JsonResponse({"result": "bad", "mensaje": u"No Tiene Programa Analítico activo."})
                except Exception as ex:
                    return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos."})
                    pass

            elif action == 'delsilabovirtual':
                try:
                    data['title'] = u'Eliminar Cabecera de Silabo'
                    data['silabo'] = silabo = Silabo.objects.get(pk=int(encrypt(request.GET['ids'])))
                    data['mallaid'] = int(encrypt(request.GET['mallaid']))
                    return render(request, "niveles/delsilabovirtual.html", data)
                except Exception as ex:
                    pass

            elif action == 'planclasevirtual':
                try:
                    data['title'] = u'PLANIFICACIÓN SEMANAL DE SÍLABO'
                    lista_nueva = []
                    lista_semanas = []
                    panalitico = 0
                    data['silabocab'] = silabocab = Silabo.objects.get(pk=int(encrypt(request.GET['silaboid'])),
                                                                       status=True)
                    data['idmalla'] = int(encrypt(request.GET['idmalla']))
                    data['tiporecurso'] = TIPO_RECURSOS
                    data['tipolink'] = TIPO_LINK
                    data['tipoactividad'] = TIPO_ACTIVIDAD
                    if not PlanificacionClaseSilabo.objects.filter(
                            tipoplanificacion__planificacionclasesilabo_materia__materia=silabocab.materia,
                            status=True).exists():
                        return JsonResponse({"result": "bad", "mensaje": u"Noo tiene cronograma académico."})
                    data['planificacion'] = PlanificacionClaseSilabo.objects.filter(
                        tipoplanificacion__planificacionclasesilabo_materia__materia=silabocab.materia,
                        status=True).exclude(semana=0).order_by('orden')
                    lista = []
                    for p in PlanificacionClaseSilabo.objects.filter(
                            tipoplanificacion__planificacionclasesilabo_materia__materia=silabocab.materia,
                            status=True).exclude(semana=0).order_by('orden'):
                        semana = None
                        idcodigo = 0
                        if silabocab.silabosemanal_set.filter(fechainiciosemana__gte=p.fechainicio,
                                                              fechafinciosemana__lte=p.fechafin, status=True).exists():
                            lissemana = silabocab.silabosemanal_set.filter(fechainiciosemana__gte=p.fechainicio,
                                                                           fechafinciosemana__lte=p.fechafin,
                                                                           status=True)[0]
                            idcodigo = lissemana.id
                            semana = lissemana
                        idcodigo = idcodigo
                        modelosilabo = semana
                        lista.append(
                            [p.fechainicio.isocalendar()[1], p.fechainicio, p.fechafin, idcodigo, modelosilabo])
                    if silabocab.silabosemanal_set.filter(status=True).exists():
                        panalitico = 1
                    aux = 0
                    data['panalitico'] = panalitico
                    data['fechas'] = lista
                    data['porcentaje_semanas_registradas'] = silabocab.estado_semanas_llenas(lista.__len__())
                    data['tiene_practica'] = silabocab.materia.asignaturamalla.practicas
                    data['aprobar'] = variable_valor('APROBAR_SILABO')
                    data['rechazar'] = variable_valor('RECHAZAR_SILABO')
                    data['pendiente'] = variable_valor('PENDIENTE_SILABO')
                    pruede_modificar = False
                    hora_principal_0 = False
                    ban = 0
                    if silabocab.materia.profesormateria_set.filter(Q(status=True), Q(activo=True), (
                            Q(tipoprofesor_id=TIPO_DOCENTE_TEORIA) | Q(tipoprofesor_id=TIPO_DOCENTE_FIRMA) | Q(
                        tipoprofesor_id=TIPO_DOCENTE_AYUDANTIA)), profesor=silabocab.profesor).exists():
                        pruede_modificar = True
                    else:
                        if silabocab.materia.profesormateria_set.filter(Q(status=True), Q(activo=True), (
                                Q(tipoprofesor_id=TIPO_DOCENTE_TEORIA) | Q(tipoprofesor_id=TIPO_DOCENTE_FIRMA) | Q(
                            tipoprofesor_id=TIPO_DOCENTE_AYUDANTIA))).exists():
                            if silabocab.materia.profesormateria_set.filter(Q(status=True), Q(activo=True), (
                                    Q(tipoprofesor_id=TIPO_DOCENTE_TEORIA) | Q(tipoprofesor_id=TIPO_DOCENTE_FIRMA) | Q(
                                tipoprofesor_id=TIPO_DOCENTE_AYUDANTIA)))[0].hora == 0:
                                hora_principal_0 = True
                            for pro in silabocab.materia.profesormateria_set.filter(status=True,
                                                                                    profesor=silabocab.profesor,
                                                                                    activo=True).exclude(
                                tipoprofesor_id=4).exclude(
                                pk__in=silabocab.materia.profesormateria_set.values_list('id', flat=False).filter(
                                    Q(status=True), Q(activo=True), (Q(tipoprofesor_id=TIPO_DOCENTE_TEORIA) | Q(
                                        tipoprofesor_id=TIPO_DOCENTE_FIRMA) | Q(
                                        tipoprofesor_id=TIPO_DOCENTE_AYUDANTIA)))):
                                if pro.hora > 0:
                                    ban = 1
                                    pruede_modificar = True
                                    break
                    if ban == 1:
                        if hora_principal_0 and pruede_modificar:
                            pruede_modificar = True
                        else:
                            pruede_modificar = False
                    data['pruede_modificar'] = pruede_modificar
                    return render(request, "niveles/listado_plancasevirtual.html", data)
                except Exception as ex:
                    pass

            elif action == 'addsemanaplanificacionvirtual':
                try:
                    planificacionsemana = None
                    data['title'] = u'Adicionar la Semana # ' + str(
                        int(encrypt(request.GET['numsemana']))) + ' Planificación'
                    data['silabo'] = silabo = \
                        Silabo.objects.filter(pk=int(encrypt(request.GET['idsilabo'])), status=True,
                                              programaanaliticoasignatura__activo=True)[0]
                    data['idmallavirtual'] = int(encrypt(request.GET['idmallavirtual']))
                    data['contenido'] = silabo.programaanaliticoasignatura.contenido_program_analitico()
                    # data['contenido'] = ContenidoResultadoProgramaAnalitico.objects.filter(programaanaliticoasignatura=silabo.programaanaliticoasignatura, status=True).order_by('orden')
                    data['numsemana'] = encrypt(request.GET['numsemana'])
                    data['nsemana'] = int(encrypt(request.GET['numsemana']))
                    data['semana'] = encrypt(request.GET['semana'])
                    data['fini'] = request.GET['fini']
                    data['ffin'] = request.GET['ffin']
                    data[
                        'librosilabos'] = silabo.programaanaliticoasignatura.bibliografiaprogramaanaliticoasignatura_set.all()
                    if PlanificacionClaseSilabo_Materia.objects.filter(materia=silabo.materia,
                                                                       tipoplanificacion__periodo=silabo.materia.nivel.periodo).exists():
                        planificacion = PlanificacionClaseSilabo_Materia.objects.get(materia=silabo.materia,
                                                                                     tipoplanificacion__periodo=silabo.materia.nivel.periodo) if PlanificacionClaseSilabo_Materia.objects.get(
                            materia=silabo.materia, tipoplanificacion__periodo=silabo.materia.nivel.periodo) else None
                        planificacionsemana = planificacion.tipoplanificacion.planificacionclasesilabo_set.filter(
                            status=True).order_by('semana')
                    data['planificacionsemana'] = planificacionsemana
                    # form = SilaboSemanalVirtualForm(initial={})
                    # data['form'] = form
                    return render(request, "niveles/addsemanaplanificacionvirtual.html", data)
                except Exception as ex:
                    pass

            elif action == 'editsemanaplanificacionvirtual':
                try:
                    planificacionsemana = None
                    data['fini'] = request.GET['fini']
                    data['ffin'] = request.GET['ffin']
                    data['silabo'] = silabosemanal = SilaboSemanalVirtual.objects.get(pk=encrypt(request.GET['ids']))
                    data['idmallavirtual'] = encrypt(request.GET['idmallavirtual'])
                    data['title'] = u'Editar la Semana # ' + str(silabosemanal.numsemana) + ' de la Planificación de'
                    data['subtemasilabos'] = DetalleSilaboSemanalVirtualSubtema.objects.filter(
                        silabosemanalvirtual_id=silabosemanal.id)
                    data['temasilabos'] = temasilabos = DetalleSilaboSemanalVirtualTema.objects.filter(
                        silabosemanalvirtual_id=silabosemanal.id)
                    data['contenido'] = silabosemanal.silabo.programaanaliticoasignatura.contenido_program_analitico()
                    # data['contenido'] = ContenidoResultadoProgramaAnalitico.objects.filter(programaanaliticoasignatura=silabosemanal.silabo.programaanaliticoasignatura, programaanaliticoasignatura__activo=True, status=True).order_by('orden')
                    data['contenidosubtemas'] = silabosemanal.detallesilabosemanalvirtualsubtema_set.filter(
                        subtemaunidadresultadoprogramaanalitico__status=True)
                    data['contenidotemas'] = silabosemanal.detallesilabosemanalvirtualtema_set.filter(
                        temaunidadresultadoprogramaanalitico__status=True)
                    # if PlanificacionClaseSilabo_Materia.objects.filter(materia=silabosemanal.silabo.materia, tipoplanificacion__periodo=silabosemanal.silabo.materia.nivel.periodo).exists():
                    #     planificacion = PlanificacionClaseSilabo_Materia.objects.get(materia=silabosemanal.silabo.materia, tipoplanificacion__periodo=silabosemanal.silabo.materia.nivel.periodo)
                    #     planificacionsemana = planificacion.tipoplanificacion.planificacionclasesilabo_set.filter(status=True).order_by('semana')
                    # data['planificacionsemana'] = planificacionsemana
                    # data['cronogramasemana'] = silabosemanal.cronogramasilabo_set.filter(status=True)
                    form = SilaboSemanalVirtualForm(initial={})
                    # form.deshabilitar_horas()
                    data['form'] = form
                    # data['puede_editar'] = silabosemanal.puede_eliminar()
                    return render(request, "niveles/editsemanaplanificacionvirtual.html", data)
                except Exception as ex:
                    pass

            elif action == 'addsemanasilaboactividad':
                try:
                    data['title'] = u'Adicionar Actividad'
                    data['codigosemana'] = silabosemanal = SilaboSemanal.objects.get(
                        pk=encrypt(request.GET['codigosemana']))
                    data['idmallavirtual'] = encrypt(request.GET['idmallavirtual'])
                    form = VirtualActividadesSilaboForm()
                    form.adicionar(silabosemanal.id)
                    data['form'] = form
                    return render(request, "niveles/addsemanasilaboactividad.html", data)
                except Exception as ex:
                    pass

            elif action == 'editsemanasilaboactividad':
                try:
                    planificacionsemana = None
                    data['actividadsilabo'] = actividadsilabo = VirtualActividadesSilabo.objects.get(
                        pk=encrypt(request.GET['codigoactividad']))
                    data['idmallavirtual'] = encrypt(request.GET['idmallavirtual'])
                    data['title'] = u'Editar la Actividad # ' + str(actividadsilabo.silabosemanal.numsemana)
                    form = VirtualActividadesSilaboForm(initial={'descripcion': actividadsilabo.descripcion,
                                                                 'nombre': actividadsilabo.nombre,
                                                                 'tipoactividad': actividadsilabo.tipoactividad,
                                                                 'tema': actividadsilabo.tema})
                    form.editar(actividadsilabo.silabosemanal.id)
                    data['form'] = form
                    return render(request, "niveles/editsemanasilaboactividad.html", data)
                except Exception as ex:
                    pass

            elif action == 'addsemanasilabocasopractico':
                try:
                    data['title'] = u'Adicionar Experiencia'
                    data['codigosemana'] = silabosemanal = SilaboSemanal.objects.get(
                        pk=encrypt(request.GET['codigosemana']))
                    data['idmallavirtual'] = encrypt(request.GET['idmallavirtual'])
                    form = VirtualCasosPracticosSilaboForm()
                    form.adicionar(silabosemanal.id)
                    data['form'] = form
                    return render(request, "niveles/addsemanasilabocasopractico.html", data)
                except Exception as ex:
                    pass

            elif action == 'editsemanasilabocasopractico':
                try:
                    planificacionsemana = None
                    data['casopracticosilabo'] = casopracticosilabo = VirtualCasosPracticosSilabo.objects.get(
                        pk=encrypt(request.GET['codigocaso']))
                    data['idmallavirtual'] = encrypt(request.GET['idmallavirtual'])
                    data['title'] = u'Editar la Experiencia # ' + str(
                        casopracticosilabo.silabosemanal.numsemana) + ' de la Planificación de'
                    form = VirtualCasosPracticosSilaboForm(initial={'descripcion': casopracticosilabo.descripcion,
                                                                    'nombre': casopracticosilabo.nombre,
                                                                    # 'subtema': casopracticosilabo.subtema
                                                                    'tema': casopracticosilabo.tema})
                    form.editar(casopracticosilabo.silabosemanal.id)
                    data['form'] = form
                    return render(request, "niveles/editsemanasilabocasopractico.html", data)
                except Exception as ex:
                    pass

            elif action == 'editsemanasilabolecturas':
                try:
                    planificacionsemana = None
                    data['lecturasilabo'] = lecturasilabo = VirtualLecturasSilabo.objects.get(
                        pk=encrypt(request.GET['codigolectura']))
                    data['idmallavirtual'] = encrypt(request.GET['idmallavirtual'])
                    data['title'] = u'Editar la Lectura # ' + str(
                        lecturasilabo.silabosemanal.numsemana) + ' de la Planificación de'
                    form = VirtualLecturasSilaboForm(initial={'descripcion': lecturasilabo.descripcion,
                                                              'nombre': lecturasilabo.nombre,
                                                              'tema': lecturasilabo.tema})
                    form.editar(lecturasilabo.silabosemanal.id)
                    data['form'] = form
                    return render(request, "niveles/editsemanasilabolecturas.html", data)
                except Exception as ex:
                    pass

            elif action == 'addsemanasilabolecturas':
                try:
                    data['title'] = u'Adicionar Lectura'
                    data['codigosemana'] = silabosemanal = SilaboSemanal.objects.get(
                        pk=encrypt(request.GET['codigosemana']))
                    data['idmallavirtual'] = encrypt(request.GET['idmallavirtual'])
                    form = VirtualLecturasSilaboForm()
                    form.adicionar(silabosemanal.id)
                    data['form'] = form
                    return render(request, "niveles/addsemanasilabolecturas.html", data)
                except Exception as ex:
                    pass

            elif action == 'addsemanasilabopresencial':
                try:
                    data['title'] = u'Adicionar presencial virtual'
                    data['codigosemana'] = silabosemanal = SilaboSemanal.objects.get(
                        pk=encrypt(request.GET['codigosemana']))
                    data['idmallavirtual'] = encrypt(request.GET['idmallavirtual'])
                    form = VirtualPresencialSilaboForm()
                    form.adicionar(silabosemanal.id)
                    data['form'] = form
                    return render(request, "niveles/addsemanasilabopresencial.html", data)
                except Exception as ex:
                    pass

            elif action == 'editsemanasilabopresencial':
                try:
                    planificacionsemana = None
                    data['presencialsilabo'] = presencialsilabo = VirtualPresencialSilabo.objects.get(
                        pk=encrypt(request.GET['codigopresencial']))
                    data['idmallavirtual'] = encrypt(request.GET['idmallavirtual'])
                    data['title'] = u'Editar presencial # ' + str(
                        presencialsilabo.silabosemanal.numsemana) + ' de la Planificación de'
                    form = VirtualPresencialSilaboForm(initial={'descripcion': presencialsilabo.descripcion,
                                                                'link': presencialsilabo.link,
                                                                'tema': presencialsilabo.tema})
                    form.editar(presencialsilabo.silabosemanal.id)
                    data['form'] = form
                    return render(request, "niveles/editsemanasilabopresencial.html", data)
                except Exception as ex:
                    pass

            elif action == 'addsemanasilaborecurso':
                try:
                    data['title'] = u'Adicionar mas recurso'
                    data['codigosemana'] = silabosemanal = SilaboSemanal.objects.get(
                        pk=encrypt(request.GET['codigosemana']))
                    data['idmallavirtual'] = encrypt(request.GET['idmallavirtual'])
                    form = VirtualRecursoSilaboForm()
                    form.adicionar(silabosemanal.id)
                    data['form'] = form
                    return render(request, "niveles/addsemanasilaborecurso.html", data)
                except Exception as ex:
                    pass

            elif action == 'editsemanasilaborecurso':
                try:
                    planificacionsemana = None
                    data['recursosilabo'] = recursosilabo = VirtualMasRecursoSilabo.objects.get(
                        pk=encrypt(request.GET['codigorecurso']))
                    data['idmallavirtual'] = encrypt(request.GET['idmallavirtual'])
                    data['title'] = u'Editar mas recurso # ' + str(
                        recursosilabo.silabosemanal.numsemana) + ' de la Planificación de'
                    form = VirtualRecursoSilaboForm(initial={'descripcion': recursosilabo.descripcion,
                                                             'nombre': recursosilabo.nombre,
                                                             # 'subtema': recursosilabo.subtema,
                                                             'tema': recursosilabo.tema,
                                                             'tiporecurso': recursosilabo.tiporecurso})
                    form.editar(recursosilabo.silabosemanal.id)
                    data['form'] = form
                    return render(request, "niveles/editsemanasilaborecurso.html", data)
                except Exception as ex:
                    pass

            elif action == 'addsemanasilabotest':
                try:
                    data['title'] = u'Adicionar test virtual'
                    data['codigosemana'] = silabosemanal = SilaboSemanal.objects.get(
                        pk=encrypt(request.GET['codigosemana']))
                    data['idmallavirtual'] = encrypt(request.GET['idmallavirtual'])
                    form = VirtualTestSilaboForm()
                    form.adicionar(silabosemanal.id)
                    data['form'] = form
                    return render(request, "niveles/addsemanasilabotest.html", data)
                except Exception as ex:
                    pass

            elif action == 'editsemanasilabotest':
                try:
                    planificacionsemana = None
                    data['testsilabo'] = testsilabo = VirtualTestSilabo.objects.get(
                        pk=encrypt(request.GET['codigotest']))
                    data['idmallavirtual'] = encrypt(request.GET['idmallavirtual'])
                    data['title'] = u'Editar la Test # ' + str(
                        testsilabo.silabosemanal.numsemana) + ' de la Planificación de'
                    form = VirtualTestSilaboForm(initial={'descripcion': testsilabo.descripcion,
                                                          'link': testsilabo.link,
                                                          'tema': testsilabo.tema})
                    form.editar(testsilabo.silabosemanal.id)
                    data['form'] = form
                    return render(request, "niveles/editsemanasilabotest.html", data)
                except Exception as ex:
                    pass

            elif action == 'editsemanasilabotemas':
                try:
                    data['title'] = u'Editar Resultado de Aprendizaje'
                    data['fini'] = request.GET['fini']
                    data['ffin'] = request.GET['ffin']
                    data['idmallavirtual'] = int(encrypt(request.GET['idmallavirtual']))
                    data['silabovirtual'] = silabovirtual = SilaboSemanal.objects.get(
                        pk=int(encrypt(request.GET['codigosilabo'])), status=True)
                    data['subtemasilabos'] = DetalleSilaboSemanalSubtema.objects.filter(
                        silabosemanal_id=silabovirtual.id)
                    data['temasilabos'] = temasilabos = DetalleSilaboSemanalTema.objects.filter(
                        silabosemanal_id=silabovirtual.id)
                    data['contenido'] = silabovirtual.silabo.programaanaliticoasignatura.contenido_program_analitico()
                    data['permite_modificar'] = False
                    return render(request, "niveles/editsemanasilabotemas.html", data)
                except Exception as ex:
                    pass

            elif action == 'tiene_programaanaliticovirtual':
                try:
                    materia = Materia.objects.get(pk=int(encrypt(request.GET['id'])))
                    if not materia.asignaturamalla.programaanaliticoasignatura_set.filter(activo=True).exists():
                        return JsonResponse({"result": "bad", "mensaje": u"No Tiene Programa Analitico."})
                    return JsonResponse({"result": "ok"})
                except Exception as ex:
                    return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos."})

            elif action == 'totalmatriculadosadmision':
                try:
                    periodo = request.GET['periodo']
                    cursor = connections['sga_select'].cursor()
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=listado_alumnos.xls'
                    wb = xlwt.Workbook()
                    ws = wb.add_sheet('Sheetname')
                    estilo = xlwt.easyxf(
                        'font: height 350, name Arial, colour_index black, bold on, italic on; align: wrap on, vert centre, horiz center;')
                    ws.write_merge(0, 0, 0, 9, 'UNIVERSIDAD ESTATAL DE MILAGRO', estilo)
                    ws.col(0).width = 1000
                    ws.col(1).width = 6000
                    ws.col(2).width = 3000
                    ws.col(3).width = 3000
                    ws.col(4).width = 6000
                    ws.col(5).width = 6000
                    ws.col(6).width = 6000
                    ws.col(7).width = 6000
                    ws.col(8).width = 4000
                    ws.col(9).width = 6000
                    ws.col(10).width = 6000
                    ws.col(11).width = 1000
                    ws.col(14).width = 4000
                    ws.col(15).width = 4000
                    ws.col(16).width = 4000
                    ws.write(4, 0, 'N.')
                    ws.write(4, 1, 'PERIODO')
                    ws.write(4, 2, 'NIVEL_CRE')
                    ws.write(4, 3, 'NIVEL_MAT')
                    ws.write(4, 4, 'SECCION')
                    ws.write(4, 5, 'CEDULA')
                    ws.write(4, 6, 'APELLIDOS')
                    ws.write(4, 7, 'NOMBRES')
                    ws.write(4, 8, 'SEXO')
                    ws.write(4, 9, 'FECHANACIMIENTO')
                    ws.write(4, 10, 'EMAIL')
                    ws.write(4, 11, 'EMAILINST')
                    ws.write(4, 12, 'COORDINACION')
                    ws.write(4, 13, 'CARRERA')
                    ws.write(4, 14, 'COD. SENESCYT')
                    ws.write(4, 15, 'TELEFONO')
                    # ws.write(4, 16, 'USUARIO')
                    ws.write(4, 16, 'INSCRIPCION')
                    ws.write(4, 17, 'LGTBI')
                    ws.write(4, 18, 'ETNIA')
                    ws.write(4, 19, 'NACIONALIDAD')
                    ws.write(4, 20, 'PAIS')
                    ws.write(4, 21, 'PROVINCIA')
                    ws.write(4, 22, 'CANTON')
                    ws.write(4, 23, 'DIRECCION')
                    ws.write(4, 24, 'ESTADO SOCIO ECONOMICO')
                    ws.write(4, 25, 'REALIZADO')
                    ws.write(4, 26, 'HORAS PRACTICAS')
                    # ws.write(4, 27, 'HORAS VINCULACION')
                    ws.write(4, 27, 'FECHA INICIO PRIMER NIVEL')
                    ws.write(4, 28, 'FECHA CONVALIDACION')
                    ws.write(4, 29, 'PROMEDIO ASISTENCIA')
                    ws.write(4, 30, 'PROMEDIO NOTAS')
                    ws.write(4, 31, 'COLEGIO')
                    ws.write(4, 32, 'DÍAS')
                    ws.write(4, 33, 'CREDO')

                    a = 4
                    date_format = xlwt.XFStyle()
                    date_format.num_format_str = 'yyyy/mm/dd'
                    # (select sum(horas) from sga_participantesmatrices vincu, sga_proyectosinvestigacion  proyec
                    #  where vincu.proyecto_id = proyec.id and proyec.tipo = 1 and vincu.matrizevidencia_id = 2  and vincu.status = True and vincu.inscripcion_id = i.id) as horasvin,
                    listaestudiante = "select mat.id,per.nombre as periodo,nv.nombre as nivel,p.cedula,p.apellido1,p.apellido2,p.nombres,p.email,p.emailinst," \
                                      "coor.nombre as coordinacion,car.nombre as carrera,car.codigo as codigo, p.sexo_id as sexo,p.nacimiento,ses.nombre as sesion,p.telefono, usu.username,mat.inscripcion_id, " \
                                      "(select nmt.nombre from sga_nivelmalla nmt where nmt.id=mat.nivelmalla_id) as nivelmalla, p.lgtbi, car.mencion, (select raza.nombre from sga_perfilinscripcion perfil,sga_raza raza where perfil.persona_id=p.id and perfil.raza_id=raza.id) as etnia,p.nacionalidad,  " \
                                      "(select nombre from sga_pais pais where p.pais_id = pais.id) as pais, " \
                                      "(select nombre from sga_provincia prov where p.provincia_id = prov.id) as provincia, " \
                                      "(select nombre from sga_canton canton where p.canton_id = canton.id) as canton, " \
                                      "p.direccion , p.direccion2, (select gru.codigo || ' " " ' ||gru.nombre from socioecon_fichasocioeconomicainec ficha, socioecon_gruposocioeconomico gru where ficha.grupoeconomico_id=gru.id and ficha.persona_id=p.id) as grupo, " \
                                      "(select fich.confirmar from socioecon_fichasocioeconomicainec fich where fich.persona_id = p.id) as confirmar, " \
                                      "(select sum(numerohora) from sga_practicaspreprofesionalesinscripcion praci  where  praci.inscripcion_id = i.id and praci.status = True) as horasprac, " \
                                      " i.fechainicioprimernivel, i.fechainicioconvalidacion, " \
                                      " (select avg(ma1.asistenciafinal) from sga_materiaasignada ma1 where ma1.matricula_id = mat.id and ma1.status = true and ma1.retiramateria = false) as pasistencia, " \
                                      " (select avg(ma1.notafinal) from sga_materiaasignada ma1 where ma1.matricula_id = mat.id and ma1.status = true and ma1.retiramateria = false) as ppromedio, i.colegio,  (SELECT ARRAY_TO_STRING(ARRAY_AGG(DISTINCT DIAS),',') FROM SGA_PERSONARELIGION RELI WHERE P.ID = RELI.PERSONA_ID AND RELI.status = True) AS DIAS, (SELECT ARRAY_TO_STRING(ARRAY_AGG(DISTINCT CREDO.NOMBRE),',') FROM SGA_CREDO CREDO, SGA_PERSONARELIGION RELI WHERE CREDO.ID = RELI.CREDO_ID AND RELI.PERSONA_ID = P.ID AND CREDO.status = True) AS CREDO " \
                                      "from sga_matricula mat,sga_inscripcion i,sga_persona p,auth_user usu,sga_nivel n,sga_carrera car,sga_coordinacion coor, " \
                                      "sga_coordinacion_carrera cca, sga_periodo per, sga_nivelmalla nv,sga_inscripcionnivel inniv,sga_sesion ses " \
                                      "where coor.id=9 and  mat.estado_matricula in (2,3) and mat.inscripcion_id=i.id and i.persona_id=p.id and usu.id=p.usuario_id and mat.nivel_id=n.id and i.carrera_id=car.id and car.id=cca.carrera_id " \
                                      "and cca.coordinacion_id=coor.id and n.periodo_id=per.id and i.id=inniv.inscripcion_id and inniv.nivel_id=nv.id " \
                                      "and n.periodo_id='" + periodo + "'  and i.sesion_id=ses.id and mat.id not in (select ret.matricula_id from sga_retiromatricula ret) and mat.id not in(select ma.id from (select  mat.id as id,count(ma.materia_id)  as numero " \
                                                                       "from sga_Matricula mat , sga_Nivel n,sga_materiaasignada ma,sga_materia mate, " \
                                                                       "sga_asignatura asi where mat.estado_matricula in (2,3) and mat.nivel_id=n.id and mat.id=ma.matricula_id " \
                                                                       "and ma.materia_id=mate.id and mate.asignatura_id=asi.id and n.periodo_id='" + periodo + "'  " \
                                                                                                                                                                "and asi.modulo=True group by mat.id) ma,(select  mat.id as id, count(ma.materia_id) as numero " \
                                                                                                                                                                "from sga_Matricula mat , sga_Nivel n,sga_materiaasignada ma, " \
                                                                                                                                                                "sga_materia mate, sga_asignatura asi where mat.estado_matricula in (2,3) and mat.nivel_id=n.id and mat.id=ma.matricula_id " \
                                                                                                                                                                "and ma.materia_id=mate.id and mate.asignatura_id=asi.id and n.periodo_id='" + periodo + "'  group by mat.id) mo " \
                                                                                                                                                                                                                                                         "where ma.id=mo.id and ma.numero=mo.numero);"
                    cursor.execute(listaestudiante)
                    results = cursor.fetchall()
                    for per in results:
                        a += 1
                        ws.write(a, 0, a - 4)
                        ws.write(a, 1, per[1])
                        ws.write(a, 2, per[2])
                        ws.write(a, 3, per[18])
                        ws.write(a, 4, per[14])
                        ws.write(a, 5, per[3])
                        ws.write(a, 6, per[4] + ' ' + per[5])
                        ws.write(a, 7, per[6])
                        if per[12] == 1:
                            sexo = 'FEMENINO'
                        elif per[12] == 2:
                            sexo = 'MASCULINO'
                        else:
                            sexo = 'NINGUNO'
                        ws.write(a, 8, sexo)
                        ws.write(a, 9, per[13], date_format)
                        ws.write(a, 10, per[7])
                        ws.write(a, 11, per[8])
                        ws.write(a, 12, per[9])
                        ws.write(a, 13, per[10] + (" MENCION " + per[20] if per[20] else ""))
                        ws.write(a, 14, per[11])
                        ws.write(a, 15, per[15])
                        # ws.write(a, 16, per[16])
                        ws.write(a, 16, per[17])
                        ws.write(a, 17, "SI" if per[19] else "NO")
                        ws.write(a, 18, per[21])
                        ws.write(a, 19, per[22])
                        ws.write(a, 20, per[23])
                        ws.write(a, 21, per[24])
                        ws.write(a, 22, per[25])
                        ws.write(a, 23, per[26] + ' ' + per[27])
                        ws.write(a, 24, per[28])
                        if per[29]:
                            ws.write(a, 25, 'SI')
                        else:
                            ws.write(a, 25, 'NO')
                        ws.write(a, 26, per[30])
                        # ws.write(a, 27, per[31])
                        ws.write(a, 27, per[31], date_format)
                        ws.write(a, 28, per[32], date_format)
                        ws.write(a, 29, per[33])
                        ws.write(a, 30, per[34])
                        ws.write(a, 31, u'%s' % per[35])
                        ws.write(a, 32, per[36])
                        ws.write(a, 33, per[37])
                    # lperiodo = Periodo.objects.filter(pk=periodo)[0]
                    # carreras = Carrera.objects.filter(malla__asignaturamalla__materia__nivel__periodo__id=periodo, coordinacion__id=9).distinct()
                    # for carrera in carreras:
                    #     ws = wb.add_sheet(carrera.__str__() if not carrera.alias else carrera.alias.__str__())
                    #     inscripciones = Inscripcion.objects.filter(carrera=carrera, matricula__nivel__periodo__id=periodo)
                    #     ws.col(0).width = 1000
                    #     ws.col(1).width = 3000
                    #     ws.col(2).width = 6000
                    #     ws.col(3).width = 6000
                    #     ws.col(4).width = 1000
                    #     ws.write(0, 0, 'N.')
                    #     ws.write(0, 1, 'CEDULA')
                    #     ws.write(0, 2, 'APELLIDOS')
                    #     ws.write(0, 3, 'NOMBRES')
                    #     ws.write(0, 4, 'PARALELO')
                    #     c = 5
                    #     for materia in Asignatura.objects.filter(materia__asignaturamalla__malla__carrera=carrera, materia__nivel__periodo=lperiodo).order_by('id').distinct():
                    #         ws.write(0, c, materia.nombre)
                    #         c += 1
                    #     ws.write(0, c, 'ESTADO')
                    #     ws.write(0, c+1, 'PASADAS')
                    #     a = 1
                    #     for inscripcion in inscripciones:
                    #         ws.write(a, 0, a - 1)
                    #         ws.write(a, 1, inscripcion.persona.cedula)
                    #         ws.write(a, 2, inscripcion.persona.apellido1+' '+inscripcion.persona.apellido2)
                    #         ws.write(a, 3, inscripcion.persona.nombres)
                    #         c = 5
                    #         estado = "APROBADO"
                    #         pasadas = 0
                    #         paralelo = ""
                    #         for nota in MateriaAsignada.objects.filter(matricula=inscripcion.matricula_periodo(lperiodo), status=True).order_by('materia__asignaturamalla__asignatura__id'):
                    #             if paralelo == "":
                    #                 ws.write(a, 4, nota.materia.paralelo)
                    #                 paralelo = nota.materia.paralelo
                    #             ws.write(a, c, nota.notafinal)
                    #             if nota.notafinal < 70:
                    #                 estado = "REPROBADO"
                    #             else:
                    #                 pasadas += 1
                    #             c += 1
                    #         ws.write(a, c, estado)
                    #         ws.write(a, c+1, pasadas)
                    #         a += 1
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'totalaprobadosadmision':
                try:
                    periodo = request.GET['periodo']
                    cursor = connections['sga_select'].cursor()
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=listado_alumnos.xls'
                    wb = xlwt.Workbook()
                    # ws = wb.add_sheet('Sheetname')
                    estilo = xlwt.easyxf(
                        'font: height 350, name Arial, colour_index black, bold on, italic on; align: wrap on, vert centre, horiz center;')
                    # # detallado por carrera
                    lperiodo = Periodo.objects.filter(pk=periodo)[0]
                    carreras = Carrera.objects.filter(malla__asignaturamalla__materia__nivel__periodo__id=periodo,
                                                      coordinacion__id=9).distinct()
                    for carrera in carreras:
                        # asignaturamallas = AsignaturaMalla.objects.filter(status=True, malla__carrera=carrera, materia__nivel__periodo=periodo).order_by('id').distinct()
                        asignaturas = Asignatura.objects.filter(status=True, asignaturamalla__malla__carrera=carrera,
                                                                asignaturamalla__materia__nivel__periodo=periodo).order_by(
                            'id').distinct()
                        ws = wb.add_sheet(u'%s' % carrera.alias)
                        sql = "select tabla1.cedula, tabla1.apellido, tabla1.nombre,tabla1.username as usuario, " \
                              " (select count(*) from sga_matricula mat2 where mat2.status = True and mat2.estado_matricula = 2 and mat2.inscripcion_id = tabla1.inscripcion) as veces, "
                        a = 1
                        for asignaturamalla in asignaturas:
                            sql = sql + " COALESCE((select a1.nombre from sga_materiaasignada mat1, sga_materia m1, sga_asignaturamalla am1, sga_asignatura a1 " \
                                        " where mat1.matricula_id=tabla1.matricula and mat1.status=True and mat1.materia_id=m1.id and m1.status=True and " \
                                        " m1.asignaturamalla_id=am1.id and am1.status=True and am1.asignatura_id=" + str(
                                asignaturamalla.id) + " and am1.asignatura_id=a1.id and a1.status=True), " \
                                                      " '') as materia" + str(a) + ","
                            a += 1
                        a = 1
                        for asignaturamalla in asignaturas:
                            sql = sql + " tabla1.nota" + str(a) + ", "
                            a += 1
                        sql = sql + "tabla1.username as usuario " \
                                    " from (select i.id as inscripcion, ma.id as matricula, p.cedula as cedula, (p.apellido1||' '||p.apellido2) as apellido, p.nombres as nombre, aus.username,  "
                        a = 1
                        tope = TopeAlumnosPrimero.objects.filter(carrera=carrera, periodo=periodo, status=True)
                        cantidadtope = 0
                        if tope:
                            cantidadtope = tope[0].cantidad
                        for asignaturamalla in asignaturas:
                            sql = sql + " COALESCE((select notafinal from sga_materiaasignada mas, sga_materia mat, sga_asignaturamalla am where mas.status=true and mat.status=true and mas.materia_id=mat.id and mas.matricula_id=ma.id " \
                                        " and am.asignatura_id=" + str(
                                asignaturamalla.id) + " and mat.asignaturamalla_id=am.id and am.status=True),0) as nota" + str(
                                a) + "," \
                                     " (select asistenciafinal from sga_materiaasignada mas, sga_materia mat where mas.status=true and mat.status=true and mas.materia_id=mat.id and mas.matricula_id=ma.id " \
                                     " and mat.asignaturamalla_id=" + str(asignaturamalla.id) + ") as asistencia" + str(
                                a) + ", "
                            a += 1
                        sql = sql + " ma.id from sga_matricula ma, sga_nivel ni, sga_inscripcion i, sga_persona p,auth_user aus where ma.status=true and ma.estado_matricula in (2,3) and ma.nivel_id=ni.id and ni.status=true " \
                                    " and ni.periodo_id= " + str(
                            lperiodo.id) + " and i.id=ma.inscripcion_id and i.status=true and i.carrera_id=" + str(
                            carrera.id) + " and p.id=i.persona_id and p.status=true and p.usuario_id=aus.id " \
                                          " order by 2) as tabla1 where 1=1 "
                        sql = sql + " order by 3 desc, 4 desc, 2 asc"

                        # tabla1.nota1 >= 70 and tabla1.nota2 >= 70 and tabla1.nota3 >= 70
                        if cantidadtope != 0:
                            sql = sql + " limit " + str(cantidadtope)
                        estilo = xlwt.easyxf(
                            'font: height 350, name Arial, colour_index black, bold on, italic on; align: wrap on, vert centre, horiz center;')
                        style = xlwt.easyxf(
                            'font: height 150, bold on; border: left thin, right thin, top thin, bottom thin; align: wrap on, vert centre, horiz center;')
                        style1 = xlwt.easyxf('font: bold on; align: wrap on, vert centre, horiz center;')
                        style2 = xlwt.easyxf('font: bold on; align: wrap on, vert centre;')
                        style3 = xlwt.easyxf(
                            'font: height 150; border: left thin, right thin, top thin, bottom thin; align: wrap on, vert centre, horiz center;')
                        style4 = xlwt.easyxf('font: height 150; border: left thin, right thin, top thin, bottom thin;')
                        style5 = xlwt.easyxf('font: bold on; align: wrap on, vert centre, horiz center;')
                        ws.write_merge(0, 0, 0, 5, 'UNIVERSIDAD ESTATAL DE MILAGRO', estilo)
                        ws.write_merge(1, 1, 0, 5, carrera.nombre.upper(), estilo)
                        ws.col(0).width = 1000
                        ws.col(1).width = 3000
                        ws.col(2).width = 6000
                        ws.col(3).width = 6000
                        ws.col(4).width = 5000
                        ws.col(5).width = 5000
                        ws.col(6).width = 5000
                        ws.col(7).width = 5000
                        ws.write(2, 0, 'N.', style)
                        ws.write(2, 1, 'CEDULA', style)
                        ws.write(2, 2, 'APELLIDOS', style)
                        ws.write(2, 3, 'NOMBRES', style)
                        c = 4
                        i = 1
                        for asignaturamalla in asignaturas:
                            ws.write(2, c, u"Asignatura %s" % i, style)
                            c += 1
                            i += 1
                        ws.write(2, c, 'NÚMEROS DE MATRICULA', style)
                        ws.write(2, c + 1, 'PROMEDIO NOTAS', style)
                        ws.write(2, c + 2, 'USUARIO', style)
                        a = 3
                        cursor.execute(sql)
                        inscripciones = cursor.fetchall()
                        for inscripcion in inscripciones:
                            ws.write(a, 0, a - 2, style3)
                            ws.write(a, 1, inscripcion[0], style4)
                            ws.write(a, 2, inscripcion[1], style4)
                            ws.write(a, 3, inscripcion[2], style4)
                            c = 5
                            col = 4
                            i = 1
                            for asi in asignaturas:
                                ws.write(a, col, u"%s" % inscripcion[c], style)
                                c += 1
                                col += 1
                                i += 1
                            suma = 0
                            for asi in asignaturas:
                                suma = suma + inscripcion[c]
                                if inscripcion[c] != '':
                                    c += 1

                            promedio = str(null_to_decimal((suma / c), 2))
                            # ws.write(a, 4, inscripcion[3], style3)
                            # ws.write(a, 5, inscripcion[7], style3)
                            # ws.write(a, 6, inscripcion[4], style3)
                            # ws.write(a, 7, inscripcion[8], style3)
                            # ws.write(a, 8, inscripcion[5], style3)
                            # ws.write(a, 9, inscripcion[9], style3)
                            # ws.write(a, 4+i, inscripcion[3], style3)
                            # ws.write(a, 5+i, inscripcion[4], style3)
                            ws.write(a, 3 + i, u"%s" % inscripcion[4], style3)
                            ws.write(a, 4 + i, promedio, style3)
                            ws.write(a, 5 + i, inscripcion[3], style3)
                            a += 1

                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'totalactividadesdocentes':
                try:
                    periodo = request.GET['periodo']
                    cursor = connections['sga_select'].cursor()
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=listado_actividaddocente.xls'
                    wb = xlwt.Workbook()
                    ws = wb.add_sheet('Sheetname')
                    estilo = xlwt.easyxf(
                        'font: height 350, name Arial, colour_index black, bold on, italic on; align: wrap on, vert centre, horiz center;')
                    ws.col(0).width = 1000
                    ws.col(1).width = 3000
                    ws.col(2).width = 10000
                    ws.col(3).width = 4000
                    ws.col(4).width = 10000
                    ws.col(5).width = 0
                    ws.col(6).width = 6000
                    ws.col(7).width = 2000
                    ws.col(8).width = 6000
                    ws.col(9).width = 6000
                    ws.col(10).width = 6000
                    ws.write(0, 0, 'N.')
                    ws.write(0, 1, 'CRITERIO')
                    ws.write(0, 2, 'FACULTAD')
                    ws.write(0, 3, 'CEDULA')
                    ws.write(0, 4, 'APELLIDOS Y NOMBRES')
                    ws.write(0, 5, 'USUARIO')
                    ws.write(0, 6, 'ACTIVIDAD')
                    ws.write(0, 7, 'HORAS')
                    ws.write(0, 8, 'DEDICACION')
                    ws.write(0, 9, 'TIPO PRPFESOR')
                    ws.write(0, 10, u'CATEGORIZACIÓN')
                    ws.write(0, 11, u'ESCALAFON')
                    ws.write(0, 12, 'SEXO')
                    a = 0
                    date_format = xlwt.XFStyle()
                    date_format.num_format_str = 'yyyy/mm/dd'
                    listaestudiante = "select 'Docencia' as criterio,coor.nombre as facultad,per.apellido1, per.apellido2 , per.nombres as docente, " \
                                      " cri.nombre as actividad,detdis.horas,us.username, td.nombre,(select cat.nombre from sga_categorizaciondocente cat where cat.id=dis.categoria_id ), per.cedula, " \
                                      "(select sex.nombre from sga_sexo sex where sex.id=per.sexo_id ) as sexo , (select cat.nombre from sga_profesortipo cat where cat.id=dis.nivelcategoria_id) as nivelcategoria, " \
                                      " (select cat.nombre from sga_nivelescalafondocente cat where cat.id=dis.nivelescalafon_id) as nivelcategoria " \
                                      " from sga_profesordistributivohoras dis,sga_detalledistributivo detdis,sga_criteriodocenciaperiodo critd, " \
                                      " sga_tiempodedicaciondocente td, " \
                                      " sga_criteriodocencia cri, sga_profesor pro,sga_persona per, sga_coordinacion coor,auth_user us " \
                                      " where dis.profesor_id=pro.id and td.id=dis.dedicacion_id " \
                                      " and pro.persona_id=per.id " \
                                      " and per.usuario_id=us.id " \
                                      " and dis.coordinacion_id=coor.id  " \
                                      " and dis.id=detdis.distributivo_id " \
                                      " and detdis.criteriodocenciaperiodo_id=critd.id " \
                                      " and critd.criterio_id=cri.id " \
                                      " and detdis.criteriodocenciaperiodo_id is not null " \
                                      " and dis.periodo_id='" + periodo + "' " \
                                                                          " union all " \
                                                                          " select 'Investigacion' as criterio,coor.nombre as facultad,per.apellido1 , per.apellido2, per.nombres as docente, " \
                                                                          " cri.nombre as actividad,detdis.horas,us.username , td.nombre,(select cat.nombre from sga_categorizaciondocente cat where cat.id=dis.categoria_id ), per.cedula, " \
                                                                          " (select sex.nombre from sga_sexo sex where sex.id=per.sexo_id ) as sexo , (select cat.nombre from sga_profesortipo cat where cat.id=dis.nivelcategoria_id) as nivelcategoria, " \
                                                                          " (select cat.nombre from sga_nivelescalafondocente cat where cat.id=dis.nivelescalafon_id) as nivelcategoria " \
                                                                          " from sga_profesordistributivohoras dis,sga_detalledistributivo detdis,sga_criterioinvestigacionperiodo critd, " \
                                                                          " sga_tiempodedicaciondocente td, " \
                                                                          " sga_criterioinvestigacion cri, sga_profesor pro,sga_persona per, sga_coordinacion coor,auth_user us " \
                                                                          " where dis.profesor_id=pro.id " \
                                                                          " and td.id=dis.dedicacion_id " \
                                                                          " and pro.persona_id=per.id " \
                                                                          " and per.usuario_id=us.id " \
                                                                          " and dis.coordinacion_id=coor.id " \
                                                                          " and dis.id=detdis.distributivo_id " \
                                                                          " and detdis.criterioinvestigacionperiodo_id=critd.id " \
                                                                          " and critd.criterio_id=cri.id  " \
                                                                          " and detdis.criterioinvestigacionperiodo_id is not null " \
                                                                          " and dis.periodo_id='" + periodo + "'  " \
                                                                                                              " union all  " \
                                                                                                              " select 'Gestion' as criterio,coor.nombre as facultad,per.apellido1 , per.apellido2 , per.nombres as docente, " \
                                                                                                              " cri.nombre as actividad,detdis.horas,us.username , td.nombre,(select cat.nombre from sga_categorizaciondocente cat where cat.id=dis.categoria_id ), per.cedula, " \
                                                                                                              " (select sex.nombre from sga_sexo sex where sex.id=per.sexo_id ) as sexo , (select cat.nombre from sga_profesortipo cat where cat.id=dis.nivelcategoria_id) as nivelcategoria, " \
                                                                                                              " (select cat.nombre from sga_nivelescalafondocente cat where cat.id=dis.nivelescalafon_id) as nivelcategoria " \
                                                                                                              " from sga_profesordistributivohoras dis,sga_detalledistributivo detdis,sga_criteriogestionperiodo critd, " \
                                                                                                              " sga_tiempodedicaciondocente td,  " \
                                                                                                              " sga_criteriogestion cri, sga_profesor pro,sga_persona per, sga_coordinacion coor,auth_user us " \
                                                                                                              " where dis.profesor_id=pro.id  " \
                                                                                                              " and td.id=dis.dedicacion_id   " \
                                                                                                              " and pro.persona_id=per.id  " \
                                                                                                              " and per.usuario_id=us.id  " \
                                                                                                              " and dis.coordinacion_id=coor.id " \
                                                                                                              " and dis.id=detdis.distributivo_id  " \
                                                                                                              " and detdis.criteriogestionperiodo_id=critd.id " \
                                                                                                              " and critd.criterio_id=cri.id  " \
                                                                                                              " and detdis.criteriogestionperiodo_id is not null " \
                                                                                                              " and dis.periodo_id='" + periodo + "';"
                    cursor.execute(listaestudiante)
                    results = cursor.fetchall()
                    for per in results:
                        a += 1
                        ws.write(a, 0, a)
                        ws.write(a, 1, per[0])
                        ws.write(a, 2, per[1])
                        ws.write(a, 3, per[10])
                        ws.write(a, 4, per[2] + ' ' + per[3] + ' ' + per[4])
                        ws.write(a, 5, per[7])
                        ws.write(a, 6, per[5])
                        ws.write(a, 7, per[6])
                        ws.write(a, 8, per[8])
                        ws.write(a, 9, per[12])
                        ws.write(a, 10, per[9])
                        ws.write(a, 11, per[13])
                        ws.write(a, 12, per[11])
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'totalactividadesdocentesmaterias':
                try:
                    periodo = request.GET['periodo']
                    cursor = connections['sga_select'].cursor()
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=listado_actividaddocente.xls'
                    wb = xlwt.Workbook()
                    ws = wb.add_sheet('Sheetname')
                    estilo = xlwt.easyxf(
                        'font: height 350, name Arial, colour_index black, bold on, italic on; align: wrap on, vert centre, horiz center;')
                    # ws.write_merge(0, 0, 0, 5, 'UNIVERSIDAD ESTATAL DE MILAGRO', estilo)
                    ws.col(0).width = 10000
                    ws.col(1).width = 4000
                    ws.col(2).width = 4000
                    ws.col(3).width = 2000
                    ws.col(4).width = 6000
                    ws.col(5).width = 2000
                    ws.col(6).width = 10000
                    ws.col(7).width = 3000
                    ws.col(8).width = 3000
                    ws.col(9).width = 6000
                    ws.col(10).width = 6000
                    ws.col(11).width = 4000
                    ws.col(12).width = 6000
                    ws.col(13).width = 4000
                    ws.col(14).width = 10000
                    ws.col(15).width = 10000
                    ws.col(16).width = 5000
                    ws.col(17).width = 5000
                    ws.col(18).width = 5000
                    ws.write(0, 0, 'CARRERA')
                    ws.write(0, 1, 'SECCION')
                    ws.write(0, 2, 'NIVEL')
                    ws.write(0, 3, 'PARALELO')
                    ws.write(0, 4, 'ACTIVIDADES/MATERIAS')
                    ws.write(0, 5, 'HORAS')
                    ws.write(0, 6, 'APELLIDOS Y NOMBRES')
                    ws.write(0, 7, 'CRITERIO')
                    ws.write(0, 8, 'CEDULA')
                    ws.write(0, 9, 'CORREO INSTITUCIONAL')
                    ws.write(0, 10, u'CATEGORIZACIÓN')
                    ws.write(0, 11, 'DEDICACION')
                    ws.write(0, 12, 'FACULTAD')
                    ws.write(0, 13, 'TIPO PROFESOR')
                    ws.write(0, 14, 'TITULO TERCER NIVEL')
                    ws.write(0, 15, 'TITULO MASTER')
                    ws.write(0, 16, 'TITULO PHD')
                    ws.write(0, 17, 'ETNIA')
                    ws.write(0, 18, 'SEXO')
                    ws.write(0, 19, 'LGTBI')
                    a = 0
                    date_format = xlwt.XFStyle()
                    date_format.num_format_str = 'yyyy/mm/dd'
                    listaestudiante = "select 'Docencia' as criterio,coor.nombre as facultad,per.apellido1, per.apellido2 , per.nombres as docente, " \
                                      "null,null as nivel,null, cri.nombre as actividad,detdis.horas,us.username, td.nombre, " \
                                      "(select cat.nombre from sga_categorizaciondocente cat  " \
                                      "where cat.id=dis.categoria_id ),null,per.cedula,per.emailinst,us.username, " \
                                      "null as tipoprofesor,(SELECT array_to_string(array_agg(tit.nombre || '-' || ins.nombre),',')  FROM sga_titulacion tc " \
                                      " left join sga_titulo tit  on tc.titulo_id=tit.id " \
                                      "left join sga_institucioneducacionsuperior ins  on ins.id=tc.institucion_id " \
                                      "where tc.persona_id=per.id " \
                                      "and tit.nivel_id=4 " \
                                      "and tit.grado_id in(2, 5) and tc.verificado=true) as master , " \
                                      "(SELECT array_to_string(array_agg(tit.nombre),',') FROM sga_titulacion tc ,sga_titulo tit  " \
                                      "where tc.titulo_id=tit.id and tc.persona_id=per.id and tit.nivel_id=4 and tit.grado_id=1 and tc.verificado=true) as phd," \
                                      "(select (raza.nombre) from sga_perfilinscripcion perfil,sga_raza raza where perfil.raza_id=raza.id and perfil.persona_id=per.id and perfil.status=True)  as etnia,  " \
                                      "(select nombre from sga_sexo sexo where sexo.id=per.sexo_id ) as sexo,per.lgtbi, " \
                                      "(SELECT array_to_string(array_agg(tit.nombre || '-' || ins.nombre),',')  FROM sga_titulacion tc " \
                                      "left join sga_titulo tit  on tc.titulo_id=tit.id " \
                                      "left join sga_institucioneducacionsuperior ins  on ins.id=tc.institucion_id " \
                                      "where tc.persona_id=per.id " \
                                      "and tit.nivel_id=3  and tc.verificado=true) as tercernivel  " \
                                      "from sga_profesordistributivohoras dis,sga_detalledistributivo detdis,sga_criteriodocenciaperiodo critd,  " \
                                      "sga_tiempodedicaciondocente td,  " \
                                      "sga_criteriodocencia cri, sga_profesor pro,sga_persona per, sga_coordinacion coor,auth_user us  " \
                                      "where dis.profesor_id=pro.id  " \
                                      "and td.id=dis.dedicacion_id  " \
                                      "and pro.persona_id=per.id   " \
                                      "and per.usuario_id=us.id  " \
                                      "and dis.coordinacion_id=coor.id  " \
                                      "and dis.id=detdis.distributivo_id  " \
                                      "and detdis.criteriodocenciaperiodo_id=critd.id  " \
                                      "and critd.criterio_id=cri.id  " \
                                      "and detdis.criteriodocenciaperiodo_id is not null  " \
                                      "and dis.periodo_id='" + periodo + "' and cri.id not in (15,16,17,18)  " \
                                                                         "union all  " \
                                                                         "select 'Investigacion' as criterio,coor.nombre as facultad,per.apellido1 , per.apellido2, per.nombres as docente,  " \
                                                                         "null,null as nivel,null, cri.nombre as actividad,detdis.horas,us.username , td.nombre, " \
                                                                         "(select cat.nombre from sga_categorizaciondocente cat where cat.id=dis.categoria_id ), " \
                                                                         "null,per.cedula,per.emailinst,us.username,null as tipoprofesor,(SELECT array_to_string(array_agg(tit.nombre || '-' || ins.nombre),',')  FROM sga_titulacion tc " \
                                                                         " left join sga_titulo tit  on tc.titulo_id=tit.id " \
                                                                         "left join sga_institucioneducacionsuperior ins  on ins.id=tc.institucion_id " \
                                                                         "where tc.persona_id=per.id " \
                                                                         "and tit.nivel_id=4 " \
                                                                         "and tit.grado_id in(2, 5) and tc.verificado=true) as master , " \
                                                                         "(SELECT array_to_string(array_agg(tit.nombre),',') FROM sga_titulacion tc ,sga_titulo tit  " \
                                                                         "where tc.titulo_id=tit.id and tc.persona_id=per.id and tit.nivel_id=4 and tit.grado_id=1 and tc.verificado=true) as phd,  " \
                                                                         "(select (raza.nombre) from sga_perfilinscripcion perfil,sga_raza raza where perfil.raza_id=raza.id and perfil.persona_id=per.id and perfil.status=True)  as etnia,  " \
                                                                         "(select nombre from sga_sexo sexo where sexo.id=per.sexo_id ) as sexo,per.lgtbi, " \
                                                                         "(SELECT array_to_string(array_agg(tit.nombre || '-' || ins.nombre),',')  FROM sga_titulacion tc " \
                                                                         "left join sga_titulo tit  on tc.titulo_id=tit.id " \
                                                                         "left join sga_institucioneducacionsuperior ins  on ins.id=tc.institucion_id " \
                                                                         "where tc.persona_id=per.id " \
                                                                         "and tit.nivel_id=3  and tc.verificado=true) as tercernivel  " \
                                                                         "from sga_profesordistributivohoras dis,sga_detalledistributivo detdis,sga_criterioinvestigacionperiodo critd,  " \
                                                                         "sga_tiempodedicaciondocente td,  " \
                                                                         "sga_criterioinvestigacion cri, sga_profesor pro,sga_persona per, sga_coordinacion coor,auth_user us  " \
                                                                         "where dis.profesor_id=pro.id   " \
                                                                         "and td.id=dis.dedicacion_id  " \
                                                                         "and pro.persona_id=per.id  " \
                                                                         "and per.usuario_id=us.id  " \
                                                                         "and dis.coordinacion_id=coor.id  " \
                                                                         "and dis.id=detdis.distributivo_id  " \
                                                                         "and detdis.criterioinvestigacionperiodo_id=critd.id  " \
                                                                         "and critd.criterio_id=cri.id  " \
                                                                         "and detdis.criterioinvestigacionperiodo_id is not null  " \
                                                                         "and dis.periodo_id='" + periodo + "' " \
                                                                                                            "union all  " \
                                                                                                            "select 'Gestion' as criterio,coor.nombre as facultad,per.apellido1 , per.apellido2 , per.nombres as docente,  " \
                                                                                                            "null,null as nivel,null, cri.nombre as actividad,detdis.horas,us.username , td.nombre, " \
                                                                                                            "(select cat.nombre from sga_categorizaciondocente cat where cat.id=dis.categoria_id ),null, " \
                                                                                                            "per.cedula,per.emailinst,us.username,null as tipoprofesor ,(SELECT array_to_string(array_agg(tit.nombre || '-' || ins.nombre),',')  FROM sga_titulacion tc " \
                                                                                                            " left join sga_titulo tit  on tc.titulo_id=tit.id " \
                                                                                                            "left join sga_institucioneducacionsuperior ins  on ins.id=tc.institucion_id " \
                                                                                                            "where tc.persona_id=per.id " \
                                                                                                            "and tit.nivel_id=4 " \
                                                                                                            "and tit.grado_id in(2, 5) and tc.verificado=true) as master , " \
                                                                                                            "(SELECT array_to_string(array_agg(tit.nombre),',') FROM sga_titulacion tc ,sga_titulo tit  " \
                                                                                                            "where tc.titulo_id=tit.id and tc.persona_id=per.id and tit.nivel_id=4 and tit.grado_id=1 and tc.verificado=true) as phd,  " \
                                                                                                            "(select (raza.nombre) from sga_perfilinscripcion perfil,sga_raza raza where perfil.raza_id=raza.id and perfil.persona_id=per.id and perfil.status=True)  as etnia, " \
                                                                                                            "(select nombre from sga_sexo sexo where sexo.id=per.sexo_id ) as sexo,per.lgtbi, " \
                                                                                                            "(SELECT array_to_string(array_agg(tit.nombre || '-' || ins.nombre),',')  FROM sga_titulacion tc " \
                                                                                                            "left join sga_titulo tit  on tc.titulo_id=tit.id " \
                                                                                                            "left join sga_institucioneducacionsuperior ins  on ins.id=tc.institucion_id " \
                                                                                                            "where tc.persona_id=per.id " \
                                                                                                            "and tit.nivel_id=3  and tc.verificado=true) as tercernivel  " \
                                                                                                            "from sga_profesordistributivohoras dis,sga_detalledistributivo detdis,sga_criteriogestionperiodo critd,  " \
                                                                                                            "sga_tiempodedicaciondocente td,  " \
                                                                                                            "sga_criteriogestion cri, sga_profesor pro,sga_persona per, sga_coordinacion coor,auth_user us  " \
                                                                                                            "where dis.profesor_id=pro.id  " \
                                                                                                            "and td.id=dis.dedicacion_id   " \
                                                                                                            "and pro.persona_id=per.id  " \
                                                                                                            "and per.usuario_id=us.id  " \
                                                                                                            "and dis.coordinacion_id=coor.id  " \
                                                                                                            "and dis.id=detdis.distributivo_id  " \
                                                                                                            "and detdis.criteriogestionperiodo_id=critd.id  " \
                                                                                                            "and critd.criterio_id=cri.id  " \
                                                                                                            "and detdis.criteriogestionperiodo_id is not null  " \
                                                                                                            "and dis.periodo_id='" + periodo + "' " \
                                                                                                                                               "union all  " \
                                                                                                                                               "select 'Materias' as criterio,coor.nombre as facultad,per.apellido1 , per.apellido2 , per.nombres as docente,  " \
                                                                                                                                               "mat.paralelo,nmalla.nombre as nivel,carr.nombre || ' ' || carr.mencion as carreras, asig.nombre as actividad,mat.horassemanales,us.username ,  " \
                                                                                                                                               "td.nombre,(select cat.nombre from sga_categorizaciondocente cat, sga_profesordistributivohoras dist " \
                                                                                                                                               "where cat.id=dist.categoria_id and dist.periodo_id='" + periodo + "' and dist.profesor_id=pro.id ),ses.nombre as sesion, " \
                                                                                                                                                                                                                  "per.cedula,per.emailinst,us.username,tipro.nombre as tipoprofesor,(SELECT array_to_string(array_agg(tit.nombre || '-' || ins.nombre),',')  FROM sga_titulacion tc " \
                                                                                                                                                                                                                  " left join sga_titulo tit  on tc.titulo_id=tit.id " \
                                                                                                                                                                                                                  "left join sga_institucioneducacionsuperior ins  on ins.id=tc.institucion_id " \
                                                                                                                                                                                                                  "where tc.persona_id=per.id " \
                                                                                                                                                                                                                  "and tit.nivel_id=4 " \
                                                                                                                                                                                                                  "and tit.grado_id in(2, 5) and tc.verificado=true) as master , " \
                                                                                                                                                                                                                  "(SELECT array_to_string(array_agg(tit.nombre),',') FROM sga_titulacion tc ,sga_titulo tit  " \
                                                                                                                                                                                                                  "where tc.titulo_id=tit.id and tc.persona_id=per.id and tit.nivel_id=4 and tit.grado_id=1 and tc.verificado=true) as phd,  " \
                                                                                                                                                                                                                  "(select (raza.nombre) from sga_perfilinscripcion perfil,sga_raza raza where perfil.raza_id=raza.id and perfil.persona_id=per.id and perfil.status=True)  as etnia,  " \
                                                                                                                                                                                                                  "(select nombre from sga_sexo sexo where sexo.id=per.sexo_id ) as sexo,per.lgtbi, " \
                                                                                                                                                                                                                  "(SELECT array_to_string(array_agg(tit.nombre || '-' || ins.nombre),',')  FROM sga_titulacion tc " \
                                                                                                                                                                                                                  "left join sga_titulo tit  on tc.titulo_id=tit.id " \
                                                                                                                                                                                                                  "left join sga_institucioneducacionsuperior ins  on ins.id=tc.institucion_id " \
                                                                                                                                                                                                                  "where tc.persona_id=per.id " \
                                                                                                                                                                                                                  "and tit.nivel_id=3  and tc.verificado=true) as tercernivel  " \
                                                                                                                                                                                                                  "from sga_profesormateria pmat,sga_materia mat,sga_nivel niv,sga_profesor pro,sga_persona per,  " \
                                                                                                                                                                                                                  "sga_asignaturamalla asimalla,sga_malla malla,sga_carrera carr,sga_asignatura asig,  " \
                                                                                                                                                                                                                  "sga_nivelmalla nmalla,auth_user us,sga_coordinacion_carrera corcar,sga_coordinacion coor,  " \
                                                                                                                                                                                                                  "sga_tiempodedicaciondocente td ,sga_sesion ses, sga_tipoprofesor tipro  " \
                                                                                                                                                                                                                  "where pmat.profesor_id=pro.id  " \
                                                                                                                                                                                                                  "and pro.persona_id=per.id   " \
                                                                                                                                                                                                                  "and per.usuario_id=us.id    " \
                                                                                                                                                                                                                  "and pro.dedicacion_id=td.id  " \
                                                                                                                                                                                                                  "and pmat.materia_id=mat.id  " \
                                                                                                                                                                                                                  "and mat.nivel_id=niv.id and niv.sesion_id=ses.id  " \
                                                                                                                                                                                                                  "and mat.asignaturamalla_id=asimalla.id  " \
                                                                                                                                                                                                                  "and asimalla.malla_id=malla.id  " \
                                                                                                                                                                                                                  "and malla.carrera_id=carr.id  " \
                                                                                                                                                                                                                  "and corcar.carrera_id=carr.id  " \
                                                                                                                                                                                                                  "and corcar.coordinacion_id=coor.id and tipro.id not in (3,4) " \
                                                                                                                                                                                                                  "and asimalla.asignatura_id=asig.id and asimalla.nivelmalla_id=nmalla.id and pmat.tipoprofesor_id=tipro.id  " \
                                                                                                                                                                                                                  "and niv.periodo_id='" + periodo + "' "
                    cursor.execute(listaestudiante)
                    results = cursor.fetchall()
                    for per in results:
                        a += 1
                        ws.write(a, 0, per[7])
                        ws.write(a, 1, per[13])
                        ws.write(a, 2, per[6])
                        ws.write(a, 3, per[5])
                        ws.write(a, 4, per[8])
                        ws.write(a, 5, per[9])
                        ws.write(a, 6, per[2] + ' ' + per[3] + ' ' + per[4])
                        ws.write(a, 7, per[0])
                        ws.write(a, 8, per[14])
                        ws.write(a, 9, per[16] + '@unemi.edu.ec')
                        ws.write(a, 10, per[12])
                        ws.write(a, 11, per[11])
                        ws.write(a, 12, per[1])
                        ws.write(a, 13, per[17])
                        ws.write(a, 14, per[23])
                        ws.write(a, 15, per[18])
                        ws.write(a, 16, per[19])
                        ws.write(a, 17, per[20])
                        ws.write(a, 18, per[21])
                        if per[22]:
                            lgtbi = 'SI'
                        else:
                            lgtbi = 'NO'
                        ws.write(a, 19, lgtbi)
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'totalmatriculadossolomodulos':
                try:
                    periodo = request.GET['periodo']
                    cursor = connections['sga_select'].cursor()
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=listado_alumnos.xls'
                    wb = xlwt.Workbook()
                    ws = wb.add_sheet('Sheetname')
                    estilo = xlwt.easyxf(
                        'font: height 350, name Arial, colour_index black, bold on, italic on; align: wrap on, vert centre, horiz center;')
                    ws.write_merge(0, 0, 0, 9, 'UNIVERSIDAD ESTATAL DE MILAGRO', estilo)
                    ws.col(0).width = 1000
                    ws.col(1).width = 6000
                    ws.col(2).width = 3000
                    ws.col(3).width = 3000
                    ws.col(4).width = 6000
                    ws.col(5).width = 6000
                    ws.col(6).width = 6000
                    ws.col(7).width = 6000
                    ws.col(8).width = 6000
                    ws.col(9).width = 6000
                    ws.col(10).width = 1000
                    ws.write(4, 0, 'N.')
                    ws.write(4, 1, 'PERIODO')
                    ws.write(4, 2, 'NIVEL')
                    ws.write(4, 3, 'SECCION')
                    ws.write(4, 4, 'CEDULA')
                    ws.write(4, 5, 'APELLIDOS')
                    ws.write(4, 6, 'NOMBRES')
                    ws.write(4, 7, 'SEXO')
                    ws.write(4, 8, 'EMAIL')
                    ws.write(4, 9, 'EMAILINST')
                    ws.write(4, 10, 'COORDINACION')
                    ws.write(4, 11, 'CARRERA')
                    ws.write(4, 12, 'TELEFONO')
                    a = 4
                    date_format = xlwt.XFStyle()
                    date_format.num_format_str = 'yyyy/mm/dd'
                    listaestudiante = "select mat.id,per.nombre as periodo,nv.nombre as nivel,p.cedula,p.apellido1,p.apellido2,p.nombres,p.email,p.emailinst, " \
                                      "coor.nombre as coordinacion,car.nombre as carrera, p.sexo_id as sexo,ses.nombre as sesion,p.telefono " \
                                      "from sga_matricula mat,sga_inscripcion i,sga_persona p,sga_nivel n,sga_carrera car,sga_coordinacion coor, " \
                                      "sga_coordinacion_carrera cca, sga_periodo per, sga_nivelmalla nv,sga_inscripcionnivel inniv,sga_sesion ses " \
                                      "where mat.inscripcion_id=i.id and i.persona_id=p.id and mat.nivel_id=n.id and i.carrera_id=car.id and car.id=cca.carrera_id " \
                                      "and cca.coordinacion_id=coor.id and n.periodo_id=per.id and i.id=inniv.inscripcion_id and inniv.nivel_id=nv.id " \
                                      "and n.periodo_id='" + periodo + "' and i.sesion_id=ses.id and mat.id in(select ma.id from (select  mat.id as id,count(ma.materia_id)  as numero " \
                                                                       "from sga_Matricula mat , sga_Nivel n,sga_materiaasignada ma,sga_materia mate, " \
                                                                       "sga_asignatura asi where mat.nivel_id=n.id and mat.id=ma.matricula_id " \
                                                                       "and ma.materia_id=mate.id and mate.asignatura_id=asi.id and n.periodo_id='" + periodo + "' " \
                                                                                                                                                                "and asi.modulo=True group by mat.id) ma,(select  mat.id as id, count(ma.materia_id) as numero " \
                                                                                                                                                                "from sga_Matricula mat , sga_Nivel n,sga_materiaasignada ma, " \
                                                                                                                                                                "sga_materia mate, sga_asignatura asi where mat.nivel_id=n.id and mat.id=ma.matricula_id " \
                                                                                                                                                                "and ma.materia_id=mate.id and mate.asignatura_id=asi.id and n.periodo_id='" + periodo + "' group by mat.id) mo " \
                                                                                                                                                                                                                                                         "where ma.id=mo.id and ma.numero=mo.numero);"
                    cursor.execute(listaestudiante)
                    results = cursor.fetchall()
                    for per in results:
                        a += 1
                        ws.write(a, 0, a - 4)
                        ws.write(a, 1, per[1])
                        ws.write(a, 2, per[2])
                        ws.write(a, 3, per[12])
                        ws.write(a, 4, per[3])
                        ws.write(a, 5, per[4] + ' ' + per[5])
                        ws.write(a, 6, per[6])
                        if per[11] == 1:
                            sexo = 'FEMENINO'
                        else:
                            sexo = 'MASCULINO'
                        ws.write(a, 7, sexo)
                        ws.write(a, 8, per[7])
                        ws.write(a, 9, per[8])
                        ws.write(a, 10, per[9])
                        ws.write(a, 11, per[10])
                        ws.write(a, 12, per[13])
                    # ws.write(a+2, 0, 'Fecha:')
                    # ws.write(a+2, 1, datetime.today(),date_format)
                    ws.write_merge(a + 2, a + 2, 0, 1, datetime.today(), date_format)
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'docentes':
                try:
                    periodo = request.GET['periodo']

                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=prematricula_asignaturas.xls'
                    __author__ = 'Unemi'
                    style0 = easyxf('font: name Times New Roman, color-index blue, bold off', num_format_str='#,##0.00')
                    style_nb = easyxf('font: name Times New Roman, color-index blue, bold on',
                                      num_format_str='#,##0.00')
                    style_sb = easyxf('font: name Times New Roman, color-index blue, bold on')
                    title = easyxf(
                        'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    style1 = easyxf(num_format_str='D-MMM-YY')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('exp_xls_post_part')
                    ws.write_merge(0, 0, 0, 6, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)

                    ws.col(0).width = 6000
                    ws.col(1).width = 6000
                    ws.col(2).width = 6000
                    ws.col(3).width = 6000
                    ws.col(4).width = 6000
                    ws.col(5).width = 6000
                    ws.col(6).width = 6000

                    ws.write(4, 0, 'DOCENTE')
                    ws.write(4, 1, 'CARRERA')
                    ws.write(4, 2, 'ASIGNATURA')
                    ws.write(4, 3, 'TITULAR')
                    ws.write(4, 4, 'TIPO DE CONTRATO')
                    ws.write(4, 5, 'CATEGORIA')
                    ws.write(4, 6, 'DEDICACIÓN')

                    a = 4
                    date_format = xlwt.XFStyle()
                    date_format.num_format_str = 'yyyy/mm/dd'
                    profesores = ProfesorMateria.objects.filter(materia__nivel__periodo=periodo,
                                                                status=True).distinct().order_by(
                        'profesor__persona__apellido1', 'profesor__persona__apellido2').exclude(tipoprofesor__id=4)
                    for profesor in profesores:
                        a += 1
                        ws.write(a, 0, u'%s' % profesor.profesor.persona.nombre_completo_inverso())
                        ws.write(a, 1, u'%s' % profesor.materia.carrera().nombre_completo())
                        ws.write(a, 2, u'%s' % profesor.materia.asignatura.nombre)
                        if profesor.principal:
                            ws.write(a, 3, "SI")
                        else:
                            ws.write(a, 3, "NO")
                        nivelcategoria = ""
                        if profesor.profesor.distributivohoraseval(periodo):
                            if profesor.profesor.distributivohoraseval(periodo).nivelcategoria:
                                nivelcategoria = u'%s' % profesor.profesor.distributivohoraseval(
                                    periodo).nivelcategoria.nombre
                        ws.write(a, 4, nivelcategoria)
                        categoria = ""
                        if profesor.profesor.distributivohoraseval(periodo):
                            if profesor.profesor.distributivohoraseval(periodo).categoria:
                                categoria = u'%s' % profesor.profesor.distributivohoraseval(periodo).categoria.nombre
                        nivelescalafon = ""
                        if profesor.profesor.distributivohoraseval(periodo):
                            if profesor.profesor.distributivohoraseval(periodo).nivelescalafon:
                                nivelescalafon = profesor.profesor.distributivohoraseval(periodo).nivelescalafon.nombre

                        ws.write(a, 5, categoria + ' ' + nivelescalafon)
                        dedicacion = ""
                        if profesor.profesor.distributivohoraseval(periodo):
                            dedicacion = u'%s' % profesor.profesor.distributivohoraseval(periodo).dedicacion.nombre
                        ws.write(a, 6, dedicacion)
                    # ws.write(a+2, 0, 'Fecha:')
                    # ws.write(a+2, 1, datetime.today(),date_format)
                    a += 1
                    # ws.write_merge(a + 2, a + 2, 0, 1, datetime.today(), date_format)
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'reportehorarioexamen':
                try:
                    # periodo = request.GET['periodo']
                    # coordinacion = request.GET['coordinacion']

                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=horarioexamen.xls'
                    __author__ = 'Unemi'
                    style0 = easyxf('font: name Times New Roman, color-index blue, bold off', num_format_str='#,##0.00')
                    style_nb = easyxf('font: name Times New Roman, color-index blue, bold on',
                                      num_format_str='#,##0.00')
                    style_sb = easyxf('font: name Times New Roman, color-index blue, bold on')
                    title = easyxf(
                        'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    style1 = easyxf(num_format_str='D-MMM-YY')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('exp_xls_post_part')
                    ws.write_merge(0, 0, 0, 6, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)

                    ws.col(0).width = 6000
                    ws.col(1).width = 6000
                    ws.col(2).width = 6000
                    ws.col(3).width = 6000
                    ws.col(4).width = 6000
                    ws.col(5).width = 6000
                    ws.col(6).width = 6000
                    ws.col(7).width = 6000
                    ws.col(8).width = 6000
                    ws.col(9).width = 6000

                    ws.write(4, 0, 'FACULTAD')
                    ws.write(4, 1, 'CARRERA')
                    ws.write(4, 2, 'NIVEL')
                    ws.write(4, 3, 'PARALELO')
                    ws.write(4, 4, 'ASIGNATURA')
                    ws.write(4, 5, 'FECHA')
                    ws.write(4, 6, 'TURNO')
                    ws.write(4, 7, 'PARCIAL')
                    ws.write(4, 8, 'AULA')
                    ws.write(4, 9, 'DIRECTOR DE CARRERA')

                    a = 5
                    date_format = xlwt.XFStyle()
                    date_format.num_format_str = 'yyyy/mm/dd'

                    materias = Materia.objects.filter(status=True, nivel__periodo=periodo).distinct().order_by('nivel')

                    for materia in materias:
                        ws.write(a, 0, u'%s' % materia.asignaturamalla.malla.carrera.coordinacion_set.all()[0].nombre)
                        ws.write(a, 1, u'%s' % materia.asignaturamalla.malla.carrera.nombre)
                        ws.write(a, 2, u'%s' % materia.asignaturamalla.nivelmalla.nombre)
                        ws.write(a, 3, u'%s' % materia.paralelo)
                        ws.write(a, 4, u'%s' % materia.asignatura.nombre)
                        horarioexamenes = materia.horarioexamen()
                        if not horarioexamenes:
                            ws.write(a, 5, u'%s' % 'NO REGISTRA')
                            ws.write(a, 6, u'%s' % 'NO REGISTRA')
                            ws.write(a, 7, u'%s' % 'NO REGISTRA')
                            ws.write(a, 8, u'%s' % 'NO REGISTRA')
                        else:
                            for horarioexamen in horarioexamenes:
                                ws.write(a, 5, u'%s' % horarioexamen.fecha)
                                ws.write(a, 6, u'Turno %s [%s a %s]' % (
                                    str(horarioexamen.turno.turno), horarioexamen.turno.comienza.strftime("%H:%M %p"),
                                    horarioexamen.turno.termina.strftime("%H:%M %p")))
                                ws.write(a, 7, u'%s' % horarioexamen.detallemodelo.parcial() if horarioexamen.detallemodelo else "")
                                aulas = ""
                                for aula in horarioexamen.materia.aulas():
                                    aulas = aulas + aula.nombre
                                    aulas = aulas + ","
                                if aulas.__len__() > 0:
                                    aulas = aulas[0:aulas.__len__() - 1]
                                ws.write(a, 8, u'%s' % aulas)
                        ws.write(a, 9, u'%s' % materia.asignaturamalla.malla.carrera.get_director(periodo).persona)
                        a += 1
                    # ws.write_merge(a + 2, a + 2, 0, 1, datetime.today(), date_format)
                    wb.save(response)
                    return response
                except Exception as ex:
                    # messages.error(request, str(ex))
                    return redirect("{}?info={}".format(request.path, ex))

            elif action == 'reportereactivo':
                try:
                    periodo = request.GET['periodo']

                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=reactivo.xls'
                    __author__ = 'Unemi'
                    style0 = easyxf('font: name Times New Roman, color-index blue, bold off', num_format_str='#,##0.00')
                    style_nb = easyxf('font: name Times New Roman, color-index blue, bold on',
                                      num_format_str='#,##0.00')
                    style_sb = easyxf('font: name Times New Roman, color-index blue, bold on')
                    title = easyxf(
                        'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    style1 = easyxf(num_format_str='D-MMM-YY')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('exp_xls_post_part')
                    ws.write_merge(0, 0, 0, 6, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)

                    ws.col(0).width = 6000
                    ws.col(1).width = 6000
                    ws.col(2).width = 6000
                    ws.col(3).width = 6000
                    ws.col(4).width = 6000
                    ws.col(5).width = 6000
                    ws.col(6).width = 6000

                    ws.write(4, 0, 'FACULTAD')
                    ws.write(4, 1, 'CARRERA')
                    ws.write(4, 2, 'NIVEL')
                    ws.write(4, 3, 'PARALELO')
                    ws.write(4, 4, 'ASIGNATURA')
                    ws.write(4, 5, 'DOCENTE')
                    ws.write(4, 6, 'CONFIRMADO REACTIVO 1')
                    ws.write(4, 7, 'FECHA CONFIRMACION')
                    ws.write(4, 8, 'CONFIRMADO REACTIVO 2')
                    ws.write(4, 9, 'FECHA CONFIRMACION')

                    a = 4
                    date_format = xlwt.XFStyle()
                    date_format.num_format_str = 'yyyy/mm/dd'
                    materias = Materia.objects.filter(nivel__periodo=periodo, status=True,
                                                      profesormateria__isnull=False).distinct().order_by(
                        'asignaturamalla__malla__carrera__coordinacion', 'asignaturamalla__nivelmalla',
                        'asignaturamalla__malla__carrera', 'paralelo').exclude(
                        asignaturamalla__malla__carrera__coordinacion__id__in=[9])
                    for materia in materias:
                        a += 1
                        ws.write(a, 0, u'%s' % materia.asignaturamalla.malla.carrera.coordinacion_set.all()[0].nombre)
                        ws.write(a, 1, u'%s' % materia.asignaturamalla.malla.carrera.nombre)
                        ws.write(a, 2, u'%s' % materia.asignaturamalla.nivelmalla.nombre)
                        ws.write(a, 3, u'%s' % materia.paralelo)
                        ws.write(a, 4, u'%s' % materia.asignatura.nombre)
                        ws.write(a, 5,
                                 u'%s' % materia.profesor_materia_principal().profesor.persona.nombre_completo_inverso())
                        reactivo1 = materia.reactivomateria_set.filter(status=True).exclude(
                            detallemodelo__nombre__icontains='EX2')
                        reactivo_1 = 'NO'
                        fecha1 = ''
                        if reactivo1.exists():
                            reactivo_1 = 'SI'
                            fecha1 = reactivo1[0].fecha
                        reactivo2 = materia.reactivomateria_set.filter(status=True,
                                                                       detallemodelo__nombre__icontains='EX2')
                        reactivo_2 = 'NO'
                        fecha2 = ''
                        if reactivo2.exists():
                            reactivo_2 = 'SI'
                            fecha2 = reactivo2[0].fecha
                        ws.write(a, 6, u'%s' % reactivo_1)
                        ws.write(a, 7, u'%s' % fecha1)
                        ws.write(a, 8, u'%s' % reactivo_2)
                        ws.write(a, 9, u'%s' % fecha2)

                    a += 1
                    # ws.write_merge(a + 2, a + 2, 0, 1, datetime.today(), date_format)
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'reporteaprobadosreprobadosadmision':
                try:

                    noti = Notificacion(cuerpo='Generación de reporte de excel en progreso',
                                        titulo='Excel Estudiantes Admisión - aprobados y reprobados', destinatario=persona,
                                        url='',
                                        prioridad=1, app_label='SGA',
                                        fecha_hora_visible=datetime.now() + timedelta(days=1), tipo=2,
                                        en_proceso=True)
                    noti.save(request)
                    #reporte_estudiantesaprobadoreprobadosadmision_background(request=request, data=data, notiid=noti.pk, periodo=periodo).start()
                    reporte_estudiantesaprobadoreprobadosadmision_matriz_background(request=request, data=data, notiid=noti.pk, periodo=periodo).start()

                    return JsonResponse({"result": True,
                                         "mensaje": u"El reporte se está realizando. Verifique su apartado de notificaciones después de unos minutos.",
                                         "btn_notificaciones": traerNotificaciones(request, data, persona)})

                except Exception as ex:
                    print('Error on line {}'.format(sys.exc_info()[-1].tb_lineno))
                    pass

            elif action == 'horarioexamen':
                try:
                    nivelmallaid = 0
                    data['title'] = u'Horarios de Examen'
                    data['mallaid'] = mallaid = int(request.GET['mallaid'])
                    data['mallanombre'] = malla = Malla.objects.get(pk=mallaid)
                    data['nivel'] = nivel = Nivel.objects.get(pk=int(request.GET['nivel']))
                    data['turnos'] = nivel.sesion.turnosactivos()
                    data['paraleloid'] = paraleloid = request.GET['paraleloid']
                    data['semana'] = ['Lunes', 'Martes', 'Miercoles', 'Jueves', 'Viernes', 'Sabado', 'Domingo']
                    materias = nivel.materia_set.filter(asignaturamalla__malla=malla, status=True)
                    if 'nivelmallaid' in request.GET:
                        nivelmallaid = int(request.GET['nivelmallaid'])
                        if nivelmallaid > 0:
                            data['nivelmalla'] = nivelmalla = NivelMalla.objects.get(pk=nivelmallaid)
                            materias = materias.filter(asignaturamalla__nivelmalla=nivelmalla)
                    if not paraleloid == '0':
                        materias = materias.filter(paralelo=paraleloid)
                    data['materias'] = materias.order_by('asignaturamalla__nivelmalla', 'asignatura__nombre', 'inicio',
                                                         'identificacion', 'id')
                    data['nivelmallaid'] = nivelmallaid
                    form = FechaExamenesForm()
                    data['form'] = form
                    if variable_valor('LISTADO_DETALLES_MODELOEVALUTIVO_GESTIONAR_EXAMEN'):
                        data['detalle_gestionar_examenes'] = list(int(i) for i in variable_valor('LISTADO_DETALLES_MODELOEVALUTIVO_GESTIONAR_EXAMEN'))
                    return render(request, "niveles/horarioexamen.html", data)
                except Exception as ex:
                    pass

            elif action == 'sacarestudianteslimpios':
                try:
                    periodo = Periodo.objects.filter(pk=int(request.GET['idp']))[0]
                    coordinacion = Coordinacion.objects.filter(pk=int(request.GET['idc']))[0]
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=reactivo.xls'
                    __author__ = 'Unemi'
                    style0 = easyxf('font: name Times New Roman, color-index blue, bold off', num_format_str='#,##0.00')
                    style_nb = easyxf('font: name Times New Roman, color-index blue, bold on',
                                      num_format_str='#,##0.00')
                    style_sb = easyxf('font: name Times New Roman, color-index blue, bold on')
                    title = easyxf(
                        'font: name Times New Roman, color-index blue, bold on , height 350; alignment: horiz centre')
                    style1 = easyxf(num_format_str='D-MMM-YY')
                    output_folder = os.path.join(os.path.join(SITE_STORAGE, 'media', 'asistencias'))
                    nombre = "estudiantes_" + coordinacion.alias + "_" + datetime.now().strftime(
                        '%Y%m%d_%H%M%S') + ".xls"
                    filename = os.path.join(output_folder, nombre)
                    ruta = "media/asistencias/" + nombre

                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('exp_xls_post_part')
                    ws.col(0).width = 6000
                    ws.col(1).width = 6000
                    ws.col(2).width = 6000
                    ws.col(3).width = 6000
                    ws.col(4).width = 6000
                    ws.write(0, 0, 'CEDULA')
                    ws.write(0, 1, 'CARRERA_ID')
                    ws.write(0, 2, 'SECCION_ID')
                    ws.write(0, 3, 'PARALELO')
                    ws.write(0, 4, 'NIVEL_MATRICULA')

                    a = 0
                    date_format = xlwt.XFStyle()
                    date_format.num_format_str = 'yyyy/mm/dd'
                    for inscripcion in Inscripcion.objects.filter(matricula__nivel__periodo=periodo,
                                                                  carrera__coordinacion=coordinacion).exclude(
                        coordinacion_id=9).order_by('coordinacion', 'carrera'):
                        malla = inscripcion.carrera.malla()
                        nivelmalla_matricula = inscripcion.matricula_periodo(periodo).nivelmalla_id
                        asignaturas_atras = AsignaturaMalla.objects.filter(nivelmalla__id__lte=nivelmalla_matricula,
                                                                           malla=malla)
                        asignaturas_delante = AsignaturaMalla.objects.filter(nivelmalla__id__gt=nivelmalla_matricula,
                                                                             malla=malla)
                        bandera = 0
                        for asignatura_atras in asignaturas_atras:
                            if bandera == 0:
                                if RecordAcademico.objects.filter(inscripcion=inscripcion,
                                                                  asignatura=asignatura_atras.asignatura).exists():
                                    record = RecordAcademico.objects.filter(inscripcion=inscripcion,
                                                                            asignatura=asignatura_atras.asignatura)[0]
                                    if record.aprobada == False:
                                        bandera = 1
                                else:
                                    bandera = 1
                        if bandera == 0:
                            for asignatura_delante in asignaturas_delante:
                                if RecordAcademico.objects.filter(inscripcion=inscripcion,
                                                                  asignatura=asignatura_delante.asignatura).exists():
                                    bandera = 1
                        if bandera == 0:
                            a += 1
                            ws.write(a, 0, u'%s' % inscripcion.persona.cedula)
                            ws.write(a, 1, u'%s' % malla.carrera_id)
                            ws.write(a, 2, u'%s' % inscripcion.sesion_id)
                            ws.write(a, 3, '')
                            ws.write(a, 4, u'%s' % nivelmalla_matricula)

                    wb.save(filename)
                    # return book
                    return JsonResponse({'result': 'ok', 'archivo': ruta})
                except Exception as ex:
                    return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos."})



            elif action == 'conflictohorario':
                try:
                    nivel = Nivel.objects.filter(pk=int(request.GET['idn']))[0]
                    periodo = nivel.periodo
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=conflicto_horario_materias.xls'
                    __author__ = 'Unemi'
                    title = easyxf(
                        'font: name Times New Roman, color-index black, bold on , height 350; alignment: horiz centre')
                    subtitulos = easyxf(
                        'font: name Times New Roman, color-index black, bold on , height 200; alignment: horiz left')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('conflicto')
                    ws.write_merge(0, 0, 0, 4, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                    ws.col(0).width = 7000
                    ws.col(1).width = 7000
                    ws.col(2).width = 7000
                    ws.col(3).width = 1500
                    ws.col(4).width = 10000
                    ws.write(2, 0, 'PERIODO', subtitulos)
                    ws.write(2, 1, 'FACULTAD', subtitulos)
                    ws.write(2, 2, 'CARRERA', subtitulos)
                    ws.write(2, 3, 'NIVEL', subtitulos)
                    ws.write(2, 4, 'CONFLICTO', subtitulos)
                    cursor = connections['sga_select'].cursor()
                    sql = "select am.malla_id, am.nivelmalla_id , mat.paralelo from sga_materia mat, sga_nivel ni, sga_asignaturamalla am " \
                          " where mat.status=true and ni.status=true and mat.nivel_id=ni.id and am.status=true and mat.asignaturamalla_id=am.id " \
                          " and ni.periodo_id=" + str(periodo.id) + " and ni.id=" + str(
                        nivel.id) + " group by am.malla_id,am.nivelmalla_id, mat.paralelo order by am.malla_id,am.nivelmalla_id, mat.paralelo"
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    a = 3
                    for r in results:
                        materias = Materia.objects.values_list('id', flat=True).filter(status=True,
                                                                                       nivel__periodo=periodo,
                                                                                       asignaturamalla__malla__id=int(
                                                                                           r[0]),
                                                                                       asignaturamalla__nivelmalla__id=int(
                                                                                           r[1]), paralelo=r[2])
                        conflicto = conflicto_materias_seleccionadas(materias)
                        if conflicto:
                            materia = Materia.objects.filter(status=True, pk=materias[0])[0]
                            ws.write(a, 0, u'%s' % periodo.nombre)
                            ws.write(a, 1,
                                     u'%s' % materia.asignaturamalla.malla.carrera.coordinacion_set.filter(status=True)[
                                         0].nombre)
                            ws.write(a, 2, u'%s' % materia.asignaturamalla.malla.carrera.nombre)
                            ws.write(a, 3, u'%s' % r[1])
                            ws.write(a, 4, u'%s' % conflicto)
                            a += 1
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'conflictohorariodocente':
                try:
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=conflicto_horario_docentes.xls'
                    __author__ = 'Unemi'
                    title = easyxf(
                        'font: name Times New Roman, color-index black, bold on , height 350; alignment: horiz centre')
                    subtitulos = easyxf(
                        'font: name Times New Roman, color-index black, bold on , height 200; alignment: horiz left')
                    font_style = XFStyle()
                    font_style.font.bold = True
                    font_style2 = XFStyle()
                    font_style2.font.bold = False
                    wb = Workbook(encoding='utf-8')
                    ws = wb.add_sheet('conflicto')
                    ws.write_merge(0, 0, 0, 9, 'UNIVERSIDAD ESTATAL DE MILAGRO', title)
                    ws.col(0).width = 7000
                    ws.col(1).width = 7000
                    ws.col(2).width = 6000
                    ws.col(3).width = 7000
                    ws.col(4).width = 8000
                    ws.col(5).width = 9000
                    ws.col(6).width = 7000
                    ws.col(7).width = 2500
                    ws.col(8).width = 4000
                    ws.col(9).width = 3000
                    a = 2
                    ws.write(a, 0, 'PERIODO', subtitulos)
                    ws.write(a, 1, 'FACULTAD', subtitulos)
                    ws.write(a, 2, 'SESION', subtitulos)
                    ws.write(a, 3, 'CARRERA', subtitulos)
                    ws.write(a, 4, 'PROFESOR', subtitulos)
                    ws.write(a, 5, 'HORARIO', subtitulos)
                    ws.write(a, 6, 'TURNO', subtitulos)
                    ws.write(a, 7, 'DIA', subtitulos)
                    ws.write(a, 8, 'AULA', subtitulos)
                    ws.write(a, 9, 'MATERIA_ID', subtitulos)
                    a = 3
                    for coordinacion in persona.mis_coordinaciones():
                        for nivel in persona.mis_niveles(coordinacion, periodo):
                            materias = nivel.materia_set.filter(status=True).order_by('asignatura__nombre', 'inicio',
                                                                        'identificacion', 'id')
                            for materia in materias:
                                profesoresmateria = materia.profesores_materia()
                                for profesormateria in profesoresmateria:
                                    profesor = profesormateria.profesor
                                    clases = Clase.objects.filter(materia=materia, profesor=profesor, activo=True)
                                    for clase in clases:
                                        verificar_conflito_docente = profesor.existe_conflicto_docente(periodo, materia,
                                                                                                       clase.tipoprofesor,
                                                                                                       clase.inicio,
                                                                                                       clase.fin,
                                                                                                       clase.dia,
                                                                                                       clase.turno)
                                        if verificar_conflito_docente[0]:
                                            conflicto = verificar_conflito_docente[2]
                                            ws.write(a, 0, u'%s' % conflicto.materia.nivel.periodo.nombre)
                                            ws.write(a, 1, u'%s' % coordinacion.nombre)
                                            ws.write(a, 2, u'%s' % nivel.sesion)
                                            ws.write(a, 3,
                                                     u'%s' % conflicto.materia.asignaturamalla.malla.carrera.nombre)
                                            ws.write(a, 4,
                                                     u'%s' % conflicto.materia.profesor_principal() if not conflicto.profesor else conflicto.profesor.persona.nombre_completo_inverso())
                                            ws.write(a, 5, u'%s' % conflicto.materia.nombre_horario())
                                            ws.write(a, 6, u'%s' % conflicto.turno)
                                            ws.write(a, 7, u'%s' % conflicto.dia_semana())
                                            ws.write(a, 8, u'%s' % conflicto.aula)
                                            ws.write(a, 9, u'%s' % conflicto.materia.id)
                                            a += 1
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'importarmatricula':
                try:
                    data['title'] = u'Importar matricula masiva'
                    data['form'] = ImportarArchivoXLSForm()
                    data['periodo'] = Periodo.objects.get(pk=request.GET['idp'])
                    return render(request, "niveles/importarmatricula.html", data)
                except Exception as ex:
                    pass

            elif action == 'paralelos':
                try:
                    data['title'] = u'Paralelos'
                    search = None
                    if 's' in request.GET:
                        search = request.GET['s'].strip()
                        paralelo = Paralelo.objects.filter(nombre=search)
                        # ss = search.split(' ')
                        # if len(ss) == 1:
                        #     paralelo = Paralelo.objects.filter(Q(nombre=search), Q(status=True))
                        # else:
                        #     paralelo = Paralelo.objects.filter((Q(nombre=ss[0]), Q(nombre=ss[1])), Q(status=True))
                    else:
                        paralelo = Paralelo.objects.filter(status=True)
                    paging = MiPaginador(paralelo, 30)
                    p = 1
                    try:
                        paginasesion = 1
                        if 'paginador' in request.session:
                            paginasesion = int(request.session['paginador'])
                        if 'page' in request.GET:
                            p = int(request.GET['page'])
                        else:
                            p = paginasesion
                        try:
                            page = paging.page(p)
                        except:
                            p = 1
                        page = paging.page(p)
                    except:
                        page = paging.page(p)
                    request.session['paginador'] = p
                    data['paging'] = paging
                    data['rangospaging'] = paging.rangos_paginado(p)
                    data['page'] = page
                    data['search'] = search if search else ""
                    data['paralelos'] = page.object_list
                    return render(request, "niveles/viewparalelo.html", data)
                except Exception as ex:
                    pass

            elif action == 'bloques':
                try:
                    data['title'] = u'Bloques'
                    search = None
                    if 's' in request.GET:
                        search = request.GET['s'].strip()
                        bloque = Bloque.objects.filter(descripcion__icontains=search)
                    else:
                        bloque = Bloque.objects.filter(status=True)
                    paging = MiPaginador(bloque, 30)
                    p = 1
                    try:
                        paginasesion = 1
                        if 'paginador' in request.session:
                            paginasesion = int(request.session['paginador'])
                        if 'page' in request.GET:
                            p = int(request.GET['page'])
                        else:
                            p = paginasesion
                        try:
                            page = paging.page(p)
                        except:
                            p = 1
                        page = paging.page(p)
                    except:
                        page = paging.page(p)
                    request.session['paginador'] = p
                    data['paging'] = paging
                    data['rangospaging'] = paging.rangos_paginado(p)
                    data['page'] = page
                    data['search'] = search if search else ""
                    data['bloques'] = page.object_list
                    return render(request, "niveles/viewbloque.html", data)
                except Exception as ex:
                    pass

            elif action == 'turnos':
                try:
                    data['title'] = u'Turnos'
                    search = None
                    sesionselect = 0
                    if 'c' in request.GET:
                        sesionselect = int(request.GET['c'])
                        turno = Turno.objects.filter(sesion_id=sesionselect, status=True)
                    else:
                        if 's' in request.GET:
                            search = request.GET['s'].strip()
                            ss = search.split(' ')
                            if len(ss) == 1:
                                turno = Turno.objects.filter((Q(sesion__nombre__icontains=search) |
                                                              Q(comienza__icontains=search) |
                                                              Q(termina__icontains=search)),
                                                             status=True)
                        else:
                            turno = Turno.objects.filter(status=True).order_by('sesion')
                    paging = MiPaginador(turno, 30)
                    p = 1
                    try:
                        paginasesion = 1
                        if 'paginador' in request.session:
                            paginasesion = int(request.session['paginador'])
                        if 'page' in request.GET:
                            p = int(request.GET['page'])
                        else:
                            p = paginasesion
                        try:
                            page = paging.page(p)
                        except:
                            p = 1
                        page = paging.page(p)
                    except:
                        page = paging.page(p)
                    request.session['paginador'] = p
                    data['paging'] = paging
                    data['rangospaging'] = paging.rangos_paginado(p)
                    data['page'] = page
                    data['search'] = search if search else ""
                    data['turnos'] = page.object_list
                    data['sesiones'] = Sesion.objects.filter(status=True)
                    data['sesionselect'] = sesionselect
                    return render(request, "niveles/viewturno.html", data)
                except Exception as ex:
                    pass


            elif action == 'avancedistributivo':
                try:
                    data['title'] = u'Gráficas avance distributiivo'
                    listadoperiodo = Periodo.objects.filter(pk=periodo.id, status=True)
                    for lisper in listadoperiodo:
                        chart_data = []
                        listadodistributivomateriascoordinacion = Materia.objects.values_list(
                            'asignaturamalla__malla__carrera__coordinacion__id',
                            'asignaturamalla__malla__carrera__coordinacion__nombre').filter(nivel__periodo_id=lisper.id,
                                                                                            status=True).distinct().exclude(modeloevaluativo_id=27)
                        sumatoriacoordinacion = 0
                        sumatoriacoordinaciondoc = 0
                        sumatoriacoordinacionhorario = 0
                        sumatoriatotalcoordinacion = 0
                        sumatoriatotalcoordinacionhorario = 0
                        vecedividir = 0
                        for lista in listadodistributivomateriascoordinacion:
                            listaasignaturascoor = Materia.objects.values_list('id').filter(
                                asignaturamalla__malla__carrera__coordinacion__id=lista[0], nivel__periodo_id=lisper.id,
                                status=True).exclude(modeloevaluativo_id=27)
                            # listaconprofesorcoor = ProfesorMateria.objects.values_list('materia_id').filter(materia_id__in=listaasignaturascoor, status=True).exclude(profesor__persona__apellido1__icontains='DEFINIR').exclude(profesor__persona__apellido1__icontains='VIRTUAL').exclude(profesor__persona__apellido1__icontains='APELLIDOVIRT').exclude(profesor__persona__nombres__icontains='DEFINIR').exclude(profesor__persona__nombres__icontains='VIRTUAL').exclude(profesor__persona__apellido2__icontains='VIRTUAL').distinct()
                            listaconprofesorcoor = ProfesorMateria.objects.values_list('materia_id').filter(
                                materia_id__in=listaasignaturascoor, status=True).distinct()
                            listaconhorariocoor = Clase.objects.values_list('materia_id').filter(
                                materia_id__in=listaasignaturascoor, status=True).distinct()

                            codigofacu = lista[0]
                            if codigofacu == 2 or codigofacu == 3:
                                sumatoriacoordinacion += listaasignaturascoor.count()
                                sumatoriacoordinaciondoc += listaconprofesorcoor.count()
                                sumatoriacoordinacionhorario += listaconhorariocoor.count()
                                vecedividir += 1
                            else:
                                campo2 = lista[1]
                                porcentajedocente = round(
                                    (listaconprofesorcoor.count() * 100) / listaasignaturascoor.count(), 2)
                                porcentajehorario = round(
                                    (listaconhorariocoor.count() * 100) / listaasignaturascoor.count(), 2)
                                chart_data.append([campo2, porcentajedocente, porcentajehorario, codigofacu])

                        sumatoriatotalcoordinacion = round(((sumatoriacoordinaciondoc * 100) / sumatoriacoordinacion),
                                                           2)
                        sumatoriatotalcoordinacionhorario = round(
                            ((sumatoriacoordinacionhorario * 100) / sumatoriacoordinacion), 2)
                        chart_data.append(
                            ['FACULTAD CIENCIAS SOCIALES, EDUCACION COMERCIAL Y DERECHO', sumatoriatotalcoordinacion,
                             sumatoriatotalcoordinacionhorario, 0])
                    data['listado'] = chart_data
                    return render(request, "niveles/avancedistributivo.html", data)
                except Exception as ex:
                    pass

            elif action == 'avancedistributivoposgrado':
                try:
                    data['title'] = u'Gráficas avance distributiivo'
                    hoy = datetime.now().date()
                    listadoperiodo = Periodo.objects.filter(fin__gte=hoy, tipo_id__in=[3, 4], status=True).order_by(
                        'nombre')
                    chart_data = []
                    for lisper in listadoperiodo:
                        listadodistributivomateriascoordinacion = Materia.objects.values_list(
                            'asignaturamalla__malla__carrera__id', 'asignaturamalla__malla__carrera__nombre').filter(
                            nivel__periodo_id=lisper.id, status=True).distinct()
                        for lista in listadodistributivomateriascoordinacion:
                            listaasignaturascoor = Materia.objects.values_list('id').filter(
                                asignaturamalla__malla__carrera__id=lista[0], nivel__periodo_id=lisper.id, status=True)
                            listaconprofesorcoor = ProfesorMateria.objects.values_list('materia_id').filter(
                                materia_id__in=listaasignaturascoor, status=True).exclude(
                                profesor__persona__apellido1__icontains='DEFINIR').exclude(
                                profesor__persona__apellido1__icontains='VIRTUAL').exclude(
                                profesor__persona__apellido1__icontains='APELLIDOVIRT').exclude(
                                profesor__persona__nombres__icontains='DEFINIR').exclude(
                                profesor__persona__nombres__icontains='VIRTUAL').exclude(
                                profesor__persona__apellido2__icontains='VIRTUAL').distinct()
                            listaconhorariocoor = Clase.objects.values_list('materia_id').filter(
                                materia_id__in=listaasignaturascoor, status=True).distinct()

                            campo2 = lista[1]
                            porcentajedocente = round(
                                (listaconprofesorcoor.count() * 100) / listaasignaturascoor.count(), 2)
                            porcentajehorario = round(
                                (listaconhorariocoor.count() * 100) / listaasignaturascoor.count(), 2)
                            chart_data.append(
                                [campo2, porcentajedocente, porcentajehorario, listaasignaturascoor.count(),
                                 listaconprofesorcoor.count(), listaconhorariocoor.count(), lisper.nombre])

                    data['listado'] = chart_data
                    return render(request, "niveles/avancedistributivoposgrado.html", data)
                except Exception as ex:
                    pass

            elif action == 'avancedistributivocarreras':
                try:
                    data['title'] = u'Gráficas avance distributiivo'
                    data['periodo'] = periodo
                    hoy = datetime.now().date()
                    listadoperiodo = Periodo.objects.filter(pk=periodo.id, status=True).order_by('nombre')
                    chart_data = []
                    nombrecoordinacion = None
                    for lisper in listadoperiodo:
                        if 'idfacu' in request.GET:
                            idfacu = int(request.GET['idfacu'])
                            if idfacu == 0:
                                nombrecoordinacion = Coordinacion.objects.get(pk=2)
                                listadodistributivomateriascoordinacion = Materia.objects.values_list(
                                    'asignaturamalla__malla__carrera__id', 'asignaturamalla__malla__carrera__nombre',
                                    'asignaturamalla__malla__carrera__modalidad').filter(nivel__periodo_id=lisper.id,
                                                                                         asignaturamalla__malla__carrera__coordinacion__in=[
                                                                                             2, 3],
                                                                                         status=True).order_by(
                                    'asignaturamalla__malla__carrera__modalidad',
                                    'asignaturamalla__malla__carrera__nombre').distinct().exclude(modeloevaluativo_id=27)
                            else:
                                nombrecoordinacion = Coordinacion.objects.get(pk=idfacu)
                                listadodistributivomateriascoordinacion = Materia.objects.values_list(
                                    'asignaturamalla__malla__carrera__id', 'asignaturamalla__malla__carrera__nombre',
                                    'asignaturamalla__malla__carrera__modalidad').filter(nivel__periodo_id=lisper.id,
                                                                                         asignaturamalla__malla__carrera__coordinacion=idfacu,
                                                                                         status=True).order_by(
                                    'asignaturamalla__malla__carrera__modalidad',
                                    'asignaturamalla__malla__carrera__nombre').distinct().exclude(modeloevaluativo_id=27)
                        else:
                            listadodistributivomateriascoordinacion = Materia.objects.values_list(
                                'asignaturamalla__malla__carrera__id', 'asignaturamalla__malla__carrera__nombre',
                                'asignaturamalla__malla__carrera__modalidad').filter(nivel__periodo_id=lisper.id,
                                                                                     status=True).order_by(
                                'asignaturamalla__malla__carrera__modalidad',
                                'asignaturamalla__malla__carrera__nombre').distinct().exclude(modeloevaluativo_id=27)
                        for lista in listadodistributivomateriascoordinacion:
                            listaasignaturascoor = Materia.objects.values_list('id').filter(
                                asignaturamalla__malla__carrera__id=lista[0], nivel__periodo_id=lisper.id, status=True).exclude(modeloevaluativo_id=27)
                            # listaconprofesorcoor = ProfesorMateria.objects.values_list('materia_id').filter(materia_id__in=listaasignaturascoor, status=True).exclude(profesor__persona__apellido1__icontains='DEFINIR').exclude(profesor__persona__apellido1__icontains='VIRTUAL').exclude(profesor__persona__apellido1__icontains='APELLIDOVIRT').exclude(profesor__persona__nombres__icontains='DEFINIR').exclude(profesor__persona__nombres__icontains='VIRTUAL').exclude(profesor__persona__apellido2__icontains='VIRTUAL').distinct()
                            listasindefinir = ProfesorMateria.objects.values_list('materia_id').filter(
                                materia_id__in=listaasignaturascoor, status=True).filter(
                                Q(profesor__persona__apellido1__icontains='DEFINIR') | Q(
                                    profesor__persona__apellido1__icontains='VIRTUAL') | Q(
                                    profesor__persona__apellido1__icontains='APELLIDOVIRT') | Q(
                                    profesor__persona__nombres__icontains='DEFINIR') | Q(
                                    profesor__persona__nombres__icontains='VIRTUAL') | Q(
                                    profesor__persona__apellido2__icontains='VIRTUAL')).distinct()
                            listaconprofesorcoor = ProfesorMateria.objects.values_list('materia_id').filter(
                                materia_id__in=listaasignaturascoor, status=True).distinct()
                            listaconhorariocoor = Clase.objects.values_list('materia_id').filter(
                                materia_id__in=listaasignaturascoor, status=True).distinct()

                            campo2 = lista[1]
                            porcentajedocente = round(
                                (listaconprofesorcoor.count() * 100) / listaasignaturascoor.count(), 2)
                            porcentajehorario = round(
                                (listaconhorariocoor.count() * 100) / listaasignaturascoor.count(), 2)
                            chart_data.append(
                                [campo2, porcentajedocente, porcentajehorario, listaasignaturascoor.count(),
                                 listaconprofesorcoor.count(), listaconhorariocoor.count(), listasindefinir.count(),
                                 lista[2]])

                    data['listado'] = chart_data
                    data['nombrecoordinacion'] = nombrecoordinacion
                    return render(request, "niveles/avancedistributivocarreras.html", data)
                except Exception as ex:
                    pass

            elif action == 'addparalelo':
                try:
                    data['title'] = u'Adicionar paralelo'
                    data['form'] = ParaleloForm()
                    return render(request, "niveles/addparalelo.html", data)
                except Exception as ex:
                    pass

            elif action == 'addbloque':
                try:
                    data['title'] = u'Adicionar bloque'
                    data['form'] = BloqueForm()
                    return render(request, "niveles/addbloque2.html", data)
                except Exception as ex:
                    pass

            elif action == 'delbloque':
                try:
                    data['title'] = u'Eliminar bloque'
                    data['bloque'] = Bloque.objects.get(pk=int(request.GET['id']))
                    return render(request, "niveles/delbloque.html", data)
                except Exception as ex:
                    pass

            elif action == 'delparalelo':
                try:
                    data['title'] = u'Eliminar paralelo'
                    data['paralelo'] = Paralelo.objects.get(pk=int(request.GET['id']))
                    return render(request, "niveles/delparalelo.html", data)
                except Exception as ex:
                    pass

            elif action == 'editparalelo':
                try:
                    data['title'] = u'Editar paralelo'
                    data['paralelo'] = paralelo = Paralelo.objects.get(pk=int(request.GET['id']))
                    form = ParaleloForm(initial={'nombre': paralelo.nombre})
                    data['form'] = form
                    return render(request, "niveles/editparalelo.html", data)
                except Exception as ex:
                    pass

            elif action == 'editbloque':
                try:
                    data['title'] = u'Editar bloque'
                    data['bloque'] = bloque = Bloque.objects.get(pk=int(request.GET['id']))
                    initial = model_to_dict(bloque)
                    form = BloqueForm(initial=initial)
                    data['form'] = form
                    return render(request, "niveles/editbloque2.html", data)
                except Exception as ex:
                    pass

            elif action == 'addturno':
                try:
                    data['title'] = u'Adicionar Turno'
                    data['form'] = TurnoForm()
                    return render(request, "niveles/addturno.html", data)
                except Exception as ex:
                    pass

            elif action == 'editturno':
                try:
                    data['title'] = u'Editar turno'

                    data['turno'] = turno = Turno.objects.get(pk=int(request.GET['id']))

                    form = TurnoForm(initial={'sesion': turno.sesion,
                                              'turno': turno.turno,
                                              'comienza': turno.comienza,
                                              'termina': turno.termina,
                                              'mostrar': turno.mostrar,
                                              'horas': turno.horas,
                                              })

                    data['form'] = form

                    return render(request, "niveles/editturno.html", data)

                except Exception as ex:
                    pass

            elif action == 'confirmar_actualizacion_estudiantes':
                try:
                    data['title'] = u'Confirmar acualización de estudiantes'
                    data['materia'] = Materia.objects.get(pk=request.GET['id'])
                    mallaid = None
                    nivelmallaid = None
                    paraleloid = None
                    if 'mallaid' in request.GET:
                        mallaid = request.GET['mallaid']
                    data['mallaid'] = mallaid
                    if 'paraleloid' in request.GET['paraleloid']:
                        paraleloid = request.GET['paraleloid']
                    data['paraleloid'] = paraleloid
                    if 'nivelmallaid' in request.GET:
                        nivelmallaid = request.GET['nivelmallaid']
                    data['nivelmallaid'] = nivelmallaid
                    return render(request, "niveles/confirmar_actualizacion_estudiantes.html", data)
                except Exception as ex:
                    pass

            elif action == 'confirmar_actualizacion_docentes':
                try:
                    data['title'] = u'Confirmar acualización de docentes'
                    data['materia'] = Materia.objects.get(pk=request.GET['id'])
                    mallaid = None
                    nivelmallaid = None
                    paraleloid = None
                    if 'mallaid' in request.GET:
                        mallaid = request.GET['mallaid']
                    data['mallaid'] = mallaid
                    if 'paraleloid' in request.GET['paraleloid']:
                        paraleloid = request.GET['paraleloid']
                    data['paraleloid'] = paraleloid
                    if 'nivelmallaid' in request.GET:
                        nivelmallaid = request.GET['nivelmallaid']
                    data['nivelmallaid'] = nivelmallaid
                    return render(request, "niveles/confirmar_actualizacion_docentes.html", data)
                except Exception as ex:
                    pass

            elif action == 'confirmar_actualizacion_silabos':
                try:
                    data['title'] = u'Confirmar acualización de sílabo'
                    data['materia'] = Materia.objects.get(pk=request.GET['id'])
                    mallaid = None
                    nivelmallaid = None
                    paraleloid = None
                    if 'mallaid' in request.GET:
                        mallaid = request.GET['mallaid']
                    data['mallaid'] = mallaid
                    if 'paraleloid' in request.GET['paraleloid']:
                        paraleloid = request.GET['paraleloid']
                    data['paraleloid'] = paraleloid
                    if 'nivelmallaid' in request.GET:
                        nivelmallaid = request.GET['nivelmallaid']
                    data['nivelmallaid'] = nivelmallaid
                    return render(request, "niveles/confirmar_actualizacion_silabo.html", data)
                except Exception as ex:
                    pass

            elif action == 'confirmar_actualizacion_modelo':
                try:
                    data['title'] = u'Confirmar acualización de modelo evaluativo'
                    data['materia'] = Materia.objects.get(pk=request.GET['id'])
                    mallaid = None
                    nivelmallaid = None
                    paraleloid = None
                    if 'mallaid' in request.GET:
                        mallaid = request.GET['mallaid']
                    data['mallaid'] = mallaid
                    if 'paraleloid' in request.GET['paraleloid']:
                        paraleloid = request.GET['paraleloid']
                    data['paraleloid'] = paraleloid
                    if 'nivelmallaid' in request.GET:
                        nivelmallaid = request.GET['nivelmallaid']
                    data['nivelmallaid'] = nivelmallaid
                    return render(request, "niveles/confirmar_actualizacion_modelo.html", data)
                except Exception as ex:
                    pass

            elif action == 'confirmar_actualizacion_silabo_moodle':
                try:
                    data['title'] = u'Confirmar acualización de sílabo en moodle'
                    data['materia'] = Materia.objects.get(pk=request.GET['id'])
                    mallaid = None
                    nivelmallaid = None
                    paraleloid = None
                    if 'mallaid' in request.GET:
                        mallaid = request.GET['mallaid']
                    data['mallaid'] = mallaid
                    if 'paraleloid' in request.GET['paraleloid']:
                        paraleloid = request.GET['paraleloid']
                    data['paraleloid'] = paraleloid
                    if 'nivelmallaid' in request.GET:
                        nivelmallaid = request.GET['nivelmallaid']
                    data['nivelmallaid'] = nivelmallaid
                    return render(request, "niveles/confirmar_actualizacion_silabo_moodle.html", data)
                except Exception as ex:
                    pass

            elif action == 'confirmar_actualizacion_modelo_posgrado':
                try:
                    data['title'] = u'Actualización moodle'
                    data['materia'] = Materia.objects.get(pk=request.GET['id'])
                    data['clave'] = request.GET['clave']
                    mallaid = None
                    nivelmallaid = None
                    paraleloid = None
                    if 'mallaid' in request.GET:
                        mallaid = request.GET['mallaid']
                    data['mallaid'] = mallaid
                    if 'paraleloid' in request.GET['paraleloid']:
                        paraleloid = request.GET['paraleloid']
                    data['paraleloid'] = paraleloid
                    if 'nivelmallaid' in request.GET:
                        nivelmallaid = request.GET['nivelmallaid']
                    data['nivelmallaid'] = nivelmallaid
                    return render(request, "niveles/confirmar_actualizacion_modelo_posgrado.html", data)
                except Exception as ex:
                    pass

            elif action == 'perfilaccesousuario':
                try:
                    data['title'] = u'Perfil acceso usuario'
                    search = None
                    if 's' in request.GET:
                        search = request.GET['s'].strip()
                        ss = search.split(' ')
                        if len(ss) == 1:
                            perfilaccesousuario = PerfilAccesoUsuario.objects.filter(Q(grupo__name__icontains=search) | Q(coordinacion__nombre__icontains=search)).order_by('grupo__id', 'coordinacion__id').distinct('grupo__id', 'coordinacion__id')
                        else:
                            perfilaccesousuario = PerfilAccesoUsuario.objects.filter((Q(grupo__name__icontains=ss[0]) & Q(grupo__name__icontains=ss[1])) | (Q(coordinacion__nombre__icontains=ss[0]) & Q(coordinacion__nombre__icontains=ss[1]))).order_by('grupo__id', 'coordinacion__id').distinct('grupo__id', 'coordinacion__id')
                    else:
                        perfilaccesousuario = PerfilAccesoUsuario.objects.filter(status=True).order_by('grupo__id', 'coordinacion__id').distinct('grupo__id', 'coordinacion__id')

                    paging = MiPaginador(perfilaccesousuario, 30)
                    p = 1
                    try:
                        paginasesion = 1
                        if 'paginador' in request.session:
                            paginasesion = int(request.session['paginador'])
                        if 'page' in request.GET:
                            p = int(request.GET['page'])
                        else:
                            p = paginasesion
                        try:
                            page = paging.page(p)
                        except:
                            p = 1
                        page = paging.page(p)
                    except:
                        page = paging.page(p)
                    request.session['paginador'] = p
                    data['paging'] = paging
                    data['rangospaging'] = paging.rangos_paginado(p)
                    data['page'] = page
                    data['search'] = search if search else ""
                    data['perfilaccesousuarios'] = page.object_list
                    return render(request, "niveles/perfilaccesousuario.html", data)
                except Exception as ex:
                    pass

            elif action == 'addperfilaccesousuario':
                try:
                    data['title'] = u'Adicionar perfil acceso usuario'
                    form = PerfilAccesoUsuarioForm()
                    form.vaciarcarrera()
                    data['form'] = form
                    return render(request, "niveles/addperfilaccesousuario.html", data)
                except Exception as ex:
                    pass

            elif action == 'editperfilaccesousuario':
                try:
                    data['title'] = u'Editar perfil acceso usuario'
                    data['perfilacceso'] = perfilacceso = PerfilAccesoUsuario.objects.get(pk=int(encrypt(request.GET['id'])))
                    form = PerfilAccesoUsuarioForm(initial={'grupo': perfilacceso.grupo,
                                                            'coordinacion': perfilacceso.coordinacion,
                                                            'carrera': perfilacceso.carreras_grupos_perfil_acceso_usuario()
                                                            }
                                                   )
                    form.cargarcarrera(perfilacceso)
                    data['form'] = form
                    return render(request, "niveles/editperfilaccesousuario.html", data)
                except Exception as ex:
                    pass

            elif action == 'delperfilaccesousuario':
                try:
                    data['title'] = u'Eliminar perfil acceso usuario'
                    data['perfilacceso'] = PerfilAccesoUsuario.objects.get(pk=int(encrypt(request.GET['id'])))
                    return render(request, "niveles/delperfilaccesousuario.html", data)
                except Exception as ex:

                    pass

            elif action == 'migrar_actividades_sakai':
                try:
                    data['title'] = u'Confirmar migracion actividad sakai'
                    data['materia'] = Materia.objects.get(pk=request.GET['id'])
                    mallaid = None
                    nivelmallaid = None
                    paraleloid = None
                    if 'mallaid' in request.GET:
                        mallaid = request.GET['mallaid']
                    data['mallaid'] = mallaid
                    if 'paraleloid' in request.GET['paraleloid']:
                        paraleloid = request.GET['paraleloid']
                    data['paraleloid'] = paraleloid
                    if 'nivelmallaid' in request.GET:
                        nivelmallaid = request.GET['nivelmallaid']
                    data['nivelmallaid'] = nivelmallaid
                    return render(request, "niveles/migrar_actividades_sakai.html", data)
                except Exception as ex:
                    pass

            elif action == 'addobservacionseguimiento':
                try:
                    data['title'] = u'Adicionar Observación'
                    data['silabo'] = silabo = \
                        Silabo.objects.filter(pk=int(encrypt(request.GET['idsilabo'])), status=True,
                                              programaanaliticoasignatura__activo=True)[0]
                    data['silabosemanal'] = silabosemanal = SilaboSemanal.objects.get(
                        pk=int(encrypt(request.GET['idact'])))
                    data['idmallavirtual'] = int(encrypt(request.GET['idmallavirtual']))
                    initial = model_to_dict(silabosemanal)
                    form = ObservacionSeguimientoSemanalForm(initial=initial)
                    data['form'] = form
                    return render(request, "niveles/addobservacionseguimiento.html", data)
                except Exception as ex:
                    pass

            elif action == 'bibliografiascomplementarias':
                try:
                    if 'id' in request.GET:
                        listabibliografia = []
                        listaapa = []
                        listalink = []
                        silabosemana = SilaboSemanal.objects.get(pk=request.GET['id'])
                        for bli in silabosemana.detallesilabosemanalbibliografiadocente_set.filter(status=True):
                            listabibliografia.append([bli.librokohaprogramaanaliticoasignatura.id,
                                                      str(bli.librokohaprogramaanaliticoasignatura)])
                        for apa in silabosemana.bibliograbiaapasilabo_set.filter(status=True):
                            listaapa.append([apa.id, apa.bibliografia])
                        for link in silabosemana.recursosdidacticossemanal_set.filter(status=True):
                            listalink.append([link.id, str(link), str(link.link)])
                        data = {"results": "ok", 'listabibliografia': listabibliografia, 'listapa': listaapa,
                                'listalink': listalink}
                        return JsonResponse(data)
                except Exception as ex:
                    pass

            elif action == 'consultarbibliografia_complementaria':
                try:
                    if 'id' in request.GET:
                        bibliografia = LibroKohaProgramaAnaliticoAsignatura.objects.get(pk=request.GET['id'])
                        data = {"results": "ok", "bibliografia": str(bibliografia)}
                    else:
                        data = {"results": "bad", "mensaje": u'Error al cargar los datos'}
                    return JsonResponse(data)
                except Exception as ex:
                    pass

            elif action == 'addbibliografia':
                try:
                    data['title'] = u'Adicionar Bibliografia'
                    data['codigosemana'] = silabosemanal = SilaboSemanal.objects.get(
                        pk=encrypt(request.GET['codigosemana']))
                    data['idmallavirtual'] = encrypt(request.GET['idmallavirtual'])
                    return render(request, "niveles/addbilbiografia.html", data)
                except Exception as ex:
                    pass

            elif action == 'editbibliografia':
                try:
                    data['title'] = u'Editar Bibliografia'
                    data['idmallavirtual'] = int(encrypt(request.GET['idmallavirtual']))
                    data['silabosemana'] = silabosemana = SilaboSemanal.objects.get(pk=int(encrypt(request.GET['ids'])))
                    data['bibliografiaapa'] = silabosemana.bibliograbiaapasilabo_set.filter(status=True)
                    return render(request, "niveles/editarbibliografia.html", data)
                except Exception as ex:
                    pass

            # Editar objetivo apendizaje
            elif action == 'editarobjetivoaprendizaje':
                try:
                    silabosemana = SilaboSemanal.objects.get(pk=int(encrypt(request.GET['ids'])))
                    return JsonResponse({"result": "ok", 'objetivo': silabosemana.objetivoaprendizaje,
                                         "ids": encrypt(silabosemana.id)})
                except Exception as ex:
                    pass
                # Editar enfoque metodologico semana silabo

            elif action == 'editenfoquemetodologico':
                try:
                    silabosemana = SilaboSemanal.objects.get(pk=int(encrypt(request.GET['ids'])))
                    return JsonResponse(
                        {"result": "ok", 'enfoque': silabosemana.enfoque, "ids": encrypt(silabosemana.id)})
                except Exception as ex:
                    pass

            elif action == 'detalles_recurso_tutor_semanal':
                try:
                    data['title'] = u'Detalle recurso tutor semanal'
                    data['semana'] = semana = SilaboSemanal.objects.get(pk=int(encrypt(request.GET['id'])))
                    data['idmallavirtual'] = request.GET['idmallavirtual']
                    data['recursos'] = semana.detallerecursotutorsemanal_set.filter(status=True)
                    return render(request, "niveles/detalles_recurso_tutor_semanal.html", data)
                except Exception as ex:
                    pass

            elif action == 'cronogramaacademico':
                try:
                    data['title'] = "Cronograma Académico"
                    data['persona'] = persona
                    data['periodo'] = periodo
                    data['id'] = request.GET['nivelid']
                    data['nivelid'] = request.GET['nivelid']
                    data['id2'] = request.GET['id']
                    data['mallaid'] = request.GET['mallaid']
                    data['nivelmallaid'] = 0
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = request.GET['nivelmallaid']
                    data['paraleloid'] = 0
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    data['materia'] = materia = Materia.objects.get(pk=int(request.GET['id']))
                    nombretipo = u"%s - %s -%s" % (materia.asignaturamalla.asignatura.nombre, periodo.nombre, materia.paralelo)
                    if not TipoPlanificacionClaseSilabo.objects.filter(status=True, periodo=periodo, nombre=nombretipo).exists():
                        tipoplanificacionclasesilabo = TipoPlanificacionClaseSilabo(periodo=periodo,
                                                                                    nombre=nombretipo)
                        tipoplanificacionclasesilabo.save(request)
                    else:
                        tipoplanificacionclasesilabo = TipoPlanificacionClaseSilabo.objects.get(status=True, periodo=periodo, nombre=nombretipo)
                    if not PlanificacionClaseSilabo.objects.filter(tipoplanificacion=tipoplanificacionclasesilabo, status=True).exists():
                        fechainicio = materia.inicio
                        fechafin = materia.fin
                        semana = fechainicio.isocalendar()[1]
                        # sacar numero de dias entre dos fechas
                        # d1 = datetime.strptime(fechainicio, "%Y-%m-%d")
                        # d2 = datetime.strptime(fechafin, "%Y-%m-%d")
                        dias = int((fechafin - fechainicio).days)
                        ##
                        fechainicioaux = fechainicio
                        i = 1
                        rangofechas = []
                        while i <= dias:
                            bandera = 0
                            fechafinaux = fechainicio + timedelta(days=i)
                            semana_aux = fechafinaux.isocalendar()[1]
                            if not semana == semana_aux:
                                bandera = 1
                                semana = semana_aux
                                rangofechas.append([fechainicioaux, fechainicio + timedelta(days=i - 1)])
                                fechainicioaux = fechafinaux
                            i = i + 1
                        if bandera == 0:
                            semana = semana_aux
                            rangofechas.append([fechainicioaux, fechainicio + timedelta(days=i - 1)])

                        i = 1
                        for fecha in rangofechas:
                            planificacionclasesilabo = PlanificacionClaseSilabo(
                                tipoplanificacion=tipoplanificacionclasesilabo,
                                fechainicio=fecha[0],
                                fechafin=fecha[1],
                                orden=i,
                                semana=i,
                                obejetivosemanal=u"Semana %s" % (i))
                            planificacionclasesilabo.save(request)
                            i = i + 1
                    data['tipoplanificaciones'] = TipoPlanificacionClaseSilabo.objects.filter(pk=int(tipoplanificacionclasesilabo.id))
                    if not tipoplanificacionclasesilabo.planificacionclasesilabo_materia_set.filter(materia=materia).exists():
                        plani = PlanificacionClaseSilabo_Materia(tipoplanificacion=tipoplanificacionclasesilabo, materia=materia)
                        plani.save(request)
                        log(u'Adicionó nueva planificacion de silabo: %s' % plani, request, "add")

                    tipoplanificacionestodo = materia.planificacionclasesilabo_materia_set.filter(status=True).exclude(tipoplanificacion__periodo=periodo)
                    ids = tipoplanificacionestodo.values_list('tipoplanificacion_id')
                    data['tipoplanificacionestodo'] = TipoPlanificacionClaseSilabo.objects.filter(id__in=ids)

                    return render(request, "niveles/cronogramaacademico.html", data)
                except Exception as ex:
                    pass

            elif action == 'editplanificacionsemanal':
                try:
                    data['title'] = u'Editar semana de Planificación de Clase'
                    data['planificacion'] = planificacion = PlanificacionClaseSilabo.objects.get(
                        pk=int(encrypt(request.GET['id'])))
                    form = PlanificacionClaseSilaboForm(initial={'tipoplanificacion': planificacion.tipoplanificacion,
                                                                 'fechainicio': planificacion.fechainicio,
                                                                 'fechafin': planificacion.fechafin,
                                                                 'semana': planificacion.semana,
                                                                 'obejetivosemanal': planificacion.obejetivosemanal})
                    form.adicionar()
                    data['form'] = form
                    data['idmateria'] = request.GET['idmateria']
                    data['id2'] = request.GET['id2']
                    data['mallaid'] = request.GET['mallaid']
                    data['nivelmallaid'] = 0
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = request.GET['nivelmallaid']
                    data['paraleloid'] = 0
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    return render(request, "niveles/editplanificacionsemanal.html", data)
                except Exception as ex:
                    pass

            elif action == 'delplanificacionsemanal':
                try:
                    data['title'] = u'Eliminar de Planificación se de semana de Clase'
                    data['planificacion'] = PlanificacionClaseSilabo.objects.get(pk=int(encrypt(request.GET['id'])))
                    data['idmateria'] = request.GET['idmateria']
                    data['mallaid'] = request.GET['mallaid']
                    data['id'] = request.GET['id2']
                    data['nivelid'] = request.GET['nivelid']
                    data['nivelmallaid'] = 0
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = request.GET['nivelmallaid']
                    data['paraleloid'] = 0
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    return render(request, "niveles/delplanificacionsemanal.html", data)
                except Exception as ex:
                    pass

            elif action == 'subirnotas':
                try:
                    data['title'] = u'Subir calificación'
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['materia_id'])
                    data['nivel'] = nivel = Nivel.objects.get(pk=request.GET['nivel_id'])
                    data['mallaid'] = 0
                    data['nivelmallaid'] = 0
                    data['paraleloid'] = 0
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = nivelmallaid = request.GET['nivelmallaid']
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    search = None
                    ids = None
                    archivonotas = MateriaArchivoNotas.objects.filter(materia=materia).order_by(
                        'fecha_creacion').order_by('-fecha_creacion')
                    if 's' in request.GET:
                        search = request.GET['s']
                        if search:
                            archivonotas = archivonotas.filter(
                                Q(descripcion__icontains=search) | Q(observacion__icontains=search))
                    if 'id' in request.GET:
                        ids = request.GET['id']
                        if ids:
                            archivonotas = archivonotas.filter(id=ids)
                    paging = MiPaginador(archivonotas, 25)
                    p = 1
                    try:
                        paginasesion = 1
                        if 'paginador' in request.session:
                            paginasesion = int(request.session['paginador'])
                        if 'page' in request.GET:
                            p = int(request.GET['page'])
                        else:
                            p = paginasesion
                        try:
                            page = paging.page(p)
                        except:
                            p = 1
                        page = paging.page(p)
                    except:
                        page = paging.page(p)
                    request.session['paginador'] = p
                    data['paging'] = paging
                    data['rangospaging'] = paging.rangos_paginado(p)
                    data['page'] = page
                    data['search'] = search if search else ""
                    data['ids'] = ids if ids else ""
                    data['archivonotas'] = page.object_list
                    data['reporte_1'] = obtener_reporte('rpt_modelo_subida_acta_nivel_materia')
                    return render(request, "niveles/materia_archivo_notas/view.html", data)
                except Exception as ex:
                    pass

            elif action == 'addsubirnotas':
                try:
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['materia_id'])
                    data['title'] = u'Adicionar archivo notas de la materia %s' % materia.__str__()
                    data['nivel'] = nivel = Nivel.objects.get(pk=request.GET['nivel_id'])
                    data['mallaid'] = 0
                    data['nivelmallaid'] = 0
                    data['paraleloid'] = 0
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = nivelmallaid = request.GET['nivelmallaid']
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    form = MateriaArchivoNotasForm()
                    detallemodeloevaluativo = materia.modeloevaluativo.detallemodeloevaluativo_set.filter(
                        dependiente=False).order_by('orden')
                    form.modeloevaluativo(detallemodeloevaluativo)
                    data['form'] = form
                    return render(request, "niveles/materia_archivo_notas/add.html", data)
                except Exception as ex:
                    pass

            elif action == 'reportecumplerequisitostitu':
                try:
                    noti = Notificacion(cuerpo='Generación de reporte de excel en progreso',
                                        titulo='Excel de reporte de requisitos de titulacion', destinatario=persona,
                                        url='',
                                        prioridad=1, app_label='SGA',
                                        fecha_hora_visible=datetime.now() + timedelta(days=1), tipo=2,
                                        en_proceso=True)
                    noti.save(request)
                    reporte_cumplimiento_titulacion_background(request=request, data=data, notiid=noti.pk, periodo=periodo).start()

                    return JsonResponse({"result": True,
                                         "mensaje": u"El reporte se está realizando. Verifique su apartado de notificaciones después de unos minutos.",
                                         "btn_notificaciones": traerNotificaciones(request, data, persona)})
                except Exception as ex:
                    print('Error on line {}'.format(sys.exc_info()[-1].tb_lineno))
                    pass


            elif action == 'editsubirnotas':
                try:
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['materia_id'])
                    data['title'] = u'Editar archivo notas de la materia %s' % materia.__str__()
                    data['nivel'] = nivel = Nivel.objects.get(pk=request.GET['nivel_id'])
                    data['mallaid'] = 0
                    data['nivelmallaid'] = 0
                    data['paraleloid'] = 0
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = nivelmallaid = request.GET['nivelmallaid']
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    archivonotas = MateriaArchivoNotas.objects.get(pk=request.GET['id'])
                    form = MateriaArchivoNotasForm(initial={'descripcion': archivonotas.descripcion,
                                                            'observacion': archivonotas.observacion,
                                                            'criteriomodeloevaluativo': archivonotas.criteriovalidar.all()})
                    detallemodeloevaluativo = materia.modeloevaluativo.detallemodeloevaluativo_set.filter(
                        dependiente=False).order_by('orden')
                    form.modeloevaluativo(detallemodeloevaluativo)
                    data['form'] = form
                    data['archivonotas'] = archivonotas
                    return render(request, "niveles/materia_archivo_notas/edit.html", data)
                except Exception as ex:
                    pass

            elif action == 'deletesubirnotas':
                try:
                    data['archivonotas'] = archivonotas = MateriaArchivoNotas.objects.get(pk=request.GET['id'])
                    data['title'] = u'Eliminar archivo notas de la materia %s' % archivonotas.materia.__str__()
                    data['nivel'] = nivel = Nivel.objects.get(pk=request.GET['nivel_id'])
                    data['mallaid'] = 0
                    data['nivelmallaid'] = 0
                    data['paraleloid'] = 0
                    if 'mallaid' in request.GET:
                        data['mallaid'] = mallaid = request.GET['mallaid']
                    if 'nivelmallaid' in request.GET:
                        data['nivelmallaid'] = nivelmallaid = request.GET['nivelmallaid']
                    if 'paraleloid' in request.GET:
                        data['paraleloid'] = request.GET['paraleloid']
                    return render(request, "niveles/materia_archivo_notas/delete.html", data)
                except Exception as ex:
                    pass

            elif action == 'importar_matriz_senescyt':
                try:
                    data['title'] = u'Importar matriz de SENESCYT'
                    search = None
                    ids = None
                    archivos_matrices = My_SubirMatrizInscripcion.objects.filter(periodo=periodo).order_by('fecha_creacion').order_by('-fecha_creacion')
                    if not persona.usuario.is_superuser:
                        archivos_matrices = archivos_matrices.filter(status=True)
                    if 's' in request.GET:
                        search = request.GET['s']
                        if search:
                            archivos_matrices = archivos_matrices.filter(
                                Q(descripcion__icontains=search) | Q(observacion__icontains=search))
                    if 'id' in request.GET:
                        ids = request.GET['id']
                        if ids:
                            archivos_matrices = archivos_matrices.filter(id=ids)
                    paging = MiPaginador(archivos_matrices, 25)
                    p = 1
                    try:
                        paginasesion = 1
                        if 'paginador' in request.session:
                            paginasesion = int(request.session['paginador'])
                        if 'page' in request.GET:
                            p = int(request.GET['page'])
                        else:
                            p = paginasesion
                        try:
                            page = paging.page(p)
                        except:
                            p = 1
                        page = paging.page(p)
                    except:
                        page = paging.page(p)
                    request.session['paginador'] = p
                    data['paging'] = paging
                    data['rangospaging'] = paging.rangos_paginado(p)
                    data['page'] = page
                    data['search'] = search if search else ""
                    data['ids'] = ids if ids else ""
                    data['archivos_matrices'] = page.object_list
                    data['info'] = request.GET['info'] if 'info' in request.GET and request.GET['info'] else ''
                    data['url_vars'] = f'&action={action}'
                    return render(request, "niveles/importar_matriz_senescyt/view.html", data)
                except Exception as ex:
                    pass

            elif action == 'mover_alumnos_masivo_admision':
                try:
                    data['title'] = u'Mover alumnos masivo'
                    coor = Coordinacion.objects.filter(status=True, id=9)[0]
                    data['niveles'] = niveles = Nivel.objects.filter(nivellibrecoordinacion__coordinacion=coor, periodo=periodo, status=True)
                    return render(request, "niveles/mover_alumnos_masivo_admision/view.html", data)
                except Exception as ex:
                    pass

            elif action == 'addsubirmatriz':
                try:
                    data['title'] = u'Adicionar matriz de SENESCYT del periodo académico %s' % periodo.__str__()
                    form = SubirMatrizInscripcionForm()
                    # form.criterios_add()
                    data['form'] = form
                    return render(request, "niveles/importar_matriz_senescyt/add.html", data)
                except Exception as ex:
                    pass

            elif action == 'editsubirmatriz':
                try:
                    data['title'] = u'Editar matriz de SENESCYT del periodo académico %s' % periodo.__str__()
                    subirmatriz = My_SubirMatrizInscripcion.objects.get(pk=request.GET['id'])
                    form = SubirMatrizInscripcionForm(initial={'descripcion': subirmatriz.descripcion,
                                                               'observacion': subirmatriz.observacion,
                                                               'proceso': subirmatriz.proceso,
                                                               'periodo_id_sag': subirmatriz.periodo_id_sag,
                                                               # 'criterios_obligatorio': subirmatriz.criterios.filter(is_obligatorio=True),
                                                               # 'criterios_adicionar': subirmatriz.criterios.filter(is_obligatorio=False)
                                                               })
                    # form.criterios_edit()
                    data['form'] = form
                    data['subirmatriz'] = subirmatriz
                    return render(request, "niveles/importar_matriz_senescyt/edit.html", data)
                except Exception as ex:
                    pass

            elif action == 'deletesubirmatriz':
                try:
                    data['subirmatriz'] = subirmatriz = My_SubirMatrizInscripcion.objects.get(pk=request.GET['id'])
                    data['title'] = u'Eliminar matriz de SENESCYT código [%s], del periodo académico %s' % (subirmatriz.id, periodo.__str__())
                    return render(request, "niveles/importar_matriz_senescyt/delete.html", data)
                except Exception as ex:
                    pass

            elif action == 'procesomatricularadmisionmatriz':
                try:
                    data['title'] = u'PROCESO DE MATRICULACIÓN DE LA MATRIZ DE SENESCYT'
                    data['matriz'] = matriz = My_SubirMatrizInscripcion.objects.get(pk=request.GET['id'])
                    total = matriz.total_procesos()
                    # total = matriz.historialprocesosubirmatrizinscripcion_set.filter(status=True).count()
                    # total_success = matriz.historialprocesosubirmatrizinscripcion_set.filter(status=True, estado=2).count()
                    total_success = matriz.total_procesos_exitosos()
                    if total != total_success:
                        return HttpResponseRedirect("niveles?action=importar_matriz_senescyt&info=%s" % u"No se puede continuar a matricular hasta que finalice el proceso asociado.")
                    periodoanterior_aux = periodoanterior = Periodo.objects.filter(status=True, tipo_id__in=[TIPO_PERIODO_REGULAR, TIPO_PERIODO_PROPEDEUTICO]).order_by('-inicio')
                    if 'idaux' in request.GET:
                        if not periodoanterior_aux.filter(pk=request.GET['idaux']).exists():
                            periodoanterior_aux = periodoanterior_aux.filter(status=True, tipo_id__in=[TIPO_PERIODO_REGULAR, TIPO_PERIODO_PROPEDEUTICO]).order_by('-inicio')
                        else:
                            periodoanterior_aux = periodoanterior_aux.filter(pk=request.GET['idaux'], status=True)
                    data['periodos_admision'] = periodoanterior
                    data['periodosadmision_aux'] = periodoanterior_aux.first()
                    data['distributivo'] = distributivo = matriz.cargar_distributivo_matriz_admision(periodo, periodoanterior_aux.first())
                    niveles = Nivel.objects.filter(periodo=periodo, nivellibrecoordinacion__coordinacion_id=ADMISION_ID)
                    matriculas = Matricula.objects.filter(nivel__in=niveles)
                    data['total_matricular'] = matriculas.count()
                    data['total_por_matricular'] = distributivo['cupoDemanda'] - matriculas.count()
                    return render(request, "niveles/importar_matriz_senescyt/matricula.html", data)
                except Exception as ex:
                    return HttpResponseRedirect(f"/niveles?info={ex.__str__()}")

            elif action == 'matriculacionprimernivel':
                try:
                    if not persona.usuario.is_superuser:
                        return HttpResponseRedirect(f"/niveles")
                    data['title'] = u'Matriculación de alumnos Admitidos a Primer Nivel'
                    # if total != total_success:
                    #    return HttpResponseRedirect("niveles?action=importar_matriz_senescyt&info=%s" % u"No se puede continuar a matricular hasta que finalice el proceso asociado.")
                    periodoc = None
                    data['info'] = None
                    if 'idpc' in request.GET:
                        if not Periodo.objects.filter(pk=request.GET['idpc']).exists():
                            data['info'] = u"No se encontro el periodo"
                            # data['info'] = request.GET['info'] if 'info' in request.GET and request.GET['info'] else ''
                        else:
                            periodoc = Periodo.objects.filter(pk=request.GET['idpc'])
                    else:
                        periodoc = Periodo.objects.filter(status=True, tipo_id__in=[TIPO_PERIODO_REGULAR, TIPO_PERIODO_PROPEDEUTICO]).order_by('-inicio')
                    data['periodop'] = periodop = Periodo.objects.filter(status=True, tipo_id__in=[TIPO_PERIODO_REGULAR, TIPO_PERIODO_PROPEDEUTICO]).order_by('-inicio')
                    data['periodoc'] = periodoc[0]
                    carreras_ids = My_MatriculaPregrado.objects.values_list('inscripcion__carrera_id').filter(nivel__periodo=periodoc[0], aprobado=True).distinct()
                    # carreras_ids = My_InscripcionPregrado.objects.values_list('carrera_id').filter(id__in=inscripcion_ids).distinct()
                    coordinacion_ids = My_CarreraPregrado.objects.values_list('coordinacionvalida_id').filter(id__in=carreras_ids).distinct()
                    data['coordinaciones'] = coordinaciones = My_CoordinacionPregrado.objects.filter(id__in=coordinacion_ids).distinct()
                    config = My_ConfigMatriculacionPrimerNivel.objects.filter(periodoadmision=periodoc[0], periodopregrado=periodo, status=True)
                    data['config'] = None
                    data['estadisticas'] = None
                    can_enroll = True
                    if config.exists():
                        data['config'] = config[0]
                        data['estadisticas'] = config[0].load_statistics()
                        if config[0].has_detail():
                            if config[0].list_careers_first_level().exists():
                                if config[0].list_careers_first_level().filter(carrerapregrado__isnull=True).exists():
                                    can_enroll = False
                                elif carreras_ids.count() != config[0].list_careers_first_level().count():
                                    can_enroll = False
                            else:
                                can_enroll = False
                        else:
                            can_enroll = False
                    else:
                        can_enroll = False
                    data['can_enroll'] = can_enroll
                    data['can_enroll_msg'] = 'Existe carreras por configurar' if not can_enroll else ''
                    return render(request, "niveles/matriculacion_primer_nivel/view.html", data)
                except Exception as ex:
                    pass

            elif action == 'reportealumnoreprobado':
                try:
                    output = io.BytesIO()
                    workbook = xlsxwriter.Workbook(output)
                    ws = workbook.add_worksheet('Alumnosmatriculas')
                    merge_format = workbook.add_format({
                        'bold': 1,
                        'border': 1,
                        'align': 'center',
                        'valign': 'vcenter'})

                    ws.merge_range(0, 0, 0, 7, 'UNIVERSIDAD ESTATAL DE MILAGRO',
                                   workbook.add_format({'align': 'center', 'valign': 'vcenter'}))
                    columns = [
                        (u"FACULTAD", 40),
                        (u"CARRERA", 40),
                        (u"CEDULA", 25),
                        (u"PRIMER APELLIDO", 40),
                        (u"SEGUNDO APELLIDO", 40),
                        (u"NOMBRES", 40),
                        (u"EMAIL", 40),
                        (u"EMAIL INSTITUCIONAL", 40),
                        (u"CELULAR", 25),
                        (u"TELEFONO", 25),
                        (u"MATERIA", 40),
                        (u"PARALELO", 25),
                        (u"NIVEL", 25),
                        (u"NOTA FINAL", 40),
                        (u"ASISTENCIA FINAL", 40),
                        (u"ESTADO", 25),
                        (u"NUMERO DE MATRICULA", 25),
                        (u"ANIO MALLA", 25),
                        (u"FECHA NACIMIENTO", 25),
                        (u"MODALIDAD", 25),
                        (u"SEXO", 25),
                        (u"CANTON RESIDENCIA", 25),
                        (u"FECHA DE MATRICULA", 25),
                        (u"HORA DE MATRICULA", 25)
                    ]
                    row_num = 3
                    for col_num in range(len(columns)):
                        ws.write(row_num, col_num, columns[col_num][0], merge_format)
                        ws.set_column(col_num, col_num, columns[col_num][1])
                    cursor = connections['default'].cursor()

                    sql = """
                            SELECT coordinacion.nombre AS coordinacion, CASE WHEN carrera.mencion = '' THEN carrera.nombre ELSE (carrera.nombre || ' CON MENCION EN ' || carrera.mencion) END AS carrera, 
                                 persona.cedula, persona.apellido1, persona.apellido2, persona.nombres, persona.email, persona.emailinst, persona.telefono, persona.telefono_conv, 
                                 (asignatura.nombre || CASE WHEN materia.alias = '' THEN '' ELSE (' - ('|| materia.alias || ')') END || CASE WHEN materia.identificacion = '' THEN '' ELSE (' - ['|| materia.identificacion || ']') END) AS materia, 
                                 materia.paralelo AS paralelo, nivelmalla.nombre AS nivel, materiaasig.notafinal AS notafinal, materiaasig.asistenciafinal AS asistenciafinal, tipoestado.nombre AS estado, materiaasig.matriculas AS veces, EXTRACT(YEAR
                                FROM malla.inicio) AS aniomalla, 
                                 persona.nacimiento, modalidad.nombre, genero.nombre, canton.nombre,matricula.fecha, matricula.hora
                                FROM sga_materiaasignada materiaasig
                                INNER JOIN sga_materia materia ON materia.id = materiaasig.materia_id
                                INNER JOIN sga_nivel nivel ON nivel.id = materia.nivel_id
                                INNER JOIN sga_modalidad modalidad ON nivel.modalidad_id = modalidad.id
                                INNER JOIN sga_asignaturamalla asigmalla ON asigmalla.id = materia.asignaturamalla_id
                                INNER JOIN sga_malla malla ON malla.id = asigmalla.malla_id
                                INNER JOIN sga_carrera carrera ON carrera.id = malla.carrera_id
                                INNER JOIN sga_matricula matricula ON matricula.id = materiaasig.matricula_id
                                INNER JOIN sga_inscripcion inscripcion ON inscripcion.id = matricula.inscripcion_id
                                INNER JOIN sga_persona persona ON persona.id = inscripcion.persona_id
                                LEFT JOIN sga_sexo genero ON genero.id = persona.sexo_id
                                LEFT JOIN sga_canton canton ON canton.id = persona.canton_id
                                INNER JOIN sga_asignatura asignatura ON asignatura.id = materia.asignatura_id
                                INNER JOIN sga_nivelmalla nivelmalla ON nivelmalla.id = asigmalla.nivelmalla_id
                                INNER JOIN sga_tipoestado tipoestado ON tipoestado.id = materiaasig.estado_id
                                INNER JOIN sga_coordinacion_carrera coordinacioncarrera ON coordinacioncarrera.carrera_id = carrera.id
                                INNER JOIN sga_coordinacion coordinacion ON coordinacion.id = coordinacioncarrera.coordinacion_id
                                WHERE nivel.periodo_id =%s  and materiaasig.matriculas>1
                    """ % (periodo.id)
                    cursor.execute(sql)
                    results = cursor.fetchall()
                    row_num = 4
                    for r in results:
                        ws.write(row_num, 0, u'%s' % r[0])
                        ws.write(row_num, 1, u'%s' % r[1])
                        ws.write(row_num, 2, u'%s' % r[2])
                        ws.write(row_num, 3, u'%s' % r[3])
                        ws.write(row_num, 4, u'%s' % r[4])
                        ws.write(row_num, 5, u'%s' % r[5])
                        ws.write(row_num, 6, u'%s' % r[6])
                        ws.write(row_num, 7, u'%s' % r[7])
                        ws.write(row_num, 8, u'%s' % r[8])
                        ws.write(row_num, 9, u'%s' % r[9])
                        ws.write(row_num, 10, u'%s' % r[10])
                        ws.write(row_num, 11, u'%s' % r[11])
                        ws.write(row_num, 12, u'%s' % r[12])
                        ws.write(row_num, 13, r[13])
                        ws.write(row_num, 14, r[14])
                        ws.write(row_num, 15, u'%s' % r[15])
                        ws.write(row_num, 16, r[16])
                        ws.write(row_num, 17, r[17])
                        ws.write(row_num, 18, u'%s' % r[18])
                        ws.write(row_num, 19, u'%s' % r[19])
                        ws.write(row_num, 20, u'%s' % r[20])
                        ws.write(row_num, 21, u'%s' % r[21])
                        ws.write(row_num, 22, u'%s' % r[22])
                        ws.write(row_num, 23, u'%s' % r[23])
                        row_num += 1
                    workbook.close()
                    output.seek(0)
                    filename = 'reporte_estudiantes_reprobados' + random.randint(1, 10000).__str__() + '.xlsx'
                    response = HttpResponse(output, content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
                    response['Content-Disposition'] = 'attachment; filename=%s' % filename

                    return response
                except Exception as ex:
                    pass

            elif action == 'asignaciontutores':
                try:
                    data['title'] = u'Asignación de tutores a estudiantes'
                    if periodo.tipo.id == 3 or periodo.tipo.id == 4:
                        data['carreras'] = Carrera.objects.filter(status=True, modalidad__in=[1, 2, 3], coordinacion__id__in=[7])
                        idprof = DetalleDistributivo.objects.values('distributivo__profesor_id').filter(status=True, distributivo__periodo=periodo)
                    else:
                        data['carreras'] = Carrera.objects.filter(status=True, modalidad__in=[1, 2], coordinacion__id__in=[1, 2, 3, 4, 5])
                        idprof = DetalleDistributivo.objects.values('distributivo__profesor_id').filter(status=True, criteriodocenciaperiodo__isnull=False, distributivo__periodo=periodo, criteriodocenciaperiodo__criterio_id=105)

                    data['profesores'] = Profesor.objects.filter(status=True, id__in=idprof)
                    return render(request, "niveles/asignaciontutores.html", data)
                except Exception as ex:
                    pass

            elif action == 'reporteasignaciontutores':
                try:
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=asignacion_tutores.xls'
                    wb = xlwt.Workbook()
                    ws = wb.add_sheet('Hoja1')
                    ws.col(0).width = 6000
                    ws.col(1).width = 6000
                    ws.col(2).width = 6000
                    ws.col(3).width = 6000
                    ws.col(4).width = 6000
                    ws.col(5).width = 6000
                    ws.col(6).width = 6000
                    ws.write(1, 0, 'N.')
                    ws.write(1, 1, 'DOCENTE')
                    ws.write(1, 2, 'CEDULA')
                    ws.write(1, 3, 'ESTUDIANTE')
                    ws.write(1, 4, 'CARRERA')
                    ws.write(1, 5, 'JORNADA')
                    ws.write(1, 6, 'NIVEL')
                    a = 1
                    date_format = xlwt.XFStyle()
                    date_format.num_format_str = 'yyyy/mm/dd'
                    soportes = SoporteAcademicoTutor.objects.values_list('materiaasignada__matricula_id', flat=True).filter(status=True, periodo=periodo, materiaasignada__matricula__status=True).order_by('materiaasignada__matricula_id').distinct()
                    for soporte in soportes:
                        a += 1
                        registro = SoporteAcademicoTutor.objects.filter(status=True, periodo=periodo, materiaasignada__matricula_id=soporte)[0]
                        ws.write(a, 0, a)
                        ws.write(a, 1, u"%s" % registro.tutor)
                        ws.write(a, 2, u"%s" % registro.materiaasignada.matricula.inscripcion.persona.identificacion())
                        ws.write(a, 3, u"%s" % registro.materiaasignada.matricula.inscripcion.persona)
                        ws.write(a, 4, u"%s" % registro.materiaasignada.matricula.inscripcion.carrera)
                        ws.write(a, 5, u"%s" % registro.materiaasignada.matricula.nivel.sesion)
                        ws.write(a, 6, u"%s" % registro.materiaasignada.matricula.nivelmalla)
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'eliminarasignacion':
                try:
                    data['title'] = u'Eliminar asignación'
                    data['profesor'] = Profesor.objects.get(pk=request.GET['id'])
                    return render(request, 'niveles/eliminarasignacion.html', data)
                except Exception as ex:
                    pass

            elif action == 'matriculacioninternado':
                try:
                    puede_realizar_accion(request, 'sga.puede_matricular_masivo_internado')
                    data['title'] = u'Matriculación masiva internado'
                    data['periodo_origen'] = periodo_origen = periodo
                    data['periodo_todos'] = Periodo.objects.filter(status=True, tipo_id=2)
                    data['carrera_todos'] = carreras = Carrera.objects.filter(status=True, pk__in=Materia.objects.values_list('asignaturamalla__malla__carrera__id').filter(nivel__periodo=periodo_origen, asignaturamalla__malla__carrera__coordinacion__id=1))
                    data['niveles_malla'] = niveles_malla = NivelMalla.objects.filter(pk__in=[7, 8])
                    periodo_destino = None
                    carrera = None
                    nivel_malla_origen = None
                    nivel_malla_destino = None
                    if 'idpd' in request.GET and request.GET['idpd']:
                        if Periodo.objects.filter(pk=int(request.GET['idpd'])).exists():
                            periodo_destino = Periodo.objects.get(pk=int(request.GET['idpd']))
                    if 'idc' in request.GET and request.GET['idc']:
                        if Carrera.objects.filter(pk=int(request.GET['idc'])).exists():
                            carrera = Carrera.objects.get(pk=int(request.GET['idc']))
                    if 'idnmo' in request.GET and request.GET['idnmo']:
                        if NivelMalla.objects.filter(pk=int(request.GET['idnmo'])).exists():
                            nivel_malla_origen = NivelMalla.objects.get(pk=int(request.GET['idnmo']))
                    if 'idnmd' in request.GET and request.GET['idnmd']:
                        if NivelMalla.objects.filter(pk=int(request.GET['idnmd'])).exists():
                            nivel_malla_destino = NivelMalla.objects.get(pk=int(request.GET['idnmd']))
                    data['nivel_malla_origen'] = nivel_malla_origen
                    data['nivel_malla_destino'] = nivel_malla_destino
                    data['periodo_destino'] = periodo_destino
                    data['carrera'] = carrera
                    data['total_matriculado_pa'] = Matricula.objects.filter(nivel__periodo=periodo_origen, retiradomatricula=False, inscripcion__carrera=carrera, nivelmalla=nivel_malla_origen).count()
                    data['total_matriculado_pd'] = Matricula.objects.filter(nivel__periodo=periodo_destino, retiradomatricula=False, inscripcion__carrera=carrera, materiaasignada__materia__asignaturamalla__nivelmalla=nivel_malla_destino).distinct().count()
                    matriculadoss = Matricula.objects.filter(nivel__periodo=periodo_destino, retiradomatricula=False, inscripcion__carrera=carrera, materiaasignada__materia__asignaturamalla__nivelmalla=nivel_malla_destino)
                    data['matriculados'] = Matricula.objects.filter(nivel__periodo=periodo_origen, retiradomatricula=False, inscripcion__carrera=carrera, nivelmalla=nivel_malla_origen).exclude(inscripcion__in=matriculadoss.values_list('inscripcion__id', flat=True)).order_by('materiaasignada__materia__paralelomateria__nombre', 'inscripcion__persona').distinct()
                    return render(request, 'niveles/matriculacion_internado/view.html', data)
                except Exception as ex:
                    pass

            elif action == 'excelasistencia':
                try:
                    periodo = Periodo.objects.get(pk=int(request.GET['id']))
                    coordinaciones = Coordinacion.objects.filter(id__in=[1, 2, 3, 4, 5])
                    response = HttpResponse(content_type="application/ms-excel")
                    response['Content-Disposition'] = 'attachment; filename=asistencia.xls'
                    wb = xlwt.Workbook()
                    for coordinacion in coordinaciones:
                        nombrearchivo = coordinacion.alias
                        ws = wb.add_sheet(nombrearchivo)
                        estilo = xlwt.easyxf(
                            'font: height 350, name Arial, colour_index black, bold on, italic on; align: wrap on, vert centre, horiz center;')
                        ws.write_merge(0, 0, 0, 9, 'UNIVERSIDAD ESTATAL DE MILAGRO', estilo)
                        ws.col(1).width = 11000
                        ws.col(2).width = 11000
                        ws.col(3).width = 27000
                        ws.col(4).width = 23000
                        ws.col(5).width = 5000
                        ws.col(6).width = 3000
                        ws.write(4, 1, 'CARRERA')
                        ws.write(4, 2, 'PROFESOR')
                        ws.write(4, 3, 'MATERIA')
                        ws.write(4, 4, 'ALUMNO')
                        ws.write(4, 5, 'CEDULA')
                        ws.write(4, 6, 'PORCENTAJE')
                        a = 4
                        carreras = coordinacion.carreras()
                        for carrera in carreras:
                            materias = Materia.objects.filter(status=True, nivel__periodo_id=113, asignaturamalla__malla__carrera=carrera).exclude(nivel__modalidad_id=3)
                            for mat in materias:
                                for asignadomateria in mat.asignados_a_esta_materia():
                                    por = 0
                                    if asignadomateria.asistencias_zoom_valida() > 0:
                                        por = round(((asignadomateria.asistencias_zoom_valida() * 100) / asignadomateria.cantidad_asistencias_zoom()), 0)
                                        if por < 70:
                                            a += 1
                                            ws.write(a, 1, mat.asignaturamalla.malla.carrera.__str__())
                                            ws.write(a, 2, str(mat.profesores_materia()[0].profesor))
                                            ws.write(a, 3, mat.nombre_completo())
                                            ws.write(a, 4, asignadomateria.matricula.inscripcion.persona.nombre_completo())
                                            ws.write(a, 5, asignadomateria.matricula.inscripcion.persona.identificacion())
                                            ws.write(a, 6, por)
                    wb.save(response)
                    return response
                except Exception as ex:
                    pass

            elif action == 'matricular_especial':
                try:
                    puede_realizar_accion(request, 'sga.puede_matricular_alumno_materia')
                    data['title'] = u'Matriculas especiales'
                    data['materia'] = materia = Materia.objects.get(pk=request.GET['id'])
                    form = MatricularEspecialForm()
                    data['form'] = form
                    return render(request, "niveles/matricular_especial.html", data)
                except Exception as ex:
                    pass

            elif action == 'vistafechascronogramas':
                try:
                    materia = Materia.objects.get(pk=request.GET['idmate'])
                    fechainicio = materia.inicio
                    fechafin = materia.fin
                    semana = fechainicio.isocalendar()[1]
                    dias = int((fechafin - fechainicio).days)
                    fechainicioaux = fechainicio
                    i = 1
                    rangofechas = []
                    while i <= dias:
                        bandera = 0
                        fechafinaux = fechainicio + timedelta(days=i)
                        semana_aux = fechafinaux.isocalendar()[1]
                        if not semana == semana_aux:
                            bandera = 1
                            semana = semana_aux
                            rangofechas.append([fechainicioaux, fechainicio + timedelta(days=i - 1)])
                            fechainicioaux = fechafinaux
                        i = i + 1
                    if bandera == 0:
                        semana = semana_aux
                        rangofechas.append([fechainicioaux, fechainicio + timedelta(days=i - 1)])
                    data = {"results": "ok", 'listadorangofechas': rangofechas}
                    return JsonResponse(data)
                except Exception as ex:
                    transaction.set_rollback(True)
                    return JsonResponse({"result": "bad", "mensaje": u"Error al guardar los datos."})

            elif action == 'generar_reporte_ultimo_modin_aprobado':
                try:
                    __author__ = 'Unemi'

                    coordinacion = request.GET['coordinacion']
                    coordinacion_nombre = request.GET['coordinacion_nombre']

                    output = io.BytesIO()
                    workbook = xlsxwriter.Workbook(output)
                    ws = workbook.add_worksheet('ultimo_modulo_aprobado')
                    ws.set_column(0, 10, 30)
                    formatotitulo = workbook.add_format(
                        {'bold': 1, 'text_wrap': True, 'border': 1, 'align': 'center', 'valign': 'middle',
                         'fg_color': '#A2D0EC'})
                    formatotitulo_filtros = workbook.add_format(
                        {'bold': 1, 'text_wrap': True, 'border': 1, 'fg_color': '#EBF5FB'})

                    formatoceldacab = workbook.add_format(
                        {'align': 'center', 'bold': 1, 'border': 1, 'text_wrap': True, 'fg_color': '#EBF5FB'})
                    formatoceldaleft = workbook.add_format(
                        {'text_wrap': True, 'align': 'center', 'valign': 'vcenter', 'border': 1})

                    ws.merge_range('A1:C1', 'ESTUDIANTES DEL PERIODO ACTUAL CON ÚLTIMO MÓDULO DE INGLÉS APROBADO', formatotitulo)
                    ws.merge_range('D1:F1', str(coordinacion_nombre), formatoceldaleft)

                    ws.write(1, 0, 'INSCRIPCIÓN', formatoceldacab)
                    ws.write(1, 1, 'MATRÍCULA', formatoceldacab)
                    ws.write(1, 2, 'IDENTIFICACIÓN', formatoceldacab)
                    ws.write(1, 3, 'NOMBRES', formatoceldacab)
                    ws.write(1, 4, 'EMAIL PERSONAL', formatoceldacab)
                    ws.write(1, 5, 'EMAIL INSTITUCIONAL', formatoceldacab)
                    ws.write(1, 6, 'TELÉFONO', formatoceldacab)
                    ws.write(1, 7, 'CARRERA', formatoceldacab)
                    ws.write(1, 8, 'ÚLTIMO MÓDULO APROBADO', formatoceldacab)

                    matriculas = Matricula.objects.filter(status=True, nivel__periodo=periodo).order_by('-inscripcion__carrera')
                    if len(coordinacion)>0:
                        matriculas=matriculas.filter(inscripcion__coordinacion=coordinacion)
                    fila_det = 3
                    for matricula in matriculas:
                        records = RecordAcademico.objects.filter(status=True, inscripcion=matricula.inscripcion.id,
                                                                 aprobada=True, modulomalla__isnull=False).distinct()

                        # for record in records:
                        #     modulo = str(record.modulomalla)

                        # print(matricula.inscripcion.id,
                        #       matricula.id,
                        #       matricula.inscripcion.persona.cedula if matricula.id else matricula.inscripcion.persona.pasaporte,
                        #       matricula.inscripcion.persona,
                        #       matricula.inscripcion.carrera.nombre,
                        #       matricula.inscripcion.coordinacion.nombre,
                        #       modulo)

                        ws.write('A%s' % fila_det,
                                 str(matricula.inscripcion.id if matricula.inscripcion.id else 'NO EXISTE REGISTRO'),
                                 formatoceldaleft)
                        ws.write('B%s' % fila_det, str(matricula.id if matricula.id else 'NO EXISTE REGISTRO'),
                                 formatoceldaleft)
                        ws.write('C%s' % fila_det,
                                 str(matricula.inscripcion.persona.cedula if matricula.id else matricula.inscripcion.persona.pasaporte),
                                 formatoceldaleft)
                        ws.write('D%s' % fila_det,
                                 str(matricula.inscripcion.persona if matricula.inscripcion.persona else 'NO EXISTE REGISTRO'),
                                 formatoceldaleft)
                        ws.write('E%s' % fila_det,
                                 str(matricula.inscripcion.persona.email if matricula.inscripcion.persona else 'NO EXISTE REGISTRO'),
                                 formatoceldaleft)
                        ws.write('F%s' % fila_det,
                                 str(matricula.inscripcion.persona.emailinst if matricula.inscripcion.persona else 'NO EXISTE REGISTRO'),
                                 formatoceldaleft)
                        ws.write('G%s' % fila_det,
                                 str(matricula.inscripcion.persona.telefono if matricula.inscripcion.persona else 'NO EXISTE REGISTRO'),
                                 formatoceldaleft)
                        ws.write('H%s' % fila_det,
                                 str(matricula.inscripcion.carrera.nombre if matricula.inscripcion.carrera.nombre else 'NO EXISTE REGISTRO'),
                                 formatoceldaleft)
                        modulo = ''
                        for record in records:
                            modulo = str(record.modulomalla)

                        ws.write('I%s' % fila_det, str(modulo if modulo else 'NO REGISTRA'), formatoceldaleft)
                        fila_det += 1

                    workbook.close()
                    output.seek(0)
                    filename = 'Estudiantes con último módulo de inglés aprobado.xlsx'
                    response = HttpResponse(output,
                                            content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
                    response['Content-Disposition'] = 'attachment; filename=%s' % filename

                    return response
                except Exception as ex:
                    pass

            elif action == 'generar_reporte_ultimo_modin_aprobado_general':
                try:
                    __author__ = 'Unemi'

                    # coordinacion = request.GET  ['coordinacion']
                    # periodo_nombre = request.GET['periodo_nombre']

                    output = io.BytesIO()
                    workbook = xlsxwriter.Workbook(output)
                    ws = workbook.add_worksheet('ultimo_modulo_aprobado')
                    ws.set_column(0, 10, 30)
                    formatotitulo = workbook.add_format(
                        {'bold': 1, 'text_wrap': True, 'border': 1, 'align': 'center', 'valign': 'middle',
                         'fg_color': '#A2D0EC'})
                    formatotitulo_filtros = workbook.add_format(
                        {'bold': 1, 'text_wrap': True, 'border': 1, 'fg_color': '#EBF5FB'})

                    formatoceldacab = workbook.add_format(
                        {'align': 'center', 'bold': 1, 'border': 1, 'text_wrap': True, 'fg_color': '#EBF5FB'})
                    formatoceldaleft = workbook.add_format(
                        {'text_wrap': True, 'align': 'center', 'valign': 'vcenter', 'border': 1})

                    ws.merge_range('A1:C1', 'ESTUDIANTES DEL PERIODO ACTUAL CON ÚLTIMO MÓDULO DE INGLÉS APROBADO', formatotitulo)
                    ws.merge_range('E1:G1', str(periodo), formatoceldaleft)

                    ws.write(1, 0, 'INSCRIPCIÓN', formatoceldacab)
                    ws.write(1, 1, 'MATRÍCULA', formatoceldacab)
                    ws.write(1, 2, 'IDENTIFICACIÓN', formatoceldacab)
                    ws.write(1, 3, 'NOMBRES', formatoceldacab)
                    ws.write(1, 4, 'EMAIL PERSONAL', formatoceldacab)
                    ws.write(1, 5, 'EMAIL INSTITUCIONAL', formatoceldacab)
                    ws.write(1, 6, 'TELÉFONO', formatoceldacab)
                    ws.write(1, 7, 'CARRERA', formatoceldacab)
                    ws.write(1, 8, 'FACULTAD', formatoceldacab)
                    ws.write(1, 9, 'ÚLTIMO MÓDULO APROBADO', formatoceldacab)

                    matriculas = Matricula.objects.filter(status=True, nivel__periodo=periodo).order_by('-inscripcion__carrera')

                    fila_det = 3
                    for matricula in matriculas:
                        records = RecordAcademico.objects.filter(status=True, inscripcion=matricula.inscripcion.id,
                                                                 aprobada=True, modulomalla__isnull=False).distinct()

                        # for record in records:
                        #     modulo = str(record.modulomalla)

                        # print(matricula.inscripcion.id,
                        #       matricula.id,
                        #       matricula.inscripcion.persona.cedula if matricula.id else matricula.inscripcion.persona.pasaporte,
                        #       matricula.inscripcion.persona,
                        #       matricula.inscripcion.carrera.nombre,
                        #       matricula.inscripcion.coordinacion.nombre,
                        #       modulo)

                        ws.write('A%s' % fila_det,
                                 str(matricula.inscripcion.id if matricula.inscripcion.id else 'NO EXISTE REGISTRO'),
                                 formatoceldaleft)
                        ws.write('B%s' % fila_det, str(matricula.id if matricula.id else 'NO EXISTE REGISTRO'),
                                 formatoceldaleft)
                        ws.write('C%s' % fila_det,
                                 str(matricula.inscripcion.persona.cedula if matricula.id else matricula.inscripcion.persona.pasaporte),
                                 formatoceldaleft)
                        ws.write('D%s' % fila_det,
                                 str(matricula.inscripcion.persona if matricula.inscripcion.persona else 'NO EXISTE REGISTRO'),
                                 formatoceldaleft)
                        ws.write('E%s' % fila_det,
                                 str(matricula.inscripcion.persona.email if matricula.inscripcion.persona else 'NO EXISTE REGISTRO'),
                                 formatoceldaleft)
                        ws.write('F%s' % fila_det,
                                 str(matricula.inscripcion.persona.emailinst if matricula.inscripcion.persona else 'NO EXISTE REGISTRO'),
                                 formatoceldaleft)
                        ws.write('G%s' % fila_det,
                                 str(matricula.inscripcion.persona.telefono if matricula.inscripcion.persona else 'NO EXISTE REGISTRO'),
                                 formatoceldaleft)
                        ws.write('H%s' % fila_det,
                                 str(matricula.inscripcion.carrera.nombre if matricula.inscripcion.carrera.nombre else 'NO EXISTE REGISTRO'),
                                 formatoceldaleft)
                        ws.write('I%s' % fila_det,
                                 str(matricula.inscripcion.coordinacion.nombre if matricula.inscripcion.coordinacion.nombre else 'NO EXISTE REGISTRO'),
                                 formatoceldaleft)
                        modulo = ''
                        for record in records:
                            modulo = str(record.modulomalla)

                        ws.write('J%s' % fila_det, str(modulo if modulo else 'NO REGISTRA'), formatoceldaleft)
                        fila_det += 1

                    workbook.close()
                    output.seek(0)
                    filename = 'Estudiantes con último módulo de inglés aprobado.xlsx'
                    response = HttpResponse(output,
                                            content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
                    response['Content-Disposition'] = 'attachment; filename=%s' % filename

                    return response
                except Exception as ex:
                    pass

            elif action == 'cargar_periodo':
                try:
                    lista = []
                    periodos = Periodo.objects.filter(status=True).distinct()

                    for periodo in periodos:
                        if not buscar_dicc(lista, 'id', periodo.id):
                            lista.append({'id': periodo.id, 'nombre': periodo.nombre})
                    return JsonResponse({'result': 'ok', 'lista': lista})
                except Exception as ex:
                    return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos."})

            elif action == 'cargar_coordinacion':
                try:
                    lista = []
                    coordinaciones = Coordinacion.objects.filter(status=True).distinct()

                    for coordinacion in coordinaciones:
                        if not buscar_dicc(lista, 'id', coordinacion.id):
                            lista.append({'id': coordinacion.id, 'nombre': coordinacion.nombre})
                    return JsonResponse({'result': 'ok', 'lista': lista})
                except Exception as ex:
                    return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos."})

            elif action == 'reporte_acta_calificaciones':
                try:
                    materia_id = request.GET['materia']
                    reporte_id = request.GET['reporte']
                    reporte = Reporte.objects.get(pk=reporte_id)
                    base_url = request.META['HTTP_HOST']
                    d = datetime.now()
                    pdfname = reporte.nombre + d.strftime('%Y%m%d_%H%M%S')
                    tipo = 'pdf'
                    paRequest = {
                        'materia': materia_id,
                        'imp_logo': True,
                        'imp_encabezado': True,
                        'imp_fecha': True,
                        'imp_membretada': False,
                        'url_qr': unicode(base_url + "/".join([MEDIA_URL, 'documentos', 'userreports', elimina_tildes(request.user.username), pdfname + "." + tipo]))
                    }
                    d = run_report_v1(reporte=reporte, tipo=tipo, paRequest=paRequest, request=request)
                    if not d['isSuccess']:
                        raise NameError(d['mensaje'])
                    else:
                        return ok_json({"r": d['mensaje'], 'reportfile': d['data']['reportfile']})
                    # return JsonResponse({'result': 'ok','reportfile': ''})
                except Exception as ex:
                    transaction.set_rollback(True)
                    return bad_json(mensaje="Error, al generar el reporte. %s" % ex.__str__())

            elif action == 'listaresponsablesactaadmision':
                try:
                    data['title'] = u'Configurar Responsables Actas Admisión'
                    search = None
                    ids = None
                    responablesactaadmision = ResponsableActaAdmision.objects.filter(status=True).order_by('id')
                    if 's' in request.GET:
                        search = request.GET['s']
                        if search.isdigit():
                            responablesactaadmision = responablesactaadmision.filter(pk=search)
                        else:
                            responablesactaadmision = responablesactaadmision.filter(Q(periodo__nombre__icontains=search))
                    if 'id' in request.GET:
                        ids = request.GET['id']
                        responablesactaadmision = responablesactaadmision.filter(id=ids)
                    paging = MiPaginador(responablesactaadmision, 25)
                    p = 1
                    try:
                        paginasesion = 1
                        if 'paginador' in request.session:
                            paginasesion = int(request.session['paginador'])
                        if 'page' in request.GET:
                            p = int(request.GET['page'])
                        else:
                            p = paginasesion
                        try:
                            page = paging.page(p)
                        except:
                            p = 1
                        page = paging.page(p)
                    except:
                        page = paging.page(p)
                    request.session['paginador'] = p
                    data['paging'] = paging
                    data['page'] = page
                    data['rangospaging'] = paging.rangos_paginado(p)
                    data['responablesactaadmision'] = page.object_list
                    #data['vigente'] = vigente
                    data['search'] = search if search else ""
                    data['ids'] = ids if ids else ""
                    return render(request, "niveles/listaresponsablesactaadmision.html", data)
                except Exception as ex:
                    pass

            elif action == 'addresponsableactaadmision':
                try:
                    data['title'] = u'Adicionar Responsable Acta Admisión'
                    form = ResponsableActaAdmisionForm(initial={'tipo':1})
                    userlog = request.user
                    data['form'] = form
                    data['action'] = action
                    template = get_template("niveles/modal/formresponsableactaadmision.html")
                    return JsonResponse({"result": True, 'data': template.render(data), 'title': data['title']})
                except Exception as ex:
                    transaction.set_rollback(True)
                    return JsonResponse({"result": False, "mensaje": u"Error al adicionar los datos."})

            elif action == 'editresponsableactaadmision':
                try:
                    data['title'] = u'Editar  Responsable Acta Admisión'
                    data['id'] = id = int(encrypt(request.GET['id']))
                    data['registro'] = registro = ResponsableActaAdmision.objects.get(pk=id)
                    form = ResponsableActaAdmisionForm()
                    userlog = request.user
                    form.initial = model_to_dict(registro)
                    data['form'] = form
                    data['action'] = action
                    template = get_template("niveles/modal/formresponsableactaadmision.html")
                    return JsonResponse({"result": True, 'data': template.render(data), 'title': data['title']})
                except Exception as ex:
                    transaction.set_rollback(True)
                    return JsonResponse({"result": False, "mensaje": u"Error al adicionar los datos."})

            elif action == 'loadFormResponableActaAdmision':
                try:
                    typeForm = request.GET['typeForm'] if 'typeForm' in request.GET and request.GET['typeForm'] and str(request.GET['typeForm']) in ['new', 'edit', 'view'] else None
                    if typeForm is None:
                        raise NameError(u"No se encontro el tipo de formulario")
                    f = ResponsableActaAdmisionForm(initial={'tipo':1})
                    eResponsableActaAdmision = None
                    # ePeriodoCrontab = None
                    id = 0
                    if typeForm in ['edit', 'view']:
                        id = int(request.GET['id']) if 'id' in request.GET and request.GET['id'] and int(request.GET['id']) != 0 else None
                        ePeriodoActaAdmision = PeriodoActaAdmision.objects.filter(periodo=periodo).first()
                        # if eResponsableActaAdmision.objects.filter(periodo=ePeriodo).exists():
                        #     ePeriodoCrontab = PeriodoCrontab.objects.get(periodo=ePeriodo)
                        # if typeForm == 'view':
                        #     f.view()
                        if typeForm == 'edit':
                            puede_realizar_accion(request, 'bd.puede_modificar_periodo_acta_admision')
                    data['eResponsableActaAdmision'] = eResponsableActaAdmision
                    data['tableData'] = request.GET.get('tableData', '')
                    data['form'] = f
                    data['frmName'] = "frmResponsableActaAdmision"
                    data['id'] = id
                    template = get_template("niveles/modal/formresponsableactaadmision.html")
                    json_content = template.render(data)
                    return JsonResponse({"result": "ok", 'html': json_content})
                except Exception as ex:
                    return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos. %s" % ex.__str__()})


            elif action == 'loadFormPeriodoCalificacion':
                try:
                    f = PeriodoCalificacionForm(initial={})
                    data['form'] = f
                    data['frmName'] = "frmPeriodoCalificacion"
                    template = get_template("niveles/modal/frmPeriodoCalificacion.html")
                    json_content = template.render(data)
                    return JsonResponse({"result": "ok", 'html': json_content})
                except Exception as ex:
                    return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos. %s" % ex.__str__()})

            elif action == 'downloadRptPeriodoCalificacion':
                try:
                    if data['permiteWebPush']:
                        if not 'idp' in request.GET or not request.GET['idp']:
                            raise NameError(u"No se encontro parametro de periodo")
                        if not 'idm' in request.GET or not request.GET['idm']:
                            raise NameError(u"No se encontro parametro de modalidad")
                        idp = request.GET['idp']
                        idm = request.GET['idm']
                        if not Periodo.objects.values("id").filter(pk=idp).exists():
                            raise NameError(u"No existe periodo")
                        if not Modalidad.objects.values("id").filter(pk=idm).exists():
                            raise NameError(u"No existe modalidad")
                        ePeriodo = Periodo.objects.get(pk=idp)
                        eModalidad = Modalidad.objects.get(pk=idm)
                        eNotificacion = Notificacion(cuerpo='Generación de reporte de excel en progreso',
                                                     titulo=f'Calificaciones de {ePeriodo.nombre}',
                                                     destinatario=persona,
                                                     url='',
                                                     prioridad=1,
                                                     app_label='SGA',
                                                     fecha_hora_visible=datetime.now() + timedelta(days=1),
                                                     tipo=2,
                                                     en_proceso=True)
                        eNotificacion.save(request)
                        ReportCalifcacionPeriodo(request=request, data=data, eNotificacion=eNotificacion).start()
                        return JsonResponse({"result": True,
                                             "mensaje": u"El reporte se está realizando. Verifique su apartado de notificaciones después de unos minutos.",
                                             "btn_notificaciones": traerNotificaciones(request, data, persona)})
                    else:
                        return JsonResponse({"result": False, "mensaje": f"Error al generar reporte, No esta habilitado notificaciones push"})
                except Exception as ex:
                    if data['permiteWebPush']:
                        return JsonResponse({"result": False, "mensaje": f"Error al generar reporte, {ex.__str__()}"})
                    else:
                        return JsonResponse({"result": False, "mensaje": f"Error al generar reporte, No esta habilitado notificaciones push"})


            elif action == 'loadFormPeriodoActaAdmision':
                try:
                    typeForm = request.GET.get('typeForm') #request.GET['typeForm'] if 'typeForm' in request.GET and request.GET['typeForm'] and str(request.GET['typeForm']) in ['new', 'edit', 'view'] else None
                    if typeForm is None:
                        raise NameError(u"No se encontro el tipo de formulario")
                    f = ResponsableActaAdmisionForm(initial={'tipo':1})
                    eResponsableActaAdmision = None
                    # ePeriodoCrontab = None
                    id = 0
                    if not periodo:
                        raise NameError(u"No existe Periodo")
                    ePeriodoActaAdmision = PeriodoActaAdmision.objects.filter(periodo=periodo).first()

                    eAsignaturas = Asignatura.objects.filter(materia__nivel__periodo=periodo)
                    if periodo.inicio.year <= 2019:
                        eAsignaturas = eAsignaturas.filter(materia__nivel__nivellibrecoordinacion__coordinacion_id = 9)
                    eAsignaturas = eAsignaturas.distinct()

                    if typeForm in ['edit', 'view']:
                        id = int(request.GET['id']) if 'id' in request.GET and request.GET['id'] and int(request.GET['id']) != 0 else None
                        if not PeriodoActaAdmision.objects.filter(pk=id).exists():
                            raise NameError(u"No existe formulario a editar")
                        ePeriodoActaAdmision = PeriodoActaAdmision.objects.get(pk=id)
                        # f.set_initial(ePeriodo)
                        # if eResponsableActaAdmision.objects.filter(periodo=ePeriodo).exists():
                        #     ePeriodoCrontab = PeriodoCrontab.objects.get(periodo=ePeriodo)
                        # if typeForm == 'view':
                        #     f.view()
                        if typeForm == 'edit':
                            puede_realizar_accion(request, 'bd.puede_modificar_periodo_crontab')

                    data['typeForm'] = request.GET['typeForm']
                    data['ePeriodoActaAdmision'] = ePeriodoActaAdmision
                    data['eAsignaturas'] = eAsignaturas
                    data['form'] = f
                    data['frmName'] = "frmPeriodoActaAdmision"
                    data['id'] = id
                    template = get_template("niveles/modal/frmPeriodoActaAdmision.html")
                    json_content = template.render(data)
                    asignaturas = []

                    for eAsignatura in eAsignaturas:
                        asignatura = model_to_dict(eAsignatura, exclude = ['precedencia'])
                        asignatura['tableData'] = f'#data-asignatura{eAsignatura.id}'
                        asignatura['responsables']= []
                        if ePeriodoActaAdmision:
                            eResponsablesActaAdmision = ePeriodoActaAdmision.get_responsables_asignatura(eAsignatura)
                            for eResponsableActaAdmision in eResponsablesActaAdmision:
                                responsable = model_to_dict(eResponsableActaAdmision)
                                responsable['tableData'] = asignatura['tableData']
                                responsable['tipo'] = eResponsableActaAdmision.get_tipo_display()
                                responsable['tipo_id'] = eResponsableActaAdmision.tipo
                                responsable['persona'] = eResponsableActaAdmision.persona.__str__() if eResponsableActaAdmision.persona else ''
                                responsable['tipoprofesor_id'] = eResponsableActaAdmision.tipoprofesor.id if eResponsableActaAdmision.tipoprofesor else ''
                                responsable['tipoprofesor'] = eResponsableActaAdmision.tipoprofesor.__str__() if eResponsableActaAdmision.tipoprofesor else ''
                                responsable['persona_id'] = eResponsableActaAdmision.persona.id if eResponsableActaAdmision.persona else '0'
                                asignatura['responsables'].append(responsable)

                        asignaturas.append(asignatura)

                    return JsonResponse({"result": "ok", 'html': json_content,'asignaturas':asignaturas})
                except Exception as ex:
                    return JsonResponse({"result": "bad", "mensaje": u"Error al obtener los datos. %s" % ex.__str__()})


            elif action == 'viewmapabloque':
                try:
                    data['title'] = u'Vista de Mapa Bloque'
                    data['id'] = id = int(encrypt(request.GET['id']))
                    data['bloque'] = registro = Bloque.objects.get(pk=id)
                    userlog = request.user
                    data['action'] = action
                    data['urlbase'] = f"{request.scheme}://{request.META['HTTP_HOST']}"
                    template = get_template("niveles/modal/viewmapabloque.html")
                    return JsonResponse({"result": True, 'data': template.render(data), 'title': data['title']})
                except Exception as ex:
                    transaction.set_rollback(True)
                    return JsonResponse({"result": False, "mensaje": u"Error al adicionar los datos."})

            elif action == 'buscareponsable':
                try:
                    tipo = int(request.GET['tipo'])
                    materia = int(request.GET['materia'])
                    dt = []
                    if tipo == 1:
                        resp = Materia.objects.get(id=materia).profesores_materia()
                        it=None
                        if periodo.clasificacion==1:
                           resp = resp.filter(tipoprofesor_id__in=[1, 14])
                        for pro in resp:
                            if not it == pro.profesor.id:
                                dt.append({'id': pro.id, 'text': str(pro.profesor)})
                                it = pro.profesor.id
                    elif tipo == 2:
                        resp = Profesor.objects.filter(status=True, activo=True).distinct()
                        for pro in resp:
                            dt.append({'id': pro.id, 'text': str(pro.persona)})
                    elif tipo == 3:
                        resp = Administrativo.objects.filter(status=True).distinct()
                        for pro in resp:
                            dt.append({'id': pro.id, 'text': str(pro.persona)})
                    else:
                        return JsonResponse({"result": "bad", "mensaje": 'Seleccione un tipo de representante'})
                    return JsonResponse({"result": "ok", "data": dt})
                except Exception as e:
                    pass
            elif action == 'buscaraula':
                try:
                    detalle = int(request.GET['detalle'])
                    fecha = request.GET['fecha']
                    inicio = request.GET['inicio']
                    fin = request.GET['fin']
                    dt = []
                    c = []
                    if datetime.strptime(fin, '%H:%M').time() > datetime.strptime(inicio, '%H:%M').time():
                        resp = Aula.objects.filter(status=True).exclude(id__in=HorarioExamenDetalle.objects.filter(status=True, horarioexamen__fecha=convertir_fecha(fecha), horainicio__range=[inicio, fin], horafin__range=[inicio, fin]).exclude(aula_id=218).values_list('aula_id', flat=True)).distinct()
                        for pro in resp:
                            if not pro.id in c:
                                c.append(pro.id)
                                dt.append({'id': pro.id, 'text': str(pro)})
                    return JsonResponse({"result": "ok", "data": dt})
                except Exception as e:
                    pass

            elif action == 'firmantes':
                try:
                    data['modalidades'] = Modalidad.objects.filter(status=True)
                    data['tipos'] = TipoProfesor.objects.filter(status=True)
                    data['periodo'] = periodo
                    template = get_template("niveles/listafirmantes.html")
                    json_content = template.render(data)
                    return JsonResponse({"result": "ok", 'data': json_content})
                except Exception as e:
                    pass

            elif action == 'addfirmante':
                valold = 0
                try:
                    modalidad = request.GET['modalidad']
                    tipo = json.loads(request.GET['tipo'])
                    if not ProfesorFirmaActaPeriodo.objects.filter(status=True, modalidad_id=modalidad, periodo=periodo).exists():
                        firmante = ProfesorFirmaActaPeriodo(periodo=periodo)

                    else:
                        firmante = ProfesorFirmaActaPeriodo.objects.get(modalidad_id=modalidad, periodo=periodo)
                        valold = firmante.tipoprofesor.all().values_list('id', flat=True)
                    firmante.modalidad_id = modalidad
                    firmante.save(request)
                    firmante.tipoprofesor.clear()
                    if not tipo:
                        log(u'Removio tipo firmante: %s' % firmante, request, "del")
                        firmante.delete()
                        return JsonResponse({"result": "ok", 'mensaje': 'Todos los tipos fueron removidos'})
                    for firm in tipo:
                        firmante.tipoprofesor.add(firm)
                    log(u'Adiciono tipo profesor firmante: %s' % firmante, request, "add")
                    return JsonResponse({"result": "ok", 'mensaje': 'Tipo agregado correctamente'})
                except Exception as e:
                    print('Error on line {} - {}'.format(sys.exc_info()[-1].tb_lineno, e))
                    transaction.set_rollback(True)
                    return JsonResponse({"result": "bad", "mensaje": u"Solicitud Incorrecta.", 'valold': valold})

            elif action == 'resultadosevaluaciondocenteposgrado':
                try:
                    data['title'] = u"Resultados Evaluación Docente"
                    profesor = Profesor.objects.filter(Q(persona=int(encrypt(request.GET['id'])), activo=True, status=True)).first()
                    profesormateria = ProfesorMateria.objects.values_list('materia_id', flat=True).filter(Q(profesor=profesor) & Q(materia__cerrado=False) | Q(materia__cerrado__isnull=True) & Q(activo=True, principal=True))
                    hoy = datetime.now().date()
                    rubricas = RespuestaRubrica.objects.values_list('rubrica_id').filter(respuestaevaluacion__profesor=profesor, status=True).distinct()
                    preguntasrubricas = RubricaPreguntas.objects.filter(rubrica__in=rubricas)
                    data['hoy'] = hoy
                    data['preguntas'] = preguntasrubricas
                    data['periodo'] = periodo
                    data['profesor'] = profesor
                    data['idmat'], data['idmal'], data['idp'], data['idcv'] = request.GET.get('idmat',''), request.GET.get('idmal', ''), request.GET.get('idp', ''), request.GET.get('idcv', '')
                    data['listadoMaterias'] = Materia.objects.filter(id__in=set(profesormateria), status=True)
                    return render(request, "niveles/resultadosevaluaciondocenteposgrado.html", data)
                except Exception as ex:
                    return HttpResponseRedirect("/niveles?info=Error: %s" % ex.__str__())

            elif action == 'reporteestudiantesmatriculadosvariascarreras':
                try:
                    data['title'] = u"Resultados Evaluación Docente"
                    cursor = connections['sga_select'].cursor()
                    sql = f"""
                            SELECT 
                              coordinacion.nombre Facultad,
                              carrera.nombre Carrera,
                              nivelmalla.nombre Semestre,
                              (persona.apellido1||' '||persona.apellido2||' '||persona.nombres) estudiante,
                              CASE  
                                 WHEN persona.cedula IS NOT NULL OR persona.cedula !=''   THEN 'CEDULA'
                                 WHEN persona.pasaporte IS NOT NULL OR persona.pasaporte !='' THEN 'PASAPORTE'
                                 WHEN persona.ruc IS NOT NULL OR persona.ruc !='' THEN 'RUC'
                                 ELSE ''
                              END TipoDocumento,
                              CASE  
                                 WHEN persona.cedula IS NOT NULL OR persona.cedula !=''   THEN persona.cedula
                                 WHEN persona.pasaporte IS NOT NULL OR persona.pasaporte !='' THEN persona.pasaporte
                                 WHEN persona.ruc IS NOT NULL OR persona.ruc !='' THEN persona.ruc
                                 ELSE ''
                              END Documento,
                              sexo.nombre Genero,
                              persona.telefono TelefonoMovil,
                              persona.telefono_conv Telefono,
                              persona.email Email,
                              persona.emailinst EmailInst,
                              CASE WHEN graduado.id IS NOT NULL THEN 'SI' ELSE 'NO'END GraduadoUnemi,
                              perdidagratuidad.observacion MotivoPerdidaGratuidad,
                              CASE 
                                    WHEN perdidagratuidad.titulo_sniese THEN 'SI' 
                                    WHEN	perdidagratuidad.id IS NULL THEN	''  
                                    ELSE 'NO'END titulo_sniese,
                              CASE 
                                    WHEN perdidagratuidad.cupo_aceptado_senescyt THEN 'SI'
                                    WHEN	perdidagratuidad.id IS NULL THEN	''  
                                    ELSE 'NO'END cupo_aceptado_senescyt,
                              CASE 
                                    WHEN perdidagratuidad.segunda_carrera_raes THEN 'SI'
                                    WHEN	perdidagratuidad.id IS NULL THEN	''
                                    ELSE 'NO'END segunda_carrera_raes
                              
                            FROM 
                              sga_inscripcion inscripcion
                              INNER JOIN sga_persona persona ON persona.id=inscripcion.persona_id
                              LEFT  JOIN sga_sexo sexo ON sexo.id=persona.sexo_id
                              INNER JOIN sga_coordinacion coordinacion ON coordinacion.id=inscripcion.coordinacion_id
                              INNER JOIN sga_carrera carrera ON carrera.id=inscripcion.carrera_id
                              INNER JOIN sga_perfilusuario perfilusuario  ON perfilusuario.inscripcion_id=inscripcion.id
                              INNER JOIN sga_matricula matricula ON matricula.inscripcion_id=inscripcion.id
                              INNER JOIN sga_nivel nivel ON nivel.id=matricula.nivel_id
                              INNER JOIN sga_nivelmalla nivelmalla ON nivelmalla.id=matricula.nivelmalla_id
                              LEFT JOIN sga_graduado graduado ON graduado.inscripcion_id=inscripcion.id AND graduado."status"
                              LEFT JOIN sga_perdidagratuidad perdidagratuidad ON perdidagratuidad.inscripcion_id=inscripcion.id AND perdidagratuidad."status"
                            WHERE
                               (
                                  SELECT COUNT(*) FROM sga_matricula 
                                  INNER JOIN sga_inscripcion ON sga_inscripcion.id=sga_matricula.inscripcion_id
                                  INNER JOIN sga_nivel ON sga_nivel.id=sga_matricula.nivel_id
                                  WHERE 
                                   sga_matricula."status" 
                                   AND sga_matricula.retiradomatricula=FALSE 
                                   AND sga_inscripcion.persona_id=persona.id
                                   AND sga_inscripcion.coordinacion_id IN(1,2,3,4,5)
                                   AND sga_nivel.periodo_id=nivel.periodo_id
                               )>1
                               AND inscripcion.coordinacion_id IN(1,2,3,4,5)
                               AND inscripcion."status"
                               AND perfilusuario."status"
                               AND perfilusuario.visible
                               AND matricula."status"
                               AND matricula.retiradomatricula=FALSE
                               AND nivel.periodo_id={periodo.id}
                            ORDER BY estudiante, inscripcion.id
                    """
                    cursor.execute(sql)
                    output = io.BytesIO()
                    rows_effected = cursor.rowcount
                    results = cursor.fetchall()
                    campos = [desc[0] for desc in cursor.description]
                    __author__ = 'Unemi'
                    workbook = xlsxwriter.Workbook(output, {'constant_memory': True})
                    worksheet = workbook.add_worksheet('ListadoEstudiantes')
                    fuentecabecera = workbook.add_format({
                        'align': 'center',
                        'bg_color': 'silver',
                        'border': 1,
                        'bold': 1
                    })

                    formatoceldacenter = workbook.add_format({
                        'border': 1,
                        'valign': 'vcenter',
                        'align': 'center'})

                    row_num, numcolum = 0, 0
                    for col_num in campos:
                        worksheet.write(row_num, numcolum, col_num, fuentecabecera)
                        worksheet.set_column(row_num, numcolum, 40)
                        numcolum += 1
                    row_num += 1

                    for lis in results:
                        colum_num = 0
                        for l in lis:
                            worksheet.write(row_num, colum_num, l, formatoceldacenter)
                            worksheet.set_column(row_num, numcolum, 40)
                            colum_num += 1
                        row_num += 1
                    workbook.close()
                    output.seek(0)
                    name_document = 'reporte_matriculados_2_carrera_{}'.format(str(datetime.now().strftime('%Y%m%d_%H%M%S')))
                    filename = f'{name_document}.xlsx'
                    response = HttpResponse(
                        output,
                        content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                    )
                    response['Content-Disposition'] = 'attachment; filename=%s' % filename

                    return response
                except Exception as ex:
                    return HttpResponseRedirect("/niveles?info=Error: %s" % ex.__str__())

            elif action == 'condicionesevaluardocente':
                try:
                    data['title'] = 'Condiciones para evaluar docente'
                    hoy = datetime.now().date()
                    data['hoy'] = hoy
                    filtros, s, url_vars = Q(status=True), request.GET.get('s', ''), f'&action={action}'
                    if 'id' in request.GET:
                        data['nivel'] = nivel = Nivel.objects.get(pk=request.GET['id'])
                    if 'mallaid' in request.GET:
                        data['malla'] = malla = Malla.objects.get(pk=int(request.GET['mallaid']))
                    if 'matid' in request.GET:
                        data['materia'] = materia = Materia.objects.get(pk=request.GET['matid'], status=True)
                        data['registrofechas'] = registrofechas = True if materia.inicioeval and materia.fineval else False
                        fechas = False
                        if registrofechas:
                            fechas = materia.inicioeval <= hoy <= materia.fineval
                        data['fechas'] = fechas
                        # proceso.activo_estudiantes()
                        proceso = materia.nivel.periodo.proceso_evaluativo()
                        data['procesoeactivo'] = procesoeactivo = proceso.instrumentoheteroactivo
                        data['procesoevaluativofechas'] = procesoevaluativofechas = True if proceso.instrumentoheteroinicio and proceso.instrumentoheterofin else False
                        activoestudiantes = False
                        if procesoevaluativofechas:
                            activoestudiantes = proceso.instrumentoheteroinicio <= hoy <= proceso.instrumentoheterofin
                        data['procesoevaluativo'] = activoestudiantes
                        data['profesorp'] = profesorprincipal = materia.profesor_principal()
                        listaprofesor = []
                        for p in materia.profesores_materia():
                            profesordistributivohoras = ProfesorDistributivoHoras.objects.filter(
                                                            profesor=p.profesor,
                                                            periodo=periodo).order_by('-profesor__persona__usuario__is_active', 'profesor')
                            if profesordistributivohoras:
                                listaprofesor.append([str(p.profesor),'Registrado en Distributivo', True])
                            else:
                                listaprofesor.append([str(p.profesor), 'No se encuentra registrado en Distributivo', False])
                        data['profesordistributivohoras'] = listaprofesor
                    data['url_vars'] = url_vars
                    return render(request, "niveles/condicionesevaluardocente.html", data)
                except Exception as ex:
                    pass

            if action == 'resumenevaluar':
                data['title'] = u'Listado de modalidades a evaluar heteroevaluación'
                listamodalrubricas = []
                rubricalistadomodalidades = RubricaModalidadTipoProfesor.objects.values_list('modalidad_id', 'tipoprofesor_id').filter(rubrica__proceso__periodo=periodo, rubrica__para_hetero=True, status=True).distinct()
                for rubmodal in rubricalistadomodalidades:
                    listamodalrubricas.append(str(rubmodal[0]) + '' + str(rubmodal[1]))
                data['tipoprofesorevalua'] = TipoProfesor.objects.values_list('id', flat=True).filter(evaluahetero=True, status=True)
                listadomodalidades = ProfesorMateria.objects. \
                    values_list('materia__nivel__modalidad_id',
                                'materia__nivel__modalidad__nombre',
                                'tipoprofesor_id',
                                'tipoprofesor__nombre'). \
                    annotate(sumatoria=Concat('materia__nivel__modalidad_id', 'tipoprofesor_id')). \
                    annotate(numprofe=Count('profesor', distinct=True)). \
                    filter(materia__nivel__periodo=periodo, materia__nivel__status=True, materia__status=True, status=True)

                data['listadomodalidades'] = listadomodalidades
                data['listamodalrubricas'] = listamodalrubricas
                return render(request, "niveles/resumenevaluar.html", data)

            if action == 'docentesevaluar':
                data['title'] = u'Listado de docentes que serán evaluados'
                search, filtro, url_vars = request.GET.get('s', ''), Q(status=True), ''
                data['modalidad'] = modalidad = Modalidad.objects.get(pk=request.GET['idmodalidad'])
                data['tipoprofesor'] = tipoprofesor = TipoProfesor.objects.get(pk=request.GET['idtipoprofesor'])
                if 's' in request.GET:
                    search = request.GET['s'].strip()
                    ss = search.split(' ')
                    if len(ss) == 1:
                        listadoprofesores = ProfesorMateria.objects.filter(Q(profesor__persona__nombres__icontains=search) |
                                                                           Q(profesor__persona__apellido1__icontains=search) |
                                                                           Q(profesor__persona__apellido2__icontains=search) |
                                                                           Q(profesor__persona__cedula__icontains=search) |
                                                                           Q(profesor__persona__pasaporte__icontains=search) |
                                                                           Q(profesor__persona__usuario__username__icontains=search),
                                                                           materia__nivel__periodo=periodo,materia__nivel__modalidad=modalidad, tipoprofesor=tipoprofesor, materia__nivel__status=True, materia__status=True, status=True). \
                            order_by('profesor__persona__apellido1', 'profesor__persona__apellido2', 'profesor__persona__nombres', 'materia__paralelo')
                    else:
                        listadoprofesores = ProfesorMateria.objects.filter(Q(profesor__persona__apellido1__icontains=ss[0]) &
                                                                           Q(profesor__persona__apellido2__icontains=ss[1]),
                                                                           materia__nivel__periodo=periodo, materia__nivel__modalidad=modalidad, tipoprofesor=tipoprofesor, materia__nivel__status=True, materia__status=True, status=True). \
                            order_by('profesor__persona__apellido1', 'profesor__persona__apellido2', 'profesor__persona__nombres', 'materia__paralelo')
                else:
                    listadoprofesores = ProfesorMateria.objects.filter(materia__nivel__periodo=periodo, materia__nivel__modalidad=modalidad, tipoprofesor=tipoprofesor, materia__nivel__status=True, materia__status=True, status=True). \
                        order_by('profesor__persona__apellido1', 'profesor__persona__apellido2', 'profesor__persona__nombres', 'materia__paralelo')
                numerofilas = 25
                paging = MiPaginador(listadoprofesores, numerofilas)
                p = 1
                url_vars += "&action=docentesevaluar&idmodalidad="+request.GET['idmodalidad']+"&idtipoprofesor="+request.GET['idtipoprofesor']
                try:
                    paginasesion = 1
                    if 'paginador' in request.session:
                        paginasesion = int(request.session['paginador'])
                    if 'page' in request.GET:
                        p = int(request.GET['page'])
                        if p == 1:
                            numerofilasguiente = numerofilas
                        else:
                            numerofilasguiente = numerofilas * (p - 1)
                    else:
                        p = paginasesion
                        if p == 1:
                            numerofilasguiente = numerofilas
                        else:
                            numerofilasguiente = numerofilas * (p - 1)
                    try:
                        page = paging.page(p)
                    except:
                        p = 1
                    page = paging.page(p)
                except:
                    page = paging.page(p)
                request.session['paginador'] = p
                data['paging'] = paging
                data['numerofilasguiente'] = numerofilasguiente
                data['numeropagina'] = p
                data['rangospaging'] = paging.rangos_paginado(p)
                data['page'] = page
                data['search'] = search if search else ""
                data["url_vars"] = url_vars
                data['listadoprofesores'] = page.object_list
                return render(request, "niveles/listadodocentesevaluados.html", data)

            if action == 'loadViewPlanificar':
                data['id'] = id = request.GET.get('id', 0)
                planificacion_completa = False
                eMateria = Materia.objects.filter(pk=id).filter(inicio__isnull=False,fin__isnull=False,fechafinasistencias__isnull=False, status=True)
                if eMateria:
                    planificacion_completa= eMateria.first().existe_horario()
                else:
                    planificacion_completa = False
                data['planificacion_completa'] =planificacion_completa
                data['action']= action = 'save_planificacion_solicitud'
                materia = None
                if materia := PlanificacionMateria.objects.filter(materia__id=id, status=True).first():
                    f = PlanificacionMateriaSolicitudForm(initial={
                        "profesor": materia.profesor,
                        "autor": materia.autor,
                        "invitado": materia.invitado,
                        "observacionsolicitud": materia.observacionsolicitud,
                        "lanzar_convocatoria": materia.lanzar_convocatoria
                    })
                    data['existe'] = existe = True
                else:
                    f = PlanificacionMateriaSolicitudForm()
                    data['existe'] = existe = False

                data['materia'] = materia

                data['form2'] = f
                template = get_template('niveles/modal/planificarmateriaposgrado.html')
                return JsonResponse({"result": True, 'data': template.render(data)})


            if action == 'presidentecurso':
                try:
                    url_vars = f"&action={action}"
                    coordinacionid, nivelmallaid, carreraid, filtro = request.GET.get('coordinacionid', ''), request.GET.get('nivelmallaid', ''), request.GET.get('carreraid',''), Q(status=True)
                    data['title'] = u'Presidentes de curso'
                    data['periodo'] = periodo
                    #data['presidentes'] = PresidenteCurso.objects.filter((Q(matricula__nivel__periodo=periodo) | Q(matricula__isnull=True)), Q(status=True))
                    carreras = PresidenteCurso.objects.filter(status=True).values('carrera_id')
                    data['carreras'] = Carrera.objects.filter(status=True, pk__in=carreras)
                    data['coordinaciones'] = Coordinacion.objects.filter(status=True)
                    data['nivelesmalla'] = NivelMalla.objects.filter(status=True)


                    if carreraid and int(request.GET['carreraid']) > 0:
                        data['carreraid'] = int(carreraid)
                        filtro = filtro & Q(carrera__id=carreraid)
                        url_vars += f"&carreraid={carreraid}"


                    if nivelmallaid and int(request.GET['nivelmallaid']) > 0:
                        data['nivelmallaid'] = int(nivelmallaid)
                        filtro = filtro & Q(nivel__id=nivelmallaid)
                        url_vars += f"&nivelmallaid={nivelmallaid}"

                    presidente = PresidenteCurso.objects.filter(filtro, (Q(matricula__nivel__periodo=periodo) | Q(matricula__isnull=True)), desde=periodo.inicio, hasta=periodo.fin ).order_by('carrera_id', 'nivel_id', 'paralelo_id')
                    paging = MiPaginador(presidente, 20)
                    p = 1
                    try:
                        paginasesion = 1
                        if 'paginador' in request.session:
                            paginasesion = int(request.session['paginador'])
                        if 'page' in request.GET:
                            p = int(request.GET['page'])
                        else:
                            p = paginasesion
                        try:
                            page = paging.page(p)
                        except:
                            p = 1
                        page = paging.page(p)
                    except:
                        page = paging.page(p)
                    request.session['paginador'] = p
                    paging.rangos_paginado(p)
                    data['paging'] = paging
                    data['rangospaging'] = paging.rangos_paginado(p)
                    data['page'] = page
                    data['presidentes'] = page.object_list
                    data['url_vars'] = url_vars

                    return render(request, "niveles/presidentecurso.html", data)

                except Exception as ex:
                    pass

            elif action == 'editpresidentecurso':
                try:
                    data['title'] = u'Editar presidente de curso'
                    data['presidente'] = presidente =PresidenteCurso.objects.get(pk=int(request.GET['id']))
                    form = PresidenteCursoForm(initial={'desde': presidente.desde,
                                                            'hasta': presidente.hasta,
                                                        'activo': presidente.activo})
                    data['form'] = form
                    template = get_template("niveles/modal/editpresidentecurso.html")
                    return JsonResponse({"result": True, 'data': template.render(data)})
                except Exception as ex:
                    return JsonResponse({"result": False, 'message': str(ex)})

            elif action == 'delpresidentecurso':
                try:
                    data['title'] = u'Eliminar presidente de curso'
                    data['presidente'] = PresidenteCurso.objects.get(pk=int(request.GET['id']))
                    return render(request, "niveles/dpresidentecurso.html", data)
                except Exception as ex:
                    pass

            if action == 'buscarpersona':
                try:
                    presidente = PresidenteCurso.objects.get(pk=request.GET['id'], status=True)
                    q = request.GET['q'].upper().strip()
                    s = q.split(" ")
                    materias = Materia.objects.filter(status=True, asignaturamalla__malla__carrera__id=presidente.carrera_id,
                                                      asignaturamalla__nivelmalla__id=presidente.nivel_id, paralelomateria__id=presidente.paralelo_id,
                                                      nivel__periodo__id=periodo.id).values('id')
                    query = MateriaAsignada.objects.filter(status=True, materia__id__in=materias).distinct('matricula_id')
                    # query = materiasasignadas.objects.filter(status=True)
                    # query = Persona.objects.filter(status=True)
                    if len(s) == 1:
                        per = query.filter((Q(matricula__inscripcion__persona__nombres__icontains=q) | Q(matricula__inscripcion__persona__apellido1__icontains=q) | Q(matricula__inscripcion__persona__apellido2__icontains=q) | Q(matricula__inscripcion__persona__cedula__contains=q))).distinct('matricula_id')[:15]
                    elif len(s) == 2:
                        per = query.filter((Q(matricula__inscripcion__persona__apellido1__contains=s[0]) & Q(matricula__inscripcion__persona__apellido2__contains=s[1])) |
                                           (Q(matricula__inscripcion__persona__nombres__icontains=s[0]) & Q(matricula__inscripcion__persona__nombres__icontains=s[1])) |
                                           (Q(matricula__inscripcion__persona__nombres__icontains=s[0]) & Q(matricula__inscripcion__persona__apellido1__contains=s[1]))).distinct('matricula_id')[:15]
                    else:
                        per = query.filter((Q(matricula__inscripcion__persona__nombres__contains=s[0]) & Q(matricula__inscripcion__persona__apellido1__contains=s[1]) &
                                            Q(matricula__inscripcion__persona__apellido2__contains=s[2])) | (Q(matricula__inscripcion__persona__nombres__contains=s[0]) &
                                            Q(matricula__inscripcion__persona__nombres__contains=s[1]) & Q(matricula__inscripcion__persona__apellido1__contains=s[2]))).distinct('matricula_id')[:15]
                    data = {"result": "ok",
                            "results": [{"id": x.matricula_id, "name": str(x.matricula.inscripcion.persona.nombre_completo())}
                                        for x in per]}
                    return JsonResponse(data)
                except Exception as ex:
                    pass

            return HttpResponseRedirect(request.path)

        else:
            try:
                categorias = []
                reportes_categoria = Reporte.objects.filter(id=451, interface=False).distinct().order_by('descripcion')
                if reportes_categoria:
                    categorias.append({'nombre': reportes_categoria.first().categoria.nombre, 'reportes': reportes_categoria})
                data['categorias'] = categorias

                template = u"niveles/view.html"
                coordinacionesdip = [7]

                if not request.user.has_perm('sga.puede_visible_periodo'):
                    if not request.session['periodo'].visible:
                        return HttpResponseRedirect("/?info=Periodo Inactivo.")
                r = False
                if 'info' in request.GET and request.GET['info']:
                    data['info'] = request.GET['info']
                data['title'] = u'Niveles académicos'
                data['aprobacion_distributivo'] = APROBACION_DISTRIBUTIVO
                data['periodo'] = request.session['periodo']
                data['ePeriodo'] = PeriodoActaAdmision.objects.filter(periodo=periodo).first()
                data['reporte_0'] = obtener_reporte('reporte_matriculados')
                data['can_reporte_1'] = True if datetime.now().date() > periodo.fin else False
                data['reporte_1'] = obtener_reporte('rpt_poa_resultados_aprobacion_estudiantes_x_asignatura')
                data['periodos_retencion'] = Periodo.objects.filter(status=True, tipo_id=2).exclude(
                    pk__in=[15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37,
                            38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
                            61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75])
                data['reporte_matriculados_postgrado'] = obtener_reporte('estudiantes_matriculados_postgrado')

                if periodo.tipo_id in [3, 4]:
                    data['coordinaciones'] = Coordinacion.objects.filter(pk__in=coordinacionesdip, status=True)
                    template = "niveles/viewdip.html"
                else:
                    data['coordinaciones'] = persona.mis_coordinaciones()

                return render(request, template, data)
            except Exception as ex:
                return HttpResponseRedirect(f"/?info={ex.__str__()}")


def elimina_rubros(mat):
    eliminar = True
    rubros = Rubro.objects.filter(status=True, matricula=mat)
    if rubros.exists():
        for r in rubros:
            if Pago.objects.filter(rubro=r).exists():
                eliminar = False
    else:
        eliminar = False
    return eliminar
