{% extends "basebs.html" %}
{% load sga_extras %}
{% load humanize %}
{% block heading %}
    <script src="/static/adicionalesjs/formquestionb4.js?0.25"></script>
    <link href="/static/dropzone/dist/min/dropzone.min.css" rel="stylesheet"/>
    <script src="/static/dropzone/dist/min/dropzone.min.js"></script>
    <script type="text/javascript" src='/static/js/select2.js?v=1.0.0'></script>
    <link type='text/css' rel='stylesheet' href="/static/css/select2.css?v=1.0.0"/>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
    <script src="/static/assets/js/moment.js"></script>
    <script type='text/javascript' src="/static/js/bootstrap-datepicker.js?1.0.0"></script>
    <script type='text/javascript' src="/static/js/bootstrap-timepicker.js?1.0.0"></script>
    <link href="/static/css/datepicker.css?1.0.0" rel='stylesheet'/>
    <link href="/static/css/bootstrap-timepicker.css?1.0.0" rel='stylesheet'/>
    <style type="text/css">
        .isloading-wrapper.isloading-right{margin-left:10px;}
        .isloading-overlay{position:relative;text-align:center;}.isloading-overlay .isloading-wrapper{background:#FFFFFF;-webkit-border-radius:7px;-webkit-background-clip:padding-box;-moz-border-radius:7px;-moz-background-clip:padding;border-radius:7px;background-clip:padding-box;display:inline-block;margin:0 auto;padding:10px 20px;top:10%;z-index:9000;}
        .cardContainer {
            display: flex;
            flex-wrap: wrap;

            justify-content: flex-start;
            align-items: center;
            flex-direction:row;
            padding: 1em;
            text-align: left;

        }

        .cardV1 {
            width: 30%;
            display: flex;
            align-content: space-between;
            padding: .6em 1.5em;
            margin: 0 5px;
            margin-bottom: 1em;
            border-radius: .3em;
            box-shadow: rgba(0, 0, 0, 0.2) 3px 6px 10px;
            border: solid 1px #ccc;
            min-width: 0;
            word-wrap: break-word;
            background-color: #f8f9fa;
            background-clip: border-box;
            border: 1px solid rgba(0,0,0,.125);
            border-radius: 0.25rem;
        }

        .actions {
            /*min-width: 80px;
            height: auto;
            border-radius: .3em;
            background: linear-gradient(to bottom, #d6c091 0%, #C05C9A 100%);
            border: solid 1px firebrick;*/
            opacity: .7;
            margin: .6em;
            padding: 5px;
            text-align: center;

        }

        .cardV1 h3 {
            margin: 0;
            margin-left: .5em;
            font-size: 1.1em;
        }

        .content p {
            margin: 0;
            font-size: 1em;
            margin-left: .5em;
            color: #222;
        }

        @media (max-width: 820px) {
            .cardContainer {
                min-width: 25%;
                display: block;
            }
            .cardV1 {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .cardV1 {
                box-shadow: none;
            }
        }



    </style>

    <script type="text/javascript">
        $(function () {
            $(".tl").tooltip({placement:"left"});
            $(".tr").tooltip({placement:"right"});
            $(".tu").tooltip({placement:"top"});
            $(".tb").tooltip({placement:"bottom"});

            //$('#id_horainicio').timepicker('setTime', inicio);
            //$('#id_horafin').timepicker('setTime', fin);
            /*$(".folder").droppable({
                revert: 'invalid',
                cursor: 'move',
                snapMode: "inner",
                drop: function (event, ui) {
                    var foldername_ = $(this).attr('data-name');
                    var folderid_ = $(this).attr('data-id');
                    var mover_ = false;
                    var actiondrop_ = '';
                    var textodrop_ = '';
                    var filename_ = '';
                    var fileid_ = '';
                    if (ui.draggable.attr("data-type") === 'file') {
                        filename_ = ui.draggable.attr("data-name");
                        fileid_ = ui.draggable.attr('data-id');
                        textodrop_ = `<div style="text-align: left; font-size:15px"><b style="font-size:20px">¿Deseas cambiar la ubicación de este archivo?</b><br><b>Archivo:</b> ${filename_}<br><b>Ubicación Actual:</b> {{ filtro.nombre  }}<br><b>Nueva Ubicación:</b> ${foldername_}</div>`
                        actiondrop_ = 'changefilefolder';
                        mover_ = true;
                    } else if (ui.draggable.attr("data-type") === 'folder') {
                        filename_ = ui.draggable.attr("data-name");
                        fileid_ = ui.draggable.attr('data-id');
                        textodrop_ = `<div style="text-align: left; font-size:15px"><b style="font-size:20px">¿Deseas cambiar la ubicación de está carpeta?</b><br><b>Carpeta:</b> ${filename_}<br><b>Ubicación Actual:</b> {{ filtro.nombre  }}<br><b>Nueva Ubicación:</b> ${foldername_}</div>`
                        actiondrop_ = 'changefolderfolder';
                        mover_ = true;
                    }

                }
            });

            $(".folder").draggable({
                zIndex: '50',
                connectToSortable: '.folder',
                appendTo: '.folder',
                revert: true,
            });*/
        });

    </script>
{% endblock %}
{% block atras %}/adm_horarios{% endblock %}
{% block canvas %}
    <div class="row-fluid">
        <div class="span-12">
            <h4>{{ title}}</h4>
            <h5>Periodo: {{ periodo}}</h5>
        </div>
    </div>
    {% if eCoordinaciones %}
        <div class="row-fluid">
            <div class="span-12">
                <div class="btn-group">
                    <a class="btn dropdown-toggle " data-toggle="dropdown" href="#"> Reportes <span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li><a href="{{ request.path }}?action=reporteaula_examenes&periodo={{ periodo.id }}" target="_blank"><i class="fa fa-file-excel-o" aria-hidden="true"></i>  Reporte de horarios examenes y aulas </a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class='row-fluid'>
            <div class="span12">
                {% for eCoordinacion in eCoordinaciones %}
                    <div class="accordion" id="accordion{{ eCoordinacion.id }}">
                        <div class="accordion-group" >
                            <div class="accordion-heading" style="background: #d9edf7">
                                <span class="accordion-toggle" data-toggle="collapse" data-parent="#accordion{{ eCoordinacion.id }}" href="#collapseCoordinacion_{{ eCoordinacion.id }}">
                                    <a class="" data-toggle="collapse" data-parent="#accordion{{ eCoordinacion.id }}" href="#collapseCoordinacion_{{ eCoordinacion.id }}"><i class="fa fa-tasks fa-fw"></i></a>
                                    <a data-toggle="collapse" data-parent="#accordion{{ eCoordinacion.id }}" href="#collapseCoordinacion_{{ eCoordinacion.id }}" >{{ eCoordinacion.nombre }} ({{ eCoordinacion.alias }})</a>
                                </span>
                            </div>
                            <div id="collapseCoordinacion_{{ eCoordinacion.id }}" class="accordion-body collapse in" style="margin: 10px;">
                                <div class="accordion-heading" style="padding-top: 15px; width: 100%; height: max-content; display: inline-block">
                                    {% with eSesiones=eCoordinacion|args:ePeriodo|call:"secciones_por_periodo" %}
                                        {% if eSesiones %}
                                            <div class="cardContainer">
                                                {% for eSesion in eSesiones %}
                                                    <div class="cardV1">
                                                        <div class="actions">
                                                            {% if eSesion|args:ePeriodo|args:eCoordinacion|call:"tiene_choque_horarioexamen" %}
                                                                <span style="color: #f89406;margin-right: 10px;" ><i class="fa fa-bell blinkimg"></i></span>
                                                            {% endif %}
                                                            <a class="btn btn-mini btn-primary" v-on:click="actionEventLoad('{{ eCoordinacion.id|encrypt }}', '{{ eSesion.id|encrypt }}')"><i class="fa fa-gears"></i></a>
                                                        </div>
                                                        <div class="content"><h3>{{ eSesion.nombre }}</h3>
                                                            <p>Comienza: {{ eSesion.comienza }} - Termina: {{ eSesion.termina }}</p>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <div class="alert alert-info">
                                                <a href="javascript:;" class="close" data-dismiss="alert">×</a>
                                                <h5 class="alert-heading">No se encontraron secciones para la coordinación</h5>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% else %}
        <div class='row-fluid'>
            <div class="span12">
                <div class="alert alert-info">
                    <a  href="javascript:;" class="close" data-dismiss="alert">×</a>
                    <h5 class="alert-heading">No se encontraron coordinaciones para el periodo académico {{ periodo.nombre }}<br></h5>
                </div>
            </div>
        </div>

    {% endif %}
    <div class="modal fade static" id="modalConfiguracionHorario">
        <div class="modal-header">
            <h4 class="paneltitle">HORARIOS DE EXÁMENES DE LA COORDINACIÓN <<${ eCoordinacion.nombre }>> DE LA SECCIÓN <<${ eSesion.nombre }>></h4>
        </div>
        <div class="modal-body panelbody">
            <div class='row-fluid'>
                <div class="span8">
                    <label style="font-weight: bold">Carrera:</label>
                    <select id="listCarrera" style="width: 100%" v-model="selectedValueMallaID" @change="onChangeSeacrh($event)">
                        <option v-for="option in eMallas" :key="option.id" v-bind:value="option.id" v-bind:class="{'tr-red':option.tiene_conflicto_horarioexamen_aula}" >${option.display}</option>
                    </select>
                </div>
                <div class="span2">
                    <label style="font-weight: bold">Nivel:</label>
                    <select id="listNivel" style="width: 100%" v-model="selectedValueNivelMallaID" @change="onChangeSeacrh($event)">
                        <option v-for="option in eNivelesMalla" :key="option.id" v-bind:value="option.id" v-bind:class="{'tr-red':option.tiene_conflicto_horarioexamen_aula}">${option.nombre}</option>
                    </select>
                </div>
                <div class="span2">
                    <label style="font-weight: bold">Paralelo:</label>
                    <select id="listPararelo" style="width: 100%" v-model="selectedValueParaleloID" @change="onChangeSeacrh($event)">
                        <option v-for="option in eParalelos" :key="option.id" v-bind:value="option.id" v-bind:class="{'tr-red':option.tiene_conflicto_horarioexamen_aula}">${option.nombre}</option>
                    </select>
                </div>
            </div>
            <div class="row-fluid">
                <div class="span12">
                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th style="width: 30%; text-align: center">Asignatura</th>
                            <th style="width: 35%; text-align: center">Horario de Clase</th>
                            <th style="width: 35%; text-align: center">Horario de Examen</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="eMateria in eMaterias" :key="eMateria.id" style="font-size: 10px" v-bind:class="{'tr-red':eMateria.tiene_conflictohorarioexamen}">
                            <td>
                                <div>
                                    ${eMateria.idm} - ${eMateria.display}
                                </div>
                                <div v-if="eMateria.asignaturamalla.nivelmalla">
                                    <span class="smaller">${eMateria.asignaturamalla.nivelmalla.nombre}</span>
                                </div>
                                <div>
                                    <span class="smaller">M.E.: ${eMateria.modeloevaluativo.nombre}</span>
                                </div>
                                <div>
                                    <span class="label label-info">ALUMNOS: ${eMateria.matriculados}</span>
                                </div>
                                <div v-if="eMateria.asignaturamalla.practicas || eMateria.rectora || eMateria.tutoria || eMateria.practicas || !eMateria.validacreditos || !eMateria.validapromedio || eMateria.tipomateria == 1 || eMateria.tipomateria == 2">
                                    <span class="label label-warning tu" v-if="eMateria.asignaturamalla.practicas" title="Teórico-Práctica">TP</span>
                                    <span class="label label-info tu" title="Materia general">MG</span>
                                    <span class="label label-warning tu" v-if="eMateria.asignaturamalla.practicas" title="Tutoria">TR</span>
                                    <span class="label label-warning tu" v-if="eMateria.practicas" title="Prácticas pre-profesionales">PP</span>
                                    <span class="label label-warning tu" v-if="!eMateria.validacreditos" title="No valida para créditos">NVC</span>
                                    <span class="label label-warning tu" v-if="!eMateria.validapromedio" title="No valida para promedio">NVP</span>
                                    <span class="label tu" v-if="eMateria.tipomateria == 1" title="Presencial">PR</span>
                                    <span class="label label-inverse tu" v-if="eMateria.tipomateria == 2" title="Virtual">VR</span>
                                    <span class="label tu" v-if="eMateria.seevalua" title="Se Evalua">EV</span>
                                    <span class="label label-inverse tu" v-else title="No se Evalua">NEV</span>
                                </div>

                                <span class="label label-primary tu" v-if="eMateria.asignaturamalla.malla.carrera.modalidad == 1" title="Modalidad Imparticion Clase">Mod. Imp. Clase: Presencial</span>
                                <span class="label label-darkgreen tu" v-if="eMateria.asignaturamalla.malla.carrera.modalidad == 2" title="Modalidad Imparticion Clase">Mod. Imp. Clase: Semipresencial</span>
                                <span class="label label-purple tu" v-if="eMateria.asignaturamalla.malla.carrera.modalidad == 3" title="Modalidad Imparticion Clase">Mod. Imp. Clase: Virtual</span>
                                <span class="label label-info tu" v-if="eMateria.asignaturamalla.malla.carrera.modalidad == 4" title="Modalidad Imparticion Clase">Mod. Imp. Clase: Hibrida</span>
                                <hr style="margin: 1px; margin-top: 5px; padding: 1px; color: #0e0e0e">
                                <table class="table table-condensed">
                                    <tr v-for="eProfesorMateria in eMateria.profesores" :key="eProfesorMateria.id">
                                        <td>
                                            ${eProfesorMateria.tipoprofesor.nombre} - <strong>${eProfesorMateria.profesor.persona.nombre_completo}</strong>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                            <td style="text-align: center;">
                                <div v-for="eHorarioAula in eMateria.horario_clase" :key="eHorarioAula.id">
                                    <h6>${eHorarioAula.display}</h6>
                                    <table class="table table-bordered table-condensed">
                                        <thead>
                                        <tr>
                                            <th style="text-align: center; vertical-align: middle; font-size: 9px">Día</th>
                                            <th style="text-align: center; vertical-align: middle; font-size: 9px">Hora</th>
                                            <th style="text-align: center; vertical-align: middle; font-size: 9px">Tipo</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr v-for="eClase in eHorarioAula.eClases" :key="eClase.id">
                                            <td style="text-align: center; vertical-align: middle; font-size: 9px">${eClase.dia_display}</td>
                                            <td style="text-align: center; vertical-align: middle; font-size: 9px">${eClase.turno.comienza} - ${eClase.turno.termina}</td>
                                            <td style="text-align: center; vertical-align: middle; font-size: 9px">${eClase.tipohorario_display}</td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>

                            </td>
                            <td style="text-align: left;">
                                <div v-if="!eMateria.cerrado">
                                    {% if perms.inno.puede_crear_horarioexamen %}
                                        <a href="javascript:;" class="btn btn-mini btn-success tu" v-on:click="openModalHorarioExamen(eMateria)" title="Adicionar"><i class="fa fa-plus"></i> Agregar</a>
                                    {% endif %}
                                    <table class="table table-bordered table-condensed" v-if="eMateria.horario_examen.length">
                                        <thead>
                                        <tr>
                                            <th style="padding: 0;text-align: center; vertical-align: middle"><i class="fa fa-gears"></i></th>
                                            <th style="padding: 0;text-align: center; vertical-align: middle">Examen</th>
                                            <th style="padding: 0;text-align: center; vertical-align: middle">Aula</th>
                                            <th style="padding: 0;text-align: center; vertical-align: middle">Fecha</th>
                                            <th style="padding: 0;text-align: center; vertical-align: middle">H.Inicio</th>
                                            <th style="padding: 0;text-align: center; vertical-align: middle">H.Fin</th>
                                            <th style="padding: 0;text-align: center; vertical-align: middle">Cant.</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr v-for="eHorario in eMateria.horario_examen" :key="eHorario.id">
                                            <td style="text-align: center; vertical-align: middle">
                                                {% if perms.inno.puede_editar_horarioexamen %}
                                                    <a class='btn btn-tini btn-warning btn-mini tu' v-if="eHorario.puede_editar" v-on:click="openModalHorarioExamen(eMateria, eHorario)" title="Editar"><span class="fa fa-edit"></span> </a>
                                                {% endif %}
                                                {% if perms.inno.puede_eliminar_horarioexamen %}
                                                    <a class='btn btn-tini btn-danger btn-mini tu' v-if="eHorario.puede_eliminar" v-on:click="deleteHorarioExamen(eMateria, eHorario)" title="Eliminar"><span class="fa fa-remove"></span> </a>
                                                {% endif %}
                                                {% if perms.inno.puede_clonar_horarioexamen %}
                                                    <a class='btn btn-tini btn-info btn-mini tu' v-on:click="openCloneHorarioExamen(eMateria, eHorario)" title="Clonar"><span class="fa fa-copy"></span> </a>
                                                {% endif %}
                                            </td>
                                            <td style="text-align: center; vertical-align: middle">
                                                <span v-if="eHorario.conflicto_horarioexamen_aula.length > 0 || eHorario.conflicto_horarioexamen_profesor.length > 0" v-on:click="openModalHorarioExamenConflicto(eMateria, eHorario.conflicto_horarioexamen_aula, eHorario.conflicto_horarioexamen_profesor)" style="color: #f89406;margin-right: 10px;"><i class="fa fa-bell blinkimg"></i></span>
                                                ${eHorario.horarioexamen.detallemodelo.nombre}
                                            </td>
                                            <td style="text-align: center; vertical-align: middle">
                                                <div v-if="eHorario.aula">${eHorario.aula.display}</div>
                                                <div v-else>Sin Aula</div>
                                            </td>
                                            <td style="text-align: center; vertical-align: middle">${eHorario.horarioexamen.fecha}</td>
                                            <td style="text-align: center; vertical-align: middle">${eHorario.horainicio}</td>
                                            <td style="text-align: center; vertical-align: middle">${eHorario.horafin}</td>
                                            <td style="text-align: center; vertical-align: middle">${eHorario.cantalumnos}</td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div v-else>
                                    <div class="alert alert-info">
                                        <h4 class="alert-heading">Materia se encuentra cerrada</h4>
                                    </div>
                                </div>

                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn action-close">CERRAR</a>
        </div>
    </div>

    <div class="modal fade static" id="modalHorarioExamen">
        <div class="modal-header">
            <h3 class="paneltitle">Horario de examen</h3>
        </div>
        <div class="modal-body">
            <div class="row-fluid">
                <form id="formulario2" class='form-vertical' action="" method="POST" >
                    <fieldset id="fieldset_tiporesponsable" class="control-group nomargins" style="min-height:35px; float: left; width: 15%" >
                        <div class="control-label label-text" labelwidth="" style="display: table;height: 30px;">
                            <div style="display: table-cell; vertical-align: middle; line-height: 11px">
                                <label for="id_tiporesponsable" style="padding-right: 20px; font-weight: bold">Tipo responsable: </label>
                            </div>
                        </div>
                        <div class="control" style="float: left; width: 95%">
                            <select name="tiporesponsable" id="id_tiporesponsable" @change="onChangeTipoResponsable(eMateria, $event.target.value)">
                                <option value="0">Ninguno</option>
                                <option value="1">Profesores de la materia</option>
                                <option value="2">Profesores general</option>
                                <option value="3">Administrativos</option>
                            </select>
                        </div>
                    </fieldset>

                    <fieldset id="fieldset_responsable" class="control-group nomargins" style="min-height:35px; float: left; width: 35%" >
                        <div class="control-label label-text" labelwidth="" style="display: table;height: 30px;">
                            <div style="display: table-cell; vertical-align: middle; line-height: 11px">
                                <label for="id_responsable" style="padding-right: 20px; font-weight: bold">Responsable: </label>
                            </div>
                        </div>
                        <div class="control" style="float: left; width: 95%">
                            <select name="responsable" id="id_responsable">
                                <option  v-for="option in eResponsables" :key="option.id" v-bind:value="option.id">${option.display}</option>
                            </select>
                        </div>
                    </fieldset>
                    <fieldset id="fieldset_examen" class="control-group nomargins" style="min-height:35px; float: left; width: 15%" >
                        <div class="control-label label-text" labelwidth="" style="display: table;height: 30px;">
                            <div style="display: table-cell; vertical-align: middle; line-height: 11px">
                                <label for="id_detallemodelo" style="padding-right: 20px; font-weight: bold">Examen: </label>
                            </div>
                        </div>
                        <div class="control" style="float: left; width: 75%">
                            <select name="detallemodelo" id="id_detallemodelo">
                                <option v-for="option in eMateria.configuracionexamen" :key="option.id" v-bind:value="option.id" >${option.nombre}</option>
                            </select>
                        </div>
                    </fieldset>

                    <fieldset id="fieldset_aula" class="control-group nomargins" style="min-height:35px; float: left; width: 25%" >
                        <div class="control-label label-text" labelwidth="" style="display: table;height: 30px;">
                            <div style="display: table-cell; vertical-align: middle; line-height: 11px">
                                <label for="id_aula" style="padding-right: 20px; font-weight: bold">Aula: </label>
                            </div>
                        </div>
                        <div class="control" style="float: left; width: 96%">
                            <select name="aula" id="id_aula">
                                {#                                {% for eAula in eAulas %}#}
                                {#                                    <option value="{{ eAula.id|encrypt }}" >{{ eAula.nombre_display }}</option>#}
                                {#                                {% endfor %}#}
                                <option v-for="option in eAulas" :key="option.id" v-bind:value="option.id" >${option.display}</option>
                            </select>
                        </div>
                    </fieldset>

                    <fieldset id="fieldset_fecha" class="control-group nomargins" style="min-height:35px; float: left; width: 20%" >
                        <div class="control-label label-text" labelwidth="" style="display: table;height: 30px;">
                            <div style="display: table-cell; vertical-align: middle; line-height: 11px">
                                <label for="id_fecha_examen" style="padding-right: 20px; font-weight: bold">Fecha: </label>
                            </div>
                        </div>
                        <div class="control" style="float: left; width: 50%">
                            <input type="text" name="fecha_examen" id="id_fecha_examen">
                        </div>
                    </fieldset>
                    <fieldset id="fieldset_hora_comienza" class="control-group nomargins" style="min-height:35px; float: left; width: 20%" >
                        <div class="control-label label-text" labelwidth="" style="display: table;height: 30px;">
                            <div style="display: table-cell; vertical-align: middle; line-height: 11px">
                                <label for="id_hora_comienza" style="padding-right: 20px; font-weight: bold">Hora comienza: </label>
                            </div>
                        </div>
                        <div class="control" style="float: left; width: 75%">
                            <input type="text" name="hora_comienza" id="id_hora_comienza">
                        </div>
                    </fieldset>
                    <fieldset id="fieldset_hora_termina" class="control-group nomargins" style="min-height:35px; float: left; width: 20%" >
                        <div class="control-label label-text" labelwidth="" style="display: table;height: 30px;">
                            <div style="display: table-cell; vertical-align: middle; line-height: 11px">
                                <label for="id_hora_termina" style="padding-right: 20px; font-weight: bold">Hora termina: </label>
                            </div>
                        </div>
                        <div class="control" style="float: left; width: 75%">
                            <input type="text" name="hora_termina" id="id_hora_termina">
                        </div>
                    </fieldset>
                    <fieldset id="fieldset_cantidad_alumno" class="control-group nomargins" style="min-height:35px; float: left; width: 20%" >
                        <div class="control-label label-text" labelwidth="" style="display: table;height: 30px;">
                            <div style="display: table-cell; vertical-align: middle; line-height: 11px">
                                <label for="id_cantidad_alumno" style="padding-right: 20px; font-weight: bold">Cantidad alumno: </label>
                            </div>
                        </div>
                        <div class="control" style="float: left; width: 98%">
                            <input type="number" name="cantidad_alumno" id="id_cantidad_alumno">
                        </div>
                    </fieldset>
                    <fieldset id="fieldset_validahorario" class="control-group nomargins" style="min-height:35px; float: left; width: 20%" >
                        <div class="control-label label-text" labelwidth="" style="display: table;height: 30px;">
                            <div style="display: table-cell; vertical-align: middle; line-height: 11px">
                                <label for="id_validahorario" style="padding-right: 20px; font-weight: bold">¿Valida horario? </label>
                            </div>
                        </div>
                        <div class="control" style="float: left; width: 98%">
                            <input type="checkbox" name="validahorario" id="id_validahorario" v-model="valueValidaHorario">
                        </div>
                    </fieldset>

                </form>
            </div>

        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn btn-success action-save">GUARDAR</a>
            <a href="javascript:;" class="btn action-close">CERRAR</a>
        </div>
    </div>
    <div class="modal fade static" id="modalCloneHorarioExamen">
        <div class="modal-header">
            <h3 class="paneltitle">Clonar Horario de examen</h3>
        </div>
        <div class="modal-body">
            <div class="row-fluid">
                <form id="formulario2" class='form-vertical' action="" method="POST" >
                    <input value="0" type="hidden" name="clone_examen" id="id_clone_examen">
                    <fieldset id="fieldset_examen" class="control-group nomargins" style="min-height:35px; float: left; width: 100%" >
                        <div class="control-label label-text" labelwidth="" style="display: table;height: 30px;">
                            <div style="display: table-cell; vertical-align: middle; line-height: 11px">
                                <label for="id_detallemodelo_clone" style="padding-right: 20px; font-weight: bold">Examen: </label>
                            </div>
                        </div>
                        <div class="control" style="float: left; width: 100%">
                            <select name="detallemodelo" id="id_detallemodelo_clone">
                                <option v-for="option in eMateria.configuracionexamen" :key="option.id" v-bind:value="option.id" >${option.nombre}</option>
                            </select>
                        </div>
                    </fieldset>

                    <fieldset id="fieldset_fecha" class="control-group nomargins" style="min-height:35px; float: left; width: 100%" >
                        <div class="control-label label-text" labelwidth="" style="display: table;height: 30px;">
                            <div style="display: table-cell; vertical-align: middle; line-height: 11px">
                                <label for="id_fecha_clone" style="padding-right: 20px; font-weight: bold">Fecha: </label>
                            </div>
                        </div>
                        <div class="control" style="float: left; width: 100%">
                            <input type="text" name="fecha_examen" id="id_fecha_clone">
                        </div>
                    </fieldset>
                </form>
            </div>

        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn btn-success action-save">GUARDAR</a>
            <a href="javascript:;" class="btn action-close">CERRAR</a>
        </div>
    </div>
    <div class="modal fade static" id="modalHorarioExamenConflicto">
        <div class="modal-header">
            <h3 class="paneltitle">Horario de examen conflicto</h3>
        </div>
        <div class="modal-body">
            <div class="row-fluid">
                <table>
                    <thead>
                    <tr>
                        <th>Asignatura</th>
                        <th>Tipo Conflicto</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="eHorarioConflicto in eHorarioDetalleConflictoAula">
                        <td>
                            ${eHorarioConflicto.display}
                        </td>
                        <td>Choque en Aula</td>
                    </tr>
                    <tr v-for="eHorarioConflicto in eHorarioDetalleConflictoProfesor">
                        <td>
                            ${eHorarioConflicto.display}
                        </td>
                        <td>Choque en Profesor</td>
                    </tr>
                    <tr v-if="eHorarioDetalleConflictoAula.length == 0 && eHorarioDetalleConflictoProfesor.length == 0">
                        <td colspan="2">Conflicto en capacidad de aula</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn action-close">CERRAR</a>
        </div>
    </div>
{% endblock %}

{% block extraJs %}
    <script src="/static/js/vue.js"></script>
    <script type="text/javascript">
        const loadAjax = (data, url) => new Promise((resolve, reject) => {
            $.ajax({
                type: "POST",
                url: url,
                data: data,
                success: function(response) {
                    resolve({
                        error: false,
                        value: response
                    });
                },
                error: function() {
                    reject({
                        error: true,
                        message: "Error al enviar los datos."
                    });
                },
                dataType: "json"
            });

        });
        var app = new Vue({
            delimiters: ['${', '}'],
            el: '#app',
            data: {
                eCoordinacion: {},
                eSesion: {},
                eAulas: [],
                eMallas: [],
                eMalla: {},
                selectedValueMallaID: '',
                eNivelesMalla: [],
                eNivelMalla: {},
                selectedValueNivelMallaID: '',
                eParalelos: [],
                eParalelo: {},
                selectedValueParaleloID: '',
                eMaterias: [],
                eMateria: {},
                conflicto:0,
                eHorarioDetalle: {},
                eMateriaConflicto: {},
                eHorarioDetalleConflictoAula: [],
                eHorarioDetalleConflictoProfesor: [],
                eResponsables: [],
                valueValidaHorario: true,
            },
            created(){
                var self = this;
            },
            mounted: function (){
                var self = this;
                self.$modalConfiguracionHorario = $("#modalConfiguracionHorario");
                self.$modalHorarioExamen = $("#modalHorarioExamen");
                self.$modalHorarioExamenConflicto = $("#modalHorarioExamenConflicto");
                self.$modalCloneHorarioExamen = $("#modalCloneHorarioExamen");

                $('.action-close', self.$modalConfiguracionHorario).click(function(){
                    self.closeModalConfiguracionHorario();
                });
                $('.action-close', self.$modalHorarioExamen).click(function(){
                    self.closeModalHorarioExamen();
                });
                $('.action-close',self.$modalHorarioExamenConflicto).click(function(){
                    self.closeModalHorarioExamenConflicto();
                });
                $('.action-close',self.$modalCloneHorarioExamen).click(function(){
                    self.closeCloneModalHorarioExamen();
                });
                $('.action-save', self.$modalHorarioExamen).click(function(){
                    self.saveHorarioExamen();
                });
                $('.action-save', self.$modalCloneHorarioExamen).click(function(){
                    self.cloneModalHorarioExamen();
                });

            },
            methods:{
                loading: function (){
                   bloqueointerface()
                },
                actionEventLoad: function (coordinacion_id, sesion_id, malla_id='', nivelmalla_id='', paralelo_id='') {
                    var self = this;
                    //console.log(coordinacion_id);
                    self.loading();
                    loadAjax({
                        'action': 'loadDetailLevel',
                        'idc': coordinacion_id,
                        'ids': sesion_id,
                        'idm': malla_id,
                        'idnm': nivelmalla_id,
                        'idp': paralelo_id
                    }, '/adm_horarios/examenes')
                        .then(response => {
                            //console.log(response.value);
                            if (response.value.result == 'ok') {
                                //console.log(response.value);
                                self.openModalConfiguracionHorario(response.value.aData);
                                $.unblockUI();
                            } else {
                                $.unblockUI();
                                NotificationJG.error(response.value.mensaje);
                            }
                        })
                        .catch(error => {
                            $.unblockUI();
                            NotificationJG.error(error.message);
                        });
                },
                closeModalConfiguracionHorario: function(){
                    var self = this;
                    self.$modalConfiguracionHorario.modal('hide');
                    self.eMalla = {};
                    self.eParalelo = {};
                    self.eNivelesMalla = {};
                    self.eMallas = [];
                    self.eNivelesMalla = [];
                    self.eParalelos = [];
                    self.selectedValueMallaID = '';
                    self.selectedValueNivelMallaID = '';
                    self.selectedValueParaleloID = '';
                    self.eMaterias = [];
                    self.eMateria = {};
                    self.conflicto = 0;
                    self.eAulas = [];
                    self.eResponsables = [];
                    self.eHorarioDetalle = {};
                    self.eMateriaConflicto = {};
                    self.eHorarioDetalleConflictoAula = [];
                    self.eHorarioDetalleConflictoProfesor = [];
                },
                closeModalHorarioExamen: function(){
                    var self = this;
                    self.$modalHorarioExamen.modal('hide');
                    self.eMateria = {};
                    self.eHorarioDetalle = {};
                    self.eResponsables = [];
                },
                closeModalHorarioExamenConflicto: function(){
                    var self = this;
                    self.$modalHorarioExamenConflicto.modal('hide');
                },
                closeCloneModalHorarioExamen: function(){
                    var self = this;
                    self.eMateria = {};
                    self.eHorarioDetalle = {};
                    self.eResponsables = [];
                    self.$modalCloneHorarioExamen.modal('hide');
                },
                onChangeTipoResponsable: async function(aData, tiporesponsable){
                    var self = this;
                    self.loading();
                    //$('#id_responsable').val(null).trigger('change');
                    //$("#id_responsable").html('').append('<option selected="selected" value="">---------</option>');
                    await loadAjax({
                        'action': 'loadListResponsableHorarioExamen',
                        'tiporesponsable': tiporesponsable,
                        'idm': aData.id,
                    }, '/inno/api')
                        .then(response => {
                            if (response.value.result == 'ok') {
                                //$('#id_responsable').val(null).trigger('change');
                                self.eResponsables = response.value.aData.eResponsables;
                                //$("#id_responsable").html('').append('<option selected="selected" value="">---------</option>');
                                $.unblockUI();
                            } else {
                                $.unblockUI();
                                self.eResponsables = [];
                                //$('#id_responsable').val(null).trigger('change');
                                //$("#id_responsable").html('').append('<option selected="selected" value="">---------</option>');
                                NotificationJG.error(response.value.mensaje);
                            }
                        })
                        .catch(error => {
                            $.unblockUI();
                            self.eResponsables = [];
                            $('#id_responsable').val(null).trigger('change');
                            NotificationJG.error(error.message);
                        });
                },
                onChangeAula: async function(){
                    var self = this;
                    self.loading();
                    await loadAjax({
                        'action': 'loadListAulas'
                    }, '/inno/api')
                        .then(response => {
                            if (response.value.result == 'ok') {
                                //console.log(response.value);
                                self.eAulas = response.value.aData.eAulas;
                                $.unblockUI();
                            } else {
                                $.unblockUI();
                                self.eAulas = [];
                                NotificationJG.error(response.value.mensaje);
                            }
                        })
                        .catch(error => {
                            $.unblockUI();
                            self.eAulas = [];
                            NotificationJG.error(error.message);
                        });
                },
                openModalConfiguracionHorario: function (aData){
                    var self = this;
                    self.eCoordinacion = aData.eCoordinacion;
                    self.eSesion = aData.eSesion;
                    self.eMallas = aData.eMallas;
                    self.eMalla = aData.eMalla;
                    self.selectedValueMallaID = self.eMalla.id;
                    self.eNivelesMalla = aData.eNivelesMalla;
                    self.eNivelMalla = aData.eNivelMalla;
                    self.selectedValueNivelMallaID= self.eNivelMalla.id;
                    self.eParalelos = aData.eParalelos;
                    self.eParalelo = aData.eParalelo;
                    self.selectedValueParaleloID= self.eParalelo.id;
                    self.eMaterias= aData.eMaterias;
                    self.conflicto= aData.conflicto;
                    self.$modalConfiguracionHorario.modal({backdrop:'static', width: '98%', height: $(window).height()-150}).modal('show');
                },
                openModalHorarioExamen: async function (aData, eHorario/*=undefined*/){
                    var self = this;
                    let tiporesponsable = 0;

                    self.loading();
                    //console.log(aData);
                    if (typeof eHorario == 'undefined') {
                        self.eHorarioDetalle = {};
                        var fecha = new Date();
                        var fec = fecha.getFullYear() + '-' + (fecha.getMonth() + 1) + '-' + fecha.getDate();
                        $("#id_fecha_examen").val(fec);
                        $("#id_fecha_examen").removeAttr('disabled');
                        $('#id_hora_comienza').val(`${fecha.getUTCHours()}:${fecha.getUTCMinutes()}`);
                        $('#id_hora_termina').val(`${fecha.getUTCHours()}:${fecha.getUTCMinutes()}`);
                        $('#id_cantidad_alumno').val(aData.matriculados);
                        $("#id_tiporesponsable").val(0);
                        $('#id_aula').val(aData.aulaprincipal.id);
                        await self.onChangeTipoResponsable(aData, tiporesponsable);
                        await self.onChangeAula();
                        $('#id_responsable').val(null).trigger('change');
                        $("#id_responsable").html('').append('<option selected="selected" value="">---------</option>');
                        self.valueValidaHorario = true;
                    }else{
                        self.eHorarioDetalle = eHorario;
                        //$('#id_responsable').val(null).trigger('change');
                        $("#id_responsable").html('').append('<option selected="selected" value="">---------</option>');
                        $('#id_tiporesponsable').val(eHorario.tiporesponsable);
                        await self.onChangeTipoResponsable(aData, eHorario.tiporesponsable);
                        await self.onChangeAula();
                        $("#id_fecha_examen").val(eHorario.horarioexamen.fecha);
                        $("#id_fecha_examen").attr('disabled','disabled');
                        $('#id_hora_comienza').val(eHorario.horainicio);
                        $('#id_hora_termina').val(eHorario.horafin);


                        $('#id_aula').val(eHorario.aula ? eHorario.aula.id:'');
                        $('#id_cantidad_alumno').val(eHorario.cantalumnos);
                        console.log(eHorario)
                        $('#id_responsable').val(eHorario.responsable.id);
                        self.valueValidaHorario = eHorario.validahorario;
                        $("#id_detallemodelo option[value="+eHorario.horarioexamen.detallemodelo.id+"]").attr('selected', 'selected').trigger('change');
                        $('#id_detallemodelo').val(eHorario.horarioexamen.detallemodelo.id);
                    }
                    self.eMateria = aData;

                    self.$modalHorarioExamen.modal({backdrop:'static', width: '85%'}).modal('show');
                    $("#id_fecha_examen").datepicker({format:"yyyy-mm-dd"}).on('changeDate', function(ev){ $(this).datepicker('hide'); });
                    $("#id_hora_comienza, #id_hora_termina").timepicker({
                        minuteStep: 1,
                        appendWidgetTo: 'body',
                        showSeconds: false,
                        showMeridian: false,
                        defaultTime: true
                    });
                    $("#id_aula", self.$modalHorarioExamen).select2({minimumResultsForSearch: 20, width: '100%', dropdownParent: self.$modalHorarioExamen});
                    $("#id_responsable", self.$modalHorarioExamen).select2({minimumResultsForSearch: 20, width: '100%', dropdownParent: self.$modalHorarioExamen});
                    $.unblockUI();
                },
                onChangeSeacrh: function (event){
                    var self = this;
                    console.log(event);
                    console.log(self);
                    self.actionEventLoad(self.eCoordinacion.id, self.eSesion.id, self.selectedValueMallaID, self.selectedValueNivelMallaID, self.selectedValueParaleloID);
                },
                saveHorarioExamen: function (){
                    var self = this;
                    self.loading();
                    const aData = {
                        'idhed': self.eHorarioDetalle ? self.eHorarioDetalle.id : '',
                        'idm': self.eMateria.id,
                        'iddm': $("#id_detallemodelo").val(),
                        'fecha': $("#id_fecha_examen").val(),
                        'h_comienza': $("#id_hora_comienza").val(),
                        'h_termina': $("#id_hora_termina").val(),
                        'cantidad': $("#id_cantidad_alumno").val(),
                        'ida': $("#id_aula").val(),
                        'idr': $("#id_responsable").val(),
                        'tiporesponsable': $("#id_tiporesponsable").val(),
                        'validahorario': self.valueValidaHorario ? 1 : 0,
                        'action': 'saveHorarioExamen'
                    }
                    loadAjax(aData, '/adm_horarios/examenes')
                        .then(response => {
                            if (response.value.result == 'ok') {
                                NotificationJG.success(response.value.mensaje);
                                self.closeModalHorarioExamen();
                                self.actionEventLoad(self.eCoordinacion.id, self.eSesion.id, self.eMalla.id, self.eNivelMalla.id, self.eParalelo.id);
                                //$.unblockUI();
                            } else {
                                $.unblockUI();
                                NotificationJG.error(response.value.mensaje);
                            }
                        })
                        .catch(error => {
                            $.unblockUI();
                            NotificationJG.error(error.message);
                        });
                },
                deleteHorarioExamen: function (eMateria, eHorario){
                    var self = this;
                    Swal.fire({
                        title: `NOTIFICACIÓN`,
                        text: `{% if persona.sexo.id == 1 %}Estimada{% else %}Estimado{% endif %} {{ persona }}, Esta {% if persona.sexo.id == 1 %}segura{% else %}seguro{% endif %} de eliminar el horario ${eHorario.horarioexamen.detallemodelo.nombre} del aula ${eHorario.aula?eHorario.aula.display:'Sin Aula'} de la fecha ${eHorario.horarioexamen.fecha} ${eHorario.horainicio} ${eHorario.horafin} de la materia ${eMateria.display}`,
                        type: 'warning',
                        icon: 'warning',
                        showCancelButton: true,
                        allowOutsideClick: false,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Aceptar',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.value) {
                            self.loading();
                            const aData = {
                                'id': eHorario.id,
                                'action': 'deleteHorarioExamen'
                            }
                            loadAjax(aData, '/adm_horarios/examenes')
                                .then(response => {
                                    if (response.value.result == 'ok') {
                                        self.eHorarioDetalle = {};
                                        self.eMateria = {};
                                        NotificationJG.success(response.value.mensaje);
                                        self.actionEventLoad(self.eCoordinacion.id, self.eSesion.id, self.eMalla.id, self.eNivelMalla.id, self.eParalelo.id);
                                    } else {
                                        $.unblockUI();
                                        NotificationJG.error(response.value.mensaje);
                                    }
                                })
                                .catch(error => {
                                    $.unblockUI();
                                    NotificationJG.error(error.message);
                                });
                        }
                    }).catch(error => {
                        NotificationJG.error(error.message);
                    });

                },
                openCloneHorarioExamen: function (eMateria, eHorario){
                    var self = this;
                    self.eMateria = eMateria;
                    $("#id_clone_examen").val(eHorario.id);
                    /*let configuracionexamen = eMateria.configuracionexamen;
                    const detallemodelo_id = horario_examen.horarioexamen.detallemodelo.id;*/
                    self.$modalCloneHorarioExamen.modal({backdrop:'static', width: '20%'}).modal('show');
                    $("#id_fecha_clone").datepicker({format:"yyyy-mm-dd"}).on('changeDate', function(ev){ $(this).datepicker('hide'); });
                },
                openModalHorarioExamenConflicto:function (eMateriaConflicto, eHorarioDetalleConflictoAula, eHorarioDetalleConflictoProfesor) {
                    var self = this;
                    self.eMateriaConflicto = eMateriaConflicto;
                    self.eHorarioDetalleConflictoAula = eHorarioDetalleConflictoAula;
                    self.eHorarioDetalleConflictoProfesor = eHorarioDetalleConflictoProfesor;
                    self.$modalHorarioExamenConflicto.modal({backdrop:'static', width: '85%'}).modal('show');
                },
                cloneModalHorarioExamen: function (){
                    var self = this;
                    const id_clone_examen = $("#id_clone_examen").val();
                    const fecha_clone = $("#id_fecha_clone").val();
                    const id_detallemodelo_clone = $("#id_detallemodelo_clone").val();
                    if (id_fecha_clone == ''){
                        NotificationJG.error('Ingrese una fecha por favor');
                        return;
                    }
                    self.loading();
                    const aData = {
                        'id': id_clone_examen,
                        'iddm': id_detallemodelo_clone,
                        'fecha': fecha_clone,
                        'action': 'cloneHorarioExamen'
                    }
                    loadAjax(aData, '/adm_horarios/examenes')
                        .then(response => {
                            if (response.value.result == 'ok') {
                                NotificationJG.success(response.value.mensaje);
                                self.closeCloneModalHorarioExamen();
                                self.actionEventLoad(self.eCoordinacion.id, self.eSesion.id, self.eMalla.id, self.eNivelMalla.id, self.eParalelo.id);
                                //$.unblockUI();
                            } else {
                                $.unblockUI();
                                NotificationJG.error(response.value.mensaje);
                            }
                        })
                        .catch(error => {
                            $.unblockUI();
                            NotificationJG.error(error.message);
                        });
                }
            }
        })
    </script>
    <style>
        .tr-red {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
    </style>
{% endblock %}