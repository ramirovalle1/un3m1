{% extends "ajaxformbs.html" %}
{% load sga_extras %}
{% block extraheading %}
    <script>
        $(function () {
            $("#id_nombre").addClass("validate[required]");
            $("#id_conceptualizacion").addClass("validate[required]");
            $("#id_descripcion").addClass("validate[required]");

            $("#cerrar_efecto").click(function () {
                $('#itempanelefecto').modal('hide');
            });
            $(".reqistrar_efecto").click(function () {
                $("#itempanelefecto").modal({backdrop: 'static', width: '450px'}).modal('show');

            });
            $("#guardar_efecto").click(function () {
                var descripcion = $("#descripcionefecto").val();
                $.ajax({
                    type: "POST",
                    url: "/inv_modulo",
                    data: {'action': 'registrarefecto', 'descripcion': descripcion},
                    success: function (data) {
                        if (data.result == 'ok') {
                            $('#itempanelefecto').modal('hide');
                            $("#descripcionefecto").val('');

                            smoke.alert(data.mensaje);
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        smoke.alert('error de solicitud');
                    },
                    dataType: "json"
                });
            });

            $("#cerrar_causa").click(function () {
                $('#itempanelcausa').modal('hide');
            });
            $(".reqistrar_causa").click(function () {
                $("#itempanelcausa").modal({backdrop: 'static', width: '450px'}).modal('show');

            });
            $("#guardar_causa").click(function () {
                var descripcion = $("#descripcioncausa").val();
                $.ajax({
                    type: "POST",
                    url: "/inv_modulo",
                    data: {'action': 'registrarcausa', 'descripcion': descripcion},
                    success: function (data) {
                        if (data.result == 'ok') {
                            $('#itempanelcausa').modal('hide');
                            $("#descripcioncausa").val('');

                            smoke.alert(data.mensaje);
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        smoke.alert('error de solicitud');
                    },
                    dataType: "json"
                });
            });
        });
    </script>
    <script type="text/javascript">

        $(function () {
            ItemsDisplay = function (item) {
                if (item.name) {
                    return $('<span>' + item.name + '</span>');
                } else {
                    return '---------';
                }
            };
            $("#id_causas_select2").select2({
                placeholder: "---------",
                allowClear: true,
                ajax: {
                    url: function (params) {
                        return "{{ rutainv }}?action=busquedacausascampoaccion&q=" + params.term;
                    },
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term,
                            page: params.page
                        };
                    },
                    processResults: function (data, params) {
                        params.page = params.page || 1;
                        return {
                            results: data.results,
                            pagination: {
                                more: (params.page * 30) < data.total_count
                            }
                        };
                    },
                    cache: true
                },
                escapeMarkup: function (markup) {
                    return markup;
                }, // let our custom formatter work
                minimumInputLength: 1,
                templateResult: ItemsDisplay, // omitted for brevity, see the source of this page
                templateSelection: ItemsDisplay // omitted for brevity, see the source of this page
            }).on("select2:select", function (evt) {
                $("#id_causas").attr({"value": (evt.params.data.id)});
            });
            $("#id_efecto_select2").select2({
                placeholder: "---------",
                allowClear: true,
                ajax: {
                    url: function (params) {
                        return "{{ rutainv }}?action=busquedaefectoscampoaccion&q=" + params.term;
                    },
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term,
                            page: params.page
                        };
                    },
                    processResults: function (data, params) {
                        params.page = params.page || 1;
                        return {
                            results: data.results,
                            pagination: {
                                more: (params.page * 30) < data.total_count
                            }
                        };
                    },
                    cache: true
                },
                escapeMarkup: function (markup) {
                    return markup;
                }, // let our custom formatter work
                minimumInputLength: 1,
                templateResult: ItemsDisplay, // omitted for brevity, see the source of this page
                templateSelection: ItemsDisplay // omitted for brevity, see the source of this page
            }).on("select2:select", function (evt) {
                $("#id_efectos").attr({"value": (evt.params.data.id)});
            });
        });

        $(function () {
            ItemsDisplay = function (item) {
                if (item.name) {
                    return $('<span>' + item.name + '</span>');
                } else {
                    return '---------';
                }
            };
            $("#id_causasedit_select2").select2({
                placeholder: "---------",
                allowClear: true,
                ajax: {
                    url: function (params) {
                        return "{{ rutainv }}?action=busquedacausascampoaccion&q=" + params.term;
                    },
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term,
                            page: params.page
                        };
                    },
                    processResults: function (data, params) {
                        params.page = params.page || 1;
                        return {
                            results: data.results,
                            pagination: {
                                more: (params.page * 30) < data.total_count
                            }
                        };
                    },
                    cache: true
                },
                escapeMarkup: function (markup) {
                    return markup;
                }, // let our custom formatter work
                minimumInputLength: 1,
                templateResult: ItemsDisplay, // omitted for brevity, see the source of this page
                templateSelection: ItemsDisplay // omitted for brevity, see the source of this page
            }).on("select2:select", function (evt) {
                $("#id_causasedit").attr({"value": (evt.params.data.id)});
            });
            $("#id_efectoedit_select2").select2({
                placeholder: "---------",
                allowClear: true,
                ajax: {
                    url: function (params) {
                        return "{{ rutainv }}?action=busquedaefectoscampoaccion&q=" + params.term;
                    },
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term,
                            page: params.page
                        };
                    },
                    processResults: function (data, params) {
                        params.page = params.page || 1;
                        return {
                            results: data.results,
                            pagination: {
                                more: (params.page * 30) < data.total_count
                            }
                        };
                    },
                    cache: true
                },
                escapeMarkup: function (markup) {
                    return markup;
                }, // let our custom formatter work
                minimumInputLength: 1,
                templateResult: ItemsDisplay, // omitted for brevity, see the source of this page
                templateSelection: ItemsDisplay // omitted for brevity, see the source of this page
            }).on("select2:select", function (evt) {
                $("#id_efectosedit").attr({"value": (evt.params.data.id)});
            });
        });

        $(function () {
            /*****PROBLEMAS*****/
            $("#adicionarproblema").click(function () {
                $("#id_problema").val('');
                $("#alertaingresproblema").hide();
                $("#itemspanelproblema .incompletoproblema").hide();
                $("#adicionarycerrarproblema").show();
                $("#guardar").hide();
                $("#itemspanelproblema").modal({backdrop: 'static', width: '450px'}).modal('show');
                return false;
            });
            editarproblema = function (codigoproblema) {
                var numorden = 0
                $.ajax({
                    type: "POST",
                    url: '{{ rutainv }}',
                    data: {'action': 'consultarproblemacampoaccion', 'id': codigoproblema},
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error al obtener los datos.");
                    },
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == "ok") {
                            $("#id_problemaedit").val(data.nombre);
                            tooltips();
                            {#                            conectar_controleslib();#}
                        } else {
                            smoke.alert(data.mensaje);
                            $("#id_ordenproblemaedit").val(0)
                            $("#id_problemaedit").val('');
                        }
                    }
                });

                $("#idresuledit").val('');
                $("#idresuledit").val(codigoproblema);
                $("#alertaingresproblemaedit").hide();
                $("#itemspanelproblemaedit .incompletoproblemaedit").hide();
                $("#itemspanelproblemaedit .incompletovaloresproblemaedit").hide();
                $("#adicionarycerrarproblemaedit").show();
                $("#guardar").hide();
                $("#itemspanelproblemaedit").modal({backdrop: 'static', width: '400px'}).modal('show');
                return false;
            }
            $("#adicionarycerrarproblema").click(function () {
                adicionar_problema()
            });
            $("#adicionarycerrarproblemaedit").click(function () {
                editar_problema()
            });
            $("#cerrarproblema").click(function () {
                $("#itemspanelproblema .incompletoproblema").hide();
                $("#itemspanelproblema .incompletovaloresproblema").hide();
                $("#itemspanelproblema").modal("hide");
            });
            $("#cerrarproblemaedit").click(function () {
                $("#itemspanelproblemaedit .incompletoproblemaedit").hide();
                $("#itemspanelproblemaedit .incompletovaloresproblemaedit").hide();
                $("#itemspanelproblemaedit").modal("hide");
            });
            adicionar_problema = function (ocultar) {
                var descripcion = $("#id_problema").val();
                if (descripcion == '') {
                    $("#itemspanelproblema .incompletoproblema").show();
                    return false;
                }
                $("#itemspanelproblema").modal("hide");
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "{{ rutainv }}",
                    data: {
                        'action': 'addproblemacampoaccion',
                        'descripcion': descripcion,
                        'cabid': '{{ area.id|encrypt }}',
                    },
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error al obtener los datos.");
                    },
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == "ok") {
                            $("#idcabecera").append('<li id="codproblema' + data.idproblema + '" class="parent_li">' +
                                '<a href="javascript:;" class="btn btn-tini btn-info editproblema tu" id="editproblema' + data.idproblema + '" onclick="editarproblema(' + data.idproblema + ')"  title="Editar Problema"><i class="fa fa-edit"></i></a>-&nbsp;' +
                                '<a href="javascript:;" id="adicionarcausa' + data.idproblema + '" onclick="causas(' + data.idproblema + ')" class="btn btn-success btn-tini tu" title="Adicionar Causas"><i class="fa fa-plus"></i></a>- ' +
                                '<a href="javascript:;" class="btn btn-tini btn-danger delproblema tu" iddelproblema="' + data.idproblema + '"  title="Eliminar Problema"><i class="fa fa-remove"></i></a>- ' +
                                '<span><i class="fa fa-comment-o fa fa-minus-sign"></i> <a id="nomproblema' + data.idproblema + '"> Problema: ' + data.descripcion + ' </a></span> </li>');
                            tooltips();
                            conectar_controlesproblema();
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    }
                });
            };
            editar_problema = function (ocultar) {
                var idproblema = $("#idresuledit").val();
                var descripcion = $("#id_problemaedit").val();
                if (descripcion == '') {
                    $("#itemspanelproblemaedit .incompletoproblemaedit").show();
                    return false;
                }
                $("#itemspanelproblemaedit").modal("hide");
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "{{ rutainv }}",
                    data: {
                        'action': 'editproblemacampoaccion',
                        'descripcion': descripcion,
                        'idproblema': idproblema
                    },
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error al obtener los datos.");
                    },
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == "ok") {
                            $("#nomproblema" + idproblema).html(' Problema : ' + data.descripcion)
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    }
                });
            };
            conectar_controlesproblema = function () {
                $(".delproblema").unbind();
                $(".delproblema").click(function () {
                    $('#selectdeleteproblema').modal({'width': 800}).modal('show');
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "{{ rutainv }}",
                        data: {'action': 'listaproblemacampoaccion', 'id': $(this).attr('iddelproblema')},
                        error: function () {
                            $.unblockUI();
                            smoke.alert("Error al obtener los datos.");
                        },
                        success: function (data) {
                            $.unblockUI();
                            if (data.result == "ok") {
                                $('#leyendaproblema').html(data.descripcion);
                                $('#codigoproblema').val(data.codigoproblema);
                                $('#selectdeleteproblema').modal({'width': 800}).modal('show');
                            } else {
                                smoke.alert(data.mensaje);
                            }
                        }
                    });
                });
            };
            $(".delproblema").click(function () {
                $('#selectdeleteproblema').modal({'width': 800}).modal('show');
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "{{ rutainv }}",
                    data: {'action': 'listaproblemacampoaccion', 'id': $(this).attr('iddelproblema')},
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error al obtener los datos.");
                    },
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == "ok") {
                            $('#leyendaproblema').html(data.descripcion)
                            $('#codigoproblema').val(data.codigoproblema)
                            $('#selectdeleteproblema').modal({'width': 800}).modal('show');
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    }
                });
            });
            $("#eliminacionmodal_cancelproblema").click(function () {
                $('#selectdeleteproblema').modal('hide');
            });
            $("#eliminacionmodal_formbuttonproblema").click(function () {
                $('#selectdeleteproblema').modal('hide');
                var filaproblema = ''
                filaproblema = 'codproblema' + $('#codigoproblema').val()
                $.ajax({
                    type: "POST",
                    url: "{{ rutainv }}",
                    data: {
                        'action': 'eliminarproblemacampoaccion',
                        'codigoproblema': $('#codigoproblema').val()
                    },
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error al obtener los datos.");
                    },
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == "ok") {
                            $('#' + filaproblema).remove();
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    }
                });
            });

            /*****CAUSAS*****/
            causas = function (codigoproblema) {
                $("#id_causa").val('');
                $("#id_causa_select2").val('');
                $("#idpro").val(codigoproblema);
                $("#alertaingrescausa").hide();
                $("#itemspanelcausa .incompletocausa").hide();
                $("#itemspanelcausa .incompletovalorescausa").hide();
                $("#adicionarycerrarcausa").show();
                $("#guardar").hide();
                $("#itemspanelcausa").modal({backdrop: 'static', width: '450px'}).modal('show');
                return false;
            }
            editcausa = function (codigoproblema) {
                $.ajax({
                    type: "POST",
                    url: "{{ rutainv }}",
                    data: {'action': 'consultarcausacampoaccion', 'id': codigoproblema},
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error al obtener los datos.");
                    },
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == "ok") {
                            $("#causaanterior").val(data.nombre);
                            $("#idcausedit").val(data.idcausa);
                            tooltips();
                        } else {
                            $("#id_causasedit_select2").val('');
                            smoke.alert(data.mensaje);
                        }
                    }
                });
                $("#idproedit").val('');
                $("#idproedit").val(codigoproblema);
                $("#alertaingrescausaedit").hide();
                $("#itemspanelcausaedit .incompletocausaedit").hide();
                $("#itemspanelcausaedit .incompletovalorescausaedit").hide();
                $("#adicionarycerrarcausaedit").show();
                $("#guardar").hide();
                $("#itemspanelcausaedit").modal({backdrop: 'static', width: '600px'}).modal('show');
                return false;
            };
            $("#adicionarycerrarcausa").click(function () {
                adicionar_causa()
            });
            $("#adicionarycerrarcausaedit").click(function () {
                editar_causa()
            });
            $("#cerrarcausa").click(function () {
                $("#itemspanelcausa .incompletocausa").hide();
                $("#itemspanelcausa .incompletovalocausa").hide();
                $("#itemspanelcausa").modal("hide");
            });
            $("#cerrarcausaedit").click(function () {
                $("#itemspanelcausaedit .incompletocausaedit").hide();
                $("#itemspanelcausaedit .incompletovalocausaedit").hide();
                $("#itemspanelcausaedit").modal("hide");
            });
            adicionar_causa = function (ocultar) {
                var idpro = $("#idpro").val();
                var descripcion = $("#id_causas_select2").val();
                if (descripcion == null) {
                    $("#itemspanelcausa .incompletocausa").show();
                    return false;
                }
                $("#itemspanelcausa").modal("hide");
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "{{ rutainv }}",
                    data: {
                        'action': 'addcausacampoaccion',
                        'descripcion': descripcion,
                        'idpro': idpro
                    },
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error al obtener los datos.");
                    },
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == "ok") {
                            if (($("#idcausa" + idpro).length) > 0) {
                                $("#idcausa" + idpro).append('<li class="parent_li" id="codcausa' + data.idcausa + '">' +
                                    '<a href="javascript:;" class="btn btn-tini btn-info editarcausa tu" onclick="editcausa(' + data.idcausa + ')"  title="Editar Causa"><i class="fa fa-edit"></i></a>- ' +
                                    '<a href="javascript:;" id="adicionarefecto' + data.idcausa + '" onclick="efecto(' + data.idcausa + ')" class="btn btn-success btn-tini tu" title="Adicionar Efecto"><i class="fa fa-plus"></i></a>- ' +
                                    '<a href="javascript:;" class="btn btn-tini btn-danger delcausa tu" iddelcaus="' + data.idcausa + '" title="Eliminar Causa"><i class="fa fa-remove"></i></a>- ' +
                                    '<span title="Contraer"><i class="fa fa-minus-sign"></i> <i id="nomcausa' + data.idcausa + '">Causa : ' + data.descripcion + '</i> </span> ' +
                                    '<ul id="idefecto' + data.idcausa + '"></ul>' +
                                    '</li>');
                            } else {
                                $("#codproblema" + idpro).append('<ul id="idcausa' + idpro + '">' +
                                    '<li class="parent_li" id="codcausa' + data.idcausa + '">' +
                                    '<a href="javascript:;" class="btn btn-tini btn-info editarcausa tu" onclick="editcausa(' + data.idcausa + ')"  title="Editar Causa"><i class="fa fa-edit"></i></a>- ' +
                                    '<a href="javascript:;" id="adicionarefecto' + data.idcausa + '" onclick="efecto(' + data.idcausa + ')" class="btn btn-success btn-tini tu" title="Adicionar Tema"><i class="fa fa-plus"></i></a>-' +
                                    '<a href="javascript:;" class="btn btn-tini btn-danger delcausa tu" iddelcaus="' + data.idcausa + '" title="Eliminar Causa"><i class="fa fa-remove"></i></a>- ' +
                                    '<span title="Contraer"><i class="fa fa-minus-sign"></i> <i id="nomcausa' + data.idcausa + '"> Causa : ' + data.descripcion + '</i></span>' +
                                    '<ul id="idefecto' + data.idcausa + '"></ul>' +
                                    '</li>' +
                                    '</ul>');

                            }
                            tooltips();
                            conectar_controlesunidad();
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    }
                });
            };
            conectar_controlesunidad = function () {
                $(".delcausa").unbind();
                $(".delcausa").click(function () {
                    $('#selectdeleteunidad').modal({'width': 800}).modal('show');
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "{{ rutainv }}",
                        data: {'action': 'listacausacampoaccion', 'id': $(this).attr('iddelcaus')},
                        error: function () {
                            $.unblockUI();
                            smoke.alert("Error al obtener los datos.");
                        },
                        success: function (data) {
                            $.unblockUI();
                            if (data.result == "ok") {
                                $('#leyendacausa').html(data.descripcion)
                                $('#codigocausa').val(data.codigocausa)
                                $('#selectdeletecausa').modal({'width': 800}).modal('show');
                            } else {
                                smoke.alert(data.mensaje);
                            }
                        }
                    });
                });
            };
            editar_causa = function (ocultar) {
                idpro = $("#idcausedit").val();
                var descripcion = $("#id_causasedit_select2").val();
                var idcausedit = $("#idcausedit").val();
                if (descripcion == null) {
                    $("#itemspanelcausaedit .incompletocausaedit").show();
                    return false;
                }
                $("#itemspanelcausaedit").modal("hide");
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "{{ rutainv }}",
                    data: {
                        'action': 'editcausacampoaccion',
                        'descripcion': descripcion,
                        'idcausedit': idcausedit
                    },
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error al obtener los datos.");
                    },
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == "ok") {
                            $("#nomcausa" + idpro).html(' CAUSA: ' + descripcion);
                            location.reload();
                            tooltips();
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    }
                });
            };
            $(".delcausa").click(function () {
                $('#selectdeletecausa').modal({'width': 800}).modal('show');
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "{{ rutainv }}",
                    data: {'action': 'listacausacampoaccion', 'id': $(this).attr('iddelcaus')},
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error al obtener los datos.");
                    },
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == "ok") {
                            $('#leyendacausa').html(data.descripcion)
                            $('#codigocausa').val(data.codigocausa)
                            $('#selectdeletecausa').modal({'width': 800}).modal('show');
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    }
                });
            });
            $("#eliminacionmodal_cancelcausa").click(function () {
                $('#selectdeletecausa').modal('hide');
            });
            $("#eliminacionmodal_formbuttoncausa").click(function () {
                $('#selectdeletecausa').modal('hide');
                var filacausa = ''
                filacausa = 'codcausa' + $('#codigocausa').val()
                $.ajax({
                    type: "POST",
                    url: "{{ rutainv }}",
                    data: {
                        'action': 'eliminarcausacampoaccion',
                        'codigocausa': $('#codigocausa').val()
                    },
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error al obtener los datos.");
                    },
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == "ok") {
                            $('#' + filacausa).remove();
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    }
                });
            });

            /*****EFECTO*****/
            efecto = function (codigoefecto) {
                $("#id_efecto_select2").val('');
                $("#id_efecto").val('');
                $("#idcaus").val('');
                $("#idcaus").val(codigoefecto);
                $("#alertaingresefecto").hide();
                $("#itemspanelefecto .incompletoefecto").hide();
                $("#itemspanelefecto .incompletovaloresefecto").hide();
                $("#adicionarycerrarefecto").show();
                $("#guardar").hide();
                $("#itemspanelefecto").modal({backdrop: 'static', width: '450px'}).modal('show');
                return false;
            }
            editefecto = function (codigoefecto) {
                $.ajax({
                    type: "POST",
                    url: "{{ rutainv }}",
                    data: {'action': 'consultarefectocampoaccion', 'id': codigoefecto},
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error al obtener los datos.");
                    },
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == "ok") {
                            $("#efectoanterior").val(data.nombre);
                            $("#idefectedit").val(data.idefecto);
                            tooltips();
                        } else {
                            $("#id_efectoedit_select2").val('');
                            smoke.alert(data.mensaje);
                        }
                    }
                });
                $("#idefectedit").val('');
                $("#idefectedit").val(codigoefecto);
                $("#alertaingresefectoedit").hide();
                $("#itemspanelefectoedit .incompletoefectoedit").hide();
                $("#itemspanelefectoedit .incompletovaloresefectoedit").hide();
                $("#adicionarycerrarefectoedit").show();
                $("#guardar").hide();
                $("#itemspanelefectoedit").modal({backdrop: 'static', width: '400px'}).modal('show');
                return false;
            }
            $("#adicionarycerrarefecto").click(function () {
                adicionar_efecto()
            });
            $("#adicionarycerrarefectoedit").click(function () {
                editar_efecto()
            });
            $("#cerrarefecto").click(function () {
                $("#itemspanelefecto .incompletoefecto").hide();
                $("#itemspanelefecto .incompletovaloefecto").hide();
                $("#itemspanelefecto").modal("hide");
            });
            $("#cerrarefectoedit").click(function () {
                $("#itemspanelefectoedit .incompletoefectoedit").hide();
                $("#itemspanelefectoedit .incompletovaloefectoedit").hide();
                $("#itemspanelefectoedit").modal("hide");
            });
            adicionar_efecto = function (ocultar) {
                var idcaus = $("#idcaus").val();
                var descripcion = $("#id_efecto_select2").val();
                if (descripcion == null) {
                    $("#itemspanelefecto .incompletoefecto").show();
                    return false;
                }
                $("#itemspanelefecto").modal("hide");
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "{{ rutainv }}",
                    data: {
                        'action': 'addefectocampoaccion',
                        'descripcion': descripcion,
                        'idcaus': idcaus
                    },
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error al obtener los datos.");
                    },
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == "ok") {
                            if (($("#idefecto" + idcaus).length) > 0) {
                                $("#idefecto" + idcaus).append('<li id="codefecto' + data.idefecto + '" class="parent_li">' +
                                    '<a href="javascript:;" class="btn btn-tini btn-info editefecto tu" onclick="editefecto(' + data.idefecto + ')"  title="Editar Efecto"><i class="fa fa-edit"></i></a> ' +
                                    '<a href="javascript:;" class="btn btn-tini btn-danger delefecto tu" idt="' + data.idefecto + '" title="Eliminar Efecto"><i class="fa fa-remove"></i></a> ' +
                                    '<span title="Contraer"><i class="fa fa-minus-sign"></i><i id="nomefecto' + data.idefecto + '"> Efecto: ' + data.descripcion + '</i>' +
                                    '</span><ul id="idsubefecto' + data.idefecto + '"></ul></li>');
                            }
                            tooltips();
                            conectar_controlesefecto();
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    }
                });
            };
            editar_efecto = function (ocultar) {
                var idefectedit = $("#idefectedit").val();
                var descripcion = $("#id_efectoedit_select2").val();
                if (descripcion == null) {
                    $("#itemspanelefectoedit .incompletoefectoedit").show();
                    return false;
                }
                $("#itemspanelefectoedit").modal("hide");
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "{{ rutainv }}",
                    data: {
                        'action': 'editefectocampoaccion',
                        'descripcion': descripcion,
                        'idefectedit': idefectedit,
                    },
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error al obtener los datos.");
                    },
                    success: function (data) {
                        //$.unblockUI();
                        if (data.result == "ok") {
                            //bloqueointerface();
                            location.reload();
                            $("#nomefecto" + data.idefecto).html(' Efecto: ' + descripcion)
                            tooltips();
                            {#                            conectar_controlesefecto();#}
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    }
                });
            };
            conectar_controlesefecto = function () {
                $(".delefecto").unbind();
                $(".delefecto").click(function () {
                    $('#selectdeleteefecto').modal({'width': 800}).modal('show');
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "{{ rutainv }}",
                        data: {'action': 'listaefectocampoaccion', 'id': $(this).attr('idt')},
                        error: function () {
                            $.unblockUI();
                            smoke.alert("Error al obtener los datos.");
                        },
                        success: function (data) {
                            $.unblockUI();
                            if (data.result == "ok") {
                                $('#leyendaefecto').html(data.descripcion)
                                $('#codigoefecto').val(data.codigoefecto)
                                $('#selectdeleteefecto').modal({'width': 800}).modal('show');
                            } else {
                                smoke.alert(data.mensaje);
                            }
                        }
                    });
                });
            };
            $(".delefecto").click(function () {
                $('#selectdeleteefecto').modal({'width': 800}).modal('show');
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "{{ rutainv }}",
                    data: {'action': 'listaefectocampoaccion', 'id': $(this).attr('idt')},
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error al obtener los datos.");
                    },
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == "ok") {
                            $('#leyendaefecto').html(data.descripcion)
                            $('#codigoefecto').val(data.codigoefecto)
                            $('#selectdeleteefecto').modal({'width': 800}).modal('show');
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    }
                });
            });
            $("#eliminacionmodal_cancelefecto").click(function () {
                $('#selectdeleteefecto').modal('hide');
            });
            $("#eliminacionmodal_formbuttonefecto").click(function () {
                $('#selectdeleteefecto').modal('hide');
                var filaefecto = ''
                filaefecto = 'codefecto' + $('#codigoefecto').val()
                $.ajax({
                    type: "POST",
                    url: "{{ rutainv }}",
                    data: {
                        'action': 'eliminarefectocampoaccion',
                        'codigoefecto': $('#codigoefecto').val()
                    },
                    error: function () {
                        $.unblockUI();
                        smoke.alert("Error al obtener los datos.");
                    },
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == "ok") {
                            $('#' + filaefecto).remove();
                        } else {
                            smoke.alert(data.mensaje);
                        }
                    }
                });
            });


            $('.tree li:has(ul)').addClass('parent_li').find(' > span').attr('title', 'Contraer');
            $('.tree li.parent_li > span').on('click', function (e) {
                var children = $(this).parent('li.parent_li').find(' > ul > li');
                if (children.is(":visible")) {
                    children.hide('fast');
                    $(this).attr('title', 'Ampliar').find(' > i').addClass('fa fa-plus-sign').removeClass('fa fa-minus-sign');
                } else {
                    children.show('fast');
                    $(this).attr('title', 'Contraer').find(' > i').addClass('fa fa-minus-sign').removeClass('fa fa-plus-sign');
                }
                e.stopPropagation();
            });
        });

    </script>
    <style>
        .fa fa-folder-open {
            background-position: -408px -120px;
            width: 16px;
        }

        .well {
            min-height: 20px;
            padding: 19px;
            margin-bottom: 20px;
            background-color: #f5f5f5;
            border: 1px solid #e3e3e3;
            -webkit-border-radius: 4px;
            -moz-border-radius: 4px;
            border-radius: 4px;
            -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
            -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
        }

        .well blockquote {
            border-color: #ddd;
            border-color: rgba(0, 0, 0, 0.15);
        }

        .well-large {
            padding: 24px;
            -webkit-border-radius: 6px;
            -moz-border-radius: 6px;
            border-radius: 6px;
        }

        .well-small {
            padding: 9px;
            -webkit-border-radius: 3px;
            -moz-border-radius: 3px;
            border-radius: 3px;
        }

        .close {
            float: right;
            font-size: 20px;
            font-weight: bold;
            line-height: 20px;
            color: #000000;
            text-shadow: 0 1px 0 #ffffff;
            opacity: 0.2;
            filter: alpha(opacity=20);
        }

        .close:hover, .close:focus {
            color: #000000;
            text-decoration: none;
            cursor: pointer;
            opacity: 0.4;
            filter: alpha(opacity=40);
        }

        button.close {
            padding: 0;
            cursor: pointer;
            background: transparent;
            border: 0;
            -webkit-appearance: none;
        }

        .tree {
            min-height: 20px;
            padding: 19px;
            margin-bottom: 20px;
            background-color: #fbfbfb;
            border: 1px solid #999;
            -webkit-border-radius: 4px;
            -moz-border-radius: 4px;
            border-radius: 4px;
            -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
            -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05)
        }

        .tree li {
            list-style-type: none;
            margin: 0;
            padding: 10px 5px 0 5px;
            position: relative
        }

        .tree li::before, .tree li::after {
            content: '';
            left: -20px;
            position: absolute;
            right: auto
        }

        .tree li::before {
            border-left: 1px solid #999;
            bottom: 50px;
            height: 100%;
            top: 0;
            width: 1px
        }

        .tree li::after {
            border-top: 1px solid #999;
            height: 20px;
            top: 25px;
            width: 25px
        }

        .tree li span {
            -moz-border-radius: 5px;
            -webkit-border-radius: 5px;
            border: 1px solid #999;
            border-radius: 5px;
            display: inline-block;
            padding: 3px 8px;
            text-decoration: none
        }

        .tree li.parent_li > span {
            cursor: pointer
        }

        .tree > ul > li::before, .tree > ul > li::after {
            border: 0
        }

        .tree li:last-child::before {
            height: 30px
        }

        .tree li.parent_li > span:hover, .tree li.parent_li > span:hover + ul li span {
            background: #eee;
            border: 1px solid #94a0b4;
            color: #000
        }
    </style>
{% endblock %}
{% block atras %}{{ rutainv }}?action=campoaccion&cabcom={{ cabcom|encrypt }}{% endblock %}
{% block titulo %}{{ title }}{% endblock %}
{% block formaction %}{{ rutainv }}?cabcom={{ cabcom|encrypt }}{% endblock %}
{% block formdestination %}{{ rutainv }}?action=campoaccion&cabcom={{ cabcom|encrypt }}{% endblock %}
{% block formwidth %}form-xl{% endblock %}
{% block formextra %}
    <input type='hidden' name='action' value='editcampoaccion'/>
    <input type='hidden' name='id' value='{{ area.id|encrypt }}'/>
{% endblock %}
{% block formsuffix %}
    <div class="tree well">
        <div align="center"><strong>PROBLEMAS DEL CAMPO DE ACCIÓN</strong></div>
        <ul id="idcabecera">
            <a href="javascript:;" class="btn btn-success btn-mini tu" id="adicionarproblema"
               title='Adicionar Problema'> + Adicionar</a>
            {% for conte in contenido %}
                <li id="codproblema{{ conte.id }}">
                    <a href='javascript:;' class='btn btn-tini btn-info editproblema tu'
                       id="editproblema{{ conte.id }}"
                       onclick="editarproblema({{ conte.id }})" title='Editar Problema'>
                        <i class='fa fa-edit'></i>
                    </a>-
                    <a href="javascript:;" class="btn btn-success btn-tini tu" id="adicionarcausas{{ conte.id }}"
                       onclick="causas({{ conte.id }})" title='Adicionar Causas'><i class="fa fa-plus"></i>
                    </a>-
                    <a href='javascript:;' class='btn btn-tini btn-danger delproblema tu' iddelproblema="{{ conte.id }}"
                       title='Eliminar Problema'>
                        <i class='fa fa-remove'></i>
                    </a>-
                    <span><i class="fa fa-comment-o"></i><a
                            id="nomproblema{{ conte.id }}"> Problema: {{ conte.descripcion }}</a></span>

                    <ul id="idcausa{{ conte.id }}">
                        {% for caus in conte.causas %}
                            <li id="codcausa{{ caus.id }}">
                                <a href='javascript:;' class='btn btn-tini btn-info editarcausa tu'
                                   onclick="editcausa({{ caus.id }})" title='Editar Causa'>
                                    <i class='fa fa-edit'></i>
                                </a>-
                                <a href="javascript:;" id="adicionarcausa{{ caus.id }}" onclick="efecto({{ caus.id }})"
                                   class="btn btn-success btn-tini tu" title='Adicionar Efecto'><i
                                        class="fa fa-plus"></i>
                                </a>-
                                <a href='javascript:;' class='btn btn-tini btn-danger delcausa tu'
                                   iddelcaus="{{ caus.id }}" title='Eliminar Causa'>
                                    <i class='fa fa-remove'></i>
                                </a>-
                                <span><i class="fa fa-minus-sign"></i>
                                    <i id="nomcausa{{ caus.id }}"> Causa: {{ caus.causas.descripcion }}</i>
                                            </span>

                                <ul id="idefecto{{ caus.id }}">
                                    {% for efec in caus.efectos %}
                                        <li id="codefecto{{ efec.id }}" class="parent_li">
                                            <a href='javascript:;'
                                               class='btn btn-tini btn-info editefecto tu'
                                               onclick="editefecto({{ efec.id }})"
                                               title='Editar Efecto'><i class='fa fa-edit'></i></a>
                                            <a href='javascript:;'
                                               class='btn btn-tini btn-danger delefecto tu'
                                               idt="{{ efec.id }}" title='Eliminar Efecto'><i
                                                    class='fa fa-remove'></i></a>
                                            <span><i class="fa fa-minus-sign"></i> <i
                                                    id="nomefecto{{ efec.id }}"> Efecto: {{ efec.efecto.descripcion }}</i></span>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </li>
                        {% endfor %}

                    </ul>
                </li>
            {% endfor %}
        </ul>
    </div>
{% endblock %}
{% block formback %}{{ rutainv }}?action=campoaccion&cabcom={{ cabcom|encrypt }}{% endblock %}
{% block extraalerts %}

    <div class="modal fade static" id="itempanelefecto" style="display: none;">
        <div class="modal-header">
            <h3 class="paneltitle"><span class="fa fa-cogs"></span> Agregar Efecto </h3>
        </div>
        <div class="modal-body panelbody">
            <div class="row-fluid">
                <span id="horasalida">Descripción: </span><br>
                <textarea style="width: 100%; text-transform: none" id="descripcionefecto"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <table class="pull-right">
                <tr>
                    <td><a href="javascript:;" class="btn btn-generar btn-success guardar_efecto" id="guardar_efecto"><i
                            class="fa fa-plus"></i> Guadar</a></td>
                    <td><a href="javascript:;" class="btn btn-cerrar btn-info cerrar_efecto" id="cerrar_efecto"><i
                            class="fa fa-trash"></i> Cerrar</a></td>
                </tr>
            </table>
        </div>
    </div>
    <div class="modal fade static" id="itempanelcausa" style="display: none;">
        <div class="modal-header">
            <h3 class="paneltitle"><span class="fa fa-cogs"></span> Agregar Causa </h3>
        </div>
        <div class="modal-body panelbody">
            <div class="row-fluid">
                <span id="horasalida">Descripción: </span><br>
                <textarea style="width: 100%; text-transform: none" id="descripcioncausa"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <table class="pull-right">
                <tr>
                    <td><a href="javascript:;" class="btn btn-generar btn-success guardar_causa" id="guardar_causa"><i
                            class="fa fa-plus"></i> Guadar</a></td>
                    <td><a href="javascript:;" class="btn btn-cerrar btn-info cerrar_causa" id="cerrar_causa"><i
                            class="fa fa-trash"></i> Cerrar</a></td>
                </tr>
            </table>
        </div>
    </div>

    <!-- MODALES PROBLEMA -->
    <div class="modal fade static" id="itemspanelproblema" style="display: none;">
        <div class="modal-header">
            <h3 class="paneltitle">Adicionar Problemas</h3>
        </div>
        <div class="modal-body panelbody">
            <div class="alert alert-info incompletoproblema" style="display: none;">
                <i class="fa fa-info-sign"></i> Complete todos los campos para continuar
            </div>
            <div class="row-fluid">
                <form id="formulario2" class='form-vertical' action="" method="POST">
                    Descripción:
                    <textarea style="width: 100%; text-transform: none" name="problema" id="id_problema">I</textarea>
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn btn-success" id="adicionarycerrarproblema"><i class="fa fa-plus"></i>
                Guardar</a>
            <a href="javascript:;" class="btn btn-cerrar btn-info" id="cerrarproblema">Cerrar</a>
        </div>
    </div>
    <div class="modal fade static" id="itemspanelproblemaedit" style="display: none;">
        <div class="modal-header">
            <h3 class="paneltitle">Editar Problema</h3>
        </div>
        <div class="modal-body panelbody">
            <div class="alert alert-info incompletoproblemaedit" style="display: none;">
                <i class="fa fa-info-sign"></i> Complete todos los campos para continuar
            </div>
            <div class="row-fluid">
                <form id="formulario2" class='form-vertical' action="" method="POST">
                    Descripción:
                    <textarea style="width: 100%; text-transform: none" name="problemaedit"
                              id="id_problemaedit"></textarea>
                    <input type="hidden" name="resuledit" id="idresuledit">
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn btn-success" id="adicionarycerrarproblemaedit"><i class="fa fa-plus"></i>
                Guardar</a>
            <a href="javascript:;" class="btn btn-cerrar btn-info" id="cerrarproblemaedit">Cerrar</a>
        </div>
    </div>
    <div class="modal fade static" id="selectdeleteproblema" style="min-height: 60px">
        <div class="modal-header">
            <h4 id="paneltitle">Eliminar Problema</h4>
        </div>
        <div class="modal-body" id="selectdeletepar-body">
            <input type='hidden' id="codigoproblema" name="codigoproblema" value=""/>
            <p style="margin-top: 10px;">Esta seguro(a) que desea eliminar: <b id="leyendaproblema"></b></p>
        </div>
        <div class="modal-footer">
            <p style="text-align: right; margin-bottom: 0">
                <a href="javascript:;" id="eliminacionmodal_formbuttonproblema" class='btn btn-danger btn-form'>
                    Eliminar</a>
                <a href="javascript:;" id="eliminacionmodal_cancelproblema" class="btn btn-info"> Cerrar</a>
            </p>
        </div>
    </div>

    <!-- MODALES EFECTOS -->
    <div class="modal fade static" id="itemspanelefecto" style="display: none;">
        <div class="modal-header">
            <h3 class="paneltitle">Adicionar Efectos</h3>
            <a class="reqistrar_efecto tu btn btn-default" title="Agregar Efectos">
                <i class="fa fa-plus"></i></a>
        </div>
        <div class="modal-body panelbody">
            <div class="alert alert-info incompletoefecto" style="display: none;">
                <i class="fa fa-info-sign"></i> Complete todos los campos para continuar
            </div>
            <div class="row-fluid">
                <form id="formulario2" class='form-vertical' action="" method="POST">
                    Efectos:
                    <input type="hidden" name="caus" id="idcaus">
                    <select id="id_efecto_select2" style="width: 100%">
                    </select>
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn btn-success" id="adicionarycerrarefecto"><i class="fa fa-plus"></i>
                Guardar</a>
            <a href="javascript:;" class="btn btn-cerrar btn-info" id="cerrarefecto">Cerrar</a>
        </div>
    </div>
    <div class="modal fade static" id="itemspanelefectoedit" style="display: none;">
        <div class="modal-header">
            <h3 class="paneltitle">Editar efecto</h3>
        </div>
        <div class="modal-body panelbody">
            <div class="alert alert-info incompletoefectoedit" style="display: none;">
                <i class="fa fa-info-sign"></i> Complete todos los campos para continuar
            </div>
            <div class="row-fluid">
                <form id="formulario2" class='form-vertical' action="" method="POST">             
                    Efecto Actual:
                    <textarea style="width: 100%; text-transform: none" id="efectoanterior" disabled></textarea>
                    <br>
                    <br>
                    Descripción:
                    <select id="id_efectoedit_select2" style="width: 100%">
                    </select>
                    <input type="hidden" name="efectedit" id="idefectedit">
                    
                    
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn btn-success" id="adicionarycerrarefectoedit"><i class="fa fa-plus"></i>
                Guardar</a>
            <a href="javascript:;" class="btn btn-cerrar btn-info" id="cerrarefectoedit">Cerrar</a>
        </div>
    </div>
    <div class="modal fade static" id="selectdeleteefecto" style="min-height: 60px">
        <div class="modal-header">
            <h4 id="paneltitle">Eliminar Tema</h4>
        </div>
        <div class="modal-body" id="selectdeletepar-body">
            <input type='hidden' id="codigoefecto" name="codigoefecto" value=""/>
            <p style="margin-top: 10px;">Esta seguro(a) que desea eliminar: <b id="leyendaefecto"></b></p>
        </div>
        <div class="modal-footer">
            <p style="text-align: right; margin-bottom: 0">
                <a href="javascript:;" id="eliminacionmodal_formbuttonefecto" class='btn btn-danger btn-form'>
                    Eliminar</a>
                <a href="javascript:;" id="eliminacionmodal_cancelefecto" class="btn btn-info"> Cerrar</a>
            </p>
        </div>
    </div>

    <!-- MODALES CAUSAS -->
    <div class="modal fade static" id="itemspanelcausa" style="display: none;">
        <div class="modal-header">
            <h3 class="paneltitle">Adicionar Causas</h3>
            <a class="reqistrar_causa tu btn btn-default" title="Agregar Causas">
                <i class="fa fa-plus"></i></a>
        </div>
        <div class="modal-body panelbody">
            <div class="alert alert-info incompletocausa" style="display: none;">
                <i class="fa fa-info-sign"></i> Complete todos los campos para continuar
            </div>
            <div class="row-fluid">
                <form id="formulario2" class='form-vertical' action="" method="POST">
                    Causas:<br>
                    <input type="hidden" name="pro" id="idpro">
                    <select id="id_causas_select2" style="width: 100%">
                    </select>
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn btn-success" id="adicionarycerrarcausa"><i class="fa fa-plus"></i>
                Guardar</a>
            <a href="javascript:;" class="btn btn-cerrar btn-info" id="cerrarcausa">Cerrar</a>
        </div>
    </div>
    <div class="modal fade static" id="itemspanelcausaedit" style="display: none;">
        <div class="modal-header">
            <h3 class="paneltitle">Editar causa</h3>
        </div>
        <div class="modal-body panelbody">
            <div class="alert alert-info incompletocausaedit" style="display: none;">
                <i class="fa fa-info-sign"></i> Complete todos los campos para continuar
            </div>
            <div class="row-fluid">
                <form id="formulario2" class='form-vertical' action="" method="POST">
                    Causa Actual:
                    <textarea style="width: 100%; text-transform: none" id="causaanterior" disabled></textarea>
                    <br>
                    <br>
                    Descripción:
                    <select id="id_causasedit_select2" style="width: 100%">
                    </select>
                    <input type="hidden" name="causedit" id="idcausedit">
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn btn-success" id="adicionarycerrarcausaedit"><i class="fa fa-plus"></i>
                Guardar</a>
            <a href="javascript:;" class="btn btn-cerrar btn-info" id="cerrarcausaedit">Cerrar</a>
        </div>
    </div>
    <div class="modal fade static" id="selectdeletecausa" style="min-height: 60px">
        <div class="modal-header">
            <h4 id="paneltitle">Eliminar Causa</h4>
        </div>
        <div class="modal-body" id="selectdeletepar-body">
            <input type='hidden' id="codigocausa" name="codigocausa" value=""/>
            <p style="margin-top: 10px;">Esta seguro(a) que desea eliminar: <b id="leyendacausa"></b></p>
        </div>
        <div class="modal-footer">
            <p style="text-align: right; margin-bottom: 0">
                <a href="javascript:;" id="eliminacionmodal_formbuttoncausa" class='btn btn-danger btn-form'>
                    Eliminar</a>
                <a href="javascript:;" id="eliminacionmodal_cancelcausa" class="btn btn-info"> Cerrar</a>
            </p>
        </div>
    </div>


{% endblock %}
