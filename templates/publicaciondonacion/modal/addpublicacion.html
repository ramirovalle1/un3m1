{% extends "base.html" %}
{% load sga_extras %}
{% block heading %}

    <script type="text/javascript" src='/static/js/jquery.validationEngine.js?v=1.0.0'></script>
    <script type="text/javascript" src='/static/js/jquery.validationEngine-es.js?v=1.0.0'></script>
    <link type='text/css' rel='stylesheet' href="/static/css/validationEngine.jquery.css?v=1.0.0"/>

    <script type="text/javascript" src='/static/js/select2.js?v=1.0.0'></script>
    <link type='text/css' rel='stylesheet' href="/static/css/select2.css?v=1.0.0"/>

    <script type="text/javascript" src="/static/js/bootstrap-filestyle.min.js?v=1.0.1"></script>

    <script type="text/javascript" src="/static/ckeditor/ckeditor-init.js?v=1.0.1"
            data-ckeditor-basepath="/static/ckeditor/ckeditor/" id="ckeditor-init-script"></script>
    <script type="text/javascript" src="/static/ckeditor/ckeditor/ckeditor.js?v=1.0.1"></script>

    <script type='text/javascript' src="/static/js/bootstrap-datepicker.js?4.0.0"></script>
    <link href="/static/switchery/switchery.min.css" rel="stylesheet"/>
    <script src="/static/switchery/switchery.min.js"></script>
    <link rel="stylesheet" href="/static/dropify/css/dropify.min.css">
    <script type="text/javascript" src='/static/dropify/js/dropify.min.js?v=1.0.0'></script>
    <link href="/static/css/datepicker.css?4.0.0" rel='stylesheet'/>

    <link href="/static/css/table-responsive.css?1.0.0" type="text/css" rel="stylesheet"/>


    <script type="text/javascript">

        var switchery = {};
        $.fn.initSwitchery = function (e) {
            var searchBy = ".js-switch";
            $(this).find(searchBy).each(function (i, html) {
                if (!$(html).next().hasClass("switchery")) {
                    switchery[html.getAttribute('id')] = new Switchery(html, {size: 'small', color: '#5DADE2'});
                }
            });
        };


        function changeFormat(args) {
            let parts = args.split('-');
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }

        function validate2(fI, fF) {
            let fechaI = changeFormat(fI);
            let fechaF = changeFormat(fF);
            let mayor;
            (Date.parse(fechaF) > Date.parse(fechaI)) ? mayor = fechaF : mayor = fechaI;

            return fechaF.toDateString() === mayor.toDateString();
        }

        function soloNumeros(e) {
            var key = window.Event ? e.which : e.keyCode
            return (key >= 48 && key <= 57)
        }

        function set_dropify(args) {
            $(args).filestyle('destroy');
            $(args).dropify({
                messages: {
                    default: '<h4>Arrastre y suelte el archivo o haga clic aquí.<h4>',
                    replace: 'Arrastre y suelte el archivo o haga clic aquí.',
                    remove: 'Eliminar',
                    error: 'Ocurrió un error!'
                },
                error: {
                    fileSize: "El tamaño del archivo debe ser máximo (2MB).",
                    fileExtension: "Sólo puede subir los archivos con las extensiones .jpeg .pdf .jpg .png .docx"
                },

            });
        }

        $(function () {
            tabla_paginada = $('.tabla_paginada').DataTable({
                retrieve: true,
                responsive: false,
                ordering: false,
                paging: true,
                searching: true,
                language: {
                    "url": "/static/bootstrap5/libs/datatables.net-bs5/js/es-ES.json"
                },
                bInfo: false,
                dom: 'Bfrtip',
                buttons: [],
                columnDefs: [
                    { "width": "10%", "targets": 0 },
                    { "width": "60%", "targets": 1 },
                    { "width": "20%", "targets": 2 },
                    { "width": "10%", "targets": 3 },
                ]
            });

            $('.tabla_paginada tbody').on('click', 'tr', function () {
                var data = tabla_paginada.row(this).data();
            });

            $("#form").validationEngine({autoHidePrompt: true, autoHideDelay: 1000});

            $('#continuarbutton').click(function () {
                $('.is-invalid').removeClass('is-invalid');
                var valid = $("form").validationEngine('validate');
                if(valid){
                    $('#productos-tab').show('slow')
                    var someTabTriggerEl = document.querySelector('#productos-tab')
                    var tab = new bootstrap.Tab(someTabTriggerEl)
                    tab.show();
                }
            });
            set_dropify("#id_evidencianecesidad");
            $("#id_nombre, #id_fechainiciorecepcion,#id_fechafinrecepcion, #id_fechainicioentrega, #id_fechafinentrega, #id_evidencianecesidad, #id_evidenciaejecucion, #id_producto, #id_objetivo, #id_tipodonacion, #id_poblacion").addClass("validate[required]");

            /*INIT EDIT ACTION*/
            if ($('#action').val() === 'editpublicacion') {
                $('#producto-detalle-table').show();
                $('#id_evidencianecesidad').removeClass('validate[required]');
                $('#id_producto').trigger('change.select2');

                set_dropify("#id_evidenciaejecucion");
            } else {
                $('#producto-detalle-table').hide();
            }

            //$("#id_detalleproducto").select2('destroy');

            //SOBREPOSICIONAR MODAL
            $('body').on('shown.bs.modal', '.modal', function () {
                $(this).find('select').each(function () {
                    var dropdownParent = $(document.body);
                    if ($(this).parents('.modal.in:first').length !== 0)
                        dropdownParent = $(this).parents('.modal.in:first');
                    $(this).select2({
                        dropdownParent: dropdownParent
                        // ...
                    });
                });
            });

            $("body").initSwitchery();

            $(".selectorfecha").datepicker({format: "dd-mm-yyyy"}).on('changeDate', function (ev) {
                $(this).datepicker('hide');
            });

            //$(".selectorfecha").attr('style', 'width:100%;');


            ItemsDisplay = function (item) {
                if (item.text == 'undefined') {
                    return '---------';
                }
                if (item.text) {
                    return $('<span>' + item.text + '</span>');
                } else {
                    if (item.name) {
                        return $('<span>' + item.name + '</span>');
                    } else {
                        return '---------';
                    }
                }
            };

            $("#id_poblacion").select2({
                placeholder: "   --Buscar población--",
                allowClear: true,
                escapeMarkup: function (markup) {
                    return markup;
                },
                minimumInputLength: 1,
                templateResult: ItemsDisplay, // omitted for brevity, see the source of this page
                templateSelection: ItemsDisplay // omitted for brevity, see the source of this page
            });
            $("#id_tipodonacion").select2({
                placeholder: "&nbsp;&nbsp;--Buscar tipo de donación--",
                allowClear: true,
                escapeMarkup: function (markup) {
                    return markup;
                }, // let our custom formatter work
                minimumInputLength: 1,
                templateResult: ItemsDisplay, // omitted for brevity, see the source of this page
                templateSelection: ItemsDisplay // omitted for brevity, see the source of this page
            });
            $("#id_producto").select2({
                placeholder: "   --Buscar producto--",
                allowClear: false,
                escapeMarkup: function (markup) {
                    return markup;
                }, // let our custom formatter work
                minimumInputLength: 1,
                templateResult: ItemsDisplay, // omitted for brevity, see the source of this page
                templateSelection: ItemsDisplay // omitted for brevity, see the source of this page
            });

            !$("#id_fechafinrecepcion").val() ? $("#id_fechafinrecepcion").attr('disabled', true) : '';
            !$("#id_fechafinentrega").val() ? $("#id_fechafinentrega").attr('disabled', true) : '';

            $("#id_fechainiciorecepcion").on('changeDate', function () {
                let end = $("#id_fechafinrecepcion")

                if (end.val()) {
                    if (!validate2($(this).val(), end.val())) {
                        alertaDanger('La fecha de inicio debe ser menor o igual a la fecha de finalización.');
                        $(this).val('').focus();
                    }
                }
                end.attr('disabled', false);
            });
            $("#id_fechafinrecepcion").on('changeDate', function (e) {
                let fechaI = $("#id_fechainiciorecepcion").val();

                if (!validate2(fechaI, $(this).val())) {
                    alertaDanger('La fecha de finalización debe ser mayor o igual a la fecha de inicio.');
                    $(this).val('').focus();
                }
            });
            $("#id_fechainicioentrega").on('changeDate', function () {
                let end = $("#id_fechafinentrega");

                if (end.val()) {
                    if (!validate2($(this).val(), end.val())) {
                        alertaDanger('La fecha de inicio debe ser menor o igual a la fecha de finalización.');
                        $(this).val('').focus();
                    }
                }
                end.attr('disabled', false);
            });
            $("#id_fechafinentrega").on('changeDate', function (e) {
                let init = $("#id_fechainicioentrega").val();

                if (!validate2(init, $(this).val())) {
                    alertaDanger('La fecha de finalización debe ser mayor o igual a la fecha de inicio.');
                    $(this).val('').focus();
                }
            });


            envioformulario = function () {
                $('.is-invalid').removeClass('is-invalid');
                var valid = $("form").validationEngine('validate');
                if (valid) {
                    $('.datepicker').css({"display": "none"});
                    $('.bootstrap-timepicker-widget').css({"display": "none"});
                    bloqueointerface();
                    $('.controls input').each(function () {
                        if ($(this).attr('type') == 'text') {
                            $(this).val($(this).val().trim());
                        }
                        if ($(this).attr('type') != 'file') {
                            if ($(this).css('text-transform') == 'uppercase') {
                                if ($(this).attr('type') != 'password') {
                                    $(this).val($(this).val().toUpperCase());
                                }
                            }
                        }
                    });

                    try {
                        for (instance in CKEDITOR.instances) {
                            CKEDITOR.instances[instance].updateElement();
                        }
                    } catch (err) {
                        console.log(err.message);
                    }

                    var formdata = new FormData($("#formulario")[0]);

                    let lista = []
                    try {
                        $('.dp_rows').each(function () {
                            lista.push($(this).attr('data-to-save'));
                        });
                    } catch (e) {
                        console.log(e.message);
                    }

                    if (lista.length > 0) formdata.append('detalleproducto', lista);
                    $.ajax({
                        type: "POST",
                        url: "{{ request.path }}",
                        data: formdata,
                        success: function (data) {
                            if (data.result == 'ok') {

                                if (data.showSwal) {
                                    $.unblockUI();
                                    urlDestino = "{{ request.path }}" + ((data.id) ? data.id : "");
                                    mensajeSuccessSwal(data.titulo, data.mensaje, urlDestino);
                                } else if (data.mensaje) {
                                    $.unblockUI();
                                    NotificationJG.success(data.mensaje);
                                    if (data.resultados) {
                                        $("#resultadosquery").html("");
                                        $("#resultadosquery").html(data.resultados);
                                    }
                                } else {
                                    if ($('#submitAndAdd').length) {
                                        location.reload();
                                    } else {
                                        location.href = "{% block formdestination %}{{ request.path }}{% endblock %}" + ((data.id) ? data.id : "");
                                    }
                                }
                            } else {
                                $.unblockUI();
                                if (!data.showSwal) {
                                    NotificationJG.error(data.mensaje);
                                } else {
                                    if (data.swalType == 'error')
                                        mensajeErrorSwal(data.titulo, data.mensaje);
                                    else
                                        mensajeWarningSwal(data.titulo, data.mensaje);
                                }
                                //smoke.alert(data.mensaje);

                                if (data.form) {
                                    data.form.forEach(function (val, indx) {
                                        var keys = Object.keys(val);
                                        keys.forEach(function (val1, indx1) {
                                            $("#id_" + val1).addClass("is-invalid");
                                            {#$("#errorMessage" + val1).html(val[val1]);#}
                                            console.log(val[val1])
                                        });
                                    });
                                }

                            }
                        },

                        error: function (jqXHR, textStatus, errorThrown) {
                            $.unblockUI();
                            {#smoke.alert("Error de conexión.");#}
                            var msg = '';
                            if (jqXHR.status === 0) {
                                msg = 'Not connect: Verify Network.';
                            } else if (jqXHR.status == 404) {
                                msg = 'Requested page not found [404]';
                            } else if (jqXHR.status == 500) {
                                msg = 'Internal Server Error [500].';
                            } else if (textStatus === 'parsererror') {
                                msg = 'Requested JSON parse failed.';
                            } else if (textStatus === 'timeout') {
                                msg = 'Time out error.';
                            } else if (textStatus === 'abort') {
                                msg = 'Ajax request aborted.';
                            } else {
                                msg = 'Uncaught Error: ' + jqXHR.responseText;
                            }
                            //smoke.alert("Error al enviar los datos: " + msg);
                            NotificationJG.error("Error al enviar los datos: " + msg);
                        },
                        always: function (){
                          $.unblockUI();
                        },

                        dataType: "json",
                        cache: false,
                        contentType: false,
                        processData: false
                    });
                } else {
                    setTimeout(function () {
                        $('.help-text').each(function () {
                            var field = $(this);
                            if (field.attr('alert')) {
                                field.html(field.attr('alert'));
                            } else {
                                field.html('');
                            }
                        });
                    }, 8000);
                    $.unblockUI();
                }
            };

            $("#formbutton").click(function () {
                Swal.fire({
                    html: `<b>¿Esta seguro de finalizar y enviar la solicitud?</b>`,
                    text: "Esta acción es irreversible",
                    type: 'info',
                    showCancelButton: true,
                    allowOutsideClick: false,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Si, deseo hacerlo',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.value) {
                        envioformulario();
                    }
                });
            });


            //$(":file").filestyle({"input": false});
            $("select").select2({minimumResultsForSearch: 10, width: '100%'});

            tipo_formulario($("#formulario"));

            $(".select2hidden").each(function () {
                var id = $(this).attr("id");
                $("#" + id + "_select2").html('<option>' + $(this).attr("descripcion") + '</option>').trigger('change');
            });

            $('#btn_inner_save').click(function () {
                let row = $(this).attr('data-type-save');
                if (row){
                    SaveDetails(row);
                }else{
                    SaveDetails();
                }
            });
        });


        function editVal(e) {
            if ($('.table .row-content-data-' + e).length) {
                var values = ($('#id_detalleproducto option[id="' + e + '"]')[0].value).split(';');
                $('#id_cantidad').val(parseInt(values[1]));
                $('#id_unidadmedida').val(parseInt(values[2])).trigger('change');
                $('#btncancelardetalleproducto').attr('edit', true);
            }
            formDetallleProducto(e, 'Editar', '40%');
        }

        function formDetallleProducto(idproducto, titulo, width = '40%') {
            $('#adddetalleproducto .paneltitle').html(titulo);
            $('#adddetalleproducto #id_cantidad').attr('idp', idproducto).focus();
            $("#adddetalleproducto").modal({
                backdrop: 'static',
                width: width,
                height: '100%'
            }).modal('show').on('hidden.bs.modal', function (e) {
                $('#adddetalleproducto #id_cantidad').val('');
                $('#adddetalleproducto #id_unidadmedida').val(0).trigger('change');
            });
        }

        function formModal2(id, text, action, footer = true) {
            let list = []
            $("#modalViewTitulo .modal-footer").hide();
            //Excluyo los id de los productos que ya fueron seleccionados
            $('.list_id_productos').each(function () {
                list.push($(this).text());
            })
            bloqueointerface();
            $.ajax({
                type: "GET",
                url: `{{ url_ }}`,
                data: {
                    'action': action,
                    'id': id,
                    'ids': list,
                },
                success: function (data) {
                    $.unblockUI();
                    if (data.result) {

                        $("#modalViewTitulo .panelbody").html(data.html);
                        if (!footer) {
                            $("#modalViewTitulo .modal-footer").show();
                            !footer ? $(".grupo-botones-form-modal").remove() : null;
                            $('#btn_inner_save').attr('data-type-save', '');
                        }

                        $('#modalViewTitulo .paneltitle').html(text);
                        $("#id_descripcion, #id_tipoproducto, #id_producto, #id_cantidad, #id_unidadmedida").addClass("validate[required]");
                        $("#modalViewTitulo").modal({
                            backdrop: 'static',
                            width: '40%',
                            height: '100%'
                        }).modal('show').on('hidden.bs.modal', function (e) {
                            $("#modalViewTitulo .panelbody").empty();
                        });
                    } else {
                        alertaDanger(data.mensaje);
                    }
                },
                error: function () {
                    $.unblockUI();
                    alertaDanger("Error al enviar los datos");
                },
                dataType: "json"
            });
        }

        function validarFecha(input) {
            $(input).on('changeDate', function (e) {
                let init = $(input.split(',', 1)[0]);
                let end = $(input.split(',', 1)[1]);
                let initvalue = init.val();
                let endvalue = end.val();
                if ((initvalue.split('/')[0]).length !== 2) {
                    initvalue = initvalue.split('/')[3] + '/' + initvalue.split('/')[2] + '/' + initvalue.split('/')[1];
                }
                if ((endvalue.split('/')[0]).length !== 2) {
                    endvalue = endvalue.split('/')[3] + '/' + endvalue.split('/')[2] + '/' + endvalue.split('/')[1];
                }

                if (end.val()) {
                    if (!validate2(initvalue, endvalue)) {
                        alertaDanger('La fecha de inicio debe ser menor o igual a la fecha de finalización.');
                        $(this).val('').focus();
                    }
                }
                end.attr('disabled') ? end.attr('disabled', false) : '';
            });
        }

        function SaveDetails(row_number=null) {
            $('.is-invalid').removeClass('is-invalid');
            let valid = $("#formdata").validationEngine('validate');
            if (valid){
                id = $('#id_producto').val();
                nombre = $('#select2-id_producto-container').text();
                cantidadproducto = $('#id_cantidad').val();
                unidadmedida = $('#id_unidadmedida').val();
                if (row_number){
                    let row = $('#row-'+row_number);
                    let td = row.children();
                    td[0].innerHTML =  id;
                    td[1].innerHTML =  nombre;
                    td[2].innerHTML =  cantidadproducto;
                    row.attr('data-to-save', id+';'+cantidadproducto+';'+unidadmedida)
                }else{
                    let rows = $('.dp_rows').length;
                    let id_row = rows + 1;
                    let row = '<tr id="row-'+ id_row +'" data-to-save="'+ id +';'+ cantidadproducto +';'+ unidadmedida +'" class="dp_rows py-2"><td class="list_id_productos">'+ id +'</td><td>'+ nombre +'</td><td>'+ cantidadproducto +'</td><td><a onclick="EditDetails('+ id_row +')" class="btn btn-sm btn-defauld"><i class="fa fa-edit"></i></a><a onclick="DeleteDetails('+ id_row +')" class="btn btn-sm btn-defauld"><i class="fa fa-trash"></i></a></td></tr>'
                    $('#tbody_to_append').prepend(row);
                    ($('.dp_rows').html()) ? $('.dataTables_empty').hide() : $('.dataTables_empty').show();
                }

                $('#modalViewTitulo').modal('hide');
            }else{
                setTimeout(function() {
                    $('.help-text', $("#modalViewTitulo")).html("");
                }, 8000);
                $.unblockUI();
            }
        }

        function DeleteDetails(e) {
            $('#row-'+e).remove();
            ($('.dp_rows').html()) ? $('.dataTables_empty').hide() : $('.dataTables_empty').show();
        }

        function EditDetails(e) {
            let row = $('#row-'+e);
            if (row.length){
                let data = row.attr('data-to-save').split(';');
                let list = []
                $('.list_id_productos').each(function () {
                    var id = $(this).text();
                    parseInt(data[0]) !== parseInt(id) ? list.push(id) : null;
                })

                $.get("{{ request.path }}", {'action': 'editdetalleproducto', 'render': data, 'ids':list}, function (data) {
                    if (data.result) {
                        $("#modalViewTitulo .panelbody").html(data.html);
                        $("#modalViewTitulo .modal-footer").show();
                        $(".grupo-botones-form-modal").remove();
                        $('#modalViewTitulo .paneltitle').html(e['nombre']);
                        $("#id_descripcion, #id_tipoproducto").addClass("validate[required]");
                        $("#modalViewTitulo").modal({
                            backdrop: 'static',
                            width: '40%',
                            height: '100%'
                        }).modal('show').on('hidden.bs.modal', function (e) {
                            $("#modalViewTitulo .panelbody").empty();
                        });
                    } else {
                        alertaDanger(data.mensaje);
                    }
                }, 'json');

                $('#btn_inner_save').attr('data-type-save', e);
            }
        }

    </script>
    <style>
        table.table thead th, table.table thead td {
            padding: 0;
            border-bottom: 0;
            background-color: #fff;
            text-align: center;
        }

        table.table tbody th, table.table tbody td {
            padding: 0;
            border-bottom: 0;
            background-color: #fff;
            text-align: center;
        }
        @media (max-width: 768px) {
            .label-text {
                text-align: left !important;
            }
        }

        /*@media (max-width: 360px){
            .d-sm-none{
                display:none;
            }
        }*/

        .nav-pills .nav-link.active {
            background-color: #fe990047;
            border-color: #D6EAF8;;
            color: #1C3247;
        }

        .nav-pills .nav-link:hover {
            opacity: .9;
        }

        .dataTables_filter {
            display: none;
        }

        .dropdown-item:hover {
            background-color: #fe990047;
            opacity: .3;
            border-color: #D6EAF8;;
            color: #1C3247;
        }
        ::-webkit-scrollbar {
          width: 10px;
        }

        /* Track */
        ::-webkit-scrollbar-track {
          box-shadow: inset 0 0 5px grey;
          border-radius: 10px;
        }

        /* Handle */
        ::-webkit-scrollbar-thumb {
          background: silver;
          border-radius: 10px;
        }

    </style>
{% endblock %}
{% block atras %}{{ request.path }}{% endblock %}
{% block canvas %}
    <div class="row" style="width: 100%">
        <div class="col-lg-2 col-md-2 d-sm-none d-md-block d-lg-block"></div>
        <div class="col-lg-8 col-md-8 col-sm-12">
            <div class="row">
                {% if aprobado %}
                    <div class="alert alert-warning" role="alert">
                       <i class="fa fa-bell blinkimg"></i> Estimad{% if persona.es_mujer %}a{% else %}o{% endif %} {{ persona }}, se aumentó en 7 dias la fecha límite de entrega a partir de la aprobación de su solicitud. Por lo cual la nueva fecha límite de entrega es <b>{{ ffentrega }}</b>
                    </div>
                {% endif %}
            </div>
            <div class='row-fluid no-marging-bottom mt-4' style="margin-bottom: 3px;">
                <div class="headtitle">
                    <h3 class="texto-blue">{{ title }}</h3>
                    <h6>Ingrese todos sus datos de forma correcta</h6>
                </div>
            </div>
            <div class='row'>
                <div class='col-12'>
                    <div class="form-l px-2">
                        <div class="card">
                            <div class="card-body border-top border-5 rounded-3 border-dark-info">
                                <form class="form-group p-2" id="formulario" formtype="form-horizontal" style="width: 100%; margin-bottom: 0" onsubmit="return false">
                                    <div class="row-fluid" style="margin-bottom: 10px">
                                        {% if form.errors %}
                                        <div class="alert alert-warning" role="alert">
                                           <i class="fa fa-bell blinkimg"></i>
                                            {{ form.error }}

                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="row">
                                        <input type="hidden" name="id" value="{{ id|encrypt }}"/>
                                        <input type="hidden" name="action" value="{{ action }}" id="action"/>
                                        {% csrf_token %}

                                        {% for field in form %}
                                            {% if field.errors %}
                                                {{ field.errors }}
                                            {% endif %}
                                            {% if field.field.widget.attrs.separator %}
                                                <hr noshade="noshade" style="clear: both; color: #0c0c0c; height: 4px; width: 100%; align-content: center"/>
                                            {% endif %}
                                            {% if field.field.widget.attrs.titulo %}
                                                <div style="width: 100%; height: 25px; float: left; font-weight: bold; text-align: center">{{ field.field.widget.attrs.titulo }}</div>
                                            {% endif %}

                                            {% if field.field.widget.attrs.separator2 %}
                                                <div id="separator2_{{ field.name }}"
                                                     style="width: 100%; height: max-content; display: inline-block">
                                                    <h6 style="width:100%; text-align:left; border-bottom: 1px solid #98a3ab; line-height:0.1em; margin:10px 0 20px;">
                                                        <span id="separator2title_{{ field.name }}" style="padding:0 10px; background: #f5f5f5;">{% if field.field.widget.attrs.separatortitle %}{{ field.field.widget.attrs.separatortitle|safe }}{% endif %}</span>
                                                    </h6>
                                                </div>
                                            {% endif %}
                                            <div id="fieldset_{{ field.name }}"
                                                 class="col-md-{{ field.field.widget.attrs.col }}"
                                                 style="float: left; padding-right: 20px;">
                                                <div class="row">
                                                    {% if field.field.widget.attrs.showmsginfo and field.field.widget.attrs.msgloc == 'top' %}
                                                        <div class="alert alert-info">
                                                            {% if field.field.widget.attrs.msgtitle %}
                                                                <h4 class="alert-heading">{{ field.field.widget.attrs.msgtitle }}</h4>
                                                            {% endif %}
                                                            {% if field.field.widget.attrs.msgtext %}
                                                                {{ field.field.widget.attrs.msgtext }}<br>
                                                            {% endif %}
                                                            {% if field.field.widget.attrs.msglist %}
                                                                <ul>
                                                                    {% for item in field.field.widget.attrs.msglist %}
                                                                        <li>{{ item }}</li>
                                                                    {% endfor %}
                                                                </ul>
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="row-fluid input-group">
                                                    <div class="label-text col-md-{% if field.field.widget.attrs.col == '12' %}3{% else %}6{% endif %} col-sm-3 col-12"
                                                         {% if field.field.widget.attrs.labelwidth %}labelwidth="{{ field.field.widget.attrs.labelwidth }}"{% endif %}
                                                         style="display: table;height: 30px;">
                                                        {% if field.field.widget.attrs.fieldbuttons %}
                                                            <div style="display: table-cell; vertical-align: middle; line-height: 11px; align-items: rig">
                                                                {% for boton in field.field.widget.attrs.fieldbuttons %}
                                                                    <a href="javascript:;"
                                                                       class="btn btn-sm {{ boton.btnclasscolor }} tu"
                                                                       title="{{ boton.tooltiptext }}"
                                                                       id="{{ boton.id }}"><i
                                                                            class="fa {{ boton.btnfaicon }}"></i></a>
                                                                {% endfor %}
                                                            </div>
                                                        {% endif %}
                                                        <div style="display: table-cell; vertical-align: middle; line-height: 11px">
                                                            <label for="id_{{ field.name }}" style="padding-right: 10px">{{ field.label }}:</label>
                                                        </div>
                                                    </div>
                                                    <div class="control-group col-md-{% if field.field.widget.attrs.col == '12' %}9{% else %}6{% endif %} col-sm-9 col-12"
                                                         style="float: left; width:
                                                                 {% if field.field.widget.attrs.controlwidth %}{{ field.field.widget.attrs.controlwidth }}{% else %}100{% endif %}">
                                                        {% if field.field.widget.attrs.select2search %}
                                                            <select id="id_{{ field.name }}_select2"
                                                                    {% if field.field.widget.attrs.disabled %}disabled=""{% endif %}>
                                                                <option value="0" selected="selected">---------</option>
                                                            </select>
                                                            <input name="{{ field.name }}" id="id_{{ field.name }}"
                                                                   value="{{ field.value }}" hidden="hidden"
                                                                   {% if field.field.widget.attrs.descripcion %}descripcion="{{ field.field.widget.attrs.descripcion }}"{% endif %}
                                                                   class="select2hidden">
                                                        {% else %}
                                                            {{ field }}
                                                        {% endif %}
                                                        {% if field.field.widget.attrs.help_text2 %}
                                                            <small class="form-text text-muted">
                                                                {{ field.field.widget.attrs.help_text2 }}
                                                            </small>
                                                        {% endif %}
                                                        <p class="help-text"
                                                           style="color: #dc1414;font-size: xx-small; margin-bottom: 0; height: 13px; line-height: 13px">{{ field.help_text }} </p>
                                                        {% if field.field.widget.attrs.mensage %}
                                                            <span class="alert-info">{{ field.field.widget.attrs.mensage }} </span>
                                                        {% endif %}
                                                    </div>
                                                </div>

                                                {% if field.field.widget.attrs.showmsginfo and field.field.widget.attrs.msgloc == 'bottom' %}
                                                    <div class="alert alert-info" style="float: left; width: 100% ">
                                                        {% if field.field.widget.attrs.msgtitle %}
                                                            <h4 class="alert-heading">{{ field.field.widget.attrs.msgtitle }}</h4>
                                                        {% endif %}
                                                        {% if field.field.widget.attrs.msgtext %}
                                                            {{ field.field.widget.attrs.msgtext }}<br>
                                                        {% endif %}
                                                        {% if field.field.widget.attrs.msglist %}
                                                            <ul>
                                                                {% for item in field.field.widget.attrs.msglist %}
                                                                    <li>{{ item }}</li>
                                                                {% endfor %}
                                                            </ul>
                                                        {% endif %}
                                                    </div>
                                                {% endif %}

                                            </div>
                                        {% endfor %}
                                    </div>
                                    <div class="row" style="margin-bottom: 10px">
                                    </div>
                                    <div class="row" style="margin-bottom: 10px">
                                        <div class="divider"></div>
                                    </div>
                                    <div class="row">
                                        <div style="text-align: right; float: left; width: 100%">
        {#                                                            <a href="javascript:;" class="btn btn-success btn-form" id="formbutton">Guardar</a>#}
        {#                                                            {% if not aprobado %}<a href="javascript:;" class="btn btn-success" id="continuarbutton"><i class="fa fa-arrow-right"></i> Continuar</a>{% endif %}#}
        {#                                                            <a href="{{ request.path }}" class="btn btn-danger"><i class="fa fa-undo"></i> Cancelar</a>#}
        {#                                                            <a href="{{ request.path }}" class="btn {% if permite_modificar %}btn-danger{% else %}btn-info{% endif %} bloqueo_pantalla" id="formcancel">{% if permite_modificar %}Cancelar{% else %}Aceptar{% endif %}</a>#}
                                        </div>
                                    </div>
                                </form>
                                <div class="row">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="card my-4 px-2">
                                                <div class="card-header border-bottom-0">
                                                    <div class="col-lg-12 col-md-12 col-12">
                                                        <div class="row">
                                                            <div class="col-sm-6 col-md-6 col-lg-6" style="float: left;">
                                                                {% if not aprobado %}
                                                                <a href="javascript:;" onclick="formModal2(0, 'SOLICITAR PRODUCTO', 'adddetalleproducto', false)" class="btn btn-success" title="Agregar producto a la solicitud"><i class="fa fa-plus"></i> Agregar producto</a>
                                                                <div class="btn-group">
                                                                    <button type="button" class="btn dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                                        <i class="fa fa-cogs"></i> Configuraciones
                                                                    </button>
                                                                    <div class="dropdown-menu" style="font-size: 16px">
                                                                        <a onclick="formModal2(0,'Adicionar nuevo producto','addproducto', true);" class="dropdown-item fs-6" href="javascript:void(0)">
                                                                            <i class="fa fa-plus-circle dropdown-item-icon"></i>Nuevo producto
                                                                        </a>
                                                                    </div>
                                                                </div>
                                                                {% endif %}
                                                            </div>
                                                            <div class="col-sm-6 col-md-3 col-lg-2  offset-md-3 offset-lg-4 justify-content-center">
                                                                <a id="formbutton" style="cursor: pointer;" class="btn btn-cian-secondary mb-2"><i class="fa fa-share"></i> Finalizar</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class='col-12'>
                                            <div class="card mb-4">
                                                <div class="card-body border-top border-6 rounded-3 border-dark-info">
                                                    <table class='table table-bordered tabla_paginada'>
                                                        <thead>
                                                            <tr>
                                                                <th style="background-color: #f0f0f0">#</th>
                                                                <th style="background-color: #f0f0f0">PRODUCTO</th>
                                                                <th style="background-color: #f0f0f0">CANTIDAD</th>
                                                                <th style="background-color: #f0f0f0">ACCIONES</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="tbody_to_append">
                                                            {% if listaproductos %}
                                                                {% for x in listaproductos %}
                                                                    <tr id="row-{{ forloop.counter }}" data-to-save="{{ x.producto_id }};{{ x.cantidad }};{{ x.unidadmedida_id }}" class="dp_rows">
                                                                        <td class="list_id_productos">{{ x.producto_id }}</td>
                                                                        <td>{{ x.producto }}</td>
                                                                        <td>{{ x.cantidad }}</td>
                                                                        <td class="py-2">
                                                                            {% if not aprobado %}<a onclick="EditDetails('{{ forloop.counter }}')" class="btn btn-md btn-default"><i class="fa fa-edit"></i></a>{% endif %}
                                                                            <a onclick="DeleteDetails('{{ forloop.counter }}')" class="btn btn-md btn-default"><i class="fa fa-trash"></i></a>
                                                                        </td>
                                                                    </tr>
                                                                    {% empty %}
                                                                    <tr>
                                                                        <td colspan="4">NO EXISTEN REGISTROS</td>
                                                                    </tr>
                                                                {% endfor %}
                                                            {% endif %}
                                                        </tbody>

                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-2 d-sm-none d-md-block d-lg-block"></div>
    </div>
    <div class="modal fade static" id="modalViewTitulo" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 style="display:inline-block"><b class="paneltitle"></b></h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12">
                            {% csrf_token %}
                            <div class="panelbody">

                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="display: none;">
                    <div style="text-align: right; float: left; width: 100%">
                        <a id="btn_inner_save" href="javascript:;" class="btn btn-success" data-type-save=""><i class="fa fa-check-circle"></i> Guardar</a>
                        <a href="javascript:;" class="btn btn-cerrar btn-danger" data-bs-dismiss="modal" aria-label="Close">Cerrar</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}