{% extends "base.html" %}
{% load sga_extras %}
{% load humanize %}
{% block heading %}

    <script type="text/javascript">
        var rubosseleccionadosgenerales = [];

        $(function () {
            selectorrubro = $(".selectorrubro");
            selectorrubro2 = $(".selectorrubro2");
            todos2 = $("#todos2");


            $("#generarrecibo").click(function () {
                generarrecibo();
            });

            generarrecibo = function () {
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/rec_finanzas",
                    data: {"action": "generarrecibo", "id": 50},
                    success: function (data) {
                        $.unblockUI();

                        if (data.result == 'ok') {
                            {#smoke.alert("Generado...");#}
                            Swal.fire({
                                type: 'info',
                                text: 'Generando',
                            })
                        } else {
                            {#smoke.alert(data.mensaje);#}
                            Swal.fire({
                            type: 'warning',
                            text: data.mensaje,
                        })
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        {#smoke.alert("Error de conexion.");#}
                        Swal.fire({
                            type: 'warning',
                            text: 'Error de conexión',
                        })
                    },
                    dataType: "json"
                });

            };

            $("#rubrospanel_cerrar").click(function () {
                $("#rubrospanel").modal('hide');
                $.unblockUI();
            });

            actulizarvalor = function () {
                var seleccionados = $(".selectorrubro:checked");
                var suma = 0;
                seleccionados.each(function () {
                    valor = $(this).attr('deuda');
                    suma += parseFloat(valor);
                });
                suma = suma.toFixed(2);
                $("#porpagar").html("$ " + suma);
            };

            todos = $("#todos");

            todos.click(function () {
                if (todos.prop('checked')) {
                    selectorrubro.prop('checked', true);
                } else {
                    selectorrubro.prop('checked', false);
                }
                actulizarvalor();
            });

            selectorrubro.change(function () {
                actulizarvalor();
            });


            todos2.click(function () {
                if (todos2.prop('checked')) {
                    selectorrubro2.prop('checked', true);
                } else {
                    selectorrubro2.prop('checked', false);
                }
            });

            selectorrubro2.prop("checked", false);
            todos2.prop("checked", false);

            $("#reverso").click(function () {
                var ids;
                var seleccionados = $(".selectorrubro2:checked");
                if (seleccionados.length > 0) {
                    Swal.fire({
                        html: '¿Desea volver los rubros a UNEMI?',
                        text: "Esta acción es irreversible",
                        type: 'info',
                        showCancelButton: true,
                        allowOutsideClick: false,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Si, deseo hacerlo',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.value) {
                            bloqueointerface();
                            ids = '';
                            seleccionados.each(function () {
                                if (ids.length > 0) {
                                    ids += ",";
                                }
                                ids += $(this).attr('rid');
                            });
                            if (ids.length > 0) {
                                bloqueointerface();
                                $.ajax({
                                    type: "POST",
                                    url: "/rec_finanzas",
                                    data: {'ids': ids, 'action': 'reverso'},
                                    success: function (data) {
                                        location.reload()
                                    },
                                    error: function () {
                                        $.unblockUI();
                                        {#smoke.alert("Error al traer rubros a UNEMI.");#}
                                        Swal.fire({
                                            type: 'warning',
                                            text: 'Error al traer rubros a UNEMI',
                                        })
                                    },
                                    dataType: "json"
                                });

                                location.href = "/rec_finanzas?action=reverso&ids=" + ids;
                            } else {
                                {#smoke.alert("Debe seleccionar al menos un rubro");#}
                                Swal.fire({
                                    type: 'warning',
                                    text: 'Debe seleccionar al menos un rubro',
                                })
                            }

                        }
                    })}
                else{
                    Swal.fire({
                        type: 'warning',
                        title: 'Error!',
                        text: 'Debe seleccionar al menos 1 rubro!',
                    })
                }

            });


            {% if habilitado %}
                $(".ingresarpago").click(function () {
                    var tipodoc = $(this).attr('tdoc');
                    var ids;
                    var seleccionados = $(".selectorrubro:checked");
                    var aniorubro = 0;
                    var aniodiferente = false;

                    /*seleccionados.each(function() {
                        arubro = parseInt($(this).attr('anio'));
                        if(aniorubro == 0){
                            aniorubro = arubro;
                        }
                        else{
                            if(aniorubro != arubro){
                                aniodiferente = true;
                                return false;
                            }
                            aniorubro = arubro;
                        }
                    });

                    if(aniodiferente){
                        smoke.alert("Los rubros seleccionados deben corresponder al mismo año");
                        return false;
                    }
                    */

                    ids = '';
                    if (seleccionados.filter("[iva='0.00']").length > 0 && seleccionados.filter("[iva!='0.00']").length > 0) {
                        {#smoke.alert("No puede mezclar rubros con IVA y sin IVA.");#}
                        Swal.fire({
                            type: 'warning',
                            text: 'No puede mezclar rubros con IVA y sin IVA',
                        })
                        return false;
                    }
                    seleccionados.each(function () {
                        if (ids.length > 0) {
                            ids += ",";
                        }
                        ids += $(this).attr('rid');
                    });
                    if (ids.length > 0) {
                        location.href = "/rec_finanzas?action=pagar&ids=" + ids + "&tdoc=" + tipodoc;
                    } else {
                         Swal.fire({
                        type: 'warning',
                        title: 'Error!',
                        text: 'Debe seleccionar al menos 1 rubro!',
                    })
                    }
                });
            {% endif %}

            conectar_adicionar = function () {
                $(".btn-cobrar").unbind();

                $(".btn-cobrar").click(function () {
                    var tid = $(this).attr("tid");
                    var valor = parseFloat($("#vr" + tid).val());
                    var ncuota = parseInt($("#nc" + tid).val());
                    var iva = $("#iva" + tid).val();
                    var matricula = $("#mt" + tid).val();
                    var fecha = $("#fe" + tid).val();
                    var nombre = $("#nr" + tid).val();
                    var isEpu = $("#isE" + tid).is(':checked');

                    if (valor > 0 && nombre.trim().length > 0) {
                        if (ncuota > 1) {
                            showWaiting("Genreando Rubros", "Espere unos segundos por favor...");
                        } else {
                            showWaiting("Registrando Rubro", "Espere unos segundos por favor...");
                        }
                        $.ajax({
                            type: "POST",
                            url: "/rec_finanzas",
                            data: {
                                'action': 'addotro',
                                'fe': fecha,
                                'matricula': matricula,
                                'ncuota': ncuota,
                                'valor': valor,
                                'iva': iva,
                                'nombre': nombre,
                                'tid': tid,
                                'id': '{{ cliente.id }}',
                                'isE': isEpu,
                            },
                            success: function (data) {
                                if (data.result == 'ok') {
                                    $("#rubrospanel").modal("hide");
                                    location.href = '/rec_finanzas?action=rubros&id={{ cliente.id }}';
                                } else {
                                    hideWaiting();
                                    {#smoke.alert(data.mensaje);#}
                                    Swal.fire({
                                        type: 'warning',
                                        text: data.mensaje,
                                    })
                                }
                            },
                            error: function () {
                                hideWaiting();
                                {#smoke.alert("Error de conexión.");#}
                                Swal.fire({
                                    type: 'warning',
                                    text: 'Error de conexión',
                                })
                            },
                            dataType: "json"
                        });
                    } else {
                        $("#vr" + tid).focus();
                    }
                });
            };


            addmatricula = function () {
                $(".btn-matricula").unbind();

                $(".btn-matricula").click(function () {
                    var mid = $(this).attr("mid");
                    var rid = $(this).attr("rid");
                    if (mid > 0) {
                        $("#rubrospanel").modal("hide");
                        showWaiting("Registrando Matricula", "Espere unos segundos por favor...");
                        $.ajax({
                            type: "POST",
                            url: "/rec_finanzas",
                            data: {'action': 'addmatricula', 'mid': mid, 'rid': rid},
                            success: function (data) {
                                if (data.result == 'ok') {
                                    location.href = '/rec_finanzas?action=rubros&id={{ cliente.id }}';
                                } else {
                                    hideWaiting();
                                    {#smoke.alert(data.mensaje);#}
                                    Swal.fire({
                                        type: 'warning',
                                        text: data.mensaje,
                                    })
                                }
                            },
                            error: function () {
                                hideWaiting();
                                {#smoke.alert("Error de conexión.");#}
                                Swal.fire({
                                    type: 'warning',
                                    text: 'Error de conexión',
                                })
                            },
                            dataType: "json"
                        });
                    } else {
                        $("#vr" + tid).focus();
                    }
                });
            };
            validanumeros = function () {
                $(".otrosrubrosinput").blur(function () {
                    numerico($(this), 0, 0, 2);
                });
                $(".otroscuotainput").blur(function () {
                    numerico($(this), 0, 60, 0);
                });
            };

            $("#addrubro").click(function () {
                var iid = $(this).attr("iid");
                var w = $(window).width() - 100;
                //bloqueointerface();
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/rec_finanzas",
                    data: {'action': 'segotros', id: iid},
                    success: function (data) {
                        $.unblockUI();
                        if (data.result === 'ok') {
                            $("#rubrospanel_rubros").html(data.html);
                            $("#paneltitle").html("Conceptos de Cobro");
                            $("#rubrospanel").modal({"backdrop": "static", "width": w}).modal("show");
                            {#$("#rubrospanel").find(".selectorfecha").daterangepicker({ singleDatePicker: true, showDropdowns: true});#}
                            $("#rubrospanel").find(".selectorfecha").daterangepicker({
                                locale: {
                                    format: 'DD-MM-YYYY hh:mm A',
                                    daysOfWeek: [
                                        "Do",
                                        "Lu",
                                        "Ma",
                                        "Mi",
                                        "Ju",
                                        "Vi",
                                        "Sa"
                                    ],
                                    monthNames: [
                                        "Enero",
                                        "Febrero",
                                        "Marzo",
                                        "Abril",
                                        "Mayo",
                                        "Junio",
                                        "Julio",
                                        "Agosto",
                                        "Setiembre",
                                        "Octubre",
                                        "Noviembre",
                                        "Diciembre"
                                    ],
                                    cancelLabel: 'Limpiar',
                                    applyLabel: 'Aplicar'
                                },
                                opens: 'left',
                                singleDatePicker: true,
                            });
                            {#    .on('changeDate', function (ev) {#}
                            {#    $(this).datepicker('hide');#}
                            {# });#}
                            validanumeros();
                            conectar_adicionar();
                            $(".filterable tr:has(td)").each(function () {
                                var t = $(this).text().toLowerCase();
                                $("<td class='indexColumn'></td>").hide().text(t).appendTo(this);
                            });

                            $("#FilterTextBox").unbind().val('');

                            $("#FilterTextBox").keyup(function () {
                                var s = $(this).val().toLowerCase().split(" ");

                                $(".filterable tr:hidden").show();

                                $.each(s, function () {
                                    $(".filterable tr:visible .indexColumn:not(:contains('" + this + "'))").parent().hide();
                                }); //each

                                //$(".filterable tr:visible .indexColumn:not(:contains('" + s + "'))").parent().hide();
                                //$(".filterable3 tr:hidden").show();
                            });

                        } else {
                            {#smoke.alert(data.mensaje);#}
                            Swal.fire({
                                type: 'warning',
                                text: data.mensaje,
                            })
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        {#smoke.alert("Error de conexión.");#}
                        Swal.fire({
                            type: 'warning',
                            text: 'Error de conexión',
                        })
                    },
                    dataType: "json"
                });
            });

            {#$(".delmatricula").click(function() {#}
            {#    var iid = $(this).attr("iid");#}
            {#    bloqueointerface();#}
            {#    $.ajax({#}
            {#        type: "POST",#}
            {#        url: "/rec_finanzas",#}
            {#        data: {'action': 'delmatricula', id: iid},#}
            {#        success: function(data) {#}
            {#            $.unblockUI();#}
            {#            if (data.result=='ok'){#}
            {#                location.href = '/rec_finanzas?action=rubros&id={{ cliente.id }}';#}
            {#            } else {#}
            {#                smoke.alert(data.mensaje);#}
            {#            }#}
            {#        },#}
            {#        error: function() {#}
            {#            $.unblockUI();#}
            {#            smoke.alert("Error de conexión.");#}
            {#        },#}
            {#        dataType: "json"#}
            {#    });#}


            $(".addmatricula").click(function () {
                var iid = $(this).attr("iid");
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/rec_finanzas",
                    data: {'action': 'matriculas', id: {{ cliente.id }}, idr: iid},
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == 'ok') {
                            $("#paneltitle").html("Asignar Matricula");
                            $("#rubrospanel_rubros").html(data.html);
                            $("#rubrospanel").modal({"backdrop": "static", "width": "900px"}).modal("show");
                            $(".filterable tr:has(td)").each(function () {
                                var t = $(this).text().toLowerCase();
                                $("<td class='indexColumn'></td>").hide().text(t).appendTo(this);
                            });
                            $("#FilterTextBox").unbind().val('');
                            $("#FilterTextBox").keyup(function () {
                                var s = $(this).val().toLowerCase().split(" ");
                                $(".filterable tr:hidden").show();
                                $(".filterable tr:visible .indexColumn:not(:contains('" + s + "'))").parent().hide();
                                $(".filterable3 tr:hidden").show();
                            });
                            addmatricula();
                            let close_offcamvas = document.getElementById("close-offcanvas");
                            close_offcamvas.click();
                        } else {
                            {#smoke.alert(data.mensaje);#}
                            Swal.fire({
                            type: 'warning',
                            text: data.mensaje,
                        })
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        {#smoke.alert("Error de conexión.");#}
                        Swal.fire({
                            type: 'warning',
                            text: 'Error de conexión',
                        })
                    },
                    dataType: "json"
                });
            });

            $(".obserrubro").blur(function () {
                var elemento = $(this);
                var id = elemento.attr("idr");
                var va = elemento.attr('va');
                var texto = elemento.val();
                if (va != texto) {
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/rec_finanzas",
                        data: {'action': 'act_obser', 'id': id, 'valor': texto},
                        success: function (data) {
                            $.unblockUI();
                            if (data.result == 'ok') {
                                elemento.attr({'va': texto})
                            } else {
                                elemento.val(elemento.attr('va'));
                                {#smoke.alert(data.mensaje);#}
                                Swal.fire({
                                    type: 'warning',
                                    text: data.mensaje,
                                })
                            }
                        },
                        error: function () {
                            $.unblockUI();
                            elemento.val(elemento.attr('va'));
                            {#smoke.alert(data.mensaje);#}
                            {#smoke.alert("Error de conexión.");#}
                            Swal.fire({
                            type: 'warning',
                            title: 'Error de conexión',
                            text: data.mensaje,
                        })
                        },
                        dataType: "json"
                    });
                }
            });


            selectorrubro.prop("checked", false);
            todos.prop("checked", false);

            $(".otrosrubrosinput").blur(function () {
                numerico($(this), 0, 0, 2);
            });

            pagosrecibo = $("#pagosrecibo");

            $(".verpagos").click(function () {
                var id = $(this).attr('id');
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/rec_finanzas",
                    data: {'action': 'pagosderecibo', 'id': id},
                    success: function (data) {
                        $('#contenidotablarecibos').html('');
                        $.unblockUI();
                        if (data.result == 'ok') {
                            pagosrecibo.modal({width: "600px"}).modal('show');
                            for (x in data.lista) {
                                elemento = data.lista[x];
                                $('#contenidotablarecibos').append('<tr><td style="text-align: center">' + elemento.fecha + '</td><td style="text-align: center">' + elemento.valor + '</td></tr>');
                            }
                        } else {
                            {#smoke.alert(data.mensaje);#}
                            Swal.fire({
                            type: 'warning',
                            text: data.mensaje,
                        })
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        {#smoke.alert("Error al obtener los datos");#}
                        Swal.fire({
                            type: 'warning',
                            text: 'Error al obtener los datos',
                        })
                    },
                    dataType: "json"
                });
            });
            $(".eventoperiodoipec").click(function () {
                var id = $(this).attr("id");
                bloqueointerface();
                $.ajax({
                    type: "POST",
                    url: "/rec_finanzas",
                    data: {'action': 'eventoperiodoipec', id: {{ cliente.id }}, idr: id},
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == 'ok') {
                            $("#paneltitle_evento").html("Asignar Evento IPEC");
                            $("#panel_evento").html(data.html);
                            $("#eventopanel").modal({"backdrop": "static", "width": "900px"}).modal("show");
                            $(".filterable tr:has(td)").each(function () {
                                var t = $(this).text().toLowerCase();
                                $("<td class='indexColumn'></td>").hide().text(t).appendTo(this);
                            });
                            $("#FilterTextBox_evento").unbind().val('');
                            $("#FilterTextBox_evento").keyup(function () {
                                var s = $(this).val().toLowerCase().split(" ");
                                $(".filterable tr:hidden").show();
                                $(".filterable tr:visible .indexColumn:not(:contains('" + s + "'))").parent().hide();
                                $(".filterable3 tr:hidden").show();
                            });
                            addeventoperiodoipec();
                            let close_offcamvas = document.getElementById("close-offcanvas");
                            close_offcamvas.click();
                        } else {
                            {#smoke.alert(data.mensaje);#}
                            Swal.fire({
                            type: 'warning',
                            text: data.mensaje,
                        })
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        {#smoke.alert("Error de conexión.");#}
                        Swal.fire({
                            type: 'warning',
                            text: 'Error de conexión',
                        })
                    },
                    dataType: "json"
                });
            });
            $('#eventopanel_cerrar').click(function () {
                $("#eventopanel").modal('hide');
            });
            addeventoperiodoipec = function () {
                $(".btn-eventoperiodoipec").unbind();

                $(".btn-eventoperiodoipec").click(function () {
                    var eid = $(this).attr("eid");
                    var rid = $(this).attr("rid");
                    if (eid > 0) {
                        $("#eventopanel").modal("hide");
                        showWaiting("Registrando Evento IPEC", "Espere unos segundos por favor...");
                        $.ajax({
                            type: "POST",
                            url: "/rec_finanzas",
                            data: {'action': 'addeventoperiodoipec', 'eid': eid, 'rid': rid},
                            success: function (data) {
                                if (data.result == 'ok') {
                                    location.href = '/rec_finanzas?action=rubros&id={{ cliente.id }}';
                                } else {
                                    hideWaiting();
                                    {#smoke.alert(data.mensaje);#}
                                    Swal.fire({
                                        type: 'warning',
                                        text: data.mensaje,
                                    })
                                }
                            },
                            error: function () {
                                hideWaiting();
                                {#smoke.alert("Error de conexión.");#}
                                Swal.fire({
                                    type: 'warning',
                                    text: 'Error de conexión',
                                })
                            },
                            dataType: "json"
                        });
                    } else {
                        $("#vr" + tid).focus();
                    }
                });
            };

            $(".mostrardetalle_view").click(function () {
                $("#aprobarcerrar").css('display', 'none');
                var id = $(this).attr('ide');
                bloqueointerface();
                $.ajax({
                    type: "GET",
                    url: "/rec_finanzas",
                    data: {'action': 'verdetalleevento', 'id': id},
                    success: function (data) {
                        $.unblockUI();
                        if (data.result == 'ok') {
                            $(".panelbody").html(data.data);
                            $("#itemspanel").modal({backdrop: 'static', width: '900px'}).modal('show');
                        } else {
                            {#smoke.alert(data.mensaje);#}
                            Swal.fire({
                            type: 'warning',
                            text: data.mensaje,
                        })
                        }
                    },
                    error: function () {
                        $.unblockUI();
                        {#smoke.alert("Error de conexión.");#}
                        Swal.fire({
                            type: 'warning',
                            text: 'Error de conexión',
                        })
                    },
                    dataType: "json"
                });
            });
            $("#itemspanel .btn-cerrar").click(function () {
                $("#itemspanel").modal("hide");
                return false;
            });

            $(".quitarliquidado").click(function () {
                let id=$(this).attr('rid')
                 Swal.fire({
                        text: '¿Está seguro que desea remover liquidación de este rubro?',
                        title: "Esta acción es irreversible!",
                        type: 'info',
                        showCancelButton: true,
                        allowOutsideClick: false,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Si, deseo hacerlo',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.value) {
                            bloqueointerface();
                            $.ajax({
                                type: "POST",
                                url: "/rec_finanzas",
                                data: {'action': 'removeliquidacion', 'id': id},
                                success: function (data) {
                                    $.unblockUI();
                                    if (data.result === 'ok') {
                                       Swal.fire({
                                        type: 'success',
                                        text: '¡Liquidación removida!',
                                    }).then((result) => {
                                            if (result.value) {
                                                bloqueointerface();
                                                window.location.reload();
                                            }
                                        });
                                    } else {
                                        Swal.fire({
                                            type: 'warning',
                                            text: data.mensaje,
                                        })
                                    }
                                },
                                error: function (data) {
                                    $.unblockUI();
                                    Swal.fire({
                                        type: 'warning',
                                        text: data.mensaje,
                                    })
                                },
                                dataType: "json"
                            });

                        }
                    })
            });
        });

    </script>
    <link href="/static/css/offcanvas-options.css" rel="stylesheet">
{% endblock %}

{% block atras %}{% if nivel %}/matriculas?action=matricula&id={{ nivel.id }}{% else %}/rec_finanzas?id={{ cliente.id }}
{% endif %}{% endblock %}
{% block canvas %}
    <div class='row'>
        <div class='col-lg-12'>
            <div class="headtitle">
                <h3 class="texto-blue">{{ title }}</h3>
                 <h6>Cliente: {{ cliente }} </h6>
                 <h6>Cedula: {{ cliente.cedula }} </h6>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class='row'>
            <div class="col-sm-8">
                {% if perms.sagest.puede_adicionar_rubro %}
                    <a href="javascript:;" iid="{{ cliente.id }}" class="btn btn-success" id="addrubro"><i
                            class="fa fa-plus "></i> Rubro</a>
                {% endif %}
                {% if  perms.sagest.puede_reverso_rubro %}
                    <a href="javascript:;" class="btn btn-info" id="reverso"><i
                            class="fa fa-plus "></i> Reverso</a>
                {% endif %}

            </div>
        </div>
        <div class="card mb-4">
                 <div class="card-body border-top border-6 rounded-3 border-dark-info">
                     <div class="table-responsive">
                        <table class='table table-bordered table-striped'>
                        <thead class="cabecera_tabla">
                        <tr>
                            <th style="width: 20px; text-align: center;"><input type="checkbox" id="todos"></th>
                            {% if  perms.sagest.puede_reverso_rubro %}
                                <th style="width: 20px; text-align: center;"> Reverso <br><input type="checkbox" id="todos2">
                                </th>
                            {% endif %}
                            <th style="width: 200px; text-align: center;">Nombre</th>

{#                            <th style="width: 65px; text-align: center;">Vence</th>#}
                            <th style="width: 65px; text-align: center;">Valor</th>
                            <th style="width: 65px; text-align: center;">IVA % / Valor</th>
                            <th style="width: 65px; text-align: center;">Valor Total</th>
                            <th style="width: 65px; text-align: center;">Valor Anulado</th>
                            <th style="width: 65px; text-align: center;">Abono</th>
                            <th style="width: 65px; text-align: center;">Saldo</th>
                            <th style="width: 110px; text-align: center;">Detalles</th>
{#                            <th style="width: 45px; text-align: center;">Vencido</th>#}
{#                            <th style="width: 45px; text-align: center;">Cancelado</th>#}
                            <th style="width: 60px; text-align: center;">Pagos</th>
{#                            <th style="width: 50px; text-align: center;">Matric.</th>#}
                            <th style="width: 150px; text-align: center;">Observaci&oacute;n</th>
                            <th style="width: 20px;"></th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for rubro in rubros %}
                            <tr>
                                {% if perms.sagest.puede_reverso_rubro %}
                                    <td style="text-align: center;">
                                {% endif %}
                                {% if not perms.sagest.puede_reverso_rubro %}
                                    {% if rubro.bloqueado %}
                                        <td style="text-align: center">
                                            <label class="label label-important">Este rubro tiene bloqueo</label>
                                        </td>
                                    {% endif %}
                                    {% if not rubro.bloqueado %}
                                        <td style="text-align: center;">
                                    {% endif %}
                                {% endif %}

                                {% if not rubro.bloqueado %}
                                        {% if not rubro.esta_anulado %}
                                            {% if not rubro.cancelado %}
                                                {% if not rubro.epunemi %}
                                                    {% if tiene_nota_debito %}
                                                        {% if rubro.es_notadebito %}
                                                                <input type="checkbox" class="selectorrubro" rid="{{ rubro.id }}"
                                                                       deuda='{{ rubro.total_adeudado }}'
                                                                       anio="{{ rubro.anio_vence }}"/>

                                                        {% endif %}
                                                    {% else %}
                                                            <input type="checkbox" class="selectorrubro" rid="{{ rubro.id }}"
                                                                   deuda='{{ rubro.total_adeudado }}' iva="{{ rubro.valoriva }}"
                                                                   anio="{{ rubro.anio_vence }}"/>
                                                    {% endif %}
                                                {% endif %}
                                            {% endif %}
                                        {% endif %}
                                {% endif %}
                                {% if rubro.bloqueado %}
                                    <a hidden></a>
                                {% endif %}
                                </td>
                            {% if not rubro.bloqueado %}
                                    {% if  perms.sagest.puede_reverso_rubro %}
                                        <td style="text-align: center">
                                            {% if not rubro.cancelado %}
                                                {% if rubro.epunemi %}
                                                    <input type="checkbox" class="selectorrubro2"
                                                           rid="{{ rubro.id }}"
                                                           deuda='{{ rubro.total_adeudado }}'
                                                           anio="{{ rubro.anio_vence }}"/>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                    {% endif %}
                            {% endif %}
                            {% if perms.sagest.puede_reverso_rubro %}
                                {% if rubro.bloqueado %}
                                    <td style="text-align: center">
                                        <label class="label label-important">Este rubro tiene bloqueo</label>
                                    </td>

                                {% endif %}
                            {% endif %}


                                <td style="width: 1000px;">
                                    <b>Código:</b> {{ rubro.id }} | <b>Fecha:</b> {{ rubro.fecha|date:"d-m-Y" }} | <b>Vence: </b> {{ rubro.fechavence|date:"d-m-Y" }}
                                | <b>Contrato: </b>{% if rubro.contratorecaudacion %}{{ rubro.contratorecaudacion.numero }}{% endif %}<br>
                                    {{ rubro.nombre }}

                                    <b>Tipo:</b>
                                    {% if rubro.mostrar_tipo %}
                                    {{ rubro.mostrar_tipo }} {% endif %}  {% if rubro.capeventoperiodoipec %}
                                    <a class="btn btn-mini btn-info mostrardetalle_view tu" href="javascript:;"
                                       ide="{{ rubro.capeventoperiodoipec.id }}"><i class="fa fa-list"></i></a> {% endif %}
                                    {% if rubro.epunemi %}<label class="label label-success">RUBRO DE
                                        EPUNEMI {{ rubro.idrubroepunemi }}</label>{% endif %} {% if rubro.esta_liquidado %}<br>
                                        <label class="label label-important">LIQUIDADO</label><br>
                                    <b>Motivo de liquidación:</b> {{ rubro.liquidacion.motivo }} {% endif %} <br> <strong>Usuario:</strong>
                                    {% if not rubro.usuario.id == 1 %}{{ rubro.nombre_usuario|default_if_none:'' }}{% endif %}

                                    {% if rubro.matricula %}
                                        {% if rubro.matricula.inscripcion %}
                                            <br><strong>Matrícula:</strong>
                                            {{ rubro.matricula.inscripcion.carrera|default_if_none:'' }}
                                        {% endif %}
                                        <span class="badge bg-dark" data-bs-placement="right" data-bs-toggle="tooltip" data-bs-html="true" title="Es rubro de matriculación"> Matricula</span>
                                    {% endif %}


                                </td>


{#                                <td style="text-align: center;">{{ rubro.fechavence|date:"d-m-Y" }}</td>#}
                                <td style="text-align: right;">$ {{ rubro.valor|floatformat:2 }}</td>
                                <td style="text-align: center;">{% if rubro.iva.porcientoiva %}({{ rubro.iva.descripcion }}
                                    ){% endif %} {% if rubro.iva.porcientoiva %} - $ {{ rubro.valoriva }}{% endif %}</td>
                                <td style="text-align: right;">$ {{ rubro.valortotal|floatformat:2 }}</td>
                                <td style="text-align: right;">$ {{ rubro.valores_anulados|floatformat:2 }}</td>
                                <td style="text-align: right;">$ {{ rubro.total_pagado|floatformat:2 }}</td>
                                <td style="text-align: right;"><b>$ {{ rubro.total_adeudado|floatformat:2 }}</b></td>
                                <td><b>Vencido: </b> {% if rubro.vencido %}
                                    <span class="label label-important">Si</span>
                                {% else %}
                                    <span class='label label-success'>No</span>
                                {% endif %} <br>
                                <b>Cancelado: </b> {% if rubro.cancelado %}
                                        <span class="label label-success">Si</span>
                                    {% else %}
                                        <span class='label label-important'>No</span>
                                    {% endif %}

                                </td>
{#                                <td style="text-align: center;">#}
{#                                    {% if rubro.vencido %}#}
{#                                        <span class="label label-important">Si</span>#}
{#                                    {% else %}#}
{#                                        <span class='label label-success'>No</span>#}
{#                                    {% endif %}#}
{#                                </td>#}
{#                                <td style="text-align: center;">#}
{#                                    {% if rubro.cancelado %}#}
{#                                        <span class="label label-success">Si</span>#}
{#                                    {% else %}#}
{#                                        <span class='label label-important'>No</span>#}
{#                                    {% endif %}#}
{#                                </td>#}
                                <td style="text-align: center;">
                                    <a href="/rec_finanzas?action=pagos&id={{ rubro.id }}" data-bs-toggle="tooltip"
                                       data-bs-html="true" title=" {% if rubro.cantidad_pagos == 0 %}No tiene ningún pago realizado {% else %}Tiene un total de {{ rubro.cantidad_pagos }} {% if rubro.cantidad_pagos > 1 %}pagos realizados{% else %}pago realizado{% endif %}{% endif %}"
                                       class="btn btn-mini btn-info">{{ rubro.cantidad_pagos }} Pagos</a>
                                </td>
{#                                <td style="text-align: center">#}
{#                                    {% if rubro.matricula %}#}
{#                                        <i class="fa fa-check"></i>#}
{#                                    {% endif %}#}
{#                                </td>#}
                                <td>
                                    <textarea rows="2" class="input-block-level obserrubro" style="text-transform: uppercase"
                                              {% if 'INGLÉS' in rubro.observacion %}disabled="disabled"{% endif %}
                                              va="{{ rubro.obervacion }}"
                                              idr="{{ rubro.id }}">{{ rubro.observacion|default_if_none:'' }}</textarea>
                                </td>
                                <td>

                                    {% if rubro.esta_anulado %}
                                        <label class="label label-important">ANULADO</label>
                                    {% endif %}
                                {% if rubro.esta_liquidado and perms.sagest.puede_reverso_liquidacion %}
                                    <div class="text-center">
                                        <div class="dropdown dropstart">
                                            <a class="btn-icon btn btn-ghost btn-sm rounded-circle"
                                               href="javascript:void(0)" id="dropdownTask1" data-bs-toggle="dropdown"
                                               aria-haspopup="true" aria-expanded="false">
                                                <i class="fa fa-ellipsis-v"></i>
                                            </a>
                                            <div class="dropdown-menu">
                                                <a class="dropdown-item d-flex align-items-center quitarliquidado"
                                                   rid="{{ rubro.id|encrypt }}" href="javascript:;">
                                                    <i class="fas fa-trash"></i>&nbsp;Remover liquidación
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}


                                    {#                            {% if not rubro.epunemi %}#}
                                    {% if not rubro.matricula or not rubro.cancelado and not rubro.bloqueado %}
                                            {% if not rubro.bloqueado %}
                                                <div class="text-center">
                                                    <button class="btn-icon btn btn-ghost btn-sm rounded-circle"
                                                            type="button" data-bs-toggle="offcanvas"
                                                            data-bs-target="#offcanvasRight_{{ rubro.id }}"
                                                            aria-controls="offcanvasRight"><i class="fa fa-ellipsis-v"></i>
                                                    </button>
                                                </div>
                                                <div class="offcanvas offcanvas-end" tabindex="-1"
                                                     id="offcanvasRight_{{ rubro.id }}"
                                                     aria-labelledby="offcanvasRightLabel">
                                                    <div class="offcanvas-header">
                                                        <h2 id="offcanvasRightLabel"><span
                                                                style="margin-right: 10px;"><i class="fas fa-cogs"></i></span>
                                                            Acciones</h2>
                                                        <button type="button" class="btn-close text-reset" id="close-offcanvas"
                                                                data-bs-dismiss="offcanvas" aria-label="Close"></button>
                                                    </div>

                                                    <div class="offcanvas-body"
                                                         style="padding-top: 1rem; padding-bottom: 1rem">
{#                                                        {% if rubro.tipo.id == rubro_arancel and not rubro.tiene_pagos %}#}
{#                                                        <a href="javascript:;"#}
{#                                                           nhref="/rec_finanzas?action=diferirarancel&rid={{ rubro.id }}"#}
{#                                                           class="confirmacionmodal"><h4 class="mb-0"><i class="fa fa-plus "></i> Diferir Arancel</h4>#}
{#                                                        </a>#}
{#                                                        {% endif %}#}
                                                        {% if not rubro.cancelado %}
                                                            {% if perms.sagest.puede_modificar_rubro %}
                                                                {% if not rubro.matricula or rubro.cohortemaestria %}
                                                                    <a href="/rec_finanzas?action=editrubro&id={{ rubro.id }}">
                                                                        <h4 class="mb-0"><i class="fa fa-edit "></i> Fecha Vencimiento</h4></a>

                                                                    <a href="/rec_finanzas?action=editrubrovalor&id={{ rubro.id }}">
                                                                        <h4 class="mb-0"><i class="fa fa-edit "></i> Valor</h4></a>
                                                                {% endif %}
                                                            {% else %}
                                                                {% if perms.sagest.puede_editar_rubro_posgrado %}
                                                                    {% if not rubro.solicitud %}
                                                                        {% if not rubro.matricula or rubro.cohortemaestria %}
                                                                            <a href="/rec_finanzas?action=editrubro&id={{ rubro.id }}">
                                                                                <h4 class="mb-0"><i
                                                                                        class="fa fa-edit "></i> Fecha
                                                                                    Vencimiento</h4></a>

                                                                            <a href="/rec_finanzas?action=editrubrovalor&id={{ rubro.id }}">
                                                                                <h4 class="mb-0"><i
                                                                                        class="fa fa-edit "></i> Valor
                                                                                </h4></a>
                                                                        {% endif %}
                                                                    {% endif %}
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if perms.sagest.puede_modificar_rubro %}
                                                                <a href="/rec_finanzas?action=liquidar&id={{ rubro.id }}">
                                                                    <h4 class="mb-0"><i class="fa fa-list"></i> Liquidar
                                                                    </h4></a>
                                                            {% else %}
                                                                {% if perms.sagest.puede_editar_rubro_posgrado %}
                                                                    {% if not rubro.solicitud %}
                                                                        <a href="/rec_finanzas?action=liquidar&id={{ rubro.id }}">
                                                                            <h4 class="mb-0"><i class="fa fa-list"></i> Liquidar
                                                                            </h4></a>
                                                                    {% endif %}
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if asesorfinancieroposgrado and rubro.tipo.id == 3634 %}
                                                                <a href="/rec_finanzas?action=liquidarconvenioposgrado&id={{ rubro.id }}">
                                                                        <h4 class="mb-0"><i class="fa fa-list"></i> Liquidar posgrado
                                                                        </h4></a>
                                                            {% endif %}

                                                            {% if not rubro.tiene_pagos and perms.sagest.puede_modificar_rubro %}
                                                                <a href="/rec_finanzas?action=editnombrerubro&id={{ rubro.id }}">
                                                                    <h4 class="mb-0"><i class="fa fa-edit "></i> Editar Nombre</h4></a>
                                                                <a class="eliminacionmodal" href="javascript:;"
                                                                   nhref="/rec_finanzas?action=delrubro&id={{ rubro.id }}">
                                                                    <h4 class="mb-0"><i class="fa fa-remove "></i>
                                                                        Eliminar</h4></a>
                                                            {% else %}
                                                                {% if not rubro.tiene_pagos and perms.sagest.puede_editar_rubro_posgrado %}
                                                                    {% if not rubro.solicitud %}
                                                                        <a href="/rec_finanzas?action=editnombrerubro&id={{ rubro.id }}">
                                                                            <h4 class="mb-0"><i class="fa fa-edit "></i>
                                                                                Editar Nombre</h4></a>
                                                                        <a class="eliminacionmodal" href="javascript:;"
                                                                           nhref="/rec_finanzas?action=delrubro&id={{ rubro.id }}">
                                                                            <h4 class="mb-0"><i
                                                                                    class="fa fa-remove "></i>
                                                                                Eliminar</h4></a>
                                                                    {% endif %}
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endif %}
{#                                                        {% if not rubro.matricula %}#}
{#                                                            <a class="addmatricula" href="javascript:;"#}
{#                                                                   iid="{{ rubro.id }}">#}
{#                                                                <h4 class="mb-0"><i class="fa fa-check "></i> Asignar Matricula</h4></a>#}
{#                                                        {% else %}#}
{#                                                            <a href="javascript:;"#}
{#                                                                   nhref="/rec_finanzas?action=delmatricula&id={{ rubro.id }}"#}
{#                                                                   class="eliminacionmodal"><h4 class="mb-0"><i#}
{#                                                                    class="fa fa-check-square "></i> Quitar#}
{#                                                                Matricula</h4></a>#}
{#                                                        {% endif %}#}
{#                                                        {% if not rubro.capeventoperiodoipec %}#}
{#                                                            <a class="eventoperiodoipec" href="javascript:;"#}
{#                                                                   id="{{ rubro.id }}"><h4 class="mb-0"><i#}
{#                                                                    class="fa fa-check "></i> Asignar Evento IPEC</h4></a>#}
{#                                                        {% endif %}#}
                                                    </div>
                                                </div>
                                            {% endif %}
                                    {% endif %}
                                    {#                            {% endif %}#}
                                </td>
                            </tr>
                        {% endfor %}
                        {% if not rubros %}
                            <tr>
                                <td colspan="{% if  perms.sagest.puede_reverso_rubro %}16{% else %}15{% endif %}">NO EXISTEN RUBROS</td>
                            </tr>
                        {% endif %}
                        </tbody>
                        <tfoot>
                        <tr>
                            <td colspan="{% if  perms.sagest.puede_reverso_rubro %}8{% else %}7{% endif %}">
                                 {% if puede_pagar %}
                                <div style="width: 400px;float: left;">
                                        <a href="javascript:;" tdoc="F" id="ingresarpago"
                                           class="btn btn-success btn-huge ingresarpago"><i class="fa fa-plus "></i> INGRESAR
                                            PAGO</a>
                                        <a href="javascript:;" tdoc="R" id="ingresarpagoanioanterior"
                                           class="btn btn-warning btn-huge ingresarpago"><i class="fa fa-plus "></i> INGRESAR
                                            PAGO AÑO ANTERIOR</a>
                                   <br>
                                    {#                            <a  href="javascript:;" id="generarrecibo" class="btn btn-success tu">GENERAR RECIBO</a>#}
                                </div> {% endif %}
                                <div id='porpagar' style="font-size: 40px; width: 250px; float: left; margin-top: 5px">$ 0.00
                                </div>
                            </td>
                            <td style="text-align: right;">$ {{ cliente.total_rubros|floatformat:2 }}</td>
                            <td style="text-align: right;">$ {{ cliente.valores_anulados|floatformat:2 }}</td>
                            <td style="text-align: right;">$ {{ cliente.total_pagado|floatformat:2 }}</td>
                            <td style="text-align: right;"><b>$ {{ cliente.total_adeudado|floatformat:2 }}</b></td>
                            <td colspan="4"></td>
                        </tr>
                        </tfoot>
                    </table>
                    </div>
            </div>
        </div>
{#        <div class='row-fluid'>#}
{#            <div class="span12">#}
{#                <div class='pagination'>#}
{#                    <ul>#}
{#                        {% for pagenumber in paging.page_range %}#}
{#                            <li {%  if pagenumber == page.number %}class='active'{% endif %}><a#}
{#                                    href="/rec_finanzas?action=rubros&id={{ cliente.id }}&page={{ pagenumber }}">{{ pagenumber }}</a>#}
{#                            </li>#}
{#                        {% endfor %}#}
{#                    </ul>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
                <div class="card-footer border-top-0">
                {% include 'paginacionb4.html' %}
            </div>
    </div>
    <div class="modal fade static" id="rubrospanel">
        <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="paneltitle"></h3>
                </div>
                <div class="modal-body">
                    <input type="text" id="FilterTextBox" class="input-block-level">
                    <div style="max-height: 400px; overflow: auto">
                        <table id="rubrospanel_rubros"
                               class="table table-bordered table-striped table-condensed filterable">
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="javascript:;" id="rubrospanel_cerrar" class="btn btn-info">Cerrar</a>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade static" id="eventopanel">
        <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="paneltitle_evento"></h3>
                </div>
                <div class="modal-body">
                    <input type="text" id="FilterTextBox_evento" class="input-block-level">
                    <div style="max-height: 400px; overflow: auto">
                        <table id="panel_evento" class="table table-bordered table-striped table-condensed filterable">
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="javascript:;" id="eventopanel_cerrar" class="btn btn-info">Cerrar</a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade static" id="itemspanel" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="paneltitle">Mostrar detalles de planificación</h3>
                </div>
                <div class="modal-body panelbody">
                </div>
                <div class="modal-footer">
                    <table class="pull-right">
                        <tr>
                            <td id="aprobarcerrar"><a href="javascript:;" class="btn btn-aprobarcerrar btn-success">
                                Guardar</a>
                            </td>
                            <td><a href="javascript:;" class="btn btn-cerrar btn-info">Cerrar</a></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
