{% extends "base.html" %}
{% load sga_extras %}
{% load humanize %}
{% block heading %}
    <link href="/static/bootstrap5/libs/datepicker/css/bootstrap-datepicker.css" rel="stylesheet">
    <script src="/static/bootstrap5/libs/datepicker/js/bootstrap-datepicker.js"> </script>
    <script type="text/javascript" src="/static/ckeditor/ckeditor-init.js"></script>
    <script type="text/javascript" src="/static/ckeditor/ckeditor/ckeditor.js"></script>
    <style>
        @media (max-width: 575px) {
            .border-top {
                border-top: 1px solid #424242;
            }
            .border-left {
                border-left: 1px solid #424242;
            }
            .border-bottom {
                border-bottom: 1px solid #424242;
            }
            .border-right {
                border-right: 1px solid #424242;
            }
            .border-top-0 {
                border-top: none!important;
            }
            .border-left-0 {
                border-left: none!important;
            }
            .border-bottom-0 {
                border-bottom: none!important;
            }
            .border-right-0 {
                border-right: none!important;
            }
        }

        @media (min-width: 576px) {
            .border-sm-top {
                border-top: 1px solid #424242;
            }
            .border-sm-left {
                border-left: 1px solid #424242;
            }
            .border-sm-bottom {
                border-bottom: 1px solid #424242;
            }
            .border-sm-right {
                border-right: 1px solid #424242;
            }
            .border-sm-top-0 {
                border-top: none!important;
            }
            .border-sm-left-0 {
                border-left: none!important;
            }
            .border-sm-bottom-0 {
                border-bottom: none!important;
            }
            .border-sm-right-0 {
                border-right: none!important;
            }
        }

        @media (min-width: 768px) {
            .border-md-top {
                border-top: 1px solid #424242;
            }
            .border-md-left {
                border-left: 1px solid #424242;
            }
            .border-md-bottom {
                border-bottom: 1px solid #424242;
            }
            .border-md-right {
                border-right: 1px solid #424242;
            }
            .border-md-top-0 {
                border-top: none!important;
            }
            .border-md-left-0 {
                border-left: none!important;
            }
            .border-md-bottom-0 {
                border-bottom: none!important;
            }
            .border-md-right-0 {
                border-right: none!important;
            }
        }

        @media (min-width: 992px) {
            .border-lg-top {
                border-top: 1px solid #424242;
            }
            .border-lg-left {
                border-left: 1px solid #424242;
            }
            .border-lg-bottom {
                border-bottom: 1px solid #424242;
            }
            .border-lg-right {
                border-right: 1px solid #424242;
            }
            .border-lg-top-0 {
                border-top: none!important;
            }
            .border-lg-left-0 {
                border-left: none!important;
            }
            .border-lg-bottom-0 {
                border-bottom: none!important;
            }
            .border-lg-right-0 {
                border-right: none!important;
            }
        }

        @media (min-width: 1200px) {
            .border-xl-top {
                border-top: 1px solid #424242;
            }
            .border-xl-left {
                border-left: 1px solid #424242;
            }
            .border-xl-bottom {
                border-bottom: 1px solid #424242;
            }
            .border-xl-right {
                border-right: 1px solid #424242;
            }
            .border-xl-top-0 {
                border-top: none!important;
            }
            .border-xl-left-0 {
                border-left: none!important;
            }
            .border-xl-bottom-0 {
                border-bottom: none!important;
            }
            .border-xl-right-0 {
                border-right: none!important;
            }
        }
    </style>

    <script type="text/javascript">

        let justificacion, objetivo, contenido, resultado;

        const openAddFacilitador = function (action, title){
            bloqueointerface();
            $.ajax({
                type: "GET",
                url: `{{ request.path }}`,
                data: {
                    'action': action,
                    'id': '{{ eCapSolicitudNecesidad.pk|encrypt }}'
                },
                success: function (data) {
                    $.unblockUI();
                    if (data.result === true) {
                        $('.modal-body', $("#modalFacilitador")).html(data.html);
                        $("#modalLabelFacilitador", $("#modalFacilitador")).html(title);
                        $("#modalFacilitador").modal({backdrop: 'static', }).modal('show');
                        //$('#id_supervisor', $("#modalAddEditFechaPlanificacion")).trigger('change');
                    } else {
                        mensajeDanger(data.message);
                    }
                },
                error: function () {
                    $.unblockUI();
                    mensajeDanger("Error de conexión.");
                },
                dataType: "json"
            });
        };

        const actionDeleteFacilitador = (id, permission, app, mensaje) => {
            var question = `Al eliminar el registro no podra volver a recuperar los datos. <br>¿Está seguro de eliminar el registro <span class="label label-warning">${mensaje}</span>?`;
            Confirm.question(question, function () {
                bloqueointerface();
                var aData = {"action": "deleteFacilitador", 'id': id}
                $.ajax({
                    type: "POST",
                    url: `{{ request.path }}`,
                    data: aData,
                    success: function(data) {
                        if (data.result) {
                            $.unblockUI();

                            Swal.fire({
                                title: `NOTIFICACIÓN`,
                                text: data.message,
                                type: 'success',
                                icon: 'success',
                                showCancelButton: false,
                                allowOutsideClick: false,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Aceptar',
                                cancelButtonText: 'Cancelar'
                            }).then((result) => {
                                if (result.value) {
                                    $("#contenedor_facilitadores").html(data.html);
                                }
                            }).catch(error => {
                                NotificationJG.error(error);
                                $.unblockUI();
                            });
                        }
                        else{
                            NotificationJG.error(data.message);
                            $.unblockUI();
                        }

                    },
                    error: function() {
                        $.unblockUI();
                        NotificationJG.error("Error al enviar los datos.");
                    },
                    dataType: "json",
                });
            }, function () {
                NotificationJG.info("Enhorabuena el registro esta salvado.!");

            });

        }

        const saveSolicitudNecesidadWriteDraft = function (loading/*=false*/){
            if (loading){
                bloqueointerface();
            }
            $(".btn-firmar").addClass('hidden');
            $("#text_loading").removeClass('hidden');
            $("#text_loading").addClass('text-warning');
            $("#text_loading").addClass('fw-bold');
            $("#text_loading").html('<i class="fa fa-spinner fa-pulse fa-1x fa-fw" ></i> Guardando...');
            let formdata = new FormData($("#frmSolicitud")[0]);
            //formdata.delete('tema');
            formdata.delete('justificacion');
            formdata.delete('objetivo');
            formdata.delete('contenido');
            formdata.delete('resultado');
            formdata.delete('desde');
            formdata.delete('hasta');
            formdata.append('tema', $("#id_tema").val());
            formdata.append('justificacion', justificacion.getData());
            formdata.append('objetivo', objetivo.getData());
            formdata.append('contenido', contenido.getData());
            formdata.append('resultado',  resultado.getData());
            formdata.append('desde', $("#id_desde").val());
            formdata.append('hasta', $("#id_hasta").val());
            $.ajax({
                type: "POST",
                url: "{{ request.path }}",
                data: formdata,
                success: function (data) {
                    $.unblockUI();
                    /*if (data.result) {
                        alertaSuccess('Se guardo correctamente')
                    } else {
                        alertaDanger(data.message);
                    }*/
                    $("#text_loading").addClass('hidden');
                    $(".btn-firmar").removeClass('hidden');
                },
                error: function () {
                    $.unblockUI();
                    alertaDanger("Error de conexión.");
                    $("#text_loading").addClass('hidden');
                    $(".btn-firmar").removeClass('hidden');
                },
                dataType: "json",
                cache: false,
                contentType: false,
                processData: false
            });
        };

        const saveSolicitudNecesidad = async function (firmar/*=false*/){
            bloqueointerface();
            let formdata = new FormData($("#frmSolicitud")[0]);
            formdata.append('action', 'saveSolicitudNecesidad');
            formdata.delete('tema');
            formdata.delete('justificacion');
            formdata.delete('objetivo');
            formdata.delete('contenido');
            formdata.delete('resultado');
            formdata.delete('desde');
            formdata.delete('hasta');
            formdata.append('tema', $("#id_tema").val());
            formdata.append('justificacion', justificacion.getData());
            formdata.append('objetivo', objetivo.getData());
            formdata.append('contenido', contenido.getData());
            formdata.append('resultado', resultado.getData());
            formdata.append('desde', $("#id_desde").val());
            formdata.append('hasta', $("#id_hasta").val());
            $.ajax({
                type: "POST",
                url: "{{ request.path }}",
                data: formdata,
                success: async function (data) {
                    $.unblockUI();
                    if (data.result) {
                        if (firmar === true){
                            //alertaSuccess('Se guardo correctamente')
                            console.log("Se guardo correctamente");
                            await openModalFirma('loadFormFirma', 'Legalizar solicitud por director/a de carrera');
                        }else{
                            Swal.fire({
                                allowOutsideClick: false,
                                allowEscapeKey: false,
                                allowEnterKey: false,
                                type: 'success',
                                customClass: {
                                    confirmButton: 'btn btn-info'
                                },
                                title: 'Exitoso',
                                text: 'Registro guardado correctamente.',
                                confirmButtonText: 'Aceptar',
                            }).then((result) => {
                                if (result.value) {
                                    bloqueointerface();
                                    location.reload();
                                }
                            })
                        }
                    } else {
                        alertaDanger(data.message);
                    }
                },
                error: function () {
                    $.unblockUI();
                    alertaDanger("Error de conexión.");

                },
                dataType: "json",
                cache: false,
                contentType: false,
                processData: false
            });
        };

        const actionFirmar = async function(){

        }

        const openModalFirma = async function (action, title){
            bloqueointerface();
            $.ajax({
                type: "GET",
                url: `{{ request.path }}`,
                data: {
                    'action': action,
                    'action_x': 'firmaDirectorSolicitudNecesidad',
                    'modal_x': 'modalFirmaDocumento',
                    'id': '{{ eCapSolicitudNecesidad.pk|encrypt }}'
                },
                success: function (data) {
                    $.unblockUI();
                    if (data.result === true) {
                        $('.modal-body', $("#modalFirmaDocumento")).html(data.data.html);
                        if (data.data.tipo === 'uploadDocumento'){
                            $('.action-firmar', $("#modalFirmaDocumento")).html('Subir');
                        }
                        $("#modalLabelFirmaDocumento", $("#modalFirmaDocumento")).html(title);
                        $("#modalFirmaDocumento").modal({backdrop: 'static', }).modal('show');
                        $("#frmFirma", $("#modalFirmaDocumento")).validationEngine({autoHidePrompt:true, autoHideDelay:1000 });
                    } else {
                        mensajeDanger(data.message);
                    }
                },
                error: function () {
                    $.unblockUI();
                    mensajeDanger("Error de conexión.");
                },
                dataType: "json"
            });
        };


        const actionGuardarFirmar = async function (){
            await saveSolicitudNecesidad(true);
        };



        $(function() {
            {% if eCapSolicitudNecesidad.tiene_estado_borrador  %}
                const configCKEDITOR = {
                    language: 'es',
                    width: '100%',
                    height: 200,
                    resize_enabled: false,
                    toolbarGroups: [
                        { name: 'styles' },
                        { name: 'basicstyles' },
                        { name: 'undo' },
                        { name: 'listindentalign',  groups: [ 'list', 'indent', 'align' ] },
                        { name: 'links' },
                        { name: 'insert' },
                        { name: 'tools' },
                        { name: 'mode' }
                    ],
                    removeButtons: 'Image,Flash'
                };
                //tema = CKEDITOR.replace('tema', {...configCKEDITOR});
                justificacion = CKEDITOR.replace('justificacion', {...configCKEDITOR});
                objetivo = CKEDITOR.replace('objetivo', {...configCKEDITOR});
                contenido = CKEDITOR.replace('contenido', {...configCKEDITOR});
                resultado = CKEDITOR.replace('resultado', {...configCKEDITOR});
                /*tema.on('blur',async function(){
                    //console.log("test");
                    await saveSolicitudNecesidadWriteDraft(false);
                });*/
                justificacion.on('blur',async function(){
                    //console.log("test");
                    await saveSolicitudNecesidadWriteDraft(false);
                });
                objetivo.on('blur',async function(){
                    //console.log("test");
                    await saveSolicitudNecesidadWriteDraft(false);
                });
                contenido.on('blur',async function(){
                    //console.log("test");
                    await saveSolicitudNecesidadWriteDraft(false);
                });
                resultado.on('blur',async function(){
                    //console.log("test");
                    await saveSolicitudNecesidadWriteDraft(false);
                });
            {% endif %}
            $(".tl").tooltip({position:"center up"});
            $('#id_desde, #id_hasta').datepicker({
                autoclose: true,
                clearBtn: true,
                format:"dd/mm/yyyy"
            });

            const id_tema = document.getElementById("id_tema");
            const smallTemaCaracteres = document.getElementById("small_tema_caracteres");

            // Agrega un evento de escucha al textarea para rastrear los cambios en el contenido
            if (id_tema != undefined){
                id_tema.addEventListener("input", function () {
                    const contenido = id_tema.value;
                    const caracteresRestantes = 1000 - contenido.length;

                    // Actualiza el texto en el elemento small
                    smallTemaCaracteres.textContent = `Máximo 1000 caracteres. Quedan ${caracteresRestantes} caracteres.`;
                });
            }
            {% if eCapSolicitudNecesidad.tiene_estado_borrador %}
                $("#id_tema, #id_carrera, #id_area, #id_subarea, #id_campo_detallado, #id_justificacion, #id_num_horas_referida, #id_capacidad_participante, #id_modalidad, #id_desde, #id_hasta").change(async function(){
                    await saveSolicitudNecesidadWriteDraft(false);
                });
            {% endif %}

            /*$("#id_area, #id_subarea, #id_campo_detallado").select2({
                width: '100%',
                'placeholder': 'Seleccione un item'
            })*/



            $("#id_area").change(async function () {
                var area_id = $(this).val();
                var _subarea_id = parseInt('{% if eCapSolicitudNecesidad.subarea %}{{ eCapSolicitudNecesidad.subarea_id }}{% else %}{{ 0 }}{% endif %}')
                var _area_id = parseInt('{% if eCapSolicitudNecesidad.area %}{{ eCapSolicitudNecesidad.area_id }}{% else %}{{ 0 }}{% endif %}')
                await $("#id_subarea").empty();
                await $("#id_subarea").append('<option class="fs-6" selected="selected" value="0">Selecciona un subárea</option>');
                await $("#id_campo_detallado").empty();
                await $("#id_campo_detallado").append('<option class="fs-6" selected="selected" value="0">Selecciona un campo detallado</option>');
                if (area_id) {
                    bloqueointerface();
                    $.ajax({
                        type: "GET",
                        url: "{{ request.path }}",
                        data: {"action": "loadSubArea", "idarea": area_id},
                        success: async function (data) {
                            $.unblockUI();
                            if (data.result) {
                                await $("#id_subarea").empty();
                                await $("#id_subarea").append('<option class="fs-6" selected="selected" value="0">Selecciona un subárea</option>');
                                for (x = 0; x < data.data.length; x++) {
                                    elemento = data.data[x];
                                    await $("#id_subarea").append('<option class="fs-6" value="' + elemento[0] + '">' + elemento[1] + '</option>');
                                }

                                if (data.data.length == 1) {
                                    await $("#id_subarea").prop("selectedIndex", 1).trigger("change");
                                }
                                if (_area_id == area_id && _subarea_id !=0 ){
                                    await $("#id_subarea").val(_subarea_id).trigger("change");
                                }


                            } else {
                                await $("#id_subarea").prop("selectedIndex", 1).trigger("change");
                            }
                        },
                        error: function () {
                            $.unblockUI();
                            $("#id_subarea").val(0).trigger("change");
                            smoke.alert("Error de conexión.");
                        },
                        dataType: "json"
                    });
                }
            });

            $("#id_subarea").change(function () {
                $("#id_campo_detallado").empty();
                $("#id_campo_detallado").append('<option class="fs-6" selected="selected" value="0">Selecciona un campo detallado</option>');
                var idsubarea = $(this).val();
                var _subarea_id = parseInt('{% if eCapSolicitudNecesidad.subarea %}{{ eCapSolicitudNecesidad.subarea_id }}{% else %}{{ 0 }}{% endif %}')
                var _campo_id = parseInt('{% if eCapSolicitudNecesidad.campo_detallado %}{{ eCapSolicitudNecesidad.campo_detallado_id }}{% else %}{{ 0 }}{% endif %}')
                if (idsubarea) {
                    bloqueointerface();
                    $.ajax({
                        type: "GET",
                        url: "{{ request.path }}",
                        data: {"action": "loadCampoDetallado", "idsubarea": idsubarea},
                        success: async function (data) {
                            $.unblockUI();
                            if (data.result) {
                                $("#id_campo_detallado").empty();
                                $("#id_campo_detallado").append('<option class="fs-6" selected="selected" value="0">Selecciona un campo detallado</option>');
                                for (x = 0; x < data.data.length; x++) {
                                    elemento = data.data[x];
                                    $("#id_campo_detallado").append('<option class="fs-6" value="' + elemento[0] + '">' + elemento[1] + '</option>');
                                }
                                if (data.data.length == 1) {
                                    $("#id_campo_detallado").prop("selectedIndex", 1).trigger("change");
                                }

                                if (_subarea_id == idsubarea && _campo_id !=0 ){
                                    await $("#id_campo_detallado").val(_campo_id).trigger("change");
                                }

                            } else {
                                $("#id_campo_detallado").val(0).trigger("change");
                            }
                        },
                        error: function () {
                            $.unblockUI();
                            $("#id_campo_detallado").val(0).trigger("change");
                            smoke.alert("Error de conexión.");
                        },
                        dataType: "json"
                    });
                }
            });


            {% if eCapSolicitudNecesidad.area %}
                $("#id_area").val({{eCapSolicitudNecesidad.area.id}}).trigger("change");
            {% endif %}

            $(".action-close", $("#modalFacilitador")).click(function (){
                $("#modalFacilitador").modal('hide');

            });

            $(".action-close", $("#modalFirmaDocumento")).click(function (){
                bloqueointerface();
                $("#modalFirmaDocumento").modal('hide');
                location.reload();

            });

            $(".action-save", $("#modalFacilitador")).click(function (){
                bloqueointerface();
                let formdata = new FormData($("#formFacilitador", $("#modalFacilitador"))[0]);
                const tipo = $("#id_tipo", $("#modalFacilitador")).val();
                if (tipo == 1){
                    formdata.append('facilitador', $("#id_facilitador", $("#modalFacilitador")).val())
                }
                $.ajax({
                    type: "POST",
                    url: `{{ request.path }}`,
                    data: formdata,
                    success: function(data) {
                        $.unblockUI();
                        if (data.result === true) {
                            $("#modalFacilitador").modal('hide');
                            $("#contenedor_facilitadores").html(data.html);
                            //location.href=`{{ request.path }}?action=writeDraftSolicitudNecesidad&id=${data.id}`;
                            /*Swal.fire({
                                allowOutsideClick: false,
                                allowEscapeKey: false,
                                allowEnterKey: false,
                                type: 'success',
                                customClass: {
                                    confirmButton: 'btn btn-info'
                                },
                                title: 'Exitoso',
                                text: 'Registro guardado correctamente.',
                                confirmButtonText: 'Aceptar',
                            }).then((result) => {
                                if (result.value) {
                                    bloqueointerface();
                                    location.reload();
                                }
                            })*/
                        } else {
                            Swal.fire({
                                allowOutsideClick: false,
                                allowEscapeKey: false,
                                allowEnterKey: false,
                                type: 'error',
                                customClass: {
                                    confirmButton: 'btn btn-info'
                                },
                                title: 'Ocurrio un error',
                                text: data.message,
                                confirmButtonText: 'Aceptar',
                            })
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        $.unblockUI();
                        {#smoke.alert("Error de conexión.");#}
                        var msg = '';
                        if (jqXHR.status === 0) {
                            msg='Not connect: Verify Network.';
                        } else if (jqXHR.status == 404) {
                            msg='Requested page not found [404]';
                        } else if (jqXHR.status == 500) {
                            msg='Internal Server Error [500].';
                        } else if (textStatus === 'parsererror') {
                            msg='Requested JSON parse failed.';
                        } else if (textStatus === 'timeout') {
                            msg='Time out error.';
                        } else if (textStatus === 'abort') {
                            msg='Ajax request aborted.';
                        } else {
                            msg='Uncaught Error: ' + jqXHR.responseText;
                        }
                        //smoke.alert("Error al enviar los datos: " + msg);
                        NotificationJG.error("Error al enviar los datos: " + msg);
                    },
                    dataType: "json",
                    cache: false,
                    contentType: false,
                    processData: false
                });

            });

            $(".action-firmar", $("#modalFirmaDocumento")).click((event) => {
                let hojasFirmadas = [];
                hojasFirmadas.push(
                    {
                        x: 400,
                        y: 375,
                        width: 150,
                        height: 45,
                        numPage: 5
                    }
                );
                $("textarea[name=txtFirmas]", $("#modalFirmaDocumento")).val(JSON.stringify(hojasFirmadas));

                bloqueointerface();
                /*try {
                    for (instance in CKEDITOR.instances) {
                        CKEDITOR.instances[instance].updateElement();
                    }
                } catch (err) {
                    console.error(err.message);
                }*/
                var formdata = new FormData($("#frmFirma", $("#modalFirmaDocumento"))[0]);
                $("#frmFirma", $("#modalFirmaDocumento")).validationEngine('attach',{ scroll: false });
                var valid = $("#frmFirma", $("#modalFirmaDocumento")).validationEngine('validate', { scroll: false });

                if (valid){
                    $.ajax({
                        type: "POST",
                        url: "{{ request.path }}",
                        data: formdata,
                        success: function(data) {
                            $.unblockUI();
                            if (data.result === true){
                                Swal.fire({
                                    allowOutsideClick: false,
                                    allowEscapeKey: false,
                                    allowEnterKey: false,
                                    type: 'success',
                                    customClass: {
                                        confirmButton: 'btn btn-info'
                                    },
                                    title: 'Exitoso',
                                    text: data.message,
                                    confirmButtonText: 'Aceptar',
                                }).then((result) => {
                                    if (result.value) {
                                        bloqueointerface();
                                        let a = document.createElement("a");
                                        a.target = "_blank";
                                        a.href = data.archivo;
                                        //location.reload();
                                        location.href=`{{ request.path }}`;

                                    }
                                })
                            }else {
                                Swal.fire({
                                    allowOutsideClick: false,
                                    allowEscapeKey: false,
                                    allowEnterKey: false,
                                    type: 'error',
                                    customClass: {
                                        confirmButton: 'btn btn-info'
                                    },
                                    title: 'Ocurrio un error',
                                    text: data.message,
                                    confirmButtonText: 'Aceptar',
                                })
                            }
                        },
                        error: function() {
                            $.unblockUI();

                        },
                        dataType: "json",
                        cache: false,
                        contentType: false,
                        processData: false
                    });
                }else{
                    $.unblockUI();
                    NotificationJG.error("Complete el formulario");
                    setInterval(function() {
                        $('.help-text', $("#modalFirmaDocumento")).html("");
                    }, 8000);
                }




            });

        });

    </script>
{% endblock %}
{% block atras %}{{ request.path }}{% endblock %}
{% block canvas %}
    <!--https://geeksui.codescandy.com/geeks/pages/dashboard/admin-cms-post-new.html--->
    <div class='row'>
        <div class='col-12'>
            <div class="headtitle">
                <h3 class="texto-blue">{{ title }}</h3>
                {% if sub_title %}
                    <h6>{{ sub_title }}</h6>
                {% endif %}
            </div>
        </div>
    </div>

    <form action="javascript:;" id="frmSolicitud">
        <input type="hidden" name="id" value="{{ eCapSolicitudNecesidad.pk }}">
        <input type="hidden" name="action" value="saveChangeSolicitudNecesidadWriteDraft">
        <div class="card ">
            <div class="card-header border-bottom rounded-md-2">
                <div class=" d-md-flex align-items-center justify-content-between">
                    <h4 class="mb-0">Formulario de registro de identificacióon de necesidades de capacitación y actualización científica</h4>
                    <div>
                        {% if eCapSolicitudNecesidad.tiene_estado_borrador  %}
                            <a id="btn_guardar_firmar" onclick="actionGuardarFirmar()" href="javascript:void(0)" class="btn btn-outline-success btn-firmar fs-5" style="border-radius: 20px !important; padding: 5px 18px 5px 18px !important;"> <i class="fa fa-file" ></i> Firmar</a>
                        {% elif eCapSolicitudNecesidad.tiene_pendiente_director  %}
                            <a id="btn_firmar" onclick="openModalFirma('loadFormFirma', 'Legalizar solicitud por director/a de carrera')" href="javascript:void(0)" class="btn btn-outline-success btn-firmar fs-5" style="border-radius: 20px !important; padding: 5px 18px 5px 18px !important;"> <i class="fa fa-file" ></i> Firmar</a>
                        {% endif %}
                        <h3 id="text_loading" class="mb-0 text-right hidden">Cargando...</h3>
                    </div>

                </div>
            </div>
            <div class="card-body">
                <div class='row'>
                    <div class='col-xl-9 col-lg-8 col-md-12 col-12'>
                        <div class="row border border-light p-1 align-items-center">
                            <div class="col-12 mb-1">
                                <!-- Title -->
                                <label for="id_tema" class="form-label fs-6"><span class="badge-dot bg-warning d-inline-block me-1"></span> Tema de la capacitación y actualización específica requerida:</label>

                                {% if eCapSolicitudNecesidad.tiene_estado_borrador %}
                                    <textarea rows="3" name="tema" id="id_tema" {% if not eCapSolicitudNecesidad.tiene_estado_borrador %}readonly="readonly" disabled="disabled"{% endif %} class="form-control text-dark" placeholder="">{{ eCapSolicitudNecesidad.tema|default_if_none:'' }}</textarea>
                                    <p id="small_tema_caracteres" class="text-muted fs-6">Máximo 1000 caracteres</p>
                                {% else %}
                                    {{ eCapSolicitudNecesidad.tema|safe|default_if_none:'' }}
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mt-1 border border-light p-1 row-cols-xl-3 row-cols-lg-1 row-cols-md-1 row-cols-1 align-items-center align-middle ">
                            <div class="col mb-1">
                                <label for="id_area" class="form-label fs-6"><span class="badge-dot bg-warning d-inline-block me-1"></span> Área de capacitación/actualización <br> Campo amplio:</label>
                                <select id='id_area' {% if not eCapSolicitudNecesidad.tiene_estado_borrador %}readonly="readonly" disabled="disabled"{% endif %} class="form-select fs-6" name="area" data-original-title="Área">
                                    <option value='0' class="fs-6">Selecciona un área</option>
                                    {% for eArea in eAreas %}
                                        <option class="fs-6" value='{{ eArea.pk }}' {% if eArea.pk == eCapSolicitudNecesidad.area_id %}selected{% endif %}>{{ eArea.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col mb-1">
                                <label for="id_subarea" class="form-label fs-6"><span class="badge-dot bg-warning d-inline-block me-1"></span> Subárea de capacitación/actualización <br> Campo específico:</label>
                                <select id='id_subarea' {% if not eCapSolicitudNecesidad.tiene_estado_borrador %}readonly="readonly" disabled="disabled"{% endif %} class="form-select fs-6" name="subarea" data-original-title="Subárea">
                                    <option class="fs-6" value='0'>Selecciona un subárea</option>
                                </select>
                            </div>
                            <div class="col mb-1">
                                <label for="id_campo_detallado" class="form-label fs-6"><span class="badge-dot bg-warning d-inline-block me-1"></span> Campo detallado: <br> Lengua, literatura e investigación:</label>
                                <select id='id_campo_detallado' {% if not eCapSolicitudNecesidad.tiene_estado_borrador %}readonly="readonly" disabled="disabled"{% endif %} class="form-select fs-6" name="campo_detallado" data-original-title="Campo detallado">
                                    <option class="fs-6" value='0'>Selecciona un campo detallado</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-1 border border-light p-1 align-items-center ">
                            <label for="id_carrera" class="col-sm-4 col-form-label fs-6 border-end-md"><span class="badge-dot bg-warning d-inline-block me-1"></span> Dirigido a docentes de la carrera de:</label>
                            <div class="col-sm-8">
                                <select id='id_carrera' {% if not eCapSolicitudNecesidad.tiene_estado_borrador %}readonly="readonly" disabled="disabled"{% endif %} class="form-select fs-6" name="carrera" data-original-title="Carrera">
                                    <option value='0' class="fs-6">Selecciona una carrera</option>
                                    {% for eCarrera in eCarreras %}
                                        <option class="fs-6" value='{{ eCarrera.pk }}' {% if eCarrera.pk == eCapSolicitudNecesidad.carrera_id %}selected{% endif %}>{{ eCarrera.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row mt-1 border border-light p-1 align-items-center ">
                            <label for="id_justificacion" class="col-sm-4 col-form-label fs-6 border-end-md"><span class="badge-dot bg-warning d-inline-block me-1"></span> Origen del requerimiento/justificación:</label>
                            <div class="col-sm-8">

                                {% if eCapSolicitudNecesidad.tiene_estado_borrador %}
                                    <textarea rows="4" name="justificacion" id="id_justificacion" {% if not eCapSolicitudNecesidad.tiene_estado_borrador %}readonly="readonly" disabled="disabled"{% endif %} class="form-control text-dark" placeholder="">{{ eCapSolicitudNecesidad.justificacion|default_if_none:'' }}</textarea>
                                {% else %}
                                    {{ eCapSolicitudNecesidad.justificacion|safe|default_if_none:'' }}
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mt-1 border border-light p-1 align-items-center ">
                            <label for="id_objetivo" class="col-sm-4 col-form-label fs-6 border-end-md"><span class="badge-dot bg-warning d-inline-block me-1"></span> Objetivo general del aprendizaje propuesto:</label>
                            <div class="col-sm-8">
                                {% if eCapSolicitudNecesidad.tiene_estado_borrador %}
                                    <textarea rows="2" name="objetivo" id="id_objetivo" {% if not eCapSolicitudNecesidad.tiene_estado_borrador %}readonly="readonly" disabled="disabled"{% endif %} class="form-control text-dark" placeholder="">{{ eCapSolicitudNecesidad.objetivo|default_if_none:'' }}</textarea>
                                {% else %}
                                    {{ eCapSolicitudNecesidad.justificacion|safe|default_if_none:'' }}
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mt-1 border border-light p-1 align-items-center ">
                            <label for="id_contenido" class="col-sm-4 col-form-label fs-6 border-end-md"><span class="badge-dot bg-warning d-inline-block me-1"></span> Contenido:</label>
                            <div class="col-sm-8">
                                {% if eCapSolicitudNecesidad.tiene_estado_borrador %}
                                    <textarea rows="7" name="contenido" id="id_contenido" {% if not eCapSolicitudNecesidad.tiene_estado_borrador %}readonly="readonly" disabled="disabled"{% endif %} class="form-control text-dark" placeholder="">{{ eCapSolicitudNecesidad.contenido|default_if_none:'' }}</textarea>
                                {% else %}
                                    {{ eCapSolicitudNecesidad.contenido|safe|default_if_none:'' }}
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mt-1 border border-light p-1 align-items-center ">
                            <label for="id_resultado" class="col-sm-4 col-form-label fs-6 border-end-md"><span class="badge-dot bg-warning d-inline-block me-1"></span> Resultados esperados:</label>
                            <div class="col-sm-8">

                                {% if eCapSolicitudNecesidad.tiene_estado_borrador %}
                                    <textarea rows="5" name="resultado" id="id_resultado" {% if not eCapSolicitudNecesidad.tiene_estado_borrador %}readonly="readonly" disabled="disabled"{% endif %} class="form-control text-dark" placeholder="">{{ eCapSolicitudNecesidad.resultado|default_if_none:'' }}</textarea>
                                {% else %}
                                    {{ eCapSolicitudNecesidad.resultado|safe|default_if_none:'' }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-lg-4 col-md-12 col-12">
                        <div class="row  border border-light p-1 align-items-center ">
                            <label for="id_num_horas_referida" class="col-sm-4 col-form-label fs-6 border-end-md text-md-end px-1"><span class="badge-dot bg-warning d-inline-block me-1"></span> No. de horas referidas:</label>
                            <div class="col-sm-8 px-1">
                                <input type="number" id="id_num_horas_referida" {% if not eCapSolicitudNecesidad.tiene_estado_borrador %}readonly="readonly" disabled="disabled"{% endif %} name="num_horas_referida" class="form-control w-sm-50" value="{{ eCapSolicitudNecesidad.num_horas_referida|default_if_none:'0' }}">
                            </div>
                        </div>
                        <div class="row mt-1 border border-light p-1 align-items-center ">
                            <label for="id_capacidad_participante" class="col-sm-4 col-form-label fs-6 border-end-md text-md-end px-1"><span class="badge-dot bg-warning d-inline-block me-1"></span> Cantidad de participantes:</label>
                            <div class="col-sm-8 px-1">
                                <input type="number" id="id_capacidad_participante" {% if not eCapSolicitudNecesidad.tiene_estado_borrador %}readonly="readonly" disabled="disabled"{% endif %} name="capacidad_participante" class="form-control w-sm-50" value="{{ eCapSolicitudNecesidad.capacidad_participante|default_if_none:'0' }}">
                            </div>
                        </div>
                        <div class="row mt-1 border border-light p-1 align-items-center ">
                            <label for="id_modalidad" class="col-sm-4 col-form-label fs-6 border-end-md text-md-end px-1"><span class="badge-dot bg-warning d-inline-block me-1"></span> Modalidad:</label>
                            <div class="col-sm-8">
                                <select id='id_modalidad' {% if not eCapSolicitudNecesidad.tiene_estado_borrador %}readonly="readonly" disabled="disabled"{% endif %} class="form-select fs-6 w-sm-50 w-lg-100" name="modalidad" data-original-title="Modalidad">
                                    {% for eModalidad in eModalidades %}
                                        <option class="fs-6" value='{{ eModalidad.0 }}' {% if eModalidad.0 == eCapSolicitudNecesidad.modalidad %}selected{% endif %}>{{ eModalidad.1 }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row mt-1 border border-light p-1 align-items-center ">
                            <div class="col-12">
                                <h6 class="">Fecha sugerida para el cronograma</h6>
                            </div>
                            <div class="row ">
                                <div class="col-sm">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" {% if not eCapSolicitudNecesidad.tiene_estado_borrador %}readonly="readonly" disabled="disabled"{% endif %} id="id_desde" name="desde"  value="{% if eCapSolicitudNecesidad.desde %}{{ eCapSolicitudNecesidad.desde|date:"d/m/Y" }}{% endif %}">
                                        <label for="id_desde">Desde</label>
                                    </div>
                                </div>
                                <div class="col-sm">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" {% if not eCapSolicitudNecesidad.tiene_estado_borrador %}readonly="readonly" disabled="disabled"{% endif %} id="id_hasta" name="hasta"  value="{% if eCapSolicitudNecesidad.hasta %}{{ eCapSolicitudNecesidad.hasta|date:"d/m/Y" }}{% endif %}">
                                        <label for="id_hasta">Hasta</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-1 border border-light p-1 align-items-center ">
                            <div class="col-12 d-md-flex align-items-center justify-content-between">
                                <h6 class="m-0 text-warning fs-5">Facilitador:</h6>
                                {% if eCapSolicitudNecesidad.tiene_estado_borrador %}
                                    <a href="javascript:void(0)" onclick="openAddFacilitador('loadFormFacilitador', 'Adicionar un facilitador')" class="fs-5" > <i class="fa fa-plus text-primary" ></i></a>
                                {% endif %}
                            </div>
                            <div class="col-12" id="contenedor_facilitadores">
                                {% for facilitador in eCapSolicitudNecesidad.facilitadores %}
                                    <div class="row">
                                        <div class="col-12 d-md-flex align-items-center justify-content-between">
                                            <h6 class="mb-0">{{ facilitador.nombre }}</h6>
                                            {% if eCapSolicitudNecesidad.tiene_estado_borrador %}
                                                <a href="javascript:void(0)" onclick="actionDeleteFacilitador('{{ facilitador.id }}', '', 'sga', '{{ facilitador.nombre }}')" class="fs-5" > <i class="fa fa-close text-danger" ></i></a>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="row">
                                        <div class="col-12">
                                            <h6 class="mb-0 text-center">No existe registro</h6>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="mt-1">
                            <!-- List Group -->
                            <ul class="list-group list-group-flush">
                                <!--<li class="list-group-item">
                                    <span class="text-body">Post ID</span>
                                    <h5>8693637308</h5>
                                </li>-->
                                <li class="list-group-item">
                                    <span class="text-body">Estado actual</span>
                                    <h5>
                                        <span class="badge-dot bg-{{ eCapSolicitudNecesidad.color }} d-inline-block me-1"></span>{{ eCapSolicitudNecesidad.get_estado_display }}
                                    </h5>

                                </li>
                                <li class="list-group-item">
                                    <span class="text-body">Creado por</span>
                                    <div class="d-flex mt-2">
                                        <img src="{{ eCapSolicitudNecesidad.foto_creado_por }}" alt="" class="avatar-sm rounded-circle">
                                        <div class="ms-2">
                                            <h5 class="mb-n1">{{ eCapSolicitudNecesidad.creado_por.nombre_completo_minus }}</h5>
                                            <!--<small>Admin</small>-->
                                        </div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <span class="text-body">Creado el</span>
                                    <h5>{{ eCapSolicitudNecesidad.fecha_creacion|date:"d M, Y h:i a" }}</h5>
                                </li>
                                {% if eCapSolicitudNecesidad.fecha_modificacion %}
                                    <li class="list-group-item">
                                        <span class="text-body">Última actualización</span>
                                        <h5>{{ eCapSolicitudNecesidad.fecha_modificacion|date:"d M, Y h:i a" }}</h5>
                                    </li>
                                {% endif %}
                                {% if eCapSolicitudNecesidad.archivo %}
                                    <li class="list-group-item">
                                        <span class="text-body">Archivo</span>
                                        <a href="{{ eCapSolicitudNecesidad.archivo.url }}" target="_blank">Ver</a>
                                    </li>
                                {% endif %}
                            </ul>
                        </div>
                        {% with eCapSolicitudNecesidadSeguimientos=eCapSolicitudNecesidad.seguimiento %}
                            {% if eCapSolicitudNecesidadSeguimientos|length %}
                                <div class="card shadow-none rounded-0  align-items-left mt-1 " >
                                    <div class="card-header">
                                        <h4 class="text-center mx-0">Seguimiento</h4>
                                    </div>
                                    <ul class="list-group list-group-flush mt-0" >
                                        {% for eCapSolicitudNecesidadSeguimiento in eCapSolicitudNecesidadSeguimientos %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h5 class="mb-0 fs-6">Cambio de estado el</h5>
                                                    <span class="text-body fs-6">{{ eCapSolicitudNecesidadSeguimiento.fecha_creacion|date:"d M, Y h:i a" }}</span>
                                                    {% if eCapSolicitudNecesidadSeguimiento.observacion %}
                                                        <p class="text-body text-muted fs-6">{{ eCapSolicitudNecesidadSeguimiento.observacion }}</p>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <span class="badge badge-pill badge-{{ eCapSolicitudNecesidadSeguimiento.color }} fs-6" style="font-size: 9px !important;">{{ eCapSolicitudNecesidadSeguimiento.get_estado_display }}</span>
                                                </div>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                        {% endwith %}
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="text-end my-3">
                    {% if eCapSolicitudNecesidad.tiene_estado_borrador  %}
                        <button type="submit" onclick="actionGuardarFirmar()" href="javascript:void(0)" class="btn btn-outline-success fs-5" style="border-radius: 20px !important; padding: 5px 18px 5px 18px !important;"> <i class="fa fa-file" ></i> Firmar</button>
                        <button type="submit" id="submit" onclick="saveSolicitudNecesidadWriteDraft(true)" class="btn btn-orange fs-5"><i class="fa fa-check-circle" ></i> Guardar
                        </button>
                    {% endif %}
                    <a href="{{ request.path }}" class="btn btn-cian-secondary fs-5 bloqueo_pantalla"> <i class="fa fa-close" ></i> Regresar</a>
                </div>
            </div>
        </div>

    </form>

    <div class="modal fade" id="modalFacilitador" tabindex="-1" aria-labelledby="modalLabelFacilitador" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title m-2" id="modalLabelFacilitador">Modal title</h5>
                    <button type="button" class="btn-close action-close m-0" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body m-2">
                    ...
                </div>
                <div class="modal-footer m-2">
                    <button type="button" class="btn btn-secondary action-close" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary action-save">Adicionar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalFirmaDocumento" tabindex="-1" aria-labelledby="modalLabelFirmaDocumento" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title m-2" id="modalLabelFirmaDocumento">Modal title</h5>
                    <button type="button" class="btn-close action-close m-0" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body m-2">
                    ...
                </div>
                <div class="modal-footer m-2">
                    <button type="button" class="btn btn-primary action-firmar">Firmar</button>
                    <button type="button" class="btn btn-secondary action-close" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
