{% extends "ajaxformbs.html" %}
{% block extraheading %}
    <script>
        $(function(){
            lista_item1 = [];
            //lista_item2 = [];
            $("#id_tipocomprobante, #id_cuentadepositopac, #id_depositante, #id_concepto").addClass("validate[required]");

            $("#numero_nota, #id_numerocur").blur(function () {
                numerico($(this), 0, 0, 0);
            });

            validar_transferencia = function () {
                var valor1 = parseFloat($("#id_valortotal").val());
                var valor2 = parseFloat($("#id_montopresupuestado").val());
                var valor3 = valor1 - valor2;
                $("#id_diferencia, #totaldiferencia").val(valor3.toFixed(2));
            };

            $("#valor_nota, #valor_papeleta, #id_valortotal, #id_montopresupuestado").blur(function () {
                numerico($(this), 0, 0, 2);
                validar_transferencia();
                validar_comprobante();
            });

            $("#id_valortotal, #valortotalcomprobante, #id_valornotacredito, #id_valorfactura, #id_valorotros").val('0.00');

            $("#id_fecha, #id_fechanotacredito").datepicker({format:"dd-mm-yyyy"}).on('changeDate', function(ev){
                $(this).datepicker('hide');

                tipocomprobante = parseInt($("#id_tipocomprobante").val());
                    cargar_datos();
            });

            $("#id_fechacomp").datepicker({format:"dd-mm-yyyy"}).on('changeDate', function(ev){
                $(this).datepicker('hide');
            });
            $("#id_tipocomprobante, #id_cuentadepositopac, #id_cuentadepositocent, #id_puntoemision").val(0).trigger('change');

            tipo_comprobante = function () {
                var tipocomprobante = parseInt($("#id_tipocomprobante").val());
                $("#id_depositante").val("");
                $("#id_concepto").val("");
                $("#id_valortotal").val('0.00');
                $("#fieldset_partida").hide();
                $("#id_puntoemision").removeClass("validate[required]");
                $("#fieldset_puntoemision").hide();
                $("#id_cuentadepositopac").removeClass("validate[required]");
                $("#id_cuentadepositocent").removeClass("validate[required]");
                $("#fieldset_cuentadepositopac").hide();
                $("#fieldset_cuentadepositocent").hide();
                $("#id_depositante").removeClass("validate[required]");
                $("#id_valordeposito").removeClass("validate[required]");
                $("#id_fecha").removeClass("validate[required]");
                $("#id_fechacomp").removeClass("validate[required]");
                $("#id_fechanotacredito").removeClass("validate[required]");
                $("#id_numerocur").removeClass("validate[required]");
                $("#fieldset_depositante").hide();
                $("#fieldset_numerocur").hide();
                $("#fieldset_valordeposito").hide();
                $("#fieldset_fecha").hide();
                $("#fieldset_fechacomp").hide();
                $("#fieldset_valornotacredito").hide();
                $("#fieldset_valorfactura").hide();
                $("#fieldset_fechanotacredito").hide();
                $("#detalle_pagos").hide();
                $("#detalle_pagos_notas").hide();
                $("#papeletas").hide();
                $("#notascredito").hide();
                $("#id_valortotal").attr({'readonly': true});
                $("#id_conceptotrans").removeClass("validate[required]");
                $("#fieldset_conceptotrans").hide();
                $("#id_montopresupuestado").removeClass("validate[required]");
                $("#fieldset_montopresupuestado").hide();
                $("#id_diferencia").removeClass("validate[required]");
                $("#fieldset_diferencia").hide();
                $("#id_cuota").removeClass("validate[required]");
                $("#fieldset_cuota").hide();
                $("#id_valorotros").removeClass("validate[required]");
                $("#fieldset_valorotros").hide();
                if (tipocomprobante == 1 || tipocomprobante == 3 || tipocomprobante == 7 || tipocomprobante == 8){
                        $("#detalle_pagos").show();

                    $("#fieldset_valordeposito").show();
                    $("#papeletas").show();
                    $("#id_puntoemision").addClass("validate[required]");
                    if (tipocomprobante != 3){
                        $("#id_fechacomp").addClass("validate[required]");
                        $("#fieldset_fechacomp").show();
                    }
                    $("#id_fecha").addClass("validate[required]");
                    $("#fieldset_puntoemision").show();
                    $("#fieldset_fecha").show();
                    $("#id_cuentadepositopac").addClass("validate[required]");
                    $("#fieldset_cuentadepositopac").show();
                    $("#id_depositante").addClass("validate[required]");
                    $("#fieldset_depositante").show();
                }
                if (tipocomprobante == 2){
                    $("#detalle_pagos").show();
                    $("#id_fecha").addClass("validate[required]");
                    $("#id_puntoemision").addClass("validate[required]");
                    $("#fieldset_puntoemision").show();
                    $("#fieldset_fecha").show();
                    $("#id_cuentadepositopac").addClass("validate[required]");
                    $("#fieldset_cuentadepositopac").show();
                    $("#id_depositante").addClass("validate[required]");
                    $("#fieldset_depositante").show();
                }
                if (tipocomprobante == 4){
                    $("#detalle_pagos_notas").show();
                    $("#fieldset_valornotacredito").show();
                    $("#id_fecha").addClass("validate[required]");
                    $("#fieldset_fecha").show();
                    $("#fieldset_valorfactura").show();
                    $("#notascredito").show();
                    $("#id_fechanotacredito").addClass("validate[required]");
                    $("#id_puntoemision").addClass("validate[required]");
                    $("#fieldset_puntoemision").show();
                    $("#fieldset_fechanotacredito").show();
                    $("#id_cuentadepositopac").addClass("validate[required]");
                    $("#fieldset_cuentadepositopac").show();
                    $("#id_depositante").addClass("validate[required]");
                    $("#fieldset_depositante").show();
                    $("#fieldset_partida").show();
                    $("#id_valorotros").addClass("validate[required]");
                    $("#fieldset_valorotros").show();
                }
                if (tipocomprobante == 5){
                    $("#detalle_pagos").show();
                    $("#fieldset_valordeposito").show();
                    $("#fieldset_valorfactura").show();
                    $("#papeletas").show();
                    $("#id_puntoemision").addClass("validate[required]");
                    $("#id_fecha").addClass("validate[required]");
                    $("#fieldset_puntoemision").show();
                    $("#fieldset_fecha").show();
                    $("#id_cuentadepositopac").addClass("validate[required]");
                    $("#fieldset_cuentadepositopac").show();
                    $("#id_depositante").addClass("validate[required]");
                    $("#fieldset_depositante").show();
                }
                if (tipocomprobante == 6){
                    $("#id_puntoemision").addClass("validate[required]");
                    $("#fieldset_puntoemision").show();
                    $("#fieldset_numerocur").show();
                    $("#id_numerocur").addClass("validate[required]");
                    $("#id_cuentadepositocent").addClass("validate[required]");
                    $("#id_cuentadepositocent").val(0);
                    $("#fieldset_cuentadepositocent").show();
                    $("#id_depositante").addClass("validate[required]");
                    $("#fieldset_depositante").show();
                    $("#id_valortotal").attr({'readonly': false}).addClass("validate[required]").removeAttr('disabled');
                    $("#id_conceptotrans").addClass("validate[required]");
                    $("#fieldset_conceptotrans").show();
                    $("#id_montopresupuestado").addClass("validate[required]");
                    $("#fieldset_montopresupuestado").show();
                    $("#fieldset_diferencia").show();
                    $("#id_cuota").addClass("validate[required]");
                    $("#fieldset_cuota").show();
                    $("#fieldset_partida").show();
                    {#                    $("#id_conceptotrans").html('').append('<option selected="selected" value="">---------</option>');#}
                    {#                    $("#id_cuentadepositocent").val(0).trigger("change");#}
                    {#                    $("#id_conceptotrans").val(0).trigger("change");#}
                }
                cargar_datos();
            };

            {#       $("#id_conceptotrans").change(function(){#}
            {#                $("#id_partida").html('').append('<option selected="selected" value="">---------</option>');#}
            {#               $("#id_partida").val(0).trigger("change");#}
            {#                var id = $(this).val();#}
            {#                if (id){#}
            {#                    bloqueointerface();#}
            {#                    $.ajax({#}
            {#                        type: "POST",#}
            {#                        url: "/rec_comprobantes",#}
            {#                        data: {"action": "partida_concepto", "id": id},#}
            {#                        success: function(data) {#}
            {#                            if (data.result=='ok'){#}
            {#                                for (x=0; x < data.lista.length; x++){#}
            {#                                    elemento = data.lista[x];#}
            {#                                    $("#id_partida").append('<option value="'+elemento[0]+'">'+elemento[1]+'</option>');#}
            {#                                }#}
            {#                                if (data.lista.length == 1){#}
            {#                                    $("#id_partida").prop("selectedIndex", 1).trigger("change");#}
            {#                                }#}
            {#                            } else {#}
            {#                                $("#id_conceptotrans").val(0).trigger("change");#}
            {#                            }#}
            {#                            $.unblockUI();#}
            {#                        },#}
            {#                        error: function() {#}
            {#                            $.unblockUI();#}
            {#                            $("#id_conceptotrans").val(0).trigger("change");#}
            {#                            smoke.alert("Error de conexi贸n.");#}
            {#                        },#}
            {#                        dataType: "json"#}
            {#                    });#}
            {#                }#}
            {#            });#}

            $("#id_tipocomprobante").change(function () {
                tipo_comprobante();
            });

            $("#id_puntoemision").change(function () {
                tipocomprobante = parseInt($("#id_tipocomprobante").val());
                if(tipocomprobante != 8)
                    cargar_datos();
            });

            $('#todos').click(function () {
                $("#todos").unbind();
                conectar_control();
            });


            conectar_control = function () {
                var tipo = parseInt($("#id_tipocomprobante").val());
                $("#todos").unbind();
                $("#todos").click(function () {
                    if ($(this).is(":checked")){
                        $(".seleccionados").prop('checked', true);
                        if (tipo == 2){
                            actualizar_lista_pagos_matricula();
                        }else{
                            actualizar_lista_pagos_notas();
                        }
                    }else{
                        $(".seleccionados").prop('checked', false);
                        if (tipo == 2){
                            actualizar_lista_pagos_matricula();
                        }else{
                            actualizar_lista_pagos_notas();
                        }
                    }

                });
                $(".seleccionados").unbind();
                $(".seleccionados").click(function () {
                    if (tipo == 2){
                        actualizar_lista_pagos_matricula();
                    }else{
                        actualizar_lista_pagos_notas();
                    }
                });
            };


            $(".seleccionados").click(function () {
                var tipo = parseInt($("#id_tipocomprobante").val());
                if (tipo == 2){
                    actualizar_lista_pagos_matricula();
                }else{
                    actualizar_lista_pagos_notas();
                }
            });


            conectar_control_terceros = function () {
                $("#todos_terceros").unbind();
                $("#todos_terceros").click(function () {
                    if ($(this).is(":checked")){
                        $(".seleccionados_terceros").prop('checked', true);
                        actualizar_lista_pagos_terceros();
                    }else{
                        $(".seleccionados_terceros").prop('checked', false);
                        actualizar_lista_pagos_terceros();
                    }

                });
                $(".seleccionados_terceros").unbind();
                $(".seleccionados_terceros").click(function () {
                    actualizar_lista_pagos_terceros();
                });
            };

            $('#todos_terceros').click(function () {
                $("#todos_terceros").unbind();
                conectar_control_terceros();
            });


            $(".seleccionados_terceros").click(function () {
                actualizar_lista_pagos_terceros();
            });



            cargar_datos = function () {

                var tipocomprobante = parseInt($("#id_tipocomprobante").val());
                if ( tipocomprobante == 1) {
                    cargar_datos_recaudacion_ventanilla();
                }
                if (tipocomprobante == 2) {
                    cargar_datos_recaudacion_matricula();
                }
                if (tipocomprobante == 3) {
                    cargar_datos_recaudacion_terceros();
                }
                if (tipocomprobante == 4) {
                    cargar_datos_recaudacion_notacredito();
                }
                if (tipocomprobante == 5) {
                    cargar_datos_recaudacion_devoluciones();
                }
                if (tipocomprobante == 7 ) {
                    cargar_datos_recaudacion_otros();
                }
                if (tipocomprobante == 8 ) {
                    cargar_datos_recaudacion_fianza();
                }

            };


            tipo_comprobante();

            actualizar_lista_pagos = function () {
                lista_items1 = [];
                $(".pagos_facturas").each(function(){
                    var id = $(this).attr('ida');
                    var item = {
                        id: id,
                        tipodoc:'FAC'
                    };
                    lista_items1.push(item);
                });
                validar_comprobante();
            };

            actualizar_lista_pagos_matricula = function () {
                lista_items1 = [];
                var valortotal = 0;

                var seleccionados = $(".seleccionados:checked");
                $("#id_depositante").val('');
                $("#id_concepto").val('');

                seleccionados.each(function(){
                    var id = $(this).attr('ida');
                    var tipodoc = $(this).attr('tdoc');
                    var valor = parseFloat($(this).attr('valor'));
                    $("#id_depositante").val($(this).attr('nombre'));
                    $("#id_concepto").val($(this).attr('concepto'));
                    var item = {
                        id: id,
                        tipodoc: tipodoc
                    };
                    lista_items1.push(item);
                    valortotal += valor;
                });



                $("#id_valorfactura").val(valortotal.toFixed(2));
                actualizar_valor_notacredito();
                validar_comprobante();
            };


            actualizar_lista_pagos_notas = function () {
                lista_items1 = [];
                var valortotal = 0;
                var seleccionados = $(".seleccionados:checked");
                $("#id_depositante").val('');
                $("#id_concepto").val('');
                seleccionados.each(function(){
                    var id = $(this).attr('ida');
                    var valor = parseFloat($(this).attr('valor'));
                    $("#id_depositante").val($(this).attr('nombre'));
                    $("#id_concepto").val($(this).attr('concepto'));
                    var item = {
                        id: id
                    };
                    lista_items1.push(item);
                    valortotal += valor;
                });
                $("#id_valorfactura").val(valortotal.toFixed(2));
                actualizar_valor_notacredito();
                validar_comprobante();
            };

            actualizar_lista_pagos_terceros = function () {
                lista_items1 = [];
                var valortotal = 0;
                var seleccionados_t = $(".seleccionados_terceros:checked");
                $("#id_depositante").val('');
                $("#id_concepto").val('');
                var ref_aux = $("#id_referencia").val();
                $("#id_referencia").val('');
                seleccionados_t.each(function(){
                    var id = $(this).attr('ida');
                    var tipodoc = $(this).attr('tdoc');
                    var valor = parseFloat($(this).attr('valor'));
                    $("#id_depositante").val($(this).attr('nombre'));
                    bloqueointerface();
                    $.get("{{ request.path }}", {action:'buscarconceptofactura',id:id,tipodoc:tipodoc,valor:valor})
                        .then(function (data) {
                            if (data.result) {
                                $("#id_concepto").val(data.texto);
                                $("#id_referencia").val(data.referencia);
                                if (ref_aux == '' || ref_aux == null || ref_aux == undefined) {
                                    $("#id_referencia").val(data.referencia);
                                } else {
                                    $("#id_referencia").val(ref_aux + ' - ' + data.referencia );
                                }
                                $.unblockUI();
                            } else {
                                $.unblockUI();
                                Swal.fire({
                                    toast: false,
                                    position: 'center',
                                    icon: 'error',
                                    type: 'error',
                                    title: 'Notificaci贸n',
                                    text: data.mensaje,
                                    showConfirmButton: false,
                                    timer: 6000
                                });
                            }
                        }).fail(function (error) {
                        $.unblockUI();
                        Swal.fire({
                            toast: false,
                            position: 'center',
                            icon: 'error',
                            type: 'error',
                            title: 'Notificaci贸n',
                            text: 'Error de conexi贸n  con el servidor',
                            showConfirmButton: false,
                            timer: 6000
                        });
                    });
                    var item = {
                        id: id,
                        tipodoc: tipodoc
                    };
                    lista_items1.push(item);
                    valortotal += valor;
                });
                $("#id_valortotal, #valortotalcomprobante").val(valortotal.toFixed(2));
                validar_comprobante();
            };


            actualizar_lista_depositos = function () {
                lista_items2 = [];
                var valortotal = 0;
                $(".papeletas").each(function(){
                    var referencia = $(this).attr('referencia');
                    var valor = parseFloat($(this).attr('valor'));
                    var item = {
                        referencia: referencia,
                        valor: valor
                    };
                    lista_items2.push(item);
                    valortotal += valor;
                });

                $("#id_valordeposito").val(valortotal.toFixed(2));

                tipocomprobante = parseInt($("#id_tipocomprobante").val());
                if(tipocomprobante == 8) {
                    $("#id_valortotal").val(valortotal.toFixed(2));
                    $("#valortotalcomprobante").val(valortotal.toFixed(2));
                }
                var ref_aux2 = $("#id_referencia").val();
                var ref_aux = ''
                for (li of lista_items2) {
                    ref_aux += "#" + li.referencia + " "
                }

                if (ref_aux2 == '' || ref_aux2 == null || ref_aux2 == undefined) {
                    $("#id_referencia").val(ref_aux);
                } else {
                    $("#id_referencia").val("#"+lista_items2[lista_items2.length-1].referencia + ' - ' + ref_aux2);
                }

            };

            actualizar_lista_notas = function () {
                lista_items2 = [];
                var valortotal = 0;
                var tipocomprobante = parseInt($("#id_tipocomprobante").val());
                if (tipocomprobante == 4) {
                    $(".notas").each(function(){
                        var numero = parseInt($(this).attr('numero'));
                        var valor = parseFloat($(this).attr('valor'));
                        var item = {
                            numero: numero,
                            valor: valor
                        };
                        lista_items2.push(item);
                        valortotal += valor;
                    });
                    $("#id_valornotacredito").val(valortotal.toFixed(2));
                    actualizar_valor_notacredito();
                    validar_comprobante();
                } else {
                    $(".papeletas").each(function(){
                        var referencia = $(this).attr('referencia');
                        var valor = parseFloat($(this).attr('valor'));
                        var item = {
                            referencia: referencia,
                            valor: valor
                        };
                        lista_items2.push(item);
                        valortotal += valor;
                    });
                    $("#id_valordeposito").val(valortotal.toFixed(2));
                    actualizar_valor_notacredito();
                    validar_comprobante();
                }

            };


            validar_comprobante = function () {
                var valortotal = parseFloat($("#id_valortotal").val());
                var tipocomprobante = parseInt($("#id_tipocomprobante").val());
                if (valortotal > 0){
                    if (tipocomprobante == 1 || tipocomprobante == 3 || tipocomprobante == 7 || tipocomprobante == 8){
                        var valordeposito = parseFloat($("#id_valordeposito").val());
                        if (valortotal == valordeposito){
                            $("#formbutton").show();
                        }else{
                            $("#formbutton").hide();
                        }
                    }
                    if (tipocomprobante == 2 || tipocomprobante == 5 || tipocomprobante == 6){
                        $("#formbutton").show();
                    }
                    if (tipocomprobante == 4){
                        var valornotacredito = parseFloat($("#id_valornotacredito").val());
                        if (valornotacredito > 0){
                            if (valortotal == valornotacredito){
                                $("#formbutton").show();
                            }else{
                                $("#formbutton").hide();
                            }
                        }else{
                            $("#formbutton").show();
                        }

                    }
                }else if(tipocomprobante == 5 && parseFloat($("#id_valordeposito").val()) > 0){
                    $("#formbutton").show();

                }else{
                    $("#formbutton").hide();
                }

            };

            cargar_datos_recaudacion_ventanilla = function () {
                var punto_emision = parseInt($("#id_puntoemision").val());
                var fecha = $("#id_fecha").val();
                if (punto_emision > 0){
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/rec_comprobantes",
                        data: {"action": "datos_rec_ventanilla", "puntoemision": punto_emision, "fecha": fecha},
                        success: function(data) {
                            $.unblockUI();
                            if (data.result=='ok'){
                                $("#detalle_pagos").html(data.datos);
                                $("#id_valortotal, #valortotalcomprobante").val(data.valortotal);
                                var cajeros = '';
                                for (cajero in data.cajeros){
                                    cajeros += data.cajeros[cajero] + ', ';
                                }
                                $("#id_depositante").val(cajeros);
                            } else {
                                $("#detalle_pagos").empty();
                                $("#id_valortotal, #valortotalcomprobante").val('0.00');
                            }
                            actualizar_lista_pagos();
                        },
                        error: function() {
                            $.unblockUI();
                            $("#detalle_pagos").empty();
                            $("#id_valortotal, #valortotalcomprobante").val('0.00');
                        },
                        dataType: "json"
                    });
                }
            };

            cargar_datos_recaudacion_notacredito = function () {
                var punto_emision = parseInt($("#id_puntoemision").val());
                var fecha = $("#id_fechanotacredito").val();
                if (punto_emision > 0){
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/rec_comprobantes",
                        data: {"action": "datos_rec_notacredito", "puntoemision": punto_emision, "fecha": fecha},
                        success: function(data) {
                            $.unblockUI();
                            if (data.result=='ok'){
                                $("#detalle_pagos_notas").html(data.datos);
                            } else {
                                $("#detalle_pagos_notas").empty();
                                $("#id_valortotal, #valortotalcomprobante").val('0.00');
                            }

                            conectar_control();
                        },
                        error: function() {
                            $.unblockUI();
                            $("#detalle_pagos_notas").empty();
                            $("#id_valortotal, #valortotalcomprobante").val('0.00');
                        },
                        dataType: "json"
                    });
                }
            };

            cargar_datos_recaudacion_devoluciones = function () {
                var punto_emision = parseInt($("#id_puntoemision").val());
                var fecha = $("#id_fecha").val();
                if (punto_emision > 0){
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/rec_comprobantes",
                        data: {"action": "datos_rec_devolucion", "puntoemision": punto_emision, "fecha": fecha},
                        success: function(data) {
                            $.unblockUI();
                            if (data.result=='ok'){
                                $("#detalle_pagos").html(data.datos);
                            } else {
                                $("#detalle_pagos").empty();
                                $("#id_valortotal, #valortotalcomprobante").val('0.00');
                            }
                            conectar_control();
                        },
                        error: function() {
                            $.unblockUI();
                            $("#detalle_pagos").empty();
                            $("#id_valortotal, #valortotalcomprobante").val('0.00');
                        },
                        dataType: "json"
                    });
                }
            };


            cargar_datos_recaudacion_matricula = function () {
                var punto_emision = parseInt($("#id_puntoemision").val());
                var fecha = $("#id_fecha").val();
                if (punto_emision > 0){
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/rec_comprobantes",
                        data: {"action": "datos_rec_matricula", "puntoemision": punto_emision, "fecha": fecha},
                        success: function(data) {
                            $.unblockUI();
                            if (data.result=='ok'){
                                $("#detalle_pagos").html(data.datos);
                                {#                                $("#id_valortotal, #valortotalcomprobante").val(data.valortotal);#}
                            } else {
                                $("#detalle_pagos").empty();
                                $("#id_valortotal, #valortotalcomprobante").val('0.00');
                            }
                            conectar_control();
                            actualizar_lista_pagos_matricula();
                        },
                        error: function() {
                            $.unblockUI();
                            $("#detalle_pagos").empty();
                            $("#id_valortotal, #valortotalcomprobante").val('0.00');
                        },
                        dataType: "json"
                    });
                }
            };

            cargar_datos_recaudacion_terceros = function () {
                var punto_emision = parseInt($("#id_puntoemision").val());
                var fecha = $("#id_fecha").val();
                if (punto_emision > 0){
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/rec_comprobantes",
                        data: {"action": "datos_rec_terceros", "puntoemision": punto_emision, "fecha": fecha},
                        success: function(data) {
                            $.unblockUI();
                            if (data.result=='ok'){
                                $("#detalle_pagos").html(data.datos);
                                {#                                $("#id_valortotal, #valortotalcomprobante").val(data.valortotal);#}
                                conectar_control_terceros();
                            } else {
                                $("#detalle_pagos").empty();
                                $("#id_valortotal, #valortotalcomprobante").val('0.00');
                            }
                            actualizar_lista_pagos();
                        },
                        error: function() {
                            $.unblockUI();
                            $("#detalle_pagos").empty();
                            $("#id_valortotal, #valortotalcomprobante").val('0.00');
                        },
                        dataType: "json"
                    });
                }
            };

            cargar_datos_recaudacion_otros = function () {
                var punto_emision = parseInt($("#id_puntoemision").val());
                var fecha = $("#id_fecha").val();
                if (punto_emision > 0){
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/rec_comprobantes",
                        data: {"action": "datos_rec_otros", "puntoemision": punto_emision, "fecha": fecha},
                        success: function(data) {
                            $.unblockUI();
                            if (data.result=='ok'){
                                $("#detalle_pagos").html(data.datos);
                                {#                                $("#id_valortotal, #valortotalcomprobante").val(data.valortotal);#}

                            } else {
                                $("#detalle_pagos").empty();
                                $("#id_valortotal, #valortotalcomprobante").val('0.00');
                            }
                            conectar_control_terceros();
                        },
                        error: function() {
                            $.unblockUI();
                            $("#detalle_pagos").empty();
                            $("#id_valortotal, #valortotalcomprobante").val('0.00');
                        },
                        dataType: "json"
                    });
                }
            };

            cargar_datos_recaudacion_fianza = function () {
                var punto_emision = parseInt($("#id_puntoemision").val());
                var fecha = $("#id_fecha").val();
                if (punto_emision > 0){
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/rec_comprobantes",
                        data: {"action": "datos_rec_fianza", "puntoemision": punto_emision, "fecha": fecha},
                        success: function(data) {
                            $.unblockUI();
                            if (data.result=='ok'){
                                $("#detalle_pagos").html(data.datos);
                                {#                                $("#id_valortotal, #valortotalcomprobante").val(data.valortotal);#}

                            } else {
                                $("#detalle_pagos").empty();
                                $("#id_valortotal, #valortotalcomprobante").val('0.00');
                            }
                            conectar_control_terceros();
                        },
                        error: function() {
                            $.unblockUI();
                            $("#detalle_pagos").empty();
                            $("#id_valortotal, #valortotalcomprobante").val('0.00');
                        },
                        dataType: "json"
                    });
                }
            };


            $("#valor_papeleta").blur(function () {
                numerico($(this), 0, 0, 2);
            });

            $("#addpapeleta").click(function () {

                //alert("Agregar papelete");

                $("#valor_papeleta").val("0.00");
                $("#referencia_papeleta").val(" ");
                $("#papeletaspanel").modal({"backdrop":"static", "width": "500px"}).modal("show");
            });

            $("#addnota").click(function () {
                $("#valor_nota").val("0.00");
                $("#numero_nota").val(" ");
                $("#notaspanel").modal({"backdrop":"static", "width": "500px"}).modal("show");
            });

            $("#papeletapanel_cerrar").click(function () {
                $("#papeletaspanel").modal("hide");
            });

            $("#notapanel_cerrar").click(function () {
                $("#notaspanel").modal("hide");
            });


            $("#papeletapanel_adicionar").click(function () {

                //alert("Clic en agregar papeleta");

                var referencia = $("#referencia_papeleta").val().toUpperCase();
                var valor = parseFloat($("#valor_papeleta").val());
                if ($("#papeleta_"+referencia).length > 0){
                    alert("YA EXISTE UNA PAPELETA CON ESA REFERENCIA")
                }
                if (referencia && valor){
                    $("#detalle_papeletas").append("<tr class='papeletas' referencia='"+referencia+"' valor='"+valor+"' id='papeleta_"+referencia+"'><td>"+referencia+"</td><td style='text-align: right'>$ "+valor.toFixed(2)+"</td><td style='text-align: center'><a class='btn btn-tini btn-danger eliminaritem tu' title='Eliminar'><i class='fa fa-remove'></i></a></td></tr>");
                    if (parseInt($("#id_tipocomprobante").val()) == 5){
                        actualizar_lista_notas();
                    } else {
                        actualizar_lista_depositos();
                    }
                    validar_comprobante();
                    $("#valor_papeleta").val("0.00");
                    $("#referencia_papeleta").val(" ");
                    $(".eliminaritem").unbind();
                    $(".eliminaritem").click(function () {
                        eliminaritem($(this));
                    });
                }
            });

            $("#notapanel_adicionar").click(function () {
                var numero = parseInt($("#numero_nota").val());
                var valor = parseFloat($("#valor_nota").val());
                if ($("#nota_"+numero).length > 0){
                    alert("YA EXISTE UNA NOTA CON ESE NUMERO")
                }
                if (numero && valor){
                    $("#detalle_notas").append("<tr class='notas' numero='"+numero+"' valor='"+valor+"' id='nota_"+numero+"'><td>"+numero+"</td><td style='text-align: right'>$ "+valor.toFixed(2)+"</td><td style='text-align: center'><a class='btn btn-tini btn-danger eliminaritem tu' title='Eliminar'><i class='fa fa-remove'></i></a></td></tr>");
                    actualizar_lista_notas();
                    $("#valor_nota").val("0.00");
                    $("#numero_nota").val(" ");
                    $(".eliminaritem").unbind();
                    $(".eliminaritem").click(function () {
                        eliminaritem($(this));
                    });
                }
            });


            eliminaritem = function (elemento) {
                elemento.parent().parent().remove();
                actualizar_lista_depositos();
                actualizar_lista_notas();
                validar_comprobante();
            };

            $("#id_valorotros").blur(function () {
                numerico($(this), 0, 0, 2);
                actualizar_valor_notacredito();
                validar_comprobante();
            });

            actualizar_valor_notacredito = function () {
                var tipocomprobante = parseInt($("#id_tipocomprobante").val());
                var valor1 = 0;
                var valor2 = 0;
                var valor3 = 0;
                var valor4 = 0;
                if (tipocomprobante == 4) {
                    {#                    valor1 = parseFloat($("#id_valornotacredito").val());#}
                    valor2 = parseFloat($("#id_valorfactura").val());
                    valor4 = parseFloat($("#id_valorotros").val());
                    valor3 = valor2 + valor4;
                    $("#id_valortotal, #valortotalcomprobante").val(valor3.toFixed(2));
                    validar_comprobante();
                }
                if(tipocomprobante == 5 || tipocomprobante == 2) {
                    valor2 += parseFloat($("#id_valorfactura").val());
                    $("#id_valortotal, #valortotalcomprobante").val(valor2.toFixed(2));
                }

                validar_comprobante();
            };


            validar_comprobante();


            conectar_control();
            //conectar_control_recibos();
            conectar_control_terceros();
            actualizar_lista_depositos();
            actualizar_lista_notas();
            actualizar_lista_pagos_notas();
            actualizar_lista_pagos_matricula();
            actualizar_lista_pagos_terceros();
            actualizar_lista_pagos();


        });
    </script>
{% endblock %}
{% block atras %}/rec_comprobantes{% endblock %}
{% block titulo %}{{ title }}{% endblock %}
{% block formaction %}/rec_comprobantes{% endblock %}
{% block formdestination %}/rec_comprobantes?id={% endblock %}
{% block formextra %}
    <input type='hidden' name='action' value='add'/>
    <input type='hidden' name='valortotalcomprobante' id="valortotalcomprobante" value='0'/>
    <input type='hidden' name='totaldiferencia' id="totaldiferencia" value='0'/>
{% endblock %}
{% block formback %}/rec_comprobantes{% endblock %}
{% block buttonname %}Guardar{% endblock %}
{% block formsuffix %}
    <div class="row-fluid" id="papeletas">
        <table class="table table-bordered filterable">
            <thead>
            <tr>
                <th colspan="15">
                    PAPELETAS DE DEPOSITO
                    <a class="btn btn-mini btn-success pull-right" id="addpapeleta"><i class="fa fa-plus"></i> Adicionar</a>
                </th>
            </tr>
            <tr>
                <th>Referencia</th>
                <th style="width: 100px; text-align: center">Valor</th>
                <th style="width: 30px; text-align: center"></th>
            </tr>
            </thead>
            <tbody id="detalle_papeletas">

            </tbody>
        </table>
    </div>

    <div class="row-fluid" id="notascredito">
        <table class="table table-bordered filterable">
            <thead>
            <tr>
                <th colspan="15">
                    NOTAS DE CREDITO
                    <a class="btn btn-mini btn-success pull-right" id="addnota"><i class="fa fa-plus"></i> Adicionar</a>
                </th>
            </tr>
            <tr>
                <th>Referencia</th>
                <th style="width: 100px; text-align: center">Valor</th>
                <th style="width: 30px; text-align: center"></th>
            </tr>
            </thead>
            <tbody id="detalle_notas">

            </tbody>
        </table>
    </div>

    <div class="row-fluid" id="detalle_pagos">

    </div>

    <div class="row-fluid" id="detalle_pagos_notas">

    </div>

    <div class="modal fade static" id="papeletaspanel">
        <div class="modal-header">
            <h3 id="paneltitle">Papeletas de deposito</h3>
        </div>
        <div class="modal-body">
            <div class="row-fluid">
                <div style="float: left; width: 160px; margin-top: 3px; text-align: right; padding-right: 5px; padding-top: 3px">
                    Referencia:
                </div>
                <div style="float: left; margin-top: 3px">
                    <input class="referencia_papeleta" id="referencia_papeleta" type="text" style="text-transform: uppercase">
                </div>
                <div style="float: left; width: 160px; margin-top: 3px; text-align: right; padding-right: 5px; padding-top: 3px">
                    Valor:
                </div>
                <div style="float: left; margin-top: 3px">
                    <input class="valor_papeleta imp-moneda" id="valor_papeleta" type="text">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" id="papeletapanel_adicionar" class="btn btn-success">Adicionar</a>
            <a href="javascript:;" id="papeletapanel_cerrar" class="btn btn-info">Cerrar</a>
        </div>
    </div>

    <div class="modal fade static" id="notaspanel">
        <div class="modal-header">
            <h3 id="paneltitle">Notas de credito</h3>
        </div>
        <div class="modal-body">
            <div class="row-fluid">
                <div style="float: left; width: 160px; margin-top: 3px; text-align: right; padding-right: 5px; padding-top: 3px">
                    Numero:
                </div>
                <div style="float: left; margin-top: 3px">
                    <input class="numero_nota" id="numero_nota" type="text" style="text-transform: uppercase">
                </div>
                <div style="float: left; width: 160px; margin-top: 3px; text-align: right; padding-right: 5px; padding-top: 3px">
                    Valor:
                </div>
                <div style="float: left; margin-top: 3px">
                    <input class="valor_nota imp-moneda" id="valor_nota" type="text">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" id="notapanel_adicionar" class="btn btn-success">Adicionar</a>
            <a href="javascript:;" id="notapanel_cerrar" class="btn btn-info">Cerrar</a>
        </div>
    </div>
{% endblock %}
