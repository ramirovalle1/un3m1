{% extends 'login/base.html' %}

{% block heading %}
	{% if validar_con_captcha %}
		<script src='https://www.google.com/recaptcha/api.js'></script>
		<link rel="stylesheet" href="/static/css/captcha/chaptcha_response.css" type="text/css" media="screen"/>
	{% endif %}
	<script type="text/javascript">
        {% if validar_con_captcha %}
            var checkRecaptcha = function () {
                res = $('#g-recaptcha-response').val();
                if (res === "" || res === undefined || res.length === 0)
                    return false;
                else
                    return true;
            };
        {% endif %}

        $(function () {

            $("#username").focus();

            $("#user").blur(function () {
                $(this).val($(this).val().trim());
            });

            $("#pass, #user").keydown(function () {
                $("#errormensaje").hide();
            });

            {#$("#login").click(function () {#}
            {#    login();#}
            {# });#}

            $(".tl").tooltip({position: "center up"});

            {#            $('#user, #pass').keyup(function(e) {#}
            {#                if(e.keyCode == 13) {#}
            {#                    login();#}
            {#                }#}
            {#            });#}

        });
	</script>
	<link rel="stylesheet" href="/static/modaltour.css?0.1">

    <!-- CSS Personalizado -->
<style>
.carousel-control-prev-icon,
.carousel-control-next-icon {
    background-color: rgba(0, 0, 0, 0.7); /* Fondo semitransparente negro */
    border-radius: 50%; /* Forma circular */
    width: 45px; /* Ancho del icono */
    height: 45px; /* Alto del icono */
    display: flex;
    align-items: center;
    justify-content: center;
}

.carousel-control-prev-icon::after,
.carousel-control-next-icon::after {
    content: ''; /* Reiniciar el contenido */
}

.carousel-control-prev-icon svg,
.carousel-control-next-icon svg {
    fill: black; /* Color negro para las flechas */
    width: 20px; /* Tamaño de la flecha */
    height: 20px; /* Tamaño de la flecha */
}
</style>
	<style>
        .rc-anchor-light {
            background: #ffffff;
        !important;
            color: #000;
        }

        .rc-anchor {
            border-radius: 16px;
            box-shadow: 0 0 4px 1px rgb(0 0 0 / 8%);
            -webkit-box-shadow: 0 0 4px 1px rgb(0 0 0 / 8%);
            -moz-box-shadow: 0 0 4px 1px rgba(0, 0, 0, 0.08);
        }

        .panel_logo {
            border-radius: 0.25rem;
            /* box-shadow: 0 1px 3px rgb(0 0 0 / 12%), 0 1px 2px rgb(0 0 0 / 24%); */
            background-color: #fff;
            border-left: 5px solid #e9ecef;
            margin-bottom: 1rem;
            border-left-color: #FE9900;
            /* padding: 1rem; */
            line-height: 21px;
            width: 350px;
            font-size: 20px;
        }

        .lista_actividades {
            padding-left: 12px;
            list-style: none;
            text-align: left;
            width: 345px;
            font-size: 13px;
        }

        @media (min-width: 768px) and (max-width: 979px) {
            .lista_actividades {
                padding-left: 0;
                list-style: none;
                text-align: left;
                width: 345px;
            }
        }

        .formulariologin {
            height: 400px;
        }

        @media (min-width: 768px) and (max-width: 979px) {
            .formulariologin {
                height: 520px;
            }
        }


        @media (max-width: 767px) and (max-width: 992px) and (max-width: 1200px) {
            .formulariologin {
                height: 578px;
            }
        }

        /*.recaptchainput {
            margin-left: 141px;
        }

        @media (min-width: 768px) and (max-width: 979px) {
            .recaptchainput {
                margin-left: 241px;
            }
        }


        @media (max-width: 767px) and (max-width: 992px) and (max-width: 1200px) {
            .recaptchainput {
                margin-left: 18%;
            }
        }*/

        .btn-warning{
            background: #FA7E23 0% 0% no-repeat padding-box;
        }

	</style>
	<script>
        $(function () {
            $('#modalPerfiles').modal({backdrop: 'static', keyboard: false}).modal('show');

            $("#btnDocente").click(function(){
                $('#modalPerfiles').modal('hide');
                $("#login").html("Entrar como docente");
                $("#profile").val("docente");
            });
            $("#btnAdministrativo").click(function(){
                $('#modalPerfiles').modal('hide');
                $("#login").html("Entrar como administrativo");
                $("#profile").val("administrativo");
            });
            $('.recuperardatos').on('click', function () {
                $("#iddocumentopass").val("");
                $(".panelPass").prop("hidden", false);
                $(".panelPassConf").prop("hidden", true);
                $('#modalRecuperarDatos').modal('show')
            })

            $("#idPerfiles").click(function(){
                $('#modalPerfiles').modal({backdrop: 'static', keyboard: false}).modal('show');
            });

            buscar = function () {
                var busqueda = $("#iddocumentopass").val();
                if (busqueda.trim().length > 0) {
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/recoverypassword",
                        data: {"action": "searchSGA", "documento": busqueda},
                        success: function (data) {
                            $.unblockUI();
                            if (data.result === "ok") {
                                console.log(data)
                                $(".panelPassConf").prop("hidden", false);
                                $(".panelPass").prop("hidden", true);
                                $("#nombrepersona").html(data.user);
                                if (data.permisoboton === "0") {
                                    $("#generar").hide();
                                    $("#visualizar").show();
                                    $("#cambioclave").attr('value', 0)
                                } else {
                                    $("#generar").show();
                                    $("#visualizar").hide();
                                    $("#cambioclave").attr('value', data.id)
                                }

                            } else {
                                alertaDanger(data.mensaje)
                            }
                        },
                        error: function () {
                            $.unblockUI();
                            alertaWarning('No se pudo realizar la consulta')
                        },
                        dataType: "json"
                    });
                } else {
                    $("#iddocumentopass").focus();
                }
            };

            $("#busqueda").click(function () {
                buscar();
            });

            $("#cambioclave").click(function () {
                var usuario = $("#iddocumentopass").val();
                var id = $(this).attr('value');
                console.log(id)
                console.log(usuario)
                if (usuario.trim().length > 0) {
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/recoverypassword",
                        data: {"action": "generatepassword", "id": id, "app": 1},
                        success: function (data) {
                            $.unblockUI();
                            if (data.result === "ok") {
                                mensajeSuccess('Revise su bandeja de correo  para completar la solicitud', 'Proceso Exitoso')
                            } else {
                                alertaDanger(data.mensaje)
                            }
                        },
                        error: function () {
                            $.unblockUI();
                            alertaDanger("Error al enviar la solicitud.");
                        },
                        dataType: "json"
                    });
                } else {
                    $("#datos").focus();
                }

            });

            $("#cambioclaveAdmision").click(function () {
                var usuario = $("#cedula_admision").val();
                var id = $(this).attr('value');
                console.log(id)
                console.log(usuario)
                if (usuario.trim().length > 0) {
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/recoverypassword",
                        data: {"action": "resetear_clave_admision", "id": id, "app": 1},
                        success: function (data) {
                            $.unblockUI();
                            if (data.result === "ok") {
                                mensajeSuccess('Temporalmente su clave sera su número de cedula.', 'Proceso Exitoso');
                                $("#generarAdmision").hide();
                                $("#visualizarAdmision").show();
                                $("#cambioclaveAdmision").attr('value', 0);
                            } else {
                                alertaDanger(data.mensaje)
                            }
                        },
                        error: function () {
                            $.unblockUI();
                            alertaDanger("Error al enviar la solicitud.");
                        },
                        dataType: "json"
                    });
                } else {
                    $("#datos").focus();
                }

            });

            buscar_admision = function () {
                var busqueda = $("#cedula_admision").val();
                if (busqueda.trim().length > 0) {
                    bloqueointerface();
                    $.ajax({
                        type: "POST",
                        url: "/recoverypassword",
                        data: {"action": "searchAdmision", "cedula_admision": busqueda},
                        success: function (data) {
                            $.unblockUI();
                            if (data.result === "ok") {
                                console.log(data)
                                $(".panelPassConfAdmision").prop("hidden", false);
                                $(".panelPassAdmision").prop("hidden", true);
                                $("#nombrepersonaadm").html(data.user);
                                if (data.permisoboton === "0") {
                                    $("#generarAdmision").hide();
                                    $("#visualizarAdmision").show();
                                    $("#cambioclaveAdmision").attr('value', 0)
                                } else {
                                    $("#generarAdmision").show();
                                    $("#visualizarAdmision").hide();
                                    $("#cambioclaveAdmision").attr('value', data.id)
                                }

                            } else {
                                alertaDanger(data.mensaje)
                            }
                        },
                        error: function () {
                            $.unblockUI();
                            alertaWarning('No se pudo realizar la consulta')
                        },
                        dataType: "json"
                    });
                } else {
                    $("#iddocumentopass").focus();
                }
            };

            $('#recuperar2').on('click', function () {
                $("#cedula_admision").val("");
                $(".panelPassAdmision").prop("hidden", false);
                $(".panelPassConfAdmision").prop("hidden", true);
                $('#modalRecuperarDatosAdmision').modal('show')
            });

            $("#busqueda_admision").click(function () {
                buscar_admision();
            });

            $('#cedula_admision').keyup(function (e) {
                if (e.keyCode == 13) {
                    buscar_admision();
                }
            });


        })
	</script>
	<style>
        .input-group > :not(:first-child):not(.dropdown-menu):not(.valid-tooltip):not(.valid-feedback):not(.invalid-tooltip):not(.invalid-feedback) {
            border-bottom-left-radius: 0;
            border-top-left-radius: 0;
            margin-left: -2px;
        !important:;
        }
	</style>
	<script src="/static/bootstrap-show-password/dist/bootstrap-show-password.js"></script>
{% endblock %}
{% block extraJs %}
    {% include 'adm_registro_marcadas/utils_info.html' %}
    <script type="application/javascript">
        const login = async () => {
            var capipprivada = jscd.ip;
            var navegador = jscd.browser + ' ' + jscd.browserMajorVersion;
            var os = jscd.os + ' ' + jscd.osVersion;
            var cookies = jscd.cookies;
            var screensize = jscd.screen;
            bloqueointerface()
            $("#login").attr({"disabled": "disabled"});
            $.ajax({
                type: "POST",
                url: "/loginsga",
                data: {
                    'action': 'login',
                    'capippriva': capipprivada,
                    'navegador': navegador,
                    'os': os,
                    'cookies': cookies,
                    'screensize': screensize,
                    'user': $("#user").val(),
                    'pass': $("#pass").val(),
                    'next':  $("#next").val(),
                    'profile': $("#profile").val(),
                    'g-recaptcha-response': $("#g-recaptcha-response").val()
                },
                success: function (data) {
                    $.unblockUI();
                    if (data.result === 'ok') {
                        localStorage.clear();
                        localStorage.setItem('sessionid', data.sessionid);
                        window.name = data.sessionid;
                        {#location.href = "/loginsga";#}
                        location.href = data.url_redirect;
                    } else {
                        $("#login").removeAttr('disabled');
                        {#$("#errormensaje").html(data.mensaje).show();#}
                        alertaWarning(data.mensaje);
                        {% if validar_con_captcha %}
                            grecaptcha.reset();
                        {% endif %}
                    }
                },
                error: function () {
                    $.unblockUI();
                    $("#login").removeAttr('disabled');
                    alertaWarning('Error al enviar los datos');
                    {#$("#errormensaje").html('Error al enviar los datos').show();#}
                    {% if validar_con_captcha %}
                        grecaptcha.reset();
                    {% endif %}
                },
                dataType: "json"
            });
        };

        {% if faceid_access %}
            $(async function () {
                $("#intentar_new, #id_intentos_cab").hide();
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                const captureButton = document.getElementById('login');
                const cerrarButton = document.getElementById('cerrar_faceid');
                const intentarNew = document.getElementById('intentar_new');
                const resultText = document.getElementById('result');
                const instructionText = document.getElementById('instructions');
                const cloudFunctionUrl = 'https://us-central1-unemi-biometrico-sga.cloudfunctions.net/analyze_photo';
                let blinkCount = 0;
                let startFaceDetected = false;
                let noDetectFace = 0;
                let camera;
                let ingresoApi=false
                let isProcessing = false; // Nueva variable para controlar el procesamiento
                let detectionStopped = false;
                let lastMovementTime = 0;
                let lastNoseX = null; // Posición anterior de la nariz en X
                let lastNoseY = null; // Posición anterior de la nariz en Y
                let interval;
                const movementThreshold = 0.05; // Umbral para determinar si un movimiento es significativo
                
                const faceMesh = new FaceMesh({
                        locateFile: (file) => {
                            return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                        }
                    });
                startCamera()
    
                function onResults(results) {
                    if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) {
                        noDetectFace++;
                        instructionText.innerText = "No se detectó un rostro. Inténtelo de nuevo.";
                        resultText.classList.add('text-danger');
                        resultText.classList.remove('text-success');
                        stopDetection();
                        if(noDetectFace > 2){
                            instructionText.innerText = "Si la cámara no se visualiza correctamente, te recomendamos utilizar Google Chrome, Microsoft Edge o Safari para garantizar un funcionamiento óptimo del reconocimiento facial.";
                        }
                     }
                     if (detectionStopped) {
                        return; // Detiene la detección si está marcada como detenida
                    }
                    resultText.classList.remove('text-danger');
                    if (isProcessing) {
                        // Si estamos esperando que pase el tiempo de espera, no procesamos nada
                        return
                    }
                    const landmarks = results.multiFaceLandmarks[0];
                    const initialBrowDistance = captureInitialBrowDistance(landmarks);
                    const leftEAR = [landmarks[33], landmarks[160], landmarks[158], landmarks[133], landmarks[153], landmarks[144]]
                    const rightEAR = [landmarks[263], landmarks[387], landmarks[385], landmarks[362], landmarks[380], landmarks[373]]
                    const noseX = landmarks[1].x;
                    const noseY = landmarks[1].y;
                    const leftEyeY = landmarks[159].y;
                    const rightEyeY = landmarks[386].y;
                    const mouthLeftX = landmarks[61].x;
                    const mouthRightX = landmarks[291].x;
                    const chinY = landmarks[152].y;
                    const chinX = landmarks[152].x;
                    const mouthTopY = landmarks[13].y;
                    const mouthBottomY = landmarks[14].y;
                    const browLeftX = landmarks[70].x;
                    const browRightX = landmarks[107].x;
    
                    let movementDetected = false;
                    let incorrectMovementDetected = false;
    
    
                    if (lastNoseX !== null && lastNoseY !== null) {
                        // Calcula la magnitud del movimiento
                        const movementMagnitude = Math.sqrt(Math.pow(noseX - lastNoseX, 2) + Math.pow(noseY - lastNoseY, 2));
    
                        // Si el movimiento es significativo y ocurrió en menos de 3 segundos, marcarlo como sospechoso
                        const currentTime = performance.now();
                        if (movementMagnitude > movementThreshold && currentTime - lastMovementTime < 3000) {
                            instructionText.html = "Movimiento sospechoso detectado. <br> Por favor, realice las acciones lentamente."
                            resultText.classList.add('text-danger');
                            return;
                        }
    
                        if (movementMagnitude > movementThreshold) {
                            lastMovementTime = currentTime; // Actualiza el tiempo del último movimiento significativo
                        }
                    }
    
                    lastNoseX = noseX;
                    lastNoseY = noseY;
    
                    if (currentStep < sequence.length) {
                        switch (sequence[currentStep]) {
                            case 'smile':
                                movementDetected = detectSmile(mouthLeftX, mouthRightX);
                                break;
                            case 'blink':
                                movementDetected = detectBlink(leftEAR, rightEAR);
                                break;
                            case 'tiltLeft':
                                movementDetected = detectTiltLeft(noseX, chinX);
                                incorrectMovementDetected = detectTiltRight(noseX, chinX);
                                break;
                            case 'tiltRight':
                                movementDetected = detectTiltRight(noseX, chinX);
                                incorrectMovementDetected = detectTiltLeft(noseX, chinX);
                                break;
                        }
    
                        if (incorrectMovementDetected) {
                            // Resetea la secuencia y notifica al usuario
                            instructionText.innerText = `Movimiento incorrecto detectado.`;
                            resultText.classList.add('text-danger');
                            stopDetection();
                        } else if (movementDetected) {
                            isProcessing = true; // Bloquea la detección de nuevos movimientos
                            paso = currentStep + 1;
                            {#console.log(paso)#}
                            instructionText.innerText = `Paso ${paso} completado. Espere...`;
                            if(paso < 1){
                                setTimeout(() => {
                                    if (!detectionStopped){
                                        currentStep++;
                                        updateInstructions();
                                    }
                                    isProcessing = false; // Desbloquea para el siguiente movimiento
                                }, 2000); // 2000 milisegundos = 2 segundos de retraso
                            }else{
                                currentStep++;
                                updateInstructions();
                                isProcessing = false; // Desbloquea para el siguiente movimiento
                            }
                        }
                    }
    
                    if (currentStep >= sequence.length) {
                        resultText.innerText = 'Prueba de vida completada con éxito';
                        resultText.classList.add('text-success');
                        resultText.classList.remove('text-danger');
                         captureAndSendImage();
                    }
                }
    
                function startCamera(){
                    faceMesh.setOptions({
                        {#maxNumFaces: 1,#}
                        refineLandmarks: true,
                        minDetectionConfidence: 0.5,
                        minTrackingConfidence: 0.5
                    });
                    camera = new Camera(video, {
                        onFrame: async () => {
                            await faceMesh.send({image: video});
                        },
                        width: 640,
                        height: 480
                    });
    
                }
    
                async function startDetection(){
                    await camera.start();
                    faceMesh.onResults(onResults);
                    startCountDetection()
                    detectionStopped = false;
                    $("#intentar_new").hide();
                }
    
                function stopDetection() {
                    stopCountDetection()
                    detectionStopped = true;
    
                    if (camera) {
                        camera.stop(); // Detener la cámara
                    }
    
                    // Detener el flujo de medios (apagar la cámara)
                    if (video.srcObject) {
                        video.srcObject.getTracks().forEach(track => track.stop());
                    }
    
                    // Limpiar el video para liberar recursos
                    video.srcObject = null;
    
                    // Actualizar la interfaz
                    resultText.innerText = "Detección detenida.";
                    resultText.classList.add('text-danger');
                    resultText.classList.remove('text-success');
                    $("#intentar_new").show();
    
                }
    
                function startCountDetection() {
                    const tiempo = document.getElementById('id_time');
                    const duration = 12000;
                    const startTime = performance.now(); // Hora de inicio de la animación
                    interval = setInterval(() => {
                        const elapsedTime = performance.now() - startTime; // Tiempo transcurrido
                        const timeLeft = Math.max(0, duration - elapsedTime); // Tiempo restante en milisegundos
    
                        // Convertir milisegundos a segundos
                        const secondsLeft = Math.ceil(timeLeft / 1000);
    
                        {#console.log(timeLeft)#}
                        // Actualizar la etiqueta con el tiempo restante
                        tiempo.textContent = `Tiempo restante: ${secondsLeft} segundos`;
                        if (timeLeft <= 0) {
                            stopDetection();
                            if (!ingresoApi) {
                                $("#intentar_new").show();
                            }
                        }
                    }, 1000);
                }

                function stopCountDetection() {
                    clearInterval(interval); // Detener el intervalo usando clearInterval
                }
                
                function validarUser(){
                    bloqueointerface()
                    $.ajax({
                        url: '/api',
                        type: 'GET',
                        data: { 'usuario': $("#user").val(),
                                'password': $("#pass").val(),
                                'profile': $("#profile").val(),
                                'app': 'sga',
                                'a': 'validarusuario'},
                        success: function (response) {
                            if (response.result === false){
                                $.unblockUI();
                                alertaWarning(response.mensaje)
                                if(response.tipo === 'usuario'){
                                    $("#user").focus();
                                    $("#helpUsuario").html(response.mensaje);
                                    $("#helpUsuario").addClass('text-danger');
                                    $("#user").addClass('is-invalid');
                                }else if(response.tipo === 'password'){
                                    $("#pass").focus();
                                    $("#helpPassword").html(response.mensaje);
                                    $("#helpPassword").addClass('text-danger');
                                    $("#pass").addClass('is-invalid')
    
                                    $("#helpUsuario").html('');
                                    $("#user").removeClass('text-danger');
                                    $("#user").removeClass('is-invalid');
                                    $("#user").addClass('is-valid');
                                }else{
                                    $("#user, #pass").removeClass('text-danger');
                                    $("#user, #pass").removeClass('is-invalid');
                                    $("#user, #pass").addClass('is-valid');
                                }
                                return false
                            }else if(!response.faceid){
                                login();
                            }else{
                                $("#helpPassword, #helpUsuario").removeClass('text-danger').html('');
                                $("#pass, #user").removeClass('is-invalid');
                                 $("#pass, #user").addClass('is-valid');
                                startFaceDetection();
                            }
                        },
                        error: function (xhr, status, error) {
                            $.unblockUI();
                            return false
                            alertaDanger('Error de conexión')
                            // Manejar el error de la consulta AJAX si es necesario
                        }
                    });
                }
                
                function startFaceDetection() {
                    bloqueointerface()
                    if (!startFaceDetected){
                        navigator.mediaDevices.getUserMedia({video: true})
                        .then(stream => {
                            video.srcObject = stream;
                            video.play();
                            video.onloadedmetadata = () => {
                                canvas.width = video.videoWidth;
                                canvas.height = video.videoHeight;
                                startDetection().then(() => {
                                    resetSequence();
                                    setTimeout(() => {
                                       $.unblockUI();
                                        startFaceDetected = true;
                                        formModalFace('Capturar imagen', 'modal-md', false, 'fa fa-camera');
                                    }, 500); // Espera 1 segundo antes de mostrar el modal
                                });
                            };
                        })
                        .catch(err => {
                            console.error("Error de acceso a la camara: ", err);
                            mensajeDangerReload('Error al acceder a la cámara. <br> Por favor verifique los permisos y recargue la pagina.', 'Recargar');
                        }); 
                    }else{
                        $.unblockUI();
                        resultText.innerText = "";
                        resetSequence();
                        startDetection();
                        formModalFace('Capturar imagen', 'modal-md', false, 'fa fa-camera');
                    }
                   
                }
    
                async function captureAndSendImage() {
                    if (isProcessing) return; // Si ya está en proceso, no hacer nada.
                    isProcessing = true;
                    bloqueointerface();
                    ingresoApi = true;
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
                        const dataURL = canvas.toDataURL('image/jpg');
                        const username = $("#user").val().trim().toLowerCase();
                        const payload = JSON.stringify({
                            image: dataURL,
                            cedula: username
                        });
    
                        stopDetection();
                        $('#itemspanelface').modal('hide');
                        fetch(cloudFunctionUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                },
                                body: payload
                            })
                            .then(response => response.json())
                            .then(data => {
                                console.log(data);
                                if (data.status === 'success') {
                                    imgURL = dataURL;
                                    similitud = data.message;
                                    login();
                                } else {
                                    $.unblockUI();
                                    mensajeDangerReload('No se pudo identificar al usuario con la imagen capturada, asegure que sus datos sean correctos y vuelva a intentarlo.')
                                }
                            })
                            .catch(error => {
                                $.unblockUI();
                                console.error('Error:', error);
                                mensajeDangerReload('Ocurrió un error inesperado en la verificación de la imagen, por favor recargue la página e intente de nuevo')
                            });
    
                    } else {
                        mensajeDanger('La cámara no está lista. Por favor, inténtelo de nuevo.');
                        isProcessing = false; // Liberar bloqueo
                    }
                }

                const validarCampos = async () => {
                    let usuario = $("#user").val();
                    if (usuario.length === 0) {
                        $("#user").focus();
                        return false;
                    }
                    let clave = $("#pass").val();
                    if (clave.length === 0) {
                        $("#pass").focus();
                        return false;
                    }
                    {% if validar_con_captcha %}
                        if ($("#g-recaptcha-response").length !== 0) {
                            if (!checkRecaptcha()) {
                                $.unblockUI();
                                alertaDanger('Complete el captcha para continuar')
                                return false;
                            }
                        }
                    {% endif %}
                    validarUser();
                    {#startFaceDetection()#}
                }
    
                intentarNew.addEventListener('click', async () => {
                    blinkCount = 0;
                    resultText.innerText = "";
                    resetSequence();
                    startDetection();
                    $("#intentar_new").hide();
                });
    
                captureButton.addEventListener('click', async () => {
                    await validarCampos();
                });
    
                cerrarButton.addEventListener('click', async () => {
                    stopDetection();
                    $('#itemspanelface').modal('hide');
                    {#ingresoApi=false#}
                    {#resultText.innerText = "";#}
                    {#resultText.classList.remove('text-danger');#}
                    {#resultText.classList.remove('text-success');#}
                    {#$("#intentar_new").hide();#}
                    {#bloqueointerface()#}
                    {#location.reload()#}
                });
            });
        {% else %}
            $(function () {
                $("#login").click(function () {
                    let usuario = $("#user").val();
                    if (usuario.length === 0) {
                        $("#user").focus();
                        return false;
                    }
                    let clave = $("#pass").val();
                    if (clave.length === 0) {
                        $("#pass").focus();
                        return false;
                    }
                    {% if validar_con_captcha %}
                        if ($("#g-recaptcha-response").length !== 0) {
                            if (!checkRecaptcha()) {
                                $.unblockUI();
                                alertaDanger('Complete el captcha para continuar')
                                return false;
                            }
                        }
                    {% endif %}
                    login();
                });
            });
        {% endif %}
    </script>
{% endblock %}
{% block canvas %}
	<br>
	<div class="row align-items-center min-vh-80">
		<div class="col-md-6 col-xl-6 col-12 hidden-phone visible-desktop" style="padding-left: 7%;border-right: 1px solid #e9ecef; height: 500px;">
			<center>
				{#                {% if DIA_CANCER_MAMA_19_OCTUBRE %}#}
				{#                    <div id="carouselEventos" class="carousel slide lista_eventos" data-ride="carousel" style="height: 57%;">#}
				{#                        <div class="carousel-inner" role="listbox">#}
				{#                            <div class="carousel-item active">#}
				{#                                <img src="/static/diascelebres/luchaoctubre/sga_login.png" class="fancybox" width="100%">#}
				{#                            </div>#}
				{#                        </div>#}
				{#                    </div>#}
				{#                {% else %}#}
				<a href="/"><img src="/static/logos/sgaplus_blue.svg" style="width: 70%;margin-left: -65px;" class="mb-4" alt=""></a><br>
				{% if DIA_DE_LA_MADRE %}
                     <div id="carouselNoticias" class="carousel slide" data-bs-ride="carousel" data-bs-interval="5000" style="width: 387px; height: 400px;">
                         <div class="carousel-inner">
                             {% for carousel in CAROUSEL_LOGIN_IMG %}
                                 <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                     <img data-fancybox src="{{ carousel }}" data-src="{{ carousel }}" title=""
                                          class="d-block w-100 h-100 object-fit-cover">
                                 </div>
                             {% empty %}
                                 <div class="carousel-item active">
                                     <img data-fancybox src="/static/diascelebres/diadelamadre/post_2.png" data-src="/static/diascelebres/diadelamadre/post_2.png" title=""
                                          class="d-block w-100 h-100 object-fit-cover">
                                 </div>
                             {% endfor %}
                         </div>

                         <!-- Flechas de Navegación -->
                         <button class="carousel-control-prev" type="button" data-bs-target="#carouselNoticias"
                                 data-bs-slide="prev">
                             <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                             <span class="visually-hidden">Previous</span>
                         </button>
                         <button class="carousel-control-next" type="button" data-bs-target="#carouselNoticias"
                                 data-bs-slide="next">
                             <span class="carousel-control-next-icon" aria-hidden="true"></span>
                             <span class="visually-hidden">Next</span>
                         </button>
                     </div>

				{% else %}
					{% if noticias or noticiasgraficas %}
						<div id="carouselNoticias" class="carousel slide lista_actividades" data-ride="carousel" style="width: 357px;height: 57%;">
							<div class="carousel-inner" role="listbox">
								{% for noticia in noticias %}
									<div class="carousel-item {% if forloop.first and not noticiasgraficas %}active{% else %}active{% endif %}">
										<div class="panel_logo">
											<p class="texto-blue" style="margin-left: 4px; font-weight: 600"> {{ noticia.titular }}</p>
										</div>
										{{ noticia.cuerpo|safe }}
									</div>
								{% endfor %}
								{% for noticia in noticiasgraficas %}
									<div class="carousel-item {% if forloop.first and not noticias %}active{% endif %}">
										<div class="panel_logo">
											<p class="texto-blue" style="margin-left: 4px; font-weight: 600"> {{ noticia.titular }}</p>
										</div>
										<img src="/media/{{ noticia.imagen__archivo }}" class="fancybox"
											 width="100%">
									</div>
								{% endfor %}
							</div>
							{#                        <a class="carousel-control-prev" href="#carouselNoticias" role="button" data-slide="prev" >#}
							{#                            <span class="carousel-control-prev-icon" aria-hidden="true" style="color: black; border-radius: 18px; background-color: #d1d1d1; width: 30px; margin-left: -86px;"></span>#}
							{#                        </a>#}
							{#                        <a class="carousel-control-next" href="#carouselNoticias" role="button" data-slide="next" >#}
							{#                            <span class="carousel-control-next-icon" aria-hidden="true" style="color: black; border-radius: 18px; background-color: #d1d1d1; width: 30px; margin-right: -69px;"></span>#}
							{#                        </a>#}
						</div>
					{% else %}
						<div class="panel_logo">
							<p class="texto-blue"><b>Facilitamos todos tus procesos</b> en <br>gestión e integración académica.
							</p>
						</div>
						<ul class="texto-gris lista_actividades" style="margin-top: 10px">
							<li style="margin-bottom: 10px;"><img src="/static/logos/icon_login_autoevaluacion.svg"
																  width="45px"> <b>Autoevaluación</b> constante
							</li>
							<li style="margin-bottom: 10px;"><img src="/static/logos/icon_login_consulta_cronograma.svg"
																  width="45px">Consulta <b>cronograma</b> de actividades
							</li>
							<li style="margin-bottom: 10px;"><img src="/static/logos/icon_login_aula_virtual.svg"
																  width="45px">Acceso a <b>Aula virtual</b></li>
							<li style="margin-bottom: 10px;"><img src="/static/logos/icon_login_actas_calificaciones.svg"
																  width="45px"><b>Actas de calificaciones</b> actualizadas
							</li>
							<li style="margin-bottom: 10px;"><img src="/static/logos/icon_login_mas_procesos.svg"
																  width="45px">Y más procesos para ti.
							</li>
						</ul>
					{% endif %}
				{% endif %}
				{#                {% endif %}#}
			</center>
		</div>
		<div class="col-md-6 col-xl-6 col-12 formulariologin">
			<div class="mb-1 text-center">
				<div class="visible-phone hidden-desktop">
					<center>
						<a href="/"><img src="/static/logos/sgaplus_blue.svg" style="width: 250px" class="mb-4" alt=""></a><br>
					</center>
				</div>
				<h2 class="mb-1 fw-bold texto-naranja">Iniciar sesión</h2>
				<!--<h4 class="mb-1 fw-bold texto-primary label_perfil">Perfil</h4>-->
				<p style="font-size: 15px; line-height: 17px">Ingrese sus datos de forma correcta</p>
			</div>
			<form>
				<div class="mb-3" style="text-align: center">
					{% if next %}
						<input type="hidden" id="next" name="next" value="{{ next }}">
					{% endif %}
					<input type="hidden" id="profile" name="profile" value="">
                    <div>
                        <label for="username" class="form-label" style="margin-left: -192px;"><b>Usuario:</b></label>
                        <input type="text" id='user' name="user" placeholder="Ingrese su nombre de usuario"
                               style="width: 243px;"
                               required>
                        <p class="fs-6 text-danger" style="margin-left: -147px;" id="helpUsuario"></p>
                    </div>
                    <div>
                        <label for="password" class="form-label"
						   style="margin-top: 9px;margin-left: -174px;"><b>Contraseña:</b></label>
                        <input type="password" id="pass" style="width: 207px;"
                               data-toggle="password" data-placement="after" name="pass"
                               placeholder="Ingrese su contraseña" required>
                        <p class="fs-6 text-danger" id="helpPassword" style="margin-left: -128px;"></p>
                    </div>
					
					
				</div>

				{% if validar_con_captcha %}
					<!--<div class="mb-3" style="text-align: center">
						<label for="password" class="form-label" style="margin-left: -176px;"><b>Seguridad:</b></label>
						<div style="margin-top: 1px;width: 243px;" id="g-recaptcha-response"
							 class="g-recaptcha recaptchainput" data-sitekey="{{ public_key }}"></div>
					</div>-->
					<div class="row justify-content-center align-items-center">
						<div class="col-auto m-0 p-0 text-center">
							<div
									style="display: block; width: auto;"
									id="g-recaptcha-response"
									class="g-recaptcha inline normal "
									data-sitekey="{{ public_key }}"
							/>
						</div>
					</div>
				{% endif %}

				<div>
					<div class="d-grid">
						<center>
							<a href="javascript:void(0);" id="login" class="btn btn-orange text-white my-2"
							   style="width: 40%;border-radius: 3.2rem;padding: 8px 11px;">Entrar</a><br>

							<a href="javascript:void(0);" id="idPerfiles" class="btn btn-primary text-white"
							   style="width: 40%;border-radius: 3.2rem;padding: 8px 11px;">Perfiles</a><br>

							{% if LOGIN_GMAIL %}
								<div class="login-buttons mt-2">
									<a class="btn btn-soft-google transition-3d-hover" href="{% url 'social:begin' 'google-oauth2' %}">
										<svg xmlns="https://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48" aria-hidden="true" class="L5wZDc">
											<path fill="#4285F4" d="M45.12 24.5c0-1.56-.14-3.06-.4-4.5H24v8.51h11.84c-.51 2.75-2.06 5.08-4.39 6.64v5.52h7.11c4.16-3.83 6.56-9.47 6.56-16.17z"></path>
											<path fill="#34A853" d="M24 46c5.94 0 10.92-1.97 14.56-5.33l-7.11-5.52c-1.97 1.32-4.49 2.1-7.45 2.1-5.73 0-10.58-3.87-12.31-9.07H4.34v5.7C7.96 41.07 15.4 46 24 46z"></path>
											<path fill="#FBBC05" d="M11.69 28.18C11.25 26.86 11 25.45 11 24s.25-2.86.69-4.18v-5.7H4.34C2.85 17.09 2 20.45 2 24c0 3.55.85 6.91 2.34 9.88l7.35-5.7z"></path>
											<path fill="#EA4335" d="M24 10.75c3.23 0 6.13 1.11 8.41 3.29l6.31-6.31C34.91 4.18 29.93 2 24 2 15.4 2 7.96 6.93 4.34 14.12l7.35 5.7c1.73-5.2 6.58-9.07 12.31-9.07z"></path>
											<path fill="none" d="M2 2h44v44H2z"></path>
										</svg>
										Iniciar Sesión con Google
									</a>
								</div>
							{% endif %}
						</center>
					</div>
				</div>

				<div class="mt-4 text-center">
					{% if id_periodo_admision %}
						<a href="javascript:;" class="btn btn-info btn-mini " style="font-size: 12px" id="recuperar2">
							<i class="fa fa-check-circle-o"></i>
							Consultar credenciales <br> Curso de Nivelación {{ nombre_priodo_admision }}
						</a>
					{% endif %}
					<p style="font-size: 13px">¿No recuerdas tus datos? <a href="javascript:void(0)"
																		   class="recuperardatos">Recuperar
						datos</a><br>¿Tienes problemas? <a target="_blank"
														   href="mailto:servicios.informaticos@unemi.edu.ec">Contacta al
						administrador</a></p>
				</div>
			</form>
		</div>
	</div>

	<div class="modal fade opacity" id="modalRecuperarDatos">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content" style="background-color: transparent;!important;border: 1px solid transparent;">
				<div class="modal-wrap">
					<div class="modal-header"
						 style="text-align: right; display: list-item; border-bottom: 1px solid white; padding: 12px 13px">
						<button type="button" class="btn-close btn-cerrar-modal" data-toggle="modal"
								data-dismiss="modal" aria-label="Close">X
						</button>
					</div>
					<div class="panelPass">
						<center style="margin-bottom: 43px;"><br>
							<H2 class="texto-naranja">Recuperar datos de cuenta</H2>
							<p class="texto-gris">Ingrese su número de documento<br>para validar su cuenta:</p>
							<input id="iddocumentopass" type="text" class="form-control" maxlength="15"
								   placeholder="Ingrese su número de cédula/ruc/pasaporte.." style="width: 75%"><br>
							<a href="javascript:void(0);" id="busqueda" class="btn btn-warning btn-sm text-white"
							   style="width: 40%;  border-radius: 3.2rem; font-size: 15px; margin-top: 10px">Validar</a>
						</center>
					</div>
					<div class="panelPassConf" hidden>
						<center style="margin-top: -37px; margin-bottom: 23px;"><br>
							<img src="/static/logos/icon_user_check.svg" style="width: 70px">
							<h2 class="texto-naranja">Datos de cuenta</h2>
							<span class="texto-gris">Su nombre de usuario es:</span><br>
							<b class="texto-blue" id="nombrepersona"></b>
							<div id="generar">
								<p class="texto-gris">¿Desea recuperar su contraseña?</p>
								<button href="javascript:void(0);" data-toggle="modal" data-dismiss="modal"
										class="btn btn-gris btn-sm"
										style="width: 40%;  border-radius: 3.2rem; font-size: 15px">Cerrar
								</button>
								<a href="javascript:void(0);" id="cambioclave" class="btn btn-warning btn-sm text-white"
								   style="width: 40%;  border-radius: 3.2rem; font-size: 15px">Aceptar</a>
							</div>
							<div id="visualizar">
								<p class="texto-gris">Si es la primera vez que ingresa, <br><b>su número de cédula séra
									su contraseña</b></p>
								<button href="javascript:void(0);" data-toggle="modal" data-dismiss="modal"
										class="btn btn-gris btn-sm"
										style="width: 40%;  border-radius: 3.2rem; font-size: 15px">Cerrar
								</button>
							</div>
						</center>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade opacity" id="modalRecuperarDatosAdmision">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content" style="background-color: transparent;!important;border: 1px solid transparent;">
				<div class="modal-wrap">
					<div class="modal-header"
						 style="text-align: right; display: list-item; border-bottom: 1px solid white; padding: 12px 13px">
						<button type="button" class="btn-close btn-cerrar-modal" data-toggle="modal"
								data-dismiss="modal" aria-label="Close">X
						</button>
					</div>
					<div class="panelPassAdmision">
						<center style="margin-bottom: 43px;"><br>
							<H2 class="texto-blue">Recuperar datos de cuenta</H2>
							<p class="texto-gris">Ingrese su número de documento<br>para validar su cuenta:</p>
							<input id="cedula_admision" type="text" class="form-control" maxlength="15"
								   placeholder="Ingrese su número de cédula/ruc/pasaporte.." style="width: 75%"><br>
							<a href="javascript:void(0);" id="busqueda_admision" class="btn btn-warning btn-sm text-white"
							   style="width: 40%;  border-radius: 3.2rem; font-size: 15px; margin-top: 10px">Validar</a>
						</center>
					</div>
					<div class="panelPassConfAdmision" hidden>
						<center style="margin-top: -37px; margin-bottom: 23px;"><br>
							<img src="/static/logos/icon_user_check.svg" style="width: 70px">
							<h2 class="texto-naranja">Datos de cuenta</h2>
							<span class="texto-gris">Su nombre de usuario es:</span><br>
							<b class="texto-blue" id="nombrepersonaadm"></b>

							<div id="generarAdmision">
								<p class="texto-gris">¿Desea recuperar su contraseña?</p>
								<button href="javascript:void(0);" data-toggle="modal" data-dismiss="modal"
										class="btn btn-gris btn-sm"
										style="width: 40%;  border-radius: 3.2rem; font-size: 15px">Cerrar
								</button>
								<a href="javascript:void(0);" id="cambioclaveAdmision" class="btn btn-warning btn-sm text-white"
								   style="width: 40%;  border-radius: 3.2rem; font-size: 15px">Aceptar</a>
							</div>
							<div id="visualizarAdmision">
								<p class="texto-gris">Si es la primera vez que ingresa, <br><b>su número de cédula séra
									su contraseña</b></p>
								<button href="javascript:void(0);" data-toggle="modal" data-dismiss="modal"
										class="btn btn-gris btn-sm"
										style="width: 40%;  border-radius: 3.2rem; font-size: 15px">Cerrar
								</button>
							</div>
						</center>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade opacity" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true" id="modalPerfiles">
		<div class="modal-dialog modal-lg modal-dialog-scrollable" style="background-color: transparent;!important;border: 1px solid transparent;">
			<div class="modal-content">
				<!--<div class="modal-header">
                    <h5 class="modal-title">Modal title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>-->
				<div class="modal-body">
					<div class="text-center my-lg-6 mx-lg-10 my-sm-3 mx-sm-5">
						<h3 class="texto-blue"><span class="border border-2 border-left me-2 border-warning"></span>PERFILES</h3>
						<p class="text-muted">Selecciona tu perfil para iniciar sesión en el</p>
						<img  src="/static/logos/sgaplus_blue.svg" width="136px" height="38px"/>
						<h5 class="texto-blue">Estudiantes, docentes y administrativos</h5>
						<p class="text-muted">Accede a tus funcionalidades específicas.</p>
						<div class="row row-cols-1 row-cols-lg-3 row-cols-md-2 row-cols-sm-1 g-4 mt-3 justify-content-center">
							<div class="col">
								<div class="card border-0 shadow-none h-100">
									<img src="/static/images/login/estudiante.svg" class="card-img-top" alt="Estudiante" width="65px" height="76px">
									<div class="card-body text-center">
										<h4 class="text-blue m-0 p-0">Estudiante</h4>
										<p class="fs-6 text-muted m-0 p-0" style="line-height: 1.5em">¡Conéctate y Explora: Acceso Estudiantil!</p>
										<a class="btn btn-warning btn-large mt-2 rounded-pill px-6" style="" href="{{ SITE_URL_SIE }}/login">Ingresar</a>									</div>
								</div>
							</div>
							<div class="col">
								<div class="card border-0 shadow-none h-100">
									<img src="/static/images/login/docente.svg" class="card-img-top" alt="Docente" width="65px" height="76px">
									<div class="card-body text-center">
										<h4 class="text-blue m-0 p-0">Docente</h4>
										<p class="fs-6 text-muted m-0 p-0" style="line-height: 1.5em">Accede a tu espacio de enseñanza.</p>
										<a class="btn btn-warning btn-large mt-2 rounded-pill px-6" href="javascript:void(0);" id="btnDocente">Ingresar</a>
									</div>
								</div>
							</div>
							<div class="col">
								<div class="card border-0 shadow-none h-100">
									<img src="/static/images/login/administrativo.svg" class="card-img-top" alt="Administrativo" width="65px" height="76px">
									<div class="card-body text-center">
										<h4 class="text-blue m-0 p-0">Administrativo</h4>
										<p class="fs-6 text-muted m-0 p-0" style="line-height: 1.5em">Gestión eficiente en tus manos.</p>
										<a class="btn btn-warning btn-large mt-2 rounded-pill px-6" href="javascript:void(0);" id="btnAdministrativo">Ingresar</a>
									</div>
								</div>
							</div>
						</div>
					</div>

				</div>
				<!--<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary">Save changes</button>
				</div>-->
			</div>
		</div>
	</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
